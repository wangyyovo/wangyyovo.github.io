<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>NATS Streaming | Blank</title><meta name="author" content="Blank"><meta name="copyright" content="Blank"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="NATS StreamingNATS Streaming 概念NATS Streaming是一个由NATS驱动的数据流系统，用Go编程语言编写。 NATS Streaming服务器的可执行文件名是nats-streaming-server。 NATS Streaming与核心NATS平台无缝嵌入，扩展和互操作。 NATS Streaming服务器作为Apache-2.0许可下的开源软件提供。 S">
<meta property="og:type" content="article">
<meta property="og:title" content="NATS Streaming">
<meta property="og:url" content="https://wangyyovo.github.io/posts/e845c472/">
<meta property="og:site_name" content="Blank">
<meta property="og:description" content="NATS StreamingNATS Streaming 概念NATS Streaming是一个由NATS驱动的数据流系统，用Go编程语言编写。 NATS Streaming服务器的可执行文件名是nats-streaming-server。 NATS Streaming与核心NATS平台无缝嵌入，扩展和互操作。 NATS Streaming服务器作为Apache-2.0许可下的开源软件提供。 S">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/nats/95994a9aea31be452e66c89e68ba4a27.jpg">
<meta property="article:published_time" content="2019-09-27T08:10:36.000Z">
<meta property="article:modified_time" content="2019-09-27T08:10:36.000Z">
<meta property="article:author" content="Blank">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/nats/95994a9aea31be452e66c89e68ba4a27.jpg"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/theme/favicon.ico"><link rel="canonical" href="https://wangyyovo.github.io/posts/e845c472/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'mediumZoom',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'NATS Streaming',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2019-09-27 16:10:36'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="alternate" href="/atom.xml" title="Blank" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/theme/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">356</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">36</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">54</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fas fa-coffee"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 娱乐</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-image"></i><span> 相册</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-book"></i><span> 教程</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/posts/21cfbf15/"><span> 🚀 快速開始</span></a></li><li><a class="site-page child" href="/posts/dc584b87/"><span> 📑 主題頁面</span></a></li><li><a class="site-page child" href="/posts/4aa8abbe/"><span> 🛠 主題配置-1</span></a></li><li><a class="site-page child" href="/posts/ceeb73f/"><span> ⚔️ 主題配置-2</span></a></li><li><a class="site-page child" href="/posts/98d20436/"><span> ❓ 主題問答</span></a></li><li><a class="site-page child" href="/posts/4073eda/"><span> ⚡️ 進階教程</span></a></li><li><a class="site-page child" href="/posts/198a4240/"><span> ✨ 更新日誌</span></a></li><li><a class="site-page child" href="/posts/507c070f/"><span> 📑 Aplayer教程</span></a></li><li><a class="site-page child" href="/posts/2df239ce/"><span> 📑 標籤外掛</span></a></li><li><a class="site-page child" href="/posts/b37b5fe3/"><span> 📑 自定義代碼配色</span></a></li><li><a class="site-page child" href="/posts/ea33ab97/"><span> 📑 自定義側邊欄</span></a></li><li><a class="site-page child" href="/posts/89757140/"><span> 📑 Markdown</span></a></li><li><a class="site-page child" href="/posts/9db656e5/"><span> 📑 代码高亮测试</span></a></li><li><a class="site-page child" href="/posts/c9711c19/"><span> 📑 當設置top_img為false時</span></a></li><li><a class="site-page child" href="/posts/39b121ef/"><span> 📑 Hexo內置標籤外掛</span></a></li><li><a class="site-page child" href="/posts/7670b080/"><span> 📑 Butterfly 美化/優化/魔改 教程合集</span></a></li><li><a class="site-page child" href="/posts/913b2502/"><span> 📑 没有封面</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/nats/95994a9aea31be452e66c89e68ba4a27.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Blank</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fas fa-coffee"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 娱乐</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-image"></i><span> 相册</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-book"></i><span> 教程</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/posts/21cfbf15/"><span> 🚀 快速開始</span></a></li><li><a class="site-page child" href="/posts/dc584b87/"><span> 📑 主題頁面</span></a></li><li><a class="site-page child" href="/posts/4aa8abbe/"><span> 🛠 主題配置-1</span></a></li><li><a class="site-page child" href="/posts/ceeb73f/"><span> ⚔️ 主題配置-2</span></a></li><li><a class="site-page child" href="/posts/98d20436/"><span> ❓ 主題問答</span></a></li><li><a class="site-page child" href="/posts/4073eda/"><span> ⚡️ 進階教程</span></a></li><li><a class="site-page child" href="/posts/198a4240/"><span> ✨ 更新日誌</span></a></li><li><a class="site-page child" href="/posts/507c070f/"><span> 📑 Aplayer教程</span></a></li><li><a class="site-page child" href="/posts/2df239ce/"><span> 📑 標籤外掛</span></a></li><li><a class="site-page child" href="/posts/b37b5fe3/"><span> 📑 自定義代碼配色</span></a></li><li><a class="site-page child" href="/posts/ea33ab97/"><span> 📑 自定義側邊欄</span></a></li><li><a class="site-page child" href="/posts/89757140/"><span> 📑 Markdown</span></a></li><li><a class="site-page child" href="/posts/9db656e5/"><span> 📑 代码高亮测试</span></a></li><li><a class="site-page child" href="/posts/c9711c19/"><span> 📑 當設置top_img為false時</span></a></li><li><a class="site-page child" href="/posts/39b121ef/"><span> 📑 Hexo內置標籤外掛</span></a></li><li><a class="site-page child" href="/posts/7670b080/"><span> 📑 Butterfly 美化/優化/魔改 教程合集</span></a></li><li><a class="site-page child" href="/posts/913b2502/"><span> 📑 没有封面</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">NATS Streaming</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2019-09-27T08:10:36.000Z" title="发表于 2019-09-27 16:10:36">2019-09-27</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2019-09-27T08:10:36.000Z" title="更新于 2019-09-27 16:10:36">2019-09-27</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/microservice/">microservice</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/microservice/nats/">nats</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">4.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>19分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="NATS Streaming"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><script src="\assets\js\APlayer.min.js"> </script><h1 id="NATS-Streaming"><a href="#NATS-Streaming" class="headerlink" title="NATS Streaming"></a>NATS Streaming</h1><h2 id="NATS-Streaming-概念"><a href="#NATS-Streaming-概念" class="headerlink" title="NATS Streaming 概念"></a>NATS Streaming 概念</h2><p>NATS Streaming是一个由NATS驱动的数据流系统，用Go编程语言编写。 NATS Streaming服务器的可执行文件名是<a target="_blank" rel="noopener" href="https://github.com/nats-io/nats-streaming-server">nats-streaming-server</a>。 NATS Streaming与核心NATS平台无缝嵌入，扩展和互操作。 NATS Streaming服务器作为Apache-2.0许可下的开源软件提供。 Synadia积极维护和支持NATS Streaming服务器。</p>
<h3 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h3><p>除了核心NATS平台的功能外，NATS Streaming还提供以下功能：</p>
<ul>
<li>增强的消息协议 - NATS Streaming使用谷歌协议缓冲区实现自己的增强型消息格式。这些消息通过二进制数据流在NATS核心平台进行传播,因此不需要改变NATS的基本协议。NATS Streaming信息包含以下字段:<ul>
<li>序列 - 一个全局顺序序列号为主题的通道<br>　　- 主题 - 是NATS Streaming 交付对象<br>　　- 答复内容 - 对应&quot;reply-to&quot;对应的对象内容<br>　　- 数据 - 真是数据内容<br>　　- 时间戳 - 接收的时间戳，单位是纳秒<br>　　- 重复发送 - 标志这条数据是否需要服务再次发送<br>　　- CRC32 - 一个循环冗余数据校验选项，在数据存储和数据通讯领域里，为了保证数据的正确性所采用的检错手段，这里使用的是 IEEE CRC32 算法</li>
</ul>
</li>
<li>消息&#x2F;事件持久性 - NATS Streaming提供了可配置的消息持久化，持久目的地可以为内存或者文件。另外，对应的存储子系统使用了一个公共接口允许我们开发自己自定义实现来持久化对应的消息。</li>
<li>至少一次传送 - NATS Streaming提供了发布者和服务器之间的消息确认(发布操作) 和订阅者和服务器之间的消息确认(确认消息发送)。其中消息被保存在服务器端内存或者辅助存储(或其他外部存储器)用来为需要重新接受消息的订阅者进行重发消息。</li>
<li>发布者发送速率限定 - NATS Streaming提供了一个连接选项叫 MaxPubAcksInFlight，它能有效的限制一个发布者可能随意的在任何时候发送的未被确认的消息。当达到这个配置的最大数量时，异步发送调用接口将会被阻塞，直到未确认消息降到指定数量之下。</li>
<li>每个订户的速率匹配&#x2F;限制 - NATS Streaming运行指定的订阅中设置一个参数为 MaxInFlight，它用来指定已确认但未消费的最大数据量，当达到这个限制时，NATS Streaming 将暂停发送消息给订阅者，直到未确认的数据量小于设定的量为止。</li>
<li>以主题重发的历史数据 - 新订阅的可以在已经存储起来的订阅的主题频道指定起始位置消息流。通过使用这个选项,消息就可以开始发送传递了:<ul>
<li>订阅的主题存储的最早的信息</li>
<li>与当前订阅主题之前的最近存储的数据，这通常被认为是 &quot;最后的值&quot; 或 &quot;初值&quot; 对应的缓存</li>
<li>一个以纳秒为基准的 日期／时间</li>
<li>一个历史的起始位置相对当前服务的 日期／时间，例如：最后30秒</li>
<li>一个特定的消息序列号</li>
</ul>
</li>
<li>持久订阅 - 订阅也可以指定一个“持久化的名称”可以在客户端重启时不受影响。持久订阅会使得对应服务跟踪客户端最后确认消息的序列号和持久名称。当这个客户端重启或者重新订阅的时候，使用相同的客户端ID 和 持久化的名称，对应的服务将会从最早的未被确认的消息处恢复。</li>
</ul>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>NATS为Linux，Mac和Windows提供服务器<a target="_blank" rel="noopener" href="https://www.nats.io/documentation/streaming/nats-streaming-install/">二进制文件</a>。您可以在您选择的任何平台上从源安装服务器。</p>
<h3 id="用法，配置和管理"><a href="#用法，配置和管理" class="headerlink" title="用法，配置和管理"></a>用法，配置和管理</h3><p>NATS Streaming提供了一组丰富的命令和参数来配置服务器的所有方面。有关使用，配置和管理的更多信息，请参阅<a target="_blank" rel="noopener" href="https://github.com/nats-io/nats-streaming-server/">自述文件</a>。</p>
<h2 id="安装NATS-Streaming-Server"><a href="#安装NATS-Streaming-Server" class="headerlink" title="安装NATS Streaming Server"></a>安装NATS Streaming Server</h2><h3 id="安装并运行NATS-Streaming-Server"><a href="#安装并运行NATS-Streaming-Server" class="headerlink" title="安装并运行NATS Streaming Server"></a>安装并运行NATS Streaming Server</h3><p>在本教程中，您将安装并运行NATS Streaming服务器（nats-streaming-server）。您可以在任何时候运行NATS Streaming服务器时遵循相同的过程。</p>
<h4 id="安装NATS-Streaming服务器"><a href="#安装NATS-Streaming服务器" class="headerlink" title="安装NATS Streaming服务器"></a>安装NATS Streaming服务器</h4><p>有许多方法可以安装NATS Streaming服务器。<br><strong>GitHub发布</strong></p>
<p>GitHub版本页面上始终提供最新的官方发行版二进制文件。可以使用以下平台：</p>
<ul>
<li>Linux (x86, x86_64, ARM)</li>
<li>Windows (x86, x86_64)</li>
<li>macOS</li>
</ul>
<p>也可以使用以下方法。请注意，这些方法可能无法安装最新发布的版本：<br><strong>Go</strong></p>
<p>确保设置了Go环境</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">% </span><span class="language-bash">go get github.com/nats-io/nats-streaming-server</span></span><br></pre></td></tr></table></figure>

<p>请注意，此方法可能无法安装最新发布的版本。<br><strong>Docker Hub</strong></p>
<p>Docker Hub上始终提供最新的官方<a target="_blank" rel="noopener" href="https://hub.docker.com/_/nats-streaming/">Docker映像</a>。</p>
<p><strong>Windows</strong></p>
<p>在Windows上，也可以通过Chocolatey安装NATS Streaming服务器：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">% </span><span class="language-bash">choco install nats-streaming-server</span></span><br></pre></td></tr></table></figure>

<p><strong>macOS</strong></p>
<p>在macOS上，可以通过Homebrew安装NATS Streaming服务器：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">% </span><span class="language-bash">brew install nats-streaming-server</span></span><br></pre></td></tr></table></figure>

<p><strong>启动NATS Streaming服务器</strong></p>
<p>您可以调用NATS Streaming服务器二进制文件，没有选项，也没有配置文件，以启动具有可接受的独立默认值的服务器（无身份验证，无群集）。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">% </span><span class="language-bash">nats-streaming-server</span></span><br></pre></td></tr></table></figure>

<p>当服务器成功启动时，您将看到NATS Streaming服务器在TCP端口4222上侦听客户端连接：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[18085] 2016/10/31 13:11:44.059012 [INF] Starting nats-streaming-server[test-cluster] version 0.3.1</span><br><span class="line">[18085] 2016/10/31 13:11:44.059830 [INF] Starting nats-server version 0.9.4</span><br><span class="line">[18085] 2016/10/31 13:11:44.061544 [INF] Listening for client connections on 0.0.0.0:4222</span><br><span class="line">[18085] 2016/10/31 13:11:44.061966 [INF] Server is ready</span><br><span class="line">[18085] 2016/10/31 13:11:44.396819 [INF] STAN: Message store is MEMORY</span><br><span class="line">[18085] 2016/10/31 13:11:44.396832 [INF] STAN: --------- Store Limits ---------</span><br><span class="line">[18085] 2016/10/31 13:11:44.396837 [INF] STAN: Channels:                  100 *</span><br><span class="line">[18085] 2016/10/31 13:11:44.396839 [INF] STAN: -------- channels limits -------</span><br><span class="line">[18085] 2016/10/31 13:11:44.396842 [INF] STAN:   Subscriptions:          1000 *</span><br><span class="line">[18085] 2016/10/31 13:11:44.396844 [INF] STAN:   Messages     :       1000000 *</span><br><span class="line">[18085] 2016/10/31 13:11:44.396855 [INF] STAN:   Bytes        :     976.56 MB *</span><br><span class="line">[18085] 2016/10/31 13:11:44.396858 [INF] STAN:   Age          :     unlimited *</span><br><span class="line">[18085] 2016/10/31 13:11:44.396859 [INF] STAN: --------------------------------</span><br></pre></td></tr></table></figure>



<p><strong>启用NATS监控启动NATS流服务器（可选）</strong></p>
<p>NATS Streaming服务器在端口8222上公开其嵌入式NATS服务器（nats-server）的监视接口。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">% </span><span class="language-bash">nats-streaming-server -m 8222</span></span><br></pre></td></tr></table></figure>

<p>如果在启用监视的情况下运行NATS Streaming服务器，则会看到以下消息：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[18122] 2016/10/31 13:13:10.048663 [INF] Starting nats-streaming-server[test-cluster] version 0.3.1</span><br><span class="line">[18122] 2016/10/31 13:13:10.048843 [INF] Starting nats-server version 0.9.4</span><br><span class="line">[18122] 2016/10/31 13:13:10.048890 [INF] Starting http monitor on 0.0.0.0:8222</span><br><span class="line">[18122] 2016/10/31 13:13:10.048968 [INF] Listening for client connections on 0.0.0.0:4222</span><br><span class="line">[18122] 2016/10/31 13:13:10.048992 [INF] Server is ready</span><br><span class="line">[18122] 2016/10/31 13:13:10.388282 [INF] STAN: Message store is MEMORY</span><br><span class="line">[18122] 2016/10/31 13:13:10.388301 [INF] STAN: --------- Store Limits ---------</span><br><span class="line">[18122] 2016/10/31 13:13:10.388309 [INF] STAN: Channels:                  100 *</span><br><span class="line">[18122] 2016/10/31 13:13:10.388312 [INF] STAN: -------- channels limits -------</span><br><span class="line">[18122] 2016/10/31 13:13:10.388316 [INF] STAN:   Subscriptions:          1000 *</span><br><span class="line">[18122] 2016/10/31 13:13:10.388319 [INF] STAN:   Messages     :       1000000 *</span><br><span class="line">[18122] 2016/10/31 13:13:10.388333 [INF] STAN:   Bytes        :     976.56 MB *</span><br><span class="line">[18122] 2016/10/31 13:13:10.388338 [INF] STAN:   Age          :     unlimited *</span><br><span class="line">[18122] 2016/10/31 13:13:10.388341 [INF] STAN: --------------------------------</span><br></pre></td></tr></table></figure>

<h2 id="NATS-Streaming入门"><a href="#NATS-Streaming入门" class="headerlink" title="NATS Streaming入门"></a>NATS Streaming入门</h2><p>本教程使用示例Go NATS Streaming客户端演示NATS Streaming。</p>
<h3 id="先决条件"><a href="#先决条件" class="headerlink" title="先决条件"></a>先决条件</h3><ul>
<li><a target="_blank" rel="noopener" href="https://help.github.com/articles/set-up-git/">设置你的Git环境</a></li>
<li><a target="_blank" rel="noopener" href="https://golang.org/doc/install">设置Go环境</a></li>
</ul>
<h3 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h3><p>下载并安装<a target="_blank" rel="noopener" href="https://github.com/nats-io/nats-streaming-server/releases">NATS Streaming Server</a>。</p>
<p>克隆以下存储库：</p>
<ul>
<li>NATS Streaming Server: <code>git clone https://github.com/nats-io/nats-streaming-server.git</code></li>
<li>NATS Streaming Client: <code>git clone https://github.com/nats-io/go-nats-streaming.git</code></li>
</ul>
<h3 id="启动NATS-Streaming-Server"><a href="#启动NATS-Streaming-Server" class="headerlink" title="启动NATS Streaming Server"></a>启动NATS Streaming Server</h3><p>两种选择：</p>
<p>运行您下载的二进制文件，例如：$ .&#x2F;nats-streaming-server</p>
<p>或者，从源代码运行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">% </span><span class="language-bash"><span class="built_in">cd</span> <span class="variable">$GOPATH</span>/src/github.com/nats-io/nats-streaming-server</span></span><br><span class="line"><span class="meta prompt_">% </span><span class="language-bash">go run nats-streaming-server.go</span></span><br></pre></td></tr></table></figure>

<p>您应该看到以下内容，表明NATS Streaming Server正在运行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">% </span><span class="language-bash">go run nats-streaming-server.go</span></span><br><span class="line">[89999] 2016/06/25 08:54:35.399071 [INF] Starting nats-streaming-server[test-cluster] version 0.1.0</span><br><span class="line">[89999] 2016/06/25 08:54:35.399315 [INF] Starting nats-server version 0.9.0.beta</span><br><span class="line">[89999] 2016/06/25 08:54:35.399326 [INF] Listening for client connections on localhost:4222</span><br><span class="line">[89999] 2016/06/25 08:54:35.400721 [INF] Server is ready</span><br><span class="line">[89999] 2016/06/25 08:54:35.737589 [INF] STAN: Message store is MEMORY</span><br><span class="line">[89999] 2016/06/25 08:54:35.737610 [INF] STAN: Maximum of 1000000 will be stored</span><br></pre></td></tr></table></figure>

<h3 id="运行发布者客户端"><a href="#运行发布者客户端" class="headerlink" title="运行发布者客户端"></a>运行发布者客户端</h3><p>发布多条消息。对于每个出版物，您应该得到一个结果。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">% </span><span class="language-bash"><span class="built_in">cd</span> <span class="variable">$GOPATH</span>/src/github.com/nats-io/go-nats-streaming/examples/stan-pub</span></span><br><span class="line"><span class="meta prompt_">% </span><span class="language-bash">go run main.go foo <span class="string">&quot;msg one&quot;</span></span></span><br><span class="line">Published [foo] : &#x27;msg one&#x27;</span><br><span class="line"><span class="meta prompt_">% </span><span class="language-bash">go run main.go foo <span class="string">&quot;msg two&quot;</span></span></span><br><span class="line">Published [foo] : &#x27;msg two&#x27;</span><br><span class="line"><span class="meta prompt_">% </span><span class="language-bash">go run main.go foo <span class="string">&quot;msg three&quot;</span></span></span><br><span class="line">Published [foo] : &#x27;msg three&#x27;</span><br></pre></td></tr></table></figure>

<h3 id="运行订户客户端"><a href="#运行订户客户端" class="headerlink" title="运行订户客户端"></a>运行订户客户端</h3><p>使用<code>--all</code>标志接收所有已发布的消息。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">% </span><span class="language-bash"><span class="built_in">cd</span> <span class="variable">$GOPATH</span>/src/github.com/nats-io/go-nats-streaming/examples/stan-sub</span></span><br><span class="line"><span class="meta prompt_">% </span><span class="language-bash">go run main.go --all -c test-cluster -<span class="built_in">id</span> myID foo</span></span><br><span class="line">Connected to nats://localhost:4222 clusterID: [test-cluster] clientID: [myID]</span><br><span class="line">subscribing with DeliverAllAvailable</span><br><span class="line">Listening on [foo], clientID=[myID], qgroup=[] durable=[]</span><br><span class="line"><span class="meta prompt_">[#</span><span class="language-bash">1] Received on [foo]: <span class="string">&#x27;sequence:1 subject:&quot;foo&quot; data:&quot;msg one&quot; timestamp:1465962202884478817 &#x27;</span></span></span><br><span class="line"><span class="meta prompt_">[#</span><span class="language-bash">2] Received on [foo]: <span class="string">&#x27;sequence:2 subject:&quot;foo&quot; data:&quot;msg two&quot; timestamp:1465962208545003897 &#x27;</span></span></span><br><span class="line"><span class="meta prompt_">[#</span><span class="language-bash">3] Received on [foo]: <span class="string">&#x27;sequence:3 subject:&quot;foo&quot; data:&quot;msg three&quot; timestamp:1465962215567601196</span></span></span><br></pre></td></tr></table></figure>

<h3 id="探索其他订阅选项"><a href="#探索其他订阅选项" class="headerlink" title="探索其他订阅选项"></a>探索其他订阅选项</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">--seq &lt;seqno&gt;       Start at seqno</span><br><span class="line">--all               Deliver all available messages</span><br><span class="line">--last              Deliver starting with last published message</span><br><span class="line">--since &lt;duration&gt;  Deliver messages in last interval (e.g. 1s, 1hr, https://golang.org/pkg/time/#ParseDuration)</span><br><span class="line">--durable &lt;name&gt;    Durable subscriber name</span><br><span class="line">--unsubscribe       Unsubscribe the durable on exit</span><br></pre></td></tr></table></figure>

<h2 id="NATS流媒体服务器安全"><a href="#NATS流媒体服务器安全" class="headerlink" title="NATS流媒体服务器安全"></a>NATS流媒体服务器安全</h2><h3 id="验证用户"><a href="#验证用户" class="headerlink" title="验证用户"></a>验证用户</h3><p>要从命令行启用用户身份验证，可以使用与NATS服务器（nats-server）相同的机制。您传入-user <user>和-pass <pass>命令或--auth参数，NATS流服务器将自动使用这些凭据。或者，您可以将配置文件与单个用户或令牌一起使用。</p>
<p>使用具有多用户授权的配置文件时，必须将-user和-pass参数与NATS流服务器一起使用，与配置文件中的用户匹配，以指定NATS流服务器应对其进行身份验证的用户。嵌入式NATS服务器。</p>
<p>例如，如果您向NATS流媒体服务器传递包含多个用户的文件，则必须以配置文件中定义的“Joe”等用户身份运行流服务器。</p>
<h3 id="使用TLS"><a href="#使用TLS" class="headerlink" title="使用TLS"></a>使用TLS</h3><p>虽然NATS Streaming服务器有几个与TLS相关的参数，但保护服务器的连接非常简单。但是，请记住，NATS Streaming服务器嵌入NATS服务器，从而产生客户端 - 服务器关系，其中NATS Streaming服务器是其嵌入式NATS服务器的客户端。</p>
<p>这意味着必须使用两组TLS配置参数：嵌入式NATS服务器的TLS服务器参数，以及NATS流服务器本身的TLS客户端参数。</p>
<p>流服务器使用以下三个参数指定它的TLS客户端证书：</p>
<ul>
<li>-tls_client_key流服务器的客户端密钥</li>
<li>-tls_client_cert流服务器的客户端证书</li>
<li>-tls_client_cacert流媒体服务器的客户端证书CA.</li>
</ul>
<p>这些可能与您的NATS流媒体客户端使用的证书相同。</p>
<p>嵌入式NATS服务器使用以下命令指定TLS服务器证书：</p>
<ul>
<li>--tlscert <file>服务器证书文件</li>
<li>--tlskey <file>服务器证书的私钥</li>
<li>--tlscacert <file>用于验证的客户端证书CA.</li>
</ul>
<p>服务器参数的使用方法与安全典型NATS服务器的方式相同。</p>
<p>正确使用NATS Streaming Server需要使用客户端和服务器参数。</p>
<p>例如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">% </span><span class="language-bash">nats-streaming-server -tls_client_cert client-cert.pem -tls_client_key client-key.pem -tls_client_cacert ca.pem -tlscert server-cert.pem -tlskey server-key.pem -tlscacert ca.pem</span></span><br></pre></td></tr></table></figure>

<p>进一步的TLS相关功能可以在Securing NATS&gt; TLS中找到。请注意，如果需要指定密码套件，则可以通过<code>-config</code>命令行参数传递嵌入式NATS服务器的配置文件。</p>
<h2 id="NATS-Streaming-Protocol"><a href="#NATS-Streaming-Protocol" class="headerlink" title="NATS Streaming Protocol"></a>NATS Streaming Protocol</h2><p>The NATS streaming protocol sits atop the core <a target="_blank" rel="noopener" href="https://www.nats.io/documentation/internals/nats-protocol">NATS protocol</a> and uses <a target="_blank" rel="noopener" href="https://developers.google.com/protocol-buffers/">Google’s Protocol Buffers</a>.  Protocol buffer messages are marshaled into bytes and published as NATS  messages on specific subjects described below. In communicating with  the NATS Streaming Server, the NATS <a target="_blank" rel="noopener" href="https://www.nats.io/documentation/writing_applications/concepts">request&#x2F;reply</a> pattern is used for all protocol messages that have a corresponding reply.</p>
<h3 id="NATS-streaming-protocol-conventions"><a href="#NATS-streaming-protocol-conventions" class="headerlink" title="NATS streaming protocol conventions"></a>NATS streaming protocol conventions</h3><p><strong>Subject names</strong>:  Subject names, including reply subject (INBOX) names, are  case-sensitive and must be non-empty alphanumeric strings with no  embedded whitespace, and optionally token-delimited using the dot  character (<code>.</code>), e.g.:</p>
<p><code>FOO</code>, <code>BAR</code>, <code>foo.bar</code>, <code>foo.BAR</code>, <code>FOO.BAR</code> and <code>FOO.BAR.BAZ</code> are all valid subject names</p>
<p><code>FOO. BAR</code>, <code>foo. .bar</code> and<code>foo..bar</code> are *not- valid subject names</p>
<p><strong>Wildcards</strong>: NATS streaming does *<em>not</em>- support wildcards in subject subscriptions</p>
<p><strong>Protocol definition</strong>: The fields of NATS streaming protocol messages are defined in the go-nats-streaming <a target="_blank" rel="noopener" href="https://github.com/nats-io/go-nats-streaming/blob/master/pb/protocol.proto">protocol file</a>.</p>
<h3 id="NATS-streaming-protocol-messages"><a href="#NATS-streaming-protocol-messages" class="headerlink" title="NATS streaming protocol messages"></a>NATS streaming protocol messages</h3><p>The following table briefly describes the NATS streaming protocol messages.</p>
<p>Click the name to see more detailed information, including usage:</p>
<table>
<thead>
<tr>
<th>Message Name</th>
<th>Sent By</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><a target="_blank" rel="noopener" href="https://www.nats.io/documentation/streaming/nats-streaming-protocol/#CONNREQ"><code>ConnectRequest</code></a></td>
<td>Client</td>
<td>Request to connect to the NATS Streaming Server</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://www.nats.io/documentation/streaming/nats-streaming-protocol/#CONNRESP"><code>ConnectResponse</code></a></td>
<td>Server</td>
<td>Result of a connection request</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://www.nats.io/documentation/streaming/nats-streaming-protocol/#SUBREQ"><code>SubscriptionRequest</code></a></td>
<td>Client</td>
<td>Request sent to subscribe and retrieve data</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://www.nats.io/documentation/streaming/nats-streaming-protocol/#SUBRESP"><code>SubscriptionResponse</code></a></td>
<td>Server</td>
<td>Result of a subscription request</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://www.nats.io/documentation/streaming/nats-streaming-protocol/#UNSUBREQ"><code>UnsubscribeRequest</code></a></td>
<td>Client</td>
<td>Unsubscribe from a subject</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://www.nats.io/documentation/streaming/nats-streaming-protocol/#PUBMSG"><code>PubMsg</code></a></td>
<td>Client</td>
<td>Publish a message to a subject, with optional reply subject</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://www.nats.io/documentation/streaming/nats-streaming-protocol/#PUBACK"><code>PubAck</code></a></td>
<td>Server</td>
<td>An acknowledgement that a published message has been processed on the server</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://www.nats.io/documentation/streaming/nats-streaming-protocol/#MSGPROTO"><code>MsgProto</code></a></td>
<td>Server</td>
<td>A message from the NATS Streaming Server to a subscribing client</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://www.nats.io/documentation/streaming/nats-streaming-protocol/#ACK"><code>Ack</code></a></td>
<td>Client</td>
<td>Acknowledges that a message has been received</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://www.nats.io/documentation/streaming/nats-streaming-protocol/#CLOSEREQ"><code>CloseRequest</code></a></td>
<td>Client</td>
<td>Request sent to close the connection to the NATS Streaming Server</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://www.nats.io/documentation/streaming/nats-streaming-protocol/#CLOSERESP"><code>CloseResp</code></a></td>
<td>Server</td>
<td>Result of the close request</td>
</tr>
</tbody></table>
<p>The following sections explain each protocol message.</p>
<h3 id="ConnectRequest"><a href="#ConnectRequest" class="headerlink" title="ConnectRequest"></a>ConnectRequest</h3><p><strong>Description</strong></p>
<p>A  connection request is sent when a streaming client connects to the NATS  Streaming Server. The connection request contains a unique identifier  representing the client, and an inbox subject the client will listen on  for incoming heartbeats. The identifier *<em>must</em>- be unique; a  connection attempt with an identifier currently in use will fail. The  inbox subject is the subject where the client receives incoming  heartbeats, and responds by publishing an empty NATS message to the  reply subject, indicating it is alive. The NATS Streaming Server will  return a <a target="_blank" rel="noopener" href="https://www.nats.io/documentation/streaming/nats-streaming-protocol/#CONNRESP">ConnectResponse</a> message to the reply subject specified in the NATS request message.</p>
<p>This request is published to a subject comprised of the <code>&lt;discover-prefix&gt;.cluster-id</code>, for example, if a NATS Streaming Server was started with a cluster-id of <code>mycluster</code>, and the default prefix was used, the client publishes to <code>_STAN.discover.mycluster</code></p>
<p><strong>Message Structure</strong></p>
<ul>
<li><code>clientID</code>: A unique identifier for a client</li>
<li><code>heartbeatInbox</code>: An inbox to which the NATS Streaming Server will send heartbeats for the client to process</li>
</ul>
<h3 id="ConnectResponse"><a href="#ConnectResponse" class="headerlink" title="ConnectResponse"></a>ConnectResponse</h3><p><strong>Description</strong></p>
<p>After a <code>ConnectRequest</code>  is published, the NATS Streaming Server responds with this message on  the reply subject of the underlying NATS request. The NATS Streaming  Server requires the client to make requests and publish messages on  certain subjects (described above), and when a connection is successful,  the client saves the information returned to be used in sending other  NATS streaming protocol messages. In the event the connection was not  successful, an error is returned in the <code>error</code> field.</p>
<p><strong>Message Structure</strong></p>
<ul>
<li><code>pubPrefix</code>: Prefix to use when publishing</li>
<li><code>subRequests</code>: Subject used for subscription requests</li>
<li><code>unsubRequests</code>: Subject used for unsubscribe requests</li>
<li><code>closeRequests</code>: Subject for closing a connection</li>
<li><code>error</code>: An error string, which will be empty&#x2F;omitted upon success</li>
<li><code>publicKey</code>: Reserved for future use</li>
</ul>
<h3 id="SubscriptionRequest"><a href="#SubscriptionRequest" class="headerlink" title="SubscriptionRequest"></a>SubscriptionRequest</h3><p><strong>Description</strong></p>
<p>A <code>SubscriptionRequest</code> is published on the subject returned in the <code>subRequests</code> field of a <a target="_blank" rel="noopener" href="https://www.nats.io/documentation/streaming/nats-streaming-protocol/#CONNRESP"><code>ConnectResponse</code></a>, and creates a subscription to a subject on the NATS Streaming Server. This will return a <a target="_blank" rel="noopener" href="https://www.nats.io/documentation/streaming/nats-streaming-protocol/#SUBRESP">SubscriptionResponse</a> message to the reply subject specified in the NATS protocol request message.</p>
<p><strong>Message Structure</strong></p>
<ul>
<li><code>clientID</code>: Client ID originally provided in the <a target="_blank" rel="noopener" href="https://www.nats.io/documentation/streaming/nats-streaming-protocol/#CONNREQ">ConnectRequest</a></li>
<li><code>subject</code>: Formal subject to subscribe to, e.g. foo.bar</li>
<li><code>qGroup</code>: Optional queue group</li>
<li><code>inbox</code>: Inbox subject to deliver messages on</li>
<li><code>maxInFlight</code>: Maximum inflight messages without an acknowledgement allowed</li>
<li><code>ackWaitInSecs</code>: Timeout for receiving an acknowledgement from the client</li>
<li><code>durableName</code>: Optional durable name which survives client restarts</li>
<li><code>startPosition</code>: An enumerated type specifying the point in history to start replaying data</li>
<li><code>startSequence</code>: Optional start sequence number</li>
<li><code>startTimeDelta</code>: Optional start time</li>
</ul>
<p><strong>StartPosition enumeration</strong></p>
<ul>
<li><code>NewOnly</code>: Send only new messages</li>
<li><code>LastReceived</code>: Send only the last received message</li>
<li><code>TimeDeltaStart</code>: Send messages from duration specified in the <code>startTimeDelta</code> field.</li>
<li><code>SequenceStart</code>: Send messages starting from the sequence in the <code>startSequence</code> field.</li>
<li><code>First</code>: Send all available messages</li>
</ul>
<h3 id="SubscriptionResponse"><a href="#SubscriptionResponse" class="headerlink" title="SubscriptionResponse"></a>SubscriptionResponse</h3><p><strong>Description</strong></p>
<p>The <code>SubscriptionResponse</code> message is the response from the <code>SubscriptionRequest</code>. After a client has processed an incoming <a target="_blank" rel="noopener" href="https://www.nats.io/documentation/streaming/nats-streaming-protocol/#MSGPROTO">MsgProto</a> message, it must send an acknowledgement to the <code>ackInbox</code> subject provided here.</p>
<p><strong>Message Structure</strong></p>
<ul>
<li><code>ackInbox</code>: subject the client sends message acknowledgements to the NATS Streaming Server</li>
<li><code>error</code>: error string, empty&#x2F;omitted if no error</li>
</ul>
<h3 id="UnsubscribeRequest"><a href="#UnsubscribeRequest" class="headerlink" title="UnsubscribeRequest"></a>UnsubscribeRequest</h3><p><strong>Description</strong></p>
<p>The <code>UnsubscribeRequest</code> unsubcribes the connection from the specified subject. The inbox specified is the <code>inbox</code> returned from the NATS Streaming Server in the <code>SubscriptionResponse</code>.</p>
<p><strong>Message Structure</strong></p>
<ul>
<li><code>clientID</code>: Client ID originally provided in the <a target="_blank" rel="noopener" href="https://www.nats.io/documentation/streaming/nats-streaming-protocol/#CONNREQ">ConnectRequest</a></li>
<li><code>subject</code>: Subject for the subscription</li>
<li><code>inbox</code>: Inbox subject to identify subscription</li>
<li><code>durableName</code>: Optional durable name which survives client restarts</li>
</ul>
<h3 id="PubMsg"><a href="#PubMsg" class="headerlink" title="PubMsg"></a>PubMsg</h3><p><strong>Description</strong></p>
<p>The <code>PubMsg</code> protocol message is published from a client to the NATS Streaming Server. The GUID must be unique, and is returned in the <a target="_blank" rel="noopener" href="https://www.nats.io/documentation/streaming/nats-streaming-protocol/#PUBACK">PubAck</a> message to correlate the success or failure of storing this particular message.</p>
<p><strong>Message Structure</strong></p>
<ul>
<li><code>clientID</code>: Client ID originally provided in the <a target="_blank" rel="noopener" href="https://www.nats.io/documentation/streaming/nats-streaming-protocol/#CONNREQ">ConnectRequest</a></li>
<li><code>guid</code>: a guid generated for this particular message</li>
<li><code>subject</code>: subject</li>
<li><code>reply</code>: optional reply subject</li>
<li><code>data</code>: payload</li>
<li><code>sha256</code>: optional sha256 of payload data</li>
</ul>
<h3 id="PubAck"><a href="#PubAck" class="headerlink" title="PubAck"></a>PubAck</h3><p><strong>Description</strong></p>
<p>The <code>PubAck</code>  message is an acknowledgement from the NATS Streaming Server that a  message has been processed. The message arrives on the subject specified  on the reply subject of the NATS message the <code>PubMsg</code> was published on. The GUID is the same GUID used in the <code>PubMsg</code>  being acknowledged. If an error string is present, the message was not  persisted by the NATS Streaming Server and no guarantees regarding  persistence are honored. <code>PubAck</code> messages may be handled asynchronously from their corresponding <code>PubMsg</code> in the client.</p>
<p><strong>Message Structure</strong></p>
<ul>
<li><code>guid</code>: GUID of the message being acknowledged by the NATS Streaming Server</li>
<li><code>error</code>: An error string, empty&#x2F;omitted if no error</li>
</ul>
<h3 id="MsgProto"><a href="#MsgProto" class="headerlink" title="MsgProto"></a>MsgProto</h3><p><strong>Description</strong></p>
<p>The <code>MsgProto</code> message is received by client from the NATS Streaming Server, containing the payload of messages sent by a publisher. A <code>MsgProto</code> message that is not acknowledged with an <a target="_blank" rel="noopener" href="https://www.nats.io/documentation/streaming/nats-streaming-protocol/#ACK">Ack</a> message within the duration specified by the <code>ackWaitInSecs</code> field of the subscription request will be redelivered.</p>
<p><strong>Message Structure</strong></p>
<ul>
<li><code>sequence</code>: Globally ordered sequence number for the subject’s channel</li>
<li><code>subject</code>: Subject</li>
<li><code>reply</code>: Optional reply</li>
<li><code>data</code>: Payload</li>
<li><code>timestamp</code>: Time the message was stored in the server.</li>
<li><code>redelivered</code>: Flag specifying if the message is being redelivered</li>
<li><code>CRC32</code>: Optional IEEE CRC32</li>
</ul>
<h3 id="Ack"><a href="#Ack" class="headerlink" title="Ack"></a>Ack</h3><p><strong>Description</strong></p>
<p>An <code>Ack</code> message is an acknowledgement from the client that a <a target="_blank" rel="noopener" href="https://www.nats.io/documentation/streaming/nats-streaming-protocol/#MSGPROTO">MsgProto</a> message has been considered received. It is published to the <code>ackInbox</code> field of the <a target="_blank" rel="noopener" href="https://www.nats.io/documentation/streaming/nats-streaming-protocol/#SUBRESP"><code>SubscriptionResponse</code></a>.</p>
<p><strong>Message Structure</strong></p>
<ul>
<li><code>subject</code>: Subject of the message being acknowledged</li>
<li><code>sequence</code>: Sequence of the message being acknowledged</li>
</ul>
<h3 id="CloseRequest"><a href="#CloseRequest" class="headerlink" title="CloseRequest"></a>CloseRequest</h3><p><strong>Description</strong></p>
<p>A <code>CloseRequest</code> message is published on the <code>closeRequests</code> subject from the <a target="_blank" rel="noopener" href="https://www.nats.io/documentation/streaming/nats-streaming-protocol/#CONNRESP"><code>ConnectResponse</code></a>,  and notifies the NATS Streaming Server that the client connection is  closing, allowing the server to free up resources. This message should *<em>always</em>- be sent when a client is finished using a connection.</p>
<p><strong>Message Structure</strong></p>
<ul>
<li><code>clientID</code>: Client ID originally provided in the <a target="_blank" rel="noopener" href="https://www.nats.io/documentation/streaming/nats-streaming-protocol/#CONNREQ">ConnectRequest</a></li>
</ul>
<h3 id="CloseResponse"><a href="#CloseResponse" class="headerlink" title="CloseResponse"></a>CloseResponse</h3><p><strong>Description</strong></p>
<p>The <code>CloseResponse</code> is sent by the NATS Streaming Server on the reply subject of the <code>CloseRequest</code> NATS message. This response contains any error that may have occurred with the corresponding close call.</p>
<p><strong>Message Structure</strong></p>
<ul>
<li><code>error</code>: error string, empty&#x2F;omitted if no error</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://wangyyovo.github.io">Blank</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://wangyyovo.github.io/posts/e845c472/">https://wangyyovo.github.io/posts/e845c472/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://wangyyovo.github.io" target="_blank">Blank</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/nats/95994a9aea31be452e66c89e68ba4a27.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/ShareJS/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/ShareJS/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/cd0e56c9/"><img class="prev-cover" src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/nats/939916bec37ea8f169680b4d133f4a86.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">NATS和NATS Streaming</div></div></a></div><div class="next-post pull-right"><a href="/posts/7f2c8890/"><img class="next-cover" src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/nats/285494672816019cfb027039031cb3ca.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Nats管理服务器</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/theme/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Blank</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">356</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">36</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">54</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/wangyyovo" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:xxxxxx@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fas fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#NATS-Streaming"><span class="toc-text">NATS Streaming</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#NATS-Streaming-%E6%A6%82%E5%BF%B5"><span class="toc-text">NATS Streaming 概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%89%B9%E7%82%B9"><span class="toc-text">特点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-text">安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E6%B3%95%EF%BC%8C%E9%85%8D%E7%BD%AE%E5%92%8C%E7%AE%A1%E7%90%86"><span class="toc-text">用法，配置和管理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85NATS-Streaming-Server"><span class="toc-text">安装NATS Streaming Server</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E5%B9%B6%E8%BF%90%E8%A1%8CNATS-Streaming-Server"><span class="toc-text">安装并运行NATS Streaming Server</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85NATS-Streaming%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-text">安装NATS Streaming服务器</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NATS-Streaming%E5%85%A5%E9%97%A8"><span class="toc-text">NATS Streaming入门</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%88%E5%86%B3%E6%9D%A1%E4%BB%B6"><span class="toc-text">先决条件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-1"><span class="toc-text">安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8NATS-Streaming-Server"><span class="toc-text">启动NATS Streaming Server</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E5%8F%91%E5%B8%83%E8%80%85%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-text">运行发布者客户端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E8%AE%A2%E6%88%B7%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-text">运行订户客户端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A2%E7%B4%A2%E5%85%B6%E4%BB%96%E8%AE%A2%E9%98%85%E9%80%89%E9%A1%B9"><span class="toc-text">探索其他订阅选项</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NATS%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AE%89%E5%85%A8"><span class="toc-text">NATS流媒体服务器安全</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E7%94%A8%E6%88%B7"><span class="toc-text">验证用户</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8TLS"><span class="toc-text">使用TLS</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NATS-Streaming-Protocol"><span class="toc-text">NATS Streaming Protocol</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#NATS-streaming-protocol-conventions"><span class="toc-text">NATS streaming protocol conventions</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NATS-streaming-protocol-messages"><span class="toc-text">NATS streaming protocol messages</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ConnectRequest"><span class="toc-text">ConnectRequest</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ConnectResponse"><span class="toc-text">ConnectResponse</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SubscriptionRequest"><span class="toc-text">SubscriptionRequest</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SubscriptionResponse"><span class="toc-text">SubscriptionResponse</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UnsubscribeRequest"><span class="toc-text">UnsubscribeRequest</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PubMsg"><span class="toc-text">PubMsg</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PubAck"><span class="toc-text">PubAck</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MsgProto"><span class="toc-text">MsgProto</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Ack"><span class="toc-text">Ack</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CloseRequest"><span class="toc-text">CloseRequest</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CloseResponse"><span class="toc-text">CloseResponse</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/d14168d/" title="虚拟机问题合集"><img src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/hexo/090cfe4e9e60b0ad0de05db822f3ae97.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="虚拟机问题合集"/></a><div class="content"><a class="title" href="/posts/d14168d/" title="虚拟机问题合集">虚拟机问题合集</a><time datetime="2022-07-16T13:30:36.000Z" title="发表于 2022-07-16 21:30:36">2022-07-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/f540045f/" title="用go语言编写移动端sdk和app开发"><img src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/golang/941ed1ec2925719a0c92e76f4f786b6a.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="用go语言编写移动端sdk和app开发"/></a><div class="content"><a class="title" href="/posts/f540045f/" title="用go语言编写移动端sdk和app开发">用go语言编写移动端sdk和app开发</a><time datetime="2022-07-04T12:14:21.000Z" title="发表于 2022-07-04 20:14:21">2022-07-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/5faac006/" title="在线编程IDE"><img src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/hexo/090cfe4e9e60b0ad0de05db822f3ae97.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="在线编程IDE"/></a><div class="content"><a class="title" href="/posts/5faac006/" title="在线编程IDE">在线编程IDE</a><time datetime="2022-06-12T13:30:36.000Z" title="发表于 2022-06-12 21:30:36">2022-06-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/7594185d/" title="即时性能分析工具Pyroscope"><img src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/golang/3bfb3279740bc9a5b5ef436fa887ef07.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="即时性能分析工具Pyroscope"/></a><div class="content"><a class="title" href="/posts/7594185d/" title="即时性能分析工具Pyroscope">即时性能分析工具Pyroscope</a><time datetime="2022-06-12T08:07:36.000Z" title="发表于 2022-06-12 16:07:36">2022-06-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/82a7aa7c/" title="golang性能调试优化方法"><img src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/common/3.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="golang性能调试优化方法"/></a><div class="content"><a class="title" href="/posts/82a7aa7c/" title="golang性能调试优化方法">golang性能调试优化方法</a><time datetime="2022-06-12T03:00:36.000Z" title="发表于 2022-06-12 11:00:36">2022-06-12</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By Blank</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://wangyyovo.github.io/">blog</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@5/instantpage.js" type="module"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '49gEIIGN7uRbL6vHhieSpBzM-MdYXbMMI',
      appKey: 'uqts0urLKwikYQ0fKmIkMHBE',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><div class="aplayer no-destroy" data-id="000PeZCQ1i4XVs" data-server="tencent" data-type="artist" data-fixed="true" data-mini="true" data-listFolded="false" data-order="random" data-preload="none" data-autoplay="false" muted></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-heart.min.js" async="async" mobile="false"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer@1/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/MetingJS/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>