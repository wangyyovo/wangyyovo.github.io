<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>创建型模式-单例模式 | Blank</title><meta name="author" content="Blank"><meta name="copyright" content="Blank"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="https:&#x2F;&#x2F;refactoringguru.cn&#x2F;design-patterns&#x2F;singleton  创建型模式-单例模式亦称： 单件模式、Singleton 意图单例模式是一种创建型设计模式， 让你能够保证一个类只有一个实例， 并提供一个访问该实例的全局节点。  问题单例模式同时解决了两个问题， 所以违反了_单一职责原则_：  保证一个类只有一个实例。 为什么会有人想要控制一个类所拥有">
<meta property="og:type" content="article">
<meta property="og:title" content="创建型模式-单例模式">
<meta property="og:url" content="https://wangyyovo.github.io/posts/37f0d8f/">
<meta property="og:site_name" content="Blank">
<meta property="og:description" content="https:&#x2F;&#x2F;refactoringguru.cn&#x2F;design-patterns&#x2F;singleton  创建型模式-单例模式亦称： 单件模式、Singleton 意图单例模式是一种创建型设计模式， 让你能够保证一个类只有一个实例， 并提供一个访问该实例的全局节点。  问题单例模式同时解决了两个问题， 所以违反了_单一职责原则_：  保证一个类只有一个实例。 为什么会有人想要控制一个类所拥有">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/common/6cc78f9be0372c0d330f2c7d326f7d9e.jpg">
<meta property="article:published_time" content="2021-05-03T09:22:45.000Z">
<meta property="article:modified_time" content="2021-05-03T09:22:45.000Z">
<meta property="article:author" content="Blank">
<meta property="article:tag" content="pattern">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/common/6cc78f9be0372c0d330f2c7d326f7d9e.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "创建型模式-单例模式",
  "url": "https://wangyyovo.github.io/posts/37f0d8f/",
  "image": "https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/common/6cc78f9be0372c0d330f2c7d326f7d9e.jpg",
  "datePublished": "2021-05-03T09:22:45.000Z",
  "dateModified": "2021-05-03T09:22:45.000Z",
  "author": [
    {
      "@type": "Person",
      "name": "Blank",
      "url": "https://wangyyovo.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/theme/favicon.ico"><link rel="canonical" href="https://wangyyovo.github.io/posts/37f0d8f/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":400,"highlightFullpage":true,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":150,"languages":{"author":"作者: Blank","link":"链接: ","source":"来源: Blank","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '创建型模式-单例模式',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="alternate" href="/atom.xml" title="Blank" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/theme/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">352</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">46</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">58</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fas fa-comment-dots"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 娱乐</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-image"></i><span> 相册</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-book"></i><span> 教程</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/posts/21cfbf15/"><span> 🚀 快速開始</span></a></li><li><a class="site-page child" href="/posts/dc584b87/"><span> 📑 主題頁面</span></a></li><li><a class="site-page child" href="/posts/4aa8abbe/"><span> 🛠 主題配置</span></a></li><li><a class="site-page child" href="/posts/ceeb73f/"><span> ⚔️ 標簽外挂</span></a></li><li><a class="site-page child" href="/posts/98d20436/"><span> ❓ 主題問答</span></a></li><li><a class="site-page child" href="/posts/4073eda/"><span> ⚡️ 進階教程</span></a></li><li><a class="site-page child" href="/posts/507c070f/"><span> 📑 Aplayer教程</span></a></li><li><a class="site-page child" href="/posts/2df239ce/"><span> 📑 標籤外掛</span></a></li><li><a class="site-page child" href="/posts/b37b5fe3/"><span> 📑 自定義代碼配色</span></a></li><li><a class="site-page child" href="/posts/ea33ab97/"><span> 📑 自定義側邊欄</span></a></li><li><a class="site-page child" href="/posts/89757140/"><span> 📑 Markdown</span></a></li><li><a class="site-page child" href="/posts/9db656e5/"><span> 📑 代码高亮测试</span></a></li><li><a class="site-page child" href="/posts/c9711c19/"><span> 📑 當設置top_img為false時</span></a></li><li><a class="site-page child" href="/posts/39b121ef/"><span> 📑 Hexo內置標籤外掛</span></a></li><li><a class="site-page child" href="/posts/7670b080/"><span> 📑 Butterfly 美化/優化/魔改 教程合集</span></a></li><li><a class="site-page child" href="/posts/913b2502/"><span> 📑 没有封面</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-language"></i><span> 语言</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/"><i class="fa-fw fas fa-c"></i><span> 中文</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/common/6cc78f9be0372c0d330f2c7d326f7d9e.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Blank</span></a><a class="nav-page-title" href="/"><span class="site-name">创建型模式-单例模式</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fas fa-comment-dots"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 娱乐</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-image"></i><span> 相册</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-book"></i><span> 教程</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/posts/21cfbf15/"><span> 🚀 快速開始</span></a></li><li><a class="site-page child" href="/posts/dc584b87/"><span> 📑 主題頁面</span></a></li><li><a class="site-page child" href="/posts/4aa8abbe/"><span> 🛠 主題配置</span></a></li><li><a class="site-page child" href="/posts/ceeb73f/"><span> ⚔️ 標簽外挂</span></a></li><li><a class="site-page child" href="/posts/98d20436/"><span> ❓ 主題問答</span></a></li><li><a class="site-page child" href="/posts/4073eda/"><span> ⚡️ 進階教程</span></a></li><li><a class="site-page child" href="/posts/507c070f/"><span> 📑 Aplayer教程</span></a></li><li><a class="site-page child" href="/posts/2df239ce/"><span> 📑 標籤外掛</span></a></li><li><a class="site-page child" href="/posts/b37b5fe3/"><span> 📑 自定義代碼配色</span></a></li><li><a class="site-page child" href="/posts/ea33ab97/"><span> 📑 自定義側邊欄</span></a></li><li><a class="site-page child" href="/posts/89757140/"><span> 📑 Markdown</span></a></li><li><a class="site-page child" href="/posts/9db656e5/"><span> 📑 代码高亮测试</span></a></li><li><a class="site-page child" href="/posts/c9711c19/"><span> 📑 當設置top_img為false時</span></a></li><li><a class="site-page child" href="/posts/39b121ef/"><span> 📑 Hexo內置標籤外掛</span></a></li><li><a class="site-page child" href="/posts/7670b080/"><span> 📑 Butterfly 美化/優化/魔改 教程合集</span></a></li><li><a class="site-page child" href="/posts/913b2502/"><span> 📑 没有封面</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-language"></i><span> 语言</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/"><i class="fa-fw fas fa-c"></i><span> 中文</span></a></li></ul></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">创建型模式-单例模式</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-05-03T09:22:45.000Z" title="发表于 2021-05-03 17:22:45">2021-05-03</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-05-03T09:22:45.000Z" title="更新于 2021-05-03 17:22:45">2021-05-03</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/pattern/">pattern</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">9.8k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>45分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><script src="\assets\js\APlayer.min.js"> </script><blockquote>
<p><a target="_blank" rel="noopener" href="https://refactoringguru.cn/design-patterns/singleton">https://refactoringguru.cn/design-patterns/singleton</a></p>
</blockquote>
<h1 id="创建型模式-单例模式"><a href="#创建型模式-单例模式" class="headerlink" title="创建型模式-单例模式"></a>创建型模式-单例模式</h1><p><strong>亦称：</strong> 单件模式、Singleton</p>
<h2 id="意图"><a href="#意图" class="headerlink" title="意图"></a>意图</h2><p><strong>单例模式</strong>是一种创建型设计模式， 让你能够保证一个类只有一个实例， 并提供一个访问该实例的全局节点。</p>
<p><img src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/blog/pattern/singleton.png"></p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>单例模式同时解决了两个问题， 所以违反了_单一职责原则_：</p>
<ol>
<li><p><strong>保证一个类只有一个实例</strong>。 为什么会有人想要控制一个类所拥有的实例数量？ 最常见的原因是控制某些共享资源 （例如数据库或文件） 的访问权限。</p>
<p>它的运作方式是这样的： 如果你创建了一个对象， 同时过一会儿后你决定再创建一个新对象， 此时你会获得之前已创建的对象， 而不是一个新对象。</p>
<p>注意， 普通构造函数无法实现上述行为， 因为构造函数的设计决定了它<strong>必须</strong>总是返回一个新对象。</p>
<p><img src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/blog/pattern/singleton-comic-1-zh.png" alt="客户端甚至可能没有意识到它们一直都在使用同一个对象"></p>
</li>
<li><p><strong>为该实例提供一个全局访问节点</strong>。 还记得你 （好吧， 其实是我自己） 用过的那些存储重要对象的全局变量吗？ 它们在使用上十分方便， 但同时也非常不安全， 因为任何代码都有可能覆盖掉那些变量的内容， 从而引发程序崩溃。</p>
<p>和全局变量一样， 单例模式也允许在程序的任何地方访问特定对象。 但是它可以保护该实例不被其他代码覆盖。</p>
<p>还有一点： 你不会希望解决同一个问题的代码分散在程序各处的。 因此更好的方式是将其放在同一个类中， 特别是当其他代码已经依赖这个类时更应该如此。</p>
</li>
</ol>
<p>如今， 单例模式已经变得非常流行， 以至于人们会将只解决上文描述中任意一个问题的东西称为<em>单例</em>。</p>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>所有单例的实现都包含以下两个相同的步骤：</p>
<ul>
<li>将默认构造函数设为私有， 防止其他对象使用单例类的 <code>new</code>运算符。</li>
<li>新建一个静态构建方法作为构造函数。 该函数会 “偷偷” 调用私有构造函数来创建对象， 并将其保存在一个静态成员变量中。 此后所有对于该函数的调用都将返回这一缓存对象。</li>
</ul>
<p>如果你的代码能够访问单例类， 那它就能调用单例类的静态方法。 无论何时调用该方法， 它总是会返回相同的对象。</p>
<h2 id="真实世界类比"><a href="#真实世界类比" class="headerlink" title="真实世界类比"></a>真实世界类比</h2><p>政府是单例模式的一个很好的示例。 一个国家只有一个官方政府。 不管组成政府的每个人的身份是什么，  “某政府” 这一称谓总是鉴别那些掌权者的全局访问节点。</p>
<h2 id="单例模式结构"><a href="#单例模式结构" class="headerlink" title="单例模式结构"></a>单例模式结构</h2><p><img src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/blog/pattern/structure-zh-indexed.png"></p>
<ol>
<li><p><strong>单例</strong> （Singleton） 类声明了一个名为 <code>get­Instance</code>获取实例的静态方法来返回其所属类的一个相同实例。</p>
<p>单例的构造函数必须对客户端 （Client） 代码隐藏。 调用 <code>获取实例</code>方法必须是获取单例对象的唯一方式。</p>
</li>
</ol>
<h2 id="伪代码"><a href="#伪代码" class="headerlink" title="伪代码"></a>伪代码</h2><p>在本例中， 数据库连接类即是一个<strong>单例</strong>。</p>
<p>该类不提供公有构造函数， 因此获取该对象的唯一方式是调用 <code>获取实例</code>方法。 该方法将缓存首次生成的对象， 并为所有后续调用返回该对象。</p>
<figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 数据库类会对`getInstance（获取实例）`方法进行定义以让客户端在程序各处</span></span><br><span class="line"><span class="comment">// 都能访问相同的数据库连接实例。</span></span><br><span class="line"><span class="keyword">class</span> Database <span class="keyword">is</span></span><br><span class="line">    <span class="comment">// 保存单例实例的成员变量必须被声明为静态类型。</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> field instance: Database</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 单例的构造函数必须永远是私有类型，以防止使用`new`运算符直接调用构</span></span><br><span class="line">    <span class="comment">// 造方法。</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">constructor</span> <span class="title">Database</span><span class="params">()</span> <span class="title">is</span></span></span><br><span class="line"><span class="function">        <span class="comment">// 部分初始化代码（例如到数据库服务器的实际连接）。</span></span></span><br><span class="line"><span class="function">        <span class="comment">// ...</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    <span class="comment">// 用于控制对单例实例的访问权限的静态方法。</span></span></span><br><span class="line"><span class="function">    <span class="title">public</span> <span class="title">static</span> <span class="title">method</span> <span class="title">getInstance</span><span class="params">()</span> <span class="title">is</span></span></span><br><span class="line"><span class="function">        <span class="title">if</span> <span class="params">(Database.instance == null)</span> <span class="title">then</span></span></span><br><span class="line"><span class="function">            <span class="title">acquireThreadLock</span><span class="params">()</span> <span class="title">and</span> <span class="title">then</span></span></span><br><span class="line"><span class="function">                <span class="comment">// 确保在该线程等待解锁时，其他线程没有初始化该实例。</span></span></span><br><span class="line"><span class="function">                <span class="title">if</span> <span class="params">(Database.instance == null)</span> <span class="title">then</span></span></span><br><span class="line"><span class="function">                    <span class="title">Database</span>.<span class="title">instance</span> = <span class="title">new</span> <span class="title">Database</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        <span class="title">return</span> <span class="title">Database</span>.<span class="title">instance</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    <span class="comment">// 最后，任何单例都必须定义一些可在其实例上执行的业务逻辑。</span></span></span><br><span class="line"><span class="function">    <span class="title">public</span> <span class="title">method</span> <span class="title">query</span><span class="params">(sql)</span> <span class="title">is</span></span></span><br><span class="line"><span class="function">        <span class="comment">// 比如应用的所有数据库查询请求都需要通过该方法进行。因此，你可以</span></span></span><br><span class="line"><span class="function">        <span class="comment">// 在这里添加限流或缓冲逻辑。</span></span></span><br><span class="line"><span class="function">        <span class="comment">// ...</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">class</span> <span class="title">Application</span> <span class="title">is</span></span></span><br><span class="line"><span class="function">    <span class="title">method</span> <span class="title">main</span><span class="params">()</span> <span class="title">is</span></span></span><br><span class="line"><span class="function">        <span class="title">Database</span> <span class="title">foo</span> = <span class="title">Database</span>.<span class="title">getInstance</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        <span class="title">foo</span>.<span class="title">query</span><span class="params">(&quot;SELECT ...&quot;)</span></span></span><br><span class="line"><span class="function">        <span class="comment">// ...</span></span></span><br><span class="line"><span class="function">        <span class="title">Database</span> <span class="title">bar</span> = <span class="title">Database</span>.<span class="title">getInstance</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        <span class="title">bar</span>.<span class="title">query</span><span class="params">(&quot;SELECT ...&quot;)</span></span></span><br><span class="line"><span class="function">        <span class="comment">// 变量 `bar` 和 `foo` 中将包含同一个对象。</span></span></span><br></pre></td></tr></table></figure>

<h2 id="单例模式适合应用场景"><a href="#单例模式适合应用场景" class="headerlink" title="单例模式适合应用场景"></a>单例模式适合应用场景</h2><p><strong>如果程序中的某个类对于所有客户端只有一个可用的实例，可以使用单例模式。</strong></p>
<p>单例模式禁止通过除特殊构建方法以外的任何方式来创建自身类的对象。 该方法可以创建一个新对象， 但如果该对象已经被创建， 则返回已有的对象。</p>
<p><strong>如果你需要更加严格地控制全局变量，可以使用单例模式。</strong></p>
<p>单例模式与全局变量不同， 它保证类只存在一个实例。 除了单例类自己以外， 无法通过任何方式替换缓存的实例。</p>
<p>请注意， 你可以随时调整限制并设定生成单例实例的数量， 只需修改 <code>获取实例</code>方法， 即 getInstance 中的代码即可实现。</p>
<h2 id="实现方式"><a href="#实现方式" class="headerlink" title="实现方式"></a>实现方式</h2><ol>
<li>在类中添加一个私有静态成员变量用于保存单例实例。</li>
<li>声明一个公有静态构建方法用于获取单例实例。</li>
<li>在静态方法中实现&quot;延迟初始化&quot;。 该方法会在首次被调用时创建一个新对象， 并将其存储在静态成员变量中。 此后该方法每次被调用时都返回该实例。</li>
<li>将类的构造函数设为私有。 类的静态方法仍能调用构造函数， 但是其他对象不能调用。</li>
<li>检查客户端代码， 将对单例的构造函数的调用替换为对其静态构建方法的调用。</li>
</ol>
<h2 id="单例模式优缺点"><a href="#单例模式优缺点" class="headerlink" title="单例模式优缺点"></a>单例模式优缺点</h2><p>优点</p>
<ul>
<li>你可以保证一个类只有一个实例。</li>
<li>你获得了一个指向该实例的全局访问节点。</li>
<li>仅在首次请求单例对象时对其进行初始化。</li>
</ul>
<p>缺点</p>
<ul>
<li>违反了_单一职责原则_。 该模式同时解决了两个问题。</li>
<li>单例模式可能掩盖不良设计， 比如程序各组件之间相互了解过多等。</li>
<li>该模式在多线程环境下需要进行特殊处理， 避免多个线程多次创建单例对象。</li>
<li>单例的客户端代码单元测试可能会比较困难， 因为许多测试框架以基于继承的方式创建模拟对象。 由于单例类的构造函数是私有的， 而且绝大部分语言无法重写静态方法， 所以你需要想出仔细考虑模拟单例的方法。 要么干脆不编写测试代码， 或者不使用单例模式。</li>
</ul>
<h2 id="与其他模式的关系"><a href="#与其他模式的关系" class="headerlink" title="与其他模式的关系"></a>与其他模式的关系</h2><ul>
<li><a target="_blank" rel="noopener" href="https://refactoringguru.cn/design-patterns/facade">外观模式</a>类通常可以转换为<a target="_blank" rel="noopener" href="https://refactoringguru.cn/design-patterns/singleton">单例模式</a>类， 因为在大部分情况下一个外观对象就足够了。</li>
<li>如果你能将对象的所有共享状态简化为一个享元对象， 那么<a target="_blank" rel="noopener" href="https://refactoringguru.cn/design-patterns/flyweight">享元模式</a>就和<a target="_blank" rel="noopener" href="https://refactoringguru.cn/design-patterns/singleton">单例</a>类似了。 但这两个模式有两个根本性的不同。<ol>
<li>只会有一个单例实体， 但是<em>享元</em>类可以有多个实体， 各实体的内在状态也可以不同。</li>
<li><em>单例</em>对象可以是可变的。 享元对象是不可变的。</li>
</ol>
</li>
<li><a target="_blank" rel="noopener" href="https://refactoringguru.cn/design-patterns/abstract-factory">抽象工厂模式</a>、 <a target="_blank" rel="noopener" href="https://refactoringguru.cn/design-patterns/builder">生成器模式</a>和<a target="_blank" rel="noopener" href="https://refactoringguru.cn/design-patterns/prototype">原型模式</a>都可以用<a target="_blank" rel="noopener" href="https://refactoringguru.cn/design-patterns/singleton">单例</a>来实现。</li>
</ul>
<h2 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h2><p><strong>单例</strong>是一种创建型设计模式， 让你能够保证一个类只有一个实例， 并提供一个访问该实例的全局节点。</p>
<p>单例拥有与全局变量相同的优缺点。 尽管它们非常有用， 但却会破坏代码的模块化特性。</p>
<p>在某些其他上下文中， 你不能使用依赖于单例的类。 你也将必须使用单例类。 绝大多数情况下， 该限制会在创建单元测试时出现。</p>
<div class="tabs"><div class="nav-tabs"><button type="button" class="tab active">C#</button><button type="button" class="tab">C++</button><button type="button" class="tab">JAVA</button><button type="button" class="tab">PHP</button><button type="button" class="tab">Python</button><button type="button" class="tab">Ruby</button><button type="button" class="tab">Swift</button><button type="button" class="tab">TypeScrit</button><button type="button" class="tab">Golang</button></div><div class="tab-contents"><div class="tab-item-content active"><p><strong>在 C# 中使用模式</strong></p>
<p><strong>复杂度：</strong> ★☆☆</p>
<p><strong>流行度：</strong> ★★☆</p>
<p><strong>使用示例：</strong> 许多开发者将单例模式视为一种反模式。 因此它在 C# 代码中的使用频率正在逐步减少。</p>
<p><strong>识别方法：</strong> 单例可以通过返回相同缓存对象的静态构建方法来识别。</p>
<div class="tabs"><div class="nav-tabs"><button type="button" class="tab active">基础单例</button><button type="button" class="tab">线程安全单例</button><button type="button" class="tab">希望了解更多？</button></div><div class="tab-contents"><div class="tab-item-content active"><p><strong>基础单例</strong></p>
<p>实现一个粗糙的单例非常简单。 你仅需隐藏构造函数并实现一个静态的构建方法即可。</p>
<p>相同的类在多线程环境中会出错。 多线程可能会同时调用构建方法并获取多个单例类的实例。</p>
<p><strong>Program.cs:</strong> 概念示例</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Singleton</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// The Singleton class defines the `GetInstance` method that serves as an</span></span><br><span class="line">    <span class="comment">// alternative to constructor and lets clients access the same instance of</span></span><br><span class="line">    <span class="comment">// this class over and over.</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title">Singleton</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// The Singleton&#x27;s constructor should always be private to prevent</span></span><br><span class="line">        <span class="comment">// direct construction calls with the `new` operator.</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span>()</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// The Singleton&#x27;s instance is stored in a static field. There there are</span></span><br><span class="line">        <span class="comment">// multiple ways to initialize this field, all of them have various pros</span></span><br><span class="line">        <span class="comment">// and cons. In this example we&#x27;ll show the simplest of these ways,</span></span><br><span class="line">        <span class="comment">// which, however, doesn&#x27;t work really well in multithreaded program.</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> Singleton _instance;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// This is the static method that controls the access to the singleton</span></span><br><span class="line">        <span class="comment">// instance. On the first run, it creates a singleton object and places</span></span><br><span class="line">        <span class="comment">// it into the static field. On subsequent runs, it returns the client</span></span><br><span class="line">        <span class="comment">// existing object stored in the static field.</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title">GetInstance</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (_instance == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                _instance = <span class="keyword">new</span> Singleton();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> _instance;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Finally, any singleton should define some business logic, which can</span></span><br><span class="line">        <span class="comment">// be executed on its instance.</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">someBusinessLogic</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// The client code.</span></span><br><span class="line">            Singleton s1 = Singleton.GetInstance();</span><br><span class="line">            Singleton s2 = Singleton.GetInstance();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (s1 == s2)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;Singleton works, both variables contain the same instance.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;Singleton failed, variables contain different instances.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Output.txt:</strong> 执行结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Singleton works, both variables contain the same instance.</span><br></pre></td></tr></table></figure></div><div class="tab-item-content"><p><strong>线程安全单例</strong></p>
<p>为了解决这个问题， 你必须在创建首个单例对象时对线程进行同步。</p>
<p><strong>Program.cs:</strong> 概念示例</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Threading;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Singleton</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// This Singleton implementation is called &quot;double check lock&quot;. It is safe</span></span><br><span class="line">    <span class="comment">// in multithreaded environment and provides lazy initialization for the</span></span><br><span class="line">    <span class="comment">// Singleton object.</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title">Singleton</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span>()</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> Singleton _instance;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We now have a lock object that will be used to synchronize threads</span></span><br><span class="line">        <span class="comment">// during first access to the Singleton.</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="built_in">object</span> _lock = <span class="keyword">new</span> <span class="built_in">object</span>();</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title">GetInstance</span>(<span class="params"><span class="built_in">string</span> <span class="keyword">value</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// This conditional is needed to prevent threads stumbling over the</span></span><br><span class="line">            <span class="comment">// lock once the instance is ready.</span></span><br><span class="line">            <span class="keyword">if</span> (_instance == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// Now, imagine that the program has just been launched. Since</span></span><br><span class="line">                <span class="comment">// there&#x27;s no Singleton instance yet, multiple threads can</span></span><br><span class="line">                <span class="comment">// simultaneously pass the previous conditional and reach this</span></span><br><span class="line">                <span class="comment">// point almost at the same time. The first of them will acquire</span></span><br><span class="line">                <span class="comment">// lock and will proceed further, while the rest will wait here.</span></span><br><span class="line">                <span class="keyword">lock</span> (_lock)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// The first thread to acquire the lock, reaches this</span></span><br><span class="line">                    <span class="comment">// conditional, goes inside and creates the Singleton</span></span><br><span class="line">                    <span class="comment">// instance. Once it leaves the lock block, a thread that</span></span><br><span class="line">                    <span class="comment">// might have been waiting for the lock release may then</span></span><br><span class="line">                    <span class="comment">// enter this section. But since the Singleton field is</span></span><br><span class="line">                    <span class="comment">// already initialized, the thread won&#x27;t create a new</span></span><br><span class="line">                    <span class="comment">// object.</span></span><br><span class="line">                    <span class="keyword">if</span> (_instance == <span class="literal">null</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        _instance = <span class="keyword">new</span> Singleton();</span><br><span class="line">                        _instance.Value = <span class="keyword">value</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> _instance;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We&#x27;ll use this property to prove that our Singleton really works.</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Value &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// The client code.</span></span><br><span class="line">            </span><br><span class="line">            Console.WriteLine(</span><br><span class="line">                <span class="string">&quot;&#123;0&#125;\n&#123;1&#125;\n\n&#123;2&#125;\n&quot;</span>,</span><br><span class="line">                <span class="string">&quot;If you see the same value, then singleton was reused (yay!)&quot;</span>,</span><br><span class="line">                <span class="string">&quot;If you see different values, then 2 singletons were created (booo!!)&quot;</span>,</span><br><span class="line">                <span class="string">&quot;RESULT:&quot;</span></span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            Thread process1 = <span class="keyword">new</span> Thread(() =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                TestSingleton(<span class="string">&quot;FOO&quot;</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">            Thread process2 = <span class="keyword">new</span> Thread(() =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                TestSingleton(<span class="string">&quot;BAR&quot;</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">            process1.Start();</span><br><span class="line">            process2.Start();</span><br><span class="line">            </span><br><span class="line">            process1.Join();</span><br><span class="line">            process2.Join();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">TestSingleton</span>(<span class="params"><span class="built_in">string</span> <span class="keyword">value</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Singleton singleton = Singleton.GetInstance(<span class="keyword">value</span>);</span><br><span class="line">            Console.WriteLine(singleton.Value);</span><br><span class="line">        &#125; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Output.txt:</strong> 执行结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FOO</span><br><span class="line">FOO</span><br></pre></td></tr></table></figure></div><div class="tab-item-content"><p><strong>希望了解更多？</strong></p>
<p>C# 中还有更多特殊类型的单例模式。 阅读这篇文章以了解更多：</p>
<p> <a target="_blank" rel="noopener" href="https://refactoring.guru/csharp-singleton">深入理解 C#： 单例的实现</a></p></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><div class="tab-item-content"><p><strong>在 C++ 中使用模式</strong></p>
<p><strong>复杂度：</strong> ★☆☆</p>
<p><strong>流行度：</strong> ★★☆</p>
<p><strong>使用示例：</strong> 许多开发者将单例模式视为一种反模式。 因此它在 C++ 代码中的使用频率正在逐步减少。</p>
<p><strong>识别方法：</strong> 单例可以通过返回相同缓存对象的静态构建方法来识别。</p>
<div class="tabs"><div class="nav-tabs"><button type="button" class="tab active">基础单例</button><button type="button" class="tab">线程安全单例</button></div><div class="tab-contents"><div class="tab-item-content active"><p><strong>基础单例</strong></p>
<p>实现一个粗糙的单例非常简单。 你仅需隐藏构造函数并实现一个静态的构建方法即可。</p>
<p>相同的类在多线程环境中会出错。 多线程可能会同时调用构建方法并获取多个单例类的实例。</p>
<p><strong>main.cc:</strong> 概念示例</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The Singleton class defines the `GetInstance` method that serves as an</span></span><br><span class="line"><span class="comment"> * alternative to constructor and lets clients access the same instance of this</span></span><br><span class="line"><span class="comment"> * class over and over.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Singleton</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The Singleton&#x27;s constructor should always be private to prevent direct</span></span><br><span class="line"><span class="comment">     * construction calls with the `new` operator.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="built_in">Singleton</span>(<span class="type">const</span> std::string value): <span class="built_in">value_</span>(value)</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">static</span> Singleton* singleton_;</span><br><span class="line"></span><br><span class="line">    std::string value_;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Singletons should not be cloneable.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="built_in">Singleton</span>(Singleton &amp;other) = <span class="keyword">delete</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Singletons should not be assignable.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">void</span> <span class="keyword">operator</span>=(<span class="type">const</span> Singleton &amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * This is the static method that controls the access to the singleton</span></span><br><span class="line"><span class="comment">     * instance. On the first run, it creates a singleton object and places it</span></span><br><span class="line"><span class="comment">     * into the static field. On subsequent runs, it returns the client existing</span></span><br><span class="line"><span class="comment">     * object stored in the static field.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">static</span> Singleton *<span class="title">GetInstance</span><span class="params">(<span class="type">const</span> std::string&amp; value)</span></span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Finally, any singleton should define some business logic, which can be</span></span><br><span class="line"><span class="comment">     * executed on its instance.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">SomeBusinessLogic</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">std::string <span class="title">value</span><span class="params">()</span> <span class="type">const</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> value_;</span><br><span class="line">    &#125; </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Singleton* Singleton::singleton_= <span class="literal">nullptr</span>;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Static methods should be defined outside the class.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">Singleton *<span class="title">Singleton::GetInstance</span><span class="params">(<span class="type">const</span> std::string&amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * This is a safer way to create an instance. instance = new Singleton is</span></span><br><span class="line"><span class="comment">     * dangeruous in case two instance threads wants to access at the same time</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span>(singleton_==<span class="literal">nullptr</span>)&#123;</span><br><span class="line">        singleton_ = <span class="keyword">new</span> <span class="built_in">Singleton</span>(value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> singleton_;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ThreadFoo</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">// Following code emulates slow initialization.</span></span><br><span class="line">    std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">milliseconds</span>(<span class="number">1000</span>));</span><br><span class="line">    Singleton* singleton = Singleton::<span class="built_in">GetInstance</span>(<span class="string">&quot;FOO&quot;</span>);</span><br><span class="line">    std::cout &lt;&lt; singleton-&gt;<span class="built_in">value</span>() &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ThreadBar</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">// Following code emulates slow initialization.</span></span><br><span class="line">    std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">milliseconds</span>(<span class="number">1000</span>));</span><br><span class="line">    Singleton* singleton = Singleton::<span class="built_in">GetInstance</span>(<span class="string">&quot;BAR&quot;</span>);</span><br><span class="line">    std::cout &lt;&lt; singleton-&gt;<span class="built_in">value</span>() &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::cout &lt;&lt;<span class="string">&quot;If you see the same value, then singleton was reused (yay!\n&quot;</span> &lt;&lt;</span><br><span class="line">                <span class="string">&quot;If you see different values, then 2 singletons were created (booo!!)\n\n&quot;</span> &lt;&lt;</span><br><span class="line">                <span class="string">&quot;RESULT:\n&quot;</span>;   </span><br><span class="line">    <span class="function">std::thread <span class="title">t1</span><span class="params">(ThreadFoo)</span></span>;</span><br><span class="line">    <span class="function">std::thread <span class="title">t2</span><span class="params">(ThreadBar)</span></span>;</span><br><span class="line">    t1.<span class="built_in">join</span>();</span><br><span class="line">    t2.<span class="built_in">join</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Output.txt:</strong> 执行结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">If you see the same value, then singleton was reused (yay!</span><br><span class="line">If you see different values, then 2 singletons were created (booo!!)</span><br><span class="line"></span><br><span class="line">RESULT:</span><br><span class="line">BAR</span><br><span class="line">FOO</span><br></pre></td></tr></table></figure></div><div class="tab-item-content"><p><strong>线程安全单例</strong></p>
<p>为了解决这个问题， 你必须在创建首个单例对象时对线程进行同步。</p>
<p><strong>main.cc:</strong> 概念示例</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The Singleton class defines the `GetInstance` method that serves as an</span></span><br><span class="line"><span class="comment"> * alternative to constructor and lets clients access the same instance of this</span></span><br><span class="line"><span class="comment"> * class over and over.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Singleton</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The Singleton&#x27;s constructor/destructor should always be private to</span></span><br><span class="line"><span class="comment">     * prevent direct construction/desctruction calls with the `new`/`delete`</span></span><br><span class="line"><span class="comment">     * operator.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">static</span> Singleton * pinstance_;</span><br><span class="line">    <span class="type">static</span> std::mutex mutex_;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="built_in">Singleton</span>(<span class="type">const</span> std::string value): <span class="built_in">value_</span>(value)</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    ~<span class="built_in">Singleton</span>() &#123;&#125;</span><br><span class="line">    std::string value_;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Singletons should not be cloneable.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="built_in">Singleton</span>(Singleton &amp;other) = <span class="keyword">delete</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Singletons should not be assignable.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">void</span> <span class="keyword">operator</span>=(<span class="type">const</span> Singleton &amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * This is the static method that controls the access to the singleton</span></span><br><span class="line"><span class="comment">     * instance. On the first run, it creates a singleton object and places it</span></span><br><span class="line"><span class="comment">     * into the static field. On subsequent runs, it returns the client existing</span></span><br><span class="line"><span class="comment">     * object stored in the static field.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">static</span> Singleton *<span class="title">GetInstance</span><span class="params">(<span class="type">const</span> std::string&amp; value)</span></span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Finally, any singleton should define some business logic, which can be</span></span><br><span class="line"><span class="comment">     * executed on its instance.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">SomeBusinessLogic</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function">std::string <span class="title">value</span><span class="params">()</span> <span class="type">const</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> value_;</span><br><span class="line">    &#125; </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Static methods should be defined outside the class.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">Singleton* Singleton::pinstance_&#123;<span class="literal">nullptr</span>&#125;;</span><br><span class="line">std::mutex Singleton::mutex_;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The first time we call GetInstance we will lock the storage location</span></span><br><span class="line"><span class="comment"> *      and then we make sure again that the variable is null and then we</span></span><br><span class="line"><span class="comment"> *      set the value. RU:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">Singleton *<span class="title">Singleton::GetInstance</span><span class="params">(<span class="type">const</span> std::string&amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mutex_)</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (pinstance_ == <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        pinstance_ = <span class="keyword">new</span> <span class="built_in">Singleton</span>(value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> pinstance_;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ThreadFoo</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">// Following code emulates slow initialization.</span></span><br><span class="line">    std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">milliseconds</span>(<span class="number">1000</span>));</span><br><span class="line">    Singleton* singleton = Singleton::<span class="built_in">GetInstance</span>(<span class="string">&quot;FOO&quot;</span>);</span><br><span class="line">    std::cout &lt;&lt; singleton-&gt;<span class="built_in">value</span>() &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ThreadBar</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">// Following code emulates slow initialization.</span></span><br><span class="line">    std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">milliseconds</span>(<span class="number">1000</span>));</span><br><span class="line">    Singleton* singleton = Singleton::<span class="built_in">GetInstance</span>(<span class="string">&quot;BAR&quot;</span>);</span><br><span class="line">    std::cout &lt;&lt; singleton-&gt;<span class="built_in">value</span>() &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    std::cout &lt;&lt;<span class="string">&quot;If you see the same value, then singleton was reused (yay!\n&quot;</span> &lt;&lt;</span><br><span class="line">                <span class="string">&quot;If you see different values, then 2 singletons were created (booo!!)\n\n&quot;</span> &lt;&lt;</span><br><span class="line">                <span class="string">&quot;RESULT:\n&quot;</span>;   </span><br><span class="line">    <span class="function">std::thread <span class="title">t1</span><span class="params">(ThreadFoo)</span></span>;</span><br><span class="line">    <span class="function">std::thread <span class="title">t2</span><span class="params">(ThreadBar)</span></span>;</span><br><span class="line">    t1.<span class="built_in">join</span>();</span><br><span class="line">    t2.<span class="built_in">join</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Output.txt:</strong> 执行结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">If you see the same value, then singleton was reused (yay!</span><br><span class="line">If you see different values, then 2 singletons were created (booo!!)</span><br><span class="line"></span><br><span class="line">RESULT:</span><br><span class="line">FOO</span><br><span class="line">FOO</span><br></pre></td></tr></table></figure></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><div class="tab-item-content"><p><strong>在 Java 中使用模式</strong></p>
<p><strong>复杂度：</strong> ★☆☆</p>
<p><strong>流行度：</strong> ★★☆</p>
<p><strong>使用示例：</strong> 许多开发者将单例模式视为一种反模式。 因此它在 Java 代码中的使用频率正在逐步减少。</p>
<p>尽管如此， Java 核心程序库中仍有相当多的单例示例：</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://docs.oracle.com/javase/8/docs/api/java/lang/Runtime.html#getRuntime--"><code>java.lang.Runtime#getRuntime()</code></a></li>
<li><a target="_blank" rel="noopener" href="http://docs.oracle.com/javase/8/docs/api/java/awt/Desktop.html#getDesktop--"><code>java.awt.Desktop#getDesktop()</code></a></li>
<li><a target="_blank" rel="noopener" href="http://docs.oracle.com/javase/8/docs/api/java/lang/System.html#getSecurityManager--"><code>java.lang.System#getSecurityManager()</code></a></li>
</ul>
<p><strong>识别方法：</strong> 单例可以通过返回相同缓存对象的静态构建方法来识别。</p>
<div class="tabs"><div class="nav-tabs"><button type="button" class="tab active">基础单例（单线程）</button><button type="button" class="tab">基础单例（多线程）</button><button type="button" class="tab">采用延迟加载的线程安全单例</button><button type="button" class="tab">希望了解更多？</button></div><div class="tab-contents"><div class="tab-item-content active"><p><strong>基础单例（单线程）</strong></p>
<p>实现一个粗糙的单例非常简单。 你仅需隐藏构造函数并实现一个静态的构建方法即可。</p>
<p><strong>Singleton.java:</strong> 单例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> refactoring_guru.singleton.example.non_thread_safe;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Singleton</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Singleton instance;</span><br><span class="line">    <span class="keyword">public</span> String value;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Singleton</span><span class="params">(String value)</span> &#123;</span><br><span class="line">        <span class="comment">// The following code emulates slow initialization.</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException ex) &#123;</span><br><span class="line">            ex.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title function_">getInstance</span><span class="params">(String value)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;</span><br><span class="line">            instance = <span class="keyword">new</span> <span class="title class_">Singleton</span>(value);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>DemoSingleThread.java:</strong> 客户端代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> refactoring_guru.singleton.example.non_thread_safe;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DemoSingleThread</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;If you see the same value, then singleton was reused (yay!)&quot;</span> + <span class="string">&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;If you see different values, then 2 singletons were created (booo!!)&quot;</span> + <span class="string">&quot;\n\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;RESULT:&quot;</span> + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        <span class="type">Singleton</span> <span class="variable">singleton</span> <span class="operator">=</span> Singleton.getInstance(<span class="string">&quot;FOO&quot;</span>);</span><br><span class="line">        <span class="type">Singleton</span> <span class="variable">anotherSingleton</span> <span class="operator">=</span> Singleton.getInstance(<span class="string">&quot;BAR&quot;</span>);</span><br><span class="line">        System.out.println(singleton.value);</span><br><span class="line">        System.out.println(anotherSingleton.value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>OutputDemoSingleThread.txt:</strong> 执行结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">If you see the same value, then singleton was reused (yay!)</span><br><span class="line">If you see different values, then 2 singletons were created (booo!!)</span><br><span class="line"></span><br><span class="line">RESULT:</span><br><span class="line"></span><br><span class="line">FOO</span><br><span class="line">FOO</span><br></pre></td></tr></table></figure></div><div class="tab-item-content"><p><strong>基础单例（多线程）</strong></p>
<p>相同的类在多线程环境中会出错。 多线程可能会同时调用构建方法并获取多个单例类的实例。</p>
<p><strong>Singleton.java:</strong> 单例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> refactoring_guru.singleton.example.non_thread_safe;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Singleton</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Singleton instance;</span><br><span class="line">    <span class="keyword">public</span> String value;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Singleton</span><span class="params">(String value)</span> &#123;</span><br><span class="line">        <span class="comment">// The following code emulates slow initialization.</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException ex) &#123;</span><br><span class="line">            ex.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title function_">getInstance</span><span class="params">(String value)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;</span><br><span class="line">            instance = <span class="keyword">new</span> <span class="title class_">Singleton</span>(value);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>DemoMultiThread.java:</strong> 客户端代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> refactoring_guru.singleton.example.non_thread_safe;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DemoMultiThread</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;If you see the same value, then singleton was reused (yay!)&quot;</span> + <span class="string">&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;If you see different values, then 2 singletons were created (booo!!)&quot;</span> + <span class="string">&quot;\n\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;RESULT:&quot;</span> + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">threadFoo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">ThreadFoo</span>());</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">threadBar</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">ThreadBar</span>());</span><br><span class="line">        threadFoo.start();</span><br><span class="line">        threadBar.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ThreadFoo</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">Singleton</span> <span class="variable">singleton</span> <span class="operator">=</span> Singleton.getInstance(<span class="string">&quot;FOO&quot;</span>);</span><br><span class="line">            System.out.println(singleton.value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ThreadBar</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">Singleton</span> <span class="variable">singleton</span> <span class="operator">=</span> Singleton.getInstance(<span class="string">&quot;BAR&quot;</span>);</span><br><span class="line">            System.out.println(singleton.value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>OutputDemoMultiThread.txt:</strong> 执行结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">If you see the same value, then singleton was reused (yay!)</span><br><span class="line">If you see different values, then 2 singletons were created (booo!!)</span><br><span class="line"></span><br><span class="line">RESULT:</span><br><span class="line"></span><br><span class="line">FOO</span><br><span class="line">BAR</span><br></pre></td></tr></table></figure></div><div class="tab-item-content"><p><strong>采用延迟加载的线程安全单例</strong></p>
<p>为了解决这个问题， 你必须在创建首个单例对象时对线程进行同步。</p>
<p><strong>Singleton.java:</strong> 单例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> refactoring_guru.singleton.example.thread_safe;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Singleton</span> &#123;</span><br><span class="line">    <span class="comment">// The field must be declared volatile so that double check lock would work</span></span><br><span class="line">    <span class="comment">// correctly.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> Singleton instance;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String value;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Singleton</span><span class="params">(String value)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title function_">getInstance</span><span class="params">(String value)</span> &#123;</span><br><span class="line">        <span class="comment">// The approach taken here is called double-checked locking (DCL). It</span></span><br><span class="line">        <span class="comment">// exists to prevent race condition between multiple threads that may</span></span><br><span class="line">        <span class="comment">// attempt to get singleton instance at the same time, creating separate</span></span><br><span class="line">        <span class="comment">// instances as a result.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// It may seem that having the `result` variable here is completely</span></span><br><span class="line">        <span class="comment">// pointless. There is, however, a very important caveat when</span></span><br><span class="line">        <span class="comment">// implementing double-checked locking in Java, which is solved by</span></span><br><span class="line">        <span class="comment">// introducing this local variable.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// You can read more info DCL issues in Java here:</span></span><br><span class="line">        <span class="comment">// https://refactoring.guru/java-dcl-issue</span></span><br><span class="line">        <span class="type">Singleton</span> <span class="variable">result</span> <span class="operator">=</span> instance;</span><br><span class="line">        <span class="keyword">if</span> (result != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">synchronized</span>(Singleton.class) &#123;</span><br><span class="line">            <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;</span><br><span class="line">                instance = <span class="keyword">new</span> <span class="title class_">Singleton</span>(value);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> instance;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>DemoMultiThread.java:</strong> 客户端代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> refactoring_guru.singleton.example.thread_safe;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DemoMultiThread</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;If you see the same value, then singleton was reused (yay!)&quot;</span> + <span class="string">&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;If you see different values, then 2 singletons were created (booo!!)&quot;</span> + <span class="string">&quot;\n\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;RESULT:&quot;</span> + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">threadFoo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">ThreadFoo</span>());</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">threadBar</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">ThreadBar</span>());</span><br><span class="line">        threadFoo.start();</span><br><span class="line">        threadBar.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ThreadFoo</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">Singleton</span> <span class="variable">singleton</span> <span class="operator">=</span> Singleton.getInstance(<span class="string">&quot;FOO&quot;</span>);</span><br><span class="line">            System.out.println(singleton.value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ThreadBar</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">Singleton</span> <span class="variable">singleton</span> <span class="operator">=</span> Singleton.getInstance(<span class="string">&quot;BAR&quot;</span>);</span><br><span class="line">            System.out.println(singleton.value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>OutputDemoMultiThread.txt:</strong> 执行结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">If you see the same value, then singleton was reused (yay!)</span><br><span class="line">If you see different values, then 2 singletons were created (booo!!)</span><br><span class="line"></span><br><span class="line">RESULT:</span><br><span class="line"></span><br><span class="line">BAR</span><br><span class="line">BAR</span><br></pre></td></tr></table></figure></div><div class="tab-item-content"><p><strong>希望了解更多？</strong></p>
<p>Java 中还有更多特殊类型的单例模式。 阅读这篇文章以了解更多：</p>
<p><a target="_blank" rel="noopener" href="https://refactoring.guru/java-singleton">Java 单例设计模式的最佳实践与示例</a></p></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><div class="tab-item-content"><p><strong>在 PHP 中使用模式</strong></p>
<p><strong>复杂度：</strong> ★☆☆</p>
<p><strong>流行度：</strong> ★★☆</p>
<p><strong>使用示例：</strong> 许多开发者将单例模式视为一种反模式。 因此它在 PHP 代码中的使用频率正在逐步减少。</p>
<p><strong>识别方法：</strong> 单例可以通过返回相同缓存对象的静态构建方法来识别。</p>
<div class="tabs"><div class="nav-tabs"><button type="button" class="tab active">概念示例</button><button type="button" class="tab">真实世界示例</button></div><div class="tab-contents"><div class="tab-item-content active"><p><strong>概念示例</strong></p>
<p>本例说明了<strong>单例</strong>设计模式的结构并重点回答了下面的问题：</p>
<ul>
<li>它由哪些类组成？</li>
<li>这些类扮演了哪些角色？</li>
<li>模式中的各个元素会以何种方式相互关联？</li>
</ul>
<p>了解该模式的结构后， 你可以更容易地理解下面基于真实世界的 PHP 应用案例。</p>
<p><strong>index.php:</strong> 概念示例</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">RefactoringGuru</span>\<span class="title class_">Singleton</span>\<span class="title class_">Conceptual</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The Singleton class defines the `GetInstance` method that serves as an</span></span><br><span class="line"><span class="comment"> * alternative to constructor and lets clients access the same instance of this</span></span><br><span class="line"><span class="comment"> * class over and over.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Singleton</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The Singleton&#x27;s instance is stored in a static field. This field is an</span></span><br><span class="line"><span class="comment">     * array, because we&#x27;ll allow our Singleton to have subclasses. Each item in</span></span><br><span class="line"><span class="comment">     * this array will be an instance of a specific Singleton&#x27;s subclass. You&#x27;ll</span></span><br><span class="line"><span class="comment">     * see how this works in a moment.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">static</span> <span class="variable">$instances</span> = [];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The Singleton&#x27;s constructor should always be private to prevent direct</span></span><br><span class="line"><span class="comment">     * construction calls with the `new` operator.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Singletons should not be cloneable.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">__clone</span>(<span class="params"></span>) </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Singletons should not be restorable from strings.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">\Exception</span>(<span class="string">&quot;Cannot unserialize a singleton.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * This is the static method that controls the access to the singleton</span></span><br><span class="line"><span class="comment">     * instance. On the first run, it creates a singleton object and places it</span></span><br><span class="line"><span class="comment">     * into the static field. On subsequent runs, it returns the client existing</span></span><br><span class="line"><span class="comment">     * object stored in the static field.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * This implementation lets you subclass the Singleton class while keeping</span></span><br><span class="line"><span class="comment">     * just one instance of each subclass around.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getInstance</span>(<span class="params"></span>): <span class="title">Singleton</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$cls</span> = <span class="built_in">static</span>::<span class="variable language_">class</span>;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="built_in">self</span>::<span class="variable">$instances</span>[<span class="variable">$cls</span>])) &#123;</span><br><span class="line">            <span class="built_in">self</span>::<span class="variable">$instances</span>[<span class="variable">$cls</span>] = <span class="keyword">new</span> <span class="built_in">static</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">self</span>::<span class="variable">$instances</span>[<span class="variable">$cls</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Finally, any singleton should define some business logic, which can be</span></span><br><span class="line"><span class="comment">     * executed on its instance.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">someBusinessLogic</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The client code.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">clientCode</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$s1</span> = <span class="title class_">Singleton</span>::<span class="title function_ invoke__">getInstance</span>();</span><br><span class="line">    <span class="variable">$s2</span> = <span class="title class_">Singleton</span>::<span class="title function_ invoke__">getInstance</span>();</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$s1</span> === <span class="variable">$s2</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Singleton works, both variables contain the same instance.&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Singleton failed, variables contain different instances.&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">clientCode</span>();</span><br></pre></td></tr></table></figure>

<p><strong>Output.txt:</strong> 执行结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Singleton works, both variables contain the same instance.</span><br></pre></td></tr></table></figure></div><div class="tab-item-content"><p><strong>真实世界示例</strong></p>
<p><strong>单例</strong>模式由于限制了代码复用， 且让单元测试复杂化而名声不佳。 但它在有些情况下仍然非常实用， 特别是在需要控制一些共享资源时十分方便。 例如， 全局日志对象必须对日志文件的访问权限进行控制。 另一个例子： 共享的运行时配置存储。</p>
<p><strong>index.php:</strong> 真实世界示例</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">RefactoringGuru</span>\<span class="title class_">Singleton</span>\<span class="title class_">RealWorld</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * If you need to support several types of Singletons in your app, you can</span></span><br><span class="line"><span class="comment"> * define the basic features of the Singleton in a base class, while moving the</span></span><br><span class="line"><span class="comment"> * actual business logic (like logging) to subclasses.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Singleton</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The actual singleton&#x27;s instance almost always resides inside a static</span></span><br><span class="line"><span class="comment">     * field. In this case, the static field is an array, where each subclass of</span></span><br><span class="line"><span class="comment">     * the Singleton stores its own instance.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">static</span> <span class="variable">$instances</span> = [];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Singleton&#x27;s constructor should not be public. However, it can&#x27;t be</span></span><br><span class="line"><span class="comment">     * private either if we want to allow subclassing.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Cloning and unserialization are not permitted for singletons.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">__clone</span>(<span class="params"></span>) </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">\Exception</span>(<span class="string">&quot;Cannot unserialize singleton&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The method you use to get the Singleton&#x27;s instance.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getInstance</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$subclass</span> = <span class="built_in">static</span>::<span class="variable language_">class</span>;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="built_in">self</span>::<span class="variable">$instances</span>[<span class="variable">$subclass</span>])) &#123;</span><br><span class="line">            <span class="comment">// Note that here we use the &quot;static&quot; keyword instead of the actual</span></span><br><span class="line">            <span class="comment">// class name. In this context, the &quot;static&quot; keyword means &quot;the name</span></span><br><span class="line">            <span class="comment">// of the current class&quot;. That detail is important because when the</span></span><br><span class="line">            <span class="comment">// method is called on the subclass, we want an instance of that</span></span><br><span class="line">            <span class="comment">// subclass to be created here.</span></span><br><span class="line"></span><br><span class="line">            <span class="built_in">self</span>::<span class="variable">$instances</span>[<span class="variable">$subclass</span>] = <span class="keyword">new</span> <span class="built_in">static</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">self</span>::<span class="variable">$instances</span>[<span class="variable">$subclass</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The logging class is the most known and praised use of the Singleton pattern.</span></span><br><span class="line"><span class="comment"> * In most cases, you need a single logging object that writes to a single log</span></span><br><span class="line"><span class="comment"> * file (control over shared resource). You also need a convenient way to access</span></span><br><span class="line"><span class="comment"> * that instance from any context of your app (global access point).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Logger</span> <span class="keyword">extends</span> <span class="title">Singleton</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * A file pointer resource of the log file.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$fileHandle</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Since the Singleton&#x27;s constructor is called only once, just a single file</span></span><br><span class="line"><span class="comment">     * resource is opened at all times.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Note, for the sake of simplicity, we open the console stream instead of</span></span><br><span class="line"><span class="comment">     * the actual file here.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;fileHandle = <span class="title function_ invoke__">fopen</span>(<span class="string">&#x27;php://stdout&#x27;</span>, <span class="string">&#x27;w&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Write a log entry to the opened file resource.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">writeLog</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$message</span></span>): <span class="title">void</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$date</span> = <span class="title function_ invoke__">date</span>(<span class="string">&#x27;Y-m-d&#x27;</span>);</span><br><span class="line">        <span class="title function_ invoke__">fwrite</span>(<span class="variable">$this</span>-&gt;fileHandle, <span class="string">&quot;<span class="subst">$date</span>: <span class="subst">$message</span>\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Just a handy shortcut to reduce the amount of code needed to log messages</span></span><br><span class="line"><span class="comment">     * from the client code.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">log</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$message</span></span>): <span class="title">void</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$logger</span> = <span class="built_in">static</span>::<span class="title function_ invoke__">getInstance</span>();</span><br><span class="line">        <span class="variable">$logger</span>-&gt;<span class="title function_ invoke__">writeLog</span>(<span class="variable">$message</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Applying the Singleton pattern to the configuration storage is also a common</span></span><br><span class="line"><span class="comment"> * practice. Often you need to access application configurations from a lot of</span></span><br><span class="line"><span class="comment"> * different places of the program. Singleton gives you that comfort.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Config</span> <span class="keyword">extends</span> <span class="title">Singleton</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$hashmap</span> = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getValue</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$key</span></span>): <span class="title">string</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;hashmap[<span class="variable">$key</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setValue</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$key</span>, <span class="keyword">string</span> <span class="variable">$value</span></span>): <span class="title">void</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;hashmap[<span class="variable">$key</span>] = <span class="variable">$value</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The client code.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title class_">Logger</span>::<span class="title function_ invoke__">log</span>(<span class="string">&quot;Started!&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Compare values of Logger singleton.</span></span><br><span class="line"><span class="variable">$l1</span> = <span class="title class_">Logger</span>::<span class="title function_ invoke__">getInstance</span>();</span><br><span class="line"><span class="variable">$l2</span> = <span class="title class_">Logger</span>::<span class="title function_ invoke__">getInstance</span>();</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$l1</span> === <span class="variable">$l2</span>) &#123;</span><br><span class="line">    <span class="title class_">Logger</span>::<span class="title function_ invoke__">log</span>(<span class="string">&quot;Logger has a single instance.&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title class_">Logger</span>::<span class="title function_ invoke__">log</span>(<span class="string">&quot;Loggers are different.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Check how Config singleton saves data...</span></span><br><span class="line"><span class="variable">$config1</span> = <span class="title class_">Config</span>::<span class="title function_ invoke__">getInstance</span>();</span><br><span class="line"><span class="variable">$login</span> = <span class="string">&quot;test_login&quot;</span>;</span><br><span class="line"><span class="variable">$password</span> = <span class="string">&quot;test_password&quot;</span>;</span><br><span class="line"><span class="variable">$config1</span>-&gt;<span class="title function_ invoke__">setValue</span>(<span class="string">&quot;login&quot;</span>, <span class="variable">$login</span>);</span><br><span class="line"><span class="variable">$config1</span>-&gt;<span class="title function_ invoke__">setValue</span>(<span class="string">&quot;password&quot;</span>, <span class="variable">$password</span>);</span><br><span class="line"><span class="comment">// ...and restores it.</span></span><br><span class="line"><span class="variable">$config2</span> = <span class="title class_">Config</span>::<span class="title function_ invoke__">getInstance</span>();</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$login</span> == <span class="variable">$config2</span>-&gt;<span class="title function_ invoke__">getValue</span>(<span class="string">&quot;login&quot;</span>) &amp;&amp;</span><br><span class="line">    <span class="variable">$password</span> == <span class="variable">$config2</span>-&gt;<span class="title function_ invoke__">getValue</span>(<span class="string">&quot;password&quot;</span>)</span><br><span class="line">) &#123;</span><br><span class="line">    <span class="title class_">Logger</span>::<span class="title function_ invoke__">log</span>(<span class="string">&quot;Config singleton also works fine.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Logger</span>::<span class="title function_ invoke__">log</span>(<span class="string">&quot;Finished!&quot;</span>);</span><br></pre></td></tr></table></figure>

<p><strong>Output.txt:</strong> 执行结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2018-06-04: Started!</span><br><span class="line">2018-06-04: Logger has a single instance.</span><br><span class="line">2018-06-04: Config singleton also works fine.</span><br><span class="line">2018-06-04: Finished!</span><br></pre></td></tr></table></figure></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><div class="tab-item-content"><p><strong>在 Python 中使用模式</strong></p>
<p><strong>复杂度：</strong> ★☆☆</p>
<p><strong>流行度：</strong> ★★☆</p>
<p><strong>使用示例：</strong> 许多开发者将单例模式视为一种反模式。 因此它在 Python 代码中的使用频率正在逐步减少。</p>
<p><strong>识别方法：</strong> 单例可以通过返回相同缓存对象的静态构建方法来识别。</p>
<div class="tabs"><div class="nav-tabs"><button type="button" class="tab active">基础单例</button><button type="button" class="tab">线程安全单例</button></div><div class="tab-contents"><div class="tab-item-content active"><p><strong>基础单例</strong></p>
<p>实现一个粗糙的单例非常简单。 你仅需隐藏构造函数并实现一个静态的构建方法即可。</p>
<p>相同的类在多线程环境中会出错。 多线程可能会同时调用构建方法并获取多个单例类的实例。</p>
<p><strong>main.py:</strong> 概念示例</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SingletonMeta</span>(<span class="title class_ inherited__">type</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    The Singleton class can be implemented in different ways in Python. Some</span></span><br><span class="line"><span class="string">    possible methods include: base class, decorator, metaclass. We will use the</span></span><br><span class="line"><span class="string">    metaclass because it is best suited for this purpose.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    _instances = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__call__</span>(<span class="params">cls, *args, **kwargs</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Possible changes to the value of the `__init__` argument do not affect</span></span><br><span class="line"><span class="string">        the returned instance.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> cls <span class="keyword">not</span> <span class="keyword">in</span> cls._instances:</span><br><span class="line">            instance = <span class="built_in">super</span>().__call__(*args, **kwargs)</span><br><span class="line">            cls._instances[cls] = instance</span><br><span class="line">        <span class="keyword">return</span> cls._instances[cls]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Singleton</span>(metaclass=SingletonMeta):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">some_business_logic</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Finally, any singleton should define some business logic, which can be</span></span><br><span class="line"><span class="string">        executed on its instance.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># ...</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># The client code.</span></span><br><span class="line"></span><br><span class="line">    s1 = Singleton()</span><br><span class="line">    s2 = Singleton()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">id</span>(s1) == <span class="built_in">id</span>(s2):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Singleton works, both variables contain the same instance.&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Singleton failed, variables contain different instances.&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><strong>Output.txt:</strong> 执行结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Singleton works, both variables contain the same instance.</span><br></pre></td></tr></table></figure></div><div class="tab-item-content"><p><strong>线程安全单例</strong></p>
<p>为了解决这个问题， 你必须在创建首个单例对象时对线程进行同步。</p>
<p><strong>main.py:</strong> 概念示例</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Lock, Thread</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SingletonMeta</span>(<span class="title class_ inherited__">type</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    This is a thread-safe implementation of Singleton.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    _instances = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    _lock: Lock = Lock()</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    We now have a lock object that will be used to synchronize threads during</span></span><br><span class="line"><span class="string">    first access to the Singleton.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__call__</span>(<span class="params">cls, *args, **kwargs</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Possible changes to the value of the `__init__` argument do not affect</span></span><br><span class="line"><span class="string">        the returned instance.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># Now, imagine that the program has just been launched. Since there&#x27;s no</span></span><br><span class="line">        <span class="comment"># Singleton instance yet, multiple threads can simultaneously pass the</span></span><br><span class="line">        <span class="comment"># previous conditional and reach this point almost at the same time. The</span></span><br><span class="line">        <span class="comment"># first of them will acquire lock and will proceed further, while the</span></span><br><span class="line">        <span class="comment"># rest will wait here.</span></span><br><span class="line">        <span class="keyword">with</span> cls._lock:</span><br><span class="line">            <span class="comment"># The first thread to acquire the lock, reaches this conditional,</span></span><br><span class="line">            <span class="comment"># goes inside and creates the Singleton instance. Once it leaves the</span></span><br><span class="line">            <span class="comment"># lock block, a thread that might have been waiting for the lock</span></span><br><span class="line">            <span class="comment"># release may then enter this section. But since the Singleton field</span></span><br><span class="line">            <span class="comment"># is already initialized, the thread won&#x27;t create a new object.</span></span><br><span class="line">            <span class="keyword">if</span> cls <span class="keyword">not</span> <span class="keyword">in</span> cls._instances:</span><br><span class="line">                instance = <span class="built_in">super</span>().__call__(*args, **kwargs)</span><br><span class="line">                cls._instances[cls] = instance</span><br><span class="line">        <span class="keyword">return</span> cls._instances[cls]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Singleton</span>(metaclass=SingletonMeta):</span><br><span class="line">    value: <span class="built_in">str</span> = <span class="literal">None</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    We&#x27;ll use this property to prove that our Singleton really works.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, value: <span class="built_in">str</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        self.value = value</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">some_business_logic</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Finally, any singleton should define some business logic, which can be</span></span><br><span class="line"><span class="string">        executed on its instance.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_singleton</span>(<span class="params">value: <span class="built_in">str</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    singleton = Singleton(value)</span><br><span class="line">    <span class="built_in">print</span>(singleton.value)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># The client code.</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;If you see the same value, then singleton was reused (yay!)\n&quot;</span></span><br><span class="line">          <span class="string">&quot;If you see different values, &quot;</span></span><br><span class="line">          <span class="string">&quot;then 2 singletons were created (booo!!)\n\n&quot;</span></span><br><span class="line">          <span class="string">&quot;RESULT:\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">    process1 = Thread(target=test_singleton, args=(<span class="string">&quot;FOO&quot;</span>,))</span><br><span class="line">    process2 = Thread(target=test_singleton, args=(<span class="string">&quot;BAR&quot;</span>,))</span><br><span class="line">    process1.start()</span><br><span class="line">    process2.start()</span><br></pre></td></tr></table></figure>

<p><strong>Output.txt:</strong> 执行结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">If you see the same value, then singleton was reused (yay!)</span><br><span class="line">If you see different values, then 2 singletons were created (booo!!)</span><br><span class="line"></span><br><span class="line">RESULT:</span><br><span class="line"></span><br><span class="line">FOO</span><br><span class="line">FOO</span><br></pre></td></tr></table></figure></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><div class="tab-item-content"><p><strong>在 Ruby 中使用模式</strong></p>
<p><strong>复杂度：</strong> ★☆☆</p>
<p><strong>流行度：</strong> ★★☆</p>
<p><strong>使用示例：</strong> 许多开发者将单例模式视为一种反模式。 因此它在 Ruby 代码中的使用频率正在逐步减少。</p>
<p><strong>识别方法：</strong> 单例可以通过返回相同缓存对象的静态构建方法来识别。</p>
<div class="tabs"><div class="nav-tabs"><button type="button" class="tab active">基础单例</button><button type="button" class="tab">线程安全单例</button></div><div class="tab-contents"><div class="tab-item-content active"><p><strong>基础单例</strong></p>
<p>实现一个粗糙的单例非常简单。 你仅需隐藏构造函数并实现一个静态的构建方法即可。</p>
<p>相同的类在多线程环境中会出错。 多线程可能会同时调用构建方法并获取多个单例类的实例。</p>
<p><strong>main.rb:</strong> 概念示例</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The Singleton class defines the `instance` method that lets clients access the</span></span><br><span class="line"><span class="comment"># unique singleton instance.</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Singleton</span></span><br><span class="line">  <span class="variable">@instance</span> = new</span><br><span class="line"></span><br><span class="line">  private_class_method <span class="symbol">:new</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># The static method that controls the access to the singleton instance.</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># This implementation let you subclass the Singleton class while keeping just</span></span><br><span class="line">  <span class="comment"># one instance of each subclass around.</span></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">self</span>.instance</span><br><span class="line">    <span class="variable">@instance</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Finally, any singleton should define some business logic, which can be</span></span><br><span class="line">  <span class="comment"># executed on its instance.</span></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">some_business_logic</span></span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The client code.</span></span><br><span class="line"></span><br><span class="line">s1 = Singleton.instance</span><br><span class="line">s2 = Singleton.instance</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> s1.equal?(s2)</span><br><span class="line">  print <span class="string">&#x27;Singleton works, both variables contain the same instance.&#x27;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  print <span class="string">&#x27;Singleton failed, variables contain different instances.&#x27;</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p><strong>output.txt:</strong> 执行结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Singleton works, both variables contain the same instance.</span><br></pre></td></tr></table></figure></div><div class="tab-item-content"><p><strong>线程安全单例</strong></p>
<p>为了解决这个问题， 你必须在创建首个单例对象时对线程进行同步。</p>
<p><strong>main.rb:</strong> 概念示例</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The Singleton class defines the `intance` method that lets clients access the</span></span><br><span class="line"><span class="comment"># unique singleton instance.</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Singleton</span></span><br><span class="line">  <span class="keyword">attr_reader</span> <span class="symbol">:value</span></span><br><span class="line"></span><br><span class="line">  <span class="variable">@instance_mutex</span> = Mutex.new</span><br><span class="line"></span><br><span class="line">  private_class_method <span class="symbol">:new</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">initialize</span>(<span class="params">value</span>)</span><br><span class="line">    <span class="variable">@value</span> = value</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># The static method that controls the access to the singleton instance.</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># This implementation let you subclass the Singleton class while keeping just</span></span><br><span class="line">  <span class="comment"># one instance of each subclass around.</span></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">self</span>.instance(value)</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">@instance</span> <span class="keyword">if</span> <span class="variable">@instance</span></span><br><span class="line"></span><br><span class="line">    <span class="variable">@instance_mutex</span>.synchronize <span class="keyword">do</span></span><br><span class="line">      <span class="variable">@instance</span> |<span class="params"></span>|= new(value)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="variable">@instance</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Finally, any singleton should define some business logic, which can be</span></span><br><span class="line">  <span class="comment"># executed on its instance.</span></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">some_business_logic</span></span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># <span class="doctag">@param</span> [String] value</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_singleton</span>(<span class="params">value</span>)</span><br><span class="line">  singleton = Singleton.instance(value)</span><br><span class="line">  puts singleton.value</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The client code.</span></span><br><span class="line"></span><br><span class="line">puts <span class="string">&quot;If you see the same value, then singleton was reused (yay!)\n&quot;</span>\</span><br><span class="line">     <span class="string">&quot;If you see different values, then 2 singletons were created (booo!!)\n\n&quot;</span>\</span><br><span class="line">     <span class="string">&quot;RESULT:\n\n&quot;</span></span><br><span class="line"></span><br><span class="line">process1 = <span class="title class_">Thread</span>.new &#123; test_singleton(<span class="string">&#x27;FOO&#x27;</span>) &#125;</span><br><span class="line">process2 = <span class="title class_">Thread</span>.new &#123; test_singleton(<span class="string">&#x27;BAR&#x27;</span>) &#125;</span><br><span class="line">process1.join</span><br><span class="line">process2.join</span><br></pre></td></tr></table></figure>

<p><strong>output.txt:</strong> 执行结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">If you see the same value, then singleton was reused (yay!)</span><br><span class="line">If you see different values, then 2 singletons were created (booo!!)</span><br><span class="line"></span><br><span class="line">RESULT:</span><br><span class="line"></span><br><span class="line">FOO</span><br><span class="line">FOO</span><br></pre></td></tr></table></figure></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><div class="tab-item-content"><p><strong>在 Swift 中使用模式</strong></p>
<p><strong>复杂度：</strong> ★☆☆</p>
<p><strong>流行度：</strong> ★★☆</p>
<p><strong>使用示例：</strong> 许多开发者将单例模式视为一种反模式。 因此它在 Swift 代码中的使用频率正在逐步减少。</p>
<p><strong>识别方法：</strong> 单例可以通过返回相同缓存对象的静态构建方法来识别。</p>
<div class="tabs"><div class="nav-tabs"><button type="button" class="tab active">概念示例</button><button type="button" class="tab">真实世界示例</button></div><div class="tab-contents"><div class="tab-item-content active"><p><strong>概念示例</strong></p>
<p>本例说明了<strong>单例</strong>设计模式的结构并重点回答了下面的问题：</p>
<ul>
<li>它由哪些类组成？</li>
<li>这些类扮演了哪些角色？</li>
<li>模式中的各个元素会以何种方式相互关联？</li>
</ul>
<p>了解该模式的结构后， 你可以更容易地理解下面基于真实世界的 Swift 应用案例。</p>
<p><strong>Example.swift:</strong> 概念示例</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> XCTest</span><br><span class="line"></span><br><span class="line"><span class="comment">/// The Singleton class defines the `shared` field that lets clients access the</span></span><br><span class="line"><span class="comment">/// unique singleton instance.</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Singleton</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// The static field that controls the access to the singleton instance.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// This implementation let you extend the Singleton class while keeping</span></span><br><span class="line">    <span class="comment">/// just one instance of each subclass around.</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">var</span> shared: <span class="type">Singleton</span> <span class="operator">=</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> instance <span class="operator">=</span> <span class="type">Singleton</span>()</span><br><span class="line">        <span class="comment">// ... configure the instance</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">return</span> instance</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// The Singleton&#x27;s initializer should always be private to prevent direct</span></span><br><span class="line">    <span class="comment">/// construction calls with the `new` operator.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">init</span>() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Finally, any singleton should define some business logic, which can be</span></span><br><span class="line">    <span class="comment">/// executed on its instance.</span></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">someBusinessLogic</span>() -&gt; <span class="type">String</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Result of the &#x27;someBusinessLogic&#x27; call&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Singletons should not be cloneable.</span></span><br><span class="line"><span class="keyword">extension</span> <span class="title class_">Singleton</span>: <span class="title class_">NSCopying</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">copy</span>(<span class="params">with</span> <span class="params">zone</span>: <span class="type">NSZone</span>? <span class="operator">=</span> <span class="literal">nil</span>) -&gt; <span class="keyword">Any</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// The client code.</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Client</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">func</span> <span class="title function_">someClientCode</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> instance1 <span class="operator">=</span> <span class="type">Singleton</span>.shared</span><br><span class="line">        <span class="keyword">let</span> instance2 <span class="operator">=</span> <span class="type">Singleton</span>.shared</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (instance1 <span class="operator">===</span> instance2) &#123;</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Singleton works, both variables contain the same instance.&quot;</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Singleton failed, variables contain different instances.&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Let&#x27;s see how it all works together.</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SingletonConceptual</span>: <span class="title class_">XCTestCase</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">testSingletonConceptual</span>() &#123;</span><br><span class="line">        <span class="type">Client</span>.someClientCode()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Output.txt:</strong> 执行结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Singleton works, both variables contain the same instance.</span><br></pre></td></tr></table></figure></div><div class="tab-item-content"><p><strong>真实世界示例</strong></p>
<p><strong>Example.swift:</strong> 真实世界示例</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> XCTest</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Singleton Design Pattern</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// Intent: Ensure that class has a single instance, and provide a global point</span></span><br><span class="line"><span class="comment">/// of access to it.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SingletonRealWorld</span>: <span class="title class_">XCTestCase</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">testSingletonRealWorld</span>() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/// There are two view controllers.</span></span><br><span class="line">        <span class="comment">///</span></span><br><span class="line">        <span class="comment">/// MessagesListVC displays a list of last messages from a user&#x27;s chats.</span></span><br><span class="line">        <span class="comment">/// ChatVC displays a chat with a friend.</span></span><br><span class="line">        <span class="comment">///</span></span><br><span class="line">        <span class="comment">/// FriendsChatService fetches messages from a server and provides all</span></span><br><span class="line">        <span class="comment">/// subscribers (view controllers in our example) with new and removed</span></span><br><span class="line">        <span class="comment">/// messages.</span></span><br><span class="line">        <span class="comment">///</span></span><br><span class="line">        <span class="comment">/// FriendsChatService is used by both view controllers. It can be</span></span><br><span class="line">        <span class="comment">/// implemented as an instance of a class as well as a global variable.</span></span><br><span class="line">        <span class="comment">///</span></span><br><span class="line">        <span class="comment">/// In this example, it is important to have only one instance that</span></span><br><span class="line">        <span class="comment">/// performs resource-intensive work.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> listVC <span class="operator">=</span> <span class="type">MessagesListVC</span>()</span><br><span class="line">        <span class="keyword">let</span> chatVC <span class="operator">=</span> <span class="type">ChatVC</span>()</span><br><span class="line"></span><br><span class="line">        listVC.startReceiveMessages()</span><br><span class="line">        chatVC.startReceiveMessages()</span><br><span class="line"></span><br><span class="line">        <span class="comment">/// ... add view controllers to the navigation stack ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BaseVC</span>: <span class="title class_">UIViewController</span>, <span class="title class_">MessageSubscriber</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">accept</span>(<span class="params">new</span> <span class="params">messages</span>: [<span class="type">Message</span>]) &#123;</span><br><span class="line">        <span class="comment">/// handle new messages in the base class</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">accept</span>(<span class="params">removed</span> <span class="params">messages</span>: [<span class="type">Message</span>]) &#123;</span><br><span class="line">        <span class="comment">/// handle removed messages in the base class</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">startReceiveMessages</span>() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/// The singleton can be injected as a dependency. However, from an</span></span><br><span class="line">        <span class="comment">/// informational perspective, this example calls FriendsChatService</span></span><br><span class="line">        <span class="comment">/// directly to illustrate the intent of the pattern, which is: &quot;...to</span></span><br><span class="line">        <span class="comment">/// provide the global point of access to the instance...&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="type">FriendsChatService</span>.shared.add(subscriber: <span class="keyword">self</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MessagesListVC</span>: <span class="title class_">BaseVC</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">func</span> <span class="title function_">accept</span>(<span class="params">new</span> <span class="params">messages</span>: [<span class="type">Message</span>]) &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;MessagesListVC accepted &#x27;new messages&#x27;&quot;</span>)</span><br><span class="line">        <span class="comment">/// handle new messages in the child class</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">func</span> <span class="title function_">accept</span>(<span class="params">removed</span> <span class="params">messages</span>: [<span class="type">Message</span>]) &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;MessagesListVC accepted &#x27;removed messages&#x27;&quot;</span>)</span><br><span class="line">        <span class="comment">/// handle removed messages in the child class</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">func</span> <span class="title function_">startReceiveMessages</span>() &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;MessagesListVC starts receive messages&quot;</span>)</span><br><span class="line">        <span class="keyword">super</span>.startReceiveMessages()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ChatVC</span>: <span class="title class_">BaseVC</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">func</span> <span class="title function_">accept</span>(<span class="params">new</span> <span class="params">messages</span>: [<span class="type">Message</span>]) &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;ChatVC accepted &#x27;new messages&#x27;&quot;</span>)</span><br><span class="line">        <span class="comment">/// handle new messages in the child class</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">func</span> <span class="title function_">accept</span>(<span class="params">removed</span> <span class="params">messages</span>: [<span class="type">Message</span>]) &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;ChatVC accepted &#x27;removed messages&#x27;&quot;</span>)</span><br><span class="line">        <span class="comment">/// handle removed messages in the child class</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">func</span> <span class="title function_">startReceiveMessages</span>() &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;ChatVC starts receive messages&quot;</span>)</span><br><span class="line">        <span class="keyword">super</span>.startReceiveMessages()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Protocol for call-back events</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">protocol</span> <span class="title class_">MessageSubscriber</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">accept</span>(<span class="params">new</span> <span class="params">messages</span>: [<span class="type">Message</span>])</span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">accept</span>(<span class="params">removed</span> <span class="params">messages</span>: [<span class="type">Message</span>])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Protocol for communication with a message service</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">protocol</span> <span class="title class_">MessageService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">add</span>(<span class="params">subscriber</span>: <span class="type">MessageSubscriber</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Message domain model</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Message</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> id: <span class="type">Int</span></span><br><span class="line">    <span class="keyword">let</span> text: <span class="type">String</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FriendsChatService</span>: <span class="title class_">MessageService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">let</span> shared <span class="operator">=</span> <span class="type">FriendsChatService</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> subscribers <span class="operator">=</span> [<span class="type">MessageSubscriber</span>]()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">add</span>(<span class="params">subscriber</span>: <span class="type">MessageSubscriber</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/// In this example, fetching starts again by adding a new subscriber</span></span><br><span class="line">        subscribers.append(subscriber)</span><br><span class="line"></span><br><span class="line">        <span class="comment">/// Please note, the first subscriber will receive messages again when</span></span><br><span class="line">        <span class="comment">/// the second subscriber is added</span></span><br><span class="line">        startFetching()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">startFetching</span>() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/// Set up the network stack, establish a connection...</span></span><br><span class="line">        <span class="comment">/// ...and retrieve data from a server</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> newMessages <span class="operator">=</span> [<span class="type">Message</span>(id: <span class="number">0</span>, text: <span class="string">&quot;Text0&quot;</span>),</span><br><span class="line">                           <span class="type">Message</span>(id: <span class="number">5</span>, text: <span class="string">&quot;Text5&quot;</span>),</span><br><span class="line">                           <span class="type">Message</span>(id: <span class="number">10</span>, text: <span class="string">&quot;Text10&quot;</span>)]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> removedMessages <span class="operator">=</span> [<span class="type">Message</span>(id: <span class="number">1</span>, text: <span class="string">&quot;Text0&quot;</span>)]</span><br><span class="line"></span><br><span class="line">        <span class="comment">/// Send updated data to subscribers</span></span><br><span class="line">        receivedNew(messages: newMessages)</span><br><span class="line">        receivedRemoved(messages: removedMessages)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">extension</span> <span class="title class_">FriendsChatService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">receivedNew</span>(<span class="params">messages</span>: [<span class="type">Message</span>]) &#123;</span><br><span class="line"></span><br><span class="line">        subscribers.forEach &#123; item <span class="keyword">in</span></span><br><span class="line">            item.accept(new: messages)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">receivedRemoved</span>(<span class="params">messages</span>: [<span class="type">Message</span>]) &#123;</span><br><span class="line"></span><br><span class="line">        subscribers.forEach &#123; item <span class="keyword">in</span></span><br><span class="line">            item.accept(removed: messages)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Output.txt:</strong> 执行结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">MessagesListVC starts receive messages</span><br><span class="line">MessagesListVC accepted &#x27;new messages&#x27;</span><br><span class="line">MessagesListVC accepted &#x27;removed messages&#x27;</span><br><span class="line">======== At this point, the second subscriber is added ======</span><br><span class="line">ChatVC starts receive messages</span><br><span class="line">MessagesListVC accepted &#x27;new messages&#x27;</span><br><span class="line">ChatVC accepted &#x27;new messages&#x27;</span><br><span class="line">MessagesListVC accepted &#x27;removed messages&#x27;</span><br><span class="line">ChatVC accepted &#x27;removed messages&#x27;</span><br></pre></td></tr></table></figure></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><div class="tab-item-content"><p><strong>在 TypeScript 中使用模式</strong></p>
<p><strong>复杂度：</strong> ★☆☆</p>
<p><strong>流行度：</strong> ★★☆</p>
<p><strong>使用示例：</strong> 许多开发者将单例模式视为一种反模式。 因此它在 TypeScript 代码中的使用频率正在逐步减少。</p>
<p><strong>识别方法：</strong> 单例可以通过返回相同缓存对象的静态构建方法来识别。</p>
<p><strong>概念示例</strong></p>
<p>本例说明了<strong>单例</strong>设计模式的结构并重点回答了下面的问题：</p>
<ul>
<li>它由哪些类组成？</li>
<li>这些类扮演了哪些角色？</li>
<li>模式中的各个元素会以何种方式相互关联？</li>
</ul>
<p><strong>index.ts:</strong> 概念示例</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The Singleton class defines the `getInstance` method that lets clients access</span></span><br><span class="line"><span class="comment"> * the unique singleton instance.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Singleton</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="attr">instance</span>: <span class="title class_">Singleton</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The Singleton&#x27;s constructor should always be private to prevent direct</span></span><br><span class="line"><span class="comment">     * construction calls with the `new` operator.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">constructor</span>(<span class="params"></span>) &#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The static method that controls the access to the singleton instance.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * This implementation let you subclass the Singleton class while keeping</span></span><br><span class="line"><span class="comment">     * just one instance of each subclass around.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="title function_">getInstance</span>(): <span class="title class_">Singleton</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="title class_">Singleton</span>.<span class="property">instance</span>) &#123;</span><br><span class="line">            <span class="title class_">Singleton</span>.<span class="property">instance</span> = <span class="keyword">new</span> <span class="title class_">Singleton</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Singleton</span>.<span class="property">instance</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Finally, any singleton should define some business logic, which can be</span></span><br><span class="line"><span class="comment">     * executed on its instance.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">someBusinessLogic</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The client code.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">clientCode</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> s1 = <span class="title class_">Singleton</span>.<span class="title function_">getInstance</span>();</span><br><span class="line">    <span class="keyword">const</span> s2 = <span class="title class_">Singleton</span>.<span class="title function_">getInstance</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (s1 === s2) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Singleton works, both variables contain the same instance.&#x27;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Singleton failed, variables contain different instances.&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">clientCode</span>();</span><br></pre></td></tr></table></figure>

<p> <strong>Output.txt:</strong> 执行结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Singleton works, both variables contain the same instance.</span><br></pre></td></tr></table></figure></div><div class="tab-item-content"><div class="tabs"><div class="nav-tabs"><button type="button" class="tab active">概念示例</button><button type="button" class="tab">另一个例子</button></div><div class="tab-contents"><div class="tab-item-content active"><p><strong>概念示例</strong></p>
<p>通常而言， 单例实例会在结构体首次初始化时创建。 为了实现这一操作， 我们在结构体中定义一个 <code>get­Instance</code>获取实例方法。 该方法将负责创建和返回单例实例。 创建后， 每次调用 <code>get­Instance</code>时都会返回相同的单例实例。</p>
<p>协程方面又有什么需要注意的吗？ 每当多个协程想要访问实例时， 单例结构体就必须返回相同的实例。 正因如此， 单例设计模式的实施工作很容易出错。 下方的例子表示了创建单例的正确方式。</p>
<p>一些值得注意的地方：</p>
<ul>
<li>最开始时会有 <code>nil</code>检查， 确保 <code>single­Instance</code>单例实例在最开始时为空。 这是为了防止在每次调用 <code>get­Instance</code>方法时都去执行消耗巨大的锁定操作。 如果检查不通过， 则就意味着 <code>single­Instance</code>字段已被填充。</li>
<li><code>single­Instance</code>结构体将在锁定期间创建。</li>
<li>在获取到锁后还会有另一个 <code>nil</code>检查。 这是为了确保即便是有多个协程绕过了第一次检查， 也只能有一个可以创建单例实例。 否则， 所有协程都会创建自己的单例结构体实例。</li>
</ul>
<p><strong>single.go:</strong> 单例</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;sync&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> lock = &amp;sync.Mutex&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> single <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> singleInstance *single</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getInstance</span><span class="params">()</span></span> *single &#123;</span><br><span class="line">    <span class="keyword">if</span> singleInstance == <span class="literal">nil</span> &#123;</span><br><span class="line">        lock.Lock()</span><br><span class="line">        <span class="keyword">defer</span> lock.Unlock()</span><br><span class="line">        <span class="keyword">if</span> singleInstance == <span class="literal">nil</span> &#123;</span><br><span class="line">            fmt.Println(<span class="string">&quot;Creating single instance now.&quot;</span>)</span><br><span class="line">            singleInstance = &amp;single&#123;&#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            fmt.Println(<span class="string">&quot;Single instance already created.&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">&quot;Single instance already created.&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> singleInstance</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>main.go:</strong> 客户端代码</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">30</span>; i++ &#123;</span><br><span class="line">        <span class="keyword">go</span> getInstance()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Scanln is similar to Scan, but stops scanning at a newline and</span></span><br><span class="line">    <span class="comment">// after the final item there must be a newline or EOF.</span></span><br><span class="line">    fmt.Scanln()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>output.txt:</strong> 执行结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Creating single instance now.</span><br><span class="line">Single instance already created.</span><br><span class="line">Single instance already created.</span><br><span class="line">Single instance already created.</span><br><span class="line">Single instance already created.</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><em>根据： <a target="_blank" rel="noopener" href="https://golangbyexample.com/singleton-design-pattern-go/">Golang By Example</a></em></p></div><div class="tab-item-content"><p><strong>另一个例子</strong></p>
<ol>
<li><code>init</code>函数</li>
</ol>
<p>   我们可以在 <code>init</code>函数中创建单例实例。 这仅适用于实例的早期初始化工作已经确定时。  <code>init</code>函数仅会在包中的每个文件里调用一次， 所以我们可以确定其只会创建一个实例。</p>
<ol start="2">
<li><code>sync.Once</code></li>
</ol>
<p>   <code>sync.Once</code>仅会执行一次操作。 可查看下面的代码：</p>
<p><strong>syncOnce.go:</strong> 单例</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;sync&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> once sync.Once</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> single <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> singleInstance *single</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getInstance</span><span class="params">()</span></span> *single &#123;</span><br><span class="line">    <span class="keyword">if</span> singleInstance == <span class="literal">nil</span> &#123;</span><br><span class="line">        once.Do(</span><br><span class="line">            <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">                fmt.Println(<span class="string">&quot;Creating single instance now.&quot;</span>)</span><br><span class="line">                singleInstance = &amp;single&#123;&#125;</span><br><span class="line">            &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">&quot;Single instance already created.&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> singleInstance</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>main.go:</strong> 客户端代码</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">30</span>; i++ &#123;</span><br><span class="line">        <span class="keyword">go</span> getInstance()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Scanln is similar to Scan, but stops scanning at a newline and</span></span><br><span class="line">    <span class="comment">// after the final item there must be a newline or EOF.</span></span><br><span class="line">    fmt.Scanln()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>output.txt:</strong> 执行结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Creating single instance now.</span><br><span class="line">Single instance already created.</span><br><span class="line">Single instance already created.</span><br></pre></td></tr></table></figure>

<p><em>根据： <a target="_blank" rel="noopener" href="https://golangbyexample.com/singleton-design-pattern-go/">Golang By Example</a></em></p></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://wangyyovo.github.io">Blank</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://wangyyovo.github.io/posts/37f0d8f/">https://wangyyovo.github.io/posts/37f0d8f/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://wangyyovo.github.io" target="_blank">Blank</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/pattern/">pattern</a></div><div class="post-share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/common/6cc78f9be0372c0d330f2c7d326f7d9e.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/7784c089/" title="结构型模式-适配器模式"><img class="cover" src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/common/1c1bfec4d6e457394deb11dd6521bbe8.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">结构型模式-适配器模式</div></div><div class="info-2"><div class="info-item-1">  https://refactoringguru.cn/design-patterns/adapter  结构型模式-适配器模式亦称： 封装器模式、Wrapper、Adapter 意图适配器模式是一种结构型设计模式， 它能使接口不兼容的对象能够相互合作。  问题假如你正在开发一款股票市场监测程序， 它会从不同来源下载 XML 格式的股票数据， 然后向用户呈现出美观的图表。 在开发过程中， 你决定在程序中整合一个第三方智能分析函数库。 但是遇到了一个问题， 那就是分析函数库只兼容 JSON 格式的数据。  你可以修改程序库来支持 XML。 但是， 这可能需要修改部分依赖该程序库的现有代码。 甚至还有更糟糕的情况， 你可能根本没有程序库的源代码， 从而无法对其进行修改。 解决方案你可以创建一个适配器。 这是一个特殊的对象， 能够转换对象接口， 使其能与其他对象进行交互。 适配器模式通过封装对象将复杂的转换过程隐藏于幕后。 被封装的对象甚至察觉不到适配器的存在。 例如， 你可以使用一个将所有数据转换为英制单位 （如英尺和英里） 的适配器封装运行于米和千米单位制中的对象。 适配器不仅可...</div></div></div></a><a class="pagination-related" href="/posts/63b28d52/" title="创建型模式-原型模式"><img class="cover" src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/common/01b549d5aec9f475e74b2781486eed2d.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">创建型模式-原型模式</div></div><div class="info-2"><div class="info-item-1">  https://refactoringguru.cn/design-patterns/prototype  创建型模式-原型模式亦称： 克隆、Clone、Prototype 意图原型模式是一种创建型设计模式， 使你能够复制已有对象， 而又无需使代码依赖它们所属的类。  问题如果你有一个对象， 并希望生成与其完全相同的一个复制品， 你该如何实现呢？ 首先， 你必须新建一个属于相同类的对象。 然后， 你必须遍历原始对象的所有成员变量， 并将成员变量值复制到新对象中。 不错！ 但有个小问题。 并非所有对象都能通过这种方式进行复制， 因为有些对象可能拥有私有成员变量， 它们在对象本身以外是不可见的。  直接复制还有另外一个问题。 因为你必须知道对象所属的类才能创建复制品， 所以代码必须依赖该类。 即使你可以接受额外的依赖性， 那还有另外一个问题： 有时你只知道对象所实现的接口， 而不知道其所属的具体类， 比如可向方法的某个参数传入实现了某个接口的任何对象。 解决方案原型模式将克隆过程委派给被克隆的实际对象。 模式为所有支持克隆的对象声明了一个通用接口， 该接口让你能够克隆对象， 同时...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/posts/54deb0e2/" title="图解设计模式"><img class="cover" src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/common/cb75d9300b44131b6a0afbab792f48cd.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2021-05-16</div><div class="info-item-2">图解设计模式</div></div><div class="info-2"><div class="info-item-1"> 图解设计模式 http://tigerb.cn/2021/03/07/patterns-picture/  前言常常听别人说设计模式不太容易理解，以及学习设计模式到底能帮我们解决什么问题，今天我们就用几张图来看看：  设计模式到底是什么？ 为什么我们需要学习设计模式？  我也写过烂代码是的，没什么，我也写过烂代码，刚毕业时业务逻辑也会一个函数干到底，只知道能实现功能就可以了。 12345package demo func YourFunc() &#123;	// 所有的逻辑代码一股脑写完......&#125;   知道了拆分函数自然而然知道了需要合理拆分函数。  然后把各个函数组织起来。  面临新的困境某一天产品的需求需要支持新的场景，发现某一处的代码逻辑有变动需要支持新的场景，怎么办？  整个代码拷贝一份？不会有人这么干吧？(其实我还真见过，你们呢😏) 把绿色变动的代码块，复制成一个新的函数，修改为新场景使用的函数？ 把变动的代码再提为两个新函数，一个绿色为老代码，一个蓝色为新场景代码？   上面这种解决问题的方式就是面向过程的编程思想。 我们都在变优秀随着我们不断的学习...</div></div></div></a><a class="pagination-related" href="/posts/88f78d2f/" title="面向对象的设计过程"><img class="cover" src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/common/6d6dbbdcfa655b5d965f52adb35443ae.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2021-05-16</div><div class="info-item-2">面向对象的设计过程</div></div><div class="info-2"><div class="info-item-1"> 面向对象的设计过程 http://tigerb.cn/2019/10/11/oop/  前言我一直认为分享的目的不是炫技。  一是，自我学习的总结。 二是，降低他人的学习成本。 三是，别人对自己学习结果的审核。  同时，本次分享有下面四个要素：    观点 本次分享的观点是一个软件工程中的思维方法，不限于编程语言    探讨 我可能理解错的，或者大家没理解的，欢迎大家积极评论，尽可能多互动，目的增加理解   理解 真的希望大家能理解   运用 最重要的，如果你觉着有帮助，一定要去在实际业务中实战   背景工作中，几乎大家经常抱怨别人写的代码：  没法改 耦合高 无法扩展   今天就来探讨如何克服上面的问题～  场景首先问个问题：  平常工作中来了一个业务需求，我们是如何开始写代码的？  我推测大多数人可能：  1、梳理业务 2、设计数据库、接口、缓存 3、评审 4、于是就开始了 怎么怎么样...如果怎么怎么样...怎么怎么样...愉快的码代码的过程   此处有人觉着有啥问题么？  1备注：说出来问题的，本次分享就可以略过了~  一个简单的业务场景123456789101112比...</div></div></div></a><a class="pagination-related" href="/posts/bfac6395/" title="工厂模式 | Go设计模式实战"><img class="cover" src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/common/296967057d2691c0c7ed919799d75416.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2021-05-16</div><div class="info-item-2">工厂模式 | Go设计模式实战</div></div><div class="info-2"><div class="info-item-1">  http://tigerb.cn/  我的代码没有else系列-简单工厂 结合实际业务谈设计模式 业务场景 12调用一个服务生成静态页面不同的页面拥有不同的模块  不同的页面的数据结构不一样生成不同的页面对象 正常代码 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667package mainimport &quot;fmt&quot;const (	// CartConst 购物车列表页面	CartConst = &quot;cart/list&quot;	// ProductConst 商品列表页面	ProductConst = &quot;product/list&quot;)// Context 请求上下文type Context struct &#123;	URI string&#125;// PageInterface PageInterfacetype PageIn...</div></div></div></a><a class="pagination-related" href="/posts/11cee220/" title="并发组件 | Go设计模式实战"><img class="cover" src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/common/9f7060cd83cb8a5c5c9c199ae048d1f0.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2021-05-16</div><div class="info-item-2">并发组件 | Go设计模式实战</div></div><div class="info-2"><div class="info-item-1"> 并发组件 | Go设计模式实战 嗯，Go设计模式实战系列，一个设计模式业务真实使用的golang系列。 http://tigerb.cn/  前言本系列主要分享，如何在我们的真实业务场景中使用设计模式。 本系列文章主要采用如下结构：  什么是「XX设计模式」？ 什么真实业务场景可以使用「XX设计模式」？ 怎么用「XX设计模式」？  本文主要介绍「组合模式」结合Go语言天生的并发特性，如何在真实业务场景中使用。 之前文章《代码组件 | Go设计模式实战》已经介绍了「组合模式」的概念，以及在业务中的使用。今天我们结合Go语言天生的并发特性，升级「组合模式」为「并发组合模式」。 我们先来简单回顾下「组合模式」的知识，详细可以查看上篇文章《代码组件 | Go设计模式实战》 什么是「并发组合模式」？组合模式的概念：  一个具有层级关系的对象由一系列拥有父子关系的对象通过树形结构组成。  并发组合模式的概念：  一个具有层级关系的对象由一系列拥有父子关系的对象通过树形结构组成，子对象即可被串行执行，也可被并发执行  并发组合模式的优势：  原本串行的业务(存在阻塞的部分，比如网络IO等)可...</div></div></div></a><a class="pagination-related" href="/posts/20ee7783/" title="状态变换 | Go设计模式实战"><img class="cover" src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/common/c6e2f99790804a5b20eb687085df1fb6.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2021-05-16</div><div class="info-item-2">状态变换 | Go设计模式实战</div></div><div class="info-2"><div class="info-item-1"> 状态变换 | Go设计模式实战 嗯，Go设计模式实战系列，一个设计模式业务真实使用的golang系列。 http://tigerb.cn/  前言本系列主要分享，如何在我们的真实业务场景中使用设计模式。 本系列文章主要采用如下结构：  什么是「XX设计模式」？ 什么真实业务场景可以使用「XX设计模式」？ 怎么用「XX设计模式」？  本文主要介绍「状态模式」如何在真实业务场景中使用。 「状态模式」比较简单，就是算法的选取取决于于自己的内部状态。相较于「策略模式」算法的选取由用户决策变成内部状态决策，「策略模式」是用户(客户端)选择具体的算法，「状态模式」只是通过内部不同的状态选择具体的算法。 什么是「状态模式」？ 不同的算法按照统一的标准封装，根据不同的内部状态，决策使用何种算法  「状态模式」和「策略模式」的区别 策略模式：依靠客户决策 状态模式：依靠内部状态决策  什么真实业务场景可以用「状态模式」？ 具体算法的选取是由内部状态决定的   首先，内部存在多种状态 其次，不同的状态的业务逻辑各不相同   我们有哪些真实业务场景可以用「状态模式」呢？  比如，发送短信接口、限流等...</div></div></div></a><a class="pagination-related" href="/posts/aee36e49/" title="客户决策 | Go设计模式实战"><img class="cover" src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/common/e671379624222b1599a340edb6dbce75.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2021-05-16</div><div class="info-item-2">客户决策 | Go设计模式实战</div></div><div class="info-2"><div class="info-item-1"> 客户决策 | Go设计模式实战 嗯，Go设计模式实战系列，一个设计模式业务真实使用的golang系列。 http://tigerb.cn/  前言本系列主要分享，如何在我们的真实业务场景中使用设计模式。 本系列文章主要采用如下结构：  什么是「XX设计模式」？ 什么真实业务场景可以使用「XX设计模式」？ 怎么用「XX设计模式」？  本文主要介绍「策略模式」如何在真实业务场景中使用。 什么是「策略模式」？「策略模式」比较简单，大家平常工作中应该经常使用到，所以本文作为复习，帮助大家温故知新。我们先来看下定义：  不同的算法按照统一的标准封装，客户端根据不同的场景，决策使用何种算法。  上面的概念的关键词：  算法：就是行为 标准：就是interface 客户端：客户端是相对的，谁调用谁就是客户端 场景：判断条件 决策：判断的过程  概念很容易理解，不多说。 「策略模式」的优势：  典型的高内聚：算法和算法之间完全独立、互不干扰 典型的松耦合：客户端依赖的是接口的抽象方法 沉淀：每一个封装好的算法都是这个技术团队的财富，且未来可以被轻易的修改、复用  什么真实业务场景可以用「策略模...</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/theme/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Blank</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">352</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">46</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">58</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/wangyyovo" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:xxxxxx@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fas fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%9E%8B%E6%A8%A1%E5%BC%8F-%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.</span> <span class="toc-text">创建型模式-单例模式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%84%8F%E5%9B%BE"><span class="toc-number">1.1.</span> <span class="toc-text">意图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98"><span class="toc-number">1.2.</span> <span class="toc-text">问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">1.3.</span> <span class="toc-text">解决方案</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9C%9F%E5%AE%9E%E4%B8%96%E7%95%8C%E7%B1%BB%E6%AF%94"><span class="toc-number">1.4.</span> <span class="toc-text">真实世界类比</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F%E7%BB%93%E6%9E%84"><span class="toc-number">1.5.</span> <span class="toc-text">单例模式结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BC%AA%E4%BB%A3%E7%A0%81"><span class="toc-number">1.6.</span> <span class="toc-text">伪代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F%E9%80%82%E5%90%88%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">1.7.</span> <span class="toc-text">单例模式适合应用场景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F"><span class="toc-number">1.8.</span> <span class="toc-text">实现方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="toc-number">1.9.</span> <span class="toc-text">单例模式优缺点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%8E%E5%85%B6%E4%BB%96%E6%A8%A1%E5%BC%8F%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="toc-number">1.10.</span> <span class="toc-text">与其他模式的关系</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.11.</span> <span class="toc-text">代码示例</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/d14168d/" title="虚拟机问题合集"><img src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/hexo/090cfe4e9e60b0ad0de05db822f3ae97.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="虚拟机问题合集"/></a><div class="content"><a class="title" href="/posts/d14168d/" title="虚拟机问题合集">虚拟机问题合集</a><time datetime="2022-07-16T13:30:36.000Z" title="发表于 2022-07-16 21:30:36">2022-07-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/f540045f/" title="用go语言编写移动端sdk和app开发"><img src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/golang/941ed1ec2925719a0c92e76f4f786b6a.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="用go语言编写移动端sdk和app开发"/></a><div class="content"><a class="title" href="/posts/f540045f/" title="用go语言编写移动端sdk和app开发">用go语言编写移动端sdk和app开发</a><time datetime="2022-07-04T12:14:21.000Z" title="发表于 2022-07-04 20:14:21">2022-07-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/5faac006/" title="在线编程IDE"><img src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/hexo/090cfe4e9e60b0ad0de05db822f3ae97.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="在线编程IDE"/></a><div class="content"><a class="title" href="/posts/5faac006/" title="在线编程IDE">在线编程IDE</a><time datetime="2022-06-12T13:30:36.000Z" title="发表于 2022-06-12 21:30:36">2022-06-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/7594185d/" title="即时性能分析工具Pyroscope"><img src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/golang/3bfb3279740bc9a5b5ef436fa887ef07.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="即时性能分析工具Pyroscope"/></a><div class="content"><a class="title" href="/posts/7594185d/" title="即时性能分析工具Pyroscope">即时性能分析工具Pyroscope</a><time datetime="2022-06-12T08:07:36.000Z" title="发表于 2022-06-12 16:07:36">2022-06-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/82a7aa7c/" title="golang性能调试优化方法"><img src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/common/3.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="golang性能调试优化方法"/></a><div class="content"><a class="title" href="/posts/82a7aa7c/" title="golang性能调试优化方法">golang性能调试优化方法</a><time datetime="2022-06-12T03:00:36.000Z" title="发表于 2022-06-12 11:00:36">2022-06-12</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 By Blank</span><span class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 5.4.2</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.4.3</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><div class="js-pjax"><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = null

  const initValine = (el, path) => {
    if (isShuoshuo) {
      window.shuoshuoComment.destroyValine = () => {
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }

    const valineConfig = {
      el: '#vcomment',
      appId: '49gEIIGN7uRbL6vHhieSpBzM-MdYXbMMI',
      appKey: 'uqts0urLKwikYQ0fKmIkMHBE',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      visitor: false,
      ...option,
      path: isShuoshuo ? path : (option && option.path) || window.location.pathname
    }

    new Valine(valineConfig)
  }

  const loadValine = async (el, path) => {
    if (typeof Valine === 'function') {
      initValine(el, path)
    } else {
      await btf.getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js')
      initValine(el, path)
    }
  }

  if (isShuoshuo) {
    'Valine' === 'Valine'
      ? window.shuoshuoComment = { loadComment: loadValine }
      : window.loadOtherComment = loadValine
    return
  }

  if ('Valine' === 'Valine' || !false) {
    if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>