<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>OPA-ä»‹ç» | Blank</title><meta name="keywords" content="opa"><meta name="author" content="Blank"><meta name="copyright" content="Blank"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="OPA-ä»‹ç» https:&#x2F;&#x2F;www.openpolicyagent.org&#x2F;docs&#x2F;latest&#x2F;  1.OPA ä»‹ç»å¼€æ”¾ç­–ç•¥ä»£ç†ï¼ˆOPAï¼Œå‘éŸ³ä¸ºâ€œ oh-paâ€ï¼‰æ˜¯ä¸€ä¸ªå¼€æ”¾æºä»£ç çš„é€šç”¨ç­–ç•¥å¼•æ“ï¼Œå®ƒç»Ÿä¸€äº†æ•´ä¸ªå †æ ˆä¸­çš„ç­–ç•¥æ‰§è¡Œã€‚OPAæä¾›äº†ä¸€ç§é«˜çº§çš„å£°æ˜æ€§è¯­è¨€ï¼Œä½¿æ‚¨å¯ä»¥å°†ç­–ç•¥æŒ‡å®šä¸ºä»£ç å’Œç®€å•çš„APIï¼Œä»¥å‡è½»è½¯ä»¶å†³ç­–çš„è´Ÿæ‹…ã€‚æ‚¨å¯ä»¥ä½¿ç”¨OPAåœ¨å¾®æœåŠ¡ï¼ŒKubernetesï¼ŒCI &#x2F; CD">
<meta property="og:type" content="article">
<meta property="og:title" content="OPA-ä»‹ç»">
<meta property="og:url" content="https://wangyyovo.github.io/posts/5d3bf062/">
<meta property="og:site_name" content="Blank">
<meta property="og:description" content="OPA-ä»‹ç» https:&#x2F;&#x2F;www.openpolicyagent.org&#x2F;docs&#x2F;latest&#x2F;  1.OPA ä»‹ç»å¼€æ”¾ç­–ç•¥ä»£ç†ï¼ˆOPAï¼Œå‘éŸ³ä¸ºâ€œ oh-paâ€ï¼‰æ˜¯ä¸€ä¸ªå¼€æ”¾æºä»£ç çš„é€šç”¨ç­–ç•¥å¼•æ“ï¼Œå®ƒç»Ÿä¸€äº†æ•´ä¸ªå †æ ˆä¸­çš„ç­–ç•¥æ‰§è¡Œã€‚OPAæä¾›äº†ä¸€ç§é«˜çº§çš„å£°æ˜æ€§è¯­è¨€ï¼Œä½¿æ‚¨å¯ä»¥å°†ç­–ç•¥æŒ‡å®šä¸ºä»£ç å’Œç®€å•çš„APIï¼Œä»¥å‡è½»è½¯ä»¶å†³ç­–çš„è´Ÿæ‹…ã€‚æ‚¨å¯ä»¥ä½¿ç”¨OPAåœ¨å¾®æœåŠ¡ï¼ŒKubernetesï¼ŒCI &#x2F; CD">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontents.com/wangyyovo/CDN/master/cover/common/181a3c44c19e44a7e153e74abee69a73.jpg">
<meta property="article:published_time" content="2022-03-02T09:23:44.000Z">
<meta property="article:modified_time" content="2022-03-02T09:23:44.000Z">
<meta property="article:author" content="Blank">
<meta property="article:tag" content="opa">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontents.com/wangyyovo/CDN/master/cover/common/181a3c44c19e44a7e153e74abee69a73.jpg"><link rel="shortcut icon" href="https://raw.githubusercontents.com/wangyyovo/CDN/master/theme/favicon.ico"><link rel="canonical" href="https://wangyyovo.github.io/posts/5d3bf062/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹ï¼š${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"ç¹","msgToSimplifiedChinese":"ç°¡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: 'å¤©',
  date_suffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: undefined,
  lightbox: 'mediumZoom',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'OPA-ä»‹ç»',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-03-02 17:23:44'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="alternate" href="/atom.xml" title="Blank" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://raw.githubusercontents.com/wangyyovo/CDN/master/theme/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">356</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">36</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">54</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> ä¸»é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> æ—¶é—´è½´</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡ç­¾</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> åˆ†ç±»</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> å‹é“¾</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fas fa-coffee"></i><span> ç•™è¨€æ¿</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> å…³äº</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> å¨±ä¹</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> éŸ³ä¹</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> ç”µå½±</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-image"></i><span> ç›¸å†Œ</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-book"></i><span> æ•™ç¨‹</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/posts/21cfbf15/"><span> ğŸš€ å¿«é€Ÿé–‹å§‹</span></a></li><li><a class="site-page child" href="/posts/dc584b87/"><span> ğŸ“‘ ä¸»é¡Œé é¢</span></a></li><li><a class="site-page child" href="/posts/4aa8abbe/"><span> ğŸ›  ä¸»é¡Œé…ç½®-1</span></a></li><li><a class="site-page child" href="/posts/ceeb73f/"><span> âš”ï¸ ä¸»é¡Œé…ç½®-2</span></a></li><li><a class="site-page child" href="/posts/98d20436/"><span> â“ ä¸»é¡Œå•ç­”</span></a></li><li><a class="site-page child" href="/posts/4073eda/"><span> âš¡ï¸ é€²éšæ•™ç¨‹</span></a></li><li><a class="site-page child" href="/posts/198a4240/"><span> âœ¨ æ›´æ–°æ—¥èªŒ</span></a></li><li><a class="site-page child" href="/posts/507c070f/"><span> ğŸ“‘ Aplayeræ•™ç¨‹</span></a></li><li><a class="site-page child" href="/posts/2df239ce/"><span> ğŸ“‘ æ¨™ç±¤å¤–æ›</span></a></li><li><a class="site-page child" href="/posts/b37b5fe3/"><span> ğŸ“‘ è‡ªå®šç¾©ä»£ç¢¼é…è‰²</span></a></li><li><a class="site-page child" href="/posts/ea33ab97/"><span> ğŸ“‘ è‡ªå®šç¾©å´é‚Šæ¬„</span></a></li><li><a class="site-page child" href="/posts/89757140/"><span> ğŸ“‘ Markdown</span></a></li><li><a class="site-page child" href="/posts/9db656e5/"><span> ğŸ“‘ ä»£ç é«˜äº®æµ‹è¯•</span></a></li><li><a class="site-page child" href="/posts/c9711c19/"><span> ğŸ“‘ ç•¶è¨­ç½®top_imgç‚ºfalseæ™‚</span></a></li><li><a class="site-page child" href="/posts/39b121ef/"><span> ğŸ“‘ Hexoå…§ç½®æ¨™ç±¤å¤–æ›</span></a></li><li><a class="site-page child" href="/posts/7670b080/"><span> ğŸ“‘ Butterfly ç¾åŒ–/å„ªåŒ–/é­”æ”¹ æ•™ç¨‹åˆé›†</span></a></li><li><a class="site-page child" href="/posts/913b2502/"><span> ğŸ“‘ æ²¡æœ‰å°é¢</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://raw.githubusercontents.com/wangyyovo/CDN/master/cover/common/181a3c44c19e44a7e153e74abee69a73.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Blank</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> æœç´¢</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> ä¸»é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> æ—¶é—´è½´</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡ç­¾</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> åˆ†ç±»</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> å‹é“¾</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fas fa-coffee"></i><span> ç•™è¨€æ¿</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> å…³äº</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> å¨±ä¹</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> éŸ³ä¹</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> ç”µå½±</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-image"></i><span> ç›¸å†Œ</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-book"></i><span> æ•™ç¨‹</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/posts/21cfbf15/"><span> ğŸš€ å¿«é€Ÿé–‹å§‹</span></a></li><li><a class="site-page child" href="/posts/dc584b87/"><span> ğŸ“‘ ä¸»é¡Œé é¢</span></a></li><li><a class="site-page child" href="/posts/4aa8abbe/"><span> ğŸ›  ä¸»é¡Œé…ç½®-1</span></a></li><li><a class="site-page child" href="/posts/ceeb73f/"><span> âš”ï¸ ä¸»é¡Œé…ç½®-2</span></a></li><li><a class="site-page child" href="/posts/98d20436/"><span> â“ ä¸»é¡Œå•ç­”</span></a></li><li><a class="site-page child" href="/posts/4073eda/"><span> âš¡ï¸ é€²éšæ•™ç¨‹</span></a></li><li><a class="site-page child" href="/posts/198a4240/"><span> âœ¨ æ›´æ–°æ—¥èªŒ</span></a></li><li><a class="site-page child" href="/posts/507c070f/"><span> ğŸ“‘ Aplayeræ•™ç¨‹</span></a></li><li><a class="site-page child" href="/posts/2df239ce/"><span> ğŸ“‘ æ¨™ç±¤å¤–æ›</span></a></li><li><a class="site-page child" href="/posts/b37b5fe3/"><span> ğŸ“‘ è‡ªå®šç¾©ä»£ç¢¼é…è‰²</span></a></li><li><a class="site-page child" href="/posts/ea33ab97/"><span> ğŸ“‘ è‡ªå®šç¾©å´é‚Šæ¬„</span></a></li><li><a class="site-page child" href="/posts/89757140/"><span> ğŸ“‘ Markdown</span></a></li><li><a class="site-page child" href="/posts/9db656e5/"><span> ğŸ“‘ ä»£ç é«˜äº®æµ‹è¯•</span></a></li><li><a class="site-page child" href="/posts/c9711c19/"><span> ğŸ“‘ ç•¶è¨­ç½®top_imgç‚ºfalseæ™‚</span></a></li><li><a class="site-page child" href="/posts/39b121ef/"><span> ğŸ“‘ Hexoå…§ç½®æ¨™ç±¤å¤–æ›</span></a></li><li><a class="site-page child" href="/posts/7670b080/"><span> ğŸ“‘ Butterfly ç¾åŒ–/å„ªåŒ–/é­”æ”¹ æ•™ç¨‹åˆé›†</span></a></li><li><a class="site-page child" href="/posts/913b2502/"><span> ğŸ“‘ æ²¡æœ‰å°é¢</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">OPA-ä»‹ç»</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2022-03-02T09:23:44.000Z" title="å‘è¡¨äº 2022-03-02 17:23:44">2022-03-02</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2022-03-02T09:23:44.000Z" title="æ›´æ–°äº 2022-03-02 17:23:44">2022-03-02</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/microservice/">microservice</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/microservice/opa/">opa</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">å­—æ•°æ€»è®¡:</span><span class="word-count">7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»æ—¶é•¿:</span><span>29åˆ†é’Ÿ</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="OPA-ä»‹ç»"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»é‡:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><script src="\assets\js\APlayer.min.js"> </script><h1 id="OPA-ä»‹ç»"><a href="#OPA-ä»‹ç»" class="headerlink" title="OPA-ä»‹ç»"></a>OPA-ä»‹ç»</h1><blockquote>
<p><a target="_blank" rel="noopener" href="https://www.openpolicyagent.org/docs/latest/">https://www.openpolicyagent.org/docs/latest/</a></p>
</blockquote>
<h2 id="1-OPA-ä»‹ç»"><a href="#1-OPA-ä»‹ç»" class="headerlink" title="1.OPA ä»‹ç»"></a>1.OPA ä»‹ç»</h2><p>å¼€æ”¾ç­–ç•¥ä»£ç†ï¼ˆOPAï¼Œå‘éŸ³ä¸ºâ€œ oh-paâ€ï¼‰æ˜¯ä¸€ä¸ªå¼€æ”¾æºä»£ç çš„é€šç”¨ç­–ç•¥å¼•æ“ï¼Œå®ƒç»Ÿä¸€äº†æ•´ä¸ªå †æ ˆä¸­çš„ç­–ç•¥æ‰§è¡Œã€‚OPAæä¾›äº†ä¸€ç§é«˜çº§çš„å£°æ˜æ€§è¯­è¨€ï¼Œä½¿æ‚¨å¯ä»¥å°†ç­–ç•¥æŒ‡å®šä¸ºä»£ç å’Œç®€å•çš„APIï¼Œä»¥å‡è½»è½¯ä»¶å†³ç­–çš„è´Ÿæ‹…ã€‚æ‚¨å¯ä»¥ä½¿ç”¨OPAåœ¨å¾®æœåŠ¡ï¼ŒKubernetesï¼ŒCI &#x2F; CDç®¡é“ï¼ŒAPIç½‘å…³ç­‰ä¸­å®æ–½ç­–ç•¥ã€‚</p>
<p>OPA æœ€åˆæ˜¯ç”± Styra å…¬å¸åœ¨ 2016 å¹´åˆ›å»ºå¹¶å¼€æºçš„é¡¹ç›®ï¼Œç›®å‰è¯¥å…¬å¸çš„ä¸»è¦äº§å“å°±æ˜¯æä¾›å¯è§†åŒ–ç­–ç•¥æ§åˆ¶åŠç­–ç•¥æ‰§è¡Œçš„å¯è§†åŒ– Dashboard æœåŠ¡çš„ã€‚</p>
<p>OPA é¦–æ¬¡è¿›å…¥ CNCF å¹¶æˆä¸º sandbox çº§åˆ«çš„é¡¹ç›®æ˜¯åœ¨ 2018 å¹´ï¼Œ åœ¨ 2021 å¹´çš„ 2 æœˆä»½ä¾¿å·²ç»ä» CNCF æ¯•ä¸šï¼Œè¿™ä¸ªè¿‡ç¨‹ç›¸å¯¹æ¥è¯´è¿˜æ˜¯æ¯”è¾ƒå¿«çš„ï¼Œç”±æ­¤ä¹Ÿå¯ä»¥çœ‹å‡º OPA æ˜¯ä¸€ä¸ªæ¯”è¾ƒæ´»è·ƒä¸”åº”ç”¨å¹¿æ³›çš„é¡¹ç›®ã€‚</p>
<p>é€è¿‡ç°è±¡çœ‹æœ¬è´¨ï¼Œç­–ç•¥å°±æ˜¯ä¸€ç»„è§„åˆ™ï¼Œè¯·æ±‚å‘é€åˆ°å¼•æ“ï¼Œå¼•æ“æ ¹æ®è§„åˆ™æ¥è¿›è¡Œå†³ç­–ã€‚OPA å¹¶ä¸è´Ÿè´£å…·ä½“ä»»åŠ¡çš„æ‰§è¡Œï¼Œå®ƒä»…è´Ÿè´£å†³ç­–ï¼Œéœ€è¦å†³ç­–çš„è¯·æ±‚é€šè¿‡ JSON çš„æ–¹å¼ä¼ é€’ç»™ OPA ï¼Œåœ¨ OPA å†³ç­–åï¼Œä¹Ÿä¼šå°†ç»“æœä»¥ JSON çš„å½¢å¼è¿”å›ã€‚</p>
<p><img src="https://raw.githubusercontents.com/wangyyovo/CDN/master/blog/opa/opa-service.png"></p>
<h2 id="2-OPA-è§£å†³äº†å“ªäº›é—®é¢˜"><a href="#2-OPA-è§£å†³äº†å“ªäº›é—®é¢˜" class="headerlink" title="2.OPA è§£å†³äº†å“ªäº›é—®é¢˜"></a>2.OPA è§£å†³äº†å“ªäº›é—®é¢˜</h2><p>OPAé€šè¿‡è¯„ä¼°æŸ¥è¯¢è¾“å…¥ä»¥åŠé’ˆå¯¹ç­–ç•¥å’Œæ•°æ®æ¥ç”Ÿæˆç­–ç•¥å†³ç­–ã€‚OPAå’ŒRegoæ˜¯åŸŸæ— å…³çš„ï¼Œå› æ­¤æ‚¨å¯ä»¥æè¿°ç­–ç•¥ä¸­å‡ ä¹æ‰€æœ‰ç±»å‹çš„ä¸å˜å¼ã€‚ä¾‹å¦‚ï¼š</p>
<ol>
<li>å“ªäº›ç”¨æˆ·å¯ä»¥è®¿é—®å“ªäº›èµ„æºï¼›</li>
<li>å…è®¸å“ªäº›å­ç½‘å‡ºå£æµé‡ï¼›</li>
<li>å¿…é¡»å°†å·¥ä½œè´Ÿè½½éƒ¨ç½²åˆ°å“ªä¸ªç¾¤é›†ï¼›</li>
<li>å¯ä»¥ä»å“ªäº›æ³¨å†Œè¡¨äºŒè¿›åˆ¶æ–‡ä»¶ä¸‹è½½ï¼›</li>
<li>å®¹å™¨å¯ä»¥æ‰§è¡Œå“ªäº›OSåŠŸèƒ½ï¼›</li>
<li>å¯ä»¥åœ¨ä¸€å¤©çš„å“ªä¸ªæ—¶é—´è®¿é—®ç³»ç»Ÿï¼›</li>
<li>éœ€è¦ç­–ç•¥æ§åˆ¶ç”¨æˆ·æ˜¯å¦å¯ç™»é™†æœåŠ¡å™¨æˆ–è€…åšä¸€äº›æ“ä½œï¼›</li>
<li>éœ€è¦ç­–ç•¥æ§åˆ¶å“ªäº›é¡¹ç›®&#x2F;å“ªäº›ç»„ä»¶å¯è¿›è¡Œéƒ¨ç½²ï¼›</li>
<li>éœ€è¦ç­–ç•¥æ§åˆ¶å¦‚ä½•è®¿é—®æ•°æ®åº“ï¼›</li>
<li>éœ€è¦ç­–ç•¥æ§åˆ¶å“ªäº›èµ„æºå¯éƒ¨ç½²åˆ° Kubernetes ä¸­ï¼›</li>
</ol>
<p>ç­–ç•¥å†³ç­–ä¸ä»…é™äºç®€å•çš„æ˜¯&#x2F;å¦æˆ–å…è®¸&#x2F;æ‹’ç»ç­”æ¡ˆã€‚åƒæŸ¥è¯¢è¾“å…¥ä¸€æ ·ï¼Œæ‚¨çš„ç­–ç•¥å¯ä»¥ç”Ÿæˆä»»æ„ç»“æ„åŒ–æ•°æ®ä½œä¸ºè¾“å‡ºã€‚<br><img src="https://raw.githubusercontents.com/wangyyovo/CDN/master/blog/opa/bb67bc706e524598ad72c7d53de3519c.png"></p>
<p>ä½†æ˜¯å¯¹äºè¿™äº›åœºæ™¯æˆ–è€…è½¯ä»¶æ¥è¯´ï¼Œé…ç½®å®ƒä»¬çš„ç­–ç•¥æ˜¯éœ€è¦ä¸è¯¥è½¯ä»¶è¿›è¡Œè€¦åˆçš„ï¼Œå½¼æ­¤æ˜¯ä¸ç»Ÿä¸€ï¼Œä¸é€šç”¨çš„ã€‚ç®¡ç†èµ·æ¥ä¹Ÿä¼šæ¯”è¾ƒæ··ä¹±ï¼Œå¸¦æ¥äº†ä¸å°çš„ç»´æŠ¤æˆæœ¬ã€‚</p>
<p>OPA çš„å‡ºç°å¯ä»¥å°†å„å¤„é…ç½®çš„ç­–ç•¥è¿›è¡Œç»Ÿä¸€ï¼Œæå¤§çš„é™ä½äº†ç»´æŠ¤æˆæœ¬ã€‚ä»¥åŠå°†ç­–ç•¥ä¸å¯¹åº”çš„è½¯ä»¶&#x2F;æœåŠ¡è¿›è¡Œè§£è€¦ï¼Œæ–¹ä¾¿è¿›è¡Œç§»æ¤&#x2F;å¤ç”¨ã€‚<br><img src="https://raw.githubusercontents.com/wangyyovo/CDN/master/blog/opa/bb6e1d6149d3406f92ea406d150d0a55.png"></p>
<p>å‡è®¾æ‚¨åœ¨å…·æœ‰ä»¥ä¸‹ç³»ç»Ÿçš„ç»„ç»‡ä¸­å·¥ä½œï¼š<br><img src="https://raw.githubusercontents.com/wangyyovo/CDN/master/blog/opa/system.svg" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>ç³»ç»Ÿä¸­åŒ…å«ä¸‰ç§ç»„ä»¶ï¼š</p>
<ul>
<li>æœåŠ¡å™¨æš´éœ²é›¶å±‚æˆ–å¤šä¸ªåè®®ï¼ˆä¾‹å¦‚ï¼Œhttpï¼Œsshç­‰ç­‰ï¼‰</li>
<li>ç½‘ç»œè¿æ¥æœåŠ¡å™¨ï¼Œå¯ä»¥æ˜¯å…¬å…±çš„æˆ–ç§æœ‰çš„ã€‚å…¬å…±ç½‘ç»œå·²è¿æ¥åˆ°Internetã€‚</li>
<li>ç«¯å£å°†æœåŠ¡å™¨è¿æ¥åˆ°ç½‘ç»œã€‚</li>
</ul>
<p>æ‰€æœ‰æœåŠ¡å™¨ï¼Œç½‘ç»œå’Œç«¯å£å‡ç”±è„šæœ¬è®¾ç½®ã€‚è¯¥è„šæœ¬æ¥æ”¶ç³»ç»Ÿçš„JSONè¡¨ç¤ºä½œä¸ºè¾“å…¥ï¼š</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;servers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;app&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;https&quot;</span><span class="punctuation">,</span> <span class="string">&quot;ssh&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;p1&quot;</span><span class="punctuation">,</span> <span class="string">&quot;p2&quot;</span><span class="punctuation">,</span> <span class="string">&quot;p3&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;db&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;mysql&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;p3&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cache&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;memcache&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;p3&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ci&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;http&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;p1&quot;</span><span class="punctuation">,</span> <span class="string">&quot;p2&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;busybox&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;telnet&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;p1&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;networks&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net1&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;public&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net2&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;public&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net3&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;public&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net4&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;public&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;p1&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net1&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;p2&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net3&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;p3&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net2&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>å½“å¤©æ—©äº›æ—¶å€™ï¼Œæ‚¨çš„è€æ¿å‘Šè¯‰æ‚¨å¿…é¡»å®æ–½çš„æ–°å®‰å…¨ç­–ç•¥ï¼š</p>
<p>Servers reachable from the Internet must not expose the insecure â€˜httpâ€™ protocol.<br>ä»Internetå¯è®¿é—®çš„æœåŠ¡å™¨ä¸èƒ½æš´éœ²ä¸å®‰å…¨çš„â€œhttpâ€åè®®ã€‚<br>Servers are not allowed to expose the â€˜telnetâ€™ protocol.<br>æœåŠ¡å™¨ä¸å…è®¸å…¬å¼€â€™telnetâ€™åè®®<br>é…ç½®äº†æœåŠ¡å™¨ï¼Œç½‘ç»œå’Œç«¯å£å¹¶ä¸”åˆè§„å›¢é˜Ÿå¸Œæœ›å®šæœŸå®¡æ ¸ç³»ç»Ÿä»¥æŸ¥æ‰¾è¿åç­–ç•¥çš„æœåŠ¡å™¨æ—¶ï¼Œå¿…é¡»æ‰§è¡Œè¯¥ç­–ç•¥ã€‚</p>
<p>æ‚¨çš„è€æ¿å·²è¦æ±‚æ‚¨ç¡®å®šOPAæ˜¯å¦é€‚åˆå®æ–½è¯¥æ”¿ç­–ã€‚</p>
<h2 id="3-regoä»‹ç»"><a href="#3-regoä»‹ç»" class="headerlink" title="3.regoä»‹ç»"></a>3.regoä»‹ç»</h2><p>OPA ä¸­çš„ç­–ç•¥æ˜¯ä»¥ Rego è¿™ç§ DSL(Domain Specific Language) æ¥è¡¨ç¤ºçš„ã€‚</p>
<p>Rego å— Datalogï¼ˆ<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Datalog%EF%BC%89">https://en.wikipedia.org/wiki/Datalogï¼‰</a> çš„å¯å‘ï¼Œå¹¶ä¸”æ‰©å±•äº† Datalog å¯¹äºç»“æ„åŒ–æ–‡æ¡£æ¨¡å‹çš„æ”¯æŒï¼Œæ–¹ä¾¿ä»¥ JSON çš„æ–¹å¼å¯¹æ•°æ®è¿›è¡Œå¤„ç†ã€‚</p>
<p>Rego å…è®¸ç­–ç•¥åˆ¶å®šè€…å¯ä»¥ä¸“æ³¨äºè¿”å›å†…å®¹çš„æŸ¥è¯¢è€Œä¸æ˜¯å¦‚ä½•æ‰§è¡ŒæŸ¥è¯¢ã€‚åŒæ—¶ OPA ä¸­ä¹Ÿå†…ç½®äº†æ‰§è¡Œè§„åˆ™æ—¶çš„ä¼˜åŒ–ï¼Œç”¨æˆ·å¯ä»¥é»˜è®¤ä½¿ç”¨ã€‚</p>
<p>Rego å…è®¸æˆ‘ä»¬ä½¿ç”¨è§„åˆ™ï¼ˆif-thenï¼‰å°è£…å’Œé‡ç”¨é€»è¾‘ï¼Œè§„åˆ™å¯ä»¥æ˜¯å®Œæ•´çš„æˆ–è€…æ˜¯éƒ¨åˆ†çš„ã€‚</p>
<p>æ¯ä¸ªè§„åˆ™éƒ½æ˜¯ç”±å¤´éƒ¨å’Œä¸»ä½“ç»„æˆã€‚åœ¨ Rego ä¸­ï¼Œå¦‚æœè§„åˆ™ä¸»ä½“å¯¹äºæŸäº›å˜é‡èµ‹å€¼ä¸ºçœŸï¼Œé‚£ä¹ˆæˆ‘ä»¬è¯´è§„åˆ™å¤´ä¸ºçœŸã€‚å¯ä»¥é€šè¿‡ç»å¯¹è·¯å¾„å¼•ç”¨ä»»ä½•åŠ è½½åˆ° OPA ä¸­çš„è§„åˆ™æ¥æŸ¥è¯¢å®ƒçš„å€¼ã€‚è§„åˆ™çš„è·¯å¾„æ€»æ˜¯ï¼šdataâ€¦ï¼ˆè§„åˆ™ç”Ÿæˆçš„æ‰€æœ‰å€¼éƒ½å¯ä»¥é€šè¿‡å…¨å±€ data å˜é‡è¿›è¡ŒæŸ¥è¯¢ã€‚ä¾‹å¦‚ï¼Œä¸‹æ–¹ç¤ºä¾‹ä¸­çš„ data.example.rules.any_public_networks</p>
<p>å®Œæ•´è§„åˆ™æ˜¯å°†å•ä¸ªå€¼åˆ†é…ç»™å˜é‡çš„ if-then è¯­å¥ã€‚</p>
<p>éƒ¨åˆ†è§„åˆ™æ˜¯ç”Ÿæˆä¸€ç»„å€¼å¹¶å°†è¯¥ç»„åˆ†é…ç»™å˜é‡çš„ if-then è¯­å¥</p>
<p>é€»è¾‘æˆ–æ˜¯è¦åœ¨ Rego ä¸­å®šä¹‰å¤šä¸ªå…·æœ‰ç›¸åŒåç§°çš„è§„åˆ™ã€‚ï¼ˆæŸ¥è¯¢ä¸­å°†å¤šä¸ªè¡¨è¾¾å¼è¿æ¥åœ¨ä¸€èµ·æ—¶ï¼Œè¡¨ç¤ºçš„æ˜¯é€»è¾‘ ANDï¼‰</p>
<h2 id="4-OPA-å®‰è£…"><a href="#4-OPA-å®‰è£…" class="headerlink" title="4.OPA å®‰è£…"></a>4.OPA å®‰è£…</h2><p>æœ¬èŠ‚è¯´æ˜å¦‚ä½•ç›´æ¥æŸ¥è¯¢OPAå¹¶åœ¨è‡ªå·±çš„è®¡ç®—æœºä¸Šä¸å…¶äº¤äº’ã€‚</p>
<p>1.ä¸‹è½½OPA<br>è¦å¼€å§‹ä»GitHubç‰ˆæœ¬ä¸‹è½½é€‚ç”¨äºæ‚¨å¹³å°çš„OPAäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè¯·æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p>
<p>åœ¨macOSï¼ˆ64ä½ï¼‰ä¸Šï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -L -o opa https://openpolicyagent.org/downloads/v0.28.0/opa_darwin_amd64</span><br></pre></td></tr></table></figure>

<p>åœ¨Linuxï¼ˆ64ä½ï¼‰ä¸Šï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">curl -L -o opa https://openpolicyagent.org/downloads/v0.28.0/opa_linux_amd64</span><br><span class="line">chmod 755 ./opa</span><br><span class="line">cp opa /usr/local/bin/</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">opa version</span></span><br><span class="line">Version: 0.35.0</span><br><span class="line">Build Commit: a54537a</span><br><span class="line">Build Timestamp: 2021-12-01T02:11:47Z</span><br><span class="line">Build Hostname: 9e4cf671a460</span><br><span class="line">Go Version: go1.17.3</span><br><span class="line">WebAssembly: unavailable</span><br></pre></td></tr></table></figure>

<p>å®¹å™¨</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker run --<span class="built_in">rm</span>  openpolicyagent/opa:0.35.0 version</span>    </span><br><span class="line">Version: 0.35.0</span><br><span class="line">Build Commit: a54537a</span><br><span class="line">Build Timestamp: 2021-12-01T02:10:31Z</span><br><span class="line">Build Hostname: 4ee9b086e5de</span><br><span class="line">Go Version: go1.17.3</span><br><span class="line">WebAssembly: available</span><br></pre></td></tr></table></figure>



<h2 id="5-OPA-è¿è¡Œ"><a href="#5-OPA-è¿è¡Œ" class="headerlink" title="5.OPA è¿è¡Œ"></a>5.OPA è¿è¡Œ</h2><p>ä¸OPAäº¤äº’çš„æœ€ç®€å•æ–¹æ³•æ˜¯é€šè¿‡å‘½ä»¤è¡Œä½¿ç”¨opa evalå­å‘½ä»¤ã€‚opa evalæ˜¯ä¸€æŠŠç‘å£«å†›åˆ€ï¼Œå¯ç”¨äºè¯„ä¼°ä»»æ„çš„Regoè¡¨è¾¾å¼å’Œç­–ç•¥ã€‚opa evalæ”¯æŒå¤§é‡ç”¨äºæ§åˆ¶è¯„ä¼°çš„é€‰é¡¹ã€‚å¸¸ç”¨æ ‡å¿—åŒ…æ‹¬ï¼š</p>
<ul>
<li>â€“bundle -b å°†æ†ç»‘åŒ…æ–‡ä»¶æˆ–ç›®å½•åŠ è½½åˆ°OPAä¸­ã€‚è¯¥æ ‡å¿—å¯ä»¥é‡å¤ã€‚</li>
<li>â€“data -d å°†ç­–ç•¥æˆ–æ•°æ®æ–‡ä»¶åŠ è½½åˆ°OPAä¸­ã€‚è¯¥æ ‡å¿—å¯ä»¥é‡å¤ã€‚</li>
<li>â€“input -i åŠ è½½æ•°æ®æ–‡ä»¶å¹¶å°†å…¶ç”¨ä½œinputã€‚è¯¥æ ‡å¿—ä¸èƒ½é‡å¤ã€‚</li>
<li>â€“format -f è®¾ç½®è¦ä½¿ç”¨çš„è¾“å‡ºæ ¼å¼ã€‚é»˜è®¤å€¼ä¸ºjsonï¼Œå¹¶ä¸”æ—¨åœ¨ç”¨äºç¨‹åºè®¾è®¡ã€‚è¯¥prettyæ ¼å¼å‘å‡ºäº†æ›´å¤šäººç±»å¯è¯»çš„è¾“å‡ºã€‚</li>
<li>â€“fail ä¸é€‚ç”¨ å¦‚æœæŸ¥è¯¢æœªå®šä¹‰ï¼Œåˆ™ä»¥éé›¶çš„é€€å‡ºä»£ç é€€å‡ºã€‚</li>
<li>â€“fail-defined ä¸é€‚ç”¨ å¦‚æœæŸ¥è¯¢ä¸æ˜¯æœªå®šä¹‰çš„ï¼Œåˆ™ä»¥éé›¶çš„é€€å‡ºä»£ç é€€å‡ºã€‚</li>
</ul>
<p>ä¾‹å¦‚ï¼š</p>
<p>input.jsonï¼š</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;servers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;app&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;https&quot;</span><span class="punctuation">,</span> <span class="string">&quot;ssh&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;p1&quot;</span><span class="punctuation">,</span> <span class="string">&quot;p2&quot;</span><span class="punctuation">,</span> <span class="string">&quot;p3&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;db&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;mysql&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;p3&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cache&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;memcache&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;p3&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ci&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;http&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;p1&quot;</span><span class="punctuation">,</span> <span class="string">&quot;p2&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;busybox&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;telnet&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;p1&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;networks&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net1&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;public&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net2&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;public&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net3&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;public&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net4&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;public&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;p1&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net1&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;p2&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net3&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;p3&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net2&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>example.rego:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">package example</span><br><span class="line"></span><br><span class="line">default allow = false                               # unless otherwise defined, allow is false</span><br><span class="line"></span><br><span class="line">allow = true &#123;                                      # allow is true if...</span><br><span class="line">    count(violation) == 0                           # there are zero violations.</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">violation[server.id] &#123;                              # a server is in the violation set if...</span><br><span class="line">    some server</span><br><span class="line">    public_server[server]                           # it exists in the &#x27;public_server&#x27; set and...</span><br><span class="line">    server.protocols[_] == &quot;http&quot;                   # it contains the insecure &quot;http&quot; protocol.</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">violation[server.id] &#123;                              # a server is in the violation set if...</span><br><span class="line">    server := input.servers[_]                      # it exists in the input.servers collection and...</span><br><span class="line">    server.protocols[_] == &quot;telnet&quot;                 # it contains the &quot;telnet&quot; protocol.</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public_server[server] &#123;                             # a server exists in the public_server set if...</span><br><span class="line">    some i, j</span><br><span class="line">    server := input.servers[_]                      # it exists in the input.servers collection and...</span><br><span class="line">    server.ports[_] == input.ports[i].id            # it references a port in the input.ports collection and...</span><br><span class="line">    input.ports[i].network == input.networks[j].id  # the port references a network in the input.networks collection and...</span><br><span class="line">    input.networks[j].public                        # the network is public.</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">root@master:~/cks/opa# ./opa eval &quot;1*2+3&quot;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;result&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;expressions&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;value&quot;: 5,</span><br><span class="line">          &quot;text&quot;: &quot;1*2+3&quot;,</span><br><span class="line">          &quot;location&quot;: &#123;</span><br><span class="line">            &quot;row&quot;: 1,</span><br><span class="line">            &quot;col&quot;: 1</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">root@master:~/cks/opa# ./opa eval -i input.json -d example.rego &quot;data.example.violation[x]&quot;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;result&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;expressions&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;value&quot;: &quot;ci&quot;,</span><br><span class="line">          &quot;text&quot;: &quot;data.example.violation[x]&quot;,</span><br><span class="line">          &quot;location&quot;: &#123;</span><br><span class="line">            &quot;row&quot;: 1,</span><br><span class="line">            &quot;col&quot;: 1</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      &quot;bindings&quot;: &#123;</span><br><span class="line">        &quot;x&quot;: &quot;ci&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;expressions&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;value&quot;: &quot;busybox&quot;,</span><br><span class="line">          &quot;text&quot;: &quot;data.example.violation[x]&quot;,</span><br><span class="line">          &quot;location&quot;: &#123;</span><br><span class="line">            &quot;row&quot;: 1,</span><br><span class="line">            &quot;col&quot;: 1</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      &quot;bindings&quot;: &#123;</span><br><span class="line">        &quot;x&quot;: &quot;busybox&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">root@master:~/cks/opa# ./opa eval --fail-defined -i input.json -d example.rego &quot;data.example.violation[x]&quot;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;result&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;expressions&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;value&quot;: &quot;ci&quot;,</span><br><span class="line">          &quot;text&quot;: &quot;data.example.violation[x]&quot;,</span><br><span class="line">          &quot;location&quot;: &#123;</span><br><span class="line">            &quot;row&quot;: 1,</span><br><span class="line">            &quot;col&quot;: 1</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      &quot;bindings&quot;: &#123;</span><br><span class="line">        &quot;x&quot;: &quot;ci&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;expressions&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;value&quot;: &quot;busybox&quot;,</span><br><span class="line">          &quot;text&quot;: &quot;data.example.violation[x]&quot;,</span><br><span class="line">          &quot;location&quot;: &#123;</span><br><span class="line">            &quot;row&quot;: 1,</span><br><span class="line">            &quot;col&quot;: 1</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      &quot;bindings&quot;: &#123;</span><br><span class="line">        &quot;x&quot;: &quot;busybox&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="6-OPA-runï¼ˆäº’åŠ¨å¼ï¼‰"><a href="#6-OPA-runï¼ˆäº’åŠ¨å¼ï¼‰" class="headerlink" title="6.OPA runï¼ˆäº’åŠ¨å¼ï¼‰"></a>6.OPA runï¼ˆäº’åŠ¨å¼ï¼‰</h2><p>OPAåŒ…æ‹¬ä¸€ä¸ªäº¤äº’å¼å¤–å£³ç¨‹åºæˆ–REPLï¼ˆè¯»å–-è¯„ä¼°-æ‰“å°å¾ªç¯ï¼‰ã€‚æ‚¨å¯ä»¥ä½¿ç”¨REPLæ¥è¯•éªŒç­–ç•¥å¹¶ä¸ºæ–°ç­–ç•¥åˆ›å»ºåŸå‹ã€‚</p>
<p>è¦å¯åŠ¨REPLï¼Œåªéœ€ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./opa run</span><br></pre></td></tr></table></figure>

<p>å½“æ‚¨åœ¨REPLä¸­è¾“å…¥è¯­å¥æ—¶ï¼ŒOPAä¼šå¯¹å®ƒä»¬è¿›è¡Œè¯„ä¼°å¹¶æ‰“å°ç»“æœã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; true</span><br><span class="line">true</span><br><span class="line">&gt; 3.14</span><br><span class="line">3.14</span><br><span class="line">&gt; [&quot;hello&quot;, &quot;world&quot;]</span><br><span class="line">[</span><br><span class="line">&quot;hello&quot;,</span><br><span class="line">&quot;world&quot;</span><br></pre></td></tr></table></figure>

<p>å¤§å¤šæ•°REPLå…è®¸æ‚¨å®šä¹‰ä»¥åå¯ä»¥å¼•ç”¨çš„å˜é‡ã€‚OPAå…è®¸æ‚¨æ‰§è¡Œç±»ä¼¼çš„æ“ä½œã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥å®šä¹‰ä¸€ä¸ªpiå¸¸é‡ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; pi := 3.14</span><br></pre></td></tr></table></figure>

<p>å®šä¹‰â€œ piâ€åï¼Œæ‚¨å°†æŸ¥è¯¢è¯¥å€¼å¹¶æ ¹æ®è¯¥å€¼ç¼–å†™è¡¨è¾¾å¼ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; pi</span><br><span class="line">3.14</span><br><span class="line">&gt; pi &gt; 3</span><br><span class="line">true</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡æŒ‰Control-Dæˆ–é”®å…¥exitä»¥ä¸‹å‘½ä»¤é€€å‡ºREPL ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exit</span><br></pre></td></tr></table></figure>

<p>æ‚¨å¯ä»¥é€šè¿‡åœ¨å‘½ä»¤è¡Œä¸Šä¼ é€’ç­–ç•¥å’Œæ•°æ®æ–‡ä»¶æ¥å°†å®ƒä»¬åŠ è½½åˆ°REPLä¸­ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒJSONå’ŒYAMLæ–‡ä»¶æ¤äºä¸‹dataã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">opa run input.json</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œä¸€äº›æŸ¥è¯¢ä»¥æŸ¥æ‰¾æ•°æ®ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">data.server[0].protocols[1]</span><br><span class="line">undefined</span><br><span class="line">data.servers[0].protocols[1]</span><br><span class="line">&quot;ssh&quot;</span><br><span class="line">data.servers[i].protocols[j]</span><br><span class="line">+---+---+------------------------------+</span><br><span class="line">| i | j | data.servers[i].protocols[j] |</span><br><span class="line">+---+---+------------------------------+</span><br><span class="line">| 0 | 0 | &quot;https&quot;                      |</span><br><span class="line">| 0 | 1 | &quot;ssh&quot;                        |</span><br><span class="line">| 1 | 0 | &quot;mysql&quot;                      |</span><br><span class="line">| 2 | 0 | &quot;memcache&quot;                   |</span><br><span class="line">| 3 | 0 | &quot;http&quot;                       |</span><br><span class="line">| 4 | 0 | &quot;telnet&quot;                     |</span><br><span class="line">+---+---+------------------------------+</span><br><span class="line">net := data.networks[_]; net.public</span><br><span class="line">+-----------------------------+</span><br><span class="line">|             net             |</span><br><span class="line">+-----------------------------+</span><br><span class="line">| &#123;&quot;id&quot;:&quot;net3&quot;,&quot;public&quot;:true&#125; |</span><br><span class="line">| &#123;&quot;id&quot;:&quot;net4&quot;,&quot;public&quot;:true&#125; |</span><br><span class="line">+-----------------------------+</span><br></pre></td></tr></table></figure>

<p>è¦å°†æ•°æ®æ–‡ä»¶è®¾ç½®ä¸ºinputREPLä¸­çš„æ–‡æ¡£ï¼Œè¯·åœ¨æ–‡ä»¶è·¯å¾„å‰æ·»åŠ å‰ç¼€ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">opa run example.rego repl.input:input.json</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">data.example.public_server[s]</span><br><span class="line">+-------------------------------------------------------------------+-------------------------------------------------------------------+</span><br><span class="line">|                                 s                                 |                   data.example.public_server[s]                   |</span><br><span class="line">+-------------------------------------------------------------------+-------------------------------------------------------------------+</span><br><span class="line">| &#123;&quot;id&quot;:&quot;app&quot;,&quot;ports&quot;:[&quot;p1&quot;,&quot;p2&quot;,&quot;p3&quot;],&quot;protocols&quot;:[&quot;https&quot;,&quot;ssh&quot;]&#125; | &#123;&quot;id&quot;:&quot;app&quot;,&quot;ports&quot;:[&quot;p1&quot;,&quot;p2&quot;,&quot;p3&quot;],&quot;protocols&quot;:[&quot;https&quot;,&quot;ssh&quot;]&#125; |</span><br><span class="line">| &#123;&quot;id&quot;:&quot;ci&quot;,&quot;ports&quot;:[&quot;p1&quot;,&quot;p2&quot;],&quot;protocols&quot;:[&quot;http&quot;]&#125;              | &#123;&quot;id&quot;:&quot;ci&quot;,&quot;ports&quot;:[&quot;p1&quot;,&quot;p2&quot;],&quot;protocols&quot;:[&quot;http&quot;]&#125;              |</span><br><span class="line">+-------------------------------------------------------------------+-------------------------------------------------------------------+</span><br></pre></td></tr></table></figure>



<h2 id="7-OPA-runï¼ˆæœåŠ¡å™¨ï¼‰"><a href="#7-OPA-runï¼ˆæœåŠ¡å™¨ï¼‰" class="headerlink" title="7.OPA runï¼ˆæœåŠ¡å™¨ï¼‰"></a>7.OPA runï¼ˆæœåŠ¡å™¨ï¼‰</h2><p>è¦ä¸OPAé›†æˆï¼Œæ‚¨å¯ä»¥å°†å…¶ä½œä¸ºæœåŠ¡å™¨è¿è¡Œå¹¶é€šè¿‡HTTPæ‰§è¡ŒæŸ¥è¯¢ã€‚æ‚¨å¯ä»¥ä½¿ç”¨-sæˆ–å°†OPAä½œä¸ºæœåŠ¡å™¨å¯åŠ¨--serverï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./opa run --server ./example.rego</span><br></pre></td></tr></table></figure>

<p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒOPAåœ¨ä¸Šä¾¦å¬HTTPè¿æ¥0.0.0.0:8181ã€‚è¯·å‚é˜…å‚è€ƒèµ„æ–™opa run --helpï¼Œä»¥è·å–ç”¨äºæ›´æ”¹ä¾¦å¬åœ°å€ï¼Œå¯ç”¨TLSç­‰çš„é€‰é¡¹çš„åˆ—è¡¨ã€‚</p>
<p>åœ¨å¦ä¸€ä¸ªç»ˆç«¯å†…éƒ¨ä½¿ç”¨curlï¼ˆæˆ–ç±»ä¼¼çš„å·¥å…·ï¼‰æ¥è®¿é—®OPAçš„HTTP APIã€‚æŸ¥è¯¢&#x2F;v1&#x2F;dataHTTP APIæ—¶ï¼Œå¿…é¡»å°†è¾“å…¥æ•°æ®åŒ…è£…åœ¨JSONå¯¹è±¡å†…ï¼š</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span> &lt;value&gt;</span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºè¾“å…¥æ–‡ä»¶çš„å‰¯æœ¬ï¼Œä»¥é€šè¿‡å‘é€curlï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; v1-data-input.json</span><br><span class="line">&#123;</span><br><span class="line">    &quot;input&quot;: $(cat input.json)</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œä¸€äº›curlè¯·æ±‚å¹¶æ£€æŸ¥è¾“å‡ºï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl localhost:8181/v1/data/example/violation -d @v1-data-input.json -H &#x27;Content-Type: application/json&#x27;</span><br><span class="line">curl localhost:8181/v1/data/example/allow -d @v1-data-input.json -H &#x27;Content-Type: application/json&#x27;</span><br></pre></td></tr></table></figure>

<p>é»˜è®¤æƒ…å†µä¸‹data.system.mainï¼Œç”¨äºä¸å¸¦è·¯å¾„çš„ç­–ç•¥æŸ¥è¯¢ã€‚å½“æ‚¨åœ¨ä¸æä¾›è·¯å¾„çš„æƒ…å†µä¸‹æ‰§è¡ŒæŸ¥è¯¢æ—¶ï¼Œä¸å¿…åŒ…è£…è¾“å…¥ã€‚å¦‚æœè¯¥data.system.mainå†³å®šæœªå®šä¹‰ï¼Œåˆ™å°†å…¶è§†ä¸ºé”™è¯¯ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl localhost:8181 -i -d @input.json -H &#x27;Content-Type: application/json&#x27;</span><br></pre></td></tr></table></figure>

<p>æ‚¨å¯ä»¥é‡æ–°å¯åŠ¨OPAå¹¶å°†å…¶é…ç½®ä¸ºä½¿ç”¨ä»»ä½•å†³ç­–ä½œä¸ºé»˜è®¤å†³ç­–ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./opa run --server --set=default_decision=example/allow ./example.rego</span><br></pre></td></tr></table></figure>

<p>curlä»ä¸Šé¢é‡æ–°è¿è¡Œæœ€åä¸€ä¸ªå‘½ä»¤ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl localhost:8181 -i -d @input.json -H &#x27;Content-Type: application/json&#x27;</span><br></pre></td></tr></table></figure>



<h2 id="8-Rego-è¯­æ³•"><a href="#8-Rego-è¯­æ³•" class="headerlink" title="8.Rego è¯­æ³•"></a>8.Rego è¯­æ³•</h2><p>OPAç­–ç•¥ä»¥ç§°ä¸ºRegoçš„é«˜çº§å£°æ˜æ€§è¯­è¨€è¡¨ç¤ºã€‚Regoï¼ˆå‘éŸ³ä¸ºâ€œ ray-goâ€ï¼‰æ˜¯ä¸“é—¨ä¸ºåœ¨å¤æ‚çš„åˆ†å±‚æ•°æ®ç»“æ„ä¸Šè¡¨è¾¾ç­–ç•¥è€Œæ„å»ºçš„ã€‚æœ‰å…³Regoçš„è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…ç­–ç•¥è¯­è¨€æ–‡æ¡£ã€‚</p>
<p>belowä»¥ä¸‹ç¤ºä¾‹æ˜¯äº¤äº’å¼çš„ï¼å¦‚æœåœ¨åŒ…å«æœåŠ¡å™¨ï¼Œç½‘ç»œå’Œç«¯å£çš„ä¸Šæ–¹ç¼–è¾‘è¾“å…¥æ•°æ®ï¼Œåˆ™è¾“å‡ºå°†åœ¨ä¸‹é¢æ›´æ”¹ã€‚åŒæ ·ï¼Œå¦‚æœæ‚¨åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ç¼–è¾‘æŸ¥è¯¢æˆ–è§„åˆ™ï¼Œåˆ™è¾“å‡ºå°†æ›´æ”¹ã€‚åœ¨é€šè¯»æœ¬èŠ‚æ—¶ï¼Œè¯·å°è¯•æ›´æ”¹è¾“å…¥ï¼ŒæŸ¥è¯¢å’Œè§„åˆ™ï¼Œå¹¶è§‚å¯Ÿè¾“å‡ºçš„å·®å¼‚ã€‚</p>
<p>ğŸ’»ä¹Ÿå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åœ¨æ‚¨çš„è®¡ç®—æœºä¸Šæœ¬åœ°è¿è¡Œå®ƒä»¬opa evalï¼Œè¿™æ˜¯è®¾ç½®è¯´æ˜ã€‚</p>
<h3 id="8-1-å‚è€ƒ"><a href="#8-1-å‚è€ƒ" class="headerlink" title="8.1 å‚è€ƒ"></a>8.1 å‚è€ƒ</h3><p>å½“OPAè¯„ä¼°ç­–ç•¥æ—¶ï¼Œå®ƒå°†æŸ¥è¯¢ä¸­æä¾›çš„æ•°æ®ç»‘å®šåˆ°åä¸ºçš„å…¨å±€å˜é‡inputã€‚æ‚¨å¯ä»¥ä½¿ç”¨.ï¼ˆç‚¹ï¼‰è¿ç®—ç¬¦åœ¨è¾“å…¥ä¸­å¼•ç”¨æ•°æ®ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">input.servers</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;app&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;p1&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;p2&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;p3&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;https&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;ssh&quot;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;db&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;p3&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;mysql&quot;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cache&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;p3&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;memcache&quot;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ci&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;p1&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;p2&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;http&quot;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;busybox&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;p1&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;telnet&quot;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<p>è¦å¼•ç”¨æ•°ç»„å…ƒç´ ï¼Œå¯ä»¥ä½¿ç”¨ç†Ÿæ‚‰çš„æ–¹æ‹¬å·è¯­æ³•ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">input.servers[0].protocols[0]</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;https&quot;</span><br></pre></td></tr></table></figure>

<p>keyså¦‚æœé”®åŒ…å«ä»¥å¤–çš„å…¶ä»–å­—ç¬¦ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ç›¸åŒçš„æ–¹æ‹¬å·è¯­æ³• [a-zA-Z0-9_]ã€‚ä¾‹å¦‚input[â€œfoo~barâ€]ã€‚</p>
<p>å¦‚æœå¼•ç”¨çš„å€¼ä¸å­˜åœ¨ï¼Œåˆ™OPAè¿”å›undefinedã€‚æœªå®šä¹‰è¡¨ç¤ºOPAæ— æ³•æ‰¾åˆ°ä»»ä½•ç»“æœã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">input.deadbeef</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">undefined decision</span><br></pre></td></tr></table></figure>

<h3 id="8-2-è¡¨è¾¾å¼ï¼ˆé€»è¾‘ä¸ï¼‰"><a href="#8-2-è¡¨è¾¾å¼ï¼ˆé€»è¾‘ä¸ï¼‰" class="headerlink" title="8.2 è¡¨è¾¾å¼ï¼ˆé€»è¾‘ä¸ï¼‰"></a>8.2 è¡¨è¾¾å¼ï¼ˆé€»è¾‘ä¸ï¼‰</h3><p>è¦åœ¨Regoä¸­åˆ¶å®šæ”¿ç­–å†³ç­–ï¼Œæ‚¨è¦é’ˆå¯¹è¾“å…¥å’Œå…¶ä»–æ•°æ®ç¼–å†™è¡¨è¾¾å¼ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">input.servers[0].id == &quot;app&quot;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">true</span><br></pre></td></tr></table></figure>

<p>OPAåŒ…æ‹¬ä¸€ç»„å†…ç½®å‡½æ•°ï¼Œå¯ç”¨äºæ‰§è¡Œå¸¸è§æ“ä½œï¼Œä¾‹å¦‚å­—ç¬¦ä¸²æ“ä½œï¼Œæ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ï¼Œç®—æœ¯ï¼Œèšåˆç­‰ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">count(input.servers[0].protocols) &gt;= 1</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">true</span><br></pre></td></tr></table></figure>

<p>æœ‰å…³ç°æˆçš„OPAæ”¯æŒçš„å†…ç½®åŠŸèƒ½çš„å®Œæ•´åˆ—è¡¨ï¼Œè¯·å‚é˜…â€œç­–ç•¥å‚è€ƒâ€é¡µé¢ã€‚</p>
<p>å¤šä¸ªè¡¨è¾¾å¼é€šè¿‡;ï¼ˆANDï¼‰è¿ç®—ç¬¦è¿æ¥åœ¨ä¸€èµ·ã€‚ä¸ºäº†ä½¿æŸ¥è¯¢äº§ç”Ÿç»“æœï¼ŒæŸ¥è¯¢ä¸­çš„æ‰€æœ‰è¡¨è¾¾å¼å¿…é¡»ä¸ºçœŸæˆ–å·²å®šä¹‰ã€‚è¡¨è¾¾å¼çš„é¡ºåºæ— å…³ç´§è¦ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">input.servers[0].id == &quot;app&quot;; input.servers[0].protocols[0] == &quot;https&quot;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">true</span><br></pre></td></tr></table></figure>

<p>æ‚¨å¯ä»¥;é€šè¿‡å°†è¡¨è¾¾å¼åˆ†æˆå¤šè¡Œæ¥çœç•¥ï¼ˆANDï¼‰è¿ç®—ç¬¦ã€‚ä»¥ä¸‹æŸ¥è¯¢ä¸ä¸Šä¸€ä¸ªæŸ¥è¯¢å…·æœ‰ç›¸åŒçš„å«ä¹‰ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">input.servers[0].id == &quot;app&quot;</span><br><span class="line">input.servers[0].protocols[0] == &quot;https&quot;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">true</span><br></pre></td></tr></table></figure>

<p>å¦‚æœæŸ¥è¯¢ä¸­çš„ä»»ä½•è¡¨è¾¾å¼éƒ½ä¸ä¸ºçœŸï¼ˆæˆ–æœªå®šä¹‰ï¼‰ï¼Œåˆ™ç»“æœä¸ºæœªå®šä¹‰ã€‚åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œç¬¬äºŒä¸ªè¡¨è¾¾å¼ä¸ºfalseï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">input.servers[0].id == &quot;app&quot;</span><br><span class="line">input.servers[0].protocols[0] == &quot;telnet&quot;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">undefined decision</span><br></pre></td></tr></table></figure>

<h3 id="8-3-é€»è¾‘æˆ–"><a href="#8-3-é€»è¾‘æˆ–" class="headerlink" title="8.3 é€»è¾‘æˆ–"></a>8.3 é€»è¾‘æˆ–</h3><p>åœ¨æŸ¥è¯¢ä¸­å°†å¤šä¸ªè¡¨è¾¾å¼è¿æ¥åœ¨ä¸€èµ·æ—¶ï¼Œæ‚¨è¡¨ç¤ºçš„æ˜¯é€»è¾‘ä¸ã€‚è¦åœ¨Regoä¸­è¡¨è¾¾é€»è¾‘ORï¼Œæ‚¨å¯ä»¥å®šä¹‰å¤šä¸ªå…·æœ‰ç›¸åŒåç§°çš„è§„åˆ™ã€‚è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ã€‚</p>
<p>æƒ³è±¡ä¸€ä¸‹ï¼Œæ‚¨æƒ³çŸ¥é“æ˜¯å¦æœ‰ä»»ä½•æœåŠ¡å™¨å…¬å¼€å…è®¸å®¢æˆ·ç«¯å¤–å£³è®¿é—®çš„åè®®ã€‚ä¸ºäº†ç¡®å®šè¿™ä¸€ç‚¹ï¼Œä½ å¯ä»¥å®šä¹‰å£°æ˜äº†ä¸€ä¸ªå®Œæ•´çš„è§„åˆ™ shell_accessibleæ˜¯trueï¼Œå¦‚æœä»»ä½•æœåŠ¡å™¨æš´éœ²&quot;telnetâ€œæˆ–â€ssh&quot; åè®®ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">package example.logical_or</span><br><span class="line"></span><br><span class="line">default shell_accessible = false</span><br><span class="line"></span><br><span class="line">shell_accessible = true &#123;</span><br><span class="line">    input.servers[_].protocols[_] == &quot;telnet&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">shell_accessible = true &#123;</span><br><span class="line">    input.servers[_].protocols[_] == &quot;ssh&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;servers&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;id&quot;: &quot;busybox&quot;,</span><br><span class="line">            &quot;protocols&quot;: [&quot;http&quot;, &quot;telnet&quot;]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;id&quot;: &quot;web&quot;,</span><br><span class="line">            &quot;protocols&quot;: [&quot;https&quot;]</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">shell_accessible</span><br><span class="line"></span><br><span class="line">true</span><br></pre></td></tr></table></figure>

<p>defaultkeywordå¦‚æœæœªå®šä¹‰å…·æœ‰ç›¸åŒåç§°çš„æ‰€æœ‰å…¶ä»–è§„åˆ™ï¼Œåˆ™è¯¥å…³é”®å­—å‘Šè¯‰OPAä¸ºè¯¥å˜é‡åˆ†é…ä¸€ä¸ªå€¼ã€‚</p>
<p>å½“æ‚¨å°†é€»è¾‘æˆ–ä¸éƒ¨åˆ†è§„åˆ™ä¸€èµ·ä½¿ç”¨æ—¶ï¼Œæ¯ä¸ªè§„åˆ™å®šä¹‰éƒ½ä¼šå½±å“åˆ†é…ç»™å˜é‡çš„ä¸€ç»„å€¼ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥å°†ä¸Šé¢çš„ç¤ºä¾‹ä¿®æ”¹ä¸ºç”Ÿæˆä¸€ç»„å…¬å¼€&quot;telnet&quot;æˆ– çš„æœåŠ¡å™¨&quot;ssh&quot;ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">package example.logical_or</span><br><span class="line"></span><br><span class="line">shell_accessible[server.id] &#123;</span><br><span class="line">    server := input.servers[_]</span><br><span class="line">    server.protocols[_] == &quot;telnet&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">shell_accessible[server.id] &#123;</span><br><span class="line">    server := input.servers[_]</span><br><span class="line">    server.protocols[_] == &quot;ssh&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;servers&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;id&quot;: &quot;busybox&quot;,</span><br><span class="line">            &quot;protocols&quot;: [&quot;http&quot;, &quot;telnet&quot;]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;id&quot;: &quot;db&quot;,</span><br><span class="line">            &quot;protocols&quot;: [&quot;mysql&quot;, &quot;ssh&quot;]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;id&quot;: &quot;web&quot;,</span><br><span class="line">            &quot;protocols&quot;: [&quot;https&quot;]</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">shell_accessible</span><br><span class="line"></span><br><span class="line">[</span><br><span class="line">  &quot;busybox&quot;,</span><br><span class="line">  &quot;db&quot;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h3 id="8-4-Variableså˜é‡"><a href="#8-4-Variableså˜é‡" class="headerlink" title="8.4 Variableså˜é‡"></a>8.4 Variableså˜é‡</h3><p>æ‚¨å¯ä»¥ä½¿ç”¨:&#x3D;ï¼ˆèµ‹å€¼ï¼‰è¿ç®—ç¬¦å°†å€¼å­˜å‚¨åœ¨ä¸­é—´å˜é‡ä¸­ã€‚å¯ä»¥åƒä¸€æ ·å¼•ç”¨å˜é‡input</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">s := input.servers[0]</span><br><span class="line">s.id == &quot;app&quot;</span><br><span class="line">p := s.protocols[0]</span><br><span class="line">p == &quot;https&quot;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+---------+-------------------------------------------------------------------+</span><br><span class="line">|    p    |                                 s                                 |</span><br><span class="line">+---------+-------------------------------------------------------------------+</span><br><span class="line">| &quot;https&quot; | &#123;&quot;id&quot;:&quot;app&quot;,&quot;ports&quot;:[&quot;p1&quot;,&quot;p2&quot;,&quot;p3&quot;],&quot;protocols&quot;:[&quot;https&quot;,&quot;ssh&quot;]&#125; |</span><br><span class="line">+---------+-------------------------------------------------------------------+</span><br></pre></td></tr></table></figure>

<p>å½“OPAè¯„ä¼°è¡¨è¾¾å¼æ—¶ï¼Œå®ƒå°†æŸ¥æ‰¾ä½¿æ‰€æœ‰è¡¨è¾¾å¼éƒ½ä¸ºçœŸçš„å˜é‡çš„å€¼ã€‚å¦‚æœæ²¡æœ‰ä½¿æ‰€æœ‰è¡¨è¾¾å¼éƒ½ä¸ºçœŸçš„å˜é‡èµ‹å€¼ï¼Œåˆ™ç»“æœæ˜¯ä¸ç¡®å®šçš„ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">s := input.servers[0]</span><br><span class="line">s.id == &quot;app&quot;</span><br><span class="line">s.protocols[1] == &quot;telnet&quot;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">undefined decision</span><br></pre></td></tr></table></figure>

<p>å˜é‡æ˜¯ä¸å¯å˜çš„ã€‚å¦‚æœæ‚¨å°è¯•ä¸¤æ¬¡åˆ†é…ç›¸åŒçš„å˜é‡ï¼ŒOPAå°†æŠ¥å‘Šé”™è¯¯ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">s := input.servers[0]</span><br><span class="line">s := input.servers[1]</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1 error occurred: 2:1: rego_compile_error: var s assigned above</span><br></pre></td></tr></table></figure>

<p>OPAå¿…é¡»èƒ½å¤Ÿæšä¸¾æ‰€æœ‰è¡¨è¾¾å¼ä¸­æ‰€æœ‰å˜é‡çš„å€¼ã€‚å¦‚æœOPAæ— æ³•æšä¸¾ä»»ä½•è¡¨è¾¾å¼ä¸­å˜é‡çš„å€¼ï¼Œåˆ™OPAå°†æŠ¥å‘Šé”™è¯¯ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">x := 1</span><br><span class="line">x != y  # y has not been assigned a value</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">2 errors occurred:</span><br><span class="line">2:1: rego_unsafe_var_error: var _ is unsafe</span><br><span class="line">2:1: rego_unsafe_var_error: var y is unsafe</span><br></pre></td></tr></table></figure>

<h3 id="8-5-è¿­ä»£"><a href="#8-5-è¿­ä»£" class="headerlink" title="8.5 è¿­ä»£"></a>8.5 è¿­ä»£</h3><p>åƒå…¶ä»–å£°æ˜æ€§è¯­è¨€ï¼ˆä¾‹å¦‚SQLï¼‰ä¸€æ ·ï¼ŒRegoæ²¡æœ‰æ˜¾å¼çš„å¾ªç¯æˆ–è¿­ä»£æ„é€ ã€‚è€Œæ˜¯å°†å˜é‡æ³¨å…¥è¡¨è¾¾å¼ä¸­æ—¶ï¼Œéšå¼å‘ç”Ÿè¿­ä»£ã€‚</p>
<p>è¦äº†è§£Regoä¸­è¿­ä»£çš„å·¥ä½œåŸç†ï¼Œè¯·æƒ³è±¡æ‚¨éœ€è¦æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•å…¬å…±ç½‘ç»œã€‚å›æƒ³ä¸€ä¸‹ï¼Œç½‘ç»œæ˜¯åœ¨æ•°ç»„ä¸­æä¾›çš„ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">input.networks</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;id&quot;: &quot;net1&quot;,</span><br><span class="line">    &quot;public&quot;: false</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;id&quot;: &quot;net2&quot;,</span><br><span class="line">    &quot;public&quot;: false</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;id&quot;: &quot;net3&quot;,</span><br><span class="line">    &quot;public&quot;: true</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;id&quot;: &quot;net4&quot;,</span><br><span class="line">    &quot;public&quot;: true</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>ä¸€ç§é€‰æ‹©æ˜¯æµ‹è¯•è¾“å…¥ä¸­çš„æ¯ä¸ªç½‘ç»œï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">input.networks[0].public == true</span><br><span class="line">false</span><br><span class="line"></span><br><span class="line">input.networks[1].public == true</span><br><span class="line">false</span><br><span class="line"></span><br><span class="line">input.networks[2].public == true</span><br><span class="line">true</span><br></pre></td></tr></table></figure>

<p>è¿™ç§æ–¹æ³•æ˜¯æœ‰é—®é¢˜çš„ï¼Œå› ä¸ºå¯èƒ½æœ‰å¤ªå¤šç½‘ç»œæ— æ³•é™æ€åˆ—å‡ºï¼Œæˆ–æ›´é‡è¦çš„æ˜¯ï¼Œå¯èƒ½æ— æ³•äº‹å…ˆçŸ¥é“ç½‘ç»œçš„æ•°é‡ã€‚</p>
<p>åœ¨Regoä¸­ï¼Œè§£å†³æ–¹æ¡ˆæ˜¯å°†æ•°ç»„ç´¢å¼•æ›¿æ¢ä¸ºå˜é‡ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">some i; input.networks[i].public == true</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">+---+</span><br><span class="line">| i |</span><br><span class="line">+---+</span><br><span class="line">| 2 |</span><br><span class="line">| 3 |</span><br><span class="line">+---+</span><br></pre></td></tr></table></figure>

<p>ç°åœ¨ï¼ŒæŸ¥è¯¢å°†è¦æ±‚è¯¥å€¼iä½¿æ•´ä¸ªè¡¨è¾¾å¼ä¸ºçœŸã€‚å½“æ‚¨åœ¨å¼•ç”¨ä¸­æ›¿æ¢å˜é‡æ—¶ï¼ŒOPAä¼šè‡ªåŠ¨æŸ¥æ‰¾æ»¡è¶³æŸ¥è¯¢ä¸­æ‰€æœ‰è¡¨è¾¾å¼çš„å˜é‡åˆ†é…ã€‚å°±åƒä¸­é—´å˜é‡ä¸€æ ·ï¼ŒOPAè¿”å›å˜é‡çš„å€¼ã€‚</p>
<p>æ‚¨å¯ä»¥æ ¹æ®éœ€è¦æ›¿æ¢ä»»æ„å¤šä¸ªå˜é‡ã€‚ä¾‹å¦‚ï¼Œè¦ç¡®å®šæ˜¯å¦æœ‰æœåŠ¡å™¨å…¬å¼€äº†ä¸å®‰å…¨çš„&quot;http&quot;åè®®ï¼Œæ‚¨å¯ä»¥ç¼–å†™ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">some i, j; input.servers[i].protocols[j] == &quot;http&quot;</span><br><span class="line"></span><br><span class="line">+---+---+</span><br><span class="line">| i | j |</span><br><span class="line">+---+---+</span><br><span class="line">| 3 | 0 |</span><br><span class="line">+---+---+</span><br></pre></td></tr></table></figure>

<p>å¦‚æœå˜é‡å‡ºç°å¤šæ¬¡ï¼Œåˆ™åˆ†é…æ»¡è¶³æ‰€æœ‰è¡¨è¾¾å¼ã€‚ä¾‹å¦‚ï¼Œè¦æŸ¥æ‰¾è¿æ¥åˆ°å…¬å…±ç½‘ç»œçš„ç«¯å£çš„IDï¼Œå¯ä»¥ç¼–å†™ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">some i, j</span><br><span class="line">id := input.ports[i].id</span><br><span class="line">input.ports[i].network == input.networks[j].id</span><br><span class="line">input.networks[j].public</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+---+------+---+</span><br><span class="line">| i |  id  | j |</span><br><span class="line">+---+------+---+</span><br><span class="line">| 1 | &quot;p2&quot; | 2 |</span><br><span class="line">+---+------+---+</span><br></pre></td></tr></table></figure>

<p>ä¸ºå˜é‡æä¾›å¥½åå­—å¯èƒ½å¾ˆéš¾ã€‚å¦‚æœä»…å¼•ç”¨ä¸€æ¬¡å˜é‡ï¼Œåˆ™å¯ä»¥å°†å…¶æ›¿æ¢ä¸ºç‰¹æ®Šçš„_ï¼ˆé€šé…ç¬¦å˜é‡ï¼‰è¿ç®—ç¬¦ã€‚ä»æ¦‚å¿µä¸Šè®²ï¼Œçš„æ¯ä¸ªå®ä¾‹_éƒ½æ˜¯ä¸€ä¸ªå”¯ä¸€å˜é‡ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">input.servers[_].protocols[_] == &quot;http&quot;</span><br><span class="line">true</span><br></pre></td></tr></table></figure>

<p>å°±åƒå¼•ç”¨ä¸å­˜åœ¨çš„å­—æ®µæˆ–æ— æ³•åŒ¹é…çš„è¡¨è¾¾å¼çš„å¼•ç”¨ä¸€æ ·ï¼Œå¦‚æœOPAæ— æ³•æ‰¾åˆ°æ»¡è¶³æ‰€æœ‰è¡¨è¾¾å¼çš„ä»»ä½•å˜é‡èµ‹å€¼ï¼Œåˆ™ç»“æœæ˜¯ä¸ç¡®å®šçš„ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">some i; input.servers[i].protocols[i] == &quot;ssh&quot;  # there is no assignment of i that satisfies the expression</span><br><span class="line"></span><br><span class="line">undefined decision</span><br></pre></td></tr></table></figure>

<h3 id="8-6-è§„åˆ™"><a href="#8-6-è§„åˆ™" class="headerlink" title="8.6 è§„åˆ™"></a>8.6 è§„åˆ™</h3><p>Regoä½¿æ‚¨å¯ä»¥ä½¿ç”¨è§„åˆ™å°è£…å’Œé‡ç”¨é€»è¾‘ã€‚è§„åˆ™åªæ˜¯if-thené€»è¾‘è¯­å¥ã€‚è§„åˆ™å¯ä»¥æ˜¯â€œå®Œæ•´â€æˆ–â€œéƒ¨åˆ†â€ã€‚</p>
<h4 id="8-6-1-å®Œæ•´è§„åˆ™"><a href="#8-6-1-å®Œæ•´è§„åˆ™" class="headerlink" title="8.6.1 å®Œæ•´è§„åˆ™"></a>8.6.1 å®Œæ•´è§„åˆ™</h4><p>å®Œæ•´çš„è§„åˆ™æ˜¯if-thenè¯­å¥ï¼Œè¿™äº›è¯­å¥å°†å•ä¸ªå€¼åˆ†é…ç»™å˜é‡ã€‚ä¾‹å¦‚ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">package example.rules</span><br><span class="line"></span><br><span class="line">any_public_networks = true &#123;  # is true if...</span><br><span class="line">    net := input.networks[_]  # some network exists and..</span><br><span class="line">    net.public                # it is public.</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¯æ¡è§„åˆ™éƒ½ç”±ä¸€ä¸ªå¤´å’Œä¸€ä¸ªèº«ä½“ç»„æˆã€‚åœ¨Regoä¸­ï¼Œå¦‚æœè§„åˆ™ä¸»ä½“å¯¹äºæŸäº›å˜é‡åˆ†é…é›†ä¸ºtrueï¼Œåˆ™è¯´è§„åˆ™æ ‡é¢˜ä¸ºtrue ã€‚åœ¨ä¸Šé¢çš„ç¤ºä¾‹any_public_networks &#x3D; trueä¸­ï¼Œå¤´æ˜¯net :&#x3D; input.networks[_]; net.publicæ˜¯èº«ä½“ã€‚</p>
<p>æ‚¨å¯ä»¥æŸ¥è¯¢è§„åˆ™ç”Ÿæˆçš„å€¼ï¼Œå°±åƒå…¶ä»–ä»»ä½•å€¼ä¸€æ ·ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">any_public_networks</span><br><span class="line">true</span><br></pre></td></tr></table></figure>

<p>è§„åˆ™ç”Ÿæˆçš„æ‰€æœ‰å€¼éƒ½å¯ä»¥é€šè¿‡å…¨å±€dataå˜é‡æŸ¥è¯¢ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">data.example.rules.any_public_networks</span><br><span class="line">true</span><br></pre></td></tr></table></figure>

<p>æ‚¨å¯ä»¥é€šè¿‡ä½¿ç”¨ç»å¯¹è·¯å¾„å¼•ç”¨OPAåŠ è½½çš„ä»»ä½•è§„åˆ™æ¥æŸ¥è¯¢å…¶å€¼ã€‚è§„åˆ™çš„è·¯å¾„å§‹ç»ˆä¸ºï¼š<br>data.<package-path>.<rule-name>ã€‚</p>
<p>å¦‚æœæ‚¨çœç•¥&#x3D; <value>è§„åˆ™æ ‡é¢˜çš„ä¸€éƒ¨åˆ†ï¼Œåˆ™è¯¥å€¼é»˜è®¤ä¸ºtrueã€‚æ‚¨å¯ä»¥æŒ‰ä»¥ä¸‹æ–¹å¼é‡å†™ä¸Šé¢çš„ç¤ºä¾‹ï¼Œè€Œæ— éœ€æ›´æ”¹å…¶å«ä¹‰ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">package example.rules</span><br><span class="line"></span><br><span class="line">any_public_networks &#123;</span><br><span class="line">    net := input.networks[_]</span><br><span class="line">    net.public</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¦å®šä¹‰å¸¸é‡ï¼Œè¯·çœç•¥è§„åˆ™ä¸»ä½“ã€‚çœç•¥è§„åˆ™æ­£æ–‡æ—¶ï¼Œé»˜è®¤ä¸ºtrueã€‚ç”±äºè§„åˆ™ä¸»ä½“ä¸ºtrueï¼Œå› æ­¤è§„åˆ™æ ‡å¤´å§‹ç»ˆä¸ºtrue &#x2F; definedã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">package example.constants</span><br><span class="line"></span><br><span class="line">pi = 3.14</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥åƒå…¶ä»–ä»»ä½•å€¼ä¸€æ ·æŸ¥è¯¢è¿™æ ·å®šä¹‰çš„å¸¸é‡ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pi &gt; 3</span><br><span class="line"></span><br><span class="line">true</span><br></pre></td></tr></table></figure>

<p>å¦‚æœOPAæ— æ³•æ‰¾åˆ°æ»¡è¶³è§„åˆ™ä¸»ä½“çš„å˜é‡åˆ†é…ï¼Œåˆ™å¯ä»¥è¯´è¯¥è§„åˆ™æ˜¯æœªå®šä¹‰çš„ã€‚ä¾‹å¦‚ï¼Œå¦‚æœinputæä¾›ç»™OPAçš„ä¸åŒ…æ‹¬å…¬å…±ç½‘ç»œï¼Œany_public_networksåˆ™å°†æ˜¯æœªå®šä¹‰çš„ï¼ˆä¸falseç›¸åŒï¼‰ã€‚ä¸‹é¢ï¼Œä¸ºOPAæä¾›äº†ä¸€ç»„ä¸åŒçš„è¾“å…¥ç½‘ç»œï¼ˆéƒ½ä¸æ˜¯å…¬å…±çš„ï¼‰ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;networks&quot;: [</span><br><span class="line">        &#123;&quot;id&quot;: &quot;n1&quot;, &quot;public&quot;: false&#125;,</span><br><span class="line">        &#123;&quot;id&quot;: &quot;n2&quot;, &quot;public&quot;: false&#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">any_public_networks</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">undefined decision</span><br></pre></td></tr></table></figure>

<h4 id="8-6-2-éƒ¨åˆ†è§„åˆ™"><a href="#8-6-2-éƒ¨åˆ†è§„åˆ™" class="headerlink" title="8.6.2 éƒ¨åˆ†è§„åˆ™"></a>8.6.2 éƒ¨åˆ†è§„åˆ™</h4><p>éƒ¨åˆ†è§„åˆ™æ˜¯if-thenè¯­å¥ï¼Œå®ƒä»¬ç”Ÿæˆä¸€ç»„å€¼å¹¶å°†è¯¥ç»„å€¼åˆ†é…ç»™å˜é‡ã€‚ä¾‹å¦‚ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">package example.rules</span><br><span class="line"></span><br><span class="line">public_network[net.id] &#123;      # net.id is in the public_network set if...</span><br><span class="line">    net := input.networks[_]  # some network exists and...</span><br><span class="line">    net.public                # it is public.</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­public_network[net.id]æ˜¯è§„åˆ™å¤´ï¼Œå¹¶ä¸”net :&#x3D; input.networks[_]; net.publicæ˜¯è§„åˆ™ä¸»ä½“ã€‚æ‚¨å¯ä»¥åƒæŸ¥è¯¢å…¶ä»–ä»»ä½•å€¼ä¸€æ ·æŸ¥è¯¢æ•´ä¸ªå€¼é›†ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public_network</span><br><span class="line"></span><br><span class="line">[</span><br><span class="line">  &quot;net3&quot;,</span><br><span class="line">  &quot;net4&quot;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>æ‚¨å¯ä»¥é€šè¿‡ä½¿ç”¨å˜é‡å¼•ç”¨setå…ƒç´ æ¥éå†å€¼é›†ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">some n; public_network[n]</span><br><span class="line"></span><br><span class="line">+--------+-------------------+</span><br><span class="line">|   n    | public_network[n] |</span><br><span class="line">+--------+-------------------+</span><br><span class="line">| &quot;net3&quot; | &quot;net3&quot;            |</span><br><span class="line">| &quot;net4&quot; | &quot;net4&quot;            |</span><br><span class="line">+--------+-------------------+</span><br></pre></td></tr></table></figure>

<p>æœ€åï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ç›¸åŒçš„è¯­æ³•æ£€æŸ¥é›†åˆä¸­æ˜¯å¦å­˜åœ¨å€¼ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public_network[&quot;net3&quot;]</span><br><span class="line"></span><br><span class="line">&quot;net3&quot;</span><br></pre></td></tr></table></figure>

<p>é™¤äº†éƒ¨åˆ†å®šä¹‰é›†åˆå¤–ï¼Œæ‚¨è¿˜å¯ä»¥éƒ¨åˆ†å®šä¹‰é”®&#x2F;å€¼å¯¹ï¼ˆä¹Ÿç§°ä¸ºå¯¹è±¡ï¼‰ã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§ è¯­è¨€æŒ‡å—ä¸­çš„è§„åˆ™ã€‚</p>
<h3 id="8-7-è¯­æ³•ç¤ºä¾‹"><a href="#8-7-è¯­æ³•ç¤ºä¾‹" class="headerlink" title="8.7 è¯­æ³•ç¤ºä¾‹"></a>8.7 è¯­æ³•ç¤ºä¾‹</h3><p>ä»¥ä¸Šå„èŠ‚ä»‹ç»äº†Regoçš„æ ¸å¿ƒæ¦‚å¿µã€‚ç»¼ä¸Šæ‰€è¿°ï¼Œè®©æˆ‘ä»¬å›é¡¾ä¸€ä¸‹æ‰€éœ€çš„ç­–ç•¥ï¼ˆè‹±è¯­ï¼‰ï¼š</p>
<p>Servers reachable from the Internet must not expose the insecure â€˜httpâ€™ protocol.<br>ä»Internetå¯è®¿é—®çš„æœåŠ¡å™¨ä¸èƒ½æš´éœ²ä¸å®‰å…¨çš„â€œhttpâ€åè®®ã€‚<br>Servers are not allowed to expose the â€˜telnetâ€™ protocol.<br>æœåŠ¡å™¨ä¸å…è®¸å…¬å¼€â€™telnetâ€™åè®®ã€‚<br>åœ¨è¾ƒé«˜çº§åˆ«ï¼Œè¯¥ç­–ç•¥éœ€è¦è¯†åˆ«è¿åæŸäº›æ¡ä»¶çš„æœåŠ¡å™¨ã€‚ä¸ºäº†å®æ–½æ­¤ç­–ç•¥ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ç§°ä¸ºçš„è§„åˆ™violation ï¼Œè¿™äº›è§„åˆ™ç”Ÿæˆä¸€ç»„è¿åçš„æœåŠ¡å™¨ã€‚</p>
<p>ä¾‹å¦‚ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">package example</span><br><span class="line"></span><br><span class="line">allow = true &#123;                                      # allow is true if...</span><br><span class="line">    count(violation) == 0                           # there are zero violations.</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">violation[server.id] &#123;                              # a server is in the violation set if...</span><br><span class="line">    some server</span><br><span class="line">    public_server[server]                           # it exists in the &#x27;public_server&#x27; set and...</span><br><span class="line">    server.protocols[_] == &quot;http&quot;                   # it contains the insecure &quot;http&quot; protocol.</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">violation[server.id] &#123;                              # a server is in the violation set if...</span><br><span class="line">    server := input.servers[_]                      # it exists in the input.servers collection and...</span><br><span class="line">    server.protocols[_] == &quot;telnet&quot;                 # it contains the &quot;telnet&quot; protocol.</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public_server[server] &#123;                             # a server exists in the public_server set if...</span><br><span class="line">    some i, j</span><br><span class="line">    server := input.servers[_]                      # it exists in the input.servers collection and...</span><br><span class="line">    server.ports[_] == input.ports[i].id            # it references a port in the input.ports collection and...</span><br><span class="line">    input.ports[i].network == input.networks[j].id  # the port references a network in the input.networks collection and...</span><br><span class="line">    input.networks[j].public                        # the network is public.</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">some x; violation[x]</span><br><span class="line"></span><br><span class="line">+-----------+--------------+</span><br><span class="line">|     x     | violation[x] |</span><br><span class="line">+-----------+--------------+</span><br><span class="line">| &quot;ci&quot;      | &quot;ci&quot;         |</span><br><span class="line">| &quot;busybox&quot; | &quot;busybox&quot;    |</span><br><span class="line">+-----------+--------------+</span><br></pre></td></tr></table></figure>



<h2 id="9-å°†-OPA-ç”¨ä½œGoåº“"><a href="#9-å°†-OPA-ç”¨ä½œGoåº“" class="headerlink" title="9.å°† OPA ç”¨ä½œGoåº“"></a>9.å°† OPA ç”¨ä½œGoåº“</h2><p>OPAå¯ä»¥ä½œä¸ºåº“åµŒå…¥åˆ°Goç¨‹åºä¸­ã€‚å°†OPAåµŒå…¥ä¸ºåº“çš„æœ€ç®€å•æ–¹æ³•æ˜¯å¯¼å…¥github.com&#x2F;open-policy-agent&#x2F;opa&#x2F;rego è½¯ä»¶åŒ…ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import &quot;github.com/open-policy-agent/opa/rego&quot;</span><br></pre></td></tr></table></figure>

<p>è°ƒç”¨è¯¥rego.Newå‡½æ•°ä»¥åˆ›å»ºå¯ä»¥å‡†å¤‡æˆ–è¯„ä¼°çš„å¯¹è±¡ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">r := rego.New(</span><br><span class="line">    rego.Query(&quot;x = data.example.allow&quot;),</span><br><span class="line">    rego.Load([]string&#123;&quot;./example.rego&quot;&#125;, nil)</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>

<p>æ”¯æŒå¤šç§é€‰é¡¹è‡ªå®šä¹‰çš„è¯„ä»·ã€‚æœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§GoDocé¡µé¢ã€‚æ„é€ æ–°rego.Regoå¯¹è±¡åï¼Œæ‚¨å¯ä»¥è°ƒç”¨ PrepareForEval()ä»¥è·å¾—å¯æ‰§è¡ŒæŸ¥è¯¢ã€‚å¦‚æœPrepareForEval()å¤±è´¥ï¼Œåˆ™è¡¨æ˜ä¼ é€’ç»™rego.New()è°ƒç”¨çš„é€‰é¡¹ä¹‹ä¸€æ— æ•ˆï¼ˆä¾‹å¦‚ï¼Œè§£æé”™è¯¯ï¼Œç¼–è¯‘é”™è¯¯ç­‰ï¼‰</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ctx := context.Background()</span><br><span class="line">query, err := r.PrepareForEval(ctx)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="comment">// handle error</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥å°†å‡†å¤‡å¥½çš„æŸ¥è¯¢å¯¹è±¡ç¼“å­˜åœ¨å†…å­˜ä¸­ï¼Œåœ¨å¤šä¸ªgoroutineä¸­å…±äº«ï¼Œå¹¶ä½¿ç”¨ä¸åŒçš„è¾“å…¥é‡å¤è°ƒç”¨ã€‚è°ƒç”¨Eval()ä»¥æ‰§è¡Œå‡†å¤‡å¥½çš„æŸ¥è¯¢ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">bs, err := ioutil.ReadFile(<span class="string">&quot;./input.json&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="comment">// handle error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> input <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err := json.Unmarshal(bs, &amp;input); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="comment">// handle error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">rs, err := query.Eval(ctx, rego.EvalInput(input))</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="comment">// handle error</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¯¥ç­–ç•¥å†³ç­–åŒ…å«åœ¨Eval()è°ƒç”¨è¿”å›çš„ç»“æœä¸­ã€‚æ‚¨å¯ä»¥æ£€æŸ¥è¯¥å†³å®šå¹¶è¿›è¡Œç›¸åº”å¤„ç†ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// In this example we expect a single result (stored in the variable &#x27;x&#x27;).</span><br><span class="line">fmt.Println(&quot;Result:&quot;, rs[0].Bindings[&quot;x&quot;])</span><br></pre></td></tr></table></figure>

<p>æ‚¨å¯ä»¥å°†ä¸Šè¿°æ­¥éª¤ç»„åˆåˆ°ä¸€ä¸ªç®€å•çš„å‘½ä»¤è¡Œç¨‹åºä¸­ï¼Œè¯¥ç¨‹åºå¯ä»¥è¯„ä¼°ç­–ç•¥å¹¶è¾“å‡ºç»“æœï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">main.<span class="keyword">go</span>ï¼š</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;context&quot;</span></span><br><span class="line">	<span class="string">&quot;encoding/json&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/open-policy-agent/opa/rego&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    ctx := context.Background()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Construct a Rego object that can be prepared or evaluated.</span></span><br><span class="line">    r := rego.New(</span><br><span class="line">        rego.Query(os.Args[<span class="number">2</span>]),</span><br><span class="line">        rego.Load([]<span class="type">string</span>&#123;os.Args[<span class="number">1</span>]&#125;, <span class="literal">nil</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create a prepared query that can be evaluated.</span></span><br><span class="line">    query, err := r.PrepareForEval(ctx)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatal(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Load the input document from stdin.</span></span><br><span class="line">    <span class="keyword">var</span> input <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">    dec := json.NewDecoder(os.Stdin)</span><br><span class="line">    dec.UseNumber()</span><br><span class="line">    <span class="keyword">if</span> err := dec.Decode(&amp;input); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatal(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Execute the prepared query.</span></span><br><span class="line">    rs, err := query.Eval(ctx, rego.EvalInput(input))</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatal(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Do something with the result.</span></span><br><span class="line">    fmt.Println(rs)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œä»¥ä¸‹ä»£ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">go run main.go example.rego &#x27;data.example.violation&#x27; &lt; input.json</span><br><span class="line">[&#123;[[ci busybox]] map[]&#125;]</span><br></pre></td></tr></table></figure></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="https://wangyyovo.github.io">Blank</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="https://wangyyovo.github.io/posts/5d3bf062/">https://wangyyovo.github.io/posts/5d3bf062/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥è‡ª <a href="https://wangyyovo.github.io" target="_blank">Blank</a>ï¼</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/opa/">opa</a></div><div class="post_share"><div class="social-share" data-image="https://raw.githubusercontents.com/wangyyovo/CDN/master/cover/common/181a3c44c19e44a7e153e74abee69a73.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/ShareJS/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/ShareJS/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/3fc956cc/"><img class="prev-cover" src="https://raw.githubusercontents.com/wangyyovo/CDN/master/cover/common/181a3c44c19e44a7e153e74abee69a73.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info">OPA-regoè¯­æ³•</div></div></a></div><div class="next-post pull-right"><a href="/posts/a3a9c33/"><img class="next-cover" src="https://raw.githubusercontents.com/wangyyovo/CDN/master/cover/nats/285494672816019cfb027039031cb3ca.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info">Nats JetStream</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>ç›¸å…³æ¨è</span></div><div class="relatedPosts-list"><div><a href="/posts/3fc956cc/" title="OPA-regoè¯­æ³•"><img class="cover" src="https://raw.githubusercontents.com/wangyyovo/CDN/master/cover/common/181a3c44c19e44a7e153e74abee69a73.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-03-02</div><div class="title">OPA-regoè¯­æ³•</div></div></a></div><div><a href="/posts/ceadba08/" title="OPAè¿›é˜¶-å‡½æ•°ä¸è™šæ‹Ÿæ–‡æ¡£"><img class="cover" src="https://raw.githubusercontents.com/wangyyovo/CDN/master/cover/common/181a3c44c19e44a7e153e74abee69a73.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-03-02</div><div class="title">OPAè¿›é˜¶-å‡½æ•°ä¸è™šæ‹Ÿæ–‡æ¡£</div></div></a></div><div><a href="/posts/b0cdaf3c/" title="OPAè¿›é˜¶-ç®€æ´çš„æ¨å¯¼å¼"><img class="cover" src="https://raw.githubusercontents.com/wangyyovo/CDN/master/cover/common/181a3c44c19e44a7e153e74abee69a73.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-03-02</div><div class="title">OPAè¿›é˜¶-ç®€æ´çš„æ¨å¯¼å¼</div></div></a></div><div><a href="/posts/74b42414/" title="å¦‚ä½•ä¼˜é›…çš„ä½¿ç”¨opaè¿›è¡Œå¼€å‘"><img class="cover" src="https://raw.githubusercontents.com/wangyyovo/CDN/master/cover/common/181a3c44c19e44a7e153e74abee69a73.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-03-02</div><div class="title">å¦‚ä½•ä¼˜é›…çš„ä½¿ç”¨opaè¿›è¡Œå¼€å‘</div></div></a></div><div><a href="/posts/ee217f4a/" title="OPAè¿›é˜¶-åˆ†å¸ƒå¼åˆ©å™¨Bundle"><img class="cover" src="https://raw.githubusercontents.com/wangyyovo/CDN/master/cover/common/181a3c44c19e44a7e153e74abee69a73.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-03-02</div><div class="title">OPAè¿›é˜¶-åˆ†å¸ƒå¼åˆ©å™¨Bundle</div></div></a></div><div><a href="/posts/ba44c24c/" title="OPAè¿›é˜¶-æµ‹è¯•ã€æ€§èƒ½åˆ†æå’ŒåŸºå‡†æµ‹è¯•"><img class="cover" src="https://raw.githubusercontents.com/wangyyovo/CDN/master/cover/common/181a3c44c19e44a7e153e74abee69a73.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-03-02</div><div class="title">OPAè¿›é˜¶-æµ‹è¯•ã€æ€§èƒ½åˆ†æå’ŒåŸºå‡†æµ‹è¯•</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> è¯„è®º</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://raw.githubusercontents.com/wangyyovo/CDN/master/theme/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Blank</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">356</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">36</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">54</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/wangyyovo" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:xxxxxx@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fas fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>å…¬å‘Š</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#OPA-%E4%BB%8B%E7%BB%8D"><span class="toc-text">OPA-ä»‹ç»</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-OPA-%E4%BB%8B%E7%BB%8D"><span class="toc-text">1.OPA ä»‹ç»</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-OPA-%E8%A7%A3%E5%86%B3%E4%BA%86%E5%93%AA%E4%BA%9B%E9%97%AE%E9%A2%98"><span class="toc-text">2.OPA è§£å†³äº†å“ªäº›é—®é¢˜</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-rego%E4%BB%8B%E7%BB%8D"><span class="toc-text">3.regoä»‹ç»</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-OPA-%E5%AE%89%E8%A3%85"><span class="toc-text">4.OPA å®‰è£…</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-OPA-%E8%BF%90%E8%A1%8C"><span class="toc-text">5.OPA è¿è¡Œ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-OPA-run%EF%BC%88%E4%BA%92%E5%8A%A8%E5%BC%8F%EF%BC%89"><span class="toc-text">6.OPA runï¼ˆäº’åŠ¨å¼ï¼‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-OPA-run%EF%BC%88%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%89"><span class="toc-text">7.OPA runï¼ˆæœåŠ¡å™¨ï¼‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-Rego-%E8%AF%AD%E6%B3%95"><span class="toc-text">8.Rego è¯­æ³•</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-%E5%8F%82%E8%80%83"><span class="toc-text">8.1 å‚è€ƒ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-%E8%A1%A8%E8%BE%BE%E5%BC%8F%EF%BC%88%E9%80%BB%E8%BE%91%E4%B8%8E%EF%BC%89"><span class="toc-text">8.2 è¡¨è¾¾å¼ï¼ˆé€»è¾‘ä¸ï¼‰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3-%E9%80%BB%E8%BE%91%E6%88%96"><span class="toc-text">8.3 é€»è¾‘æˆ–</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-4-Variables%E5%8F%98%E9%87%8F"><span class="toc-text">8.4 Variableså˜é‡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-5-%E8%BF%AD%E4%BB%A3"><span class="toc-text">8.5 è¿­ä»£</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-6-%E8%A7%84%E5%88%99"><span class="toc-text">8.6 è§„åˆ™</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#8-6-1-%E5%AE%8C%E6%95%B4%E8%A7%84%E5%88%99"><span class="toc-text">8.6.1 å®Œæ•´è§„åˆ™</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-6-2-%E9%83%A8%E5%88%86%E8%A7%84%E5%88%99"><span class="toc-text">8.6.2 éƒ¨åˆ†è§„åˆ™</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-7-%E8%AF%AD%E6%B3%95%E7%A4%BA%E4%BE%8B"><span class="toc-text">8.7 è¯­æ³•ç¤ºä¾‹</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-%E5%B0%86-OPA-%E7%94%A8%E4%BD%9CGo%E5%BA%93"><span class="toc-text">9.å°† OPA ç”¨ä½œGoåº“</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>æœ€æ–°æ–‡ç« </span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/d14168d/" title="è™šæ‹Ÿæœºé—®é¢˜åˆé›†"><img src="https://raw.githubusercontents.com/wangyyovo/CDN/master/cover/hexo/090cfe4e9e60b0ad0de05db822f3ae97.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="è™šæ‹Ÿæœºé—®é¢˜åˆé›†"/></a><div class="content"><a class="title" href="/posts/d14168d/" title="è™šæ‹Ÿæœºé—®é¢˜åˆé›†">è™šæ‹Ÿæœºé—®é¢˜åˆé›†</a><time datetime="2022-07-16T13:30:36.000Z" title="å‘è¡¨äº 2022-07-16 21:30:36">2022-07-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/f540045f/" title="ç”¨goè¯­è¨€ç¼–å†™ç§»åŠ¨ç«¯sdkå’Œappå¼€å‘"><img src="https://raw.githubusercontents.com/wangyyovo/CDN/master/cover/golang/941ed1ec2925719a0c92e76f4f786b6a.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ç”¨goè¯­è¨€ç¼–å†™ç§»åŠ¨ç«¯sdkå’Œappå¼€å‘"/></a><div class="content"><a class="title" href="/posts/f540045f/" title="ç”¨goè¯­è¨€ç¼–å†™ç§»åŠ¨ç«¯sdkå’Œappå¼€å‘">ç”¨goè¯­è¨€ç¼–å†™ç§»åŠ¨ç«¯sdkå’Œappå¼€å‘</a><time datetime="2022-07-04T12:14:21.000Z" title="å‘è¡¨äº 2022-07-04 20:14:21">2022-07-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/5faac006/" title="åœ¨çº¿ç¼–ç¨‹IDE"><img src="https://raw.githubusercontents.com/wangyyovo/CDN/master/cover/hexo/090cfe4e9e60b0ad0de05db822f3ae97.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="åœ¨çº¿ç¼–ç¨‹IDE"/></a><div class="content"><a class="title" href="/posts/5faac006/" title="åœ¨çº¿ç¼–ç¨‹IDE">åœ¨çº¿ç¼–ç¨‹IDE</a><time datetime="2022-06-12T13:30:36.000Z" title="å‘è¡¨äº 2022-06-12 21:30:36">2022-06-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/7594185d/" title="å³æ—¶æ€§èƒ½åˆ†æå·¥å…·Pyroscope"><img src="https://raw.githubusercontents.com/wangyyovo/CDN/master/cover/golang/3bfb3279740bc9a5b5ef436fa887ef07.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="å³æ—¶æ€§èƒ½åˆ†æå·¥å…·Pyroscope"/></a><div class="content"><a class="title" href="/posts/7594185d/" title="å³æ—¶æ€§èƒ½åˆ†æå·¥å…·Pyroscope">å³æ—¶æ€§èƒ½åˆ†æå·¥å…·Pyroscope</a><time datetime="2022-06-12T08:07:36.000Z" title="å‘è¡¨äº 2022-06-12 16:07:36">2022-06-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/82a7aa7c/" title="golangæ€§èƒ½è°ƒè¯•ä¼˜åŒ–æ–¹æ³•"><img src="https://raw.githubusercontents.com/wangyyovo/CDN/master/cover/common/3.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="golangæ€§èƒ½è°ƒè¯•ä¼˜åŒ–æ–¹æ³•"/></a><div class="content"><a class="title" href="/posts/82a7aa7c/" title="golangæ€§èƒ½è°ƒè¯•ä¼˜åŒ–æ–¹æ³•">golangæ€§èƒ½è°ƒè¯•ä¼˜åŒ–æ–¹æ³•</a><time datetime="2022-06-12T03:00:36.000Z" title="å‘è¡¨äº 2022-06-12 11:00:36">2022-06-12</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By Blank</div><div class="framework-info"><span>æ¡†æ¶ </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>ä¸»é¢˜ </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://wangyyovo.github.io/">blog</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="ç®€ç¹è½¬æ¢">ç¹</button><button id="darkmode" type="button" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="è®¾ç½®"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="ç›´è¾¾è¯„è®º"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">æœç´¢</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  æ•°æ®åº“åŠ è½½ä¸­</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="æœç´¢æ–‡ç« " type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@5/instantpage.js" type="module"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '49gEIIGN7uRbL6vHhieSpBzM-MdYXbMMI',
      appKey: 'uqts0urLKwikYQ0fKmIkMHBE',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><div class="aplayer no-destroy" data-id="000PeZCQ1i4XVs" data-server="tencent" data-type="artist" data-fixed="true" data-mini="true" data-listFolded="false" data-order="random" data-preload="none" data-autoplay="false" muted></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-heart.min.js" async="async" mobile="false"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer@1/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/MetingJS/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>