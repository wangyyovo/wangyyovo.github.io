<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>gomicroæ·±åº¦å­¦ä¹  | Blank</title><meta name="author" content="Blank"><meta name="copyright" content="Blank"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="gomicroæ·±åº¦å­¦ä¹ 1.æ•´ä½“æ¶æ„ä»‹ç»äº§å“å˜´é‡Œçš„ä¸€ä¸ªå°é¡¹ç›®ï¼Œä»ç«‹é¡¹åˆ°å¼€å‘ä¸Šçº¿ï¼Œéšç€æ—¶é—´å’Œéœ€æ±‚çš„ä¸æ–­æ¿€å¢ï¼Œä¼šè¶Šæ¥è¶Šå¤æ‚ï¼Œå˜æˆä¸€ä¸ªå¤§é¡¹ç›®ï¼Œå¦‚æœå‰æœŸé¡¹ç›®æ¶æ„æ²¡è®¾è®¡çš„ä¸å¥½ï¼Œä»£ç ä¼šè¶Šæ¥è¶Šè‡ƒè‚¿ï¼Œéš¾ä»¥ç»´æŠ¤ï¼ŒåæœŸçš„æ¯æ¬¡äº§å“è¿­ä»£ä¸Šçº¿éƒ½ä¼šç‰µä¸€å‘è€ŒåŠ¨å…¨èº«ã€‚é¡¹ç›®å¾®æœåŠ¡åŒ–ï¼Œæ¾è€¦åˆæ¨¡å—é—´çš„å…³ç³»ï¼Œæ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ï¼Œéšç„¶å¢åŠ äº†ç»´æŠ¤æˆæœ¬ï¼Œä½†æ˜¯è¿˜æ˜¯å¾ˆå€¼å¾—çš„ã€‚   å¾®æœåŠ¡åŒ–é¡¹ç›®é™¤äº†ç¨³å®šæ€§æˆ‘ä¸ªäººè¿˜æ¯”è¾ƒå…³å¿ƒçš„å‡ ä¸ªé—®é¢˜ï¼š  ä¸€: æœåŠ¡é—´æ•°">
<meta property="og:type" content="article">
<meta property="og:title" content="gomicroæ·±åº¦å­¦ä¹ ">
<meta property="og:url" content="https://wangyyovo.github.io/posts/566a0846/">
<meta property="og:site_name" content="Blank">
<meta property="og:description" content="gomicroæ·±åº¦å­¦ä¹ 1.æ•´ä½“æ¶æ„ä»‹ç»äº§å“å˜´é‡Œçš„ä¸€ä¸ªå°é¡¹ç›®ï¼Œä»ç«‹é¡¹åˆ°å¼€å‘ä¸Šçº¿ï¼Œéšç€æ—¶é—´å’Œéœ€æ±‚çš„ä¸æ–­æ¿€å¢ï¼Œä¼šè¶Šæ¥è¶Šå¤æ‚ï¼Œå˜æˆä¸€ä¸ªå¤§é¡¹ç›®ï¼Œå¦‚æœå‰æœŸé¡¹ç›®æ¶æ„æ²¡è®¾è®¡çš„ä¸å¥½ï¼Œä»£ç ä¼šè¶Šæ¥è¶Šè‡ƒè‚¿ï¼Œéš¾ä»¥ç»´æŠ¤ï¼ŒåæœŸçš„æ¯æ¬¡äº§å“è¿­ä»£ä¸Šçº¿éƒ½ä¼šç‰µä¸€å‘è€ŒåŠ¨å…¨èº«ã€‚é¡¹ç›®å¾®æœåŠ¡åŒ–ï¼Œæ¾è€¦åˆæ¨¡å—é—´çš„å…³ç³»ï¼Œæ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ï¼Œéšç„¶å¢åŠ äº†ç»´æŠ¤æˆæœ¬ï¼Œä½†æ˜¯è¿˜æ˜¯å¾ˆå€¼å¾—çš„ã€‚   å¾®æœåŠ¡åŒ–é¡¹ç›®é™¤äº†ç¨³å®šæ€§æˆ‘ä¸ªäººè¿˜æ¯”è¾ƒå…³å¿ƒçš„å‡ ä¸ªé—®é¢˜ï¼š  ä¸€: æœåŠ¡é—´æ•°">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontents.com/wangyyovo/CDN/master/cover/microservice/958a3c375861938b04a84b0f4fe8a4ad.jpg">
<meta property="article:published_time" content="2019-09-27T07:42:36.000Z">
<meta property="article:modified_time" content="2019-09-27T07:42:36.000Z">
<meta property="article:author" content="Blank">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontents.com/wangyyovo/CDN/master/cover/microservice/958a3c375861938b04a84b0f4fe8a4ad.jpg"><link rel="shortcut icon" href="https://raw.githubusercontents.com/wangyyovo/CDN/master/theme/favicon.ico"><link rel="canonical" href="https://wangyyovo.github.io/posts/566a0846/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹ï¼š${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"ç¹","msgToSimplifiedChinese":"ç°¡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: 'å¤©',
  date_suffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: undefined,
  lightbox: 'mediumZoom',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'gomicroæ·±åº¦å­¦ä¹ ',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2019-09-27 15:42:36'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="alternate" href="/atom.xml" title="Blank" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://raw.githubusercontents.com/wangyyovo/CDN/master/theme/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">356</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">36</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">54</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> ä¸»é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> æ—¶é—´è½´</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡ç­¾</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> åˆ†ç±»</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> å‹é“¾</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fas fa-coffee"></i><span> ç•™è¨€æ¿</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> å…³äº</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> å¨±ä¹</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> éŸ³ä¹</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> ç”µå½±</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-image"></i><span> ç›¸å†Œ</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-book"></i><span> æ•™ç¨‹</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/posts/21cfbf15/"><span> ğŸš€ å¿«é€Ÿé–‹å§‹</span></a></li><li><a class="site-page child" href="/posts/dc584b87/"><span> ğŸ“‘ ä¸»é¡Œé é¢</span></a></li><li><a class="site-page child" href="/posts/4aa8abbe/"><span> ğŸ›  ä¸»é¡Œé…ç½®-1</span></a></li><li><a class="site-page child" href="/posts/ceeb73f/"><span> âš”ï¸ ä¸»é¡Œé…ç½®-2</span></a></li><li><a class="site-page child" href="/posts/98d20436/"><span> â“ ä¸»é¡Œå•ç­”</span></a></li><li><a class="site-page child" href="/posts/4073eda/"><span> âš¡ï¸ é€²éšæ•™ç¨‹</span></a></li><li><a class="site-page child" href="/posts/198a4240/"><span> âœ¨ æ›´æ–°æ—¥èªŒ</span></a></li><li><a class="site-page child" href="/posts/507c070f/"><span> ğŸ“‘ Aplayeræ•™ç¨‹</span></a></li><li><a class="site-page child" href="/posts/2df239ce/"><span> ğŸ“‘ æ¨™ç±¤å¤–æ›</span></a></li><li><a class="site-page child" href="/posts/b37b5fe3/"><span> ğŸ“‘ è‡ªå®šç¾©ä»£ç¢¼é…è‰²</span></a></li><li><a class="site-page child" href="/posts/ea33ab97/"><span> ğŸ“‘ è‡ªå®šç¾©å´é‚Šæ¬„</span></a></li><li><a class="site-page child" href="/posts/89757140/"><span> ğŸ“‘ Markdown</span></a></li><li><a class="site-page child" href="/posts/9db656e5/"><span> ğŸ“‘ ä»£ç é«˜äº®æµ‹è¯•</span></a></li><li><a class="site-page child" href="/posts/c9711c19/"><span> ğŸ“‘ ç•¶è¨­ç½®top_imgç‚ºfalseæ™‚</span></a></li><li><a class="site-page child" href="/posts/39b121ef/"><span> ğŸ“‘ Hexoå…§ç½®æ¨™ç±¤å¤–æ›</span></a></li><li><a class="site-page child" href="/posts/7670b080/"><span> ğŸ“‘ Butterfly ç¾åŒ–/å„ªåŒ–/é­”æ”¹ æ•™ç¨‹åˆé›†</span></a></li><li><a class="site-page child" href="/posts/913b2502/"><span> ğŸ“‘ æ²¡æœ‰å°é¢</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://raw.githubusercontents.com/wangyyovo/CDN/master/cover/microservice/958a3c375861938b04a84b0f4fe8a4ad.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Blank</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> æœç´¢</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> ä¸»é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> æ—¶é—´è½´</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡ç­¾</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> åˆ†ç±»</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> å‹é“¾</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fas fa-coffee"></i><span> ç•™è¨€æ¿</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> å…³äº</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> å¨±ä¹</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> éŸ³ä¹</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> ç”µå½±</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-image"></i><span> ç›¸å†Œ</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-book"></i><span> æ•™ç¨‹</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/posts/21cfbf15/"><span> ğŸš€ å¿«é€Ÿé–‹å§‹</span></a></li><li><a class="site-page child" href="/posts/dc584b87/"><span> ğŸ“‘ ä¸»é¡Œé é¢</span></a></li><li><a class="site-page child" href="/posts/4aa8abbe/"><span> ğŸ›  ä¸»é¡Œé…ç½®-1</span></a></li><li><a class="site-page child" href="/posts/ceeb73f/"><span> âš”ï¸ ä¸»é¡Œé…ç½®-2</span></a></li><li><a class="site-page child" href="/posts/98d20436/"><span> â“ ä¸»é¡Œå•ç­”</span></a></li><li><a class="site-page child" href="/posts/4073eda/"><span> âš¡ï¸ é€²éšæ•™ç¨‹</span></a></li><li><a class="site-page child" href="/posts/198a4240/"><span> âœ¨ æ›´æ–°æ—¥èªŒ</span></a></li><li><a class="site-page child" href="/posts/507c070f/"><span> ğŸ“‘ Aplayeræ•™ç¨‹</span></a></li><li><a class="site-page child" href="/posts/2df239ce/"><span> ğŸ“‘ æ¨™ç±¤å¤–æ›</span></a></li><li><a class="site-page child" href="/posts/b37b5fe3/"><span> ğŸ“‘ è‡ªå®šç¾©ä»£ç¢¼é…è‰²</span></a></li><li><a class="site-page child" href="/posts/ea33ab97/"><span> ğŸ“‘ è‡ªå®šç¾©å´é‚Šæ¬„</span></a></li><li><a class="site-page child" href="/posts/89757140/"><span> ğŸ“‘ Markdown</span></a></li><li><a class="site-page child" href="/posts/9db656e5/"><span> ğŸ“‘ ä»£ç é«˜äº®æµ‹è¯•</span></a></li><li><a class="site-page child" href="/posts/c9711c19/"><span> ğŸ“‘ ç•¶è¨­ç½®top_imgç‚ºfalseæ™‚</span></a></li><li><a class="site-page child" href="/posts/39b121ef/"><span> ğŸ“‘ Hexoå…§ç½®æ¨™ç±¤å¤–æ›</span></a></li><li><a class="site-page child" href="/posts/7670b080/"><span> ğŸ“‘ Butterfly ç¾åŒ–/å„ªåŒ–/é­”æ”¹ æ•™ç¨‹åˆé›†</span></a></li><li><a class="site-page child" href="/posts/913b2502/"><span> ğŸ“‘ æ²¡æœ‰å°é¢</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">gomicroæ·±åº¦å­¦ä¹ </h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2019-09-27T07:42:36.000Z" title="å‘è¡¨äº 2019-09-27 15:42:36">2019-09-27</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2019-09-27T07:42:36.000Z" title="æ›´æ–°äº 2019-09-27 15:42:36">2019-09-27</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/microservice/">microservice</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">å­—æ•°æ€»è®¡:</span><span class="word-count">11.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»æ—¶é•¿:</span><span>52åˆ†é’Ÿ</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="gomicroæ·±åº¦å­¦ä¹ "><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»é‡:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><script src="\assets\js\APlayer.min.js"> </script><h1 id="gomicroæ·±åº¦å­¦ä¹ "><a href="#gomicroæ·±åº¦å­¦ä¹ " class="headerlink" title="gomicroæ·±åº¦å­¦ä¹ "></a>gomicroæ·±åº¦å­¦ä¹ </h1><h2 id="1-æ•´ä½“æ¶æ„ä»‹ç»"><a href="#1-æ•´ä½“æ¶æ„ä»‹ç»" class="headerlink" title="1.æ•´ä½“æ¶æ„ä»‹ç»"></a>1.æ•´ä½“æ¶æ„ä»‹ç»</h2><p>äº§å“å˜´é‡Œçš„ä¸€ä¸ªå°é¡¹ç›®ï¼Œä»ç«‹é¡¹åˆ°å¼€å‘ä¸Šçº¿ï¼Œéšç€æ—¶é—´å’Œéœ€æ±‚çš„ä¸æ–­æ¿€å¢ï¼Œä¼šè¶Šæ¥è¶Šå¤æ‚ï¼Œå˜æˆä¸€ä¸ªå¤§é¡¹ç›®ï¼Œå¦‚æœå‰æœŸé¡¹ç›®æ¶æ„æ²¡è®¾è®¡çš„ä¸å¥½ï¼Œä»£ç ä¼šè¶Šæ¥è¶Šè‡ƒè‚¿ï¼Œéš¾ä»¥ç»´æŠ¤ï¼ŒåæœŸçš„æ¯æ¬¡äº§å“è¿­ä»£ä¸Šçº¿éƒ½ä¼šç‰µä¸€å‘è€ŒåŠ¨å…¨èº«ã€‚é¡¹ç›®å¾®æœåŠ¡åŒ–ï¼Œæ¾è€¦åˆæ¨¡å—é—´çš„å…³ç³»ï¼Œæ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ï¼Œéšç„¶å¢åŠ äº†ç»´æŠ¤æˆæœ¬ï¼Œä½†æ˜¯è¿˜æ˜¯å¾ˆå€¼å¾—çš„ã€‚ </p>
<p><img src="https://raw.githubusercontents.com/wangyyovo/CDN/master/blog/microserive/2019-go-micro-1.png" alt="img"></p>
<p>å¾®æœåŠ¡åŒ–é¡¹ç›®é™¤äº†ç¨³å®šæ€§æˆ‘ä¸ªäººè¿˜æ¯”è¾ƒå…³å¿ƒçš„å‡ ä¸ªé—®é¢˜ï¼š</p>
<ul>
<li><p>ä¸€: æœåŠ¡é—´æ•°æ®ä¼ è¾“çš„æ•ˆç‡å’Œå®‰å…¨æ€§ã€‚</p>
</li>
<li><p>äºŒ: æœåŠ¡çš„åŠ¨æ€æ‰©å……ï¼Œä¹Ÿå°±æ˜¯æœåŠ¡çš„æ³¨å†Œå’Œå‘ç°ï¼ŒæœåŠ¡é›†ç¾¤åŒ–ã€‚</p>
</li>
<li><p>ä¸‰: å¾®æœåŠ¡åŠŸèƒ½çš„å¯è®¢åˆ¶åŒ–ï¼Œå› ä¸ºå¹¶ä¸æ˜¯æ‰€æœ‰çš„åŠŸèƒ½éƒ½ä¼šå¾ˆç¬¦åˆä½ çš„éœ€æ±‚ï¼Œéš¾å…éœ€è¦æ ¹æ®è‡ªå·±çš„éœ€è¦äºŒæ¬¡å¼€å‘ä¸€äº›åŠŸèƒ½ã€‚</p>
</li>
</ul>
<p>go-microæ˜¯goè¯­è¨€ä¸‹çš„ä¸€ä¸ªå¾ˆå¥½çš„<code>rpc</code>å¾®æœåŠ¡æ¡†æ¶ï¼ŒåŠŸèƒ½å¾ˆå®Œå–„ï¼Œè€Œä¸”æˆ‘å…³å¿ƒçš„å‡ ä¸ªé—®é¢˜ä¹Ÿè§£å†³çš„å¾ˆå¥½ï¼š</p>
<ul>
<li><p>ä¸€ï¼šæœåŠ¡é—´ä¼ è¾“æ ¼å¼ä¸º<code>protobuf</code>ï¼Œæ•ˆç‡ä¸Šæ²¡çš„è¯´ï¼Œéå¸¸çš„å¿«ï¼Œä¹Ÿå¾ˆå®‰å…¨ã€‚</p>
</li>
<li><p>äºŒï¼šgo-microçš„æœåŠ¡æ³¨å†Œå’Œå‘ç°æ˜¯å¤šç§å¤šæ ·çš„ã€‚æˆ‘ä¸ªäººæ¯”è¾ƒå–œæ¬¢<code>etcdv3</code>çš„æœåŠ¡æœåŠ¡å‘ç°å’Œæ³¨å†Œã€‚</p>
</li>
<li><p>ä¸‰ï¼šä¸»è¦çš„åŠŸèƒ½éƒ½æœ‰ç›¸åº”çš„æ¥å£ï¼Œåªè¦å®ç°ç›¸åº”çš„æ¥å£ï¼Œå°±å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€è¦è®¢åˆ¶æ’ä»¶ã€‚</p>
</li>
</ul>
<h3 id="1-1é€šä¿¡æµç¨‹"><a href="#1-1é€šä¿¡æµç¨‹" class="headerlink" title="1.1é€šä¿¡æµç¨‹"></a>1.1é€šä¿¡æµç¨‹</h3><p>go-microçš„é€šä¿¡æµç¨‹å¤§è‡³å¦‚ä¸‹</p>
<p><img src="https://raw.githubusercontents.com/wangyyovo/CDN/master/blog/microserive/2019-go-micro-2.png" alt="img"></p>
<p>Serverç›‘å¬å®¢æˆ·ç«¯çš„è°ƒç”¨ï¼Œå’Œ<code>Brocker</code>æ¨é€è¿‡æ¥çš„ä¿¡æ¯è¿›è¡Œå¤„ç†ã€‚å¹¶ä¸”Serverç«¯éœ€è¦å‘<code>Register</code>æ³¨å†Œè‡ªå·±çš„å­˜åœ¨æˆ–æ¶ˆäº¡ï¼Œè¿™æ ·Clientæ‰èƒ½çŸ¥é“è‡ªå·±çš„çŠ¶æ€ã€‚</p>
<p>RegisteræœåŠ¡çš„æ³¨å†Œçš„å‘ç°ã€‚</p>
<p>Clientç«¯ä»Registerä¸­å¾—åˆ°Serverçš„ä¿¡æ¯ï¼Œç„¶åæ¯æ¬¡è°ƒç”¨éƒ½æ ¹æ®ç®—æ³•é€‰æ‹©ä¸€ä¸ªçš„Serverè¿›è¡Œé€šä¿¡ï¼Œå½“ç„¶é€šä¿¡æ˜¯è¦ç»è¿‡ç¼–ç &#x2F;è§£ç ï¼Œé€‰æ‹©ä¼ è¾“åè®®ç­‰ä¸€ç³»åˆ—è¿‡ç¨‹çš„ã€‚</p>
<p>å¦‚æœæœ‰éœ€è¦é€šçŸ¥æ‰€æœ‰çš„Serverç«¯å¯ä»¥ä½¿ç”¨<code>Brocker</code>è¿›è¡Œä¿¡æ¯çš„æ¨é€ã€‚</p>
<p><code>Brocker</code>ä¿¡æ¯é˜Ÿåˆ—è¿›è¡Œä¿¡æ¯çš„æ¥æ”¶å’Œå‘å¸ƒã€‚</p>
<p>go-microä¹‹æ‰€ä»¥å¯ä»¥é«˜åº¦è®¢åˆ¶å’Œä»–çš„æ¡†æ¶ç»“æ„æ˜¯åˆ†ä¸å¼€çš„ï¼Œgo-microç”±8ä¸ªå…³é”®çš„interfaceç»„æˆï¼Œæ¯ä¸€ä¸ªinterfaceéƒ½å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚é‡æ–°å®ç°ï¼Œè¿™8ä¸ªä¸»è¦çš„<code>inteface</code>ä¹Ÿæ„æˆäº†go-microçš„æ¡†æ¶ç»“æ„ã€‚ </p>
<p><img src="https://raw.githubusercontents.com/wangyyovo/CDN/master/blog/microserive/2019-go-micro-3.png" alt="img"></p>
<p>è¿™äº›æ¥å£go-microéƒ½æœ‰ä»–è‡ªå·±é»˜è®¤çš„å®ç°æ–¹å¼ï¼Œè¿˜æœ‰ä¸€ä¸ª<code>go-plugins</code>æ˜¯å¯¹è¿™äº›æ¥å£å®ç°çš„å¯æ›¿æ¢é¡¹ã€‚ä½ ä¹Ÿå¯ä»¥æ ¹æ®éœ€æ±‚å®ç°è‡ªå·±çš„æ’ä»¶ã€‚  </p>
<h3 id="1-2Transort"><a href="#1-2Transort" class="headerlink" title="1.2Transort"></a>1.2Transort</h3><p>æœåŠ¡ä¹‹é—´é€šä¿¡çš„æ¥å£ã€‚ä¹Ÿå°±æ˜¯æœåŠ¡å‘é€å’Œæ¥æ”¶çš„æœ€ç»ˆå®ç°æ–¹å¼ï¼Œæ˜¯ç”±è¿™äº›æ¥å£å®šåˆ¶çš„ã€‚</p>
<p>æºç ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Transport <span class="keyword">interface</span> &#123;</span><br><span class="line">	Init(...Option) <span class="type">error</span></span><br><span class="line">	Options() Options</span><br><span class="line">	Dial(addr <span class="type">string</span>, opts ...DialOption) (Client, <span class="type">error</span>)</span><br><span class="line">	Listen(addr <span class="type">string</span>, opts ...ListenOption) (Listener, <span class="type">error</span>)</span><br><span class="line">	String() <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Socket <span class="keyword">interface</span> &#123;</span><br><span class="line">	Recv(*Message) <span class="type">error</span></span><br><span class="line">	Send(*Message) <span class="type">error</span></span><br><span class="line">	Close() <span class="type">error</span></span><br><span class="line">	Local() <span class="type">string</span></span><br><span class="line">	Remote() <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Client <span class="keyword">interface</span> &#123;</span><br><span class="line">	Socket</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Listener <span class="keyword">interface</span> &#123;</span><br><span class="line">	Addr() <span class="type">string</span></span><br><span class="line">	Close() <span class="type">error</span></span><br><span class="line">	Accept(<span class="function"><span class="keyword">func</span><span class="params">(Socket)</span></span>) <span class="type">error</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Transport çš„Listenæ–¹æ³•æ˜¯ä¸€èˆ¬æ˜¯Serverç«¯è¿›è¡Œè°ƒç”¨çš„ï¼Œä»–ç›‘å¬ä¸€ä¸ªç«¯å£ï¼Œç­‰å¾…å®¢æˆ·ç«¯è°ƒç”¨ã€‚</p>
<p>Transport çš„Dialå°±æ˜¯å®¢æˆ·ç«¯è¿›è¡Œè¿æ¥æœåŠ¡çš„æ–¹æ³•ã€‚ä»–è¿”å›ä¸€ä¸ªClientæ¥å£ï¼Œè¿™ä¸ªæ¥å£è¿”å›ä¸€ä¸ªClientæ¥å£ï¼Œè¿™ä¸ªClientåµŒå…¥äº†Socketæ¥å£ï¼Œè¿™ä¸ªæ¥å£çš„æ–¹æ³•å°±æ˜¯å…·ä½“å‘é€å’Œæ¥æ”¶é€šä¿¡çš„ä¿¡æ¯ã€‚</p>
<p>httpä¼ è¾“æ˜¯go-microé»˜è®¤çš„åŒæ­¥é€šä¿¡æœºåˆ¶ã€‚å½“ç„¶è¿˜æœ‰å¾ˆå¤šå…¶ä»–çš„æ’ä»¶ï¼šgrpc,nats,tcp,udp,rabbitmq,natsï¼Œéƒ½æ˜¯ç›®å‰å·²ç»å®ç°äº†çš„æ–¹å¼ã€‚åœ¨go-pluginsé‡Œä½ éƒ½å¯ä»¥æ‰¾åˆ°ã€‚</p>
<h3 id="1-3Codec"><a href="#1-3Codec" class="headerlink" title="1.3Codec"></a>1.3Codec</h3><p>æœ‰äº†ä¼ è¾“æ–¹å¼ï¼Œä¸‹é¢è¦è§£å†³çš„å°±æ˜¯ä¼ è¾“ç¼–ç å’Œè§£ç é—®é¢˜ï¼Œgo-microæœ‰å¾ˆå¤šç§ç¼–ç è§£ç æ–¹å¼ï¼Œé»˜è®¤çš„å®ç°æ–¹å¼æ˜¯protobuf,å½“ç„¶ä¹Ÿæœ‰å…¶ä»–çš„å®ç°æ–¹å¼ï¼Œjsonã€protobufã€jsonrpcã€mercuryç­‰ç­‰ã€‚</p>
<p>æºç ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Codec <span class="keyword">interface</span> &#123;</span><br><span class="line">	Reader</span><br><span class="line">	Writer</span><br><span class="line">	Close() <span class="type">error</span></span><br><span class="line">	String() <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Reader <span class="keyword">interface</span> &#123;</span><br><span class="line">	ReadHeader(*Message, MessageType) <span class="type">error</span></span><br><span class="line">	ReadBody(<span class="keyword">interface</span>&#123;&#125;) <span class="type">error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Writer <span class="keyword">interface</span> &#123;</span><br><span class="line">	Write(*Message, <span class="keyword">interface</span>&#123;&#125;) <span class="type">error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Marshaler is a simple encoding interface used for the broker/transport</span></span><br><span class="line"><span class="comment">// where headers are not supported by the underlying implementation.</span></span><br><span class="line"><span class="keyword">type</span> Marshaler <span class="keyword">interface</span> &#123;</span><br><span class="line">	Marshal(<span class="keyword">interface</span>&#123;&#125;) ([]<span class="type">byte</span>, <span class="type">error</span>)</span><br><span class="line">	Unmarshal([]<span class="type">byte</span>, <span class="keyword">interface</span>&#123;&#125;) <span class="type">error</span></span><br><span class="line">	String() <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Message represents detailed information about</span></span><br><span class="line"><span class="comment">// the communication, likely followed by the body.</span></span><br><span class="line"><span class="comment">// In the case of an error, body may be nil.</span></span><br><span class="line"><span class="keyword">type</span> Message <span class="keyword">struct</span> &#123;</span><br><span class="line">	Id       <span class="type">string</span></span><br><span class="line">	Type     MessageType</span><br><span class="line">	Target   <span class="type">string</span></span><br><span class="line">	Method   <span class="type">string</span></span><br><span class="line">	Endpoint <span class="type">string</span></span><br><span class="line">	Error    <span class="type">string</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// The values read from the socket</span></span><br><span class="line">	Header <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span></span><br><span class="line">	Body   []<span class="type">byte</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> Codecæ¥å£çš„Writeæ–¹æ³•å°±æ˜¯ç¼–ç è¿‡ç¨‹ï¼Œä¸¤ä¸ªReadæ˜¯è§£ç è¿‡ç¨‹ã€‚</p>
<h3 id="1-4Registry"><a href="#1-4Registry" class="headerlink" title="1.4Registry"></a>1.4Registry</h3><p>æœåŠ¡çš„æ³¨å†Œå’Œå‘ç°ï¼Œç›®å‰å®ç°çš„consul,mdns, etcd,etcdv3,zookeeper,kubernetes.ç­‰ç­‰ï¼Œ</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The registry provides an interface for service discovery</span></span><br><span class="line"><span class="comment">// and an abstraction over varying implementations</span></span><br><span class="line"><span class="comment">// &#123;consul, etcd, zookeeper, ...&#125;</span></span><br><span class="line"><span class="keyword">type</span> Registry <span class="keyword">interface</span> &#123;</span><br><span class="line">	Init(...Option) <span class="type">error</span></span><br><span class="line">	Options() Options</span><br><span class="line">	Register(*Service, ...RegisterOption) <span class="type">error</span></span><br><span class="line">	Deregister(*Service) <span class="type">error</span></span><br><span class="line">	GetService(<span class="type">string</span>) ([]*Service, <span class="type">error</span>)</span><br><span class="line">	ListServices() ([]*Service, <span class="type">error</span>)</span><br><span class="line">	Watch(...WatchOption) (Watcher, <span class="type">error</span>)</span><br><span class="line">	String() <span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç®€å•æ¥è¯´ï¼Œå°±æ˜¯Service è¿›è¡ŒRegisterï¼Œæ¥è¿›è¡Œæ³¨å†Œï¼ŒClient ä½¿ç”¨watchæ–¹æ³•è¿›è¡Œç›‘æ§ï¼Œå½“æœ‰æœåŠ¡åŠ å…¥æˆ–è€…åˆ é™¤æ—¶è¿™ä¸ªæ–¹æ³•ä¼šè¢«è§¦å‘ï¼Œä»¥æé†’å®¢æˆ·ç«¯æ›´æ–°Serviceä¿¡æ¯ã€‚</p>
<p>é»˜è®¤çš„æ˜¯æœåŠ¡æ³¨å†Œå’Œå‘ç°æ˜¯mdns</p>
<p>consul.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">configure</span><span class="params">(c *consulRegistry, opts ...registry.Option)</span></span> &#123;</span><br><span class="line">	<span class="comment">// set opts</span></span><br><span class="line">	<span class="keyword">for</span> _, o := <span class="keyword">range</span> opts &#123;</span><br><span class="line">		o(&amp;c.opts)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// use default config</span></span><br><span class="line">	config := consul.DefaultConfig()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> c.opts.Context != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="comment">// Use the consul config passed in the options, if available</span></span><br><span class="line">		<span class="keyword">if</span> co, ok := c.opts.Context.Value(<span class="string">&quot;consul_config&quot;</span>).(*consul.Config); ok &#123;</span><br><span class="line">			config = co</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> cn, ok := c.opts.Context.Value(<span class="string">&quot;consul_connect&quot;</span>).(<span class="type">bool</span>); ok &#123;</span><br><span class="line">			c.connect = cn</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Use the consul query options passed in the options, if available</span></span><br><span class="line">		<span class="keyword">if</span> qo, ok := c.opts.Context.Value(<span class="string">&quot;consul_query_options&quot;</span>).(*consul.QueryOptions); ok &amp;&amp; qo != <span class="literal">nil</span> &#123;</span><br><span class="line">			c.queryOptions = qo</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> as, ok := c.opts.Context.Value(<span class="string">&quot;consul_allow_stale&quot;</span>).(<span class="type">bool</span>); ok &#123;</span><br><span class="line">			c.queryOptions.AllowStale = as</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// check if there are any addrs</span></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(c.opts.Addrs) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		addr, port, err := net.SplitHostPort(c.opts.Addrs[<span class="number">0</span>])</span><br><span class="line">		<span class="keyword">if</span> ae, ok := err.(*net.AddrError); ok &amp;&amp; ae.Err == <span class="string">&quot;missing port in address&quot;</span> &#123;</span><br><span class="line">			port = <span class="string">&quot;8500&quot;</span></span><br><span class="line">			addr = c.opts.Addrs[<span class="number">0</span>]</span><br><span class="line">			config.Address = fmt.Sprintf(<span class="string">&quot;%s:%s&quot;</span>, addr, port)</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">			config.Address = fmt.Sprintf(<span class="string">&quot;%s:%s&quot;</span>, addr, port)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> config.HttpClient == <span class="literal">nil</span> &#123;</span><br><span class="line">		config.HttpClient = <span class="built_in">new</span>(http.Client)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// requires secure connection?</span></span><br><span class="line">	<span class="keyword">if</span> c.opts.Secure || c.opts.TLSConfig != <span class="literal">nil</span> &#123;</span><br><span class="line"></span><br><span class="line">		config.Scheme = <span class="string">&quot;https&quot;</span></span><br><span class="line">		<span class="comment">// We&#x27;re going to support InsecureSkipVerify</span></span><br><span class="line">		config.HttpClient.Transport = newTransport(c.opts.TLSConfig)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// set timeout</span></span><br><span class="line">	<span class="keyword">if</span> c.opts.Timeout &gt; <span class="number">0</span> &#123;</span><br><span class="line">		config.HttpClient.Timeout = c.opts.Timeout</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// create the client</span></span><br><span class="line">	client, _ := consul.NewClient(config)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// set address/client</span></span><br><span class="line">	c.Address = config.Address</span><br><span class="line">	c.Client = client</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä¸ªäººæ¯”è¾ƒå–œæ¬¢etcdv3é›†ç¾¤ã€‚å¤§å®¶å¯ä»¥æ ¹æ®è‡ªå·±çš„å–œå¥½é€‰æ‹©ã€‚</p>
<h3 id="1-5Selector"><a href="#1-5Selector" class="headerlink" title="1.5Selector"></a>1.5Selector</h3><p>ä»¥Registryä¸ºåŸºç¡€ï¼ŒSelector æ˜¯å®¢æˆ·ç«¯çº§åˆ«çš„è´Ÿè½½å‡è¡¡ï¼Œå½“æœ‰å®¢æˆ·ç«¯å‘æœåŠ¡å‘é€è¯·æ±‚æ—¶ï¼Œ  selectoræ ¹æ®ä¸åŒçš„ç®—æ³•ä»Registeryä¸­çš„ä¸»æœºåˆ—è¡¨ï¼Œå¾—åˆ°å¯ç”¨çš„ServiceèŠ‚ç‚¹ï¼Œè¿›è¡Œé€šä¿¡ã€‚ç›®å‰å®ç°çš„æœ‰å¾ªç¯ç®—æ³•å’Œéšæœºç®—æ³•ï¼Œé»˜è®¤çš„æ˜¯éšæœºç®—æ³•ã€‚</p>
<p>æºç ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Selector builds on the registry as a mechanism to pick nodes</span></span><br><span class="line"><span class="comment">// and mark their status. This allows host pools and other things</span></span><br><span class="line"><span class="comment">// to be built using various algorithms.</span></span><br><span class="line"><span class="keyword">type</span> Selector <span class="keyword">interface</span> &#123;</span><br><span class="line">	Init(opts ...Option) <span class="type">error</span></span><br><span class="line">	Options() Options</span><br><span class="line">	<span class="comment">// Select returns a function which should return the next node</span></span><br><span class="line">	Select(service <span class="type">string</span>, opts ...SelectOption) (Next, <span class="type">error</span>)</span><br><span class="line">	<span class="comment">// Mark sets the success/error against a node</span></span><br><span class="line">	Mark(service <span class="type">string</span>, node *registry.Node, err <span class="type">error</span>)</span><br><span class="line">	<span class="comment">// Reset returns state back to zero for a service</span></span><br><span class="line">	Reset(service <span class="type">string</span>)</span><br><span class="line">	<span class="comment">// Close renders the selector unusable</span></span><br><span class="line">	Close() <span class="type">error</span></span><br><span class="line">	<span class="comment">// Name of the selector</span></span><br><span class="line">	String() <span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é»˜è®¤çš„æ˜¯å®ç°æ˜¯æœ¬åœ°ç¼“å­˜ï¼Œå½“å‰å®ç°çš„æœ‰blacklist,label,namedç­‰æ–¹å¼ã€‚</p>
<h3 id="1-6Broker"><a href="#1-6Broker" class="headerlink" title="1.6Broker"></a>1.6Broker</h3><p>Brokeræ˜¯æ¶ˆæ¯å‘å¸ƒå’Œè®¢é˜…çš„æ¥å£ã€‚å¾ˆç®€å•çš„ä¸€ä¸ªä¾‹å­ï¼Œå› ä¸ºæœåŠ¡çš„èŠ‚ç‚¹æ˜¯ä¸å›ºå®šçš„ï¼Œå¦‚æœæœ‰éœ€è¦ä¿®æ”¹æ‰€æœ‰æœåŠ¡è¡Œä¸ºçš„éœ€æ±‚ï¼Œå¯ä»¥ä½¿æœåŠ¡è®¢é˜…æŸä¸ªä¸»é¢˜ï¼Œå½“æœ‰ä¿¡æ¯å‘å¸ƒæ—¶ï¼Œæ‰€æœ‰çš„ç›‘å¬æœåŠ¡éƒ½ä¼šæ”¶åˆ°ä¿¡æ¯ï¼Œæ ¹æ®ä½ çš„éœ€è¦åšç›¸åº”çš„è¡Œä¸ºã€‚</p>
<p>æºç ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Broker is an interface used for asynchronous messaging.</span></span><br><span class="line"><span class="keyword">type</span> Broker <span class="keyword">interface</span> &#123;</span><br><span class="line">	Init(...Option) <span class="type">error</span></span><br><span class="line">	Options() Options</span><br><span class="line">	Address() <span class="type">string</span></span><br><span class="line">	Connect() <span class="type">error</span></span><br><span class="line">	Disconnect() <span class="type">error</span></span><br><span class="line">	Publish(topic <span class="type">string</span>, m *Message, opts ...PublishOption) <span class="type">error</span></span><br><span class="line">	Subscribe(topic <span class="type">string</span>, h Handler, opts ...SubscribeOption) (Subscriber, <span class="type">error</span>)</span><br><span class="line">	String() <span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Brokeré»˜è®¤çš„å®ç°æ–¹å¼æ˜¯httpæ–¹å¼ï¼Œä½†æ˜¯è¿™ç§æ–¹å¼ä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒç”¨ã€‚go-pluginsé‡Œæœ‰å¾ˆå¤šæˆç†Ÿçš„æ¶ˆæ¯é˜Ÿåˆ—å®ç°æ–¹å¼ï¼Œæœ‰kafkaã€nsqã€rabbitmqã€redisï¼Œç­‰ç­‰ã€‚</p>
<h3 id="1-7Client"><a href="#1-7Client" class="headerlink" title="1.7Client"></a>1.7Client</h3><p>Clientæ˜¯è¯·æ±‚æœåŠ¡çš„æ¥å£ï¼Œä»–å°è£…Transportå’ŒCodecè¿›è¡Œrpcè°ƒç”¨ï¼Œä¹Ÿå°è£…äº†Brockerè¿›è¡Œä¿¡æ¯çš„å‘å¸ƒã€‚</p>
<p>æºç ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Client <span class="keyword">interface</span> &#123;</span><br><span class="line">    Init(...Option) <span class="type">error</span></span><br><span class="line">    Options() Options</span><br><span class="line">    NewMessage(topic <span class="type">string</span>, msg <span class="keyword">interface</span>&#123;&#125;, opts ...MessageOption) Message</span><br><span class="line">    NewRequest(service, method <span class="type">string</span>, req <span class="keyword">interface</span>&#123;&#125;, reqOpts ...RequestOption) Request</span><br><span class="line">    Call(ctx context.Context, req Request, rsp <span class="keyword">interface</span>&#123;&#125;, opts ...CallOption) <span class="type">error</span></span><br><span class="line">    Stream(ctx context.Context, req Request, opts ...CallOption) (Stream, <span class="type">error</span>)</span><br><span class="line">    Publish(ctx context.Context, msg Message, opts ...PublishOption) <span class="type">error</span></span><br><span class="line">    String() <span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å½“ç„¶ä»–ä¹Ÿæ”¯æŒåŒå·¥é€šä¿¡ Stream è¿™äº›å…·ä½“çš„å®ç°æ–¹å¼å’Œä½¿ç”¨æ–¹å¼ï¼Œä»¥åä¼šè¯¦ç»†è§£è¯´ã€‚</p>
<p>é»˜è®¤çš„æ˜¯rpcå®ç°æ–¹å¼ï¼Œä»–è¿˜æœ‰grpcå’Œhttpæ–¹å¼ï¼Œåœ¨go-pluginsé‡Œå¯ä»¥æ‰¾åˆ°</p>
<h3 id="1-8Server"><a href="#1-8Server" class="headerlink" title="1.8Server"></a>1.8Server</h3><p>Serverçœ‹åå­—å¤§å®¶ä¹ŸçŸ¥é“æ˜¯åšä»€ä¹ˆçš„äº†ã€‚ç›‘å¬ç­‰å¾…rpcè¯·æ±‚ã€‚ç›‘å¬brokerçš„è®¢é˜…ä¿¡æ¯ï¼Œç­‰å¾…ä¿¡æ¯é˜Ÿåˆ—çš„æ¨é€ç­‰ã€‚</p>
<p>æºç ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Server is a simple micro server abstraction</span></span><br><span class="line"><span class="keyword">type</span> Server <span class="keyword">interface</span> &#123;</span><br><span class="line">	Options() Options</span><br><span class="line">	Init(...Option) <span class="type">error</span></span><br><span class="line">	Handle(Handler) <span class="type">error</span></span><br><span class="line">	NewHandler(<span class="keyword">interface</span>&#123;&#125;, ...HandlerOption) Handler</span><br><span class="line">	NewSubscriber(<span class="type">string</span>, <span class="keyword">interface</span>&#123;&#125;, ...SubscriberOption) Subscriber</span><br><span class="line">	Subscribe(Subscriber) <span class="type">error</span></span><br><span class="line">	Start() <span class="type">error</span></span><br><span class="line">	Stop() <span class="type">error</span></span><br><span class="line">	String() <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Router handle serving messages</span></span><br><span class="line"><span class="keyword">type</span> Router <span class="keyword">interface</span> &#123;</span><br><span class="line">	<span class="comment">// ServeRequest processes a request to completion</span></span><br><span class="line">	ServeRequest(context.Context, Request, Response) <span class="type">error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Message is an async message interface</span></span><br><span class="line"><span class="keyword">type</span> Message <span class="keyword">interface</span> &#123;</span><br><span class="line">	Topic() <span class="type">string</span></span><br><span class="line">	Payload() <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">	ContentType() <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Request is a synchronous request interface</span></span><br><span class="line"><span class="keyword">type</span> Request <span class="keyword">interface</span> &#123;</span><br><span class="line">	<span class="comment">// Service name requested</span></span><br><span class="line">	Service() <span class="type">string</span></span><br><span class="line">	<span class="comment">// The action requested</span></span><br><span class="line">	Method() <span class="type">string</span></span><br><span class="line">	<span class="comment">// Endpoint name requested</span></span><br><span class="line">	Endpoint() <span class="type">string</span></span><br><span class="line">	<span class="comment">// Content type provided</span></span><br><span class="line">	ContentType() <span class="type">string</span></span><br><span class="line">	<span class="comment">// Header of the request</span></span><br><span class="line">	Header() <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span></span><br><span class="line">	<span class="comment">// Body is the initial decoded value</span></span><br><span class="line">	Body() <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">	<span class="comment">// Read the undecoded request body</span></span><br><span class="line">	Read() ([]<span class="type">byte</span>, <span class="type">error</span>)</span><br><span class="line">	<span class="comment">// The encoded message stream</span></span><br><span class="line">	Codec() codec.Reader</span><br><span class="line">	<span class="comment">// Indicates whether its a stream</span></span><br><span class="line">	Stream() <span class="type">bool</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Response is the response writer for unencoded messages</span></span><br><span class="line"><span class="keyword">type</span> Response <span class="keyword">interface</span> &#123;</span><br><span class="line">	<span class="comment">// Encoded writer</span></span><br><span class="line">	Codec() codec.Writer</span><br><span class="line">	<span class="comment">// Write the header</span></span><br><span class="line">	WriteHeader(<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>)</span><br><span class="line">	<span class="comment">// write a response directly to the client</span></span><br><span class="line">	Write([]<span class="type">byte</span>) <span class="type">error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Stream represents a stream established with a client.</span></span><br><span class="line"><span class="comment">// A stream can be bidirectional which is indicated by the request.</span></span><br><span class="line"><span class="comment">// The last error will be left in Error().</span></span><br><span class="line"><span class="comment">// EOF indicates end of the stream.</span></span><br><span class="line"><span class="keyword">type</span> Stream <span class="keyword">interface</span> &#123;</span><br><span class="line">	Context() context.Context</span><br><span class="line">	Request() Request</span><br><span class="line">	Send(<span class="keyword">interface</span>&#123;&#125;) <span class="type">error</span></span><br><span class="line">	Recv(<span class="keyword">interface</span>&#123;&#125;) <span class="type">error</span></span><br><span class="line">	Error() <span class="type">error</span></span><br><span class="line">	Close() <span class="type">error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Handler interface represents a request handler. It&#x27;s generated</span></span><br><span class="line"><span class="comment">// by passing any type of public concrete object with endpoints into server.NewHandler.</span></span><br><span class="line"><span class="comment">// Most will pass in a struct.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Example:</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//      type Greeter struct &#123;&#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//      func (g *Greeter) Hello(context, request, response) error &#123;</span></span><br><span class="line"><span class="comment">//              return nil</span></span><br><span class="line"><span class="comment">//      &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">type</span> Handler <span class="keyword">interface</span> &#123;</span><br><span class="line">	Name() <span class="type">string</span></span><br><span class="line">	Handler() <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">	Endpoints() []*registry.Endpoint</span><br><span class="line">	Options() HandlerOptions</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Subscriber interface represents a subscription to a given topic using</span></span><br><span class="line"><span class="comment">// a specific subscriber function or object with endpoints.</span></span><br><span class="line"><span class="keyword">type</span> Subscriber <span class="keyword">interface</span> &#123;</span><br><span class="line">	Topic() <span class="type">string</span></span><br><span class="line">	Subscriber() <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">	Endpoints() []*registry.Endpoint</span><br><span class="line">	Options() SubscriberOptions</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é»˜è®¤çš„æ˜¯rpcå®ç°æ–¹å¼ï¼Œä»–è¿˜æœ‰grpcå’Œhttpæ–¹å¼ï¼Œåœ¨go-pluginsé‡Œå¯ä»¥æ‰¾åˆ°</p>
<h3 id="1-9Service"><a href="#1-9Service" class="headerlink" title="1.9Service"></a>1.9Service</h3><p>Serviceæ˜¯Clientå’ŒServerçš„å°è£…ï¼Œä»–åŒ…å«äº†ä¸€ç³»åˆ—çš„æ–¹æ³•ä½¿ç”¨åˆå§‹å€¼å»åˆå§‹åŒ–Serviceå’ŒClientï¼Œä½¿æˆ‘ä»¬å¯ä»¥å¾ˆç®€å•çš„åˆ›å»ºä¸€ä¸ªrpcæœåŠ¡ã€‚</p>
<p>æºç ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Service is an interface that wraps the lower level libraries</span></span><br><span class="line"><span class="comment">// within go-micro. Its a convenience method for building</span></span><br><span class="line"><span class="comment">// and initialising services.</span></span><br><span class="line"><span class="keyword">type</span> Service <span class="keyword">interface</span> &#123;</span><br><span class="line">	Init(...Option)</span><br><span class="line">	Options() Options</span><br><span class="line">	Client() client.Client</span><br><span class="line">	Server() server.Server</span><br><span class="line">	Run() <span class="type">error</span></span><br><span class="line">	String() <span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-å…¥é—¨ä¾‹å­"><a href="#2-å…¥é—¨ä¾‹å­" class="headerlink" title="2.å…¥é—¨ä¾‹å­"></a>2.å…¥é—¨ä¾‹å­</h2><p>ä¸Šä¸€ç¯‡å¸–å­ç®€å•ä»‹ç»äº†go-microçš„æ•´ä½“æ¡†æ¶ç»“æ„ï¼Œè¿™ä¸€ç¯‡ä¸»è¦å†™go-microä½¿ç”¨æ–¹å¼çš„ä¾‹å­ï¼Œä¸­é—´ä¼šç©¿æ’ä¸€äº›go-microçš„æºç ï¼Œå’Œè°ƒç”¨æµç¨‹å›¾ï¼Œå¸®å¤§å®¶æ›´å¥½çš„ç†è§£go-microçš„åº•å±‚ã€‚æ›´è¯¦ç»†æ›´å…·ä½“çš„è°ƒç”¨æµç¨‹å’Œç»†èŠ‚ï¼Œä¼šåœ¨ä»¥åçš„å¸–å­é‡Œè¯¦ç»†è®²è§£ã€‚</p>
<blockquote>
<p>ä¾‹å­çš„githubåœ°å€ï¼š <a target="_blank" rel="noopener" href="https://github.com/lpxxn/gomicrorpc">gomicrorpc</a>   è·‘ä¸€éä¾‹å­ï¼Œä¹Ÿå°±ä¼šæ˜ç™½ä¸ªå¤§æ¦‚ã€‚</p>
</blockquote>
<h3 id="å®‰è£…æ‰€éœ€è¦çš„ç¯å¢ƒ"><a href="#å®‰è£…æ‰€éœ€è¦çš„ç¯å¢ƒ" class="headerlink" title="å®‰è£…æ‰€éœ€è¦çš„ç¯å¢ƒ"></a>å®‰è£…æ‰€éœ€è¦çš„ç¯å¢ƒ</h3><p>go-microæœåŠ¡å‘ç°é»˜è®¤ä½¿ç”¨çš„æ˜¯<a target="_blank" rel="noopener" href="https://www.consul.io/downloads.html">consul</a>ï¼Œ(2019å¹´æºç ä¿®æ”¹äº†é»˜è®¤ä½¿ç”¨mdns)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">brew install consul</span><br><span class="line">consul agent -dev</span><br></pre></td></tr></table></figure>

<p>è€…ç›´æ¥ä½¿ç”¨ä½¿ç”¨dockerè·‘</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 8300:8300 -p 8301:8301 -p 8301:8301/udp -p 8302:8302/udp -p 8302:8302 -p 8400:8400 -p 8500:8500 -p 53:53/udp consul</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä¸ªäººæ›´å–œæ¬¢<a target="_blank" rel="noopener" href="https://github.com/etcd-io/etcd/tree/v3.2.17">etcdv3</a>åŸå› æˆ‘ä¸Šä¸€ç¯‡ä¹Ÿæœ‰æåˆ°è¿‡ï¼ŒgomicroæœåŠ¡å‘ç°ä¸æ”¯æŒconsulé›†ç¾¤ï¼Œæˆ‘ä¹‹å‰ä¹Ÿå†™è¿‡<a target="_blank" rel="noopener" href="https://www.cnblogs.com/li-peng/p/9259793.html">etcdv3 é›†ç¾¤çš„æ­å»ºå’Œä½¿ç”¨</a>å¸–å­ï¼Œæœ‰æ—¶é—´å¤§å®¶å¯ä»¥çœ‹ä¸€ä¸‹</p>
<p>å®‰è£…go-microæ¡†æ¶</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get github.com/micro/go-micro</span><br></pre></td></tr></table></figure>

<p>å®‰è£…protobufå’Œä¾èµ– prtobufçš„åŸºç¡€çŸ¥è¯†æˆ‘è¿™é‡Œå°±ä¸è®²äº†ï¼Œå¦‚æœä¸äº†è§£çš„å¯ä»¥çœ‹ä¸€ä¸‹<a target="_blank" rel="noopener" href="https://developers.google.com/protocol-buffers/">å®˜æ–¹æ–‡æ¡£</a>ï¼Œå°±æ˜¯ä¸€ä¸ªè·¨å¹³å°ï¼Œè·¨è¯­è¨€çš„æ•°æ®åºåˆ—åŒ–åº“ï¼Œç®€å•æ˜“å­¦ã€‚</p>
<p>æ˜¯go-microç”¨äºå¸®åŠ©æˆ‘ä»¬ç”ŸæˆæœåŠ¡æ¥å£å’Œä¸€ç³»åˆ—çš„è°ƒç”¨ä»£ç </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">brew install protobuf</span><br><span class="line">go get -u -v github.com/golang/protobuf/&#123;proto,protoc-gen-go&#125;</span><br><span class="line">go get -u -v github.com/micro/protoc-gen-micro</span><br></pre></td></tr></table></figure>

<p>protobufä¹Ÿå¯ä»¥ç›´æ¥ä»æºç å®‰è£…</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/protocolbuffers/protobuf/releases/download/v3.6.1/protobuf-all-3.6.1.tar.gz</span><br><span class="line">tar zxvf protobuf-all-3.6.1.tar.gz</span><br><span class="line">cd protobuf-3.6.1/</span><br><span class="line">./autogen.sh</span><br><span class="line">./configure</span><br><span class="line"> make</span><br><span class="line">make install</span><br><span class="line">protoc -h</span><br></pre></td></tr></table></figure>

<p>å®‰è£…microå·¥å…·åŒ…ï¼Œè¿™ä¸ªå®‰è£…æ˜¯å¯é€‰é¡¹ï¼Œmicroæä¾›äº†ä¸€ç³»åˆ—çš„å·¥å…·æ¥å¸®åŠ©æˆ‘ä»¬æ›´å¥½çš„ä½¿ç”¨go-microã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get github.com/micro/micro</span><br></pre></td></tr></table></figure>

<h3 id="ä¾‹å­1"><a href="#ä¾‹å­1" class="headerlink" title="ä¾‹å­1"></a>ä¾‹å­1</h3><p>åˆ›å»ºprotoæ–‡ä»¶common.protoï¼Œè¿™ä¸ªæ–‡ä»¶åŒ…å«äº†ä¼ å…¥å’Œè¿”å›çš„å‚æ•°ï¼Œå‚æ•°åŒ…å«äº†å¸¸ç”¨çš„åŸºç¡€ç±»å‹ã€æ•°ç»„ã€mapç­‰ã€‚è¿˜æœ‰ä¸€ä¸ªSay æœåŠ¡ï¼Œè¿™ä¸ªæœåŠ¡é‡Œæœ‰ä¸€ä¸ªrpcæ–¹æ³•ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> model;</span><br><span class="line"></span><br><span class="line">message SayParam &#123;</span><br><span class="line">    <span class="type">string</span> msg = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message Pair &#123;</span><br><span class="line">    <span class="type">int32</span> key = <span class="number">1</span>;</span><br><span class="line">    <span class="type">string</span> values = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message SayResponse &#123;</span><br><span class="line">    <span class="type">string</span> msg = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// æ•°ç»„</span></span><br><span class="line">    repeated <span class="type">string</span> values = <span class="number">2</span>;</span><br><span class="line">    <span class="comment">// map</span></span><br><span class="line">    <span class="keyword">map</span>&lt;<span class="type">string</span>, Pair&gt; header = <span class="number">3</span>;</span><br><span class="line">    RespType <span class="keyword">type</span> = <span class="number">4</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">enum RespType &#123;</span><br><span class="line">    NONE = <span class="number">0</span>;</span><br><span class="line">    ASCEND = <span class="number">1</span>;</span><br><span class="line">    DESCEND = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æœåŠ¡æ¥å£</span></span><br><span class="line">service Say &#123;</span><br><span class="line">    rpc Hello(SayParam) returns (SayResponse) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨æ ¹ç›®å½•ä¸‹è¿è¡Œï¼Œç”Ÿæˆä¸¤ä¸ªæ¨¡æ¿æ–‡ä»¶</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">protoc --proto_path=$GOPATH/src:. --micro_out=. --go_out=. example1/proto/*.proto </span><br></pre></td></tr></table></figure>

<p>ä¸€ä¸ªæ–‡ä»¶æ˜¯protoçš„go ç»“æ„æ–‡ä»¶ï¼Œè¿˜æœ‰ä¸€ä¸ªgo-micro rpcçš„æ¥å£æ–‡ä»¶ã€‚</p>
<p>server ç«¯ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Say <span class="keyword">struct</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Say)</span></span> Hello(ctx context.Context, req *model.SayParam, rsp *model.SayResponse) <span class="type">error</span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;received&quot;</span>, req.Msg)</span><br><span class="line">    rsp.Header = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]*model.Pair)</span><br><span class="line">    rsp.Header[<span class="string">&quot;name&quot;</span>] = &amp;model.Pair&#123;Key: <span class="number">1</span>, Values: <span class="string">&quot;abc&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">    rsp.Msg = <span class="string">&quot;hello world&quot;</span></span><br><span class="line">    rsp.Values = <span class="built_in">append</span>(rsp.Values, <span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>)</span><br><span class="line">    rsp.Type = model.RespType_DESCEND</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// æˆ‘è¿™é‡Œç”¨çš„etcd åšä¸ºæœåŠ¡å‘ç°ï¼Œå¦‚æœä½¿ç”¨consulå¯ä»¥å»æ‰</span></span><br><span class="line">    reg := etcdv3.NewRegistry(<span class="function"><span class="keyword">func</span><span class="params">(op *registry.Options)</span></span>&#123;</span><br><span class="line">        op.Addrs = []<span class="type">string</span>&#123;</span><br><span class="line">            <span class="string">&quot;http://192.168.3.34:2379&quot;</span>, <span class="string">&quot;http://192.168.3.18:2379&quot;</span>, <span class="string">&quot;http://192.168.3.110:2379&quot;</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–æœåŠ¡</span></span><br><span class="line">    service := micro.NewService(</span><br><span class="line">        micro.Name(<span class="string">&quot;lp.srv.eg1&quot;</span>),</span><br><span class="line">        micro.Registry(reg),</span><br><span class="line">    )</span><br><span class="line">    service.Init()</span><br><span class="line">    <span class="comment">// æ³¨å†Œ Handler</span></span><br><span class="line">    model.RegisterSayHandler(service.Server(), <span class="built_in">new</span>(Say))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// run server</span></span><br><span class="line">    <span class="keyword">if</span> err := service.Run(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœåŠ¡å‘ç°æˆ‘ä½¿ç”¨çš„æ˜¯etcdv3 æ›¿æ¢äº†é»˜è®¤çš„consul</p>
<p>micro.NewService åˆå§‹åŒ–æœåŠ¡ï¼Œç„¶åè¿”å›ä¸€ä¸ªServiceæ¥å£çš„å®ä¾‹ï¼ŒnewService()æ–¹æ³•çš„å¤§æ¦‚æµç¨‹å¦‚ä¸‹ï¼Œ</p>
<p><img src="https://raw.githubusercontents.com/wangyyovo/CDN/master/blog/microserive/2019-go-micro-15.png" alt="img"></p>
<p>å…ˆæ˜¯ç»™å„ä¸ªæ¥å£åˆå§‹åŒ–é»˜è®¤å€¼ï¼Œå†ä½¿ç”¨ä¼ å…¥çš„å€¼æ›¿æ¢é»˜è®¤å€¼ï¼Œè¿™ä¹Ÿæ˜¯go-microå¯æ›¿æ¢æ’ä»¶çš„åœ°æ–¹ã€‚</p>
<p>serviceæœ‰ä¸€ä¸ªInit()å¯é€‰æ–¹æ³•ï¼Œè¿™æ˜¯ä¸€ä¸ªå•ä¾‹æ–¹æ³•ï¼Œ</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Init initialises options. Additionally it calls cmd.Init</span></span><br><span class="line"><span class="comment">// which parses command line flags. cmd.Init is only called</span></span><br><span class="line"><span class="comment">// on first Init.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *service)</span></span> Init(opts ...Option) &#123;</span><br><span class="line">	<span class="comment">// process options</span></span><br><span class="line">	<span class="keyword">for</span> _, o := <span class="keyword">range</span> opts &#123;</span><br><span class="line">		o(&amp;s.opts)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	s.once.Do(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="comment">// Initialise the command flags, overriding new service</span></span><br><span class="line">		_ = s.opts.Cmd.Init(</span><br><span class="line">			cmd.Broker(&amp;s.opts.Broker),</span><br><span class="line">			cmd.Registry(&amp;s.opts.Registry),</span><br><span class="line">			cmd.Transport(&amp;s.opts.Transport),</span><br><span class="line">			cmd.Client(&amp;s.opts.Client),</span><br><span class="line">			cmd.Server(&amp;s.opts.Server),</span><br><span class="line">		)</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”¨äºå§‹åŒ–cmdçš„ä¸€äº›ä¿¡æ¯</p>
<p>service.Run()æ–¹æ³• è°ƒç”¨æµç¨‹</p>
<p><img src="https://raw.githubusercontents.com/wangyyovo/CDN/master/blog/microserive/2019-go-micro-5.png" alt="img"></p>
<p>å› ä¸ºåœ¨åˆå§‹åŒ–çš„æ—¶å€™æ²¡æœ‰æŒ‡å®šç«¯å£ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åˆ†é…ä¸€ä¸ªç«¯å£å·åˆ†ç»™Serverï¼Œå¹¶æŠŠè¿™ä¸ªserverçš„ä¿¡æ¯æ³¨å†Œåˆ°Registerã€‚</p>
<p>BeferStartå’ŒAfterStartä¹Ÿéƒ½æ˜¯å¯ä»¥è‡ªå®šä¹‰çš„</p>
<p>client ç«¯ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// æˆ‘è¿™é‡Œç”¨çš„etcd åšä¸ºæœåŠ¡å‘ç°ï¼Œå¦‚æœä½¿ç”¨consulå¯ä»¥å»æ‰</span></span><br><span class="line">    reg := etcdv3.NewRegistry(<span class="function"><span class="keyword">func</span><span class="params">(op *registry.Options)</span></span>&#123;</span><br><span class="line">        op.Addrs = []<span class="type">string</span>&#123;</span><br><span class="line">            <span class="string">&quot;http://192.168.3.34:2379&quot;</span>, <span class="string">&quot;http://192.168.3.18:2379&quot;</span>, <span class="string">&quot;http://192.168.3.110:2379&quot;</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–æœåŠ¡</span></span><br><span class="line">    service := micro.NewService(</span><br><span class="line">        micro.Registry(reg),</span><br><span class="line">    )</span><br><span class="line">    service.Init()</span><br><span class="line">    sayClent := model.NewSayService(<span class="string">&quot;lp.srv.eg1&quot;</span>, service.Client())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    rsp, err := sayClent.Hello(context.Background(), &amp;model.SayParam&#123;Msg: <span class="string">&quot;hello server&quot;</span>&#125;)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fmt.Println(rsp)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢æ ¹æ®protoæ–‡ä»¶çš„ç”Ÿæˆçš„ä¸¤ä¸ªæ–‡ä»¶ä¸­æœ‰ä¸€ä¸ªæ˜¯rpcçš„æ¥å£æ–‡ä»¶ï¼Œæ¥å£æ–‡ä»¶å·²ç»å¸®æˆ‘ä»¬æŠŠè°ƒç”¨æ–¹æ³•çš„æ•´ä¸ªæµç¨‹å°è£…å¥½äº†ã€‚</p>
<p>åªéœ€è¦ç»™å‡ºæœåŠ¡åç§°å’Œlicentå°±å¯ä»¥ã€‚ç„¶åè°ƒç”¨Helloæ–¹æ³•</p>
<p>æºç ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *sayService)</span></span> Hello(ctx context.Context, in *SayParam, opts ...client.CallOption) (*SayResponse, <span class="type">error</span>) &#123;</span><br><span class="line">    req := c.c.NewRequest(c.name, <span class="string">&quot;Say.Hello&quot;</span>, in)</span><br><span class="line">    out := <span class="built_in">new</span>(SayResponse)</span><br><span class="line">    err := c.c.Call(ctx, req, out, opts...)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> out, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> ä¸»è¦çš„æµç¨‹é‡Œéƒ½åœ¨c.c.Callæ–¹æ³•é‡Œã€‚ç®€å•æ¥è¯´æµç¨‹å¦‚ä¸‹</p>
<p><img src="https://raw.githubusercontents.com/wangyyovo/CDN/master/blog/microserive/2019-go-micro-6.png" alt="img"></p>
<p>å°±æ˜¯å¾—åˆ°èŠ‚ç‚¹ä¿¡æ¯addressï¼Œæ ¹æ®addresså»æŸ¥è¯¢  poolé‡Œæ˜¯å¦æœ‰è¿æ¥ï¼Œå¦‚æœæœ‰åˆ™å–å‡ºæ¥ï¼Œå¦‚æœæ²¡æœ‰åˆ™åˆ›å»ºï¼Œç„¶åè¿›è¡Œæ•°æ®ä¼ è¾“ï¼Œä¼ è¾“å®ŒæˆåæŠŠclientæ”¾å›åˆ°poolå†…ã€‚poolçš„å¤§å°ä¹Ÿæ˜¯å¯ä»¥æ§åˆ¶çš„ï¼Œè¿™éƒ¨åˆ†çš„ä»£ç è¯»èµ·æ¥ç‰¹åˆ«çˆ½ï¼Œå…·ä½“çš„ç»†èŠ‚å’Œå¤„ç†æµç¨‹ä¼šåœ¨ä»¥åçš„å¸–å­é‡Œè¯¦ç»†è®²è§£</p>
<h3 id="ä¾‹å­2"><a href="#ä¾‹å­2" class="headerlink" title="ä¾‹å­2"></a>ä¾‹å­2</h3><p>ä¾‹å­1ï¼Œåšäº†ä¸€ä¸ªç®€å•çš„æœåŠ¡ï¼Œå·²ç»ä¸èƒ½å†ç®€å•äº†ï¼Œåªæ˜¯ä¸ºäº†èƒ½è®©å¤§å®¶ç†Ÿæ‚‰ä¸€ä¸‹go-microã€‚çœ‹å®Œä¾‹å­1ååº”è¯¥ä¼šæœ‰æ›´å¤šçš„æƒ³æ³•ï¼Œæƒ³ä½¿ç”¨æ›´å¤šçš„go-microçš„åŠŸèƒ½ï¼Œæ¯”å¦‚protobufç”Ÿæˆçš„ç±»éƒ½åœ¨ä¸€èµ·ï¼Œå¦‚æœæƒ³modelå’Œapiåˆ†å¼€æ€ä¹ˆå¤„ç†ï¼Œæ€ä¹ˆä½¿ç”¨go-microçš„åŒå‘æµï¼Œæ€ä¹ˆä½¿ç”¨æ¶ˆæ¯æ¨é€ï¼Œç­‰ç­‰ã€‚æ‰€ä»¥æˆ‘å°±åŒåšäº†ä¸€ä¸ªå°ä¾‹å­ï¼Œè¿™ä¸ªä¾‹å­é‡ŒåŒ…å«äº†ä¸€äº›ä¸œè¥¿ã€‚</p>
<p>è¿™ä¸ªä¾‹å­æˆ‘å°±åªè¯´ä¸€ä¸‹ç»„ç»‡ç»“æ„ï¼Œä¹Ÿæ²¡æœ‰å¤šå°‘ä»£ç ï¼Œå¤§å®¶æœ‰æ—¶é—´çœ‹ä¸€ä¸‹å°±okäº†ã€‚</p>
<p>protoä¸‹çš„ä¸¤ä¸ªæ–‡ä»¶å¤¹ï¼Œä¸€ä¸ªmodelä¸€ä¸ªrpcapiï¼Œæ˜¯æŠŠæ•°æ®å’Œapiåˆ†å¼€ï¼Œapiå¼•ç”¨äº†model</p>
<p>çœ‹ä¸€ä¸‹rpcapi</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> rpcapi;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;github.com/lpxxn/gomicrorpc/example2/proto/model/common.proto&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æœåŠ¡æ¥å£</span></span><br><span class="line">service Say &#123;</span><br><span class="line">    rpc Hello(model.SayParam) returns (model.SayResponse) &#123;&#125;</span><br><span class="line">    rpc Stream(model.SRequest) returns (stream model.SResponse) &#123;&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>â€‹    importäº†modelé‡Œçš„common.proto</p>
<p>åœ¨ç”Ÿæˆçš„æ—¶å€™ä¸€ä¸ªåªè¦go_outå¦ä¸€ä¸ªåªè¦micro_outå°±å¥½äº†</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">protoc --proto_path=$GOPATH/src:. --go_out=. example2/proto/model/*.proto </span><br><span class="line">protoc --proto_path=$GOPATH/src:. --micro_out=. example2/proto/rpcapi/*.proto </span><br></pre></td></tr></table></figure>

<p>è®¢é˜…ä¸€ä¸ªä¿¡æ¯</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Register Subscribers</span></span><br><span class="line"><span class="keyword">if</span> err := server.Subscribe(server.NewSubscriber(common.Topic1, subscriber.Handler)); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å½“æœ‰ä¿¡æ¯å‘é€æ—¶ï¼Œæ‰€æœ‰è®¢é˜…äº†lp.srv.eg2.topic1è¿™ä¸ªä¿¡æ¯çš„æœåŠ¡éƒ½ä¼šæ”¶åˆ°ä¿¡æ¯</p>
<p>å®¢æˆ·ç«¯å‘é€ä¿¡æ¯</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">p := micro.NewPublisher(common.Topic1, service.Client())</span><br><span class="line">p.Publish(context.TODO(), &amp;model.SayParam&#123;Msg: lib.RandomStr(lib.Random(<span class="number">3</span>, <span class="number">10</span>))&#125;)</span><br></pre></td></tr></table></figure>

<p>å¦‚æœæ˜¯ç”Ÿäº§ç¯å¢ƒä¸€å®šä¸è¦ç”¨go-microé»˜è®¤çš„ä¿¡æ¯å‘å¸ƒå’Œè®¢é˜…å¤„ç†æ–¹å¼ï¼Œmicroçš„æ’ä»¶pluginé‡Œæ˜¯æœ‰å¾ˆå¤šæˆç†Ÿçš„æ’ä»¶ã€‚</p>
<p>ä½¿ç”¨åŒå‘æµçš„å°åŠŸèƒ½</p>
<p>è¿™ä¸ªæ–¹æ³•åªæ˜¯æ¯æ¬¡å‘å®¢æˆ·ç«¯å‘é€ä¸€äº›æ•°æ®ï¼Œæ¯æ¬¡åªå‘é€ä¸€éƒ¨åˆ†ã€‚æ¯”å¦‚æˆ‘ä»¬ç»™å®¢æˆ·ç«¯æ¨é€çš„æ•°æ®å¾ˆå¤§æ—¶ï¼Œä¸€æ¬¡æ€§å…¨éƒ½æ¨è¿‡å»ï¼Œæ˜¯ä¸å¤ªæ­£ç¡®çš„åšæ³•ï¼Œåˆ†æ‰¹æ¨é€è¿˜æ˜¯æ¯”è¾ƒå¥½çš„ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Say)</span></span> Stream(ctx context.Context, req *model.SRequest, stream rpcapi.Say_StreamStream) <span class="type">error</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="type">int</span>(req.Count); i++ &#123;</span><br><span class="line">        rsp := &amp;model.SResponse&#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> j := lib.Random(<span class="number">3</span>, <span class="number">5</span>); j &lt; <span class="number">10</span>; j++ &#123;</span><br><span class="line">            rsp.Value = <span class="built_in">append</span>(rsp.Value, lib.RandomStr(lib.Random(<span class="number">3</span>, <span class="number">10</span>)))</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> err := stream.Send(rsp); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ¨¡æ‹Ÿå¤„ç†è¿‡ç¨‹</span></span><br><span class="line">        time.Sleep(time.Microsecond * <span class="number">50</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="3-RegistryæœåŠ¡çš„æ³¨å†Œå’Œå‘ç°"><a href="#3-RegistryæœåŠ¡çš„æ³¨å†Œå’Œå‘ç°" class="headerlink" title="3.RegistryæœåŠ¡çš„æ³¨å†Œå’Œå‘ç°"></a>3.RegistryæœåŠ¡çš„æ³¨å†Œå’Œå‘ç°</h2><p>æœåŠ¡çš„æ³¨å†Œä¸å‘ç°æ˜¯å¾®æœåŠ¡å¿…ä¸å¯å°‘çš„åŠŸèƒ½ï¼Œè¿™æ ·ç³»ç»Ÿæ‰èƒ½æœ‰æ›´é«˜çš„æ€§èƒ½ï¼Œæ›´é«˜çš„å¯ç”¨æ€§ã€‚go-microæ¡†æ¶çš„æœåŠ¡å‘ç°æœ‰è‡ªå·±èƒ½ç”¨çš„æ¥å£Registryã€‚åªè¦å®ç°è¿™ä¸ªæ¥å£å°±å¯ä»¥å®šåˆ¶è‡ªå·±çš„æœåŠ¡æ³¨å†Œå’Œå‘ç°ã€‚</p>
<p>go-microåœ¨å®¢æˆ·ç«¯åšçš„è´Ÿè½½ï¼Œå…¸å‹çš„Balancing-aware Clientæ¨¡å¼ã€‚</p>
<p><img src="https://raw.githubusercontents.com/wangyyovo/CDN/master/blog/microserive/2019-go-micro-7.png" alt="img"></p>
<p>æœåŠ¡ç«¯æŠŠæœåŠ¡çš„åœ°å€ä¿¡æ¯ä¿å­˜åˆ°Registry,  ç„¶åå®šæ—¶çš„å¿ƒè·³æ£€æŸ¥ï¼Œæˆ–è€…å®šæ—¶çš„é‡æ–°æ³¨å†ŒæœåŠ¡ã€‚å®¢æˆ·ç«¯ç›‘å¬Registryï¼Œæœ€å¥½æ˜¯æŠŠæœåŠ¡ä¿¡æ¯ä¿å­˜åˆ°æœ¬åœ°ï¼Œç›‘å¬æœåŠ¡çš„å˜åŠ¨ï¼Œæ›´æ–°ç¼“å­˜ã€‚å½“è°ƒç”¨æœåŠ¡ç«¯çš„æ¥å£æ˜¯æ—¶ï¼Œæ ¹æ®å®¢æˆ·ç«¯çš„æœåŠ¡åˆ—è¡¨å’Œè´Ÿè½½ç®—æ³•é€‰æ‹©æœåŠ¡ç«¯è¿›è¡Œé€šä¿¡ã€‚</p>
<p> go-microçš„èƒ½ç”¨Registryæ¥å£</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The registry provides an interface for service discovery</span></span><br><span class="line"><span class="comment">// and an abstraction over varying implementations</span></span><br><span class="line"><span class="comment">// &#123;consul, etcd, zookeeper, ...&#125;</span></span><br><span class="line"><span class="keyword">type</span> Registry <span class="keyword">interface</span> &#123;</span><br><span class="line">	Init(...Option) <span class="type">error</span></span><br><span class="line">	Options() Options</span><br><span class="line">	Register(*Service, ...RegisterOption) <span class="type">error</span></span><br><span class="line">	Deregister(*Service) <span class="type">error</span></span><br><span class="line">	GetService(<span class="type">string</span>) ([]*Service, <span class="type">error</span>)</span><br><span class="line">	ListServices() ([]*Service, <span class="type">error</span>)</span><br><span class="line">	Watch(...WatchOption) (Watcher, <span class="type">error</span>)</span><br><span class="line">	String() <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Watcher is an interface that returns updates</span></span><br><span class="line"><span class="comment">// about services within the registry.</span></span><br><span class="line"><span class="keyword">type</span> Watcher <span class="keyword">interface</span> &#123;</span><br><span class="line">	<span class="comment">// Next is a blocking call</span></span><br><span class="line">	Next() (*Result, <span class="type">error</span>)</span><br><span class="line">	Stop()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªæ¥å£è¿˜æ˜¯å¾ˆç®€å•æ˜äº†çš„ï¼Œçœ‹æ–¹æ³•ä¹Ÿå¤§æ¦‚èƒ½çŒœåˆ°ä¸»è¦çš„ä½œç”¨</p>
<p>Registeræ–¹æ³•å’ŒDeregisteræ˜¯æœåŠ¡ç«¯ç”¨äºæ³¨å†ŒæœåŠ¡çš„ï¼ŒWatcheræ¥å£æ˜¯å®¢æˆ·ç«¯ç”¨äºç›‘å¬æœåŠ¡ä¿¡æ¯å˜åŒ–çš„ã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¥go-microçš„etcdv3ä¸ºRegistryçš„ä¾‹ç»™å¤§å®¶è¯¦ç»†è®²è§£ä¸€ä¸‹go-microçš„è¯¦ç»†æœåŠ¡å‘ç°è¿‡ç¨‹</p>
<h3 id="go-micro-æœåŠ¡ç«¯æ³¨å†ŒæœåŠ¡"><a href="#go-micro-æœåŠ¡ç«¯æ³¨å†ŒæœåŠ¡" class="headerlink" title="go-micro æœåŠ¡ç«¯æ³¨å†ŒæœåŠ¡"></a>go-micro æœåŠ¡ç«¯æ³¨å†ŒæœåŠ¡</h3><p>æµç¨‹å›¾</p>
<p><img src="https://raw.githubusercontents.com/wangyyovo/CDN/master/blog/microserive/2019-go-micro-8.png" alt="img"></p>
<p>æœåŠ¡ç«¯çœ‹ä¸Šå»æµç¨‹è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œå½“æœåŠ¡ç«¯è°ƒç”¨Run()æ–¹æ³•æ—¶ï¼Œä¼šè°ƒç”¨service.Start()æ–¹æ³•ã€‚è¿™ä¸ªé™¤äº†ç›‘å¬ç«¯å£ï¼Œå¯åŠ¨æœåŠ¡ï¼Œè¿˜ä¼šæŠŠæœåŠ¡çš„ipç«¯å£å·ä¿¡æ¯ï¼Œå’Œæ‰€æœ‰çš„å…¬å¼€æ¥å£çš„å…ƒæ•°æ®ä¿¡æ¯ä¿å­˜åˆ°æˆ‘ä»¬é€‰æ‹©çš„RegisteræœåŠ¡å™¨ä¸Šå»ã€‚</p>
<p>çœ‹ä¸Šå»æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬çš„èŠ‚ç‚¹å‘ç”Ÿæ•…éšœï¼Œä¹Ÿæ˜¯éœ€è¦å‘Šè¯‰RegisteræŠŠæˆ‘ä»¬çš„èŠ‚ç‚¹ä¿¡æ¯åˆ é™¤æ‰ã€‚</p>
<p>Run()æ–¹æ³•ä¸­æœ‰ä¸ªgo s.run(ex)  æ–¹æ³•çš„è°ƒç”¨ï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯æ ¹æ®æˆ‘ä»¬è®¾ç½®intervalå»é‡æ–°æ³¨å†ŒæœåŠ¡ï¼Œå½“ç„¶æ¯”è¾ƒä¿é™©çš„æ–¹å¼æ˜¯æˆ‘ä»¬æŠŠæœåŠ¡çš„ttlä¹Ÿè®¾ç½®ä¸Šï¼Œè¿™æ ·å½“æœåŠ¡åœ¨æœªçŸ¥çš„æƒ…å†µä¸‹å´©æºƒï¼Œåˆ°äº†ttlçš„æ—¶é—´RegisteræœåŠ¡ä¹Ÿä¼šè‡ªåŠ¨æŠŠä¿¡æ¯åˆ é™¤æ‰ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *service)</span></span> run(exit <span class="keyword">chan</span> <span class="type">bool</span>) &#123;</span><br><span class="line">	<span class="keyword">if</span> s.opts.RegisterInterval &lt;= time.Duration(<span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	t := time.NewTicker(s.opts.RegisterInterval)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> &lt;-t.C:</span><br><span class="line">			s.register()</span><br><span class="line">		<span class="keyword">case</span> &lt;-exit:</span><br><span class="line">			t.Stop()</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è®¾ç½®æœåŠ¡çš„ttlå’Œ interval</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆå§‹åŒ–æœåŠ¡</span></span><br><span class="line">service := micro.NewService(</span><br><span class="line">    micro.Name(common.ServiceName),</span><br><span class="line">    micro.RegisterTTL(time.Second*<span class="number">30</span>),</span><br><span class="line">    micro.RegisterInterval(time.Second*<span class="number">20</span>),</span><br><span class="line">    micro.Registry(reg),</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p> ttlå°±æ˜¯æ³¨å†ŒæœåŠ¡çš„è¿‡æœŸæ—¶é—´ï¼Œintervalå°±æ˜¯é—´éš”å¤šä¹…å†æ¬¡æ³¨å†ŒæœåŠ¡ã€‚å¦‚æœç³»ç»Ÿå´©æºƒï¼Œè¿‡æœŸæ—¶é—´ä¹Ÿä¼šæŠŠæœåŠ¡åˆ é™¤æ‰ã€‚å®¢æˆ·ç«¯å½“ç„¶ä¹Ÿä¼šæœ‰ç›¸åº”çš„åˆ¤æ–­ï¼Œä¸‹é¢ä¼šè¯¦ç»†è§£è¯´ </p>
<h3 id="å®¢æˆ·ç«¯å‘ç°æœåŠ¡"><a href="#å®¢æˆ·ç«¯å‘ç°æœåŠ¡" class="headerlink" title="å®¢æˆ·ç«¯å‘ç°æœåŠ¡"></a>å®¢æˆ·ç«¯å‘ç°æœåŠ¡</h3><p>å®¢æˆ·ç«¯çš„æœåŠ¡å‘ç°è¦æ­¥éª¤å¤šä¸€äº›ï¼Œä½†å¹¶ä¸å¤æ‚ï¼Œä»–æ¶‰åŠåˆ°æœåŠ¡é€‰æ‹©Selectorå’ŒæœåŠ¡å‘ç°Registerä¸¤éƒ¨åˆ†ã€‚</p>
<p>Selectoræ˜¯åŸºäºæœåŠ¡å‘ç°çš„ï¼Œæ ¹æ®ä½ é€‰æ‹©çš„ä¸»æœºé€‰æ‹©ç®—æ³•ï¼Œè¿”å›ä¸»æœºçš„ä¿¡æ¯ã€‚é»˜è®¤çš„æƒ…å†µï¼Œgo-microæ˜¯æ¯æ¬¡è¦å¾—åˆ°æœåŠ¡å™¨ä¸»æœºçš„ä¿¡æ¯éƒ½è¦å»Registerå»è·å–ã€‚ä½†æ˜¯æŸ¥çœ‹cmd.goçš„æºç ä½ ä¼šå‘ç°é»˜è®¤åˆå§‹åŒ–çš„å€¼ï¼Œselectorçš„é»˜è®¤flagæ˜¯cacheã€‚DefaultSelectorsé‡Œçš„cacheå¯¹åº”çš„å°±æ˜¯åˆå§‹åŒ–cacheSelectoræ–¹æ³•</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line">DefaultFlags = []cli.Flag&#123;</span><br><span class="line">    cli.StringFlag&#123;</span><br><span class="line">        Name:   <span class="string">&quot;client&quot;</span>,</span><br><span class="line">        EnvVar: <span class="string">&quot;MICRO_CLIENT&quot;</span>,</span><br><span class="line">        Usage:  <span class="string">&quot;Client for go-micro; rpc&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    cli.StringFlag&#123;</span><br><span class="line">        Name:   <span class="string">&quot;client_request_timeout&quot;</span>,</span><br><span class="line">        EnvVar: <span class="string">&quot;MICRO_CLIENT_REQUEST_TIMEOUT&quot;</span>,</span><br><span class="line">        Usage:  <span class="string">&quot;Sets the client request timeout. e.g 500ms, 5s, 1m. Default: 5s&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    cli.IntFlag&#123;</span><br><span class="line">        Name:   <span class="string">&quot;client_retries&quot;</span>,</span><br><span class="line">        EnvVar: <span class="string">&quot;MICRO_CLIENT_RETRIES&quot;</span>,</span><br><span class="line">        Value:  client.DefaultRetries,</span><br><span class="line">        Usage:  <span class="string">&quot;Sets the client retries. Default: 1&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    cli.IntFlag&#123;</span><br><span class="line">        Name:   <span class="string">&quot;client_pool_size&quot;</span>,</span><br><span class="line">        EnvVar: <span class="string">&quot;MICRO_CLIENT_POOL_SIZE&quot;</span>,</span><br><span class="line">        Usage:  <span class="string">&quot;Sets the client connection pool size. Default: 1&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    cli.StringFlag&#123;</span><br><span class="line">        Name:   <span class="string">&quot;client_pool_ttl&quot;</span>,</span><br><span class="line">        EnvVar: <span class="string">&quot;MICRO_CLIENT_POOL_TTL&quot;</span>,</span><br><span class="line">        Usage:  <span class="string">&quot;Sets the client connection pool ttl. e.g 500ms, 5s, 1m. Default: 1m&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    cli.IntFlag&#123;</span><br><span class="line">        Name:   <span class="string">&quot;register_ttl&quot;</span>,</span><br><span class="line">        EnvVar: <span class="string">&quot;MICRO_REGISTER_TTL&quot;</span>,</span><br><span class="line">        Usage:  <span class="string">&quot;Register TTL in seconds&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    cli.IntFlag&#123;</span><br><span class="line">        Name:   <span class="string">&quot;register_interval&quot;</span>,</span><br><span class="line">        EnvVar: <span class="string">&quot;MICRO_REGISTER_INTERVAL&quot;</span>,</span><br><span class="line">        Usage:  <span class="string">&quot;Register interval in seconds&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    cli.StringFlag&#123;</span><br><span class="line">        Name:   <span class="string">&quot;server&quot;</span>,</span><br><span class="line">        EnvVar: <span class="string">&quot;MICRO_SERVER&quot;</span>,</span><br><span class="line">        Usage:  <span class="string">&quot;Server for go-micro; rpc&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    cli.StringFlag&#123;</span><br><span class="line">        Name:   <span class="string">&quot;server_name&quot;</span>,</span><br><span class="line">        EnvVar: <span class="string">&quot;MICRO_SERVER_NAME&quot;</span>,</span><br><span class="line">        Usage:  <span class="string">&quot;Name of the server. go.micro.srv.example&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    cli.StringFlag&#123;</span><br><span class="line">        Name:   <span class="string">&quot;server_version&quot;</span>,</span><br><span class="line">        EnvVar: <span class="string">&quot;MICRO_SERVER_VERSION&quot;</span>,</span><br><span class="line">        Usage:  <span class="string">&quot;Version of the server. 1.1.0&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    cli.StringFlag&#123;</span><br><span class="line">        Name:   <span class="string">&quot;server_id&quot;</span>,</span><br><span class="line">        EnvVar: <span class="string">&quot;MICRO_SERVER_ID&quot;</span>,</span><br><span class="line">        Usage:  <span class="string">&quot;Id of the server. Auto-generated if not specified&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    cli.StringFlag&#123;</span><br><span class="line">        Name:   <span class="string">&quot;server_address&quot;</span>,</span><br><span class="line">        EnvVar: <span class="string">&quot;MICRO_SERVER_ADDRESS&quot;</span>,</span><br><span class="line">        Usage:  <span class="string">&quot;Bind address for the server. 127.0.0.1:8080&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    cli.StringFlag&#123;</span><br><span class="line">        Name:   <span class="string">&quot;server_advertise&quot;</span>,</span><br><span class="line">        EnvVar: <span class="string">&quot;MICRO_SERVER_ADVERTISE&quot;</span>,</span><br><span class="line">        Usage:  <span class="string">&quot;Used instead of the server_address when registering with discovery. 127.0.0.1:8080&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    cli.StringSliceFlag&#123;</span><br><span class="line">        Name:   <span class="string">&quot;server_metadata&quot;</span>,</span><br><span class="line">        EnvVar: <span class="string">&quot;MICRO_SERVER_METADATA&quot;</span>,</span><br><span class="line">        Value:  &amp;cli.StringSlice&#123;&#125;,</span><br><span class="line">        Usage:  <span class="string">&quot;A list of key-value pairs defining metadata. version=1.0.0&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    cli.StringFlag&#123;</span><br><span class="line">        Name:   <span class="string">&quot;broker&quot;</span>,</span><br><span class="line">        EnvVar: <span class="string">&quot;MICRO_BROKER&quot;</span>,</span><br><span class="line">        Usage:  <span class="string">&quot;Broker for pub/sub. http, nats, rabbitmq&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    cli.StringFlag&#123;</span><br><span class="line">        Name:   <span class="string">&quot;broker_address&quot;</span>,</span><br><span class="line">        EnvVar: <span class="string">&quot;MICRO_BROKER_ADDRESS&quot;</span>,</span><br><span class="line">        Usage:  <span class="string">&quot;Comma-separated list of broker addresses&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    cli.StringFlag&#123;</span><br><span class="line">        Name:   <span class="string">&quot;registry&quot;</span>,</span><br><span class="line">        EnvVar: <span class="string">&quot;MICRO_REGISTRY&quot;</span>,</span><br><span class="line">        Usage:  <span class="string">&quot;Registry for discovery. consul, mdns&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    cli.StringFlag&#123;</span><br><span class="line">        Name:   <span class="string">&quot;registry_address&quot;</span>,</span><br><span class="line">        EnvVar: <span class="string">&quot;MICRO_REGISTRY_ADDRESS&quot;</span>,</span><br><span class="line">        Usage:  <span class="string">&quot;Comma-separated list of registry addresses&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    cli.StringFlag&#123;</span><br><span class="line">        Name:   <span class="string">&quot;selector&quot;</span>,</span><br><span class="line">        EnvVar: <span class="string">&quot;MICRO_SELECTOR&quot;</span>,</span><br><span class="line">        Usage:  <span class="string">&quot;Selector used to pick nodes for querying&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    cli.StringFlag&#123;</span><br><span class="line">        Name:   <span class="string">&quot;transport&quot;</span>,</span><br><span class="line">        EnvVar: <span class="string">&quot;MICRO_TRANSPORT&quot;</span>,</span><br><span class="line">        Usage:  <span class="string">&quot;Transport mechanism used; http&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    cli.StringFlag&#123;</span><br><span class="line">        Name:   <span class="string">&quot;transport_address&quot;</span>,</span><br><span class="line">        EnvVar: <span class="string">&quot;MICRO_TRANSPORT_ADDRESS&quot;</span>,</span><br><span class="line">        Usage:  <span class="string">&quot;Comma-separated list of transport addresses&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DefaultBrokers = <span class="keyword">map</span>[<span class="type">string</span>]<span class="function"><span class="keyword">func</span><span class="params">(...broker.Option)</span></span> broker.Broker&#123;</span><br><span class="line">    <span class="string">&quot;http&quot;</span>:   http.NewBroker,</span><br><span class="line">    <span class="string">&quot;memory&quot;</span>: memory.NewBroker,</span><br><span class="line">    <span class="string">&quot;nats&quot;</span>:   nats.NewBroker,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DefaultClients = <span class="keyword">map</span>[<span class="type">string</span>]<span class="function"><span class="keyword">func</span><span class="params">(...client.Option)</span></span> client.Client&#123;</span><br><span class="line">    <span class="string">&quot;rpc&quot;</span>:  client.NewClient,</span><br><span class="line">    <span class="string">&quot;mucp&quot;</span>: cmucp.NewClient,</span><br><span class="line">    <span class="string">&quot;grpc&quot;</span>: cgrpc.NewClient,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DefaultRegistries = <span class="keyword">map</span>[<span class="type">string</span>]<span class="function"><span class="keyword">func</span><span class="params">(...registry.Option)</span></span> registry.Registry&#123;</span><br><span class="line">    <span class="string">&quot;consul&quot;</span>: consul.NewRegistry,</span><br><span class="line">    <span class="string">&quot;gossip&quot;</span>: gossip.NewRegistry,</span><br><span class="line">    <span class="string">&quot;mdns&quot;</span>:   mdns.NewRegistry,</span><br><span class="line">    <span class="string">&quot;memory&quot;</span>: rmem.NewRegistry,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DefaultSelectors = <span class="keyword">map</span>[<span class="type">string</span>]<span class="function"><span class="keyword">func</span><span class="params">(...selector.Option)</span></span> selector.Selector&#123;</span><br><span class="line">    <span class="string">&quot;default&quot;</span>: selector.NewSelector,</span><br><span class="line">    <span class="string">&quot;dns&quot;</span>:     dns.NewSelector,</span><br><span class="line">    <span class="string">&quot;cache&quot;</span>:   selector.NewSelector,</span><br><span class="line">    <span class="string">&quot;router&quot;</span>:  router.NewSelector,</span><br><span class="line">    <span class="string">&quot;static&quot;</span>:  static.NewSelector,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DefaultServers = <span class="keyword">map</span>[<span class="type">string</span>]<span class="function"><span class="keyword">func</span><span class="params">(...server.Option)</span></span> server.Server&#123;</span><br><span class="line">    <span class="string">&quot;rpc&quot;</span>:  server.NewServer,</span><br><span class="line">    <span class="string">&quot;mucp&quot;</span>: smucp.NewServer,</span><br><span class="line">    <span class="string">&quot;grpc&quot;</span>: sgrpc.NewServer,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DefaultTransports = <span class="keyword">map</span>[<span class="type">string</span>]<span class="function"><span class="keyword">func</span><span class="params">(...transport.Option)</span></span> transport.Transport&#123;</span><br><span class="line">    <span class="string">&quot;memory&quot;</span>: tmem.NewTransport,</span><br><span class="line">    <span class="string">&quot;http&quot;</span>:   thttp.NewTransport,</span><br><span class="line">    <span class="string">&quot;grpc&quot;</span>:   tgrpc.NewTransport,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// used for default selection as the fall back</span></span><br><span class="line">defaultClient    = <span class="string">&quot;rpc&quot;</span></span><br><span class="line">defaultServer    = <span class="string">&quot;rpc&quot;</span></span><br><span class="line">defaultBroker    = <span class="string">&quot;http&quot;</span></span><br><span class="line">defaultRegistry  = <span class="string">&quot;mdns&quot;</span></span><br><span class="line">defaultSelector  = <span class="string">&quot;registry&quot;</span></span><br><span class="line">defaultTransport = <span class="string">&quot;http&quot;</span></span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯å½“ä½ åœ¨æ‰§è¡Œservice.Init()æ–¹æ³•æ—¶ï¼Œgo-microä¼šæŠŠé»˜è®¤çš„selectoræ›¿æ¢æˆcacheSelector,å…·ä½“çš„å®ç°æ˜¯åœ¨cmd.goçš„Beforeæ–¹æ³•é‡Œ</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *cmd)</span></span> Before(ctx *cli.Context) <span class="type">error</span> &#123;</span><br><span class="line">	<span class="comment">// If flags are set then use them otherwise do nothing</span></span><br><span class="line">	<span class="keyword">var</span> serverOpts []server.Option</span><br><span class="line">	<span class="keyword">var</span> clientOpts []client.Option</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Set the client</span></span><br><span class="line">	<span class="keyword">if</span> name := ctx.String(<span class="string">&quot;client&quot;</span>); <span class="built_in">len</span>(name) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="comment">// only change if we have the client and type differs</span></span><br><span class="line">		<span class="keyword">if</span> cl, ok := c.opts.Clients[name]; ok &amp;&amp; (*c.opts.Client).String() != name &#123;</span><br><span class="line">			*c.opts.Client = cl()</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Set the server</span></span><br><span class="line">	<span class="keyword">if</span> name := ctx.String(<span class="string">&quot;server&quot;</span>); <span class="built_in">len</span>(name) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="comment">// only change if we have the server and type differs</span></span><br><span class="line">		<span class="keyword">if</span> s, ok := c.opts.Servers[name]; ok &amp;&amp; (*c.opts.Server).String() != name &#123;</span><br><span class="line">			*c.opts.Server = s()</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Set the broker</span></span><br><span class="line">	<span class="keyword">if</span> name := ctx.String(<span class="string">&quot;broker&quot;</span>); <span class="built_in">len</span>(name) &gt; <span class="number">0</span> &amp;&amp; (*c.opts.Broker).String() != name &#123;</span><br><span class="line">		b, ok := c.opts.Brokers[name]</span><br><span class="line">		<span class="keyword">if</span> !ok &#123;</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;Broker %s not found&quot;</span>, name)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		*c.opts.Broker = b()</span><br><span class="line">		serverOpts = <span class="built_in">append</span>(serverOpts, server.Broker(*c.opts.Broker))</span><br><span class="line">		clientOpts = <span class="built_in">append</span>(clientOpts, client.Broker(*c.opts.Broker))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Set the registry</span></span><br><span class="line">	<span class="keyword">if</span> name := ctx.String(<span class="string">&quot;registry&quot;</span>); <span class="built_in">len</span>(name) &gt; <span class="number">0</span> &amp;&amp; (*c.opts.Registry).String() != name &#123;</span><br><span class="line">		r, ok := c.opts.Registries[name]</span><br><span class="line">		<span class="keyword">if</span> !ok &#123;</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;Registry %s not found&quot;</span>, name)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		*c.opts.Registry = r()</span><br><span class="line">		serverOpts = <span class="built_in">append</span>(serverOpts, server.Registry(*c.opts.Registry))</span><br><span class="line">		clientOpts = <span class="built_in">append</span>(clientOpts, client.Registry(*c.opts.Registry))</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> err := (*c.opts.Selector).Init(selector.Registry(*c.opts.Registry)); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Fatalf(<span class="string">&quot;Error configuring registry: %v&quot;</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		clientOpts = <span class="built_in">append</span>(clientOpts, client.Selector(*c.opts.Selector))</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> err := (*c.opts.Broker).Init(broker.Registry(*c.opts.Registry)); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Fatalf(<span class="string">&quot;Error configuring broker: %v&quot;</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Set the selector</span></span><br><span class="line">	<span class="keyword">if</span> name := ctx.String(<span class="string">&quot;selector&quot;</span>); <span class="built_in">len</span>(name) &gt; <span class="number">0</span> &amp;&amp; (*c.opts.Selector).String() != name &#123;</span><br><span class="line">		s, ok := c.opts.Selectors[name]</span><br><span class="line">		<span class="keyword">if</span> !ok &#123;</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;Selector %s not found&quot;</span>, name)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		*c.opts.Selector = s(selector.Registry(*c.opts.Registry))</span><br><span class="line"></span><br><span class="line">		<span class="comment">// No server option here. Should there be?</span></span><br><span class="line">		clientOpts = <span class="built_in">append</span>(clientOpts, client.Selector(*c.opts.Selector))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Set the transport</span></span><br><span class="line">	<span class="keyword">if</span> name := ctx.String(<span class="string">&quot;transport&quot;</span>); <span class="built_in">len</span>(name) &gt; <span class="number">0</span> &amp;&amp; (*c.opts.Transport).String() != name &#123;</span><br><span class="line">		t, ok := c.opts.Transports[name]</span><br><span class="line">		<span class="keyword">if</span> !ok &#123;</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;Transport %s not found&quot;</span>, name)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		*c.opts.Transport = t()</span><br><span class="line">		serverOpts = <span class="built_in">append</span>(serverOpts, server.Transport(*c.opts.Transport))</span><br><span class="line">		clientOpts = <span class="built_in">append</span>(clientOpts, client.Transport(*c.opts.Transport))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Parse the server options</span></span><br><span class="line">	metadata := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>)</span><br><span class="line">	<span class="keyword">for</span> _, d := <span class="keyword">range</span> ctx.StringSlice(<span class="string">&quot;server_metadata&quot;</span>) &#123;</span><br><span class="line">		<span class="keyword">var</span> key, val <span class="type">string</span></span><br><span class="line">		parts := strings.Split(d, <span class="string">&quot;=&quot;</span>)</span><br><span class="line">		key = parts[<span class="number">0</span>]</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(parts) &gt; <span class="number">1</span> &#123;</span><br><span class="line">			val = strings.Join(parts[<span class="number">1</span>:], <span class="string">&quot;=&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		metadata[key] = val</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(metadata) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		serverOpts = <span class="built_in">append</span>(serverOpts, server.Metadata(metadata))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(ctx.String(<span class="string">&quot;broker_address&quot;</span>)) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> err := (*c.opts.Broker).Init(broker.Addrs(strings.Split(ctx.String(<span class="string">&quot;broker_address&quot;</span>), <span class="string">&quot;,&quot;</span>)...)); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Fatalf(<span class="string">&quot;Error configuring broker: %v&quot;</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(ctx.String(<span class="string">&quot;registry_address&quot;</span>)) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> err := (*c.opts.Registry).Init(registry.Addrs(strings.Split(ctx.String(<span class="string">&quot;registry_address&quot;</span>), <span class="string">&quot;,&quot;</span>)...)); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Fatalf(<span class="string">&quot;Error configuring registry: %v&quot;</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(ctx.String(<span class="string">&quot;transport_address&quot;</span>)) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> err := (*c.opts.Transport).Init(transport.Addrs(strings.Split(ctx.String(<span class="string">&quot;transport_address&quot;</span>), <span class="string">&quot;,&quot;</span>)...)); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Fatalf(<span class="string">&quot;Error configuring transport: %v&quot;</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(ctx.String(<span class="string">&quot;server_name&quot;</span>)) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		serverOpts = <span class="built_in">append</span>(serverOpts, server.Name(ctx.String(<span class="string">&quot;server_name&quot;</span>)))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(ctx.String(<span class="string">&quot;server_version&quot;</span>)) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		serverOpts = <span class="built_in">append</span>(serverOpts, server.Version(ctx.String(<span class="string">&quot;server_version&quot;</span>)))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(ctx.String(<span class="string">&quot;server_id&quot;</span>)) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		serverOpts = <span class="built_in">append</span>(serverOpts, server.Id(ctx.String(<span class="string">&quot;server_id&quot;</span>)))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(ctx.String(<span class="string">&quot;server_address&quot;</span>)) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		serverOpts = <span class="built_in">append</span>(serverOpts, server.Address(ctx.String(<span class="string">&quot;server_address&quot;</span>)))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(ctx.String(<span class="string">&quot;server_advertise&quot;</span>)) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		serverOpts = <span class="built_in">append</span>(serverOpts, server.Advertise(ctx.String(<span class="string">&quot;server_advertise&quot;</span>)))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ttl := time.Duration(ctx.GlobalInt(<span class="string">&quot;register_ttl&quot;</span>)); ttl &gt; <span class="number">0</span> &#123;</span><br><span class="line">		serverOpts = <span class="built_in">append</span>(serverOpts, server.RegisterTTL(ttl*time.Second))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> val := time.Duration(ctx.GlobalInt(<span class="string">&quot;register_interval&quot;</span>)); val &gt; <span class="number">0</span> &#123;</span><br><span class="line">		serverOpts = <span class="built_in">append</span>(serverOpts, server.RegisterInterval(val*time.Second))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// client opts</span></span><br><span class="line">	<span class="keyword">if</span> r := ctx.Int(<span class="string">&quot;client_retries&quot;</span>); r &gt;= <span class="number">0</span> &#123;</span><br><span class="line">		clientOpts = <span class="built_in">append</span>(clientOpts, client.Retries(r))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> t := ctx.String(<span class="string">&quot;client_request_timeout&quot;</span>); <span class="built_in">len</span>(t) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		d, err := time.ParseDuration(t)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to parse client_request_timeout: %v&quot;</span>, t)</span><br><span class="line">		&#125;</span><br><span class="line">		clientOpts = <span class="built_in">append</span>(clientOpts, client.RequestTimeout(d))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> r := ctx.Int(<span class="string">&quot;client_pool_size&quot;</span>); r &gt; <span class="number">0</span> &#123;</span><br><span class="line">		clientOpts = <span class="built_in">append</span>(clientOpts, client.PoolSize(r))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> t := ctx.String(<span class="string">&quot;client_pool_ttl&quot;</span>); <span class="built_in">len</span>(t) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		d, err := time.ParseDuration(t)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to parse client_pool_ttl: %v&quot;</span>, t)</span><br><span class="line">		&#125;</span><br><span class="line">		clientOpts = <span class="built_in">append</span>(clientOpts, client.PoolTTL(d))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// We have some command line opts for the server.</span></span><br><span class="line">	<span class="comment">// Lets set it up</span></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(serverOpts) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> err := (*c.opts.Server).Init(serverOpts...); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Fatalf(<span class="string">&quot;Error configuring server: %v&quot;</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Use an init option?</span></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(clientOpts) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> err := (*c.opts.Client).Init(clientOpts...); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Fatalf(<span class="string">&quot;Error configuring client: %v&quot;</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>cacheSelector  ä¼šæŠŠä»Registeré‡Œè·å–çš„ä¸»æœºä¿¡æ¯ç¼“å­˜èµ·æ¥ã€‚å¹¶è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œå¦‚æœè¶…æ—¶åˆ™é‡æ–°è·å–ã€‚åœ¨è·å–ä¸»æœºä¿¡æ¯çš„æ—¶å€™ä»–ä¼šå•ç‹¬è·‘ä¸€ä¸ªåç¨‹ï¼Œå»watchæœåŠ¡çš„æ³¨å†Œï¼Œå¦‚æœæœ‰æ–°èŠ‚ç‚¹å‘ç°ï¼Œåˆ™åŠ åˆ°ç¼“å­˜ä¸­ï¼Œå¦‚æœæœ‰èŠ‚ç‚¹æ•…éšœåˆ™åˆ é™¤ç¼“å­˜ä¸­çš„èŠ‚ç‚¹ä¿¡æ¯ã€‚å½“clientè¿˜è¦æ ¹æ®selectoré€‰æ‹©çš„ä¸»æœºé€‰æ‹©ç®—æ³•æ‰èƒ½å¾—åˆ°ä¸»æœºä¿¡æ¯ï¼Œç›®å‰åªæœ‰ä¸¤ç§ç®—æ³•ï¼Œå¾ªç¯å’Œéšæœºæ³•ã€‚ä¸ºäº†å¢åŠ æ‰§è¡Œæ•ˆç‡ï¼Œå¾ˆclientç«¯ä¹Ÿä¼šè®¾ç½®ç¼“å­˜è¿æ¥æ± ï¼Œè¿™ä¸ªç‚¹ï¼Œä»¥åä¼šè¯¦ç»†è¯´ã€‚</p>
<p>æ‰€ä»¥å¤§æ¦‚çš„å®¢æˆ·ç«¯æœåŠ¡å‘ç°æµç¨‹æ˜¯ä¸‹é¢è¿™æ ·</p>
<p><img src="https://raw.githubusercontents.com/wangyyovo/CDN/master/blog/microserive/2019-go-micro-9.png" alt="img"></p>
<p>ä¸»è¦çš„è°ƒç”¨è¿‡ç¨‹éƒ½åœ¨Callæ–¹æ³•å†…</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *rpcClient)</span></span> Call(ctx context.Context, request Request, response <span class="keyword">interface</span>&#123;&#125;, opts ...CallOption) <span class="type">error</span> &#123;</span><br><span class="line">	<span class="comment">// make a copy of call opts</span></span><br><span class="line">	callOpts := r.opts.CallOptions</span><br><span class="line">	<span class="keyword">for</span> _, opt := <span class="keyword">range</span> opts &#123;</span><br><span class="line">		opt(&amp;callOpts)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	next, err := r.next(request, callOpts)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// check if we already have a deadline</span></span><br><span class="line">	d, ok := ctx.Deadline()</span><br><span class="line">	<span class="keyword">if</span> !ok &#123;</span><br><span class="line">		<span class="comment">// no deadline so we create a new one</span></span><br><span class="line">		ctx, _ = context.WithTimeout(ctx, callOpts.RequestTimeout)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// got a deadline so no need to setup context</span></span><br><span class="line">		<span class="comment">// but we need to set the timeout we pass along</span></span><br><span class="line">		opt := WithRequestTimeout(d.Sub(time.Now()))</span><br><span class="line">		opt(&amp;callOpts)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// should we noop right here?</span></span><br><span class="line">	<span class="keyword">select</span> &#123;</span><br><span class="line">	<span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">		<span class="keyword">return</span> errors.Timeout(<span class="string">&quot;go.micro.client&quot;</span>, fmt.Sprintf(<span class="string">&quot;%v&quot;</span>, ctx.Err()))</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// make copy of call method</span></span><br><span class="line">	rcall := r.call</span><br><span class="line"></span><br><span class="line">	<span class="comment">// wrap the call in reverse</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="built_in">len</span>(callOpts.CallWrappers); i &gt; <span class="number">0</span>; i-- &#123;</span><br><span class="line">		rcall = callOpts.CallWrappers[i<span class="number">-1</span>](rcall)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// return errors.New(&quot;go.micro.client&quot;, &quot;request timeout&quot;, 408)</span></span><br><span class="line">	call := <span class="function"><span class="keyword">func</span><span class="params">(i <span class="type">int</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">		<span class="comment">// call backoff first. Someone may want an initial start delay</span></span><br><span class="line">		t, err := callOpts.Backoff(ctx, request, i)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> errors.InternalServerError(<span class="string">&quot;go.micro.client&quot;</span>, <span class="string">&quot;backoff error: %v&quot;</span>, err.Error())</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// only sleep if greater than 0</span></span><br><span class="line">		<span class="keyword">if</span> t.Seconds() &gt; <span class="number">0</span> &#123;</span><br><span class="line">			time.Sleep(t)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// select next node</span></span><br><span class="line">		node, err := next()</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &amp;&amp; err == selector.ErrNotFound &#123;</span><br><span class="line">			<span class="keyword">return</span> errors.NotFound(<span class="string">&quot;go.micro.client&quot;</span>, <span class="string">&quot;service %s: %v&quot;</span>, request.Service(), err.Error())</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> errors.InternalServerError(<span class="string">&quot;go.micro.client&quot;</span>, <span class="string">&quot;error getting next %s node: %v&quot;</span>, request.Service(), err.Error())</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// make the call</span></span><br><span class="line">		err = rcall(ctx, node, request, response, callOpts)</span><br><span class="line">		r.opts.Selector.Mark(request.Service(), node, err)</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">error</span>, callOpts.Retries+<span class="number">1</span>)</span><br><span class="line">	<span class="keyword">var</span> gerr <span class="type">error</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt;= callOpts.Retries; i++ &#123;</span><br><span class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(i <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">			ch &lt;- call(i)</span><br><span class="line">		&#125;(i)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">			<span class="keyword">return</span> errors.Timeout(<span class="string">&quot;go.micro.client&quot;</span>, fmt.Sprintf(<span class="string">&quot;call timeout: %v&quot;</span>, ctx.Err()))</span><br><span class="line">		<span class="keyword">case</span> err := &lt;-ch:</span><br><span class="line">			<span class="comment">// if the call succeeded lets bail early</span></span><br><span class="line">			<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			retry, rerr := callOpts.Retry(ctx, request, i, err)</span><br><span class="line">			<span class="keyword">if</span> rerr != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> rerr</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> !retry &#123;</span><br><span class="line">				<span class="keyword">return</span> err</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			gerr = err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> gerr</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸»è¦çš„æ€è·¯æ˜¯</p>
<ol>
<li><p>ä»Selectoré‡Œå¾—åˆ°é€‰æ‹©ä¸»æœºç­–ç•¥æ–¹æ³•nextã€‚</p>
</li>
<li><p>æ ¹æ®Retoryæ˜¯å¦é‡è¯•è°ƒç”¨æœåŠ¡ï¼Œè°ƒç”¨æœåŠ¡çš„è¿‡ç¨‹æ˜¯ï¼Œä»next æ–¹æ³•å†…å¾—åˆ°ä¸»æœºï¼Œè¿æ¥å¹¶ä¼ è¾“æ•°æ® ï¼Œå¦‚æœå¤±è´¥åˆ™é‡è¯•ï¼Œé‡è¯•æ—¶ï¼Œä¼šæ ¹æ®ä¸»æœºé€‰æ‹©ç­–ç•¥æ–¹æ³•nexté‡æ–°å¾—åˆ°ä¸€ä¸ªæ–°çš„ä¸»æœºè¿›è¡Œæ“ä½œã€‚</p>
</li>
</ol>
<h2 id="4-rpcæ–¹æ³•è°ƒç”¨è¿‡ç¨‹è¯¦è§£"><a href="#4-rpcæ–¹æ³•è°ƒç”¨è¿‡ç¨‹è¯¦è§£" class="headerlink" title="4.rpcæ–¹æ³•è°ƒç”¨è¿‡ç¨‹è¯¦è§£"></a>4.rpcæ–¹æ³•è°ƒç”¨è¿‡ç¨‹è¯¦è§£</h2><p>ä¸Šä¸€ç¯‡å¸–å­<a target="_blank" rel="noopener" href="https://www.cnblogs.com/li-peng/p/9689786.html">goå¾®æœåŠ¡æ¡†æ¶go-microæ·±åº¦å­¦ä¹ (ä¸‰) RegistryæœåŠ¡çš„æ³¨å†Œå’Œå‘ç°è¯¦</a>ç»†è§£é‡Šäº†go-microæ˜¯å¦‚ä½•åšæœåŠ¡æ³¨å†Œå’Œå‘ç°åœ¨ï¼ŒæœåŠ¡ç«¯æ³¨å†Œserverä¿¡æ¯ï¼Œclientè·å–serverçš„åœ°å€ä¿¡æ¯ï¼Œå°±å¯ä»¥å’ŒæœåŠ¡å»ºç«‹è¿æ¥ï¼Œç„¶åå°±å¯ä»¥è¿›è¡Œé€šä¿¡äº†ã€‚è¿™ç¯‡å¸–å­è¯¦ç»†è¯´ä¸€ä¸‹ï¼Œgo-microçš„é€šä¿¡åè®®ã€ç¼–ç ï¼Œå’Œå…·ä½“æœåŠ¡æ–¹æ³•çš„è°ƒç”¨è¿‡ç¨‹æ˜¯å¦‚ä½•å®ç°çš„ï¼Œæ–‡ä¸­çš„ä»£ç è¿˜æ˜¯æˆ‘githubä¸Šçš„ä¾‹å­ï¼š <a target="_blank" rel="noopener" href="https://github.com/lpxxn/gomicrorpc">gomicrorpc</a></p>
<p>go-micro  æ”¯æŒå¾ˆå¤šé€šä¿¡åè®®ï¼šhttpã€tcpã€grpcç­‰ï¼Œæ”¯æŒçš„ç¼–ç æ–¹å¼ä¹Ÿå¾ˆå¤šæœ‰jsonã€protobufã€bytesã€jsonrpcç­‰ã€‚ä¹Ÿå¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€è¦å®ç°é€šä¿¡åè®®å’Œç¼–ç æ–¹å¼ã€‚go-micro  é»˜è®¤çš„é€šä¿¡åè®®æ˜¯httpï¼Œé»˜è®¤çš„ç¼–ç æ–¹å¼æ˜¯protobufï¼Œæˆ‘å°±ä»¥é»˜è®¤çš„æ–¹å¼æ¥åˆ†è§£ä»–çš„å…·ä½“å®ç°ã€‚</p>
<p><img src="https://raw.githubusercontents.com/wangyyovo/CDN/master/blog/microserive/2019-go-micro-10.png" alt="img"></p>
<h3 id="æœåŠ¡çš„å¯åŠ¨"><a href="#æœåŠ¡çš„å¯åŠ¨" class="headerlink" title="æœåŠ¡çš„å¯åŠ¨"></a>æœåŠ¡çš„å¯åŠ¨</h3><p>go-microåœ¨å¯åŠ¨çš„æ—¶å€™ä¼šé€‰æ‹©é»˜è®¤é€šä¿¡åè®®httpå’Œprotobufç¼–ç æ–¹å¼ï¼Œä½†ä»–æ˜¯å¦‚ä½•è·¯ç”±åˆ°å…·ä½“æ–¹æ³•çš„ï¼Ÿåœ¨go-microæœåŠ¡ç«¯å¯åŠ¨çš„æ—¶å€™æˆ‘ä»¬éœ€è¦æ³¨å†ŒHandlerï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å…·ä½“å®ç°ç»“æ„ä½“  ï¼Œå¦‚ä¾‹å­ä¸­æ³¨å†Œæ–¹æ³•æ—¶ï¼Œæˆ‘ä»¬è°ƒç”¨çš„RegisterSayHandleræ–¹æ³•</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ³¨å†Œ Handler</span></span><br><span class="line">rpcapi.RegisterSayHandler(service.Server(), <span class="built_in">new</span>(handler.Say))</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªæ–¹æ³•å†…éƒ¨çš„ä½“å®ç°ä¸»è¦æ˜¯åˆ©ç”¨äº†åå°„çš„åŠ›é‡ï¼Œæ³¨å†Œçš„å¯¹è±¡æ˜¯å®ç°äº†rpcæ¥å£çš„æ–¹æ³•ï¼Œå¦‚æˆ‘ä»¬çš„Sayå®ç°äº†SayHandlerã€‚go-microé»˜è®¤çš„routerä¼šåˆ©ç”¨åå°„æŠŠSayå¯¹è±¡çš„ä¿¡æ¯å®Œå…¨æå–å‡ºæ¥ï¼Œè§£æå‡ºç»“æ„ä½“å†…çš„æ–¹æ³•åŠæ–¹æ³•çš„å‚æ•°ï¼Œä¿å­˜åˆ°ä¸€ä¸ªmapå†…-&gt;  <code>map[ç»“æ„ä½“åç§°][æ–¹æ³•ä¿¡æ¯é›†åˆ]</code></p>
<p>å…·ä½“çš„å®ç°åœ¨rpc_router.goé‡Œrouterçš„Handle(Handler)æ–¹æ³•ï¼Œç»„ç»‡å®Œæˆåmapçš„æ˜¯ä¸‹å›¾è¿™æ ·ï¼Œä¿å­˜äº†å¾ˆå¤šåå°„ä¿¡æ¯ï¼Œç”¨ä»¥å°†æ¥è°ƒç”¨ã€‚ </p>
<p>ä¸‹é¢æ˜¯è¿™ä¸ªæ–¹æ³•çš„ä¸»è¦ä»£ç ï¼Œåˆ é™¤äº†ä¸€äº›ï¼Œå¾ˆå¸Œæœ›å¤§å®¶è¯»ä¸€ä¸‹rpc_router.goé‡Œé¢çš„ä»£ç ï¼ŒprepareMethodæ–¹æ³•æ˜¯å…·ä½“åˆ©ç”¨åå°„æå–ä¿¡æ¯çš„æ–¹æ³•ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(router *router)</span></span> Handle(h Handler) <span class="type">error</span> &#123;</span><br><span class="line">    router.mu.Lock()</span><br><span class="line">    <span class="keyword">defer</span> router.mu.Unlock()</span><br><span class="line">    <span class="comment">// ....</span></span><br><span class="line"></span><br><span class="line">    rcvr := h.Handler()</span><br><span class="line">    s := <span class="built_in">new</span>(service)</span><br><span class="line">    s.typ = reflect.TypeOf(rcvr)</span><br><span class="line">    s.rcvr = reflect.ValueOf(rcvr)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// check name</span></span><br><span class="line">        <span class="comment">// ....</span></span><br><span class="line">    s.name = h.Name()</span><br><span class="line">    s.method = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]*methodType)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Install the methods</span></span><br><span class="line">    <span class="keyword">for</span> m := <span class="number">0</span>; m &lt; s.typ.NumMethod(); m++ &#123;</span><br><span class="line">        method := s.typ.Method(m)</span><br><span class="line">                <span class="comment">// prepareMethodä¼šæŠŠæ‰€æœ‰è§£æçš„ä¿¡æ¯è¿”å›æ¥</span></span><br><span class="line">        <span class="keyword">if</span> mt := prepareMethod(method); mt != <span class="literal">nil</span> &#123;</span><br><span class="line">            s.method[method.Name] = mt</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">        <span class="comment">// .....</span></span><br><span class="line">    <span class="comment">// save handler</span></span><br><span class="line">    router.serviceMap[s.name] = s</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>serviceMapé‡Œä¿å­˜çš„å°±æ˜¯åå°„åçš„ä¿¡æ¯ï¼Œä¸‹å›¾æ˜¯æˆ‘ç”¨golandçš„debugå¾—åˆ°çš„ä¿å­˜ä¿¡æ¯ </p>
<p><img src="https://raw.githubusercontents.com/wangyyovo/CDN/master/blog/microserive/2019-go-micro-14.png" alt="img"></p>
<p>è·¯ç”±ä¿¡æ¯å¤„ç†å®Œåï¼Œä¸»è¦çš„å·¥ä½œå°±å·²ç»å®Œæˆäº†ï¼Œç„¶åæ³¨å†ŒæœåŠ¡å¹¶å¯åŠ¨æœåŠ¡ï¼Œå¯åŠ¨çš„æœåŠ¡æ˜¯ä¸€ä¸ªhttpçš„æœåŠ¡ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹http_transport.goé‡Œçš„ä»£ç  </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *httpTransportListener)</span></span> Accept(fn <span class="function"><span class="keyword">func</span><span class="params">(Socket)</span></span>) <span class="type">error</span> &#123;</span><br><span class="line">	<span class="comment">// create handler mux</span></span><br><span class="line">	mux := http.NewServeMux()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// register our transport handler</span></span><br><span class="line">	mux.HandleFunc(<span class="string">&quot;/&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">		<span class="keyword">var</span> buf *bufio.ReadWriter</span><br><span class="line">		<span class="keyword">var</span> con net.Conn</span><br><span class="line"></span><br><span class="line">		<span class="comment">// read a regular request</span></span><br><span class="line">		<span class="keyword">if</span> r.ProtoMajor == <span class="number">1</span> &#123;</span><br><span class="line">			b, err := ioutil.ReadAll(r.Body)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				http.Error(w, err.Error(), http.StatusInternalServerError)</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line">			r.Body = ioutil.NopCloser(bytes.NewReader(b))</span><br><span class="line">			<span class="comment">// hijack the conn</span></span><br><span class="line">			hj, ok := w.(http.Hijacker)</span><br><span class="line">			<span class="keyword">if</span> !ok &#123;</span><br><span class="line">				<span class="comment">// we&#x27;re screwed</span></span><br><span class="line">				http.Error(w, <span class="string">&quot;cannot serve conn&quot;</span>, http.StatusInternalServerError)</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			conn, bufrw, err := hj.Hijack()</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				http.Error(w, err.Error(), http.StatusInternalServerError)</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">defer</span> conn.Close()</span><br><span class="line">			buf = bufrw</span><br><span class="line">			con = conn</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// save the request</span></span><br><span class="line">		ch := <span class="built_in">make</span>(<span class="keyword">chan</span> *http.Request, <span class="number">1</span>)</span><br><span class="line">		ch &lt;- r</span><br><span class="line"></span><br><span class="line">		fn(&amp;httpTransportSocket&#123;</span><br><span class="line">			ht:     h.ht,</span><br><span class="line">			w:      w,</span><br><span class="line">			r:      r,</span><br><span class="line">			rw:     buf,</span><br><span class="line">			ch:     ch,</span><br><span class="line">			conn:   con,</span><br><span class="line">			local:  h.Addr(),</span><br><span class="line">			remote: r.RemoteAddr,</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// get optional handlers</span></span><br><span class="line">	<span class="keyword">if</span> h.ht.opts.Context != <span class="literal">nil</span> &#123;</span><br><span class="line">		handlers, ok := h.ht.opts.Context.Value(<span class="string">&quot;http_handlers&quot;</span>).(<span class="keyword">map</span>[<span class="type">string</span>]http.Handler)</span><br><span class="line">		<span class="keyword">if</span> ok &#123;</span><br><span class="line">			<span class="keyword">for</span> pattern, handler := <span class="keyword">range</span> handlers &#123;</span><br><span class="line">				mux.Handle(pattern, handler)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// default http2 server</span></span><br><span class="line">	srv := &amp;http.Server&#123;</span><br><span class="line">		Handler: mux,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// insecure connection use h2c</span></span><br><span class="line">	<span class="keyword">if</span> !(h.ht.opts.Secure || h.ht.opts.TLSConfig != <span class="literal">nil</span>) &#123;</span><br><span class="line">		srv.Handler = h2c.NewHandler(mux, &amp;http2.Server&#123;&#125;)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// begin serving</span></span><br><span class="line">	<span class="keyword">return</span> srv.Serve(h.listener)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœåŠ¡çš„ç®€å•æµç¨‹å›¾å¦‚ä¸‹ ï¼Œé€‰æ‹©é€šä¿¡åè®®å’Œç¼–ç æ–¹å¼-&gt;æ³¨å†ŒæœåŠ¡æ–¹æ³•-&gt;å¯åŠ¨æœåŠ¡å¹¶æ³¨å†ŒæœåŠ¡ä¿¡æ¯</p>
<p><img src="https://raw.githubusercontents.com/wangyyovo/CDN/master/blog/microserive/2019-go-micro-11.png" alt="img"></p>
<h3 id="å®¢æˆ·ç«¯è°ƒç”¨æœåŠ¡æ–¹æ³•"><a href="#å®¢æˆ·ç«¯è°ƒç”¨æœåŠ¡æ–¹æ³•" class="headerlink" title="å®¢æˆ·ç«¯è°ƒç”¨æœåŠ¡æ–¹æ³•"></a>å®¢æˆ·ç«¯è°ƒç”¨æœåŠ¡æ–¹æ³•</h3><p>å®¢æˆ·ç«¯åœ¨å¯åŠ¨çš„æ—¶å€™ä¹Ÿè¦é€‰æ‹©é»˜è®¤çš„é€šä¿¡åè®®httpï¼Œå’Œprotobufç¼–ç ã€‚å®¢æˆ·ç«¯åœ¨è°ƒç”¨rpcæ–¹æ³•çš„æ—¶å€™å¦‚ï¼š </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsp, err := client.Hello(context.Background(), &amp;model.SayParam&#123;Msg: <span class="string">&quot;hello server&quot;</span>&#125;)</span><br></pre></td></tr></table></figure>

<p>go-microä¸ºæˆ‘ä»¬è‡ªåŠ¨ç”Ÿæˆçš„rpcapi.micro.goé‡Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸ŠHelloçš„å…·ä½“å®ç°ï¼Œæ²¡æœ‰å‡ è¡Œä»£ç ï¼Œä½†å†…éƒ¨è¿˜æ˜¯åšäº†å¾ˆå¤šå·¥ä½œ</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *sayService)</span></span> Hello(ctx context.Context, in *model.SayParam, opts ...client.CallOption) (*model.SayResponse, <span class="type">error</span>) &#123;</span><br><span class="line">   req := c.c.NewRequest(c.name, <span class="string">&quot;Say.Hello&quot;</span>, in)</span><br><span class="line">   out := <span class="built_in">new</span>(model.SayResponse)</span><br><span class="line">   err := c.c.Call(ctx, req, out, opts...)</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> out, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»–çš„å®ç°æ–¹å¼æ˜¯å°è£…requestï¼Œç„¶åè°ƒç”¨æœåŠ¡æ–¹æ³•ã€‚è¿™ä¸ªrequest æ˜¯éå¸¸é‡è¦çš„ï¼š </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newRequest</span><span class="params">(service, endpoint <span class="type">string</span>, request <span class="keyword">interface</span>&#123;&#125;, contentType <span class="type">string</span>, reqOpts ...RequestOption)</span></span> Request &#123;</span><br><span class="line">    <span class="keyword">var</span> opts RequestOptions</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> _, o := <span class="keyword">range</span> reqOpts &#123;</span><br><span class="line">        o(&amp;opts)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// set the content-type specified</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(opts.ContentType) &gt; <span class="number">0</span> &#123;</span><br><span class="line">        contentType = opts.ContentType</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &amp;rpcRequest&#123;</span><br><span class="line">        service:     service,</span><br><span class="line">        method:      endpoint,</span><br><span class="line">        endpoint:    endpoint,</span><br><span class="line">        body:        request,</span><br><span class="line">        contentType: contentType,</span><br><span class="line">        opts:        opts,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªæ–¹æ³•è¿”å›ä¸€ä¸ªrpcRequesté‡Œé¢åŒ…å«äº†è¯¦ç»†çš„è°ƒç”¨ä¿¡æ¯ï¼Œservicecï¼šæœåŠ¡åï¼Œmethodå’Œendpointç›®å‰æ˜¯ä¸€æ ·çš„æ˜¯æ–¹æ³•åè¿™é‡Œæ˜¯Say.Helloï¼ŒcontentTypeæ˜¯protobufï¼Œbody   æ˜¯å…·ä½“çš„ä¿¡æ¯ï¼Œä¹Ÿè¦è¦è¿›è¡Œç¼–ç çš„å†…å®¹ï¼Œä½¿ç”¨protobufè¿›è¡Œç¼–ç ï¼Œç„¶åä¼šæŠŠè¿™äº›ä¿¡æ¯æ”¾åˆ°ä¸€ä¸ªhttp.Requesté‡Œï¼Œå†ä»Registeræˆ–è€…ä»ç¼“å­˜è·å–æœåŠ¡å™¨ä¿¡æ¯ï¼Œè¿æ¥æœåŠ¡å™¨ï¼Œå‘é€æ•°æ®ã€‚ </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *httpTransportClient)</span></span> Send(m *Message) <span class="type">error</span> &#123;</span><br><span class="line">	header := <span class="built_in">make</span>(http.Header)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> k, v := <span class="keyword">range</span> m.Header &#123;</span><br><span class="line">		header.Set(k, v)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	reqB := bytes.NewBuffer(m.Body)</span><br><span class="line">	<span class="keyword">defer</span> reqB.Reset()</span><br><span class="line">	buf := &amp;buffer&#123;</span><br><span class="line">		reqB,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	req := &amp;http.Request&#123;</span><br><span class="line">		Method: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">		URL: &amp;url.URL&#123;</span><br><span class="line">			Scheme: <span class="string">&quot;http&quot;</span>,</span><br><span class="line">			Host:   h.addr,</span><br><span class="line">		&#125;,</span><br><span class="line">		Header:        header,</span><br><span class="line">		Body:          buf,</span><br><span class="line">		ContentLength: <span class="type">int64</span>(reqB.Len()),</span><br><span class="line">		Host:          h.addr,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	h.Lock()</span><br><span class="line">	h.bl = <span class="built_in">append</span>(h.bl, req)</span><br><span class="line">	<span class="keyword">select</span> &#123;</span><br><span class="line">	<span class="keyword">case</span> h.r &lt;- h.bl[<span class="number">0</span>]:</span><br><span class="line">		h.bl = h.bl[<span class="number">1</span>:]</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">	&#125;</span><br><span class="line">	h.Unlock()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// set timeout if its greater than 0</span></span><br><span class="line">	<span class="keyword">if</span> h.ht.opts.Timeout &gt; time.Duration(<span class="number">0</span>) &#123;</span><br><span class="line">		h.conn.SetDeadline(time.Now().Add(h.ht.opts.Timeout))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> req.Write(h.conn)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç®€å•æµç¨‹å›¾å¦‚ä¸‹</p>
<p>clientï¼šå°è£…å‚æ•°-&gt; ç¼–ç æ•°æ®-&gt;è¿æ¥æœåŠ¡-&gt;å‘é€æ•°æ®-&gt;æ¥æ”¶è¿”å›æ•°æ®ï¼Œå¹¶è§£ç ã€‚</p>
<p>service: æ¥æ”¶æ•°æ®-&gt;è§£ç æ•°æ®ï¼Œæ‰¾åˆ°ç›¸åº”çš„å®ä¾‹å’Œæ–¹æ³•ï¼Œåˆ©ç”¨åå°„è°ƒç”¨å…·ä½“æ–¹æ³•-&gt;ç¼–ç è¿”æ•°æ®-&gt;å‘é€ç»™å®¢æˆ·ç«¯ã€‚</p>
<p><img src="https://raw.githubusercontents.com/wangyyovo/CDN/master/blog/microserive/2019-go-micro-12.png" alt="img"></p>
<h3 id="æœåŠ¡ç«¯å¤„ç†è¯·æ±‚"><a href="#æœåŠ¡ç«¯å¤„ç†è¯·æ±‚" class="headerlink" title="æœåŠ¡ç«¯å¤„ç†è¯·æ±‚"></a>æœåŠ¡ç«¯å¤„ç†è¯·æ±‚</h3><p>å½“æœåŠ¡ç«¯ç›‘æ¥æ”¶åˆ°æ•°æ®åï¼Œä»httpçš„Requesté‡Œçš„Headerä¸­è¯»å–åˆ°ç›¸åº”çš„ä¿¡æ¯ï¼šç¼–ç æ–¹å¼ï¼Œendpointï¼Œè¯·æ±‚çš„æ•°æ®ï¼Œç”±è·¯ç”±å™¨è¿›è¡Œå¯¹æ¯”å’ŒåŒ¹é…æ‰¾åˆ°ä¿å­˜çš„åå°„ä¿¡æ¯ï¼Œåˆ©ç”¨åå°„æŠŠè¯·æ±‚çš„æ•°æ®æ ¹æ®ç›¸åº”çš„ç¼–ç æ–¹å¼è¿›è¡Œè§£ç ï¼Œå†åˆ©ç”¨åå°„è°ƒç”¨å…·ä½“çš„æ–¹æ³•ï¼Œå¤„ç†å®ŒæŠŠè¿”å›æ•°æ®è¿›è¡Œç¼–ç ï¼Œç»„ç»‡ä¸€ä¸ªhttp.Responseä¼ è¾“ç»™ç”¨æˆ·ï¼Œå®¢æˆ·ç«¯æ¥æ”¶åˆ°æ•°æ®åè¿›è¡Œè§£ç è¯»å–æ•°æ®ã€‚  rpc_router.goé‡Œçš„callæ–¹æ³•å°±æ˜¯å…·ä½“çš„è°ƒç”¨è¿‡ç¨‹æ–¹æ³•ï¼Œæœ‰æ—¶é—´å¤§å®¶å¯ä»¥è¯»ä¸€ä¸‹ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *service)</span></span> call(ctx context.Context, router *router, sending *sync.Mutex, mtype *methodType, req *request, argv, replyv reflect.Value, cc codec.Writer) <span class="type">error</span> &#123;</span><br><span class="line">	<span class="keyword">defer</span> router.freeRequest(req)</span><br><span class="line"></span><br><span class="line">	function := mtype.method.Func</span><br><span class="line">	<span class="keyword">var</span> returnValues []reflect.Value</span><br><span class="line"></span><br><span class="line">	r := &amp;rpcRequest&#123;</span><br><span class="line">		service:     req.msg.Target,</span><br><span class="line">		contentType: req.msg.Header[<span class="string">&quot;Content-Type&quot;</span>],</span><br><span class="line">		method:      req.msg.Method,</span><br><span class="line">		endpoint:    req.msg.Endpoint,</span><br><span class="line">		body:        req.msg.Body,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// only set if not nil</span></span><br><span class="line">	<span class="keyword">if</span> argv.IsValid() &#123;</span><br><span class="line">		r.rawBody = argv.Interface()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> !mtype.stream &#123;</span><br><span class="line">		fn := <span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context, req Request, rsp <span class="keyword">interface</span>&#123;&#125;)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">			returnValues = function.Call([]reflect.Value&#123;s.rcvr, mtype.prepareContext(ctx), reflect.ValueOf(argv.Interface()), reflect.ValueOf(rsp)&#125;)</span><br><span class="line"></span><br><span class="line">			<span class="comment">// The return value for the method is an error.</span></span><br><span class="line">			<span class="keyword">if</span> err := returnValues[<span class="number">0</span>].Interface(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> err.(<span class="type">error</span>)</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// wrap the handler</span></span><br><span class="line">		<span class="keyword">for</span> i := <span class="built_in">len</span>(router.hdlrWrappers); i &gt; <span class="number">0</span>; i-- &#123;</span><br><span class="line">			fn = router.hdlrWrappers[i<span class="number">-1</span>](fn)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// execute handler</span></span><br><span class="line">		<span class="keyword">if</span> err := fn(ctx, r, replyv.Interface()); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// send response</span></span><br><span class="line">		<span class="keyword">return</span> router.sendResponse(sending, req, replyv.Interface(), cc, <span class="literal">true</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// declare a local error to see if we errored out already</span></span><br><span class="line">	<span class="comment">// keep track of the type, to make sure we return</span></span><br><span class="line">	<span class="comment">// the same one consistently</span></span><br><span class="line">	rawStream := &amp;rpcStream&#123;</span><br><span class="line">		context: ctx,</span><br><span class="line">		codec:   cc.(codec.Codec),</span><br><span class="line">		request: r,</span><br><span class="line">		id:      req.msg.Id,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Invoke the method, providing a new value for the reply.</span></span><br><span class="line">	fn := <span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context, req Request, stream <span class="keyword">interface</span>&#123;&#125;)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">		returnValues = function.Call([]reflect.Value&#123;s.rcvr, mtype.prepareContext(ctx), reflect.ValueOf(stream)&#125;)</span><br><span class="line">		<span class="keyword">if</span> err := returnValues[<span class="number">0</span>].Interface(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="comment">// the function returned an error, we use that</span></span><br><span class="line">			<span class="keyword">return</span> err.(<span class="type">error</span>)</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> serr := rawStream.Error(); serr == io.EOF || serr == io.ErrUnexpectedEOF &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">// no error, we send the special EOS error</span></span><br><span class="line">			<span class="keyword">return</span> lastStreamResponseError</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// wrap the handler</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="built_in">len</span>(router.hdlrWrappers); i &gt; <span class="number">0</span>; i-- &#123;</span><br><span class="line">		fn = router.hdlrWrappers[i<span class="number">-1</span>](fn)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// client.Stream request</span></span><br><span class="line">	r.stream = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// execute handler</span></span><br><span class="line">	<span class="keyword">return</span> fn(ctx, r, rawStream)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="5-stream-è°ƒç”¨è¿‡ç¨‹è¯¦è§£"><a href="#5-stream-è°ƒç”¨è¿‡ç¨‹è¯¦è§£" class="headerlink" title="5.stream è°ƒç”¨è¿‡ç¨‹è¯¦è§£"></a>5.stream è°ƒç”¨è¿‡ç¨‹è¯¦è§£</h2><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/li-peng/p/10365251.html">ä¸Šä¸€ç¯‡å†™äº†ä¸€ä¸‹rpcè°ƒç”¨è¿‡ç¨‹çš„å®ç°æ–¹å¼</a>ï¼Œç®€å•æ¥è¯´å°±æ˜¯æœåŠ¡ç«¯æŠŠå®ç°äº†æ¥å£çš„ç»“æ„ä½“å¯¹è±¡è¿›è¡Œåå°„ï¼ŒæŠ½å–æ–¹æ³•ï¼Œç­¾åï¼Œä¿å­˜ï¼Œå®¢æˆ·ç«¯è°ƒç”¨çš„æ—¶å€™go-microå°è¯·æ±‚æ•°æ®ï¼ŒæœåŠ¡ç«¯æ¥æ”¶åˆ°è¯·æ±‚æ—¶ï¼Œæ‰¾åˆ°éœ€è¦è°ƒç”¨è°ƒç”¨çš„å¯¹è±¡å’Œå¯¹åº”çš„æ–¹æ³•ï¼Œåˆ©ç”¨åå°„è¿›è¡Œè°ƒç”¨ï¼Œè¿”å›æ•°æ®ã€‚   ä½†æ˜¯æ²¡æœ‰è¯´streamçš„å®ç°æ–¹å¼ï¼Œæ„Ÿè§‰å•ç‹¬å†™ä¸€ç¯‡å¸–å­æ¥è¯´è¿™ä¸ªæ›´å¥½ä¸€äº›ã€‚ä¸Šä¸€ç¯‡å¸–å­æ˜¯åŸºç¡€ï¼Œç†è§£äº†ä¸Šä¸€ç¯‡ï¼Œstreamå®ç°åŸç†ä¸€ç‚¹å³ç ´ã€‚å…ˆè¯´ä¸€ä¸‹ä½¿ç”¨æ–¹å¼ï¼Œå†è¯´åŸç†ã€‚<br>å½“å‰go-microå¯¹ rpc è°ƒç”¨çš„æ–¹å¼å¤§æ¦‚å¦‚ä¸‹ï¼š<br>æ™®é€šçš„rpcè°ƒç”¨ æ˜¯è¿™æ ·ï¼š</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1.è¿æ¥æœåŠ¡å™¨æˆ–è€…ä»ç¼“å­˜æ± å¾—åˆ°è¿æ¥</span><br><span class="line">2.å®¢æˆ·ç«¯ -&gt;å‘é€æ•°æ® -&gt; æœåŠ¡ç«¯æ¥æ”¶</span><br><span class="line">3.æœåŠ¡ç«¯ -&gt;è¿”å›æ•°æ® -&gt; å®¢æˆ·ç«¯å¤„ç†æ•°æ®</span><br><span class="line">4.å…³é—­è¿æ¥æˆ–è€…æŠŠè¿æ¥è¿”å›åˆ°ç¼“å­˜æ± </span><br></pre></td></tr></table></figure>

<p>å½“å‰ rps streamçš„å®ç°æ–¹å¼ æ˜¯è¿™æ ·å­:</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. è¿æ¥æœåŠ¡å™¨</span><br><span class="line">2. å®¢æˆ·ç«¯å¤šæ¬¡å‘é€è¯·æ±‚-&gt; æœåŠ¡ç«¯æ¥æ”¶</span><br><span class="line">3. æœåŠ¡ç«¯å¤šæ¬¡è¿”å›æ•°æ®-&gt; å®¢æˆ·ç«¯å¤„ç†æ•°æ®</span><br><span class="line">4. å…³é—­è¿æ¥</span><br></pre></td></tr></table></figure>

<p>å½“æ•°æ®é‡æ¯”è¾ƒå¤§çš„æ—¶å€™æˆ‘ä»¬å¯ä»¥ç”¨streamæ–¹å¼åˆ†æ‰¹æ¬¡ä¼ è¾“æ•°æ®ã€‚å¯¹äºå®¢æˆ·ç«¯è¿˜æ˜¯æœåŠ¡ç«¯æ²¡æœ‰é™åˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€è¦ä½¿ç”¨streamæ–¹å¼ï¼Œä½¿ç”¨æ–¹å¼ä¹Ÿéå¸¸çš„ç®€å•ï¼Œåœ¨å®šä¹‰æ¥å£çš„æ—¶å€™åœ¨å‚æ•°æˆ–è€…è¿”å›å€¼å‰é¢åŠ ä¸Šstreamç„¶åå°±å¯ä»¥å¤šæ¬¡è¿›è¡Œä¼ è¾“äº†ï¼Œä½¿ç”¨çš„ä»£ç è¿˜æ˜¯ä¹‹å‰å†™çš„ä¾‹å­,ä»£ç éƒ½åœ¨githubä¸Šï¼š<br>æ¯”å¦‚æˆ‘çš„ä¾‹å­ä¸­å®šä¹‰äº†ä¸¤ä¸ªä½¿ç”¨streamçš„æ¥å£ï¼Œä¸€ä¸ªåªåœ¨è¿”å›å€¼ä½¿ç”¨streamï¼Œå¦ä¸€ä¸ªæ˜¯åœ¨å‚æ•°å’Œè¿”å›å€¼å‰éƒ½åŠ ä¸Šäº†streamï¼Œæœ€ç»ˆçš„ä½¿ç”¨æ–¹å¼æ²¡æœ‰åŒºåˆ«</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">rpc</span> Stream(model.SRequest) <span class="keyword">returns</span> (stream model.SResponse) </span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">rpc</span> BidirectionalStream(stream model.SRequest) <span class="keyword">returns</span> (stream model.SResponse) </span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>çœ‹ä¸€ä¸‹go-microä¸ºæˆ‘ä»¬ç”Ÿæˆçš„ä»£ç rpcapi.micro.goé‡Œï¼Œä¸è¦è¢«å“åˆ°ï¼Œç”Ÿæˆäº†å¾ˆå¤šä»£ç ï¼Œä½†æ˜¯æ²¡å•¥ç†è§£ä¸äº†çš„<br>Serverç«¯</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Server API for Say service</span></span><br><span class="line"><span class="keyword">type</span> SayHandler <span class="keyword">interface</span> &#123;</span><br><span class="line">    <span class="comment">// .... others  </span></span><br><span class="line">    Stream(context.Context, *model.SRequest, Say_StreamStream) <span class="type">error</span></span><br><span class="line">    BidirectionalStream(context.Context, Say_BidirectionalStreamStream) <span class="type">error</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> Say_StreamStream <span class="keyword">interface</span> &#123;</span><br><span class="line">    SendMsg(<span class="keyword">interface</span>&#123;&#125;) <span class="type">error</span></span><br><span class="line">    RecvMsg(<span class="keyword">interface</span>&#123;&#125;) <span class="type">error</span></span><br><span class="line">    Close() <span class="type">error</span></span><br><span class="line">    Send(*model.SResponse) <span class="type">error</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> Say_BidirectionalStreamStream <span class="keyword">interface</span> &#123;</span><br><span class="line">    SendMsg(<span class="keyword">interface</span>&#123;&#125;) <span class="type">error</span></span><br><span class="line">    RecvMsg(<span class="keyword">interface</span>&#123;&#125;) <span class="type">error</span></span><br><span class="line">    Close() <span class="type">error</span></span><br><span class="line">    Send(*model.SResponse) <span class="type">error</span></span><br><span class="line">    Recv() (*model.SRequest, <span class="type">error</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// .... others </span></span><br></pre></td></tr></table></figure>

<p>Clientç«¯</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Client API for Say service</span></span><br><span class="line"><span class="keyword">type</span> SayService <span class="keyword">interface</span> &#123; </span><br><span class="line">    <span class="comment">//... others</span></span><br><span class="line">    Stream(ctx context.Context, in *model.SRequest, opts ...client.CallOption) (Say_StreamService, <span class="type">error</span>)</span><br><span class="line">    BidirectionalStream(ctx context.Context, opts ...client.CallOption) (Say_BidirectionalStreamService, <span class="type">error</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Say_StreamService <span class="keyword">interface</span> &#123;</span><br><span class="line">    SendMsg(<span class="keyword">interface</span>&#123;&#125;) <span class="type">error</span></span><br><span class="line">    RecvMsg(<span class="keyword">interface</span>&#123;&#125;) <span class="type">error</span></span><br><span class="line">    Close() <span class="type">error</span></span><br><span class="line">    Recv() (*model.SResponse, <span class="type">error</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Say_BidirectionalStreamService <span class="keyword">interface</span> &#123;</span><br><span class="line">    SendMsg(<span class="keyword">interface</span>&#123;&#125;) <span class="type">error</span></span><br><span class="line">    RecvMsg(<span class="keyword">interface</span>&#123;&#125;) <span class="type">error</span></span><br><span class="line">    Close() <span class="type">error</span></span><br><span class="line">    Send(*model.SRequest) <span class="type">error</span></span><br><span class="line">    Recv() (*model.SResponse, <span class="type">error</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>â€‚â€‚â€‚â€‚ä½ ä¼šå‘ç°å‚æ•°å‰é¢åŠ äº† Streamåï¼Œç”Ÿæˆçš„ä»£ç ä¼šæŠŠä½ çš„å‚æ•°å˜æˆä¸€ä¸ªæ¥å£ï¼Œè¿™ä¸ªæ¥å£ä¸»è¦è¦çš„æ–¹æ³•æ˜¯</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SendMsg(<span class="keyword">interface</span>&#123;&#125;) <span class="type">error</span></span><br><span class="line">RecvMsg(<span class="keyword">interface</span>&#123;&#125;) <span class="type">error</span></span><br><span class="line">Close() <span class="type">error</span></span><br></pre></td></tr></table></figure>

<p>å‰©ä¸‹çš„ä¸¤ä¸ªæ¥å£æ–¹æ³•æ˜¯æ ¹æ®ä½ æ˜¯å‘é€è¿˜æ˜¯æ¥æ”¶ç”Ÿæˆçš„ï¼Œå¦‚æœæœ‰å‘é€å°±ä¼šæœ‰Send(ä½ çš„å‚æ•°)ï¼Œå¦‚æœæœ‰æ¥æ”¶ä¼šç”ŸæˆRev() (ä½ çš„å‚æ•°ï¼Œ  error),ä½†è¿™ä¸¤ä¸ªæ–¹æ³•åªæ˜¯ä¸ºäº†è®©ä½ ä½¿ç”¨æ—¶æ–¹ä¾¿ï¼Œé‡Œé¢è°ƒç”¨çš„è¿˜æ˜¯SendMsg(interface)å’ŒRecvMsg(interface)æ–¹æ³•ï¼Œä½†æ˜¯ä»–ä»¬æ˜¯æ€ä¹ˆå·¥ä½œçš„ï¼Œå¦‚ä½•å¤šæ¬¡å‘é€å’Œæ¥æ”¶ä¼ è¾“çš„æ•°æ®ï¼Œæ˜¯ä¸æ˜¯æ„Ÿè§‰å¾ˆç¥å¥‡ã€‚</p>
<p>æˆ‘å°±ä»¥<code>TsBidirectionalStream</code> æ–¹æ³•ä¸ºä¾‹å¼€å§‹åˆ†æï¼Œä¸Šä¸€ç¯‡å’Œå†æ—©ä¹‹å‰çš„å¸–å­å·²ç»è¯´äº†æœåŠ¡ç«¯å¯åŠ¨çš„æ—¶å€™éƒ½åšäº†å“ªäº›æ“ä½œï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°ï¼Œ<br>æœåŠ¡ç«¯çš„å®ç°,å¾ˆç®€å•ï¼Œä¸æ–­çš„è·å–å®¢æˆ·ç«¯å‘è¿‡æ¥çš„æ•°æ®ï¼Œå†ç»™å®¢æˆ·ç«¯ä¸€æ¬¡ä¸€æ¬¡çš„è¿”å›ä¸€äº›æ•°æ®ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> æ¨¡æ‹Ÿæ•°æ®</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Say)</span></span> BidirectionalStream(ctx context.Context, stream rpcapi.Say_BidirectionalStreamStream) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        req, err := stream.Recv()</span><br><span class="line">        <span class="keyword">if</span> err == io.EOF &#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> i := <span class="type">int64</span>(<span class="number">0</span>); i &lt; req.Count; i++ &#123;</span><br><span class="line">            <span class="keyword">if</span> err := stream.Send(&amp;model.SResponse&#123;Value: []<span class="type">string</span> &#123;lib.RandomStr(lib.Random(<span class="number">3</span>, <span class="number">6</span>))&#125;&#125;); err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> err</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯åŠ¨æœåŠ¡ï¼ŒæœåŠ¡å¼€å§‹ç›‘å¬å®¢æˆ·ç«¯ä¼ è¿‡æ¥çš„æ•°æ®.....<br>å®¢æˆ·ç«¯è°ƒç”¨æœåŠ¡ç«¯æ–¹æ³•ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è°ƒç”¨ </span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TsBidirectionalStream</span><span class="params">(client rpcapi.SayService)</span></span> &#123;</span><br><span class="line">    rspStream, err := client.BidirectionalStream(context.Background())</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// send</span></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        rspStream.Send(&amp;model.SRequest&#123;Count: <span class="number">2</span>&#125;)</span><br><span class="line">        rspStream.Send(&amp;model.SRequest&#123;Count: <span class="number">5</span>&#125;)</span><br><span class="line">        <span class="comment">// close the stream</span></span><br><span class="line">        <span class="keyword">if</span> err := rspStream.Close(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            fmt.Println(<span class="string">&quot;stream close err:&quot;</span>, err)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line">     <span class="comment">// recv</span></span><br><span class="line">    idx := <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span>  &#123;</span><br><span class="line">        rsp, err := rspStream.Recv()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> err == io.EOF &#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="built_in">panic</span>(err)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        fmt.Printf(<span class="string">&quot;test stream get idx %d  data  %v\n&quot;</span>, idx, rsp)</span><br><span class="line">        idx++</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(<span class="string">&quot;Read Value End&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å½“å®¢æˆ·ç«¯åœ¨è°ƒç”¨rpcçš„streamæ–¹æ³•æ˜¯è¦å¾ˆå¾—åˆ°stream</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">rspStream, err := client.BidirectionalStream(context.Background())</span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *sayService)</span></span> BidirectionalStream(ctx context.Context, opts ...client.CallOption) (Say_BidirectionalStreamService, <span class="type">error</span>) &#123;</span><br><span class="line">    req := c.c.NewRequest(c.name, <span class="string">&quot;Say.BidirectionalStream&quot;</span>, &amp;model.SRequest&#123;&#125;)</span><br><span class="line">    stream, err := c.c.Stream(ctx, req, opts...)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &amp;sayServiceBidirectionalStream&#123;stream&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªè°ƒç”¨<code>c.c.Stream(ctx, req, opts...)</code>æ˜¯å…³é”®ï¼Œä»–çš„å†…éƒ¨å®ç°å°±æ˜¯å’ŒæœåŠ¡å™¨è¿›è¡Œè¿æ¥ï¼Œç„¶åè¿”å›ä¸€ä¸ªstreamï¼Œè¿›è¡Œæ“ä½œã€‚</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">å®¢æˆ·ç«¯ï¼šå’ŒæœåŠ¡ç«¯å»ºç«‹è¿æ¥ï¼Œè¿”å›Streamï¼Œè¿›è¡Œæ¥æ”¶å’Œå‘é€æ•°æ®</span><br><span class="line">æœåŠ¡ç«¯ï¼šæ¥æ”¶å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚ï¼Œåˆ©ç”¨åå°„æ‰¾åˆ°ç›¸åº”çš„æ–¹æ³•ï¼Œç»„ç»‡Stremï¼Œä¼ ç»™æ–¹æ³•ï¼Œè¿›è¡Œæ•°æ®çš„å‘é€å’Œæ¥æ”¶</span><br></pre></td></tr></table></figure>

<p>å»ºç«‹è¿æ¥çš„æ—¶å€™å°±æ˜¯ä¸€æ¬¡rpcè°ƒç”¨ï¼ŒæœåŠ¡ç«¯æ¥å—è¿æ¥ï¼Œç„¶åå®¢æˆ·ç«¯å‘é€ä¸€æ¬¡è°ƒç”¨ï¼Œä½†æ˜¯ä¼ è¾“çš„æ˜¯ç©ºæ•°æ®ï¼ŒæœåŠ¡ç«¯åˆ©ç”¨åå°„æ‰¾åˆ°å…·ä½“çš„æ–¹æ³•ï¼Œç»„ç»‡streamï¼Œè°ƒç”¨å…·ä½“æ–¹æ³•ï¼Œåˆ©ç”¨è¿™ä¸ªè¿æ¥ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯è¿›è¡Œå¤šæ¬¡é€šä¿¡ã€‚</p>
<p><img src="https://raw.githubusercontents.com/wangyyovo/CDN/master/blog/microserive/2019-go-micro-13.jpg" alt="img"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="https://wangyyovo.github.io">Blank</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="https://wangyyovo.github.io/posts/566a0846/">https://wangyyovo.github.io/posts/566a0846/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥è‡ª <a href="https://wangyyovo.github.io" target="_blank">Blank</a>ï¼</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://raw.githubusercontents.com/wangyyovo/CDN/master/cover/microservice/958a3c375861938b04a84b0f4fe8a4ad.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/ShareJS/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/ShareJS/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/33bd5052/"><img class="prev-cover" src="https://raw.githubusercontents.com/wangyyovo/CDN/master/cover/microservice/0962a1f2d74318fba76ea47b22c6edda.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info">goå¾®æœåŠ¡åº“</div></div></a></div><div class="next-post pull-right"><a href="/posts/6c7dd4a5/"><img class="next-cover" src="https://raw.githubusercontents.com/wangyyovo/CDN/master/cover/microservice/791c1e6fcd278681840f1a9a88278d34.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info">etcdé›†ç¾¤é…ç½®</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> è¯„è®º</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://raw.githubusercontents.com/wangyyovo/CDN/master/theme/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Blank</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">356</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">36</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">54</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/wangyyovo" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:xxxxxx@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fas fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>å…¬å‘Š</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#gomicro%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0"><span class="toc-text">gomicroæ·±åº¦å­¦ä¹ </span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84%E4%BB%8B%E7%BB%8D"><span class="toc-text">1.æ•´ä½“æ¶æ„ä»‹ç»</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1%E9%80%9A%E4%BF%A1%E6%B5%81%E7%A8%8B"><span class="toc-text">1.1é€šä¿¡æµç¨‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2Transort"><span class="toc-text">1.2Transort</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3Codec"><span class="toc-text">1.3Codec</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4Registry"><span class="toc-text">1.4Registry</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5Selector"><span class="toc-text">1.5Selector</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-6Broker"><span class="toc-text">1.6Broker</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-7Client"><span class="toc-text">1.7Client</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-8Server"><span class="toc-text">1.8Server</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-9Service"><span class="toc-text">1.9Service</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%85%A5%E9%97%A8%E4%BE%8B%E5%AD%90"><span class="toc-text">2.å…¥é—¨ä¾‹å­</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E6%89%80%E9%9C%80%E8%A6%81%E7%9A%84%E7%8E%AF%E5%A2%83"><span class="toc-text">å®‰è£…æ‰€éœ€è¦çš„ç¯å¢ƒ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E5%AD%901"><span class="toc-text">ä¾‹å­1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%8B%E5%AD%902"><span class="toc-text">ä¾‹å­2</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Registry%E6%9C%8D%E5%8A%A1%E7%9A%84%E6%B3%A8%E5%86%8C%E5%92%8C%E5%8F%91%E7%8E%B0"><span class="toc-text">3.RegistryæœåŠ¡çš„æ³¨å†Œå’Œå‘ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#go-micro-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%B3%A8%E5%86%8C%E6%9C%8D%E5%8A%A1"><span class="toc-text">go-micro æœåŠ¡ç«¯æ³¨å†ŒæœåŠ¡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%8F%91%E7%8E%B0%E6%9C%8D%E5%8A%A1"><span class="toc-text">å®¢æˆ·ç«¯å‘ç°æœåŠ¡</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-rpc%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8%E8%BF%87%E7%A8%8B%E8%AF%A6%E8%A7%A3"><span class="toc-text">4.rpcæ–¹æ³•è°ƒç”¨è¿‡ç¨‹è¯¦è§£</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%9A%84%E5%90%AF%E5%8A%A8"><span class="toc-text">æœåŠ¡çš„å¯åŠ¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%B0%83%E7%94%A8%E6%9C%8D%E5%8A%A1%E6%96%B9%E6%B3%95"><span class="toc-text">å®¢æˆ·ç«¯è°ƒç”¨æœåŠ¡æ–¹æ³•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%A4%84%E7%90%86%E8%AF%B7%E6%B1%82"><span class="toc-text">æœåŠ¡ç«¯å¤„ç†è¯·æ±‚</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-stream-%E8%B0%83%E7%94%A8%E8%BF%87%E7%A8%8B%E8%AF%A6%E8%A7%A3"><span class="toc-text">5.stream è°ƒç”¨è¿‡ç¨‹è¯¦è§£</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>æœ€æ–°æ–‡ç« </span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/d14168d/" title="è™šæ‹Ÿæœºé—®é¢˜åˆé›†"><img src="https://raw.githubusercontents.com/wangyyovo/CDN/master/cover/hexo/090cfe4e9e60b0ad0de05db822f3ae97.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="è™šæ‹Ÿæœºé—®é¢˜åˆé›†"/></a><div class="content"><a class="title" href="/posts/d14168d/" title="è™šæ‹Ÿæœºé—®é¢˜åˆé›†">è™šæ‹Ÿæœºé—®é¢˜åˆé›†</a><time datetime="2022-07-16T13:30:36.000Z" title="å‘è¡¨äº 2022-07-16 21:30:36">2022-07-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/f540045f/" title="ç”¨goè¯­è¨€ç¼–å†™ç§»åŠ¨ç«¯sdkå’Œappå¼€å‘"><img src="https://raw.githubusercontents.com/wangyyovo/CDN/master/cover/golang/941ed1ec2925719a0c92e76f4f786b6a.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ç”¨goè¯­è¨€ç¼–å†™ç§»åŠ¨ç«¯sdkå’Œappå¼€å‘"/></a><div class="content"><a class="title" href="/posts/f540045f/" title="ç”¨goè¯­è¨€ç¼–å†™ç§»åŠ¨ç«¯sdkå’Œappå¼€å‘">ç”¨goè¯­è¨€ç¼–å†™ç§»åŠ¨ç«¯sdkå’Œappå¼€å‘</a><time datetime="2022-07-04T12:14:21.000Z" title="å‘è¡¨äº 2022-07-04 20:14:21">2022-07-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/5faac006/" title="åœ¨çº¿ç¼–ç¨‹IDE"><img src="https://raw.githubusercontents.com/wangyyovo/CDN/master/cover/hexo/090cfe4e9e60b0ad0de05db822f3ae97.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="åœ¨çº¿ç¼–ç¨‹IDE"/></a><div class="content"><a class="title" href="/posts/5faac006/" title="åœ¨çº¿ç¼–ç¨‹IDE">åœ¨çº¿ç¼–ç¨‹IDE</a><time datetime="2022-06-12T13:30:36.000Z" title="å‘è¡¨äº 2022-06-12 21:30:36">2022-06-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/7594185d/" title="å³æ—¶æ€§èƒ½åˆ†æå·¥å…·Pyroscope"><img src="https://raw.githubusercontents.com/wangyyovo/CDN/master/cover/golang/3bfb3279740bc9a5b5ef436fa887ef07.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="å³æ—¶æ€§èƒ½åˆ†æå·¥å…·Pyroscope"/></a><div class="content"><a class="title" href="/posts/7594185d/" title="å³æ—¶æ€§èƒ½åˆ†æå·¥å…·Pyroscope">å³æ—¶æ€§èƒ½åˆ†æå·¥å…·Pyroscope</a><time datetime="2022-06-12T08:07:36.000Z" title="å‘è¡¨äº 2022-06-12 16:07:36">2022-06-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/82a7aa7c/" title="golangæ€§èƒ½è°ƒè¯•ä¼˜åŒ–æ–¹æ³•"><img src="https://raw.githubusercontents.com/wangyyovo/CDN/master/cover/common/3.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="golangæ€§èƒ½è°ƒè¯•ä¼˜åŒ–æ–¹æ³•"/></a><div class="content"><a class="title" href="/posts/82a7aa7c/" title="golangæ€§èƒ½è°ƒè¯•ä¼˜åŒ–æ–¹æ³•">golangæ€§èƒ½è°ƒè¯•ä¼˜åŒ–æ–¹æ³•</a><time datetime="2022-06-12T03:00:36.000Z" title="å‘è¡¨äº 2022-06-12 11:00:36">2022-06-12</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By Blank</div><div class="framework-info"><span>æ¡†æ¶ </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>ä¸»é¢˜ </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://wangyyovo.github.io/">blog</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="ç®€ç¹è½¬æ¢">ç¹</button><button id="darkmode" type="button" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="è®¾ç½®"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="ç›´è¾¾è¯„è®º"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">æœç´¢</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  æ•°æ®åº“åŠ è½½ä¸­</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="æœç´¢æ–‡ç« " type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@5/instantpage.js" type="module"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '49gEIIGN7uRbL6vHhieSpBzM-MdYXbMMI',
      appKey: 'uqts0urLKwikYQ0fKmIkMHBE',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><div class="aplayer no-destroy" data-id="000PeZCQ1i4XVs" data-server="tencent" data-type="artist" data-fixed="true" data-mini="true" data-listFolded="false" data-order="random" data-preload="none" data-autoplay="false" muted></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-heart.min.js" async="async" mobile="false"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer@1/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/MetingJS/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>