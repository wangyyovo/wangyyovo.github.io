<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>结构型模式-享元模式 | Blank</title><meta name="author" content="Blank"><meta name="copyright" content="Blank"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="https:&#x2F;&#x2F;refactoringguru.cn&#x2F;design-patterns&#x2F;flyweight  结构型模式-享元模式亦称： 缓存、Cache、Flyweight 意图享元模式是一种结构型设计模式， 它摒弃了在每个对象中保存所有数据的方式， 通过共享多个对象所共有的相同状态， 让你能在有限的内存容量中载入更多对象。  问题假如你希望在长时间工作后放松一下， 所以开发了一款简单的游戏：">
<meta property="og:type" content="article">
<meta property="og:title" content="结构型模式-享元模式">
<meta property="og:url" content="https://wangyyovo.github.io/posts/d935b798/">
<meta property="og:site_name" content="Blank">
<meta property="og:description" content="https:&#x2F;&#x2F;refactoringguru.cn&#x2F;design-patterns&#x2F;flyweight  结构型模式-享元模式亦称： 缓存、Cache、Flyweight 意图享元模式是一种结构型设计模式， 它摒弃了在每个对象中保存所有数据的方式， 通过共享多个对象所共有的相同状态， 让你能在有限的内存容量中载入更多对象。  问题假如你希望在长时间工作后放松一下， 所以开发了一款简单的游戏：">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/cover/common/fbe970a24a54e3fd90e6fbe3115b02ef.jpg">
<meta property="article:published_time" content="2021-05-04T07:09:11.000Z">
<meta property="article:modified_time" content="2021-05-04T07:09:11.000Z">
<meta property="article:author" content="Blank">
<meta property="article:tag" content="pattern">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/cover/common/fbe970a24a54e3fd90e6fbe3115b02ef.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "结构型模式-享元模式",
  "url": "https://wangyyovo.github.io/posts/d935b798/",
  "image": "https://jsd.012700.xyz/gh/wangyyovo/CDN@master/cover/common/fbe970a24a54e3fd90e6fbe3115b02ef.jpg",
  "datePublished": "2021-05-04T07:09:11.000Z",
  "dateModified": "2021-05-04T07:09:11.000Z",
  "author": [
    {
      "@type": "Person",
      "name": "Blank",
      "url": "https://wangyyovo.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/theme/favicon.ico"><link rel="canonical" href="https://wangyyovo.github.io/posts/d935b798/"><link rel="preconnect" href="https://jsd.012700.xyz"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://jsd.012700.xyz/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":400,"highlightFullpage":true,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":150,"languages":{"author":"作者: Blank","link":"链接: ","source":"来源: Blank","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://jsd.012700.xyz/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '结构型模式-享元模式',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="alternate" href="/atom.xml" title="Blank" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/theme/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">352</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">46</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">58</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fas fa-comment-dots"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 娱乐</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-image"></i><span> 相册</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-book"></i><span> 教程</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/posts/21cfbf15/"><span> 🚀 快速開始</span></a></li><li><a class="site-page child" href="/posts/dc584b87/"><span> 📑 主題頁面</span></a></li><li><a class="site-page child" href="/posts/4aa8abbe/"><span> 🛠 主題配置</span></a></li><li><a class="site-page child" href="/posts/ceeb73f/"><span> ⚔️ 標簽外挂</span></a></li><li><a class="site-page child" href="/posts/98d20436/"><span> ❓ 主題問答</span></a></li><li><a class="site-page child" href="/posts/4073eda/"><span> ⚡️ 進階教程</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-language"></i><span> 语言</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/"><i class="fa-fw fas fa-c"></i><span> 中文</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://jsd.012700.xyz/gh/wangyyovo/CDN@master/cover/common/fbe970a24a54e3fd90e6fbe3115b02ef.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Blank</span></a><a class="nav-page-title" href="/"><span class="site-name">结构型模式-享元模式</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fas fa-comment-dots"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 娱乐</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-image"></i><span> 相册</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-book"></i><span> 教程</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/posts/21cfbf15/"><span> 🚀 快速開始</span></a></li><li><a class="site-page child" href="/posts/dc584b87/"><span> 📑 主題頁面</span></a></li><li><a class="site-page child" href="/posts/4aa8abbe/"><span> 🛠 主題配置</span></a></li><li><a class="site-page child" href="/posts/ceeb73f/"><span> ⚔️ 標簽外挂</span></a></li><li><a class="site-page child" href="/posts/98d20436/"><span> ❓ 主題問答</span></a></li><li><a class="site-page child" href="/posts/4073eda/"><span> ⚡️ 進階教程</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-language"></i><span> 语言</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/"><i class="fa-fw fas fa-c"></i><span> 中文</span></a></li></ul></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">结构型模式-享元模式</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-05-04T07:09:11.000Z" title="发表于 2021-05-04 15:09:11">2021-05-04</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-05-04T07:09:11.000Z" title="更新于 2021-05-04 15:09:11">2021-05-04</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/pattern/">pattern</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">13k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>61分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/posts/d935b798/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count" data-xid="/posts/d935b798/" itemprop="commentCount"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><script src="\assets\js\APlayer.min.js"> </script><blockquote>
<p><a target="_blank" rel="noopener" href="https://refactoringguru.cn/design-patterns/flyweight">https://refactoringguru.cn/design-patterns/flyweight</a></p>
</blockquote>
<h1 id="结构型模式-享元模式"><a href="#结构型模式-享元模式" class="headerlink" title="结构型模式-享元模式"></a>结构型模式-享元模式</h1><p><strong>亦称：</strong> 缓存、Cache、Flyweight</p>
<h2 id="意图"><a href="#意图" class="headerlink" title="意图"></a>意图</h2><p><strong>享元模式</strong>是一种结构型设计模式， 它摒弃了在每个对象中保存所有数据的方式， 通过共享多个对象所共有的相同状态， 让你能在有限的内存容量中载入更多对象。</p>
<p><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/blog/pattern/flyweight-zh.png"></p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>假如你希望在长时间工作后放松一下， 所以开发了一款简单的游戏： 玩家们在地图上移动并相互射击。 你决定实现一个真实的粒子系统， 并将其作为游戏的特色。 大量的子弹、 导弹和爆炸弹片会在整个地图上穿行， 为玩家提供紧张刺激的游戏体验。</p>
<p>开发完成后， 你推送提交了最新版本的程序， 并在编译游戏后将其发送给了一个朋友进行测试。 尽管该游戏在你的电脑上完美运行， 但是你的朋友却无法长时间进行游戏： 游戏总是会在他的电脑上运行几分钟后崩溃。 在研究了几个小时的调试消息记录后， 你发现导致游戏崩溃的原因是内存容量不足。 朋友的设备性能远比不上你的电脑， 因此游戏运行在他的电脑上时很快就会出现问题。</p>
<p>真正的问题与粒子系统有关。 每个粒子 （一颗子弹、 一枚导弹或一块弹片） 都由包含完整数据的独立对象来表示。 当玩家在游戏中鏖战进入高潮后的某一时刻， 游戏将无法在剩余内存中载入新建粒子， 于是程序就崩溃了。</p>
<p><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/blog/pattern/problem-zh-flyweight.png"></p>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>仔细观察 <code>粒子</code>Particle类， 你可能会注意到颜色 （color） 和精灵图 （sprite）这两个成员变量所消耗的内存要比其他变量多得多。 更糟糕的是， 对于所有的粒子来说， 这两个成员变量所存储的数据几乎完全一样 （比如所有子弹的颜色和精灵图都一样）。</p>
<p><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/blog/pattern/solution1-zh-flyweight.png"></p>
<p>每个粒子的另一些状态 （坐标、 移动矢量和速度） 则是不同的。 因为这些成员变量的数值会不断变化。 这些数据代表粒子在存续期间不断变化的情景， 但每个粒子的颜色和精灵图则会保持不变。</p>
<p>对象的常量数据通常被称为<em>内在状态</em>， 其位于对象中， 其他对象只能读取但不能修改其数值。 而对象的其他状态常常能被其他对象 “从外部” 改变， 因此被称为<em>外在状态</em>。</p>
<p>享元模式建议不在对象中存储外在状态， 而是将其传递给依赖于它的一个特殊方法。 程序只在对象中保存内在状态， 以方便在不同情景下重用。 这些对象的区别仅在于其内在状态 （与外在状态相比， 内在状态的变体要少很多）， 因此你所需的对象数量会大大削减。</p>
<p><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/blog/pattern/solution3-zh-flyweight.png"></p>
<p>让我们回到游戏中。 假如能从粒子类中抽出外在状态， 那么我们只需三个不同的对象 （子弹、 导弹和弹片） 就能表示游戏中的所有粒子。 你现在很可能已经猜到了， 我们将这样一个仅存储内在状态的对象称为享元。</p>
<h4 id="外在状态存储"><a href="#外在状态存储" class="headerlink" title="外在状态存储"></a>外在状态存储</h4><p>那么外在状态会被移动到什么地方呢？ 总得有类来存储它们， 对不对？ 在大部分情况中， 它们会被移动到容器对象中， 也就是我们应用享元模式前的聚合对象中。</p>
<p>在我们的例子中， 容器对象就是主要的 <code>游戏</code>Game对象， 其会将所有粒子存储在名为 <code>粒子</code>particles的成员变量中。 为了能将外在状态移动到这个类中， 你需要创建多个数组成员变量来存储每个粒子的坐标、 方向矢量和速度。 除此之外， 你还需要另一个数组来存储指向代表粒子的特定享元的引用。 这些数组必须保持同步， 这样你才能够使用同一索引来获取关于某个粒子的所有数据。</p>
<p><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/blog/pattern/solution2-zh-flyweight.png"></p>
<p>更优雅的解决方案是创建独立的情景类来存储外在状态和对享元对象的引用。 在该方法中， 容器类只需包含一个数组。</p>
<p>稍等！ 这样的话情景对象数量不是会和不采用该模式时的对象数量一样多吗？ 的确如此， 但这些对象要比之前小很多。 消耗内存最多的成员变量已经被移动到很少的几个享元对象中了。 现在， 一个享元大对象会被上千个情境小对象复用， 因此无需再重复存储数千个大对象的数据。</p>
<h4 id="享元与不可变性"><a href="#享元与不可变性" class="headerlink" title="享元与不可变性"></a>享元与不可变性</h4><p>由于享元对象可在不同的情景中使用， 你必须确保其状态不能被修改。 享元类的状态只能由构造函数的参数进行一次性初始化， 它不能对其他对象公开其设置器或公有成员变量。</p>
<h4 id="享元工厂"><a href="#享元工厂" class="headerlink" title="享元工厂"></a>享元工厂</h4><p>为了能更方便地访问各种享元， 你可以创建一个工厂方法来管理已有享元对象的缓存池。 工厂方法从客户端处接收目标享元对象的内在状态作为参数， 如果它能在缓存池中找到所需享元， 则将其返回给客户端； 如果没有找到， 它就会新建一个享元， 并将其添加到缓存池中。</p>
<p>你可以选择在程序的不同地方放入该函数。 最简单的选择就是将其放置在享元容器中。 除此之外， 你还可以新建一个工厂类， 或者创建一个静态的工厂方法并将其放入实际的享元类中。</p>
<h2 id="享元模式结构"><a href="#享元模式结构" class="headerlink" title="享元模式结构"></a>享元模式结构</h2><p><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/blog/pattern/structure-indexed-flyweight.png"></p>
<ol>
<li>享元模式只是一种优化。 在应用该模式之前， 你要确定程序中存在与大量类似对象同时占用内存相关的内存消耗问题， 并且确保该问题无法使用其他更好的方式来解决。</li>
<li><strong>享元</strong> （Flyweight） 类包含原始对象中部分能在多个对象中共享的状态。 同一享元对象可在许多不同情景中使用。 享元中存储的状态被称为 “内在状态”。 传递给享元方法的状态被称为 “外在状态”。</li>
<li><strong>情景</strong> （Context） 类包含原始对象中各不相同的外在状态。 情景与享元对象组合在一起就能表示原始对象的全部状态。</li>
<li>通常情况下， 原始对象的行为会保留在享元类中。 因此调用享元方法必须提供部分外在状态作为参数。 但你也可将行为移动到情景类中， 然后将连入的享元作为单纯的数据对象。</li>
<li><strong>客户端</strong> （Client） 负责计算或存储享元的外在状态。 在客户端看来， 享元是一种可在运行时进行配置的模板对象， 具体的配置方式为向其方法中传入一些情景数据参数。</li>
<li><strong>享元工厂</strong> （Flyweight Factory） 会对已有享元的缓存池进行管理。 有了工厂后， 客户端就无需直接创建享元， 它们只需调用工厂并向其传递目标享元的一些内在状态即可。 工厂会根据参数在之前已创建的享元中进行查找， 如果找到满足条件的享元就将其返回； 如果没有找到就根据参数新建享元。</li>
</ol>
<h2 id="伪代码"><a href="#伪代码" class="headerlink" title="伪代码"></a>伪代码</h2><p>在本例中， <strong>享元</strong>模式能有效减少在画布上渲染数百万个树状对象时所需的内存。</p>
<p><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/blog/pattern/example-flyweight.png"></p>
<p>该模式从主要的 <code>树</code>Tree类中抽取内在状态， 并将其移动到享元类 <code>树种类</code>Tree­Type之中。</p>
<p>最初程序需要在多个对象中存储相同数据， 而现在仅需在几个享元对象中保存数据， 然后在作为情景的 <code>树</code>对象中连入享元即可。 客户端代码使用享元工厂创建树对象并封装搜索指定对象的复杂行为， 并能在需要时复用对象。</p>
<figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 享元类包含一个树的部分状态。这些成员变量保存的数值对于特定树而言是唯一</span></span><br><span class="line"><span class="comment">// 的。例如，你在这里找不到树的坐标。但这里有很多树木之间所共有的纹理和颜</span></span><br><span class="line"><span class="comment">// 色。由于这些数据的体积通常非常大，所以如果让每棵树都其进行保存的话将耗</span></span><br><span class="line"><span class="comment">// 费大量内存。因此，我们可将纹理、颜色和其他重复数据导出到一个单独的对象</span></span><br><span class="line"><span class="comment">// 中，然后让众多的单个树对象去引用它。</span></span><br><span class="line"><span class="keyword">class</span> TreeType <span class="keyword">is</span></span><br><span class="line">    field <span class="keyword">name</span></span><br><span class="line">    field color</span><br><span class="line">    field texture</span><br><span class="line">    <span class="function"><span class="keyword">constructor</span> <span class="title">TreeType</span><span class="params">(<span class="keyword">name</span>, color, texture)</span> <span class="comment">&#123; ... &#125;</span></span></span><br><span class="line"><span class="function">    <span class="title">method</span> <span class="title">draw</span><span class="params">(canvas, x, y)</span> <span class="title">is</span></span></span><br><span class="line"><span class="function">        <span class="comment">// 1. 创建特定类型、颜色和纹理的位图。</span></span></span><br><span class="line"><span class="function">        <span class="comment">// 2. 在画布坐标 (X,Y) 处绘制位图。</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 享元工厂决定是否复用已有享元或者创建一个新的对象。</span></span></span><br><span class="line"><span class="function"><span class="title">class</span> <span class="title">TreeFactory</span> <span class="title">is</span></span></span><br><span class="line"><span class="function">    <span class="title">static</span> <span class="title">field</span> <span class="title">treeTypes</span>:</span> collection <span class="keyword">of</span> tree types</span><br><span class="line">    <span class="keyword">static</span> method getTreeType(<span class="keyword">name</span>, color, texture) <span class="keyword">is</span></span><br><span class="line">        <span class="keyword">type</span> = treeTypes.find(<span class="keyword">name</span>, color, texture)</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">type</span> == null)</span><br><span class="line">            <span class="keyword">type</span> = new TreeType(<span class="keyword">name</span>, color, texture)</span><br><span class="line">            treeTypes.add(<span class="keyword">type</span>)</span><br><span class="line">        return <span class="keyword">type</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 情景对象包含树状态的外在部分。程序中可以创建数十亿个此类对象，因为它们</span></span><br><span class="line"><span class="comment">// 体积很小：仅有两个整型坐标和一个引用成员变量。</span></span><br><span class="line"><span class="keyword">class</span> Tree <span class="keyword">is</span></span><br><span class="line">    field x,y</span><br><span class="line">    field <span class="keyword">type</span>: TreeType</span><br><span class="line">    <span class="function"><span class="keyword">constructor</span> <span class="title">Tree</span><span class="params">(x, y, <span class="keyword">type</span>)</span> <span class="comment">&#123; ... &#125;</span></span></span><br><span class="line"><span class="function">    <span class="title">method</span> <span class="title">draw</span><span class="params">(canvas)</span> <span class="title">is</span></span></span><br><span class="line"><span class="function">        <span class="title">type</span>.<span class="title">draw</span><span class="params">(canvas, this.x, this.y)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 树（Tree）和森林（Forest）类是享元的客户端。如果不打算继续对树类进行开</span></span></span><br><span class="line"><span class="function"><span class="comment">// 发，你可以将它们合并。</span></span></span><br><span class="line"><span class="function"><span class="title">class</span> <span class="title">Forest</span> <span class="title">is</span></span></span><br><span class="line"><span class="function">    <span class="title">field</span> <span class="title">trees</span>:</span> collection <span class="keyword">of</span> Trees</span><br><span class="line"></span><br><span class="line">    method plantTree(x, y, <span class="keyword">name</span>, color, texture) <span class="keyword">is</span></span><br><span class="line">        <span class="keyword">type</span> = TreeFactory.getTreeType(<span class="keyword">name</span>, color, texture)</span><br><span class="line">        tree = new Tree(x, y, <span class="keyword">type</span>)</span><br><span class="line">        trees.add(tree)</span><br><span class="line"></span><br><span class="line">    method draw(canvas) <span class="keyword">is</span></span><br><span class="line">        foreach (tree <span class="keyword">in</span> trees) <span class="keyword">do</span></span><br><span class="line">            tree.draw(canvas)</span><br></pre></td></tr></table></figure>

<h2 id="享元模式适合应用场景"><a href="#享元模式适合应用场景" class="headerlink" title="享元模式适合应用场景"></a>享元模式适合应用场景</h2><p><strong>仅在程序必须支持大量对象且没有足够的内存容量时使用享元模式。</strong></p>
<p> 应用该模式所获的收益大小取决于使用它的方式和情景。 它在下列情况中最有效：</p>
<ul>
<li>程序需要生成数量巨大的相似对象</li>
<li>这将耗尽目标设备的所有内存</li>
<li>对象中包含可抽取且能在多个对象间共享的重复状态。</li>
</ul>
<h2 id="实现方式"><a href="#实现方式" class="headerlink" title="实现方式"></a>实现方式</h2><ol>
<li>将需要改写为享元的类成员变量拆分为两个部分：<ul>
<li>内在状态： 包含不变的、 可在许多对象中重复使用的数据的成员变量。</li>
<li>外在状态： 包含每个对象各自不同的情景数据的成员变量</li>
</ul>
</li>
<li>保留类中表示内在状态的成员变量， 并将其属性设置为不可修改。 这些变量仅可在构造函数中获得初始数值。</li>
<li>找到所有使用外在状态成员变量的方法， 为在方法中所用的每个成员变量新建一个参数， 并使用该参数代替成员变量。</li>
<li>你可以有选择地创建工厂类来管理享元缓存池， 它负责在新建享元时检查已有的享元。 如果选择使用工厂， 客户端就只能通过工厂来请求享元， 它们需要将享元的内在状态作为参数传递给工厂。</li>
<li>客户端必须存储和计算外在状态 （情景） 的数值， 因为只有这样才能调用享元对象的方法。 为了使用方便， 外在状态和引用享元的成员变量可以移动到单独的情景类中。</li>
</ol>
<h2 id="享元模式优缺点"><a href="#享元模式优缺点" class="headerlink" title="享元模式优缺点"></a>享元模式优缺点</h2><p>优点</p>
<ul>
<li>如果程序中有很多相似对象， 那么你将可以节省大量内存。</li>
</ul>
<p>缺点</p>
<ul>
<li>你可能需要牺牲执行速度来换取内存， 因为他人每次调用享元方法时都需要重新计算部分情景数据。</li>
<li>代码会变得更加复杂。 团队中的新成员总是会问：  “为什么要像这样拆分一个实体的状态？”。</li>
</ul>
<h2 id="与其他模式的关系"><a href="#与其他模式的关系" class="headerlink" title="与其他模式的关系"></a>与其他模式的关系</h2><ul>
<li>你可以使用<a target="_blank" rel="noopener" href="https://refactoringguru.cn/design-patterns/flyweight">享元模式</a>实现<a target="_blank" rel="noopener" href="https://refactoringguru.cn/design-patterns/composite">组合模式</a>树的共享叶节点以节省内存。</li>
<li><a target="_blank" rel="noopener" href="https://refactoringguru.cn/design-patterns/flyweight">享元</a>展示了如何生成大量的小型对象， <a target="_blank" rel="noopener" href="https://refactoringguru.cn/design-patterns/facade">外观模式</a>则展示了如何用一个对象来代表整个子系统。</li>
<li>如果你能将对象的所有共享状态简化为一个享元对象， 那么<a target="_blank" rel="noopener" href="https://refactoringguru.cn/design-patterns/flyweight">享元</a>就和<a target="_blank" rel="noopener" href="https://refactoringguru.cn/design-patterns/singleton">单例模式</a>类似了。 但这两个模式有两个根本性的不同。<ol>
<li>只会有一个单例实体， 但是<em>享元</em>类可以有多个实体， 各实体的内在状态也可以不同。</li>
<li><em>单例</em>对象可以是可变的。 享元对象是不可变的。</li>
</ol>
</li>
</ul>
<h2 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h2><p><strong>享元</strong>是一种结构型设计模式， 它允许你在消耗少量内存的情况下支持大量对象。</p>
<p>模式通过共享多个对象的部分状态来实现上述功能。 换句话来说， 享元会将不同对象的相同数据进行缓存以节省内存。</p>
<div class="tabs"><div class="nav-tabs"><button type="button" class="tab active">C#</button><button type="button" class="tab">C++</button><button type="button" class="tab">JAVA</button><button type="button" class="tab">PHP</button><button type="button" class="tab">Python</button><button type="button" class="tab">Ruby</button><button type="button" class="tab">Swift</button><button type="button" class="tab">TypeScrit</button><button type="button" class="tab">Golang</button></div><div class="tab-contents"><div class="tab-item-content active"><p><strong>在 C# 中使用模式</strong></p>
<p><strong>复杂度：</strong> ★★★</p>
<p><strong>流行度：</strong> ★☆☆</p>
<p><strong>使用示例：</strong> 享元模式只有一个目的： 将内存消耗最小化。 如果你的程序没有遇到内存容量不足的问题， 则可以暂时忽略该模式。</p>
<p><strong>识别方法：</strong> 享元可以通过构建方法来识别， 它会返回缓存对象而不是创建新的对象。</p>
<p><strong>概念示例</strong></p>
<p>本例说明了<strong>享元</strong>设计模式的结构并重点回答了下面的问题：</p>
<ul>
<li>它由哪些类组成？</li>
<li>这些类扮演了哪些角色？</li>
<li>模式中的各个元素会以何种方式相互关联？</li>
</ul>
<p><strong>Program.cs:</strong> 概念示例</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="comment">// Use Json.NET library, you can download it from NuGet Package Manager</span></span><br><span class="line"><span class="keyword">using</span> Newtonsoft.Json;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">RefactoringGuru.DesignPatterns.Flyweight.Conceptual</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// The Flyweight stores a common portion of the state (also called intrinsic</span></span><br><span class="line">    <span class="comment">// state) that belongs to multiple real business entities. The Flyweight</span></span><br><span class="line">    <span class="comment">// accepts the rest of the state (extrinsic state, unique for each entity)</span></span><br><span class="line">    <span class="comment">// via its method parameters.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Flyweight</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> Car _sharedState;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Flyweight</span>(<span class="params">Car car</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>._sharedState = car;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Operation</span>(<span class="params">Car uniqueState</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">string</span> s = JsonConvert.SerializeObject(<span class="keyword">this</span>._sharedState);</span><br><span class="line">            <span class="built_in">string</span> u = JsonConvert.SerializeObject(uniqueState);</span><br><span class="line">            Console.WriteLine(<span class="string">$&quot;Flyweight: Displaying shared <span class="subst">&#123;s&#125;</span> and unique <span class="subst">&#123;u&#125;</span> state.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The Flyweight Factory creates and manages the Flyweight objects. It</span></span><br><span class="line">    <span class="comment">// ensures that flyweights are shared correctly. When the client requests a</span></span><br><span class="line">    <span class="comment">// flyweight, the factory either returns an existing instance or creates a</span></span><br><span class="line">    <span class="comment">// new one, if it doesn&#x27;t exist yet.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FlyweightFactory</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> List&lt;Tuple&lt;Flyweight, <span class="built_in">string</span>&gt;&gt; flyweights = <span class="keyword">new</span> List&lt;Tuple&lt;Flyweight, <span class="built_in">string</span>&gt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">FlyweightFactory</span>(<span class="params"><span class="keyword">params</span> Car[] args</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> elem <span class="keyword">in</span> args)</span><br><span class="line">            &#123;</span><br><span class="line">                flyweights.Add(<span class="keyword">new</span> Tuple&lt;Flyweight, <span class="built_in">string</span>&gt;(<span class="keyword">new</span> Flyweight(elem), <span class="keyword">this</span>.getKey(elem)));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Returns a Flyweight&#x27;s string hash for a given state.</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">getKey</span>(<span class="params">Car key</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            List&lt;<span class="built_in">string</span>&gt; elements = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt;();</span><br><span class="line"></span><br><span class="line">            elements.Add(key.Model);</span><br><span class="line">            elements.Add(key.Color);</span><br><span class="line">            elements.Add(key.Company);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (key.Owner != <span class="literal">null</span> &amp;&amp; key.Number != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                elements.Add(key.Number);</span><br><span class="line">                elements.Add(key.Owner);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            elements.Sort();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">string</span>.Join(<span class="string">&quot;_&quot;</span>, elements);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Returns an existing Flyweight with a given state or creates a new</span></span><br><span class="line">        <span class="comment">// one.</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Flyweight <span class="title">GetFlyweight</span>(<span class="params">Car sharedState</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">string</span> key = <span class="keyword">this</span>.getKey(sharedState);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (flyweights.Where(t =&gt; t.Item2 == key).Count() == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;FlyweightFactory: Can&#x27;t find a flyweight, creating new one.&quot;</span>);</span><br><span class="line">                <span class="keyword">this</span>.flyweights.Add(<span class="keyword">new</span> Tuple&lt;Flyweight, <span class="built_in">string</span>&gt;(<span class="keyword">new</span> Flyweight(sharedState), key));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;FlyweightFactory: Reusing existing flyweight.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.flyweights.Where(t =&gt; t.Item2 == key).FirstOrDefault().Item1;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listFlyweights</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> count = flyweights.Count;</span><br><span class="line">            Console.WriteLine(<span class="string">$&quot;\nFlyweightFactory: I have <span class="subst">&#123;count&#125;</span> flyweights:&quot;</span>);</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> flyweight <span class="keyword">in</span> flyweights)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(flyweight.Item2);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Car</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Owner &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Number &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Company &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Model &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Color &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// The client code usually creates a bunch of pre-populated</span></span><br><span class="line">            <span class="comment">// flyweights in the initialization stage of the application.</span></span><br><span class="line">            <span class="keyword">var</span> factory = <span class="keyword">new</span> FlyweightFactory(</span><br><span class="line">                <span class="keyword">new</span> Car &#123; Company = <span class="string">&quot;Chevrolet&quot;</span>, Model = <span class="string">&quot;Camaro2018&quot;</span>, Color = <span class="string">&quot;pink&quot;</span> &#125;,</span><br><span class="line">                <span class="keyword">new</span> Car &#123; Company = <span class="string">&quot;Mercedes Benz&quot;</span>, Model = <span class="string">&quot;C300&quot;</span>, Color = <span class="string">&quot;black&quot;</span> &#125;,</span><br><span class="line">                <span class="keyword">new</span> Car &#123; Company = <span class="string">&quot;Mercedes Benz&quot;</span>, Model = <span class="string">&quot;C500&quot;</span>, Color = <span class="string">&quot;red&quot;</span> &#125;,</span><br><span class="line">                <span class="keyword">new</span> Car &#123; Company = <span class="string">&quot;BMW&quot;</span>, Model = <span class="string">&quot;M5&quot;</span>, Color = <span class="string">&quot;red&quot;</span> &#125;,</span><br><span class="line">                <span class="keyword">new</span> Car &#123; Company = <span class="string">&quot;BMW&quot;</span>, Model = <span class="string">&quot;X6&quot;</span>, Color = <span class="string">&quot;white&quot;</span> &#125;</span><br><span class="line">            );</span><br><span class="line">            factory.listFlyweights();</span><br><span class="line"></span><br><span class="line">            addCarToPoliceDatabase(factory, <span class="keyword">new</span> Car &#123;</span><br><span class="line">                Number = <span class="string">&quot;CL234IR&quot;</span>,</span><br><span class="line">                Owner = <span class="string">&quot;James Doe&quot;</span>,</span><br><span class="line">                Company = <span class="string">&quot;BMW&quot;</span>,</span><br><span class="line">                Model = <span class="string">&quot;M5&quot;</span>,</span><br><span class="line">                Color = <span class="string">&quot;red&quot;</span></span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            addCarToPoliceDatabase(factory, <span class="keyword">new</span> Car &#123;</span><br><span class="line">                Number = <span class="string">&quot;CL234IR&quot;</span>,</span><br><span class="line">                Owner = <span class="string">&quot;James Doe&quot;</span>,</span><br><span class="line">                Company = <span class="string">&quot;BMW&quot;</span>,</span><br><span class="line">                Model = <span class="string">&quot;X1&quot;</span>,</span><br><span class="line">                Color = <span class="string">&quot;red&quot;</span></span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            factory.listFlyweights();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addCarToPoliceDatabase</span>(<span class="params">FlyweightFactory factory, Car car</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;\nClient: Adding a car to database.&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> flyweight = factory.GetFlyweight(<span class="keyword">new</span> Car &#123;</span><br><span class="line">                Color = car.Color,</span><br><span class="line">                Model = car.Model,</span><br><span class="line">                Company = car.Company</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// The client code either stores or calculates extrinsic state and</span></span><br><span class="line">            <span class="comment">// passes it to the flyweight&#x27;s methods.</span></span><br><span class="line">            flyweight.Operation(car);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Output.txt:</strong> 执行结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">FlyweightFactory: I have 5 flyweights:</span><br><span class="line">Camaro2018_Chevrolet_pink</span><br><span class="line">black_C300_Mercedes Benz</span><br><span class="line">C500_Mercedes Benz_red</span><br><span class="line">BMW_M5_red</span><br><span class="line">BMW_white_X6</span><br><span class="line"></span><br><span class="line">Client: Adding a car to database.</span><br><span class="line">FlyweightFactory: Reusing existing flyweight.</span><br><span class="line">Flyweight: Displaying shared &#123;&quot;Owner&quot;:null,&quot;Number&quot;:null,&quot;Company&quot;:&quot;BMW&quot;,&quot;Model&quot;:&quot;M5&quot;,&quot;Color&quot;:&quot;red&quot;&#125; and unique &#123;&quot;Owner&quot;:&quot;James Doe&quot;,&quot;Number&quot;:&quot;CL234IR&quot;,&quot;Company&quot;:&quot;BMW&quot;,&quot;Model&quot;:&quot;M5&quot;,&quot;Color&quot;:&quot;red&quot;&#125; state.</span><br><span class="line"></span><br><span class="line">Client: Adding a car to database.</span><br><span class="line">FlyweightFactory: Can&#x27;t find a flyweight, creating new one.</span><br><span class="line">Flyweight: Displaying shared &#123;&quot;Owner&quot;:null,&quot;Number&quot;:null,&quot;Company&quot;:&quot;BMW&quot;,&quot;Model&quot;:&quot;X1&quot;,&quot;Color&quot;:&quot;red&quot;&#125; and unique &#123;&quot;Owner&quot;:&quot;James Doe&quot;,&quot;Number&quot;:&quot;CL234IR&quot;,&quot;Company&quot;:&quot;BMW&quot;,&quot;Model&quot;:&quot;X1&quot;,&quot;Color&quot;:&quot;red&quot;&#125; state.</span><br><span class="line"></span><br><span class="line">FlyweightFactory: I have 6 flyweights:</span><br><span class="line">Camaro2018_Chevrolet_pink</span><br><span class="line">black_C300_Mercedes Benz</span><br><span class="line">C500_Mercedes Benz_red</span><br><span class="line">BMW_M5_red</span><br><span class="line">BMW_white_X6</span><br><span class="line">BMW_red_X1</span><br></pre></td></tr></table></figure></div><div class="tab-item-content"><p><strong>在 C++ 中使用模式</strong></p>
<p><strong>复杂度：</strong> ★★★</p>
<p><strong>流行度：</strong> ★☆☆</p>
<p><strong>使用示例：</strong> 享元模式只有一个目的： 将内存消耗最小化。 如果你的程序没有遇到内存容量不足的问题， 则可以暂时忽略该模式。</p>
<p><strong>识别方法：</strong> 享元可以通过构建方法来识别， 它会返回缓存对象而不是创建新的对象。</p>
<p><strong>概念示例</strong></p>
<p>本例说明了<strong>享元</strong>设计模式的结构并重点回答了下面的问题：</p>
<ul>
<li>它由哪些类组成？</li>
<li>这些类扮演了哪些角色？</li>
<li>模式中的各个元素会以何种方式相互关联？</li>
</ul>
<p><strong>main.cc:</strong> 概念示例</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Flyweight Design Pattern</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Intent: Lets you fit more objects into the available amount of RAM by sharing</span></span><br><span class="line"><span class="comment"> * common parts of state between multiple objects, instead of keeping all of the</span></span><br><span class="line"><span class="comment"> * data in each object.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">SharedState</span></span><br><span class="line">&#123;</span><br><span class="line">    std::string brand_;</span><br><span class="line">    std::string model_;</span><br><span class="line">    std::string color_;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">SharedState</span>(<span class="type">const</span> std::string &amp;brand, <span class="type">const</span> std::string &amp;model, <span class="type">const</span> std::string &amp;color)</span><br><span class="line">        : <span class="built_in">brand_</span>(brand), <span class="built_in">model_</span>(model), <span class="built_in">color_</span>(color)</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">friend</span> std::ostream &amp;<span class="keyword">operator</span>&lt;&lt;(std::ostream &amp;os, <span class="type">const</span> SharedState &amp;ss)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> os &lt;&lt; <span class="string">&quot;[ &quot;</span> &lt;&lt; ss.brand_ &lt;&lt; <span class="string">&quot; , &quot;</span> &lt;&lt; ss.model_ &lt;&lt; <span class="string">&quot; , &quot;</span> &lt;&lt; ss.color_ &lt;&lt; <span class="string">&quot; ]&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">UniqueState</span></span><br><span class="line">&#123;</span><br><span class="line">    std::string owner_;</span><br><span class="line">    std::string plates_;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">UniqueState</span>(<span class="type">const</span> std::string &amp;owner, <span class="type">const</span> std::string &amp;plates)</span><br><span class="line">        : <span class="built_in">owner_</span>(owner), <span class="built_in">plates_</span>(plates)</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">friend</span> std::ostream &amp;<span class="keyword">operator</span>&lt;&lt;(std::ostream &amp;os, <span class="type">const</span> UniqueState &amp;us)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> os &lt;&lt; <span class="string">&quot;[ &quot;</span> &lt;&lt; us.owner_ &lt;&lt; <span class="string">&quot; , &quot;</span> &lt;&lt; us.plates_ &lt;&lt; <span class="string">&quot; ]&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The Flyweight stores a common portion of the state (also called intrinsic</span></span><br><span class="line"><span class="comment"> * state) that belongs to multiple real business entities. The Flyweight accepts</span></span><br><span class="line"><span class="comment"> * the rest of the state (extrinsic state, unique for each entity) via its</span></span><br><span class="line"><span class="comment"> * method parameters.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Flyweight</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    SharedState *shared_state_;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Flyweight</span>(<span class="type">const</span> SharedState *shared_state) : <span class="built_in">shared_state_</span>(<span class="keyword">new</span> <span class="built_in">SharedState</span>(*shared_state))</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">Flyweight</span>(<span class="type">const</span> Flyweight &amp;other) : <span class="built_in">shared_state_</span>(<span class="keyword">new</span> <span class="built_in">SharedState</span>(*other.shared_state_))</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    ~<span class="built_in">Flyweight</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">delete</span> shared_state_;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">SharedState *<span class="title">shared_state</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> shared_state_;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Operation</span><span class="params">(<span class="type">const</span> UniqueState &amp;unique_state)</span> <span class="type">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Flyweight: Displaying shared (&quot;</span> &lt;&lt; *shared_state_ &lt;&lt; <span class="string">&quot;) and unique (&quot;</span> &lt;&lt; unique_state &lt;&lt; <span class="string">&quot;) state.\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The Flyweight Factory creates and manages the Flyweight objects. It ensures</span></span><br><span class="line"><span class="comment"> * that flyweights are shared correctly. When the client requests a flyweight,</span></span><br><span class="line"><span class="comment"> * the factory either returns an existing instance or creates a new one, if it</span></span><br><span class="line"><span class="comment"> * doesn&#x27;t exist yet.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FlyweightFactory</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @var Flyweight[]</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::unordered_map&lt;std::string, Flyweight&gt; flyweights_;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns a Flyweight&#x27;s string hash for a given state.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">std::string <span class="title">GetKey</span><span class="params">(<span class="type">const</span> SharedState &amp;ss)</span> <span class="type">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ss.brand_ + <span class="string">&quot;_&quot;</span> + ss.model_ + <span class="string">&quot;_&quot;</span> + ss.color_;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">FlyweightFactory</span>(std::initializer_list&lt;SharedState&gt; share_states)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">const</span> SharedState &amp;ss : share_states)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>-&gt;flyweights_.<span class="built_in">insert</span>(std::<span class="built_in">make_pair</span>&lt;std::string, Flyweight&gt;(<span class="keyword">this</span>-&gt;<span class="built_in">GetKey</span>(ss), <span class="built_in">Flyweight</span>(&amp;ss)));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns an existing Flyweight with a given state or creates a new one.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Flyweight <span class="title">GetFlyweight</span><span class="params">(<span class="type">const</span> SharedState &amp;shared_state)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        std::string key = <span class="keyword">this</span>-&gt;<span class="built_in">GetKey</span>(shared_state);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>-&gt;flyweights_.<span class="built_in">find</span>(key) == <span class="keyword">this</span>-&gt;flyweights_.<span class="built_in">end</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;FlyweightFactory: Can&#x27;t find a flyweight, creating new one.\n&quot;</span>;</span><br><span class="line">            <span class="keyword">this</span>-&gt;flyweights_.<span class="built_in">insert</span>(std::<span class="built_in">make_pair</span>(key, <span class="built_in">Flyweight</span>(&amp;shared_state)));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;FlyweightFactory: Reusing existing flyweight.\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>-&gt;flyweights_.<span class="built_in">at</span>(key);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">ListFlyweights</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="type">size_t</span> count = <span class="keyword">this</span>-&gt;flyweights_.<span class="built_in">size</span>();</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;\nFlyweightFactory: I have &quot;</span> &lt;&lt; count &lt;&lt; <span class="string">&quot; flyweights:\n&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (std::pair&lt;std::string, Flyweight&gt; pair : <span class="keyword">this</span>-&gt;flyweights_)</span><br><span class="line">        &#123;</span><br><span class="line">            std::cout &lt;&lt; pair.first &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">AddCarToPoliceDatabase</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    FlyweightFactory &amp;ff, <span class="type">const</span> std::string &amp;plates, <span class="type">const</span> std::string &amp;owner,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> std::string &amp;brand, <span class="type">const</span> std::string &amp;model, <span class="type">const</span> std::string &amp;color)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;\nClient: Adding a car to database.\n&quot;</span>;</span><br><span class="line">    <span class="type">const</span> Flyweight &amp;flyweight = ff.<span class="built_in">GetFlyweight</span>(&#123;brand, model, color&#125;);</span><br><span class="line">    <span class="comment">// The client code either stores or calculates extrinsic state and passes it</span></span><br><span class="line">    <span class="comment">// to the flyweight&#x27;s methods.</span></span><br><span class="line">    flyweight.<span class="built_in">Operation</span>(&#123;owner, plates&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The client code usually creates a bunch of pre-populated flyweights in the</span></span><br><span class="line"><span class="comment"> * initialization stage of the application.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FlyweightFactory *factory = <span class="keyword">new</span> <span class="built_in">FlyweightFactory</span>(&#123;&#123;<span class="string">&quot;Chevrolet&quot;</span>, <span class="string">&quot;Camaro2018&quot;</span>, <span class="string">&quot;pink&quot;</span>&#125;, &#123;<span class="string">&quot;Mercedes Benz&quot;</span>, <span class="string">&quot;C300&quot;</span>, <span class="string">&quot;black&quot;</span>&#125;, &#123;<span class="string">&quot;Mercedes Benz&quot;</span>, <span class="string">&quot;C500&quot;</span>, <span class="string">&quot;red&quot;</span>&#125;, &#123;<span class="string">&quot;BMW&quot;</span>, <span class="string">&quot;M5&quot;</span>, <span class="string">&quot;red&quot;</span>&#125;, &#123;<span class="string">&quot;BMW&quot;</span>, <span class="string">&quot;X6&quot;</span>, <span class="string">&quot;white&quot;</span>&#125;&#125;);</span><br><span class="line">    factory-&gt;<span class="built_in">ListFlyweights</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">AddCarToPoliceDatabase</span>(*factory,</span><br><span class="line">                            <span class="string">&quot;CL234IR&quot;</span>,</span><br><span class="line">                            <span class="string">&quot;James Doe&quot;</span>,</span><br><span class="line">                            <span class="string">&quot;BMW&quot;</span>,</span><br><span class="line">                            <span class="string">&quot;M5&quot;</span>,</span><br><span class="line">                            <span class="string">&quot;red&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">AddCarToPoliceDatabase</span>(*factory,</span><br><span class="line">                            <span class="string">&quot;CL234IR&quot;</span>,</span><br><span class="line">                            <span class="string">&quot;James Doe&quot;</span>,</span><br><span class="line">                            <span class="string">&quot;BMW&quot;</span>,</span><br><span class="line">                            <span class="string">&quot;X1&quot;</span>,</span><br><span class="line">                            <span class="string">&quot;red&quot;</span>);</span><br><span class="line">    factory-&gt;<span class="built_in">ListFlyweights</span>();</span><br><span class="line">    <span class="keyword">delete</span> factory;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Output.txt:</strong> 执行结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">FlyweightFactory: I have 5 flyweights:</span><br><span class="line">BMW_X6_white</span><br><span class="line">Mercedes Benz_C500_red</span><br><span class="line">Mercedes Benz_C300_black</span><br><span class="line">BMW_M5_red</span><br><span class="line">Chevrolet_Camaro2018_pink</span><br><span class="line"></span><br><span class="line">Client: Adding a car to database.</span><br><span class="line">FlyweightFactory: Reusing existing flyweight.</span><br><span class="line">Flyweight: Displaying shared ([ BMW , M5 , red ]) and unique ([ CL234IR , James Doe ]) state.</span><br><span class="line"></span><br><span class="line">Client: Adding a car to database.</span><br><span class="line">FlyweightFactory: Can&#x27;t find a flyweight, creating new one.</span><br><span class="line">Flyweight: Displaying shared ([ BMW , X1 , red ]) and unique ([ CL234IR , James Doe ]) state.</span><br><span class="line"></span><br><span class="line">FlyweightFactory: I have 6 flyweights:</span><br><span class="line">BMW_X1_red</span><br><span class="line">Mercedes Benz_C300_black</span><br><span class="line">BMW_X6_white</span><br><span class="line">Mercedes Benz_C500_red</span><br><span class="line">BMW_M5_red</span><br><span class="line">Chevrolet_Camaro2018_pink</span><br></pre></td></tr></table></figure></div><div class="tab-item-content"><p><strong>在 Java 中使用模式</strong></p>
<p><strong>复杂度：</strong> ★★★</p>
<p><strong>流行度：</strong> ★☆☆</p>
<p><strong>使用示例：</strong> 享元模式只有一个目的： 将内存消耗最小化。 如果你的程序没有遇到内存容量不足的问题， 则可以暂时忽略该模式。</p>
<p>享元模式在核心 Java 程序库中的示例：</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://docs.oracle.com/javase/8/docs/api/java/lang/Integer.html#valueOf-int-"><code>java.lang.Integer#valueOf(int)</code></a> （以及 <a target="_blank" rel="noopener" href="http://docs.oracle.com/javase/8/docs/api/java/lang/Boolean.html#valueOf-boolean-"><code>Boolean</code></a>、 <a target="_blank" rel="noopener" href="http://docs.oracle.com/javase/8/docs/api/java/lang/Byte.html#valueOf-byte-"><code>Byte</code></a>、 <a target="_blank" rel="noopener" href="http://docs.oracle.com/javase/8/docs/api/java/lang/Character.html#valueOf-char-"><code>Character</code></a>、 <a target="_blank" rel="noopener" href="http://docs.oracle.com/javase/8/docs/api/java/lang/Short.html#valueOf-short-"><code>Short</code></a>、 <a target="_blank" rel="noopener" href="http://docs.oracle.com/javase/8/docs/api/java/lang/Long.html#valueOf-long-"><code>Long</code></a> 和 <a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/api/java/math/BigDecimal.html#valueOf-long-int-"><code>Big­Decimal</code></a>）</li>
</ul>
<p><strong>识别方法：</strong> 享元可以通过构建方法来识别， 它会返回缓存对象而不是创建新的对象。</p>
<p><strong>渲染一片森林</strong></p>
<p>本例中， 我们将渲染一片森林 （1,000,000 棵树）！ 每棵树都由包含一些状态的对象来表示 （坐标和纹理等）。 尽管程序能够完成其主要工作， 但很显然它需要消耗大量内存。</p>
<p>原因很简单： 太多树对象包含重复数据 （名称、 纹理和颜色）。 因此我们可用享元模式来将这些数值存储在单独的享元对象中 （ <code>Tree­Type</code>类）。 现在我们不再将相同数据存储在数千个 <code>Tree</code>对象中， 而是使用一组特殊的数值来引用其中一个享元对象。</p>
<p>客户端代码不会知道任何事情， 因为重用享元对象的复杂机制隐藏在了享元工厂中。</p>
<p><strong>trees</strong></p>
<p><strong>trees&#x2F;Tree.java:</strong> 包含每棵树的独特状态</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> refactoring_guru.flyweight.example.trees;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.awt.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Tree</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> x;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> y;</span><br><span class="line">    <span class="keyword">private</span> TreeType type;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Tree</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y, TreeType type)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.x = x;</span><br><span class="line">        <span class="built_in">this</span>.y = y;</span><br><span class="line">        <span class="built_in">this</span>.type = type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">draw</span><span class="params">(Graphics g)</span> &#123;</span><br><span class="line">        type.draw(g, x, y);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>trees&#x2F;TreeType.java:</strong> 包含多棵树共享的状态</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> refactoring_guru.flyweight.example.trees;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.awt.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TreeType</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Color color;</span><br><span class="line">    <span class="keyword">private</span> String otherTreeData;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TreeType</span><span class="params">(String name, Color color, String otherTreeData)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.color = color;</span><br><span class="line">        <span class="built_in">this</span>.otherTreeData = otherTreeData;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">draw</span><span class="params">(Graphics g, <span class="type">int</span> x, <span class="type">int</span> y)</span> &#123;</span><br><span class="line">        g.setColor(Color.BLACK);</span><br><span class="line">        g.fillRect(x - <span class="number">1</span>, y, <span class="number">3</span>, <span class="number">5</span>);</span><br><span class="line">        g.setColor(color);</span><br><span class="line">        g.fillOval(x - <span class="number">5</span>, y - <span class="number">10</span>, <span class="number">10</span>, <span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>trees&#x2F;TreeFactory.java:</strong> 封装创建享元的复杂机制</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> refactoring_guru.flyweight.example.trees;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.awt.*;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TreeFactory</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> Map&lt;String, TreeType&gt; treeTypes = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> TreeType <span class="title function_">getTreeType</span><span class="params">(String name, Color color, String otherTreeData)</span> &#123;</span><br><span class="line">        <span class="type">TreeType</span> <span class="variable">result</span> <span class="operator">=</span> treeTypes.get(name);</span><br><span class="line">        <span class="keyword">if</span> (result == <span class="literal">null</span>) &#123;</span><br><span class="line">            result = <span class="keyword">new</span> <span class="title class_">TreeType</span>(name, color, otherTreeData);</span><br><span class="line">            treeTypes.put(name, result);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>forest</strong></p>
<p><strong>forest&#x2F;Forest.java:</strong> 我们绘制的森林</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> refactoring_guru.flyweight.example.forest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> refactoring_guru.flyweight.example.trees.Tree;</span><br><span class="line"><span class="keyword">import</span> refactoring_guru.flyweight.example.trees.TreeFactory;</span><br><span class="line"><span class="keyword">import</span> refactoring_guru.flyweight.example.trees.TreeType;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.swing.*;</span><br><span class="line"><span class="keyword">import</span> java.awt.*;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Forest</span> <span class="keyword">extends</span> <span class="title class_">JFrame</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Tree&gt; trees = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">plantTree</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y, String name, Color color, String otherTreeData)</span> &#123;</span><br><span class="line">        <span class="type">TreeType</span> <span class="variable">type</span> <span class="operator">=</span> TreeFactory.getTreeType(name, color, otherTreeData);</span><br><span class="line">        <span class="type">Tree</span> <span class="variable">tree</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Tree</span>(x, y, type);</span><br><span class="line">        trees.add(tree);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">paint</span><span class="params">(Graphics graphics)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (Tree tree : trees) &#123;</span><br><span class="line">            tree.draw(graphics);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Demo.java:</strong> 客户端代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> refactoring_guru.flyweight.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> refactoring_guru.flyweight.example.forest.Forest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.awt.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span> <span class="variable">CANVAS_SIZE</span> <span class="operator">=</span> <span class="number">500</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span> <span class="variable">TREES_TO_DRAW</span> <span class="operator">=</span> <span class="number">1000000</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span> <span class="variable">TREE_TYPES</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Forest</span> <span class="variable">forest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Forest</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; Math.floor(TREES_TO_DRAW / TREE_TYPES); i++) &#123;</span><br><span class="line">            forest.plantTree(random(<span class="number">0</span>, CANVAS_SIZE), random(<span class="number">0</span>, CANVAS_SIZE),</span><br><span class="line">                    <span class="string">&quot;Summer Oak&quot;</span>, Color.GREEN, <span class="string">&quot;Oak texture stub&quot;</span>);</span><br><span class="line">            forest.plantTree(random(<span class="number">0</span>, CANVAS_SIZE), random(<span class="number">0</span>, CANVAS_SIZE),</span><br><span class="line">                    <span class="string">&quot;Autumn Oak&quot;</span>, Color.ORANGE, <span class="string">&quot;Autumn Oak texture stub&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        forest.setSize(CANVAS_SIZE, CANVAS_SIZE);</span><br><span class="line">        forest.setVisible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(TREES_TO_DRAW + <span class="string">&quot; trees drawn&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;---------------------&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;Memory usage:&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;Tree size (8 bytes) * &quot;</span> + TREES_TO_DRAW);</span><br><span class="line">        System.out.println(<span class="string">&quot;+ TreeTypes size (~30 bytes) * &quot;</span> + TREE_TYPES + <span class="string">&quot;&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;---------------------&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;Total: &quot;</span> + ((TREES_TO_DRAW * <span class="number">8</span> + TREE_TYPES * <span class="number">30</span>) / <span class="number">1024</span> / <span class="number">1024</span>) +</span><br><span class="line">                <span class="string">&quot;MB (instead of &quot;</span> + ((TREES_TO_DRAW * <span class="number">38</span>) / <span class="number">1024</span> / <span class="number">1024</span>) + <span class="string">&quot;MB)&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">random</span><span class="params">(<span class="type">int</span> min, <span class="type">int</span> max)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> min + (<span class="type">int</span>) (Math.random() * ((max - min) + <span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>OutputDemo.png:</strong> 屏幕截图</p>
<p><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/blog/pattern/OutputDemo-flywight.png"></p>
<p><strong>OutputDemo.txt:</strong> 内存使用统计</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1000000 trees drawn</span><br><span class="line">---------------------</span><br><span class="line">Memory usage:</span><br><span class="line">Tree size (8 bytes) * 1000000</span><br><span class="line">+ TreeTypes size (~30 bytes) * 2</span><br><span class="line">---------------------</span><br><span class="line">Total: 7MB (instead of 36MB)</span><br></pre></td></tr></table></figure></div><div class="tab-item-content"><p><strong>在 PHP 中使用模式</strong></p>
<p><strong>复杂度：</strong> ★★★</p>
<p><strong>流行度：</strong> ☆☆☆</p>
<p><strong>使用示例：</strong> 由于 PHP 语言的特性， 享元模式很少在 PHP 中使用。 PHP 脚本通常仅需要应用的一部分数据， 从不会同时将所有数据载入内存。</p>
<p><strong>识别方法：</strong> 享元可以通过构建方法来识别， 它会返回缓存对象而不是创建新的对象。</p>
<div class="tabs"><div class="nav-tabs"><button type="button" class="tab active">概念示例</button><button type="button" class="tab">真实世界示例</button></div><div class="tab-contents"><div class="tab-item-content active"><p><strong>概念示例</strong></p>
<p>本例说明了<strong>享元</strong>设计模式的结构并重点回答了下面的问题：</p>
<ul>
<li>它由哪些类组成？</li>
<li>这些类扮演了哪些角色？</li>
<li>模式中的各个元素会以何种方式相互关联？</li>
</ul>
<p>了解该模式的结构后， 你可以更轻松地理解下面基于真实世界的 PHP 应用案例。</p>
<p><strong>index.php:</strong> 概念示例</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">RefactoringGuru</span>\<span class="title class_">Flyweight</span>\<span class="title class_">Conceptual</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The Flyweight stores a common portion of the state (also called intrinsic</span></span><br><span class="line"><span class="comment"> * state) that belongs to multiple real business entities. The Flyweight accepts</span></span><br><span class="line"><span class="comment"> * the rest of the state (extrinsic state, unique for each entity) via its</span></span><br><span class="line"><span class="comment"> * method parameters.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flyweight</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$sharedState</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$sharedState</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;sharedState = <span class="variable">$sharedState</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">operation</span>(<span class="params"><span class="variable">$uniqueState</span></span>): <span class="title">void</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$s</span> = <span class="title function_ invoke__">json_encode</span>(<span class="variable">$this</span>-&gt;sharedState);</span><br><span class="line">        <span class="variable">$u</span> = <span class="title function_ invoke__">json_encode</span>(<span class="variable">$uniqueState</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Flyweight: Displaying shared (<span class="subst">$s</span>) and unique (<span class="subst">$u</span>) state.\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The Flyweight Factory creates and manages the Flyweight objects. It ensures</span></span><br><span class="line"><span class="comment"> * that flyweights are shared correctly. When the client requests a flyweight,</span></span><br><span class="line"><span class="comment"> * the factory either returns an existing instance or creates a new one, if it</span></span><br><span class="line"><span class="comment"> * doesn&#x27;t exist yet.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlyweightFactory</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> Flyweight[]</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$flyweights</span> = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$initialFlyweights</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$initialFlyweights</span> <span class="keyword">as</span> <span class="variable">$state</span>) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;flyweights[<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getKey</span>(<span class="variable">$state</span>)] = <span class="keyword">new</span> <span class="title class_">Flyweight</span>(<span class="variable">$state</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns a Flyweight&#x27;s string hash for a given state.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">getKey</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$state</span></span>): <span class="title">string</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">ksort</span>(<span class="variable">$state</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">implode</span>(<span class="string">&quot;_&quot;</span>, <span class="variable">$state</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns an existing Flyweight with a given state or creates a new one.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getFlyweight</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$sharedState</span></span>): <span class="title">Flyweight</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$key</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getKey</span>(<span class="variable">$sharedState</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;flyweights[<span class="variable">$key</span>])) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;FlyweightFactory: Can&#x27;t find a flyweight, creating new one.\n&quot;</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;flyweights[<span class="variable">$key</span>] = <span class="keyword">new</span> <span class="title class_">Flyweight</span>(<span class="variable">$sharedState</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;FlyweightFactory: Reusing existing flyweight.\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;flyweights[<span class="variable">$key</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">listFlyweights</span>(<span class="params"></span>): <span class="title">void</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$count</span> = <span class="title function_ invoke__">count</span>(<span class="variable">$this</span>-&gt;flyweights);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;\nFlyweightFactory: I have <span class="subst">$count</span> flyweights:\n&quot;</span>;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;flyweights <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$flyweight</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$key</span> . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The client code usually creates a bunch of pre-populated flyweights in the</span></span><br><span class="line"><span class="comment"> * initialization stage of the application.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="variable">$factory</span> = <span class="keyword">new</span> <span class="title class_">FlyweightFactory</span>([</span><br><span class="line">    [<span class="string">&quot;Chevrolet&quot;</span>, <span class="string">&quot;Camaro2018&quot;</span>, <span class="string">&quot;pink&quot;</span>],</span><br><span class="line">    [<span class="string">&quot;Mercedes Benz&quot;</span>, <span class="string">&quot;C300&quot;</span>, <span class="string">&quot;black&quot;</span>],</span><br><span class="line">    [<span class="string">&quot;Mercedes Benz&quot;</span>, <span class="string">&quot;C500&quot;</span>, <span class="string">&quot;red&quot;</span>],</span><br><span class="line">    [<span class="string">&quot;BMW&quot;</span>, <span class="string">&quot;M5&quot;</span>, <span class="string">&quot;red&quot;</span>],</span><br><span class="line">    [<span class="string">&quot;BMW&quot;</span>, <span class="string">&quot;X6&quot;</span>, <span class="string">&quot;white&quot;</span>],</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">]);</span><br><span class="line"><span class="variable">$factory</span>-&gt;<span class="title function_ invoke__">listFlyweights</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addCarToPoliceDatabase</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    FlyweightFactory <span class="variable">$ff</span>, <span class="variable">$plates</span>, <span class="variable">$owner</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="variable">$brand</span>, <span class="variable">$model</span>, <span class="variable">$color</span></span></span></span><br><span class="line"><span class="params"><span class="function"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;\nClient: Adding a car to database.\n&quot;</span>;</span><br><span class="line">    <span class="variable">$flyweight</span> = <span class="variable">$ff</span>-&gt;<span class="title function_ invoke__">getFlyweight</span>([<span class="variable">$brand</span>, <span class="variable">$model</span>, <span class="variable">$color</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The client code either stores or calculates extrinsic state and passes it</span></span><br><span class="line">    <span class="comment">// to the flyweight&#x27;s methods.</span></span><br><span class="line">    <span class="variable">$flyweight</span>-&gt;<span class="title function_ invoke__">operation</span>([<span class="variable">$plates</span>, <span class="variable">$owner</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">addCarToPoliceDatabase</span>(<span class="variable">$factory</span>,</span><br><span class="line">    <span class="string">&quot;CL234IR&quot;</span>,</span><br><span class="line">    <span class="string">&quot;James Doe&quot;</span>,</span><br><span class="line">    <span class="string">&quot;BMW&quot;</span>,</span><br><span class="line">    <span class="string">&quot;M5&quot;</span>,</span><br><span class="line">    <span class="string">&quot;red&quot;</span>,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">addCarToPoliceDatabase</span>(<span class="variable">$factory</span>,</span><br><span class="line">    <span class="string">&quot;CL234IR&quot;</span>,</span><br><span class="line">    <span class="string">&quot;James Doe&quot;</span>,</span><br><span class="line">    <span class="string">&quot;BMW&quot;</span>,</span><br><span class="line">    <span class="string">&quot;X1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;red&quot;</span>,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="variable">$factory</span>-&gt;<span class="title function_ invoke__">listFlyweights</span>();</span><br></pre></td></tr></table></figure>

<p><strong>Output.txt:</strong> 执行结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">FlyweightFactory: I have 5 flyweights:</span><br><span class="line">Chevrolet_Camaro2018_pink</span><br><span class="line">Mercedes Benz_C300_black</span><br><span class="line">Mercedes Benz_C500_red</span><br><span class="line">BMW_M5_red</span><br><span class="line">BMW_X6_white</span><br><span class="line"></span><br><span class="line">Client: Adding a car to database.</span><br><span class="line">FlyweightFactory: Reusing existing flyweight.</span><br><span class="line">Flyweight: Displaying shared ([&quot;BMW&quot;,&quot;M5&quot;,&quot;red&quot;]) and unique ([&quot;CL234IR&quot;,&quot;James Doe&quot;]) state.</span><br><span class="line"></span><br><span class="line">Client: Adding a car to database.</span><br><span class="line">FlyweightFactory: Can&#x27;t find a flyweight, creating new one.</span><br><span class="line">Flyweight: Displaying shared ([&quot;BMW&quot;,&quot;X1&quot;,&quot;red&quot;]) and unique ([&quot;CL234IR&quot;,&quot;James Doe&quot;]) state.</span><br><span class="line"></span><br><span class="line">FlyweightFactory: I have 6 flyweights:</span><br><span class="line">Chevrolet_Camaro2018_pink</span><br><span class="line">Mercedes Benz_C300_black</span><br><span class="line">Mercedes Benz_C500_red</span><br><span class="line">BMW_M5_red</span><br><span class="line">BMW_X6_white</span><br><span class="line">BMW_X1_red</span><br></pre></td></tr></table></figure></div><div class="tab-item-content"><p><strong>真实世界示例</strong></p>
<p>在我们开始前， 请注意<strong>享元</strong>模式在 PHP 中的真实应用情况非常罕见。 这源于 PHP 的单线程特性， 你不应该在同一线程中同时将应用中的所有对象载入内存。 尽管本例并非完全严谨， 且内存问题可以通过调整应用结构来解决， 但是它仍说明了在真实世界中使用该模式时的概念。 好了， 我已经做完了免责声明。 现在让我们开始吧。</p>
<p>在本例中， 享元模式被用于将猫类专科兽医诊所动物数据库中的对象内存用量最小化。 数据库中的每条记录都将由对象 <code>猫</code>来表示， 其数据由两个部分组成：</p>
<ol>
<li>特殊 （外在） 数据 （例如宠物名字、 年龄和主人的信息）。</li>
<li>共享 （内在） 数据 （例如品种名称、 颜色和纹理等）。</li>
</ol>
<p>第一部分直接存储在 <code>猫</code>类中作为上下文。 但第二部分则会单独存储且由好几只猫共享。 共享数据存储在 <code>猫品种</code> （Cat­Variation） 类中。 所有包含类似特征的猫都会链接到同一个 <code>猫品种</code>类， 而不是在其自身对象中存储重复的数据。</p>
<p><strong>index.php:</strong> 真实世界示例</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">RefactoringGuru</span>\<span class="title class_">Flyweight</span>\<span class="title class_">RealWorld</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Flyweight objects represent the data shared by multiple Cat objects. This is</span></span><br><span class="line"><span class="comment"> * the combination of breed, color, texture, etc.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CatVariation</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The so-called &quot;intrinsic&quot; state.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$breed</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$image</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$color</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$texture</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$fur</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$size</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">string</span> <span class="variable">$breed</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">string</span> <span class="variable">$image</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">string</span> <span class="variable">$color</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">string</span> <span class="variable">$texture</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">string</span> <span class="variable">$fur</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">string</span> <span class="variable">$size</span></span></span></span><br><span class="line"><span class="params"><span class="function">    </span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;breed = <span class="variable">$breed</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;image = <span class="variable">$image</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;color = <span class="variable">$color</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;texture = <span class="variable">$texture</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;fur = <span class="variable">$fur</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;size = <span class="variable">$size</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * This method displays the cat information. The method accepts the</span></span><br><span class="line"><span class="comment">     * extrinsic  state as arguments. The rest of the state is stored inside</span></span><br><span class="line"><span class="comment">     * Flyweight&#x27;s fields.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * You might be wondering why we had put the primary cat&#x27;s logic into the</span></span><br><span class="line"><span class="comment">     * CatVariation class instead of keeping it in the Cat class. I agree, it</span></span><br><span class="line"><span class="comment">     * does sound confusing.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Keep in mind that in the real world, the Flyweight pattern can either be</span></span><br><span class="line"><span class="comment">     * implemented from the start or forced onto an existing application</span></span><br><span class="line"><span class="comment">     * whenever the developers realize they&#x27;ve hit upon a RAM problem.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * In the latter case, you end up with such classes as we have here. We kind</span></span><br><span class="line"><span class="comment">     * of &quot;refactored&quot; an ideal app where all the data was initially inside the</span></span><br><span class="line"><span class="comment">     * Cat class. If we had implemented the Flyweight from the start, our class</span></span><br><span class="line"><span class="comment">     * names might be different and less confusing. For example, Cat and</span></span><br><span class="line"><span class="comment">     * CatContext.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * However, the actual reason why the primary behavior should live in the</span></span><br><span class="line"><span class="comment">     * Flyweight class is that you might not have the Context class declared at</span></span><br><span class="line"><span class="comment">     * all. The context data might be stored in an array or some other more</span></span><br><span class="line"><span class="comment">     * efficient data structure. You won&#x27;t have another place to put your</span></span><br><span class="line"><span class="comment">     * methods in, except the Flyweight class.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">renderProfile</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$name</span>, <span class="keyword">string</span>  <span class="variable">$age</span>, <span class="keyword">string</span> <span class="variable">$owner</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;= <span class="subst">$name</span> =\n&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Age: <span class="subst">$age</span>\n&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Owner: <span class="subst">$owner</span>\n&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Breed: <span class="subst">$this</span>-&gt;breed\n&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Image: <span class="subst">$this</span>-&gt;image\n&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Color: <span class="subst">$this</span>-&gt;color\n&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Texture: <span class="subst">$this</span>-&gt;texture\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The context stores the data unique for each cat.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * A designated class for storing context is optional and not always viable. The</span></span><br><span class="line"><span class="comment"> * context may be stored inside a massive data structure within the Client code</span></span><br><span class="line"><span class="comment"> * and passed to the flyweight methods when needed.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cat</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The so-called &quot;extrinsic&quot; state.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$age</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$owner</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> CatVariation</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$variation</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$name</span>, <span class="keyword">string</span> <span class="variable">$age</span>, <span class="keyword">string</span> <span class="variable">$owner</span>, CatVariation <span class="variable">$variation</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;name = <span class="variable">$name</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;age = <span class="variable">$age</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;owner = <span class="variable">$owner</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;variation = <span class="variable">$variation</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Since the Context objects don&#x27;t own all of their state, sometimes, for</span></span><br><span class="line"><span class="comment">     * the sake of convenience, you may need to implement some helper methods</span></span><br><span class="line"><span class="comment">     * (for example, for comparing several Context objects.)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">matches</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$query</span></span>): <span class="title">bool</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$query</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">property_exists</span>(<span class="variable">$this</span>, <span class="variable">$key</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;<span class="variable">$key</span> != <span class="variable">$value</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">property_exists</span>(<span class="variable">$this</span>-&gt;variation, <span class="variable">$key</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;variation-&gt;<span class="variable">$key</span> != <span class="variable">$value</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The Context might also define several shortcut methods, that delegate</span></span><br><span class="line"><span class="comment">     * execution to the Flyweight object. These methods might be remnants of</span></span><br><span class="line"><span class="comment">     * real methods, extracted to the Flyweight class during a massive</span></span><br><span class="line"><span class="comment">     * refactoring to the Flyweight pattern.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params"></span>): <span class="title">string</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;variation-&gt;<span class="title function_ invoke__">renderProfile</span>(<span class="variable">$this</span>-&gt;name, <span class="variable">$this</span>-&gt;age, <span class="variable">$this</span>-&gt;owner);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The Flyweight Factory stores both the Context and Flyweight objects,</span></span><br><span class="line"><span class="comment"> * effectively hiding any notion of the Flyweight pattern from the client.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CatDataBase</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The list of cat objects (Contexts).</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$cats</span> = [];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The list of cat variations (Flyweights).</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$variations</span> = [];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * When adding a cat to the database, we look for an existing cat variation</span></span><br><span class="line"><span class="comment">     * first.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">addCat</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">string</span> <span class="variable">$name</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">string</span> <span class="variable">$age</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">string</span> <span class="variable">$owner</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">string</span> <span class="variable">$breed</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">string</span> <span class="variable">$image</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">string</span> <span class="variable">$color</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">string</span> <span class="variable">$texture</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">string</span> <span class="variable">$fur</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">string</span> <span class="variable">$size</span></span></span></span><br><span class="line"><span class="params"><span class="function">    </span>) </span>&#123;</span><br><span class="line">        <span class="variable">$variation</span> =</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getVariation</span>(<span class="variable">$breed</span>, <span class="variable">$image</span>, <span class="variable">$color</span>, <span class="variable">$texture</span>, <span class="variable">$fur</span>, <span class="variable">$size</span>);</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;cats[] = <span class="keyword">new</span> <span class="title class_">Cat</span>(<span class="variable">$name</span>, <span class="variable">$age</span>, <span class="variable">$owner</span>, <span class="variable">$variation</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;CatDataBase: Added a cat (<span class="subst">$name</span>, <span class="subst">$breed</span>).\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Return an existing variation (Flyweight) by given data or create a new</span></span><br><span class="line"><span class="comment">     * one if it doesn&#x27;t exist yet.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getVariation</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">string</span> <span class="variable">$breed</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">string</span> <span class="variable">$image</span>, <span class="variable">$color</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">string</span> <span class="variable">$texture</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">string</span> <span class="variable">$fur</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">string</span> <span class="variable">$size</span></span></span></span><br><span class="line"><span class="params"><span class="function">    </span>): <span class="title">CatVariation</span> </span>&#123;</span><br><span class="line">        <span class="variable">$key</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getKey</span>(<span class="title function_ invoke__">get_defined_vars</span>());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;variations[<span class="variable">$key</span>])) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;variations[<span class="variable">$key</span>] =</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">CatVariation</span>(<span class="variable">$breed</span>, <span class="variable">$image</span>, <span class="variable">$color</span>, <span class="variable">$texture</span>, <span class="variable">$fur</span>, <span class="variable">$size</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;variations[<span class="variable">$key</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * This function helps to generate unique array keys.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">getKey</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$data</span></span>): <span class="title">string</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">implode</span>(<span class="string">&quot;_&quot;</span>, <span class="variable">$data</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Look for a cat in the database using the given query parameters.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">findCat</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$query</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;cats <span class="keyword">as</span> <span class="variable">$cat</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$cat</span>-&gt;<span class="title function_ invoke__">matches</span>(<span class="variable">$query</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="variable">$cat</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;CatDataBase: Sorry, your query does not yield any results.&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The client code.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="variable">$db</span> = <span class="keyword">new</span> <span class="title class_">CatDataBase</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;Client: Let&#x27;s see what we have in \&quot;cats.csv\&quot;.\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// To see the real effect of the pattern, you should have a large database with</span></span><br><span class="line"><span class="comment">// several millions of records. Feel free to experiment with code to see the</span></span><br><span class="line"><span class="comment">// real extent of the pattern.</span></span><br><span class="line"><span class="variable">$handle</span> = <span class="title function_ invoke__">fopen</span>(<span class="keyword">__DIR__</span> . <span class="string">&quot;/cats.csv&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line"><span class="variable">$row</span> = <span class="number">0</span>;</span><br><span class="line"><span class="variable">$columns</span> = [];</span><br><span class="line"><span class="keyword">while</span> ((<span class="variable">$data</span> = <span class="title function_ invoke__">fgetcsv</span>(<span class="variable">$handle</span>)) !== <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$row</span> == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$c</span> = <span class="number">0</span>; <span class="variable">$c</span> &lt; <span class="title function_ invoke__">count</span>(<span class="variable">$data</span>); <span class="variable">$c</span>++) &#123;</span><br><span class="line">            <span class="variable">$columnIndex</span> = <span class="variable">$c</span>;</span><br><span class="line">            <span class="variable">$columnKey</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$data</span>[<span class="variable">$c</span>]);</span><br><span class="line">            <span class="variable">$columns</span>[<span class="variable">$columnKey</span>] = <span class="variable">$columnIndex</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$row</span>++;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">addCat</span>(</span><br><span class="line">        <span class="variable">$data</span>[<span class="variable">$columns</span>[<span class="string">&#x27;name&#x27;</span>]],</span><br><span class="line">        <span class="variable">$data</span>[<span class="variable">$columns</span>[<span class="string">&#x27;age&#x27;</span>]],</span><br><span class="line">        <span class="variable">$data</span>[<span class="variable">$columns</span>[<span class="string">&#x27;owner&#x27;</span>]],</span><br><span class="line">        <span class="variable">$data</span>[<span class="variable">$columns</span>[<span class="string">&#x27;breed&#x27;</span>]],</span><br><span class="line">        <span class="variable">$data</span>[<span class="variable">$columns</span>[<span class="string">&#x27;image&#x27;</span>]],</span><br><span class="line">        <span class="variable">$data</span>[<span class="variable">$columns</span>[<span class="string">&#x27;color&#x27;</span>]],</span><br><span class="line">        <span class="variable">$data</span>[<span class="variable">$columns</span>[<span class="string">&#x27;texture&#x27;</span>]],</span><br><span class="line">        <span class="variable">$data</span>[<span class="variable">$columns</span>[<span class="string">&#x27;fur&#x27;</span>]],</span><br><span class="line">        <span class="variable">$data</span>[<span class="variable">$columns</span>[<span class="string">&#x27;size&#x27;</span>]],</span><br><span class="line">    );</span><br><span class="line">    <span class="variable">$row</span>++;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">fclose</span>(<span class="variable">$handle</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;\nClient: Let&#x27;s look for a cat named \&quot;Siri\&quot;.\n&quot;</span>;</span><br><span class="line"><span class="variable">$cat</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">findCat</span>([<span class="string">&#x27;name&#x27;</span> =&gt; <span class="string">&quot;Siri&quot;</span>]);</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$cat</span>) &#123;</span><br><span class="line">    <span class="variable">$cat</span>-&gt;<span class="title function_ invoke__">render</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;\nClient: Let&#x27;s look for a cat named \&quot;Bob\&quot;.\n&quot;</span>;</span><br><span class="line"><span class="variable">$cat</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">findCat</span>([<span class="string">&#x27;name&#x27;</span> =&gt; <span class="string">&quot;Bob&quot;</span>]);</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$cat</span>) &#123;</span><br><span class="line">    <span class="variable">$cat</span>-&gt;<span class="title function_ invoke__">render</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Output.txt:</strong> 执行结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Client: Let&#x27;s see what we have in &quot;cats.csv&quot;.</span><br><span class="line">CatDataBase: Added a cat (Steve, Bengal).</span><br><span class="line">CatDataBase: Added a cat (Siri, Domestic short-haired).</span><br><span class="line">CatDataBase: Added a cat (Fluffy, Maine Coon).</span><br><span class="line"></span><br><span class="line">Client: Let&#x27;s look for a cat named &quot;Siri&quot;.</span><br><span class="line">= Siri =</span><br><span class="line">Age: 2</span><br><span class="line">Owner: Alexander Shvets</span><br><span class="line">Breed: Domestic short-haired</span><br><span class="line">Image: /cats/domestic-sh.jpg</span><br><span class="line">Color: Black</span><br><span class="line">Texture: Solid</span><br><span class="line"></span><br><span class="line">Client: Let&#x27;s look for a cat named &quot;Bob&quot;.</span><br><span class="line">CatDataBase: Sorry, your query does not yield any results.</span><br></pre></td></tr></table></figure></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><div class="tab-item-content"><p><strong>在 Python 中使用模式</strong></p>
<p><strong>复杂度：</strong> ★★★</p>
<p><strong>流行度：</strong> ☆☆☆</p>
<p><strong>使用示例：</strong> 享元模式只有一个目的： 将内存消耗最小化。 如果你的程序没有遇到内存容量不足的问题， 则可以暂时忽略该模式。</p>
<p><strong>识别方法：</strong> 享元可以通过构建方法来识别， 它会返回缓存对象而不是创建新的对象。</p>
<p><strong>概念示例</strong></p>
<p>本例说明了<strong>享元</strong>设计模式的结构并重点回答了下面的问题：</p>
<ul>
<li>它由哪些类组成？</li>
<li>这些类扮演了哪些角色？</li>
<li>模式中的各个元素会以何种方式相互关联？</li>
</ul>
<p><strong>main.py:</strong> 概念示例</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Flyweight</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    The Flyweight stores a common portion of the state (also called intrinsic</span></span><br><span class="line"><span class="string">    state) that belongs to multiple real business entities. The Flyweight</span></span><br><span class="line"><span class="string">    accepts the rest of the state (extrinsic state, unique for each entity) via</span></span><br><span class="line"><span class="string">    its method parameters.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, shared_state: <span class="built_in">str</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        self._shared_state = shared_state</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">operation</span>(<span class="params">self, unique_state: <span class="built_in">str</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        s = json.dumps(self._shared_state)</span><br><span class="line">        u = json.dumps(unique_state)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Flyweight: Displaying shared (<span class="subst">&#123;s&#125;</span>) and unique (<span class="subst">&#123;u&#125;</span>) state.&quot;</span>, end=<span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FlyweightFactory</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    The Flyweight Factory creates and manages the Flyweight objects. It ensures</span></span><br><span class="line"><span class="string">    that flyweights are shared correctly. When the client requests a flyweight,</span></span><br><span class="line"><span class="string">    the factory either returns an existing instance or creates a new one, if it</span></span><br><span class="line"><span class="string">    doesn&#x27;t exist yet.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    _flyweights: <span class="type">Dict</span>[<span class="built_in">str</span>, Flyweight] = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, initial_flyweights: <span class="type">Dict</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">for</span> state <span class="keyword">in</span> initial_flyweights:</span><br><span class="line">            self._flyweights[self.get_key(state)] = Flyweight(state)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_key</span>(<span class="params">self, state: <span class="type">Dict</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Returns a Flyweight&#x27;s string hash for a given state.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;_&quot;</span>.join(<span class="built_in">sorted</span>(state))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_flyweight</span>(<span class="params">self, shared_state: <span class="type">Dict</span></span>) -&gt; Flyweight:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Returns an existing Flyweight with a given state or creates a new one.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        key = self.get_key(shared_state)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self._flyweights.get(key):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;FlyweightFactory: Can&#x27;t find a flyweight, creating new one.&quot;</span>)</span><br><span class="line">            self._flyweights[key] = Flyweight(shared_state)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;FlyweightFactory: Reusing existing flyweight.&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> self._flyweights[key]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">list_flyweights</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        count = <span class="built_in">len</span>(self._flyweights)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;FlyweightFactory: I have <span class="subst">&#123;count&#125;</span> flyweights:&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n&quot;</span>.join(<span class="built_in">map</span>(<span class="built_in">str</span>, self._flyweights.keys())), end=<span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_car_to_police_database</span>(<span class="params"></span></span><br><span class="line"><span class="params">    factory: FlyweightFactory, plates: <span class="built_in">str</span>, owner: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">    brand: <span class="built_in">str</span>, model: <span class="built_in">str</span>, color: <span class="built_in">str</span></span></span><br><span class="line"><span class="params"></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n\nClient: Adding a car to database.&quot;</span>)</span><br><span class="line">    flyweight = factory.get_flyweight([brand, model, color])</span><br><span class="line">    <span class="comment"># The client code either stores or calculates extrinsic state and passes it</span></span><br><span class="line">    <span class="comment"># to the flyweight&#x27;s methods.</span></span><br><span class="line">    flyweight.operation([plates, owner])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    The client code usually creates a bunch of pre-populated flyweights in the</span></span><br><span class="line"><span class="string">    initialization stage of the application.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    factory = FlyweightFactory([</span><br><span class="line">        [<span class="string">&quot;Chevrolet&quot;</span>, <span class="string">&quot;Camaro2018&quot;</span>, <span class="string">&quot;pink&quot;</span>],</span><br><span class="line">        [<span class="string">&quot;Mercedes Benz&quot;</span>, <span class="string">&quot;C300&quot;</span>, <span class="string">&quot;black&quot;</span>],</span><br><span class="line">        [<span class="string">&quot;Mercedes Benz&quot;</span>, <span class="string">&quot;C500&quot;</span>, <span class="string">&quot;red&quot;</span>],</span><br><span class="line">        [<span class="string">&quot;BMW&quot;</span>, <span class="string">&quot;M5&quot;</span>, <span class="string">&quot;red&quot;</span>],</span><br><span class="line">        [<span class="string">&quot;BMW&quot;</span>, <span class="string">&quot;X6&quot;</span>, <span class="string">&quot;white&quot;</span>],</span><br><span class="line">    ])</span><br><span class="line"></span><br><span class="line">    factory.list_flyweights()</span><br><span class="line"></span><br><span class="line">    add_car_to_police_database(</span><br><span class="line">        factory, <span class="string">&quot;CL234IR&quot;</span>, <span class="string">&quot;James Doe&quot;</span>, <span class="string">&quot;BMW&quot;</span>, <span class="string">&quot;M5&quot;</span>, <span class="string">&quot;red&quot;</span>)</span><br><span class="line"></span><br><span class="line">    add_car_to_police_database(</span><br><span class="line">        factory, <span class="string">&quot;CL234IR&quot;</span>, <span class="string">&quot;James Doe&quot;</span>, <span class="string">&quot;BMW&quot;</span>, <span class="string">&quot;X1&quot;</span>, <span class="string">&quot;red&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">    factory.list_flyweights()</span><br></pre></td></tr></table></figure>

<p><strong>Output.txt:</strong> 执行结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">FlyweightFactory: I have 5 flyweights:</span><br><span class="line">Camaro2018_Chevrolet_pink</span><br><span class="line">C300_Mercedes Benz_black</span><br><span class="line">C500_Mercedes Benz_red</span><br><span class="line">BMW_M5_red</span><br><span class="line">BMW_X6_white</span><br><span class="line"></span><br><span class="line">Client: Adding a car to database.</span><br><span class="line">FlyweightFactory: Reusing existing flyweight.</span><br><span class="line">Flyweight: Displaying shared ([&quot;BMW&quot;, &quot;M5&quot;, &quot;red&quot;]) and unique ([&quot;CL234IR&quot;, &quot;James Doe&quot;]) state.</span><br><span class="line"></span><br><span class="line">Client: Adding a car to database.</span><br><span class="line">FlyweightFactory: Can&#x27;t find a flyweight, creating new one.</span><br><span class="line">Flyweight: Displaying shared ([&quot;BMW&quot;, &quot;X1&quot;, &quot;red&quot;]) and unique ([&quot;CL234IR&quot;, &quot;James Doe&quot;]) state.</span><br><span class="line"></span><br><span class="line">FlyweightFactory: I have 6 flyweights:</span><br><span class="line">Camaro2018_Chevrolet_pink</span><br><span class="line">C300_Mercedes Benz_black</span><br><span class="line">C500_Mercedes Benz_red</span><br><span class="line">BMW_M5_red</span><br><span class="line">BMW_X6_white</span><br><span class="line">BMW_X1_red</span><br></pre></td></tr></table></figure></div><div class="tab-item-content"><p><strong>在 Ruby 中使用模式</strong></p>
<p><strong>复杂度：</strong> ★★★</p>
<p><strong>流行度：</strong> ☆☆☆</p>
<p><strong>使用示例：</strong> 享元模式只有一个目的： 将内存消耗最小化。 如果你的程序没有遇到内存容量不足的问题， 则可以暂时忽略该模式。</p>
<p><strong>识别方法：</strong> 享元可以通过构建方法来识别， 它会返回缓存对象而不是创建新的对象。</p>
<p><strong>概念示例</strong></p>
<p>本例说明了<strong>享元</strong>设计模式的结构并重点回答了下面的问题：</p>
<ul>
<li>它由哪些类组成？</li>
<li>这些类扮演了哪些角色？</li>
<li>模式中的各个元素会以何种方式相互关联？</li>
</ul>
<p><strong>main.rb:</strong> 概念示例</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">&#x27;json&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The Flyweight stores a common portion of the state (also called intrinsic</span></span><br><span class="line"><span class="comment"># state) that belongs to multiple real business entities. The Flyweight accepts</span></span><br><span class="line"><span class="comment"># the rest of the state (extrinsic state, unique for each entity) via its method</span></span><br><span class="line"><span class="comment"># parameters.</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Flyweight</span></span><br><span class="line">  <span class="comment"># <span class="doctag">@param</span> [String] shared_state</span></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">initialize</span>(<span class="params">shared_state</span>)</span><br><span class="line">    <span class="variable">@shared_state</span> = shared_state</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># <span class="doctag">@param</span> [String] unique_state</span></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">operation</span>(<span class="params">unique_state</span>)</span><br><span class="line">    s = <span class="variable">@shared_state</span>.to_json</span><br><span class="line">    u = unique_state.to_json</span><br><span class="line">    print <span class="string">&quot;Flyweight: Displaying shared (<span class="subst">#&#123;s&#125;</span>) and unique (<span class="subst">#&#123;u&#125;</span>) state.&quot;</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The Flyweight Factory creates and manages the Flyweight objects. It ensures</span></span><br><span class="line"><span class="comment"># that flyweights are shared correctly. When the client requests a flyweight,</span></span><br><span class="line"><span class="comment"># the factory either returns an existing instance or creates a new one, if it</span></span><br><span class="line"><span class="comment"># doesn&#x27;t exist yet.</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FlyweightFactory</span></span><br><span class="line">  <span class="comment"># <span class="doctag">@param</span> [Hash] initial_flyweights</span></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">initialize</span>(<span class="params">initial_flyweights</span>)</span><br><span class="line">    <span class="variable">@flyweights</span> = &#123;&#125;</span><br><span class="line">    initial_flyweights.each <span class="keyword">do</span> |<span class="params">state</span>|</span><br><span class="line">      <span class="variable">@flyweights</span>[get_key(state)] = <span class="title class_">Flyweight</span>.new(state)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Returns a Flyweight&#x27;s string hash for a given state.</span></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">get_key</span>(<span class="params">state</span>)</span><br><span class="line">    state.sort.join(<span class="string">&#x27;_&#x27;</span>)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Returns an existing Flyweight with a given state or creates a new one.</span></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">get_flyweight</span>(<span class="params">shared_state</span>)</span><br><span class="line">    key = get_key(shared_state)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> !<span class="variable">@flyweights</span>.key?(key)</span><br><span class="line">      puts <span class="string">&quot;FlyweightFactory: Can&#x27;t find a flyweight, creating new one.&quot;</span></span><br><span class="line">      <span class="variable">@flyweights</span>[key] = <span class="title class_">Flyweight</span>.new(shared_state)</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      puts <span class="string">&#x27;FlyweightFactory: Reusing existing flyweight.&#x27;</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="variable">@flyweights</span>[key]</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">list_flyweights</span></span><br><span class="line">    puts <span class="string">&quot;FlyweightFactory: I have <span class="subst">#&#123;<span class="variable">@flyweights</span>.size&#125;</span> flyweights:&quot;</span></span><br><span class="line">    print <span class="variable">@flyweights</span>.keys.join(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># <span class="doctag">@param</span> [FlyweightFactory] factory</span></span><br><span class="line"><span class="comment"># <span class="doctag">@param</span> [String] plates</span></span><br><span class="line"><span class="comment"># <span class="doctag">@param</span> [String] owner</span></span><br><span class="line"><span class="comment"># <span class="doctag">@param</span> [String] brand</span></span><br><span class="line"><span class="comment"># <span class="doctag">@param</span> [String] model</span></span><br><span class="line"><span class="comment"># <span class="doctag">@param</span> [String] color</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_car_to_police_database</span>(<span class="params">factory, plates, owner, brand, model, color</span>)</span><br><span class="line">  puts <span class="string">&quot;\n\nClient: Adding a car to database.&quot;</span></span><br><span class="line">  flyweight = factory.get_flyweight([brand, model, color])</span><br><span class="line">  <span class="comment"># The client code either stores or calculates extrinsic state and passes it to</span></span><br><span class="line">  <span class="comment"># the flyweight&#x27;s methods.</span></span><br><span class="line">  flyweight.operation([plates, owner])</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The client code usually creates a bunch of pre-populated flyweights in the</span></span><br><span class="line"><span class="comment"># initialization stage of the application.</span></span><br><span class="line"></span><br><span class="line">factory = <span class="title class_">FlyweightFactory</span>.new([</span><br><span class="line">                                 <span class="string">%w[Chevrolet Camaro2018 pink]</span>,</span><br><span class="line">                                 [<span class="string">&#x27;Mercedes Benz&#x27;</span>, <span class="string">&#x27;C300&#x27;</span>, <span class="string">&#x27;black&#x27;</span>],</span><br><span class="line">                                 [<span class="string">&#x27;Mercedes Benz&#x27;</span>, <span class="string">&#x27;C500&#x27;</span>, <span class="string">&#x27;red&#x27;</span>],</span><br><span class="line">                                 <span class="string">%w[BMW M5 red]</span>,</span><br><span class="line">                                 <span class="string">%w[BMW X6 white]</span></span><br><span class="line">                               ])</span><br><span class="line"></span><br><span class="line">factory.list_flyweights</span><br><span class="line"></span><br><span class="line">add_car_to_police_database(factory, <span class="string">&#x27;CL234IR&#x27;</span>, <span class="string">&#x27;James Doe&#x27;</span>, <span class="string">&#x27;BMW&#x27;</span>, <span class="string">&#x27;M5&#x27;</span>, <span class="string">&#x27;red&#x27;</span>)</span><br><span class="line"></span><br><span class="line">add_car_to_police_database(factory, <span class="string">&#x27;CL234IR&#x27;</span>, <span class="string">&#x27;James Doe&#x27;</span>, <span class="string">&#x27;BMW&#x27;</span>, <span class="string">&#x27;X1&#x27;</span>, <span class="string">&#x27;red&#x27;</span>)</span><br><span class="line"></span><br><span class="line">puts <span class="string">&quot;\n\n&quot;</span></span><br><span class="line"></span><br><span class="line">factory.list_flyweights</span><br></pre></td></tr></table></figure>

<p><strong>output.txt:</strong> 执行结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">FlyweightFactory: I have 5 flyweights:</span><br><span class="line">Camaro2018_Chevrolet_pink</span><br><span class="line">C300_Mercedes Benz_black</span><br><span class="line">C500_Mercedes Benz_red</span><br><span class="line">BMW_M5_red</span><br><span class="line">BMW_X6_white</span><br><span class="line"></span><br><span class="line">Client: Adding a car to database.</span><br><span class="line">FlyweightFactory: Reusing existing flyweight.</span><br><span class="line">Flyweight: Displaying shared ([&quot;BMW&quot;,&quot;M5&quot;,&quot;red&quot;]) and unique ([&quot;CL234IR&quot;,&quot;James Doe&quot;]) state.</span><br><span class="line"></span><br><span class="line">Client: Adding a car to database.</span><br><span class="line">FlyweightFactory: Can&#x27;t find a flyweight, creating new one.</span><br><span class="line">Flyweight: Displaying shared ([&quot;BMW&quot;,&quot;X1&quot;,&quot;red&quot;]) and unique ([&quot;CL234IR&quot;,&quot;James Doe&quot;]) state.</span><br><span class="line"></span><br><span class="line">FlyweightFactory: I have 6 flyweights:</span><br><span class="line">Camaro2018_Chevrolet_pink</span><br><span class="line">C300_Mercedes Benz_black</span><br><span class="line">C500_Mercedes Benz_red</span><br><span class="line">BMW_M5_red</span><br><span class="line">BMW_X6_white</span><br><span class="line">BMW_X1_red</span><br></pre></td></tr></table></figure></div><div class="tab-item-content"><p><strong>在 Swift 中使用模式</strong></p>
<p><strong>复杂度：</strong> ★★★</p>
<p><strong>流行度：</strong> ☆☆☆</p>
<p><strong>使用示例：</strong> 享元模式只有一个目的： 将内存消耗最小化。 如果你的程序没有遇到内存容量不足的问题， 则可以暂时忽略该模式。</p>
<p><strong>识别方法：</strong> 享元可以通过构建方法来识别， 它会返回缓存对象而不是创建新的对象。</p>
<div class="tabs"><div class="nav-tabs"><button type="button" class="tab active">概念示例</button><button type="button" class="tab">真实世界示例</button></div><div class="tab-contents"><div class="tab-item-content active"><p><strong>概念示例</strong></p>
<p>本例说明了<strong>享元</strong>设计模式的结构并重点回答了下面的问题：</p>
<ul>
<li>它由哪些类组成？</li>
<li>这些类扮演了哪些角色？</li>
<li>模式中的各个元素会以何种方式相互关联？</li>
</ul>
<p>了解该模式的结构后， 你可以更轻松地理解下面基于真实世界的 Swift 应用案例。</p>
<p><strong>Example.swift:</strong> 概念示例</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> XCTest</span><br><span class="line"></span><br><span class="line"><span class="comment">/// The Flyweight stores a common portion of the state (also called intrinsic</span></span><br><span class="line"><span class="comment">/// state) that belongs to multiple real business entities. The Flyweight</span></span><br><span class="line"><span class="comment">/// accepts the rest of the state (extrinsic state, unique for each entity) via</span></span><br><span class="line"><span class="comment">/// its method parameters.</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Flyweight</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">let</span> sharedState: [<span class="type">String</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span>(<span class="params">sharedState</span>: [<span class="type">String</span>]) &#123;</span><br><span class="line">        <span class="keyword">self</span>.sharedState <span class="operator">=</span> sharedState</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">operation</span>(<span class="params">uniqueState</span>: [<span class="type">String</span>]) &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Flyweight: Displaying shared (<span class="subst">\(sharedState)</span>) and unique (<span class="subst">\(uniqueState)</span> state.<span class="subst">\n</span>&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// The Flyweight Factory creates and manages the Flyweight objects. It ensures</span></span><br><span class="line"><span class="comment">/// that flyweights are shared correctly. When the client requests a flyweight,</span></span><br><span class="line"><span class="comment">/// the factory either returns an existing instance or creates a new one, if it</span></span><br><span class="line"><span class="comment">/// doesn&#x27;t exist yet.</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FlyweightFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> flyweights: [<span class="type">String</span>: <span class="type">Flyweight</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span>(<span class="params">states</span>: [[<span class="type">String</span>]]) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> flyweights <span class="operator">=</span> [<span class="type">String</span>: <span class="type">Flyweight</span>]()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> state <span class="keyword">in</span> states &#123;</span><br><span class="line">            flyweights[state.key] <span class="operator">=</span> <span class="type">Flyweight</span>(sharedState: state)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">self</span>.flyweights <span class="operator">=</span> flyweights</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Returns an existing Flyweight with a given state or creates a new one.</span></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">flyweight</span>(<span class="params">for</span> <span class="params">state</span>: [<span class="type">String</span>]) -&gt; <span class="type">Flyweight</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> key <span class="operator">=</span> state.key</span><br><span class="line"></span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> foundFlyweight <span class="operator">=</span> flyweights[key] <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;FlyweightFactory: Can&#x27;t find a flyweight, creating new one.<span class="subst">\n</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">let</span> flyweight <span class="operator">=</span> <span class="type">Flyweight</span>(sharedState: state)</span><br><span class="line">            flyweights.updateValue(flyweight, forKey: key)</span><br><span class="line">            <span class="keyword">return</span> flyweight</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;FlyweightFactory: Reusing existing flyweight.<span class="subst">\n</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> foundFlyweight</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">printFlyweights</span>() &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;FlyweightFactory: I have <span class="subst">\(flyweights.count)</span> flyweights:<span class="subst">\n</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> flyweights &#123;</span><br><span class="line">            <span class="built_in">print</span>(item.key)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extension</span> <span class="title class_">Array</span> <span class="title class_">where</span> <span class="title class_">Element</span> == <span class="title class_">String</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Returns a Flyweight&#x27;s string hash for a given state.</span></span><br><span class="line">    <span class="keyword">var</span> key: <span class="type">String</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.joined()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FlyweightConceptual</span>: <span class="title class_">XCTestCase</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">testFlyweight</span>() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/// The client code usually creates a bunch of pre-populated flyweights</span></span><br><span class="line">        <span class="comment">/// in the initialization stage of the application.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> factory <span class="operator">=</span> <span class="type">FlyweightFactory</span>(states:</span><br><span class="line">        [</span><br><span class="line">            [<span class="string">&quot;Chevrolet&quot;</span>, <span class="string">&quot;Camaro2018&quot;</span>, <span class="string">&quot;pink&quot;</span>],</span><br><span class="line">            [<span class="string">&quot;Mercedes Benz&quot;</span>, <span class="string">&quot;C300&quot;</span>, <span class="string">&quot;black&quot;</span>],</span><br><span class="line">            [<span class="string">&quot;Mercedes Benz&quot;</span>, <span class="string">&quot;C500&quot;</span>, <span class="string">&quot;red&quot;</span>],</span><br><span class="line">            [<span class="string">&quot;BMW&quot;</span>, <span class="string">&quot;M5&quot;</span>, <span class="string">&quot;red&quot;</span>],</span><br><span class="line">            [<span class="string">&quot;BMW&quot;</span>, <span class="string">&quot;X6&quot;</span>, <span class="string">&quot;white&quot;</span>]</span><br><span class="line">        ])</span><br><span class="line"></span><br><span class="line">        factory.printFlyweights()</span><br><span class="line"></span><br><span class="line">        <span class="comment">/// ...</span></span><br><span class="line"></span><br><span class="line">        addCarToPoliceDatabase(factory,</span><br><span class="line">                <span class="string">&quot;CL234IR&quot;</span>,</span><br><span class="line">                <span class="string">&quot;James Doe&quot;</span>,</span><br><span class="line">                <span class="string">&quot;BMW&quot;</span>,</span><br><span class="line">                <span class="string">&quot;M5&quot;</span>,</span><br><span class="line">                <span class="string">&quot;red&quot;</span>)</span><br><span class="line"></span><br><span class="line">        addCarToPoliceDatabase(factory,</span><br><span class="line">                <span class="string">&quot;CL234IR&quot;</span>,</span><br><span class="line">                <span class="string">&quot;James Doe&quot;</span>,</span><br><span class="line">                <span class="string">&quot;BMW&quot;</span>,</span><br><span class="line">                <span class="string">&quot;X1&quot;</span>,</span><br><span class="line">                <span class="string">&quot;red&quot;</span>)</span><br><span class="line"></span><br><span class="line">        factory.printFlyweights()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">addCarToPoliceDatabase</span>(</span><br><span class="line">            <span class="keyword">_</span> <span class="params">factory</span>: <span class="type">FlyweightFactory</span>,</span><br><span class="line">            <span class="keyword">_</span> <span class="params">plates</span>: <span class="type">String</span>,</span><br><span class="line">            <span class="keyword">_</span> <span class="params">owner</span>: <span class="type">String</span>,</span><br><span class="line">            <span class="keyword">_</span> <span class="params">brand</span>: <span class="type">String</span>,</span><br><span class="line">            <span class="keyword">_</span> <span class="params">model</span>: <span class="type">String</span>,</span><br><span class="line">            <span class="keyword">_</span> <span class="params">color</span>: <span class="type">String</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Client: Adding a car to database.<span class="subst">\n</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> flyweight <span class="operator">=</span> factory.flyweight(for: [brand, model, color])</span><br><span class="line"></span><br><span class="line">        <span class="comment">/// The client code either stores or calculates extrinsic state and</span></span><br><span class="line">        <span class="comment">/// passes it to the flyweight&#x27;s methods.</span></span><br><span class="line">        flyweight.operation(uniqueState: [plates, owner])</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Output.txt:</strong> 执行结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">FlyweightFactory: I have 5 flyweights:</span><br><span class="line"></span><br><span class="line">Mercedes BenzC500red</span><br><span class="line">ChevroletCamaro2018pink</span><br><span class="line">Mercedes BenzC300black</span><br><span class="line">BMWX6white</span><br><span class="line">BMWM5red</span><br><span class="line">Client: Adding a car to database.</span><br><span class="line"></span><br><span class="line">FlyweightFactory: Reusing existing flyweight.</span><br><span class="line"></span><br><span class="line">Flyweight: Displaying shared ([&quot;BMW&quot;, &quot;M5&quot;, &quot;red&quot;]) and unique ([&quot;CL234IR&quot;, &quot;James Doe&quot;] state.</span><br><span class="line"></span><br><span class="line">Client: Adding a car to database.</span><br><span class="line"></span><br><span class="line">FlyweightFactory: Can&#x27;t find a flyweight, creating new one.</span><br><span class="line"></span><br><span class="line">Flyweight: Displaying shared ([&quot;BMW&quot;, &quot;X1&quot;, &quot;red&quot;]) and unique ([&quot;CL234IR&quot;, &quot;James Doe&quot;] state.</span><br><span class="line"></span><br><span class="line">FlyweightFactory: I have 6 flyweights:</span><br><span class="line"></span><br><span class="line">Mercedes BenzC500red</span><br><span class="line">BMWX1red</span><br><span class="line">ChevroletCamaro2018pink</span><br><span class="line">Mercedes BenzC300black</span><br><span class="line">BMWX6white</span><br><span class="line">BMWM5red</span><br></pre></td></tr></table></figure></div><div class="tab-item-content"><p><strong>真实世界示例</strong></p>
<p><strong>Example.swift:</strong> 真实世界示例</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> XCTest</span><br><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FlyweightRealWorld</span>: <span class="title class_">XCTestCase</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">testFlyweightRealWorld</span>() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> maineCoon <span class="operator">=</span> <span class="type">Animal</span>(name: <span class="string">&quot;Maine Coon&quot;</span>,</span><br><span class="line">                               country: <span class="string">&quot;USA&quot;</span>,</span><br><span class="line">                               type: .cat)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> sphynx <span class="operator">=</span> <span class="type">Animal</span>(name: <span class="string">&quot;Sphynx&quot;</span>,</span><br><span class="line">                            country: <span class="string">&quot;Egypt&quot;</span>,</span><br><span class="line">                            type: .cat)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> bulldog <span class="operator">=</span> <span class="type">Animal</span>(name: <span class="string">&quot;Bulldog&quot;</span>,</span><br><span class="line">                             country: <span class="string">&quot;England&quot;</span>,</span><br><span class="line">                             type: .dog)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Client: I created a number of objects to display&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">/// Displaying objects for the 1-st time.</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Client: Let&#x27;s show animals for the 1st time<span class="subst">\n</span>&quot;</span>)</span><br><span class="line">        display(animals: [maineCoon, sphynx, bulldog])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">/// Displaying objects for the 2-nd time.</span></span><br><span class="line">        <span class="comment">///</span></span><br><span class="line">        <span class="comment">/// Note: Cached object of the appearance will be reused this time.</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;<span class="subst">\n</span>Client: I have a new dog, let&#x27;s show it the same way!<span class="subst">\n</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> germanShepherd <span class="operator">=</span> <span class="type">Animal</span>(name: <span class="string">&quot;German Shepherd&quot;</span>,</span><br><span class="line">                              country: <span class="string">&quot;Germany&quot;</span>,</span><br><span class="line">                              type: .dog)</span><br><span class="line"></span><br><span class="line">        display(animals: [germanShepherd])</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extension</span> <span class="title class_">FlyweightRealWorld</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">display</span>(<span class="params">animals</span>: [<span class="type">Animal</span>]) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> cells <span class="operator">=</span> loadCells(count: animals.count)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> index <span class="keyword">in</span> <span class="number">0</span><span class="operator">..&lt;</span>animals.count &#123;</span><br><span class="line">            cells[index].update(with: animals[index])</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/// Using cells...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">loadCells</span>(<span class="params">count</span>: <span class="type">Int</span>) -&gt; [<span class="type">Cell</span>] &#123;</span><br><span class="line">        <span class="comment">/// Emulates behavior of a table/collection view.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="type">Array</span>(repeating: <span class="type">Cell</span>(), count: count)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">Type</span>: <span class="title class_">String</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> cat</span><br><span class="line">    <span class="keyword">case</span> dog</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Cell</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> animal: <span class="type">Animal</span>?</span><br><span class="line"></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">update</span>(<span class="params">with</span> <span class="params">animal</span>: <span class="type">Animal</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.animal <span class="operator">=</span> animal</span><br><span class="line">        <span class="keyword">let</span> type <span class="operator">=</span> animal.type.rawValue</span><br><span class="line">        <span class="keyword">let</span> photos <span class="operator">=</span> <span class="string">&quot;photos <span class="subst">\(animal.appearance.photos.count)</span>&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Cell: Updating an appearance of a <span class="subst">\(type)</span>-cell: <span class="subst">\(photos)</span><span class="subst">\n</span>&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Animal</span>: <span class="title class_">Equatable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// This is an external context that contains specific values and an object</span></span><br><span class="line">    <span class="comment">/// with a common state.</span></span><br><span class="line">    <span class="comment">///</span></span><br><span class="line">    <span class="comment">/// Note: The object of appearance will be lazily created when it is needed</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> name: <span class="type">String</span></span><br><span class="line">    <span class="keyword">let</span> country: <span class="type">String</span></span><br><span class="line">    <span class="keyword">let</span> type: <span class="type">Type</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> appearance: <span class="type">Appearance</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">AppearanceFactory</span>.appearance(for: type)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Appearance</span>: <span class="title class_">Equatable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// This object contains a predefined appearance of every cell</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> photos: [<span class="type">UIImage</span>]</span><br><span class="line">    <span class="keyword">let</span> backgroundColor: <span class="type">UIColor</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extension</span> <span class="title class_">Animal</span>: <span class="title class_">CustomStringConvertible</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> description: <span class="type">String</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;<span class="subst">\(name)</span>, <span class="subst">\(country)</span>, <span class="subst">\(type.rawValue)</span> + <span class="subst">\(appearance.description)</span>&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extension</span> <span class="title class_">Appearance</span>: <span class="title class_">CustomStringConvertible</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> description: <span class="type">String</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;photos: <span class="subst">\(photos.count)</span>, <span class="subst">\(backgroundColor)</span>&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AppearanceFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">var</span> cache <span class="operator">=</span> [<span class="type">Type</span>: <span class="type">Appearance</span>]()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">func</span> <span class="title function_">appearance</span>(<span class="params">for</span> <span class="params">key</span>: <span class="type">Type</span>) -&gt; <span class="type">Appearance</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">guard</span> cache[key] <span class="operator">==</span> <span class="literal">nil</span> <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;AppearanceFactory: Reusing an existing <span class="subst">\(key.rawValue)</span>-appearance.&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> cache[key]<span class="operator">!</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;AppearanceFactory: Can&#x27;t find a cached <span class="subst">\(key.rawValue)</span>-object, creating a new one.&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> key &#123;</span><br><span class="line">        <span class="keyword">case</span> .cat:</span><br><span class="line">            cache[key] <span class="operator">=</span> catInfo</span><br><span class="line">        <span class="keyword">case</span> .dog:</span><br><span class="line">            cache[key] <span class="operator">=</span> dogInfo</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> cache[key]<span class="operator">!</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extension</span> <span class="title class_">AppearanceFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">var</span> catInfo: <span class="type">Appearance</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">Appearance</span>(photos: [<span class="type">UIImage</span>()], backgroundColor: .red)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">var</span> dogInfo: <span class="type">Appearance</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">Appearance</span>(photos: [<span class="type">UIImage</span>(), <span class="type">UIImage</span>()], backgroundColor: .blue)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Output.txt:</strong> 执行结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Client: I created a number of objects to display</span><br><span class="line">Client: Let&#x27;s show animals for the 1st time</span><br><span class="line"></span><br><span class="line">AppearanceFactory: Can&#x27;t find a cached cat-object, creating a new one.</span><br><span class="line">Cell: Updating an appearance of a cat-cell: photos 1</span><br><span class="line"></span><br><span class="line">AppearanceFactory: Reusing an existing cat-appearance.</span><br><span class="line">Cell: Updating an appearance of a cat-cell: photos 1</span><br><span class="line"></span><br><span class="line">AppearanceFactory: Can&#x27;t find a cached dog-object, creating a new one.</span><br><span class="line">Cell: Updating an appearance of a dog-cell: photos 2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Client: I have a new dog, let&#x27;s show it the same way!</span><br><span class="line"></span><br><span class="line">AppearanceFactory: Reusing an existing dog-appearance.</span><br><span class="line">Cell: Updating an appearance of a dog-cell: photos 2</span><br></pre></td></tr></table></figure></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><div class="tab-item-content"><p><strong>在 TypeScript 中使用模式</strong></p>
<p><strong>复杂度：</strong> ★★★</p>
<p><strong>流行度：</strong> ☆☆☆</p>
<p><strong>使用示例：</strong> 享元模式只有一个目的： 将内存消耗最小化。 如果你的程序没有遇到内存容量不足的问题， 则可以暂时忽略该模式。</p>
<p><strong>识别方法：</strong> 享元可以通过构建方法来识别， 它会返回缓存对象而不是创建新的对象。</p>
<p><strong>概念示例</strong></p>
<p>本例说明了<strong>享元</strong>设计模式的结构并重点回答了下面的问题：</p>
<ul>
<li>它由哪些类组成？</li>
<li>这些类扮演了哪些角色？</li>
<li>模式中的各个元素会以何种方式相互关联？</li>
</ul>
<p><strong>index.ts:</strong> 概念示例</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The Flyweight stores a common portion of the state (also called intrinsic</span></span><br><span class="line"><span class="comment"> * state) that belongs to multiple real business entities. The Flyweight accepts</span></span><br><span class="line"><span class="comment"> * the rest of the state (extrinsic state, unique for each entity) via its</span></span><br><span class="line"><span class="comment"> * method parameters.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Flyweight</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="attr">sharedState</span>: <span class="built_in">any</span>;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">sharedState: <span class="built_in">any</span></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">sharedState</span> = sharedState;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">operation</span>(uniqueState): <span class="built_in">void</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> s = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="variable language_">this</span>.<span class="property">sharedState</span>);</span><br><span class="line">        <span class="keyword">const</span> u = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(uniqueState);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Flyweight: Displaying shared (<span class="subst">$&#123;s&#125;</span>) and unique (<span class="subst">$&#123;u&#125;</span>) state.`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The Flyweight Factory creates and manages the Flyweight objects. It ensures</span></span><br><span class="line"><span class="comment"> * that flyweights are shared correctly. When the client requests a flyweight,</span></span><br><span class="line"><span class="comment"> * the factory either returns an existing instance or creates a new one, if it</span></span><br><span class="line"><span class="comment"> * doesn&#x27;t exist yet.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FlyweightFactory</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="attr">flyweights</span>: &#123;[<span class="attr">key</span>: <span class="built_in">string</span>]: <span class="title class_">Flyweight</span>&#125; = &lt;<span class="built_in">any</span>&gt;&#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">initialFlyweights: <span class="built_in">string</span>[][]</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> state <span class="keyword">of</span> initialFlyweights) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">flyweights</span>[<span class="variable language_">this</span>.<span class="title function_">getKey</span>(state)] = <span class="keyword">new</span> <span class="title class_">Flyweight</span>(state);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns a Flyweight&#x27;s string hash for a given state.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">getKey</span>(<span class="attr">state</span>: <span class="built_in">string</span>[]): <span class="built_in">string</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> state.<span class="title function_">join</span>(<span class="string">&#x27;_&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns an existing Flyweight with a given state or creates a new one.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">getFlyweight</span>(<span class="attr">sharedState</span>: <span class="built_in">string</span>[]): <span class="title class_">Flyweight</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> key = <span class="variable language_">this</span>.<span class="title function_">getKey</span>(sharedState);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!(key <span class="keyword">in</span> <span class="variable language_">this</span>.<span class="property">flyweights</span>)) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;FlyweightFactory: Can\&#x27;t find a flyweight, creating new one.&#x27;</span>);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">flyweights</span>[key] = <span class="keyword">new</span> <span class="title class_">Flyweight</span>(sharedState);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;FlyweightFactory: Reusing existing flyweight.&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">flyweights</span>[key];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">listFlyweights</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> count = <span class="title class_">Object</span>.<span class="title function_">keys</span>(<span class="variable language_">this</span>.<span class="property">flyweights</span>).<span class="property">length</span>;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`\nFlyweightFactory: I have <span class="subst">$&#123;count&#125;</span> flyweights:`</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> <span class="variable language_">this</span>.<span class="property">flyweights</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(key);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The client code usually creates a bunch of pre-populated flyweights in the</span></span><br><span class="line"><span class="comment"> * initialization stage of the application.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> factory = <span class="keyword">new</span> <span class="title class_">FlyweightFactory</span>([</span><br><span class="line">    [<span class="string">&#x27;Chevrolet&#x27;</span>, <span class="string">&#x27;Camaro2018&#x27;</span>, <span class="string">&#x27;pink&#x27;</span>],</span><br><span class="line">    [<span class="string">&#x27;Mercedes Benz&#x27;</span>, <span class="string">&#x27;C300&#x27;</span>, <span class="string">&#x27;black&#x27;</span>],</span><br><span class="line">    [<span class="string">&#x27;Mercedes Benz&#x27;</span>, <span class="string">&#x27;C500&#x27;</span>, <span class="string">&#x27;red&#x27;</span>],</span><br><span class="line">    [<span class="string">&#x27;BMW&#x27;</span>, <span class="string">&#x27;M5&#x27;</span>, <span class="string">&#x27;red&#x27;</span>],</span><br><span class="line">    [<span class="string">&#x27;BMW&#x27;</span>, <span class="string">&#x27;X6&#x27;</span>, <span class="string">&#x27;white&#x27;</span>],</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">]);</span><br><span class="line">factory.<span class="title function_">listFlyweights</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">addCarToPoliceDatabase</span>(<span class="params"></span></span><br><span class="line"><span class="params">    ff: FlyweightFactory, plates: <span class="built_in">string</span>, owner: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">    brand: <span class="built_in">string</span>, model: <span class="built_in">string</span>, color: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;\nClient: Adding a car to database.&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> flyweight = ff.<span class="title function_">getFlyweight</span>([brand, model, color]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The client code either stores or calculates extrinsic state and passes it</span></span><br><span class="line">    <span class="comment">// to the flyweight&#x27;s methods.</span></span><br><span class="line">    flyweight.<span class="title function_">operation</span>([plates, owner]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">addCarToPoliceDatabase</span>(factory, <span class="string">&#x27;CL234IR&#x27;</span>, <span class="string">&#x27;James Doe&#x27;</span>, <span class="string">&#x27;BMW&#x27;</span>, <span class="string">&#x27;M5&#x27;</span>, <span class="string">&#x27;red&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_">addCarToPoliceDatabase</span>(factory, <span class="string">&#x27;CL234IR&#x27;</span>, <span class="string">&#x27;James Doe&#x27;</span>, <span class="string">&#x27;BMW&#x27;</span>, <span class="string">&#x27;X1&#x27;</span>, <span class="string">&#x27;red&#x27;</span>);</span><br><span class="line"></span><br><span class="line">factory.<span class="title function_">listFlyweights</span>();</span><br></pre></td></tr></table></figure>

<p><strong>Output.txt:</strong> 执行结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">FlyweightFactory: I have 5 flyweights:</span><br><span class="line">Chevrolet_Camaro2018_pink</span><br><span class="line">Mercedes Benz_C300_black</span><br><span class="line">Mercedes Benz_C500_red</span><br><span class="line">BMW_M5_red</span><br><span class="line">BMW_X6_white</span><br><span class="line"></span><br><span class="line">Client: Adding a car to database.</span><br><span class="line">FlyweightFactory: Reusing existing flyweight.</span><br><span class="line">Flyweight: Displaying shared ([&quot;BMW&quot;,&quot;M5&quot;,&quot;red&quot;]) and unique ([&quot;CL234IR&quot;,&quot;James Doe&quot;]) state.</span><br><span class="line"></span><br><span class="line">Client: Adding a car to database.</span><br><span class="line">FlyweightFactory: Can&#x27;t find a flyweight, creating new one.</span><br><span class="line">Flyweight: Displaying shared ([&quot;BMW&quot;,&quot;X1&quot;,&quot;red&quot;]) and unique ([&quot;CL234IR&quot;,&quot;James Doe&quot;]) state.</span><br><span class="line"></span><br><span class="line">FlyweightFactory: I have 6 flyweights:</span><br><span class="line">Chevrolet_Camaro2018_pink</span><br><span class="line">Mercedes Benz_C300_black</span><br><span class="line">Mercedes Benz_C500_red</span><br><span class="line">BMW_M5_red</span><br><span class="line">BMW_X6_white</span><br><span class="line">BMW_X1_red</span><br></pre></td></tr></table></figure></div><div class="tab-item-content"><p><strong>概念示例</strong></p>
<p>在游戏 《反恐精英》 中， 恐怖分子和反恐精英身着不同类型的衣物。 为了简便起见， 我们就假设双方都各有一种服装类型。 服装对象嵌入在玩家对象之中， 如下所示。</p>
<p>下面是玩家的结构体。 我们可以看到， 服装对象是嵌入在玩家结构体之中的：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> player <span class="keyword">struct</span> &#123;</span><br><span class="line">dress      dress</span><br><span class="line">playerType <span class="type">string</span> <span class="comment">// 可为 T 或 CT</span></span><br><span class="line">lat        <span class="type">int</span></span><br><span class="line">long       <span class="type">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>假设目前有 5 名恐怖分子和 5 名反恐精英， 一共是 10 名玩家。 那么关于服装， 我们就有两个选项了。</p>
<ol>
<li>10 个玩家对象各自创建不同的服装对象， 并将其嵌入。 总共会创建 10 个服装对象。</li>
<li>我们创建两个服装对象：</li>
</ol>
<ul>
<li>单一恐怖分子服装对象： 其将在 5 名恐怖分子之间共享。</li>
<li>单一反恐精英服装对象： 其将在 5 名反恐精英之间共享。</li>
</ul>
<p>你可以看到， 方法 1 中我们总共创建了 10 个服装对象； 方法 2 中则只有 2 个服装对象。 第二种方法， 就是我们所遵循的享元设计模式。 我们所创建的 2 个服装对象被称为是享元对象。</p>
<p>享元模式会从对象中提取出公共部分并创建享元对象。 这些享元对象 （服装） 随后可在多个对象 （玩家） 中分享。 这极大地减少了服装对象的数量， 更棒的是即便你创建了更多玩家， 也只需这么两个服装对象就足够了。</p>
<p>在享元模式中， 我们会将享元对象存储在 map 容器中。 每当创建共享享元对象的其他对象时， 都会从 map 容器中获取享元对象。</p>
<p>下面让我们来看看此类安排的内部状态和外部状态：</p>
<ul>
<li><em>内部状态</em>： 内部状态的服装可在多个恐怖分子和反恐精英对象间共享。</li>
<li><em>外部状态</em>： 玩家位置和玩家所使用的武器就是外部状态， 因为其在每个对象中都是不同的。</li>
</ul>
<p><strong>dressFactory.go:</strong> 享元工厂</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    <span class="comment">//TerroristDressType terrorist dress type</span></span><br><span class="line">    TerroristDressType = <span class="string">&quot;tDress&quot;</span></span><br><span class="line">    <span class="comment">//CounterTerrroristDressType terrorist dress type</span></span><br><span class="line">    CounterTerrroristDressType = <span class="string">&quot;ctDress&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">    dressFactorySingleInstance = &amp;dressFactory&#123;</span><br><span class="line">        dressMap: <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]dress),</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> dressFactory <span class="keyword">struct</span> &#123;</span><br><span class="line">    dressMap <span class="keyword">map</span>[<span class="type">string</span>]dress</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *dressFactory)</span></span> getDressByType(dressType <span class="type">string</span>) (dress, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> d.dressMap[dressType] != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> d.dressMap[dressType], <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> dressType == TerroristDressType &#123;</span><br><span class="line">        d.dressMap[dressType] = newTerroristDress()</span><br><span class="line">        <span class="keyword">return</span> d.dressMap[dressType], <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> dressType == CounterTerrroristDressType &#123;</span><br><span class="line">        d.dressMap[dressType] = newCounterTerroristDress()</span><br><span class="line">        <span class="keyword">return</span> d.dressMap[dressType], <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;Wrong dress type passed&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getDressFactorySingleInstance</span><span class="params">()</span></span> *dressFactory &#123;</span><br><span class="line">    <span class="keyword">return</span> dressFactorySingleInstance</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>dress.go:</strong> 享元接口</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> dress <span class="keyword">interface</span> &#123;</span><br><span class="line">    getColor() <span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>terroristDress.go:</strong> 具体享元对象</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> terroristDress <span class="keyword">struct</span> &#123;</span><br><span class="line">    color <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *terroristDress)</span></span> getColor() <span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> t.color</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newTerroristDress</span><span class="params">()</span></span> *terroristDress &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;terroristDress&#123;color: <span class="string">&quot;red&quot;</span>&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>counterTerroristDress.go:</strong> 具体享元对象</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> counterTerroristDress <span class="keyword">struct</span> &#123;</span><br><span class="line">    color <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *counterTerroristDress)</span></span> getColor() <span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> c.color</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newCounterTerroristDress</span><span class="params">()</span></span> *counterTerroristDress &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;counterTerroristDress&#123;color: <span class="string">&quot;green&quot;</span>&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>player.go:</strong> 背景</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> player <span class="keyword">struct</span> &#123;</span><br><span class="line">    dress      dress</span><br><span class="line">    playerType <span class="type">string</span></span><br><span class="line">    lat        <span class="type">int</span></span><br><span class="line">    long       <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newPlayer</span><span class="params">(playerType, dressType <span class="type">string</span>)</span></span> *player &#123;</span><br><span class="line">    dress, _ := getDressFactorySingleInstance().getDressByType(dressType)</span><br><span class="line">    <span class="keyword">return</span> &amp;player&#123;</span><br><span class="line">        playerType: playerType,</span><br><span class="line">        dress:      dress,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *player)</span></span> newLocation(lat, long <span class="type">int</span>) &#123;</span><br><span class="line">    p.lat = lat</span><br><span class="line">    p.long = long</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>game.go:</strong> 客户端代码</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> game <span class="keyword">struct</span> &#123;</span><br><span class="line">    terrorists        []*player</span><br><span class="line">    counterTerrorists []*player</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newGame</span><span class="params">()</span></span> *game &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;game&#123;</span><br><span class="line">        terrorists:        <span class="built_in">make</span>([]*player, <span class="number">1</span>),</span><br><span class="line">        counterTerrorists: <span class="built_in">make</span>([]*player, <span class="number">1</span>),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *game)</span></span> addTerrorist(dressType <span class="type">string</span>) &#123;</span><br><span class="line">    player := newPlayer(<span class="string">&quot;T&quot;</span>, dressType)</span><br><span class="line">    c.terrorists = <span class="built_in">append</span>(c.terrorists, player)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *game)</span></span> addCounterTerrorist(dressType <span class="type">string</span>) &#123;</span><br><span class="line">    player := newPlayer(<span class="string">&quot;CT&quot;</span>, dressType)</span><br><span class="line">    c.counterTerrorists = <span class="built_in">append</span>(c.counterTerrorists, player)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>main.go:</strong> 客户端代码</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    game := newGame()</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Add Terrorist</span></span><br><span class="line">    game.addTerrorist(TerroristDressType)</span><br><span class="line">    game.addTerrorist(TerroristDressType)</span><br><span class="line">    game.addTerrorist(TerroristDressType)</span><br><span class="line">    game.addTerrorist(TerroristDressType)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Add CounterTerrorist</span></span><br><span class="line">    game.addCounterTerrorist(CounterTerrroristDressType)</span><br><span class="line">    game.addCounterTerrorist(CounterTerrroristDressType)</span><br><span class="line">    game.addCounterTerrorist(CounterTerrroristDressType)</span><br><span class="line"></span><br><span class="line">    dressFactoryInstance := getDressFactorySingleInstance()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> dressType, dress := <span class="keyword">range</span> dressFactoryInstance.dressMap &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;DressColorType: %s\nDressColor: %s\n&quot;</span>, dressType, dress.getColor())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>output.txt:</strong> 执行结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">DressColorType: ctDress</span><br><span class="line">DressColor: green</span><br><span class="line">DressColorType: tDress</span><br><span class="line">DressColor: red</span><br></pre></td></tr></table></figure>

<p><em>根据： <a target="_blank" rel="noopener" href="https://golangbyexample.com/flyweight-design-pattern-golang/">Golang By Example</a></em></p></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://wangyyovo.github.io">Blank</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://wangyyovo.github.io/posts/d935b798/">https://wangyyovo.github.io/posts/d935b798/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://wangyyovo.github.io" target="_blank">Blank</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/pattern/">pattern</a></div><div class="post-share"><div class="social-share" data-image="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/cover/common/fbe970a24a54e3fd90e6fbe3115b02ef.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://jsd.012700.xyz/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://jsd.012700.xyz/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/43f910c2/" title="结构型模式-代理模式"><img class="cover" src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/cover/common/7ccfb7029a930e7fdc84e4af56395a68.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">结构型模式-代理模式</div></div><div class="info-2"><div class="info-item-1">  https://refactoringguru.cn/design-patterns/proxy  结构型模式-代理模式亦称： Proxy 意图代理模式是一种结构型设计模式， 让你能够提供对象的替代品或其占位符。 代理控制着对于原对象的访问， 并允许在将请求提交给对象前后进行一些处理。  问题为什么要控制对于某个对象的访问呢？ 举个例子： 有这样一个消耗大量系统资源的巨型对象， 你只是偶尔需要使用它， 并非总是需要。  你可以实现延迟初始化： 在实际有需要时再创建该对象。 对象的所有客户端都要执行延迟初始代码。 不幸的是， 这很可能会带来很多重复代码。 在理想情况下， 我们希望将代码直接放入对象的类中， 但这并非总是能实现： 比如类可能是第三方封闭库的一部分。 解决方案代理模式建议新建一个与原服务对象接口相同的代理类， 然后更新应用以将代理对象传递给所有原始对象客户端。 代理类接收到客户端请求后会创建实际的服务对象， 并将所有工作委派给它。  这有什么好处呢？ 如果需要在类的主要业务逻辑前后执行一些工作， 你无需修改类就能完成这项工作。 由于代理实现的接口与原类相同， 因此你...</div></div></div></a><a class="pagination-related" href="/posts/cf76947a/" title="结构型模式-外观模式"><img class="cover" src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/cover/common/5cc9fbce0a0cc54dbce4828138b658b7.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">结构型模式-外观模式</div></div><div class="info-2"><div class="info-item-1">  https://refactoringguru.cn/design-patterns/facade  结构型模式-外观模式亦称： 门面模式、Facade 意图外观模式是一种结构型设计模式， 能为程序库、 框架或其他复杂类提供一个简单的接口。  问题假设你必须在代码中使用某个复杂的库或框架中的众多对象。 正常情况下， 你需要负责所有对象的初始化工作、 管理其依赖关系并按正确的顺序执行方法等。 最终， 程序中类的业务逻辑将与第三方类的实现细节紧密耦合， 使得理解和维护代码的工作很难进行。 解决方案外观类为包含许多活动部件的复杂子系统提供一个简单的接口。 与直接调用子系统相比， 外观提供的功能可能比较有限， 但它却包含了客户端真正关心的功能。 如果你的程序需要与包含几十种功能的复杂库整合， 但只需使用其中非常少的功能， 那么使用外观模式会非常方便， 例如， 上传猫咪搞笑短视频到社交媒体网站的应用可能会用到专业的视频转换库， 但它只需使用一个包含 encode­(filename, format)方法 （以文件名与文件格式为参数进行编码的方法） 的类即可。 在创建这个类并将其连接到视...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/posts/37f0d8f/" title="创建型模式-单例模式"><img class="cover" src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/cover/common/6cc78f9be0372c0d330f2c7d326f7d9e.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2021-05-03</div><div class="info-item-2">创建型模式-单例模式</div></div><div class="info-2"><div class="info-item-1">  https://refactoringguru.cn/design-patterns/singleton  创建型模式-单例模式亦称： 单件模式、Singleton 意图单例模式是一种创建型设计模式， 让你能够保证一个类只有一个实例， 并提供一个访问该实例的全局节点。  问题单例模式同时解决了两个问题， 所以违反了_单一职责原则_：  保证一个类只有一个实例。 为什么会有人想要控制一个类所拥有的实例数量？ 最常见的原因是控制某些共享资源 （例如数据库或文件） 的访问权限。 它的运作方式是这样的： 如果你创建了一个对象， 同时过一会儿后你决定再创建一个新对象， 此时你会获得之前已创建的对象， 而不是一个新对象。 注意， 普通构造函数无法实现上述行为， 因为构造函数的设计决定了它必须总是返回一个新对象。   为该实例提供一个全局访问节点。 还记得你 （好吧， 其实是我自己） 用过的那些存储重要对象的全局变量吗？ 它们在使用上十分方便， 但同时也非常不安全， 因为任何代码都有可能覆盖掉那些变量的内容， 从而引发程序崩溃。 和全局变量一样， 单例模式也允许在程序的任何地方访问特定对象...</div></div></div></a><a class="pagination-related" href="/posts/63b28d52/" title="创建型模式-原型模式"><img class="cover" src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/cover/common/01b549d5aec9f475e74b2781486eed2d.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2021-05-03</div><div class="info-item-2">创建型模式-原型模式</div></div><div class="info-2"><div class="info-item-1">  https://refactoringguru.cn/design-patterns/prototype  创建型模式-原型模式亦称： 克隆、Clone、Prototype 意图原型模式是一种创建型设计模式， 使你能够复制已有对象， 而又无需使代码依赖它们所属的类。  问题如果你有一个对象， 并希望生成与其完全相同的一个复制品， 你该如何实现呢？ 首先， 你必须新建一个属于相同类的对象。 然后， 你必须遍历原始对象的所有成员变量， 并将成员变量值复制到新对象中。 不错！ 但有个小问题。 并非所有对象都能通过这种方式进行复制， 因为有些对象可能拥有私有成员变量， 它们在对象本身以外是不可见的。  直接复制还有另外一个问题。 因为你必须知道对象所属的类才能创建复制品， 所以代码必须依赖该类。 即使你可以接受额外的依赖性， 那还有另外一个问题： 有时你只知道对象所实现的接口， 而不知道其所属的具体类， 比如可向方法的某个参数传入实现了某个接口的任何对象。 解决方案原型模式将克隆过程委派给被克隆的实际对象。 模式为所有支持克隆的对象声明了一个通用接口， 该接口让你能够克隆对象， 同时...</div></div></div></a><a class="pagination-related" href="/posts/a951f0f7/" title="创建型模式-抽象工厂模式"><img class="cover" src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/cover/common/40d08d3b2ae8dc4074a9f3a7942a0b5a.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2021-05-03</div><div class="info-item-2">创建型模式-抽象工厂模式</div></div><div class="info-2"><div class="info-item-1">  https://refactoringguru.cn/design-patterns/abstract-factory  创建型模式-抽象工厂模式亦称： Abstract Factory 意图抽象工厂模式是一种创建型设计模式， 它能创建一系列相关的对象， 而无需指定其具体类。  问题假设你正在开发一款家具商店模拟器。 你的代码中包括一些类， 用于表示：  一系列相关产品， 例如 椅子Chair 、  沙发Sofa和 咖啡桌Coffee­Table 。 系列产品的不同变体。 例如， 你可以使用 现代Modern 、  维多利亚Victorian 、  装饰风艺术Art­Deco等风格生成 椅子 、  沙发和 咖啡桌 。   你需要设法单独生成每件家具对象， 这样才能确保其风格一致。 如果顾客收到的家具风格不一样， 他们可不会开心。  此外， 你也不希望在添加新产品或新风格时修改已有代码。 家具供应商对于产品目录的更新非常频繁， 你不会想在每次更新时都去修改核心代码的。 解决方案首先， 抽象工厂模式建议为系列中的每件产品明确声明接口 （例如椅子、 沙发或咖啡桌）。 然后， 确保所...</div></div></div></a><a class="pagination-related" href="/posts/63b2a10f/" title="工厂模式比较"><img class="cover" src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/cover/common/dd999ecec29f3590f23c26fbb79bb612.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2021-05-04</div><div class="info-item-2">工厂模式比较</div></div><div class="info-2"><div class="info-item-1">  https://refactoringguru.cn/design-patterns/factory-comparison  工厂模式比较本文将对下列概念之间的差异进行说明：  工厂 构建方法 静态构建 （或工厂） 方法 简单工厂 工厂方法 抽象工厂  你可以在网上找到这些术语的参考信息。 尽管它们看上去相似， 但其含义都不一样。 许多人没有意识到这一点， 从而出现了混淆和误解。 因此让我们搞清楚其中的不同之处， 一劳永逸地解决这个问题。 1. 工厂工厂是一个含义模糊的术语， 表示可以创建一些东西的函数、 方法或类。 最常见的情况下， 工厂创建的是对象。 但是它们也可以创建文件和数据库记录等其他东西。 例如， 下面这些东西都可以非正式地被称为 “工厂”：  创建程序 GUI 的函数或方法； 创建用户的类； 以特定方式调用类构造函数的静态方法。 一种创建型设计模式。  当某人说到 “工厂” 这个词时， 其具体含义通常可以根据上下文来确定。 但如果你有疑问， 可以直接提问。 毕竟作者本人有时候也没有搞清楚。 2. 构建方法构建方法在 《重构与模式》 中被定义为 “创建对象的方法”...</div></div></div></a><a class="pagination-related" href="/posts/7a751a0c/" title="创建型模式-工厂方法模式"><img class="cover" src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/cover/common/2cc53835314eae7d55be8b341557ddb0.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2021-05-03</div><div class="info-item-2">创建型模式-工厂方法模式</div></div><div class="info-2"><div class="info-item-1">  https://refactoringguru.cn/design-patterns/factory-method  创建型模式-工厂方法模式**亦称：**虚拟构造函数、Virtual Constructor、Factory Method 意图工厂方法模式是一种创建型设计模式， 其在父类中提供一个创建对象的方法， 允许子类决定实例化对象的类型。  问题假设你正在开发一款物流管理应用。 最初版本只能处理卡车运输， 因此大部分代码都在位于名为 卡车的类中。 一段时间后， 这款应用变得极受欢迎。 你每天都能收到十几次来自海运公司的请求， 希望应用能够支持海上物流功能。  这可是个好消息。 但是代码问题该如何处理呢？ 目前， 大部分代码都与 卡车类相关。 在程序中添加 轮船类需要修改全部代码。 更糟糕的是， 如果你以后需要在程序中支持另外一种运输方式， 很可能需要再次对这些代码进行大幅修改。 最后， 你将不得不编写繁复的代码， 根据不同的运输对象类， 在应用中进行不同的处理。 解决方案工厂方法模式建议使用特殊的工厂方法代替对于对象构造函数的直接调用 （即使用 new运算符）。 不用担...</div></div></div></a><a class="pagination-related" href="/posts/e59e3a52/" title="创建型模式-生成器模式"><img class="cover" src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/cover/common/43a23affdea04c9c39e82f19a8ff21d8.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2021-05-03</div><div class="info-item-2">创建型模式-生成器模式</div></div><div class="info-2"><div class="info-item-1">  https://refactoringguru.cn/design-patterns/builder  创建型模式-生成器模式亦称： 建造者模式、Builder 意图生成器模式是一种创建型设计模式， 使你能够分步骤创建复杂对象。 该模式允许你使用相同的创建代码生成不同类型和形式的对象。  问题假设有这样一个复杂对象， 在对其进行构造时需要对诸多成员变量和嵌套对象进行繁复的初始化工作。 这些初始化代码通常深藏于一个包含众多参数且让人基本看不懂的构造函数中； 甚至还有更糟糕的情况， 那就是这些代码散落在客户端代码的多个位置。  例如， 我们来思考如何创建一个 房屋House对象。 建造一栋简单的房屋， 首先你需要建造四面墙和地板， 安装房门和一套窗户， 然后再建造一个屋顶。 但是如果你想要一栋更宽敞更明亮的房屋， 还要有院子和其他设施 （例如暖气、 排水和供电设备）， 那又该怎么办呢？ 最简单的方法是扩展 房屋基类， 然后创建一系列涵盖所有参数组合的子类。 但最终你将面对相当数量的子类。 任何新增的参数 （例如门廊类型） 都会让这个层次结构更加复杂。 另一种方法则无需生成子类。 ...</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/theme/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Blank</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">352</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">46</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">58</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>主题 GitHub</span></a><div class="card-info-social-icons"><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fas fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BB%93%E6%9E%84%E5%9E%8B%E6%A8%A1%E5%BC%8F-%E4%BA%AB%E5%85%83%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.</span> <span class="toc-text">结构型模式-享元模式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%84%8F%E5%9B%BE"><span class="toc-number">1.1.</span> <span class="toc-text">意图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98"><span class="toc-number">1.2.</span> <span class="toc-text">问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">1.3.</span> <span class="toc-text">解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%96%E5%9C%A8%E7%8A%B6%E6%80%81%E5%AD%98%E5%82%A8"><span class="toc-number">1.3.0.1.</span> <span class="toc-text">外在状态存储</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%AB%E5%85%83%E4%B8%8E%E4%B8%8D%E5%8F%AF%E5%8F%98%E6%80%A7"><span class="toc-number">1.3.0.2.</span> <span class="toc-text">享元与不可变性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%AB%E5%85%83%E5%B7%A5%E5%8E%82"><span class="toc-number">1.3.0.3.</span> <span class="toc-text">享元工厂</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%AB%E5%85%83%E6%A8%A1%E5%BC%8F%E7%BB%93%E6%9E%84"><span class="toc-number">1.4.</span> <span class="toc-text">享元模式结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BC%AA%E4%BB%A3%E7%A0%81"><span class="toc-number">1.5.</span> <span class="toc-text">伪代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%AB%E5%85%83%E6%A8%A1%E5%BC%8F%E9%80%82%E5%90%88%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">1.6.</span> <span class="toc-text">享元模式适合应用场景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F"><span class="toc-number">1.7.</span> <span class="toc-text">实现方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%AB%E5%85%83%E6%A8%A1%E5%BC%8F%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="toc-number">1.8.</span> <span class="toc-text">享元模式优缺点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%8E%E5%85%B6%E4%BB%96%E6%A8%A1%E5%BC%8F%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="toc-number">1.9.</span> <span class="toc-text">与其他模式的关系</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.10.</span> <span class="toc-text">代码示例</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/d14168d/" title="虚拟机问题合集"><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/cover/hexo/090cfe4e9e60b0ad0de05db822f3ae97.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="虚拟机问题合集"/></a><div class="content"><a class="title" href="/posts/d14168d/" title="虚拟机问题合集">虚拟机问题合集</a><time datetime="2022-07-16T13:30:36.000Z" title="发表于 2022-07-16 21:30:36">2022-07-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/f540045f/" title="用go语言编写移动端sdk和app开发"><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/cover/golang/941ed1ec2925719a0c92e76f4f786b6a.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="用go语言编写移动端sdk和app开发"/></a><div class="content"><a class="title" href="/posts/f540045f/" title="用go语言编写移动端sdk和app开发">用go语言编写移动端sdk和app开发</a><time datetime="2022-07-04T12:14:21.000Z" title="发表于 2022-07-04 20:14:21">2022-07-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/5faac006/" title="在线编程IDE"><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/cover/hexo/090cfe4e9e60b0ad0de05db822f3ae97.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="在线编程IDE"/></a><div class="content"><a class="title" href="/posts/5faac006/" title="在线编程IDE">在线编程IDE</a><time datetime="2022-06-12T13:30:36.000Z" title="发表于 2022-06-12 21:30:36">2022-06-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/7594185d/" title="即时性能分析工具Pyroscope"><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/cover/golang/3bfb3279740bc9a5b5ef436fa887ef07.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="即时性能分析工具Pyroscope"/></a><div class="content"><a class="title" href="/posts/7594185d/" title="即时性能分析工具Pyroscope">即时性能分析工具Pyroscope</a><time datetime="2022-06-12T08:07:36.000Z" title="发表于 2022-06-12 16:07:36">2022-06-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/82a7aa7c/" title="golang性能调试优化方法"><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/cover/common/3.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="golang性能调试优化方法"/></a><div class="content"><a class="title" href="/posts/82a7aa7c/" title="golang性能调试优化方法">golang性能调试优化方法</a><time datetime="2022-06-12T03:00:36.000Z" title="发表于 2022-06-12 11:00:36">2022-06-12</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 By Blank</span><span class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 5.4.2</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.4.3</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://jsd.012700.xyz/npm/hexo-theme-butterfly/source/js/utils.min.js"></script><script src="https://jsd.012700.xyz/npm/hexo-theme-butterfly/source/js/main.min.js"></script><script src="https://jsd.012700.xyz/npm/hexo-theme-butterfly/source/js/tw_cn.min.js"></script><div class="js-pjax"><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = {"placeholder":"请留下你的脚印","pageSize":10,"lang":"zh-CN","requiredFields":["nick","mail","link"]}

  const initValine = (el, path) => {
    if (isShuoshuo) {
      window.shuoshuoComment.destroyValine = () => {
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }

    const valineConfig = {
      el: '#vcomment',
      appId: 'BSfgwCPLOvPHVPaSoBCGSENf-MdYXbMMI',
      appKey: '2Q8qq5060qxycL6FPL26LnMG',
      avatar: 'monsterid',
      serverURLs: 'https://bsfgwcpl.api.lncldglobal.com',
      emojiMaps: "",
      visitor: false,
      ...option,
      path: isShuoshuo ? path : (option && option.path) || window.location.pathname
    }

    new Valine(valineConfig)
  }

  const loadValine = async (el, path) => {
    if (typeof Valine === 'function') {
      initValine(el, path)
    } else {
      await btf.getScript('https://jsd.012700.xyz/npm/valine/dist/Valine.min.js')
      initValine(el, path)
    }
  }

  if (isShuoshuo) {
    'Valine' === 'Valine'
      ? window.shuoshuoComment = { loadComment: loadValine }
      : window.loadOtherComment = loadValine
    return
  }

  if ('Valine' === 'Valine' || !false) {
    if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="https://jsd.012700.xyz/npm/hexo-theme-butterfly/source/js/search/local-search.min.js"></script></div></div></body></html>