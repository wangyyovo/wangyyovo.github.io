<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Nginx Ingress注解Annotations | Blank</title><meta name="author" content="Blank"><meta name="copyright" content="Blank"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Nginx Ingress注解Annotations https:&#x2F;&#x2F;kubernetes.github.io&#x2F;ingress-nginx&#x2F;user-guide&#x2F;nginx-configuration&#x2F;annotations&#x2F;  Nginx Ingress 注解使用在 Ingress 资源实例中，用以设置当前 Ingress 资源实例中 Nginx 虚拟主机的相关配置，对应配置的是 Nginx">
<meta property="og:type" content="article">
<meta property="og:title" content="Nginx Ingress注解Annotations">
<meta property="og:url" content="https://wangyyovo.github.io/posts/5b4d812a/">
<meta property="og:site_name" content="Blank">
<meta property="og:description" content="Nginx Ingress注解Annotations https:&#x2F;&#x2F;kubernetes.github.io&#x2F;ingress-nginx&#x2F;user-guide&#x2F;nginx-configuration&#x2F;annotations&#x2F;  Nginx Ingress 注解使用在 Ingress 资源实例中，用以设置当前 Ingress 资源实例中 Nginx 虚拟主机的相关配置，对应配置的是 Nginx">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/common/7ad9570c1892b128f84b9971f7946fc4.jpg">
<meta property="article:published_time" content="2021-06-10T13:59:44.000Z">
<meta property="article:modified_time" content="2021-06-10T13:59:44.000Z">
<meta property="article:author" content="Blank">
<meta property="article:tag" content="k8s">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/common/7ad9570c1892b128f84b9971f7946fc4.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Nginx Ingress注解Annotations",
  "url": "https://wangyyovo.github.io/posts/5b4d812a/",
  "image": "https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/common/7ad9570c1892b128f84b9971f7946fc4.jpg",
  "datePublished": "2021-06-10T13:59:44.000Z",
  "dateModified": "2021-06-10T13:59:44.000Z",
  "author": [
    {
      "@type": "Person",
      "name": "Blank",
      "url": "https://wangyyovo.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/theme/favicon.ico"><link rel="canonical" href="https://wangyyovo.github.io/posts/5b4d812a/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Nginx Ingress注解Annotations',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="alternate" href="/atom.xml" title="Blank" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/theme/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">356</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">36</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">54</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fas fa-coffee"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 娱乐</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-image"></i><span> 相册</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-book"></i><span> 教程</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/posts/21cfbf15/"><span> 🚀 快速開始</span></a></li><li><a class="site-page child" href="/posts/dc584b87/"><span> 📑 主題頁面</span></a></li><li><a class="site-page child" href="/posts/4aa8abbe/"><span> 🛠 主題配置-1</span></a></li><li><a class="site-page child" href="/posts/ceeb73f/"><span> ⚔️ 主題配置-2</span></a></li><li><a class="site-page child" href="/posts/98d20436/"><span> ❓ 主題問答</span></a></li><li><a class="site-page child" href="/posts/4073eda/"><span> ⚡️ 進階教程</span></a></li><li><a class="site-page child" href="/posts/198a4240/"><span> ✨ 更新日誌</span></a></li><li><a class="site-page child" href="/posts/507c070f/"><span> 📑 Aplayer教程</span></a></li><li><a class="site-page child" href="/posts/2df239ce/"><span> 📑 標籤外掛</span></a></li><li><a class="site-page child" href="/posts/b37b5fe3/"><span> 📑 自定義代碼配色</span></a></li><li><a class="site-page child" href="/posts/ea33ab97/"><span> 📑 自定義側邊欄</span></a></li><li><a class="site-page child" href="/posts/89757140/"><span> 📑 Markdown</span></a></li><li><a class="site-page child" href="/posts/9db656e5/"><span> 📑 代码高亮测试</span></a></li><li><a class="site-page child" href="/posts/c9711c19/"><span> 📑 當設置top_img為false時</span></a></li><li><a class="site-page child" href="/posts/39b121ef/"><span> 📑 Hexo內置標籤外掛</span></a></li><li><a class="site-page child" href="/posts/7670b080/"><span> 📑 Butterfly 美化/優化/魔改 教程合集</span></a></li><li><a class="site-page child" href="/posts/913b2502/"><span> 📑 没有封面</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/common/7ad9570c1892b128f84b9971f7946fc4.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Blank</span></a><a class="nav-page-title" href="/"><span class="site-name">Nginx Ingress注解Annotations</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fas fa-coffee"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 娱乐</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-image"></i><span> 相册</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-book"></i><span> 教程</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/posts/21cfbf15/"><span> 🚀 快速開始</span></a></li><li><a class="site-page child" href="/posts/dc584b87/"><span> 📑 主題頁面</span></a></li><li><a class="site-page child" href="/posts/4aa8abbe/"><span> 🛠 主題配置-1</span></a></li><li><a class="site-page child" href="/posts/ceeb73f/"><span> ⚔️ 主題配置-2</span></a></li><li><a class="site-page child" href="/posts/98d20436/"><span> ❓ 主題問答</span></a></li><li><a class="site-page child" href="/posts/4073eda/"><span> ⚡️ 進階教程</span></a></li><li><a class="site-page child" href="/posts/198a4240/"><span> ✨ 更新日誌</span></a></li><li><a class="site-page child" href="/posts/507c070f/"><span> 📑 Aplayer教程</span></a></li><li><a class="site-page child" href="/posts/2df239ce/"><span> 📑 標籤外掛</span></a></li><li><a class="site-page child" href="/posts/b37b5fe3/"><span> 📑 自定義代碼配色</span></a></li><li><a class="site-page child" href="/posts/ea33ab97/"><span> 📑 自定義側邊欄</span></a></li><li><a class="site-page child" href="/posts/89757140/"><span> 📑 Markdown</span></a></li><li><a class="site-page child" href="/posts/9db656e5/"><span> 📑 代码高亮测试</span></a></li><li><a class="site-page child" href="/posts/c9711c19/"><span> 📑 當設置top_img為false時</span></a></li><li><a class="site-page child" href="/posts/39b121ef/"><span> 📑 Hexo內置標籤外掛</span></a></li><li><a class="site-page child" href="/posts/7670b080/"><span> 📑 Butterfly 美化/優化/魔改 教程合集</span></a></li><li><a class="site-page child" href="/posts/913b2502/"><span> 📑 没有封面</span></a></li></ul></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Nginx Ingress注解Annotations</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-06-10T13:59:44.000Z" title="发表于 2021-06-10 21:59:44">2021-06-10</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-06-10T13:59:44.000Z" title="更新于 2021-06-10 21:59:44">2021-06-10</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/microservice/">microservice</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/microservice/k8s/">k8s</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">14k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>53分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><script src="\assets\js\APlayer.min.js"> </script><h1 id="Nginx-Ingress注解Annotations"><a href="#Nginx-Ingress注解Annotations" class="headerlink" title="Nginx Ingress注解Annotations"></a>Nginx Ingress注解Annotations</h1><blockquote>
<p><a target="_blank" rel="noopener" href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/">https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/</a></p>
</blockquote>
<p>Nginx Ingress 注解使用在 Ingress 资源实例中，用以设置当前 Ingress 资源实例中 Nginx 虚拟主机的相关配置，对应配置的是 Nginx 当前虚拟主机的 server 指令域内容。在与 Nginx Ingress 配置映射具有相同功能配置时，将按照所在指令域层级遵循 Nginx 配置规则覆盖。</p>
<p>Nginx Ingress注解按照配置功能有如下分类。</p>
<h2 id="1、Nginx原生配置指令"><a href="#1、Nginx原生配置指令" class="headerlink" title="1、Nginx原生配置指令"></a>1、Nginx原生配置指令</h2><p>支持在注解中添加 Nginx 原生配置指令。配置说明如下表所示。</p>
<table>
<thead>
<tr>
<th>注解</th>
<th>类型</th>
<th>功能描述</th>
</tr>
</thead>
<tbody><tr>
<td>nginx.ingress.kubernetes.io&#x2F;server-snippet</td>
<td>string</td>
<td>在 server 指令域添加 Nginx 配置指令</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;configuration-snippet</td>
<td>string</td>
<td>在 location 指令域添加 Nginx 配置指令</td>
</tr>
</tbody></table>
<p>配置样例如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">web-nginxbar-org</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/server-snippet:</span> <span class="string">|</span></span><br><span class="line"><span class="string">            location / &#123;</span></span><br><span class="line"><span class="string">                return 302 /coffee;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string"></span><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">web.nginxbar.org</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">            <span class="attr">paths:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/tea</span></span><br><span class="line">              <span class="attr">backend:</span></span><br><span class="line">                  <span class="attr">serviceName:</span> <span class="string">tea-svc</span></span><br><span class="line">                  <span class="attr">servicePort:</span> <span class="number">80</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/coffee</span></span><br><span class="line">            <span class="attr">backend:</span></span><br><span class="line">                <span class="attr">serviceName:</span> <span class="string">coffee-svc</span></span><br><span class="line">                <span class="attr">servicePort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<h2 id="2、通用配置"><a href="#2、通用配置" class="headerlink" title="2、通用配置"></a>2、通用配置</h2><p>Nginx 虚拟主机中的通用配置。通用配置说明如下表所示。</p>
<table>
<thead>
<tr>
<th>注解</th>
<th>类型</th>
<th>功能描述</th>
</tr>
</thead>
<tbody><tr>
<td>nginx.ingress.kubernetes.io&#x2F;enable-access-log</td>
<td>true 或 false</td>
<td>对当前虚拟主机设置是否启用访问日志，默认为真</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;server-alias</td>
<td>string</td>
<td>为 Nginx 添加更多的主机名，同 Nginx 配置指令 server name</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;app-root</td>
<td>string</td>
<td>将当前虚拟主机根目录的访问 302 跳转到当前指定的路径</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;client-body-buffer-size</td>
<td>string</td>
<td>同 Nginx 配置指令 client_body_buffer_size</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;use-regex</td>
<td>true 或 false</td>
<td>是否对当前虚拟主机的 Nginx 指令 location 使用正则方式进行路径匹配，默认值为 false</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;custom-http-errors</td>
<td>[]int</td>
<td>根据响应码状态定义为错误状态并跳转到设置的默认后端</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;default-backend</td>
<td>string</td>
<td>自定义默认后端的资源对象 Service 名称，当客户端的请求没有匹配的 Nginx 规则或响应错误时，将被转发到默认后端</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;whitelist-source-range</td>
<td>CIDR</td>
<td>功能同 ConfigMap 配置键 whitelist-source-range</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;permanent-redirect</td>
<td>string</td>
<td>设置永久重定向的目标地址</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;permanent-redirect-code</td>
<td>number</td>
<td>自定义永久重定向的响应码，默认为 301</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;temporal-redirect</td>
<td>string</td>
<td>设置临时重定向的目标地址</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;from-to-www-redirect</td>
<td>true 或 false</td>
<td>设置是否将当前虚拟主机子域名为 www 的请求跳转到当前主机域名</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;rewrite-target</td>
<td>URI</td>
<td>同 Nginx 配置指令 rewrite</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;enable-rewrite-log</td>
<td>true 或 false</td>
<td>同 Nginx 配置指令 rewrite log，默认为 false</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;mirror-uri</td>
<td>string</td>
<td>同 Nginx 配置指令 mirro</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;mirror-request-body</td>
<td>true 或 false</td>
<td>同 Nginx 配置指令 mirror_request_body，默认为 true</td>
</tr>
</tbody></table>
<p>配置样例如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">web-nginxbar-org</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/rewrite-target:</span> <span class="string">/tea/$1</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/enable-rewrite-log:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">web.nginxbar.org</span>   <span class="comment"># 此service的访问域名</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">            <span class="attr">serviceName:</span> <span class="string">nginx-web</span></span><br><span class="line">            <span class="attr">servicePort:</span> <span class="number">8080</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/coffee/(.+)</span></span><br></pre></td></tr></table></figure>

<h2 id="3、访问控制"><a href="#3、访问控制" class="headerlink" title="3、访问控制"></a>3、访问控制</h2><p>用以设置基于流量、请求连接数、请求频率的访问控制。访问控制配置说明如下表所示。</p>
<table>
<thead>
<tr>
<th>注解</th>
<th>类型&#x2F;选项</th>
<th>功能描述</th>
</tr>
</thead>
<tbody><tr>
<td>nginx.ingress.kubernetes.io&#x2F;limit-rate</td>
<td>number</td>
<td>访问流量速度限制，同 Nginx 配置指令 limit_rate</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;limit-rate-after</td>
<td>number</td>
<td>启用访问流量速度限制的最大值，同 Nginx 配置指令 limit_rate_after</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;limit-connections</td>
<td>number</td>
<td>节并发连接数限制，同 Nginx 配置指令 limit_conn</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;limit-rps</td>
<td>number</td>
<td>每秒请求频率限制，burst 参数为给定值的 5 倍，响应状态码由 ConfigMap 的 limit-req-status-code 设定</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;limit-rpm</td>
<td>number</td>
<td>每分钟请求频率限制，burst 参数为给定值的 5 倍，响应状态码由 ConfigMap 的 limit-req-status-code 设定</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;limit-whitelist</td>
<td>CIDR</td>
<td>对以上限制设置基于 IP 的白名单</td>
</tr>
</tbody></table>
<h2 id="4、认证管理"><a href="#4、认证管理" class="headerlink" title="4、认证管理"></a>4、认证管理</h2><p>Nginx Ingress 提供了基本认证、摘要认证和外部认证 3 种方式，为被代理服务器提供认证支持。认证管理配置说明如下表所示。</p>
<table>
<thead>
<tr>
<th>注解</th>
<th>类型</th>
<th>功能描述</th>
</tr>
</thead>
<tbody><tr>
<td>nginx.ingress.kubernetes.io&#x2F;enable-global-auth</td>
<td>true 或 false</td>
<td>如果 ConfigMap 的 global-auth-url 被设置，Nginx 会将所有的请求重定向到提供身份验证的 URL，默认为 true</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;satisfy</td>
<td>string</td>
<td>同 Nginx 配置指令 satisfy</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;auth-type</td>
<td>basic 或 digest</td>
<td>设置 HTTP 认证类型，支持基本和摘要两种类型</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;auth-secret</td>
<td>string</td>
<td>指定关联资源对象 secret 的名称</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;auth-realm</td>
<td>string</td>
<td>设置基本认证的提示信息 auth_basic</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;auth-url</td>
<td>string</td>
<td>设置提供外部身份认证的 URL，由 Nginx 配置指令 auth_request 提供该功能</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;auth-signin</td>
<td>string</td>
<td>设置当外部认证返回 401 时跳转的 URL，通常为提示输入用户名和密码的 URL</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;auth-method</td>
<td>string</td>
<td>指定访问外部认证 URL 的 HTTP 方法，由 Nginx 配置指令 proxy_method 提供该功能</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;auth-request-redirect</td>
<td>string</td>
<td>设置发送给认证服务器请求头中 X-Auth-Request-Redirect 的值</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;auth-cache-key</td>
<td>string</td>
<td>启用认证缓存，并设置认证缓存的关键字</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;auth-cache-duration</td>
<td>string</td>
<td>基于响应码设置认证缓存的有效时间</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;auth-response-headers</td>
<td>string</td>
<td>设置认证请求完成后传递到真实后端的头信息</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;auth-snippet</td>
<td>string</td>
<td>可以自定义在外部认证指令区域添加 Nginx 配置指令</td>
</tr>
</tbody></table>
<p>基本认证配置如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建基本认证用户名nginxbar、密码123456，输出文件名必须是auth</span></span><br><span class="line"><span class="string">htpasswd</span> <span class="string">-bc</span> <span class="string">auth</span> <span class="string">nginxbar</span> <span class="number">123456</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建资源对象secret保存账号和密码</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">create</span> <span class="string">secret</span> <span class="string">generic</span> <span class="string">basic-auth</span> <span class="string">--from-file=auth</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看创建的basic-auth</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">secret</span> <span class="string">basic-auth</span> <span class="string">-o</span> <span class="string">yaml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建基本认证的Ingress实例</span></span><br><span class="line"><span class="string">cat&gt;auth-nginxbar-org.yaml&lt;&lt;EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">auth-nginxbar-org</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">        <span class="comment"># 设置认证类型</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/auth-type:</span> <span class="string">basic</span></span><br><span class="line">        <span class="comment"># 关联账号和密码</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/auth-secret:</span> <span class="string">basic-auth</span></span><br><span class="line">        <span class="comment"># 显示认证提示信息</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/auth-realm:</span> <span class="string">&#x27;Authentication Required for web.nginxbar.org&#x27;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">auth.nginxbar.org</span>   <span class="comment"># 此service的访问域名</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">          <span class="attr">paths:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">              <span class="attr">serviceName:</span> <span class="string">nginx-web</span></span><br><span class="line">              <span class="attr">servicePort:</span> <span class="number">8080</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="string">kubectl</span> <span class="string">create</span> <span class="string">-f</span> <span class="string">auth-nginxbar-org.yaml</span></span><br></pre></td></tr></table></figure>

<p>认证转发配置样例如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">auth-nginxbar-org</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/auth-url:</span> <span class="string">&quot;http://$host/auth2&quot;</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/auth-signin:</span> <span class="string">&quot;http://$host/auth/start&quot;</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/auth-method:</span> <span class="string">&quot;POST&quot;</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/auth-cache-key:</span> <span class="string">&quot;foo&quot;</span><span class="string">,</span></span><br><span class="line">        <span class="string">nginx.ingress.kubernetes.io/auth-cache-duration&quot;:</span> <span class="string">&quot;200 202 401 30m&quot;</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/auth-snippet:</span> <span class="string">|</span></span><br><span class="line"><span class="string">            proxy_set_header Foo-Header 42;</span></span><br><span class="line"><span class="string"></span><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">auth.nginxbar.org</span>   <span class="comment"># 此service的访问域名</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">            <span class="attr">serviceName:</span> <span class="string">nginx-web</span></span><br><span class="line">            <span class="attr">servicePort:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure>

<h2 id="5、跨域访问"><a href="#5、跨域访问" class="headerlink" title="5、跨域访问"></a>5、跨域访问</h2><p>跨域访问功能配置说明如下表所示。</p>
<table>
<thead>
<tr>
<th>注解</th>
<th>类型</th>
<th>功能描述</th>
</tr>
</thead>
<tbody><tr>
<td>nginx.ingress.kubernetes.io&#x2F;enable-cors</td>
<td>true 或 false</td>
<td>是否启用跨域访问支持，默认为 false</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;cors-allow-origin</td>
<td>string</td>
<td>允许跨域访问的域名，默认为 *，表示接受任意域名的访问</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;cors-allow-methods</td>
<td>string</td>
<td>允许跨域访问方法，默认为 GET、PUT、POST、DELETE、PATCH、OPTIONS</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;cors-allow-headers</td>
<td>string</td>
<td>允许跨域访问的请求头，默认为 DNT，X-CustomHeader、Keep-Alive、User-Agent、X-Requested-With、If-Modified-Since、Cache-Control、Content-Type、Authorization</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;cors-allow-credentials</td>
<td>true 或 false</td>
<td>设置在响应头中 Access-Control-Allow-Credentials 的值，设置是否允许客户端携带验证信息，如 cookie 等，默认为 true</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;cors-max-age</td>
<td>number</td>
<td>设置响应头中 Access-Control-Max-Age 的值，设置返回结果可以用于缓存的最长时间，默认为 1728000 秒</td>
</tr>
</tbody></table>
<p>配置样例如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">web-nginxbar-org</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/cors-allow-headers:</span> <span class="string">&gt;-</span></span><br><span class="line"><span class="string">            DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,</span></span><br><span class="line"><span class="string">            If-Modified-Since,Cache-Control,Content-Type,Authorization</span></span><br><span class="line"><span class="string"></span>        <span class="attr">nginx.ingress.kubernetes.io/cors-allow-methods:</span> <span class="string">&#x27;PUT, GET, POST, OPTIONS&#x27;</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/cors-allow-origin:</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/enable-cors:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/cors-max-age:</span> <span class="number">600</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">web.nginxbar.org</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">            <span class="attr">serviceName:</span> <span class="string">nginx-web</span></span><br><span class="line">            <span class="attr">servicePort:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/</span></span><br></pre></td></tr></table></figure>

<h2 id="6、代理配置"><a href="#6、代理配置" class="headerlink" title="6、代理配置"></a>6、代理配置</h2><p>Nginx 代理相关功能配置说明如下表所示。</p>
<table>
<thead>
<tr>
<th>注解</th>
<th>类型&#x2F;选项</th>
<th>功能描述</th>
</tr>
</thead>
<tbody><tr>
<td>nginx.ingress.kubernetes.io&#x2F;service-upstream</td>
<td>true 或 false</td>
<td>默认 Nginx 以 Service 中 Pod 的 IP 和端口为 Upstream 中的成员列表，该参数为 true 时，将以 Service 的 ClusterIP 和端口为被代理入口，该功能避免了因 Pod 漂移带来的 Upstream 的配置变化</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;backend-protocol</td>
<td>НТТР 或 HTTPS 或 GRPC 或 GRPCS 或 AJP 或 FCGI</td>
<td>设置代理后端服务器的代理协议类型，默认为 HTTP</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;proxy-body-size</td>
<td>string</td>
<td>同 Nginx 配置指令 client_max_body-size，默认为 1m</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;proxy-cookie-do-main</td>
<td>string</td>
<td>同 Nginx 配置指令 proxy_cookie_domain</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;proxy-cookie-path</td>
<td>string</td>
<td>同 Nginx 配置指令 proxy_cookie_path</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;proxy-connect-timeout</td>
<td>number</td>
<td>同 Nginx 配置指令 proxy_connect_timeout</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;proxy-send-time-out</td>
<td>number</td>
<td>同 Nginx 配置指令 proxy_send_timeout</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;proxy-read-time-out</td>
<td>number</td>
<td>同 Nginx 配置指令 proxy_read_timeout</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;proxy-next-up-stream</td>
<td>string</td>
<td>同 Nginx 配置指令 proxy_next_upstream</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;proxy-next-up-stream-timeout</td>
<td>number</td>
<td>同 Nginx 配置指令 proxy_next_upstream_timeout</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;proxy-next-up-stream-tries</td>
<td>number</td>
<td>同 Nginx 配置指令 proxy_next_upstream_tries</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;proxy-buffering</td>
<td>string</td>
<td>同 Nginx 配置指令 proxy_buffering</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;proxy-buffers-number</td>
<td>number</td>
<td>同 Nginx 配置指令 proxy_buffers</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;proxy-buffer-size</td>
<td>string</td>
<td>同 Nginx 配置指令 proxy_buffer_size</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;proxy-request-buffering</td>
<td>string</td>
<td>同 Nginx 配置指令 proxy_request_buffering</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;proxy-http-ver-sion</td>
<td>1.0 或 1.1</td>
<td>同 Nginx 配置指令 proxy_http_version，默认为 1.1</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;upstream-vhost</td>
<td>string</td>
<td>自定义发送到上游服务器的信息头字段中 Host 的内容，相当于 Nginx 配置指令 proxy_set_header Host $host 的设置</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;proxy-redirect-from</td>
<td>string</td>
<td>设置要替换的源文本，同 Nginx 配置指令 proxy_redirect</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;proxy-redirect-to</td>
<td>string</td>
<td>设置要替换的目标文本，同 Nginx 配置指 proxy redirect</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;connection-proxy-header</td>
<td>string</td>
<td>设置发送到被代理服务器请求头中字段属性 connection 的值，相当于 Nginx 配置指令 proxy_set_header Connection 的状态为 Keep-Alive</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;x-forwarded-prefix</td>
<td>string</td>
<td>创建并设置代理请求头属性字段 X-Forwarded-Prefix 属性，用以向后端传递请求路径</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;http2-push-pre-load</td>
<td>true 或 false</td>
<td>同 Nginx 配置指令 http2-push-preload，默认值为 false</td>
</tr>
</tbody></table>
<h2 id="7、负载均衡"><a href="#7、负载均衡" class="headerlink" title="7、负载均衡"></a>7、负载均衡</h2><p>为方便上游服务器组的动态管理，Nginx Ingress 基于 Lua 实现了一致性哈希、基于子集的一致性哈希、轮询调度及峰值指数加权移动平均（Peak Exponentially Weighted Moving-Average，Peak EWMA）负载均衡算法。负载均衡配置说明如下表所示。</p>
<table>
<thead>
<tr>
<th>注解</th>
<th>类型&#x2F;选项</th>
<th>功能描述</th>
</tr>
</thead>
<tbody><tr>
<td>nginx.ingress.kubernetes.io&#x2F;upstream-hash-by</td>
<td>string</td>
<td>同 Nginx 配置指令 hash，此处默认为一致性哈希负载算法，允许除了客户端 IP 或 cookie 之外的会话粘连</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;upstream-hash-by-subset</td>
<td>true 或 false</td>
<td>设置是否使用子集模式的一致性哈希负载算法，默认为 false</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;upstream-hash-by-subset-size</td>
<td>int</td>
<td>设置子集模式中上游服务器分组的大小，默认为 3</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;load-balance</td>
<td>round_robin 或 ewma</td>
<td>设置负载均衡算法，基于 balancer_by_lua 模块实现，支持轮询和 Peak EWMA 两种负载算法</td>
</tr>
</tbody></table>
<p>子集模式的一致性哈希负载算法是将上游服务器组中的被代理服务器分成固定数量的分组，然后把每个分组当作一致性哈希计算的虚拟节点。默认一致性哈希是按照每个被代理服务器为虚拟节点进行计算的。</p>
<p>Peak EWMA 负载均衡算法，是对每个 Pod 请求的往返延时（Round-Trip Time，RTT）计算移动平均值，并用该 Pod 的未完成请求数对这个平均值加权计算，计算值最小的 Pod 端点将被分配新的请求。</p>
<h2 id="8、会话保持配置"><a href="#8、会话保持配置" class="headerlink" title="8、会话保持配置"></a>8、会话保持配置</h2><p>设置基于 cookie 的会话亲缘关系，也就是会话保持功能。启用基于 cookie 的会话保持功能时，可以使同一客户端的请求始终转发给同一后端服务器。Nginx Ingress 对启用会话保持功能的 Service 集群使用一致性哈希负载算法，即使后端 Pod 数量变化，也不会对会话保持功能产生太大的影响。会话保持配置说明如下表所示。</p>
<table>
<thead>
<tr>
<th>注解</th>
<th>类型</th>
<th>功能描述</th>
</tr>
</thead>
<tbody><tr>
<td>nginx.ingress.kubernetes.io&#x2F;affinity</td>
<td>cookie</td>
<td>设置会话保持类型，目前只有 cookie 类型</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;session-cookie-name</td>
<td>string</td>
<td>设置 cookie 名称，默认为 INGRESSCOOKIE</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;session-cookie-path</td>
<td>string</td>
<td>设置 cookie 字段 path 的值，默认值为当前资源实例 path 的设置。如果启用 use-regex 功能，使用正则匹配时，必须单独指定，不能使用默认值</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;session-cookie-max-age</td>
<td>--</td>
<td>设置 cookie 字段 max-age 的值，表示 cookie 过期时间</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;session-cookie-expires</td>
<td>--</td>
<td>为兼容旧的浏览器，设置 cookie 字段 expires 的值，表示 cookie 过期时间</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;session-cookie-change-on-failure</td>
<td>true 或 false</td>
<td>当会话保持的被代理服务器请求失败时，如果设置值为 true，则将下次请求更改为向另一台被代理服务器转发，否则继续向当前被代理服务器转发请求</td>
</tr>
</tbody></table>
<p>配置样例如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">web-nginxbar-org</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/affinity:</span> <span class="string">&quot;cookie&quot;</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/session-cookie-name:</span> <span class="string">&quot;route&quot;</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/session-cookie-expires:</span> <span class="string">&quot;172800&quot;</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/session-cookie-max-age:</span> <span class="string">&quot;172800&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">web.nginxbar.org</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">            <span class="attr">serviceName:</span> <span class="string">nginx-web</span></span><br><span class="line">            <span class="attr">servicePort:</span> <span class="number">8080</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/</span></span><br></pre></td></tr></table></figure>

<h2 id="9、HTTPS配置"><a href="#9、HTTPS配置" class="headerlink" title="9、HTTPS配置"></a>9、HTTPS配置</h2><p>HTTPS 功能的配置说明如下表所示。</p>
<table>
<thead>
<tr>
<th>注解</th>
<th>类型</th>
<th>功能描述</th>
</tr>
</thead>
<tbody><tr>
<td>nginx.ingress.kubernetes.io&#x2F;force-ssl-redirect</td>
<td>true 或 false</td>
<td>当客户端的 HTTPS 被外部集群进行 SSL 卸载（SSL offloading）时，仍将 HTTP 的请求强制跳转到 HTTPS 端口</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;ssl-redirect</td>
<td>true 或 false</td>
<td>设置当前虚拟主机支持 HTTPS 请求时，是否将 HTTP 的请求强制跳转到 HTTPS 端口，全局默认为 true</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;ssl-passthrough</td>
<td>true 或 false</td>
<td>设置是否启用 SSL 透传</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;auth-tls-secret</td>
<td>string</td>
<td>设置客户端证书的资源对象名称</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;ssl-ciphers</td>
<td>string</td>
<td>设置 TLS 用于协商使用的加密算法组合，同 Nginx 配置指令 ssl_ciphers</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;auth-tls-verify-client</td>
<td>string</td>
<td>是否启用客户端证书验证，同 Nginx 配置指令 ssl_verify_client</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;auth-tls-verify-depth</td>
<td>number</td>
<td>客户端证书链的验证深度同 Nginx 配置指令 ssl_verify_depth</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;auth-tls-error-page</td>
<td>string</td>
<td>设置客户端证书验证错误时的跳转页面</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;auth-tls-pass-certificate-to-upstream</td>
<td>true 或 false</td>
<td>指定证书是否传递到上游服务器</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;secure-verify-ca-secret</td>
<td>string</td>
<td>设置是否启用对被代理服务器的 SSL 证书验证功能</td>
</tr>
<tr>
<td>HTTPS 配置样例如下：</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建TLS证书</span></span><br><span class="line"><span class="string">openssl</span> <span class="string">req</span> <span class="string">-x509</span> <span class="string">-nodes</span> <span class="string">-days</span> <span class="number">365</span> <span class="string">-newkey</span> <span class="string">rsa:2048</span> <span class="string">-keyout</span> <span class="string">/data/apps/certs/dashboard.key</span> <span class="string">-out</span> <span class="string">/data/apps/certs/dashboard.crt</span> <span class="string">-subj</span> <span class="string">&quot;/CN=dashboard.nginxbar.org/O=dashboard.nginxbar.org&quot;</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">-n</span> <span class="string">kube-system</span>  <span class="string">create</span> <span class="string">secret</span> <span class="string">tls</span> <span class="string">ingress-secret</span> <span class="string">--key</span> <span class="string">/data/apps/certs/dashboard.key</span> <span class="string">--cert</span> <span class="string">/data/apps/certs/dashboard.crt</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建HTTPS服务</span></span><br><span class="line"><span class="string">cat&gt;dashboard-ingress.yaml&lt;&lt;EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">dashboard-ingress</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/ingress.class:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="comment"># 使用HTTPS协议代理后端服务器</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/backend-protocol:</span> <span class="string">&quot;HTTPS&quot;</span></span><br><span class="line">        <span class="comment"># 启用SSL透传</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/ssl-passthrough:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">tls:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">dashboard.nginxbar.org</span></span><br><span class="line">        <span class="attr">secretName:</span> <span class="string">ingress-secret</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">dashboard.nginxbar.org</span></span><br><span class="line">          <span class="attr">http:</span></span><br><span class="line">            <span class="attr">paths:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">              <span class="attr">backend:</span></span><br><span class="line">                <span class="attr">serviceName:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">                <span class="attr">servicePort:</span> <span class="number">443</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="string">kubectl</span> <span class="string">create</span> <span class="string">-f</span> <span class="string">dashboard-ingress.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="string">curl</span> <span class="string">-k</span> <span class="string">-H</span> <span class="string">&quot;Host:dashboard.nginxbar.org&quot;</span> <span class="string">https://10.103.196.209</span></span><br></pre></td></tr></table></figure>

<p>Nginx-ingress 在用户没有提供证书的情况下会提供一个内置的默认 TLS 证书，如果 secretName 参数没有配置或配置错误，Nginx 会使用系统默认的证书，所以配置后仍需检查确认。</p>
<p>HTTPS 客户端证书身份认证配置样例如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建客户端证书资源对象default/ca-secret</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">        <span class="comment"># 启用客户端证书验证</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/auth-tls-verify-client:</span> <span class="string">&quot;on&quot;</span></span><br><span class="line">        <span class="comment"># 绑定客户端证书的资源对象名称，是命名空间default的ca-secret</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/auth-tls-secret:</span> <span class="string">&quot;default/ca-secret&quot;</span></span><br><span class="line">        <span class="comment"># 客户端证书链的验证深度为1</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/auth-tls-verify-depth:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">        <span class="comment"># 设置客户端证书验证错误时的跳转页面</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/auth-tls-error-page:</span> <span class="string">&quot;http://www.mysite.com/error-cert.html&quot;</span></span><br><span class="line">        <span class="comment"># 指定证书传递到上游服务器</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/auth-tls-pass-certificate-to-upstream:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx-test</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">mydomain.com</span></span><br><span class="line">        <span class="attr">http:</span></span><br><span class="line">            <span class="attr">paths:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">                <span class="attr">serviceName:</span> <span class="string">http-svc</span></span><br><span class="line">                <span class="attr">servicePort:</span> <span class="number">80</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">    <span class="attr">tls:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">mydomain.com</span></span><br><span class="line">        <span class="attr">secretName:</span> <span class="string">tls-secret</span></span><br></pre></td></tr></table></figure>

<h2 id="10、“金丝雀”发布"><a href="#10、“金丝雀”发布" class="headerlink" title="10、“金丝雀”发布"></a>10、“金丝雀”发布</h2><p>“金丝雀”发布又称为灰度发布，灰度发布功能可以将用户请求按照指定的策略进行分割，并转发到不同的代理服务器组，通过不同的代理服务器部署应用不同版本可进行对照比较，因该方式对于新版本而言类似于使用“金丝雀”的方式进行测试，所以也叫“金丝雀”发布。<br>Nginx Ingress 支持 Header、cookie 和权重 3 种方式，可单独使用，也可以组合使用。“金丝雀”发布配置说明如下表所示。</p>
<table>
<thead>
<tr>
<th>注解</th>
<th>类型</th>
<th>功能描述</th>
</tr>
</thead>
<tbody><tr>
<td>nginx.ingress.kubernetes.io&#x2F;canary</td>
<td>true 或 false</td>
<td>启用“金丝雀”发布功能</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;canary-by-header</td>
<td>string</td>
<td>设置请求头属性字段的名称，用于根据该字段的值判断是否将请求路由到“金丝雀”服务器组，该字段值为 always 时则该请求被路由到“金丝雀”服务器组；该字段值为 never 时则不路由到“金丝雀”服务器组</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;canary-by-header-value</td>
<td>string</td>
<td>自定义用于判断是否路由到“金丝雀”服务器组的请求头字段值，默认为 always，必须与 canary-by-header同时使用</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;canary-by-cookie</td>
<td>string</td>
<td>设置 cookie 的字段名称，用于根据该字段的值判断是否将请求路由到“金丝雀”服务器组。always 则路由到“金丝雀”服务器组；never 则永远不路由到“金丝雀”服务器组</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;canary-weight</td>
<td>number</td>
<td>将请求基于整数（0~100）的请求百分比随机路由到“金丝雀”服务器组；100 表示所有请求都路由到“金丝雀”服务器组；0 表示不路由任何请求到“金丝雀”服务器组</td>
</tr>
</tbody></table>
<p>“金丝雀”路由规则同时存在时的优先顺序是 canary-by-header、canary-by-cookie、canary-weight。</p>
<p>配置样例如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建主机web.nginxbar.org的Ingress资源配置</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">web-nginxbar-org</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/ingress.class:</span> <span class="string">&quot;nginx&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">web.nginxbar.org</span>   <span class="comment"># 此service的访问域名</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">            <span class="attr">serviceName:</span> <span class="string">nginx-web</span></span><br><span class="line">            <span class="attr">servicePort:</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建主机web.nginxbar.org金丝雀组的Ingress资源配置</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">web-nginxbar-org-canary</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/ingress.class:</span> <span class="string">&quot;nginx&quot;</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/canary:</span> <span class="string">&quot;true&quot;</span><span class="string">,</span></span><br><span class="line">        <span class="comment"># 根据请求头字段CanaryByHeader的值进行判断</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/canary-by-header:</span> <span class="string">&quot;CanaryByHeader&quot;</span><span class="string">,</span></span><br><span class="line">        <span class="comment"># 请求头字段CanaryByHeader的值为DoCanary时，路由到“金丝雀”服务器组</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/canary-by-header-value:</span> <span class="string">&quot;DoCanary&quot;</span><span class="string">,</span></span><br><span class="line">        <span class="comment"># 根据Cookie字段CanaryByCookie的值进行判断</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/canary-by-cookie:</span> <span class="string">&quot;CanaryByCookie&quot;</span><span class="string">,</span></span><br><span class="line">        <span class="comment"># 随机10%的请求路由到“金丝雀”服务器组</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/canary-weight:</span> <span class="string">&quot;10&quot;</span><span class="string">,</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">web.nginxbar.org</span>   <span class="comment"># 此service的访问域名</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">            <span class="attr">serviceName:</span> <span class="string">nginx-web-canary</span></span><br><span class="line">            <span class="attr">servicePort:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure>

<h2 id="11、lua-resty-waf模块"><a href="#11、lua-resty-waf模块" class="headerlink" title="11、lua-resty-waf模块"></a>11、lua-resty-waf模块</h2><p>lua-resty-waf 是一个基于 OpenResty 的高性能 Web 应用防火墙，对当前虚拟主机的访问可以按照相关防火墙规则进行访问过滤。模块配置说明如下表所示。</p>
<table>
<thead>
<tr>
<th>注解</th>
<th>类型</th>
<th>功能描述</th>
</tr>
</thead>
<tbody><tr>
<td>nginx.ingress.kubernetes.io&#x2F;lua-resty-waf</td>
<td>string</td>
<td>设置 WAF 防火墙的工作模式，inactive 表示不执行任何操作；active 表示启用：simulate 模式下，如果给定请求有匹配的规则，它将记录一条警告消息而不进行处理。这有助于在完全部署规则之前调试规则并消除可能的误报</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;lua-resty-waf-debug</td>
<td>true 或 false</td>
<td>设置是否启用调试功能，默认值为 false</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;lua-resty-waf-ignore-rulesets</td>
<td>string</td>
<td>设置忽略规则集的名称，当某些规则集（如 sqli 或 xss crs 规则集）太容易误报或不适用时，可通过该设置进行忽略处理</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;lua-resty-waf-extra-rules</td>
<td>string</td>
<td>设置自定义的规则</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;lua-resty-waf-allow-unknown-content-types</td>
<td>true 或 false</td>
<td>设置在发送了不在允许内容类型表中的内容类型头时是否继续处理请求。默认允许的为 text&#x2F;html、text&#x2F;json、application&#x2F;json 的文档类型，默认值为 false</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;lua-resty-waf-score-threshold</td>
<td>number</td>
<td>设置请求异常评分的阈值，如果超过这个阈值，则拒绝该请求，默认值为 5</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;lua-resty-waf-process-multipart-body</td>
<td>true 或 false</td>
<td>设置是否使用 lua-resty-upload 模块对 multipart&#x2F;form-data 类型请求体的处理，默认为 true</td>
</tr>
</tbody></table>
<h2 id="12、ModSecurity模块配置"><a href="#12、ModSecurity模块配置" class="headerlink" title="12、ModSecurity模块配置"></a>12、ModSecurity模块配置</h2><p>ModSecurity 是一个开源的 Web 应用防火墙。必须首先通过在 ConfigMap 中启用 Mod-Security 来加载 ModSecurity 模块。这将为所有路径启用 ModSecurity 过滤，可以手动在 Ingress 资源实例中禁用此功能。ModSecurity 模块配置说明如下表所示。</p>
<table>
<thead>
<tr>
<th>注解</th>
<th>类型</th>
<th>功能描述</th>
</tr>
</thead>
<tbody><tr>
<td>nginx.ingress.kubernetes.io&#x2F;enable-mod-security</td>
<td>bool</td>
<td>设置是否启用 ModSecurity 过滤，启用时应用推荐的规则以仅检测（Detection-Only）模式运行</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;enable-owasp-core-rules</td>
<td>bool</td>
<td>设置是否使用 OWASP 核心规则进行请求检测</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;modsecurity-transaction-id</td>
<td>string</td>
<td>设置从 Nginx 传递事务 ID，而不是在库中自动生成，有利于在 ModSecurity 中跟踪查看检测的请求，对应模块配置指令为 modsecurity_transaction_id</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;modsecurity-snippet</td>
<td>string</td>
<td>添加模块配置指令 modsecurity_rules 的内容</td>
</tr>
</tbody></table>
<p>配置样例如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">web-nginxbar-org</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/enable-modsecurity:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/enable-owasp-core-rules:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/modsecurity-transaction-id:</span> <span class="string">&quot;$request_id&quot;</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/modsecurity-snippet:</span> <span class="string">|</span></span><br><span class="line"><span class="string">        SecRuleEngine On</span></span><br><span class="line"><span class="string">        SecDebugLog /tmp/modsec_debug.log</span></span><br><span class="line"><span class="string"></span><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">web.nginxbar.org</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">            <span class="attr">serviceName:</span> <span class="string">nginx-web</span></span><br><span class="line">            <span class="attr">servicePort:</span> <span class="number">8080</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/</span></span><br></pre></td></tr></table></figure>

<h2 id="13、Influxdb模块配置"><a href="#13、Influxdb模块配置" class="headerlink" title="13、Influxdb模块配置"></a>13、Influxdb模块配置</h2><p>通过使用 Nginx Influxdb 模块，可以用 UDP 协议将请求记录实时发送到后端的 Influxdb 服务器。Influxdb 模块配置说明如下表所示。</p>
<table>
<thead>
<tr>
<th>注解</th>
<th>类型</th>
<th>功能描述</th>
</tr>
</thead>
<tbody><tr>
<td>nginx.ingress.kubernetes.io&#x2F;enable-influxdb</td>
<td>true 或 false</td>
<td>是否启用 Influxdb 输出功能</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;influxdb-measurement</td>
<td>string</td>
<td>指定 Influxdb 中的 measurement 名称</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;influxdb-port</td>
<td>string</td>
<td>指定 Influxdb 的端口</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;influxdb-host</td>
<td>string</td>
<td>指定 Influxdb 的 IP 地址</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;influxdb-server-name</td>
<td>string</td>
<td>设置自己的应用标识</td>
</tr>
</tbody></table>
<p>配置样例如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">web-nginxbar-org</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/enable-influxdb:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/influxdb-measurement:</span> <span class="string">&quot;nginxbar-reqs&quot;</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/influxdb-port:</span> <span class="string">&quot;8089&quot;</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/influxdb-host:</span> <span class="string">&quot;192.168.2.110&quot;</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/influxdb-server-name:</span> <span class="string">&quot;nginxbar-com&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">web.nginxbar.org</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">            <span class="attr">serviceName:</span> <span class="string">nginx-web</span></span><br><span class="line">            <span class="attr">servicePort:</span> <span class="number">8080</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/</span></span><br></pre></td></tr></table></figure>

<h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><h3 id="金丝雀"><a href="#金丝雀" class="headerlink" title="金丝雀"></a>金丝雀</h3><p>在某些情况下，您可能希望通过向少量与生产服务不同的服务发送少量请求来“取消”一组新的更改。Canary注释使Ingress规范可以充当路由请求的替代服务，具体取决于所应用的规则。<code>nginx.ingress.kubernetes.io/canary: &quot;true&quot;</code>设置后，可以启用以下用于配置金丝雀的注释：</p>
<ul>
<li><code>nginx.ingress.kubernetes.io/canary-by-header</code>：用于通知Ingress将请求路由到Canary Ingress中指定的服务的标头。当请求标头设置<code>always</code>为时，它将被路由到Canary。当标头设置<code>never</code>为时，它将永远不会路由到金丝雀。对于任何其他值，标头将被忽略，并且按优先级将请求与其他金丝雀规则进行比较。</li>
<li><code>nginx.ingress.kubernetes.io/canary-by-header-value</code>：匹配的报头值，用于通知Ingress将请求路由到Canary Ingress中指定的服务。当请求标头设置为此值时，它将被路由到Canary。对于任何其他标头值，标头将被忽略，并按优先级将请求与其他金丝雀规则进行比较。此注释必须与一起使用。注释是的扩展，<code>nginx.ingress.kubernetes.io/canary-by-header</code>允许自定义标头值，而不使用硬编码值。如果<code>nginx.ingress.kubernetes.io/canary-by-header</code>未定义注释，则没有任何作用。</li>
<li><code>nginx.ingress.kubernetes.io/canary-by-header-pattern</code>：这与<code>canary-by-header-value</code>PCRE Regex匹配相同。请注意，<code>canary-by-header-value</code>设置时，此注释将被忽略。当给定的正则表达式在请求处理期间导致错误时，该请求将被视为不匹配。</li>
<li><code>nginx.ingress.kubernetes.io/canary-by-cookie</code>：用于通知Ingress将请求路由到Canary Ingress中指定的服务的cookie。当cookie值设置<code>always</code>为时，它将被路由到canary。当cookie设置<code>never</code>为时，它将永远不会路由到Canary。对于任何其他值，将忽略cookie，并按优先级将请求与其他canary规则进行比较。</li>
<li><code>nginx.ingress.kubernetes.io/canary-weight</code>：随机请求的整数百分比（0-100），应将其路由到canary Ingress中指定的服务。权重0表示此Canary规则不会在Canary入口中将任何请求发送到服务。权重为100表示所有请求都将发送到Ingress中指定的替代服务。</li>
</ul>
<p>金丝雀规则按优先级进行评估。优先级如下： <code>canary-by-header -&gt; canary-by-cookie -&gt; canary-weight</code></p>
<p><strong>请注意</strong>，当您将某个入口标记为canary时，除<code>nginx.ingress.kubernetes.io/load-balance</code>和之外，所有其他非canary注释将被忽略（从相应的主要入口继承）<code>nginx.ingress.kubernetes.io/upstream-hash-by</code>。</p>
<p><strong>已知局限性</strong></p>
<p>目前，每个Ingress规则最多可以应用一个Canary Ingress。</p>
<h3 id="Rewrite"><a href="#Rewrite" class="headerlink" title="Rewrite"></a>Rewrite</h3><p>在某些情况下，后端服务中公开的URL与Ingress规则中指定的路径不同。如果没有重写，则任何请求都将返回404。将注释设置<code>nginx.ingress.kubernetes.io/rewrite-target</code>为服务所需的路径。</p>
<p>如果应用程序根目录暴露在其他路径中，并且需要重定向，请设置注释<code>nginx.ingress.kubernetes.io/app-root</code>以重定向的请求<code>/</code>。</p>
<h3 id="Session-Affinity"><a href="#Session-Affinity" class="headerlink" title="Session Affinity"></a>Session Affinity</h3><p>注释<code>nginx.ingress.kubernetes.io/affinity</code>在Ingress的所有上游中启用和设置相似性类型。这样，请求将始终定向到同一上游服务器。NGINX唯一可用的相似性类型是<code>cookie</code>。</p>
<p>注释<code>nginx.ingress.kubernetes.io/affinity-mode</code>定义了会话的粘性。<code>balanced</code>如果将部署规模扩大，则将此选项设置为（默认）将重新分配一些会话，从而重新平衡服务器上的负载。将此设置为<code>persistent</code>不会重新平衡与新服务器的会话，因此提供了最大的粘性。</p>
<p><strong>注意</strong></p>
<p>如果为一个主机定义了多个Ingress <code>nginx.ingress.kubernetes.io/affinity: cookie</code>，并且至少一个Ingress使用，则只有Ingress使用的路径<code>nginx.ingress.kubernetes.io/affinity</code>将使用会话Cookie相似性。通过随机选择后端服务器，可以在主机的其他入口定义的所有路径进行负载均衡。</p>
<h4 id="Cookie-Affinity"><a href="#Cookie-Affinity" class="headerlink" title="Cookie Affinity"></a>Cookie Affinity</h4><p>如果使用<code>cookie</code>亲缘关系类型，则还可以指定将用于通过注释路由请求的cookie的名称<code>nginx.ingress.kubernetes.io/session-cookie-name</code>。默认是创建一个名为“ INGRESSCOOKIE”的cookie。</p>
<p>NGINX批注<code>nginx.ingress.kubernetes.io/session-cookie-path</code>定义将在cookie上设置的路径。除非注释<code>nginx.ingress.kubernetes.io/use-regex</code>设置为true，否则这是可选的。会话Cookie路径不支持正则表达式。</p>
<p>使用<code>nginx.ingress.kubernetes.io/session-cookie-samesite</code>的应用<code>SameSite</code>属性粘饼干。浏览器接受的值是<code>None</code>，<code>Lax</code>和<code>Strict</code>。某些浏览器会拒绝带有的cookie <code>SameSite=None</code>，包括在<code>SameSite=None</code>规范之前创建的cookie （例如Chrome 5X）。其他浏览器错误地将<code>SameSite=None</code>cookie视为<code>SameSite=Strict</code>（例如，在OSX 14上运行的Safari）。要从<code>SameSite=None</code>浏览器中忽略这些不兼容的内容，请添加注释<code>nginx.ingress.kubernetes.io/session-cookie-conditional-samesite-none: &quot;true&quot;</code>。</p>
<h3 id="认证方式"><a href="#认证方式" class="headerlink" title="认证方式"></a>认证方式</h3><p>可以添加身份验证，并在Ingress规则中添加其他注释。身份验证的来源是包含用户名和密码的机密。</p>
<p>注释是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/auth-type: [basic|digest]</span><br></pre></td></tr></table></figure>

<p>指示<a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc2617">HTTP身份验证类型：基本或摘要访问身份验证</a>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/auth-secret: secretName</span><br></pre></td></tr></table></figure>

<p>Secret的名称，其中包含用户名和密码，这些用户名和密码被授予<code>path</code>对Ingress规则中定义的的访问权限。此注释还接受替代形式“名称空间&#x2F; secretName”，在这种情况下，秘密查找在引用的名称空间而不是Ingress名称空间中执行。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/auth-secret-type: [auth-file|auth-map]</span><br></pre></td></tr></table></figure>

<p>本<code>auth-secret</code>可以有两种形式：</p>
<ul>
<li><code>auth-file</code>-默认情况下，密钥<code>auth</code>内的htpasswd文件为秘密</li>
<li><code>auth-map</code> -机密密钥是用户名，值是哈希密码</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/auth-realm: &quot;realm string&quot;</span><br></pre></td></tr></table></figure>



<h3 id="自定义NGINX上游哈希"><a href="#自定义NGINX上游哈希" class="headerlink" title="自定义NGINX上游哈希"></a>自定义NGINX上游哈希</h3><p>NGINX支持客户端-服务器映射的负载平衡，该映射基于给定密钥的<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_upstream_module.html#hash">一致哈希</a>值。键可以包含文本，变量或其任何组合。此功能允许请求粘性而不是客户端IP或cookie。将使用<a target="_blank" rel="noopener" href="http://www.last.fm/user/RJ/journal/2007/04/10/392555/">ketama</a>一致的哈希方法，该方法确保在上游组更改时仅将少数密钥重新映射到不同的服务器。</p>
<p>上游哈希的一种特殊模式称为子集。在这种模式下，上游服务器被分组为子集，粘性通过将密钥映射到子集而不是单个上游服务器来工作。从选定的粘性子集中随机选择特定的服务器。它提供了粘性和负载分配之间的平衡。</p>
<p>要为后端启用一致的哈希：</p>
<p><code>nginx.ingress.kubernetes.io/upstream-hash-by</code>：nginx变量，文本值或它们的任意组合，以用于一致的哈希。例如<code>nginx.ingress.kubernetes.io/upstream-hash-by: &quot;$request_uri&quot;</code>，通过当前请求URI一致地哈希上游请求。</p>
<p>可以启用“子集”散列设置<code>nginx.ingress.kubernetes.io/upstream-hash-by-subset</code>：“ true”。这会将请求映射到节点的子集，而不是单个请求。<code>upstream-hash-by-subset-size</code>确定每个子集的大小（默认为3）。</p>
<p>请检查<a target="_blank" rel="noopener" href="https://blog.csdn.net/examples/chashsubset/deployment.yaml">chashsubset</a>示例。</p>
<h3 id="自定义NGINX负载平衡"><a href="#自定义NGINX负载平衡" class="headerlink" title="自定义NGINX负载平衡"></a>自定义NGINX负载平衡</h3><p>这与<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44692256/article/configmap/#load-balance"><code>load-balance</code>ConfigMap中的</a>类似，但是每个入口配置负载平衡算法。</p>
<blockquote>
<p>请注意，<code>nginx.ingress.kubernetes.io/upstream-hash-by</code>优先于此。如果<code>nginx.ingress.kubernetes.io/upstream-hash-by</code>未设置，则我们将退回到使用全局配置的负载平衡算法。</p>
</blockquote>
<h3 id="自定义NGINX上游虚拟主机"><a href="#自定义NGINX上游虚拟主机" class="headerlink" title="自定义NGINX上游虚拟主机"></a>自定义NGINX上游虚拟主机</h3><p>通过此配置设置，您可以在以下语句中控制host的值：<code>proxy_set_header Host $host</code>，它是位置块的一部分。如果您需要通过以外的方式调用上游服务器，这将非常有用<code>$host</code>。</p>
<h3 id="客户端证书认证"><a href="#客户端证书认证" class="headerlink" title="客户端证书认证"></a>客户端证书认证</h3><p>可以使用“入口规则”中的附加注释来启用“客户端证书认证”。</p>
<p>注释是：</p>
<ul>
<li><code>nginx.ingress.kubernetes.io/auth-tls-secret: secretName</code>：包含完整的证书颁发机构链的密钥的名称，该链<code>ca.crt</code>可以针对此Ingress进行身份验证。此注释还接受替代形式“名称空间&#x2F; secretName”，在这种情况下，秘密查找在引用的名称空间而不是Ingress名称空间中执行。</li>
<li><code>nginx.ingress.kubernetes.io/auth-tls-verify-depth</code>：提供的客户证书和证书颁发机构链之间的验证深度。</li>
<li><code>nginx.ingress.kubernetes.io/auth-tls-verify-client</code>：启用客户端证书的验证。</li>
<li><code>nginx.ingress.kubernetes.io/auth-tls-error-page</code>：如果发生证书身份验证错误，应重定向用户的URL &#x2F;页面</li>
<li><code>nginx.ingress.kubernetes.io/auth-tls-pass-certificate-to-upstream</code>：指示是否应将收到的证书传递给上游服务器。默认情况下是禁用的。</li>
</ul>
<p><strong>注意</strong></p>
<p>Cloudflare中<strong>无法</strong>使用带有客户端身份验证的TLS，<strong>这</strong>可能会导致意外行为。</p>
<p>Cloudflare仅允许使用Authenticated Origin Pulls，并且需要使用其自己的证书：<a target="_blank" rel="noopener" href="https://blog.cloudflare.com/protecting-the-origin-with-tls-authenticated-origin-pulls/">https</a> : <a target="_blank" rel="noopener" href="https://blog.cloudflare.com/protecting-the-origin-with-tls-authenticated-origin-pulls/">&#x2F;&#x2F;blog.cloudflare.com&#x2F;protecting-the-origin-with-tls-authenticated-origin-pulls&#x2F;</a></p>
<p>仅允许通过身份验证的原产拉取，并且可以按照其教程进行配置：<a target="_blank" rel="noopener" href="https://support.cloudflare.com/hc/en-us/articles/204494148-Setting-up-NGINX-to-use-TLS-Authenticated-Origin-Pulls">https</a> : <a target="_blank" rel="noopener" href="https://support.cloudflare.com/hc/en-us/articles/204494148-Setting-up-NGINX-to-use-TLS-Authenticated-Origin-Pulls">&#x2F;&#x2F;support.cloudflare.com&#x2F;hc&#x2F;en-us&#x2F;articles&#x2F;204494148-Setting-up-NGINX-to-use-TLS-Authenticated-Origin -拉</a></p>
<h3 id="后端证书认证"><a href="#后端证书认证" class="headerlink" title="后端证书认证"></a>后端证书认证</h3><p>使用入口规则中的附加注释，可以使用证书对代理的HTTPS后端进行身份验证。</p>
<ul>
<li><code>nginx.ingress.kubernetes.io/proxy-ssl-secret: secretName</code>：使用证书<code>tls.crt</code>（<code>tls.key</code>PEM格式的密钥）指定用于对代理HTTPS服务器进行身份验证的密钥。它还应包含<code>ca.crt</code>PEM格式的受信任CA证书，该证书用于验证代理HTTPS服务器的证书。此注释还接受替代形式“名称空间&#x2F; secretName”，在这种情况下，秘密查找在引用的名称空间而不是Ingress名称空间中执行。</li>
<li><code>nginx.ingress.kubernetes.io/proxy-ssl-verify</code>：启用或禁用对代理HTTPS服务器证书的验证。（默认值：关闭）</li>
<li><code>nginx.ingress.kubernetes.io/proxy-ssl-verify-depth</code>：设置代理HTTPS服务器证书链中的验证深度。（默认值：1）</li>
<li><code>nginx.ingress.kubernetes.io/proxy-ssl-ciphers</code>：指定对代理HTTPS服务器的请求的启用<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_ssl_ciphers">密码</a>。密码以OpenSSL库可以理解的格式指定。</li>
<li><code>nginx.ingress.kubernetes.io/proxy-ssl-name</code>：允许设置<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_ssl_name">proxy_ssl_name</a>。这允许覆盖用于验证代理HTTPS服务器的证书的服务器名称。建立与代理HTTPS服务器的连接时，也会通过SNI传递此值。</li>
<li><code>nginx.ingress.kubernetes.io/proxy-ssl-protocols</code>：启用对代理HTTPS服务器的请求的指定<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_ssl_protocols">协议</a>。</li>
</ul>
<h3 id="配置片段"><a href="#配置片段" class="headerlink" title="配置片段"></a>配置片段</h3><p>使用此注释，您可以将其他配置添加到NGINX位置。例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/configuration-snippet: | more_set_headers &quot;Request-Id: $req_id&quot;;</span><br></pre></td></tr></table></figure>

<h3 id="自定义HTTP错误"><a href="#自定义HTTP错误" class="headerlink" title="自定义HTTP错误"></a>自定义HTTP错误</h3><p>就像<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44692256/article/configmap/#custom-http-errors"><code>custom-http-errors</code></a>ConfigMap中的值一样，此批注将设置NGINX <code>proxy-intercept-errors</code>，但仅针对与此入口相关联的NGINX位置。如果在入口上指定了<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44692256/article/details/108581800#default-backend">默认后端注释</a>，则错误将路由到该注释的默认后端服务（而不是全局默认后端）。不同的入口可以指定不同的错误代码集。即使多个入口对象共享相同的主机名，此注释也可以用于为每个入口截取不同的错误代码（例如，如果每个路径在不同的入口上，则对于同一主机名上的不同路径将截取不同的错误代码） 。如果<code>custom-http-errors</code> 也是全局指定的，在此批注中指定的错误值将覆盖给定入口的主机名和路径的全局值。</p>
<p>用法示例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/custom-http-errors: &quot;404,415&quot;</span><br></pre></td></tr></table></figure>

<h3 id="默认后端"><a href="#默认后端" class="headerlink" title="默认后端"></a>默认后端</h3><p>此批注具有<code>nginx.ingress.kubernetes.io/default-backend: &lt;svc name&gt;</code>指定自定义默认后端的形式。这<code>&lt;svc name&gt;</code>是对您在其中应用此批注的相同名称空间中的服务的引用。此注释将覆盖全局默认后端。</p>
<p>当Ingress规则中的服务没有活动的端点时，将处理该服务的响应。如果同时设置了此注释和<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44692256/article/details/108581800#custom-http-errors">custom-http-errors注释，</a>它还将处理错误响应。</p>
<h3 id="启用CORS"><a href="#启用CORS" class="headerlink" title="启用CORS"></a>启用CORS</h3><p>要在Ingress规则中启用跨域资源共享（CORS），请添加注释 <code>nginx.ingress.kubernetes.io/enable-cors: &quot;true&quot;</code>。这将在服务器位置中添加一个部分以启用此功能。</p>
<p>可以使用以下注释来控制CORS：</p>
<ul>
<li><code>nginx.ingress.kubernetes.io/cors-allow-methods</code> 控制接受哪些方法。这是一个多值字段，以“，”分隔，仅接受字母（大写和小写）。</li>
<li>默认： <code>GET, PUT, POST, DELETE, PATCH, OPTIONS</code></li>
<li>例： <code>nginx.ingress.kubernetes.io/cors-allow-methods: &quot;PUT, GET, POST, OPTIONS&quot;</code></li>
<li><code>nginx.ingress.kubernetes.io/cors-allow-headers</code> 控制接受哪些标题。这是一个多值字段，以“，”分隔，并接受字母，数字，_和-。</li>
<li>默认： <code>DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization</code></li>
<li>例： <code>nginx.ingress.kubernetes.io/cors-allow-headers: &quot;X-Forwarded-For, X-app123-XPTO&quot;</code></li>
<li><code>nginx.ingress.kubernetes.io/cors-allow-origin</code> 控制CORS接受的原产地。这是一个单字段值，格式如下：<code>http(s)://origin-site.com</code>或<code>http(s)://origin-site.com:port</code></li>
<li>默认： <code>*</code></li>
<li>例： <code>nginx.ingress.kubernetes.io/cors-allow-origin: &quot;https://origin-site.com:4443&quot;</code></li>
<li><code>nginx.ingress.kubernetes.io/cors-allow-credentials</code> 控制在CORS操作期间是否可以传递凭据。</li>
<li>默认： <code>true</code></li>
<li>例： <code>nginx.ingress.kubernetes.io/cors-allow-credentials: &quot;false&quot;</code></li>
<li><code>nginx.ingress.kubernetes.io/cors-max-age</code> 控制可以将预检请求缓存多长时间。默认值：<code>1728000</code> 示例：<code>nginx.ingress.kubernetes.io/cors-max-age: 600</code></li>
</ul>
<h3 id="HTTP2推送预加载。"><a href="#HTTP2推送预加载。" class="headerlink" title="HTTP2推送预加载。"></a>HTTP2推送预加载。</h3><p>启用将“链接”响应标题字段中指定的预加载链接自动转换为推送请求的功能。</p>
<p><code>nginx.ingress.kubernetes.io/http2-push-preload: &quot;true&quot;</code></p>
<h3 id="服务器别名"><a href="#服务器别名" class="headerlink" title="服务器别名"></a>服务器别名</h3><p>允许使用注解在NGINX配置的服务器定义中定义一个或多个别名<code>nginx.ingress.kubernetes.io/server-alias: &quot;&lt;alias 1&gt;,&lt;alias 2&gt;&quot;</code>。这将创建具有相同配置的服务器，但是会向<code>server_name</code>指令添加新值。</p>
<p><strong>注意</strong></p>
<p>服务器别名不能与现有服务器的主机名冲突。如果是这样，服务器别名注释将被忽略。如果创建了服务器别名，然后又创建了具有相同主机名的新服务器，则新服务器配置将取代别名配置。</p>
<p>欲了解更多信息，请参阅<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_core_module.html#server_name">该<code>server_name</code>文档</a>。</p>
<h3 id="Server-Snippet段"><a href="#Server-Snippet段" class="headerlink" title="Server Snippet段"></a>Server Snippet段</h3><p>使用注释<code>nginx.ingress.kubernetes.io/server-snippet</code>，可以在服务器配置块中添加自定义配置。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">annotations:</span></span><br><span class="line">	<span class="attr">nginx.ingress.kubernetes.io/server-snippet:</span> <span class="string">|</span></span><br><span class="line"><span class="string">        set $agentflag 0;    </span></span><br><span class="line"><span class="string">        if ($http_user_agent ~* &quot;(Mobile)&quot; )&#123;      </span></span><br><span class="line"><span class="string">        set $agentflag 1;    </span></span><br><span class="line"><span class="string">        &#125; </span></span><br><span class="line"><span class="string">        if ( $agentflag = 1 ) &#123;</span></span><br><span class="line"><span class="string">            return 301 https://m.example.com;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>

<p>每个主机只能使用一次此注释。</p>
<h3 id="客户端主体缓冲区大小"><a href="#客户端主体缓冲区大小" class="headerlink" title="客户端主体缓冲区大小"></a>客户端主体缓冲区大小</h3><p>设置缓冲区大小，以读取每个位置的客户端请求正文。如果请求主体大于缓冲区，则将整个主体或仅将其一部分写入临时文件。默认情况下，缓冲区大小等于两个内存页。在x86，其他32位平台和x86-64上为8K。在其他64位平台上，通常为16K。此注释将应用于入口规则中提供的每个位置。</p>
<p><strong>注意</strong></p>
<p>注释值必须以Nginx可以理解的格式给出。</p>
<p>例</p>
<ul>
<li><code>nginx.ingress.kubernetes.io/client-body-buffer-size: &quot;1000&quot;</code> ＃1000字节</li>
<li><code>nginx.ingress.kubernetes.io/client-body-buffer-size: 1k</code> ＃1千字节</li>
<li><code>nginx.ingress.kubernetes.io/client-body-buffer-size: 1K</code> ＃1千字节</li>
<li><code>nginx.ingress.kubernetes.io/client-body-buffer-size: 1m</code> ＃1兆字节</li>
<li><code>nginx.ingress.kubernetes.io/client-body-buffer-size: 1M</code> ＃1兆字节</li>
</ul>
<p>有关更多信息，请参见<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_core_module.html#client_body_buffer_size">http://nginx.org</a></p>
<h3 id="外部认证"><a href="#外部认证" class="headerlink" title="外部认证"></a>外部认证</h3><p>要使用提供身份验证的现有服务，可以对Ingress规则进行注释，<code>nginx.ingress.kubernetes.io/auth-url</code>以指示应将HTTP请求发送到的URL。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/auth-url: &quot;URL to the authentication service&quot;</span><br></pre></td></tr></table></figure>

<p>另外，可以设置：</p>
<ul>
<li><code>nginx.ingress.kubernetes.io/auth-method</code>： <code>&lt;Method&gt;</code>指定要使用的HTTP方法。</li>
<li><code>nginx.ingress.kubernetes.io/auth-signin</code>： <code>&lt;SignIn_URL&gt;</code>指定错误页面的位置。</li>
<li><code>nginx.ingress.kubernetes.io/auth-response-headers</code>： <code>&lt;Response_Header_1, ..., Response_Header_n&gt;</code>指定在身份验证请求完成后传递给后端的标头。</li>
<li><code>nginx.ingress.kubernetes.io/auth-proxy-set-headers</code>： <code>&lt;ConfigMap&gt;</code>ConfigMap的名称，该名称指定要传递给身份验证服务的标头</li>
<li><code>nginx.ingress.kubernetes.io/auth-request-redirect</code>： <code>&lt;Request_Redirect_URL&gt;</code> 指定X-Auth-Request-Redirect标头值。</li>
<li><code>nginx.ingress.kubernetes.io/auth-cache-key</code>： <code>&lt;Cache_Key&gt;</code>这将启用对身份验证请求的缓存。指定身份验证响应的查找键。例如<code>$remote_user$http_authorization</code>。每个服务器和位置都有其自己的密钥空间。因此，缓存的响应仅在按服务器和按位置的基础上有效。</li>
<li><code>nginx.ingress.kubernetes.io/auth-cache-duration</code>： <code>&lt;Cache_duration&gt;</code>根据身份验证响应的响应代码（例如）指定身份验证响应的缓存时间<code>200 202 30m</code>。有关详细信息，请参见<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_valid">proxy_cache_valid</a>。您可以指定多个逗号分隔的值：<code>200 202 10m, 401 5m</code>。默认为<code>200 202 401 5m</code>。</li>
<li><code>nginx.ingress.kubernetes.io/auth-snippet</code>： <code>&lt;Auth_Snippet&gt;</code>指定用于外部身份验证的自定义代码段，例如</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/auth-url: http://foo.com/external-auth nginx.ingress.kubernetes.io/auth-snippet: | proxy_set_header Foo-Header 42;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：<code>nginx.ingress.kubernetes.io/auth-snippet</code>是可选注释。但是，它只能与结合使用<code>nginx.ingress.kubernetes.io/auth-url</code>，如果<code>nginx.ingress.kubernetes.io/auth-url</code>未设置，则将被忽略</p>
</blockquote>
<h4 id="全局外部认证"><a href="#全局外部认证" class="headerlink" title="全局外部认证"></a>全局外部认证</h4><p>默认情况下，如果<code>global-auth-url</code>在NGINX ConfigMap中设置，则控制器会将所有请求重定向到提供身份验证的现有服务。如果您想为该入口禁用此行为，则可以<code>enable-global-auth: &quot;false&quot;</code>在NGINX ConfigMap中使用。 <code>nginx.ingress.kubernetes.io/enable-global-auth</code>：指示是否应将GlobalExternalAuth配置应用于此Ingress规则。默认值设置为<code>&quot;true&quot;</code>。</p>
<h3 id="限速"><a href="#限速" class="headerlink" title="限速"></a>限速</h3><p>这些注释定义了对连接和传输速率的限制。这些可以用来减轻<a target="_blank" rel="noopener" href="https://www.nginx.com/blog/mitigating-ddos-attacks-with-nginx-and-nginx-plus">DDoS攻击</a>。</p>
<ul>
<li><code>nginx.ingress.kubernetes.io/limit-connections</code>：单个IP地址允许的并发连接数。超出此限制时，将返回503错误。</li>
<li><code>nginx.ingress.kubernetes.io/limit-rps</code>：每秒从给定IP接受的请求数。突发限制设置为限制的5倍。当客户端超过此限制时， <a target="_blank" rel="noopener" href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/#limit-req-status-code">将</a> 返回<a target="_blank" rel="noopener" href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/#limit-req-status-code">limit-req-status-code</a> <strong>默认值：*</strong> 503。</li>
<li><code>nginx.ingress.kubernetes.io/limit-rpm</code>：每分钟从给定IP接受的请求数。突发限制设置为限制的5倍。当客户端超过此限制时， <a target="_blank" rel="noopener" href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/#limit-req-status-code">将</a> 返回<a target="_blank" rel="noopener" href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/#limit-req-status-code">limit-req-status-code</a> *<strong>默认值：*</strong> 503。</li>
<li><code>nginx.ingress.kubernetes.io/limit-rate-after</code>：初始千字节数，之后将进一步限制对给定连接的响应的进一步传输。必须在启用<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44692256/article/details/108581800#proxy-buffering">代理缓冲的情况</a>下使用此功能。</li>
<li><code>nginx.ingress.kubernetes.io/limit-rate</code>：每秒允许发送到给定连接的千字节数。零值禁用速率限制。必须在启用<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44692256/article/details/108581800#proxy-buffering">代理缓冲的情况</a>下使用此功能。</li>
<li><code>nginx.ingress.kubernetes.io/limit-whitelist</code>：客户端IP源范围要从速率限制中排除。该值是逗号分隔的CIDR列表。</li>
</ul>
<p>如果你在一个单一的入口规则指定多个注释，限制在顺序应用<code>limit-connections</code>，<code>limit-rpm</code>，<code>limit-rps</code>。</p>
<p>要为所有Ingress规则全局配置设置，可以在<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44692256/article/configmap/#limit-rate">NGINX ConfigMap中</a>设置<code>limit-rate-after</code>和<code>limit-rate</code>值。在Ingress注释中设置的值将覆盖全局设置。</p>
<p>当启用<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44692256/article/configmap/#use-forwarded-headers">use-forwarded-header</a>时，将基于<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44692256/article/configmap/#use-proxy-protocol">PROXY协议</a>的使用或从<code>X-Forwarded-For</code>标头值设置客户端IP地址。</p>
<h3 id="永久重定向"><a href="#永久重定向" class="headerlink" title="永久重定向"></a>永久重定向</h3><p>此注释允许返回永久重定向，而不是向上游发送数据。例如<code>nginx.ingress.kubernetes.io/permanent-redirect: https://www.google.com</code>，将所有内容重定向到Google。</p>
<h3 id="永久重定向码"><a href="#永久重定向码" class="headerlink" title="永久重定向码"></a>永久重定向码</h3><p>此注释使您可以修改用于永久重定向的状态代码。例如，<code>nginx.ingress.kubernetes.io/permanent-redirect-code: &#39;308&#39;</code>将以308返回您的永久重定向。</p>
<h3 id="Temporal-Redirect"><a href="#Temporal-Redirect" class="headerlink" title="Temporal Redirect"></a>Temporal Redirect</h3><p>此注释使您可以返回时间重定向（返回代码302），而不是将数据发送到上游。例如<code>nginx.ingress.kubernetes.io/temporal-redirect: https://www.google.com</code>，将所有内容重定向到Google，返回码为302（临时移动）</p>
<h3 id="SSL直通"><a href="#SSL直通" class="headerlink" title="SSL直通"></a>SSL直通</h3><p>注释<code>nginx.ingress.kubernetes.io/ssl-passthrough</code>指示控制器将TLS连接直接发送到后端，而不是让NGINX解密通信。另请参阅《用户指南》中的<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44692256/tls/#ssl-passthrough">TLS &#x2F; HTTPS</a>。</p>
<p>SSL直通<strong>默认情况下</strong>处于<strong>禁用状态，</strong>并且需要使用该<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44692256/cli-arguments/"><code>--enable-ssl-passthrough</code></a>标志启动控制器 。</p>
<p>由于SSL Passthrough在OSI模型（TCP）的第4层而不是第7层（HTTP）上起作用，因此使用SSL Passthrough会使在Ingress对象上设置的所有其他注释无效。</p>
<h3 id="Service-Upstream"><a href="#Service-Upstream" class="headerlink" title="Service Upstream"></a>Service Upstream</h3><p>默认情况下，NGINX入口控制器使用NGINX上游配置中所有端点（Pod IP &#x2F;端口）的列表。</p>
<p>该<code>nginx.ingress.kubernetes.io/service-upstream</code>注释禁用该行为，而是使用在NGINX，该服务的群集IP和端口的单一上游。</p>
<p>这对于零停机时间部署之类的事情可能是理想的，因为它减少了Pod上下时重新加载NGINX配置的需求。参见问题<a target="_blank" rel="noopener" href="https://github.com/kubernetes/ingress-nginx/issues/257">＃257</a>。</p>
<h4 id="已知的问题"><a href="#已知的问题" class="headerlink" title="已知的问题"></a>已知的问题</h4><p>如果<code>service-upstream</code>指定了注释，则应考虑以下事项：</p>
<ul>
<li>粘性会话将不起作用，因为仅支持循环负载平衡。</li>
<li>该<code>proxy_next_upstream</code>指令不会有任何影响，因为如果出错，该请求将不会分派到另一个上游。</li>
</ul>
<h3 id="通过重定向执行服务器端HTTPS"><a href="#通过重定向执行服务器端HTTPS" class="headerlink" title="通过重定向执行服务器端HTTPS"></a>通过重定向执行服务器端HTTPS</h3><p>默认情况下，如果为该入口启用了TLS，则控制器将重定向（308）到HTTPS。如果要全局禁用此行为，可以<code>ssl-redirect: &quot;false&quot;</code>在NGINX <a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44692256/article/configmap/#ssl-redirect">ConfigMap中使用</a>。</p>
<p>要为特定的入口资源配置此功能，可以<code>nginx.ingress.kubernetes.io/ssl-redirect: &quot;false&quot;</code> 在特定资源中使用注释。</p>
<p>在群集外部（例如AWS ELB）上使用SSL卸载时，即使没有可用的TLS证书，强制执行到HTTPS的重定向也可能很有用。这可以通过使用<code>nginx.ingress.kubernetes.io/force-ssl-redirect: &quot;true&quot;</code>特定资源中的注释来实现。</p>
<h3 id="从-x2F-重定向到www"><a href="#从-x2F-重定向到www" class="headerlink" title="从&#x2F;重定向到www"></a>从&#x2F;重定向到www</h3><p>在某些情况下，需要从重定向<code>www.domain.com</code>到<code>domain.com</code>，反之亦然。要启用此功能，请使用注释<code>nginx.ingress.kubernetes.io/from-to-www-redirect: &quot;true&quot;</code></p>
<p>如果在某个时候创建了一个新的Ingress，且其宿主等于选项之一（如<code>domain.com</code>），则注释将被省略。</p>
<p>对于从HTTPS到HTTPS的重定向是强制性的，位于Ingress TLS部分中的Secret中定义的SSL证书包含两个通用名称的FQDN。</p>
<h3 id="白名单来源范围"><a href="#白名单来源范围" class="headerlink" title="白名单来源范围"></a>白名单来源范围</h3><p>您可以通过<code>nginx.ingress.kubernetes.io/whitelist-source-range</code>注释指定允许的客户端IP源范围。该值是逗号分隔的<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing">CIDR</a>列表，例如 <code>10.0.0.0/24,172.10.0.1</code>。</p>
<p>要为所有Ingress规则全局配置此设置，<code>whitelist-source-range</code>可以在<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44692256/article/configmap/#whitelist-source-range">NGINX ConfigMap中</a>设置该值。</p>
<p>向Ingress规则添加注释会覆盖所有全局限制。</p>
<h3 id="自定义超时"><a href="#自定义超时" class="headerlink" title="自定义超时"></a>自定义超时</h3><p>使用配置configmap可以为与上游服务器的连接设置默认的全局超时。在某些情况下，要求具有不同的值。为此，我们提供了允许进行此自定义的注释：</p>
<ul>
<li><code>nginx.ingress.kubernetes.io/proxy-connect-timeout</code></li>
<li><code>nginx.ingress.kubernetes.io/proxy-send-timeout</code></li>
<li><code>nginx.ingress.kubernetes.io/proxy-read-timeout</code></li>
<li><code>nginx.ingress.kubernetes.io/proxy-next-upstream</code></li>
<li><code>nginx.ingress.kubernetes.io/proxy-next-upstream-timeout</code></li>
<li><code>nginx.ingress.kubernetes.io/proxy-next-upstream-tries</code></li>
<li><code>nginx.ingress.kubernetes.io/proxy-request-buffering</code></li>
</ul>
<h3 id="代理重定向"><a href="#代理重定向" class="headerlink" title="代理重定向"></a>代理重定向</h3><p>使用注释<code>nginx.ingress.kubernetes.io/proxy-redirect-from</code>，<code>nginx.ingress.kubernetes.io/proxy-redirect-to</code>可以在<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_redirect">代理服务器响应</a>的<code>Location</code>和<code>Refresh</code>标头字段中设置应更改的文本</p>
<p>在注释中设置为“ off”或“ default” <code>nginx.ingress.kubernetes.io/proxy-redirect-from</code>会禁用<code>nginx.ingress.kubernetes.io/proxy-redirect-to</code>，否则，必须同时使用两个注释。请注意，每个注释必须是不带空格的字符串。</p>
<p>默认情况下，每个注释的值为“ off”。</p>
<h3 id="Custom-max-body-size"><a href="#Custom-max-body-size" class="headerlink" title="Custom max body size"></a>Custom max body size</h3><p>对于NGINX，当请求中的大小超过客户端请求正文的最大允许大小时，将向客户端返回413错误。该大小可以通过参数来配置<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_core_module.html#client_max_body_size"><code>client_max_body_size</code></a>。</p>
<p>要为所有Ingress规则全局配置此设置，<code>proxy-body-size</code>可以在<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44692256/article/configmap/#proxy-body-size">NGINX ConfigMap中</a>设置该值。要在Ingress规则中使用自定义值，请定义以下注释：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/proxy-body-size: 8m</span><br></pre></td></tr></table></figure>

<h3 id="代理Cookie域"><a href="#代理Cookie域" class="headerlink" title="代理Cookie域"></a>代理Cookie域</h3><p>设置<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cookie_domain">应在</a>代理服务器响应的“ Set-Cookie”标头字段<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cookie_domain">的domain属性</a>中<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cookie_domain">更改</a>的文本。</p>
<p>要为所有Ingress规则全局配置此设置，<code>proxy-cookie-domain</code>可以在<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44692256/article/configmap/#proxy-cookie-domain">NGINX ConfigMap中</a>设置该值。</p>
<h3 id="代理Cookie路径"><a href="#代理Cookie路径" class="headerlink" title="代理Cookie路径"></a>代理Cookie路径</h3><p>设置<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cookie_path">应在</a>代理服务器响应的“ Set-Cookie”标头字段<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cookie_path">的path属性</a>中<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cookie_path">更改</a>的文本。</p>
<p>要为所有Ingress规则全局配置此设置，<code>proxy-cookie-path</code>可以在<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44692256/article/configmap/#proxy-cookie-path">NGINX ConfigMap中</a>设置该值。</p>
<h3 id="代理缓冲"><a href="#代理缓冲" class="headerlink" title="代理缓冲"></a>代理缓冲</h3><p>启用或禁用代理缓冲<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_buffering"><code>proxy_buffering</code></a>。默认情况下，NGINX配置中禁用代理缓冲。</p>
<p>要为所有Ingress规则全局配置此设置，<code>proxy-buffering</code>可以在<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44692256/article/configmap/#proxy-buffering">NGINX ConfigMap中</a>设置该值。要在Ingress规则中使用自定义值，请定义以下注释：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/proxy-buffering: &quot;on&quot;</span><br></pre></td></tr></table></figure>

<h3 id="代理缓冲区数"><a href="#代理缓冲区数" class="headerlink" title="代理缓冲区数"></a>代理缓冲区数</h3><p>设置<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_buffers"><code>proxy_buffers</code></a>用于读取从代理服务器接收到的响应的第一部分的缓冲区数。默认情况下，代理缓冲区数设置为4</p>
<p>要全局配置此设置，请<code>proxy-buffers-number</code>在<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44692256/article/configmap/#proxy-buffers-number">NGINX ConfigMap中进行</a>设置。要在Ingress规则中使用自定义值，请定义以下注释：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/proxy-buffers-number: &quot;4&quot;</span><br></pre></td></tr></table></figure>

<h3 id="代理缓冲区大小"><a href="#代理缓冲区大小" class="headerlink" title="代理缓冲区大小"></a>代理缓冲区大小</h3><p>设置<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_buffer_size"><code>proxy_buffer_size</code></a>用于读取从代理服务器接收到的响应的第一部分的缓冲区的大小。默认情况下，代理缓冲区大小设置为“ 4k”</p>
<p>要全局配置此设置，请<code>proxy-buffer-size</code>在<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44692256/article/configmap/#proxy-buffer-size">NGINX ConfigMap中进行</a>设置。要在Ingress规则中使用自定义值，请定义以下注释：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/proxy-buffer-size: &quot;8k&quot;</span><br></pre></td></tr></table></figure>

<h3 id="代理最大临时文件大小"><a href="#代理最大临时文件大小" class="headerlink" title="代理最大临时文件大小"></a>代理最大临时文件大小</h3><p>如果<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_buffering"><code>buffering</code></a>启用了来自代理服务器的响应，并且整个响应不适合通过<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_buffer_size"><code>proxy_buffer_size</code></a>和<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_buffers"><code>proxy_buffers</code></a>指令设置的缓冲区，则可以将响应的一部分保存到临时文件中。此伪指令设置<code>size</code>临时文件的最大值，设置为<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_max_temp_file_size"><code>proxy_max_temp_file_size</code></a>。一次写入临时文件的数据大小由<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_temp_file_write_size"><code>proxy_temp_file_write_size</code></a>指令设置。</p>
<p>零值禁用对临时文件的响应的缓冲。</p>
<p>要在Ingress规则中使用自定义值，请定义以下注释：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/proxy-max-temp-file-size: &quot;1024m&quot;</span><br></pre></td></tr></table></figure>

<h3 id="代理HTTP版本"><a href="#代理HTTP版本" class="headerlink" title="代理HTTP版本"></a>代理HTTP版本</h3><p>使用此注释设置<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_http_version"><code>proxy_http_version</code></a>Nginx反向代理将用于与后端通信的。默认情况下，它设置为“ 1.1”。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/proxy-http-version: &quot;1.0&quot;</span><br></pre></td></tr></table></figure>

<h3 id="SSL密码"><a href="#SSL密码" class="headerlink" title="SSL密码"></a>SSL密码</h3><p>指定<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_ssl_module.html#ssl_ciphers">启用的密码</a>。</p>
<p>使用此注释将<code>ssl_ciphers</code>在服务器级别设置指令。该配置对主机中的所有路径均有效。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/ssl-ciphers: &quot;ALL:!aNULL:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP&quot;</span><br></pre></td></tr></table></figure>

<h3 id="连接代理头"><a href="#连接代理头" class="headerlink" title="连接代理头"></a>连接代理头</h3><p>使用此注释将覆盖NGINX设置的默认连接头。要在Ingress规则中使用自定义值，请定义注释：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/connection-proxy-header: &quot;keep-alive&quot;</span><br></pre></td></tr></table></figure>

<h3 id="启用访问日志"><a href="#启用访问日志" class="headerlink" title="启用访问日志"></a>启用访问日志</h3><p>默认情况下，访问日志处于启用状态，但在某些情况下，可能需要针对给定的入口禁用访问日志。为此，请使用注释：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/enable-access-log: &quot;false&quot;</span><br></pre></td></tr></table></figure>

<h3 id="启用重写日志"><a href="#启用重写日志" class="headerlink" title="启用重写日志"></a>启用重写日志</h3><p>默认情况下，未启用重写日志。在某些情况下，可能需要启用NGINX重写日志。请注意，重写日志将在通知级别发送到error_log文件。要启用此功能，请使用注释：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/enable-rewrite-log: &quot;true&quot;</span><br></pre></td></tr></table></figure>

<h3 id="启用开放追踪"><a href="#启用开放追踪" class="headerlink" title="启用开放追踪"></a>启用开放追踪</h3><p>可以通过ConfigMap在全局范围内启用或禁用Opentracing，但是有时需要重写它才能启用它或针对特定入口禁用它（例如，关闭对外部运行状况检查端点的跟踪）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/enable-opentracing: &quot;true&quot;</span><br></pre></td></tr></table></figure>

<h3 id="X转发前缀报头"><a href="#X转发前缀报头" class="headerlink" title="X转发前缀报头"></a>X转发前缀报头</h3><p>要<code>X-Forwarded-Prefix</code>使用字符串值将非标准标头添加到上游请求中，可以使用以下注释：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/x-forwarded-prefix: &quot;/path&quot;</span><br></pre></td></tr></table></figure>

<h3 id="ModSecurity"><a href="#ModSecurity" class="headerlink" title="ModSecurity"></a>ModSecurity</h3><p><a target="_blank" rel="noopener" href="http://modsecurity.org/">ModSecurity</a>是一个开源Web应用程序防火墙。可以为一组特定的入口位置启用它。首先必须通过在<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44692256/article/configmap/#enable-modsecurity">ConfigMap中</a>启用ModSecurity来启用ModSecurity模块 。请注意，这将为所有路径启用ModSecurity，并且必须手动禁用每个路径。</p>
<p>可以使用以下注释启用它：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/enable-modsecurity: &quot;true&quot;</span><br></pre></td></tr></table></figure>

<p>ModSecurity将使用<a target="_blank" rel="noopener" href="https://github.com/SpiderLabs/ModSecurity/blob/v3/master/modsecurity.conf-recommended">推荐的配置</a>以“仅检测”模式<a target="_blank" rel="noopener" href="https://github.com/SpiderLabs/ModSecurity/blob/v3/master/modsecurity.conf-recommended">运行</a>。</p>
<p>您可以通过设置以下注释来启用<a target="_blank" rel="noopener" href="https://www.modsecurity.org/CRS/Documentation/">OWASP核心规则集</a>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/enable-owasp-core-rules: &quot;true&quot;</span><br></pre></td></tr></table></figure>

<p>您可以通过设置以下内容从nginx传递transactionID：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/modsecurity-transaction-id: &quot;$request_id&quot;</span><br></pre></td></tr></table></figure>

<p>您还可以通过代码段添加自己的modsecurity规则集：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/modsecurity-snippet: | SecRuleEngine On SecDebugLog /tmp/modsec_debug.log</span><br></pre></td></tr></table></figure>

<p>注意：如果同时使用<code>enable-owasp-core-rules</code>和和<code>modsecurity-snippet</code>批注，则只有 <code>modsecurity-snippet</code>会生效。如果要包括<a target="_blank" rel="noopener" href="https://www.modsecurity.org/CRS/Documentation/">OWASP核心规则集</a>或 <a target="_blank" rel="noopener" href="https://github.com/SpiderLabs/ModSecurity/blob/v3/master/modsecurity.conf-recommended">建议的配置，</a>只需使用include语句：</p>
<p>nginx 0.24.1及以下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/modsecurity-snippet: | Include /etc/nginx/owasp-modsecurity-crs/nginx-modsecurity.conf Include /etc/nginx/modsecurity/modsecurity.conf</span><br></pre></td></tr></table></figure>

<p>nginx 0.25.0及更高版本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/modsecurity-snippet: | Include /etc/nginx/owasp-modsecurity-crs/nginx-modsecurity.conf</span><br></pre></td></tr></table></figure>

<h3 id="InfluxDB"><a href="#InfluxDB" class="headerlink" title="InfluxDB"></a>InfluxDB</h3><p>使用<code>influxdb-*</code>批注，我们可以使用<a target="_blank" rel="noopener" href="https://github.com/influxdata/nginx-influxdb-module/">nginx-influxdb-module</a>将请求发送到暴露UDP套接字的InfluxDB后端，从而监视通过位置的请求。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/enable-influxdb: &quot;true&quot; nginx.ingress.kubernetes.io/influxdb-measurement: &quot;nginx-reqs&quot; nginx.ingress.kubernetes.io/influxdb-port: &quot;8089&quot; nginx.ingress.kubernetes.io/influxdb-host: &quot;127.0.0.1&quot; nginx.ingress.kubernetes.io/influxdb-server-name: &quot;nginx-ingress&quot;</span><br></pre></td></tr></table></figure>

<p>对于<code>influxdb-host</code>参数，您有两个选择：</p>
<ul>
<li>使用配置为启用<a target="_blank" rel="noopener" href="https://docs.influxdata.com/influxdb/v1.5/supported_protocols/udp/">UDP协议</a>的InfluxDB服务器 。</li>
<li>将Telegraf作为Sidecar代理部署到Ingress控制器，该控制器配置为使用<a target="_blank" rel="noopener" href="https://github.com/influxdata/telegraf/tree/release-1.6/plugins/inputs/socket_listener">套接字侦听器输入</a>侦听UDP，并使用任何<a target="_blank" rel="noopener" href="https://github.com/influxdata/telegraf/tree/release-1.7/plugins/outputs">输出插件（</a>例如InfluxDB，Apache Kafka，Prometheus等）进行写入。（推荐）</li>
</ul>
<p>重要的是要记住，此阶段没有DNS解析器，因此您必须将IP地址配置为<code>nginx.ingress.kubernetes.io/influxdb-host</code>。如果将Influx或Telegraf部署为Sidecar（同一吊舱中的另一个容器），这将变得很简单，因为您可以直接使用<code>127.0.0.1</code>。</p>
<h3 id="后端协议"><a href="#后端协议" class="headerlink" title="后端协议"></a>后端协议</h3><p>使用<code>backend-protocol</code>注释可以指示NGINX应如何与后端服务通信。（<code>secure-backends</code>在旧版本中替换）有效值：HTTP，HTTPS，GRPC，GRPCS和AJP</p>
<p>默认情况下，NGINX使用<code>HTTP</code>。</p>
<p>例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/backend-protocol: &quot;HTTPS&quot;</span><br></pre></td></tr></table></figure>

<h3 id="使用正则表达式"><a href="#使用正则表达式" class="headerlink" title="使用正则表达式"></a>使用正则表达式</h3><p>注意</p>
<p>当将此注释与<code>nginx.ingress.kubernetes.io/affinity</code>类型为NGINX的注释一起使用时<code>cookie</code>， <code>nginx.ingress.kubernetes.io/session-cookie-path</code>还必须设置；会话Cookie路径不支持正则表达式。</p>
<p>使用<code>nginx.ingress.kubernetes.io/use-regex</code>注释将指示Ingress上定义的路径是否使用正则表达式。默认值为<code>false</code>。</p>
<p>下面将指示正在使用正则表达式路径：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/use-regex: &quot;true&quot;</span><br></pre></td></tr></table></figure>

<p>以下内容将指示<strong>未</strong>使用正则表达式路径：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/use-regex: &quot;false&quot;</span><br></pre></td></tr></table></figure>

<p>当此批注设置为时<code>true</code>，不区分大小写的正则表达式<a target="_blank" rel="noopener" href="https://nginx.org/en/docs/http/ngx_http_core_module.html#location">位置修饰符</a>将在给定主机的所有路径上强制执行，无论它们定义在什么Ingress上。</p>
<p>此外，如果在给定主机的任何Ingress上使用了<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44692256/article/details/108581800#rewrite"><code>rewrite-target</code>注释</a>，则不区分大小写的正则表达式<a target="_blank" rel="noopener" href="https://nginx.org/en/docs/http/ngx_http_core_module.html#location">位置修饰符</a>将在给定主机的所有路径上强制执行，无论它们定义在什么Ingress上。</p>
<p>在使用此修饰符之前，请阅读有关<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44692256/ingress-path-matching/">入口路径匹配的信息</a>。</p>
<h3 id="Satisfy"><a href="#Satisfy" class="headerlink" title="Satisfy"></a>Satisfy</h3><p>默认情况下，请求将需要满足所有身份验证要求才能被允许。通过使用此批注，基于配置值，允许满足任何或所有身份验证要求的请求。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/satisfy: &quot;any&quot;</span><br></pre></td></tr></table></figure>

<h3 id="Mirror"><a href="#Mirror" class="headerlink" title="Mirror"></a>Mirror</h3><p>允许将请求镜像到镜像后端。镜像后端的响应将被忽略。此功能很有用，可以查看请求在“测试”后端中的反应。</p>
<p>可以通过以下方式设置镜像后端：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/mirror-target: https://test.env.com/$request_uri</span><br></pre></td></tr></table></figure>

<p>默认情况下，请求正文发送到镜像后端，但可以通过应用以下命令将其关闭：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/mirror-request-body: &quot;off&quot;</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong> mirror指令将应用于入口资源内的所有路径。</p>
<p>发送到镜像的请求链接到原始请求。如果您的镜像后端速度较慢，则原始请求将受到限制。</p>
<p>有关镜像模块的更多信息，请参见<a target="_blank" rel="noopener" href="https://nginx.org/en/docs/http/ngx_http_mirror_module.html">ngx_http_mirror_module</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://wangyyovo.github.io">Blank</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://wangyyovo.github.io/posts/5b4d812a/">https://wangyyovo.github.io/posts/5b4d812a/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://wangyyovo.github.io" target="_blank">Blank</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/k8s/">k8s</a></div><div class="post-share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/common/7ad9570c1892b128f84b9971f7946fc4.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/38d4c25a/" title="Nginx Ingress配置映射ConfigMap"><img class="cover" src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/common/0f2f8f38bdbff3a5f2b97f26b7ce3752.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">Nginx Ingress配置映射ConfigMap</div></div><div class="info-2"><div class="info-item-1"> Nginx Ingress配置映射ConfigMap https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/  通过 Helm 安装 Nginx Ingress 的默认关联配置映射实例名称为 nginx-ingress-controller，用户可以通过修改资源对象 Deployment&#x2F;DaemonSet 实例 nginx-ingress-controller 中的参数 --configmap 自定义关联配置映射实例的名称。 Nginx Ingress 控制器约定 Nginx Ingress 配置映射实例中的键值只能是字符串，即便是数字或布尔值时也要以字符串的形式书写，比如 &quot;true&quot;、&quot;false&quot;、&quot;100&quot;，&quot;[]string&quot; 或 &quot;[]int&quot; 的 Slice 类型则表示内部数据是以 &quot;,&quot; 分隔的字符串。根据配置涉及的功能...</div></div></div></a><a class="pagination-related" href="/posts/4353b432/" title="k8s暴露服务的方式"><img class="cover" src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/common/181a3c44c19e44a7e153e74abee69a73.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">k8s暴露服务的方式</div></div><div class="info-2"><div class="info-item-1"> k8s暴露服务的方式hostNetwork: true这是一种直接定义Pod网络的方式。 如果在Pod中使用hostNetwork:true配置的话，在这种pod中运行的应用程序可以直接看到pod启动的主机的网络接口。在主机的所有网络接口上都可以访问到该应用程序。以下是使用主机网络的pod的示例定义： 123456789apiVersion: v1kind: Podmetadata:  name: influxdbspec:  hostNetwork: true  containers:    - name: influxdb      image: influxdb  部署该Pod： 1$ kubectl create -f influxdb-hostnetwork.yml  访问该pod所在主机的8086端口： 1curl -v http://$POD_IP:8086/ping  将看到204 No Content的204返回码，说明可以正常访问。 注意每次启动这个Pod的时候都可能被调度到不同的节点上，所有外部访问Pod的IP也是变化的，而且调度Pod的时候还需要考虑是否...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/posts/38d4c25a/" title="Nginx Ingress配置映射ConfigMap"><img class="cover" src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/common/0f2f8f38bdbff3a5f2b97f26b7ce3752.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2021-06-10</div><div class="info-item-2">Nginx Ingress配置映射ConfigMap</div></div><div class="info-2"><div class="info-item-1"> Nginx Ingress配置映射ConfigMap https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/  通过 Helm 安装 Nginx Ingress 的默认关联配置映射实例名称为 nginx-ingress-controller，用户可以通过修改资源对象 Deployment&#x2F;DaemonSet 实例 nginx-ingress-controller 中的参数 --configmap 自定义关联配置映射实例的名称。 Nginx Ingress 控制器约定 Nginx Ingress 配置映射实例中的键值只能是字符串，即便是数字或布尔值时也要以字符串的形式书写，比如 &quot;true&quot;、&quot;false&quot;、&quot;100&quot;，&quot;[]string&quot; 或 &quot;[]int&quot; 的 Slice 类型则表示内部数据是以 &quot;,&quot; 分隔的字符串。根据配置涉及的功能...</div></div></div></a><a class="pagination-related" href="/posts/4353b432/" title="k8s暴露服务的方式"><img class="cover" src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/common/181a3c44c19e44a7e153e74abee69a73.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2021-06-04</div><div class="info-item-2">k8s暴露服务的方式</div></div><div class="info-2"><div class="info-item-1"> k8s暴露服务的方式hostNetwork: true这是一种直接定义Pod网络的方式。 如果在Pod中使用hostNetwork:true配置的话，在这种pod中运行的应用程序可以直接看到pod启动的主机的网络接口。在主机的所有网络接口上都可以访问到该应用程序。以下是使用主机网络的pod的示例定义： 123456789apiVersion: v1kind: Podmetadata:  name: influxdbspec:  hostNetwork: true  containers:    - name: influxdb      image: influxdb  部署该Pod： 1$ kubectl create -f influxdb-hostnetwork.yml  访问该pod所在主机的8086端口： 1curl -v http://$POD_IP:8086/ping  将看到204 No Content的204返回码，说明可以正常访问。 注意每次启动这个Pod的时候都可能被调度到不同的节点上，所有外部访问Pod的IP也是变化的，而且调度Pod的时候还需要考虑是否...</div></div></div></a><a class="pagination-related" href="/posts/a4bf172f/" title="k8s集群三种IP"><img class="cover" src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/common/57ee6e1c332782e5197f87bccd943163.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2021-06-03</div><div class="info-item-2">k8s集群三种IP</div></div><div class="info-2"><div class="info-item-1"> k8s集群三种IPKubernetes集群里有三种IP地址，分别如下：  Node IP：Node节点的IP地址，即物理网卡的IP地址。 Pod IP：Pod的IP地址，即docker容器的IP地址，此为虚拟IP地址。 Cluster IP：Service的IP地址，此为虚拟IP地址。  Node IP可以是物理机的IP（也可能是虚拟机IP）。每个Service都会在Node节点上开通一个端口，外部可以通过NodeIP:NodePort即可访问Service里的Pod,和我们访问服务器部署的项目一样，IP:端口&#x2F;项目名 在kubernetes查询Node IP  kubectl get nodes kubectl describe node nodeName 显示出来的InternalIP就是NodeIP  Pod IPPod IP是每个Pod的IP地址，他是Docker Engine根据docker网桥的IP地址段进行分配的，通常是一个虚拟的二层网络  同Service下的pod可以直接根据PodIP相互通信 不同Service下的pod在集群间pod通信要借助于 ...</div></div></div></a><a class="pagination-related" href="/posts/3b3f4264/" title="k8s端口解析"><img class="cover" src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/common/dfa29b427f1ebb18c78bae22446b062d.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2021-06-03</div><div class="info-item-2">k8s端口解析</div></div><div class="info-2"><div class="info-item-1"> k8s端口解析nodePort外部流量访问k8s集群中service入口的一种方式（另一种方式是LoadBalancer），即nodeIP:nodePort是提供给外部流量访问k8s集群中service的入口。比如外部用户要访问k8s集群中的一个Web应用，那么我们可以配置对应service的type&#x3D;NodePort，nodePort&#x3D;30001。其他用户就可以通过浏览器http://node:30001访问到该web服务。而数据库等服务可能不需要被外界访问，只需被内部服务访问即可，那么我们就不必设置service的NodePort。 portk8s集群内部服务之间访问service的入口。即clusterIP:port是service暴露在clusterIP上的端口。mysql容器暴露了3306端口，集群内其他容器通过33306端口访问mysql服务，但是外部流量不能访问mysql服务，因为mysql服务没有配置NodePort。对应的service.yaml如下： 12345678910apiVersion: v1kind: Servicemetada...</div></div></div></a><a class="pagination-related" href="/posts/a7f60f63/" title="ArgoCD持续部署"><img class="cover" src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/common/5.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2021-06-01</div><div class="info-item-2">ArgoCD持续部署</div></div><div class="info-2"><div class="info-item-1"> ArgoCD持续部署Argo CD是用于Kubernetes的声明性GitOps连续交付工具。 Argo CD实现为kubernetes控制器，它持续监视运行中的应用程序，并将当前的活动状态与期望的目标状态进行比较(如Git repo中指定的那样)。如果已部署的应用程序的活动状态偏离了目标状态，则认为是OutOfSync。Argo CD报告和可视化这些差异，同时提供了方法，可以自动或手动将活动状态同步回所需的目标状态。在Git repo中对所需目标状态所做的任何修改都可以自动应用并反映到指定的目标环境中。 安装ArgoCD123456789101112131415161718192021222324kubectl create namespace argocdkubectl delete namespace argocdwget https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml -O argocd.yaml# 修改dev-server镜像 containers:   ...</div></div></div></a><a class="pagination-related" href="/posts/438c4ffb/" title="k8s高可用集群部署"><img class="cover" src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/common/9.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2021-05-31</div><div class="info-item-2">k8s高可用集群部署</div></div><div class="info-2"><div class="info-item-1"> k8s高可用集群部署 https://jimmysong.io/kubernetes-handbook https://kubernetes.feisky.xyz/  https://kubernetes.io/docs/reference/kubernetes-api/workload-resources/ https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/ 环境&amp;介质 虚拟化平台: VMWare Workstation 16 Pro 操作系统: CentOS Linux release 7.9.2009 (Core) 操作用户: root 电脑型号: Lenovo Legion Y7000P 2020H CPU: Intel(R) Core(TM) I7-10750H CPU @2.60HZ RAM: 16G Kubernetes: 1.20.5 Docker: 20.10.5 Flannel: 0.14.0  注: etd&#x2F;coredns等版本信息可以使用命令kubea...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/theme/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Blank</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">356</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">36</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">54</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/wangyyovo" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:xxxxxx@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Nginx-Ingress%E6%B3%A8%E8%A7%A3Annotations"><span class="toc-number">1.</span> <span class="toc-text">Nginx Ingress注解Annotations</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81Nginx%E5%8E%9F%E7%94%9F%E9%85%8D%E7%BD%AE%E6%8C%87%E4%BB%A4"><span class="toc-number">1.1.</span> <span class="toc-text">1、Nginx原生配置指令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E9%80%9A%E7%94%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">1.2.</span> <span class="toc-text">2、通用配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6"><span class="toc-number">1.3.</span> <span class="toc-text">3、访问控制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E8%AE%A4%E8%AF%81%E7%AE%A1%E7%90%86"><span class="toc-number">1.4.</span> <span class="toc-text">4、认证管理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5%E3%80%81%E8%B7%A8%E5%9F%9F%E8%AE%BF%E9%97%AE"><span class="toc-number">1.5.</span> <span class="toc-text">5、跨域访问</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6%E3%80%81%E4%BB%A3%E7%90%86%E9%85%8D%E7%BD%AE"><span class="toc-number">1.6.</span> <span class="toc-text">6、代理配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7%E3%80%81%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">1.7.</span> <span class="toc-text">7、负载均衡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8%E3%80%81%E4%BC%9A%E8%AF%9D%E4%BF%9D%E6%8C%81%E9%85%8D%E7%BD%AE"><span class="toc-number">1.8.</span> <span class="toc-text">8、会话保持配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9%E3%80%81HTTPS%E9%85%8D%E7%BD%AE"><span class="toc-number">1.9.</span> <span class="toc-text">9、HTTPS配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10%E3%80%81%E2%80%9C%E9%87%91%E4%B8%9D%E9%9B%80%E2%80%9D%E5%8F%91%E5%B8%83"><span class="toc-number">1.10.</span> <span class="toc-text">10、“金丝雀”发布</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11%E3%80%81lua-resty-waf%E6%A8%A1%E5%9D%97"><span class="toc-number">1.11.</span> <span class="toc-text">11、lua-resty-waf模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12%E3%80%81ModSecurity%E6%A8%A1%E5%9D%97%E9%85%8D%E7%BD%AE"><span class="toc-number">1.12.</span> <span class="toc-text">12、ModSecurity模块配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13%E3%80%81Influxdb%E6%A8%A1%E5%9D%97%E9%85%8D%E7%BD%AE"><span class="toc-number">1.13.</span> <span class="toc-text">13、Influxdb模块配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%B4%E6%98%8E"><span class="toc-number">1.14.</span> <span class="toc-text">说明</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%91%E4%B8%9D%E9%9B%80"><span class="toc-number">1.14.1.</span> <span class="toc-text">金丝雀</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Rewrite"><span class="toc-number">1.14.2.</span> <span class="toc-text">Rewrite</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Session-Affinity"><span class="toc-number">1.14.3.</span> <span class="toc-text">Session Affinity</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Cookie-Affinity"><span class="toc-number">1.14.3.1.</span> <span class="toc-text">Cookie Affinity</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81%E6%96%B9%E5%BC%8F"><span class="toc-number">1.14.4.</span> <span class="toc-text">认证方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89NGINX%E4%B8%8A%E6%B8%B8%E5%93%88%E5%B8%8C"><span class="toc-number">1.14.5.</span> <span class="toc-text">自定义NGINX上游哈希</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89NGINX%E8%B4%9F%E8%BD%BD%E5%B9%B3%E8%A1%A1"><span class="toc-number">1.14.6.</span> <span class="toc-text">自定义NGINX负载平衡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89NGINX%E4%B8%8A%E6%B8%B8%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA"><span class="toc-number">1.14.7.</span> <span class="toc-text">自定义NGINX上游虚拟主机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AF%81%E4%B9%A6%E8%AE%A4%E8%AF%81"><span class="toc-number">1.14.8.</span> <span class="toc-text">客户端证书认证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8E%E7%AB%AF%E8%AF%81%E4%B9%A6%E8%AE%A4%E8%AF%81"><span class="toc-number">1.14.9.</span> <span class="toc-text">后端证书认证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%89%87%E6%AE%B5"><span class="toc-number">1.14.10.</span> <span class="toc-text">配置片段</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89HTTP%E9%94%99%E8%AF%AF"><span class="toc-number">1.14.11.</span> <span class="toc-text">自定义HTTP错误</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%BB%98%E8%AE%A4%E5%90%8E%E7%AB%AF"><span class="toc-number">1.14.12.</span> <span class="toc-text">默认后端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E7%94%A8CORS"><span class="toc-number">1.14.13.</span> <span class="toc-text">启用CORS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTP2%E6%8E%A8%E9%80%81%E9%A2%84%E5%8A%A0%E8%BD%BD%E3%80%82"><span class="toc-number">1.14.14.</span> <span class="toc-text">HTTP2推送预加载。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%88%AB%E5%90%8D"><span class="toc-number">1.14.15.</span> <span class="toc-text">服务器别名</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Server-Snippet%E6%AE%B5"><span class="toc-number">1.14.16.</span> <span class="toc-text">Server Snippet段</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%B8%BB%E4%BD%93%E7%BC%93%E5%86%B2%E5%8C%BA%E5%A4%A7%E5%B0%8F"><span class="toc-number">1.14.17.</span> <span class="toc-text">客户端主体缓冲区大小</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%96%E9%83%A8%E8%AE%A4%E8%AF%81"><span class="toc-number">1.14.18.</span> <span class="toc-text">外部认证</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E5%A4%96%E9%83%A8%E8%AE%A4%E8%AF%81"><span class="toc-number">1.14.18.1.</span> <span class="toc-text">全局外部认证</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%99%90%E9%80%9F"><span class="toc-number">1.14.19.</span> <span class="toc-text">限速</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B0%B8%E4%B9%85%E9%87%8D%E5%AE%9A%E5%90%91"><span class="toc-number">1.14.20.</span> <span class="toc-text">永久重定向</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B0%B8%E4%B9%85%E9%87%8D%E5%AE%9A%E5%90%91%E7%A0%81"><span class="toc-number">1.14.21.</span> <span class="toc-text">永久重定向码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Temporal-Redirect"><span class="toc-number">1.14.22.</span> <span class="toc-text">Temporal Redirect</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SSL%E7%9B%B4%E9%80%9A"><span class="toc-number">1.14.23.</span> <span class="toc-text">SSL直通</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Service-Upstream"><span class="toc-number">1.14.24.</span> <span class="toc-text">Service Upstream</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B7%B2%E7%9F%A5%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">1.14.24.1.</span> <span class="toc-text">已知的问题</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E9%87%8D%E5%AE%9A%E5%90%91%E6%89%A7%E8%A1%8C%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AFHTTPS"><span class="toc-number">1.14.25.</span> <span class="toc-text">通过重定向执行服务器端HTTPS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8E-x2F-%E9%87%8D%E5%AE%9A%E5%90%91%E5%88%B0www"><span class="toc-number">1.14.26.</span> <span class="toc-text">从&#x2F;重定向到www</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%99%BD%E5%90%8D%E5%8D%95%E6%9D%A5%E6%BA%90%E8%8C%83%E5%9B%B4"><span class="toc-number">1.14.27.</span> <span class="toc-text">白名单来源范围</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%B6%85%E6%97%B6"><span class="toc-number">1.14.28.</span> <span class="toc-text">自定义超时</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%90%86%E9%87%8D%E5%AE%9A%E5%90%91"><span class="toc-number">1.14.29.</span> <span class="toc-text">代理重定向</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Custom-max-body-size"><span class="toc-number">1.14.30.</span> <span class="toc-text">Custom max body size</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%90%86Cookie%E5%9F%9F"><span class="toc-number">1.14.31.</span> <span class="toc-text">代理Cookie域</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%90%86Cookie%E8%B7%AF%E5%BE%84"><span class="toc-number">1.14.32.</span> <span class="toc-text">代理Cookie路径</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%90%86%E7%BC%93%E5%86%B2"><span class="toc-number">1.14.33.</span> <span class="toc-text">代理缓冲</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%90%86%E7%BC%93%E5%86%B2%E5%8C%BA%E6%95%B0"><span class="toc-number">1.14.34.</span> <span class="toc-text">代理缓冲区数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%90%86%E7%BC%93%E5%86%B2%E5%8C%BA%E5%A4%A7%E5%B0%8F"><span class="toc-number">1.14.35.</span> <span class="toc-text">代理缓冲区大小</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%90%86%E6%9C%80%E5%A4%A7%E4%B8%B4%E6%97%B6%E6%96%87%E4%BB%B6%E5%A4%A7%E5%B0%8F"><span class="toc-number">1.14.36.</span> <span class="toc-text">代理最大临时文件大小</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%90%86HTTP%E7%89%88%E6%9C%AC"><span class="toc-number">1.14.37.</span> <span class="toc-text">代理HTTP版本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SSL%E5%AF%86%E7%A0%81"><span class="toc-number">1.14.38.</span> <span class="toc-text">SSL密码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E4%BB%A3%E7%90%86%E5%A4%B4"><span class="toc-number">1.14.39.</span> <span class="toc-text">连接代理头</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E7%94%A8%E8%AE%BF%E9%97%AE%E6%97%A5%E5%BF%97"><span class="toc-number">1.14.40.</span> <span class="toc-text">启用访问日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E7%94%A8%E9%87%8D%E5%86%99%E6%97%A5%E5%BF%97"><span class="toc-number">1.14.41.</span> <span class="toc-text">启用重写日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E7%94%A8%E5%BC%80%E6%94%BE%E8%BF%BD%E8%B8%AA"><span class="toc-number">1.14.42.</span> <span class="toc-text">启用开放追踪</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#X%E8%BD%AC%E5%8F%91%E5%89%8D%E7%BC%80%E6%8A%A5%E5%A4%B4"><span class="toc-number">1.14.43.</span> <span class="toc-text">X转发前缀报头</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ModSecurity"><span class="toc-number">1.14.44.</span> <span class="toc-text">ModSecurity</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#InfluxDB"><span class="toc-number">1.14.45.</span> <span class="toc-text">InfluxDB</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8E%E7%AB%AF%E5%8D%8F%E8%AE%AE"><span class="toc-number">1.14.46.</span> <span class="toc-text">后端协议</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-number">1.14.47.</span> <span class="toc-text">使用正则表达式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Satisfy"><span class="toc-number">1.14.48.</span> <span class="toc-text">Satisfy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Mirror"><span class="toc-number">1.14.49.</span> <span class="toc-text">Mirror</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/d14168d/" title="虚拟机问题合集"><img src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/hexo/090cfe4e9e60b0ad0de05db822f3ae97.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="虚拟机问题合集"/></a><div class="content"><a class="title" href="/posts/d14168d/" title="虚拟机问题合集">虚拟机问题合集</a><time datetime="2022-07-16T13:30:36.000Z" title="发表于 2022-07-16 21:30:36">2022-07-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/f540045f/" title="用go语言编写移动端sdk和app开发"><img src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/golang/941ed1ec2925719a0c92e76f4f786b6a.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="用go语言编写移动端sdk和app开发"/></a><div class="content"><a class="title" href="/posts/f540045f/" title="用go语言编写移动端sdk和app开发">用go语言编写移动端sdk和app开发</a><time datetime="2022-07-04T12:14:21.000Z" title="发表于 2022-07-04 20:14:21">2022-07-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/5faac006/" title="在线编程IDE"><img src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/hexo/090cfe4e9e60b0ad0de05db822f3ae97.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="在线编程IDE"/></a><div class="content"><a class="title" href="/posts/5faac006/" title="在线编程IDE">在线编程IDE</a><time datetime="2022-06-12T13:30:36.000Z" title="发表于 2022-06-12 21:30:36">2022-06-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/7594185d/" title="即时性能分析工具Pyroscope"><img src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/golang/3bfb3279740bc9a5b5ef436fa887ef07.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="即时性能分析工具Pyroscope"/></a><div class="content"><a class="title" href="/posts/7594185d/" title="即时性能分析工具Pyroscope">即时性能分析工具Pyroscope</a><time datetime="2022-06-12T08:07:36.000Z" title="发表于 2022-06-12 16:07:36">2022-06-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/82a7aa7c/" title="golang性能调试优化方法"><img src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/common/3.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="golang性能调试优化方法"/></a><div class="content"><a class="title" href="/posts/82a7aa7c/" title="golang性能调试优化方法">golang性能调试优化方法</a><time datetime="2022-06-12T03:00:36.000Z" title="发表于 2022-06-12 11:00:36">2022-06-12</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 By Blank</span><span class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 5.4.2</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.4.3</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>