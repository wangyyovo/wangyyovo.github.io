<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Nginx Ingressæ³¨è§£Annotations | Blank</title><meta name="keywords" content="k8s"><meta name="author" content="Blank"><meta name="copyright" content="Blank"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Nginx Ingressæ³¨è§£Annotations https:&#x2F;&#x2F;kubernetes.github.io&#x2F;ingress-nginx&#x2F;user-guide&#x2F;nginx-configuration&#x2F;annotations&#x2F;  Nginx Ingress æ³¨è§£ä½¿ç”¨åœ¨ Ingress èµ„æºå®ä¾‹ä¸­ï¼Œç”¨ä»¥è®¾ç½®å½“å‰ Ingress èµ„æºå®ä¾‹ä¸­ Nginx è™šæ‹Ÿä¸»æœºçš„ç›¸å…³é…ç½®ï¼Œå¯¹åº”é…ç½®çš„æ˜¯ Nginx">
<meta property="og:type" content="article">
<meta property="og:title" content="Nginx Ingressæ³¨è§£Annotations">
<meta property="og:url" content="https://wangyyovo.github.io/posts/5b4d812a/">
<meta property="og:site_name" content="Blank">
<meta property="og:description" content="Nginx Ingressæ³¨è§£Annotations https:&#x2F;&#x2F;kubernetes.github.io&#x2F;ingress-nginx&#x2F;user-guide&#x2F;nginx-configuration&#x2F;annotations&#x2F;  Nginx Ingress æ³¨è§£ä½¿ç”¨åœ¨ Ingress èµ„æºå®ä¾‹ä¸­ï¼Œç”¨ä»¥è®¾ç½®å½“å‰ Ingress èµ„æºå®ä¾‹ä¸­ Nginx è™šæ‹Ÿä¸»æœºçš„ç›¸å…³é…ç½®ï¼Œå¯¹åº”é…ç½®çš„æ˜¯ Nginx">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontents.com/wangyyovo/CDN/master/cover/common/7ad9570c1892b128f84b9971f7946fc4.jpg">
<meta property="article:published_time" content="2021-06-10T13:59:44.000Z">
<meta property="article:modified_time" content="2021-06-10T13:59:44.000Z">
<meta property="article:author" content="Blank">
<meta property="article:tag" content="k8s">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontents.com/wangyyovo/CDN/master/cover/common/7ad9570c1892b128f84b9971f7946fc4.jpg"><link rel="shortcut icon" href="https://raw.githubusercontents.com/wangyyovo/CDN/master/theme/favicon.ico"><link rel="canonical" href="https://wangyyovo.github.io/posts/5b4d812a/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹ï¼š${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"ç¹","msgToSimplifiedChinese":"ç°¡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: 'å¤©',
  date_suffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: undefined,
  lightbox: 'mediumZoom',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Nginx Ingressæ³¨è§£Annotations',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-06-10 21:59:44'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="alternate" href="/atom.xml" title="Blank" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://raw.githubusercontents.com/wangyyovo/CDN/master/theme/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">356</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">36</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">54</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> ä¸»é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> æ—¶é—´è½´</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡ç­¾</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> åˆ†ç±»</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> å‹é“¾</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fas fa-coffee"></i><span> ç•™è¨€æ¿</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> å…³äº</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> å¨±ä¹</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> éŸ³ä¹</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> ç”µå½±</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-image"></i><span> ç›¸å†Œ</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-book"></i><span> æ•™ç¨‹</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/posts/21cfbf15/"><span> ğŸš€ å¿«é€Ÿé–‹å§‹</span></a></li><li><a class="site-page child" href="/posts/dc584b87/"><span> ğŸ“‘ ä¸»é¡Œé é¢</span></a></li><li><a class="site-page child" href="/posts/4aa8abbe/"><span> ğŸ›  ä¸»é¡Œé…ç½®-1</span></a></li><li><a class="site-page child" href="/posts/ceeb73f/"><span> âš”ï¸ ä¸»é¡Œé…ç½®-2</span></a></li><li><a class="site-page child" href="/posts/98d20436/"><span> â“ ä¸»é¡Œå•ç­”</span></a></li><li><a class="site-page child" href="/posts/4073eda/"><span> âš¡ï¸ é€²éšæ•™ç¨‹</span></a></li><li><a class="site-page child" href="/posts/198a4240/"><span> âœ¨ æ›´æ–°æ—¥èªŒ</span></a></li><li><a class="site-page child" href="/posts/507c070f/"><span> ğŸ“‘ Aplayeræ•™ç¨‹</span></a></li><li><a class="site-page child" href="/posts/2df239ce/"><span> ğŸ“‘ æ¨™ç±¤å¤–æ›</span></a></li><li><a class="site-page child" href="/posts/b37b5fe3/"><span> ğŸ“‘ è‡ªå®šç¾©ä»£ç¢¼é…è‰²</span></a></li><li><a class="site-page child" href="/posts/ea33ab97/"><span> ğŸ“‘ è‡ªå®šç¾©å´é‚Šæ¬„</span></a></li><li><a class="site-page child" href="/posts/89757140/"><span> ğŸ“‘ Markdown</span></a></li><li><a class="site-page child" href="/posts/9db656e5/"><span> ğŸ“‘ ä»£ç é«˜äº®æµ‹è¯•</span></a></li><li><a class="site-page child" href="/posts/c9711c19/"><span> ğŸ“‘ ç•¶è¨­ç½®top_imgç‚ºfalseæ™‚</span></a></li><li><a class="site-page child" href="/posts/39b121ef/"><span> ğŸ“‘ Hexoå…§ç½®æ¨™ç±¤å¤–æ›</span></a></li><li><a class="site-page child" href="/posts/7670b080/"><span> ğŸ“‘ Butterfly ç¾åŒ–/å„ªåŒ–/é­”æ”¹ æ•™ç¨‹åˆé›†</span></a></li><li><a class="site-page child" href="/posts/913b2502/"><span> ğŸ“‘ æ²¡æœ‰å°é¢</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://raw.githubusercontents.com/wangyyovo/CDN/master/cover/common/7ad9570c1892b128f84b9971f7946fc4.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Blank</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> æœç´¢</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> ä¸»é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> æ—¶é—´è½´</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡ç­¾</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> åˆ†ç±»</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> å‹é“¾</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fas fa-coffee"></i><span> ç•™è¨€æ¿</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> å…³äº</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> å¨±ä¹</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> éŸ³ä¹</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> ç”µå½±</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-image"></i><span> ç›¸å†Œ</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-book"></i><span> æ•™ç¨‹</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/posts/21cfbf15/"><span> ğŸš€ å¿«é€Ÿé–‹å§‹</span></a></li><li><a class="site-page child" href="/posts/dc584b87/"><span> ğŸ“‘ ä¸»é¡Œé é¢</span></a></li><li><a class="site-page child" href="/posts/4aa8abbe/"><span> ğŸ›  ä¸»é¡Œé…ç½®-1</span></a></li><li><a class="site-page child" href="/posts/ceeb73f/"><span> âš”ï¸ ä¸»é¡Œé…ç½®-2</span></a></li><li><a class="site-page child" href="/posts/98d20436/"><span> â“ ä¸»é¡Œå•ç­”</span></a></li><li><a class="site-page child" href="/posts/4073eda/"><span> âš¡ï¸ é€²éšæ•™ç¨‹</span></a></li><li><a class="site-page child" href="/posts/198a4240/"><span> âœ¨ æ›´æ–°æ—¥èªŒ</span></a></li><li><a class="site-page child" href="/posts/507c070f/"><span> ğŸ“‘ Aplayeræ•™ç¨‹</span></a></li><li><a class="site-page child" href="/posts/2df239ce/"><span> ğŸ“‘ æ¨™ç±¤å¤–æ›</span></a></li><li><a class="site-page child" href="/posts/b37b5fe3/"><span> ğŸ“‘ è‡ªå®šç¾©ä»£ç¢¼é…è‰²</span></a></li><li><a class="site-page child" href="/posts/ea33ab97/"><span> ğŸ“‘ è‡ªå®šç¾©å´é‚Šæ¬„</span></a></li><li><a class="site-page child" href="/posts/89757140/"><span> ğŸ“‘ Markdown</span></a></li><li><a class="site-page child" href="/posts/9db656e5/"><span> ğŸ“‘ ä»£ç é«˜äº®æµ‹è¯•</span></a></li><li><a class="site-page child" href="/posts/c9711c19/"><span> ğŸ“‘ ç•¶è¨­ç½®top_imgç‚ºfalseæ™‚</span></a></li><li><a class="site-page child" href="/posts/39b121ef/"><span> ğŸ“‘ Hexoå…§ç½®æ¨™ç±¤å¤–æ›</span></a></li><li><a class="site-page child" href="/posts/7670b080/"><span> ğŸ“‘ Butterfly ç¾åŒ–/å„ªåŒ–/é­”æ”¹ æ•™ç¨‹åˆé›†</span></a></li><li><a class="site-page child" href="/posts/913b2502/"><span> ğŸ“‘ æ²¡æœ‰å°é¢</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Nginx Ingressæ³¨è§£Annotations</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2021-06-10T13:59:44.000Z" title="å‘è¡¨äº 2021-06-10 21:59:44">2021-06-10</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2021-06-10T13:59:44.000Z" title="æ›´æ–°äº 2021-06-10 21:59:44">2021-06-10</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/microservice/">microservice</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/microservice/k8s/">k8s</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">å­—æ•°æ€»è®¡:</span><span class="word-count">14k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»æ—¶é•¿:</span><span>53åˆ†é’Ÿ</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Nginx Ingressæ³¨è§£Annotations"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»é‡:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><script src="\assets\js\APlayer.min.js"> </script><h1 id="Nginx-Ingressæ³¨è§£Annotations"><a href="#Nginx-Ingressæ³¨è§£Annotations" class="headerlink" title="Nginx Ingressæ³¨è§£Annotations"></a>Nginx Ingressæ³¨è§£Annotations</h1><blockquote>
<p><a target="_blank" rel="noopener" href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/">https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/</a></p>
</blockquote>
<p>Nginx Ingress æ³¨è§£ä½¿ç”¨åœ¨ Ingress èµ„æºå®ä¾‹ä¸­ï¼Œç”¨ä»¥è®¾ç½®å½“å‰ Ingress èµ„æºå®ä¾‹ä¸­ Nginx è™šæ‹Ÿä¸»æœºçš„ç›¸å…³é…ç½®ï¼Œå¯¹åº”é…ç½®çš„æ˜¯ Nginx å½“å‰è™šæ‹Ÿä¸»æœºçš„ server æŒ‡ä»¤åŸŸå†…å®¹ã€‚åœ¨ä¸ Nginx Ingress é…ç½®æ˜ å°„å…·æœ‰ç›¸åŒåŠŸèƒ½é…ç½®æ—¶ï¼Œå°†æŒ‰ç…§æ‰€åœ¨æŒ‡ä»¤åŸŸå±‚çº§éµå¾ª Nginx é…ç½®è§„åˆ™è¦†ç›–ã€‚</p>
<p>Nginx Ingressæ³¨è§£æŒ‰ç…§é…ç½®åŠŸèƒ½æœ‰å¦‚ä¸‹åˆ†ç±»ã€‚</p>
<h2 id="1ã€NginxåŸç”Ÿé…ç½®æŒ‡ä»¤"><a href="#1ã€NginxåŸç”Ÿé…ç½®æŒ‡ä»¤" class="headerlink" title="1ã€NginxåŸç”Ÿé…ç½®æŒ‡ä»¤"></a>1ã€NginxåŸç”Ÿé…ç½®æŒ‡ä»¤</h2><p>æ”¯æŒåœ¨æ³¨è§£ä¸­æ·»åŠ  Nginx åŸç”Ÿé…ç½®æŒ‡ä»¤ã€‚é…ç½®è¯´æ˜å¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚</p>
<table>
<thead>
<tr>
<th>æ³¨è§£</th>
<th>ç±»å‹</th>
<th>åŠŸèƒ½æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>nginx.ingress.kubernetes.io&#x2F;server-snippet</td>
<td>string</td>
<td>åœ¨ server æŒ‡ä»¤åŸŸæ·»åŠ  Nginx é…ç½®æŒ‡ä»¤</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;configuration-snippet</td>
<td>string</td>
<td>åœ¨ location æŒ‡ä»¤åŸŸæ·»åŠ  Nginx é…ç½®æŒ‡ä»¤</td>
</tr>
</tbody></table>
<p>é…ç½®æ ·ä¾‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">web-nginxbar-org</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/server-snippet:</span> <span class="string">|</span></span><br><span class="line"><span class="string">            location / &#123;</span></span><br><span class="line"><span class="string">                return 302 /coffee;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string"></span><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">web.nginxbar.org</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">            <span class="attr">paths:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/tea</span></span><br><span class="line">              <span class="attr">backend:</span></span><br><span class="line">                  <span class="attr">serviceName:</span> <span class="string">tea-svc</span></span><br><span class="line">                  <span class="attr">servicePort:</span> <span class="number">80</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/coffee</span></span><br><span class="line">            <span class="attr">backend:</span></span><br><span class="line">                <span class="attr">serviceName:</span> <span class="string">coffee-svc</span></span><br><span class="line">                <span class="attr">servicePort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<h2 id="2ã€é€šç”¨é…ç½®"><a href="#2ã€é€šç”¨é…ç½®" class="headerlink" title="2ã€é€šç”¨é…ç½®"></a>2ã€é€šç”¨é…ç½®</h2><p>Nginx è™šæ‹Ÿä¸»æœºä¸­çš„é€šç”¨é…ç½®ã€‚é€šç”¨é…ç½®è¯´æ˜å¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚</p>
<table>
<thead>
<tr>
<th>æ³¨è§£</th>
<th>ç±»å‹</th>
<th>åŠŸèƒ½æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>nginx.ingress.kubernetes.io&#x2F;enable-access-log</td>
<td>true æˆ– false</td>
<td>å¯¹å½“å‰è™šæ‹Ÿä¸»æœºè®¾ç½®æ˜¯å¦å¯ç”¨è®¿é—®æ—¥å¿—ï¼Œé»˜è®¤ä¸ºçœŸ</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;server-alias</td>
<td>string</td>
<td>ä¸º Nginx æ·»åŠ æ›´å¤šçš„ä¸»æœºåï¼ŒåŒ Nginx é…ç½®æŒ‡ä»¤ server name</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;app-root</td>
<td>string</td>
<td>å°†å½“å‰è™šæ‹Ÿä¸»æœºæ ¹ç›®å½•çš„è®¿é—® 302 è·³è½¬åˆ°å½“å‰æŒ‡å®šçš„è·¯å¾„</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;client-body-buffer-size</td>
<td>string</td>
<td>åŒ Nginx é…ç½®æŒ‡ä»¤ client_body_buffer_size</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;use-regex</td>
<td>true æˆ– false</td>
<td>æ˜¯å¦å¯¹å½“å‰è™šæ‹Ÿä¸»æœºçš„ Nginx æŒ‡ä»¤ location ä½¿ç”¨æ­£åˆ™æ–¹å¼è¿›è¡Œè·¯å¾„åŒ¹é…ï¼Œé»˜è®¤å€¼ä¸º false</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;custom-http-errors</td>
<td>[]int</td>
<td>æ ¹æ®å“åº”ç çŠ¶æ€å®šä¹‰ä¸ºé”™è¯¯çŠ¶æ€å¹¶è·³è½¬åˆ°è®¾ç½®çš„é»˜è®¤åç«¯</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;default-backend</td>
<td>string</td>
<td>è‡ªå®šä¹‰é»˜è®¤åç«¯çš„èµ„æºå¯¹è±¡ Service åç§°ï¼Œå½“å®¢æˆ·ç«¯çš„è¯·æ±‚æ²¡æœ‰åŒ¹é…çš„ Nginx è§„åˆ™æˆ–å“åº”é”™è¯¯æ—¶ï¼Œå°†è¢«è½¬å‘åˆ°é»˜è®¤åç«¯</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;whitelist-source-range</td>
<td>CIDR</td>
<td>åŠŸèƒ½åŒ ConfigMap é…ç½®é”® whitelist-source-range</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;permanent-redirect</td>
<td>string</td>
<td>è®¾ç½®æ°¸ä¹…é‡å®šå‘çš„ç›®æ ‡åœ°å€</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;permanent-redirect-code</td>
<td>number</td>
<td>è‡ªå®šä¹‰æ°¸ä¹…é‡å®šå‘çš„å“åº”ç ï¼Œé»˜è®¤ä¸º 301</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;temporal-redirect</td>
<td>string</td>
<td>è®¾ç½®ä¸´æ—¶é‡å®šå‘çš„ç›®æ ‡åœ°å€</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;from-to-www-redirect</td>
<td>true æˆ– false</td>
<td>è®¾ç½®æ˜¯å¦å°†å½“å‰è™šæ‹Ÿä¸»æœºå­åŸŸåä¸º www çš„è¯·æ±‚è·³è½¬åˆ°å½“å‰ä¸»æœºåŸŸå</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;rewrite-target</td>
<td>URI</td>
<td>åŒ Nginx é…ç½®æŒ‡ä»¤ rewrite</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;enable-rewrite-log</td>
<td>true æˆ– false</td>
<td>åŒ Nginx é…ç½®æŒ‡ä»¤ rewrite logï¼Œé»˜è®¤ä¸º false</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;mirror-uri</td>
<td>string</td>
<td>åŒ Nginx é…ç½®æŒ‡ä»¤ mirro</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;mirror-request-body</td>
<td>true æˆ– false</td>
<td>åŒ Nginx é…ç½®æŒ‡ä»¤ mirror_request_bodyï¼Œé»˜è®¤ä¸º true</td>
</tr>
</tbody></table>
<p>é…ç½®æ ·ä¾‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">web-nginxbar-org</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/rewrite-target:</span> <span class="string">/tea/$1</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/enable-rewrite-log:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">web.nginxbar.org</span>   <span class="comment"># æ­¤serviceçš„è®¿é—®åŸŸå</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">            <span class="attr">serviceName:</span> <span class="string">nginx-web</span></span><br><span class="line">            <span class="attr">servicePort:</span> <span class="number">8080</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/coffee/(.+)</span></span><br></pre></td></tr></table></figure>

<h2 id="3ã€è®¿é—®æ§åˆ¶"><a href="#3ã€è®¿é—®æ§åˆ¶" class="headerlink" title="3ã€è®¿é—®æ§åˆ¶"></a>3ã€è®¿é—®æ§åˆ¶</h2><p>ç”¨ä»¥è®¾ç½®åŸºäºæµé‡ã€è¯·æ±‚è¿æ¥æ•°ã€è¯·æ±‚é¢‘ç‡çš„è®¿é—®æ§åˆ¶ã€‚è®¿é—®æ§åˆ¶é…ç½®è¯´æ˜å¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚</p>
<table>
<thead>
<tr>
<th>æ³¨è§£</th>
<th>ç±»å‹&#x2F;é€‰é¡¹</th>
<th>åŠŸèƒ½æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>nginx.ingress.kubernetes.io&#x2F;limit-rate</td>
<td>number</td>
<td>è®¿é—®æµé‡é€Ÿåº¦é™åˆ¶ï¼ŒåŒ Nginx é…ç½®æŒ‡ä»¤ limit_rate</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;limit-rate-after</td>
<td>number</td>
<td>å¯ç”¨è®¿é—®æµé‡é€Ÿåº¦é™åˆ¶çš„æœ€å¤§å€¼ï¼ŒåŒ Nginx é…ç½®æŒ‡ä»¤ limit_rate_after</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;limit-connections</td>
<td>number</td>
<td>èŠ‚å¹¶å‘è¿æ¥æ•°é™åˆ¶ï¼ŒåŒ Nginx é…ç½®æŒ‡ä»¤ limit_conn</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;limit-rps</td>
<td>number</td>
<td>æ¯ç§’è¯·æ±‚é¢‘ç‡é™åˆ¶ï¼Œburst å‚æ•°ä¸ºç»™å®šå€¼çš„ 5 å€ï¼Œå“åº”çŠ¶æ€ç ç”± ConfigMap çš„ limit-req-status-code è®¾å®š</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;limit-rpm</td>
<td>number</td>
<td>æ¯åˆ†é’Ÿè¯·æ±‚é¢‘ç‡é™åˆ¶ï¼Œburst å‚æ•°ä¸ºç»™å®šå€¼çš„ 5 å€ï¼Œå“åº”çŠ¶æ€ç ç”± ConfigMap çš„ limit-req-status-code è®¾å®š</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;limit-whitelist</td>
<td>CIDR</td>
<td>å¯¹ä»¥ä¸Šé™åˆ¶è®¾ç½®åŸºäº IP çš„ç™½åå•</td>
</tr>
</tbody></table>
<h2 id="4ã€è®¤è¯ç®¡ç†"><a href="#4ã€è®¤è¯ç®¡ç†" class="headerlink" title="4ã€è®¤è¯ç®¡ç†"></a>4ã€è®¤è¯ç®¡ç†</h2><p>Nginx Ingress æä¾›äº†åŸºæœ¬è®¤è¯ã€æ‘˜è¦è®¤è¯å’Œå¤–éƒ¨è®¤è¯ 3 ç§æ–¹å¼ï¼Œä¸ºè¢«ä»£ç†æœåŠ¡å™¨æä¾›è®¤è¯æ”¯æŒã€‚è®¤è¯ç®¡ç†é…ç½®è¯´æ˜å¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚</p>
<table>
<thead>
<tr>
<th>æ³¨è§£</th>
<th>ç±»å‹</th>
<th>åŠŸèƒ½æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>nginx.ingress.kubernetes.io&#x2F;enable-global-auth</td>
<td>true æˆ– false</td>
<td>å¦‚æœ ConfigMap çš„ global-auth-url è¢«è®¾ç½®ï¼ŒNginx ä¼šå°†æ‰€æœ‰çš„è¯·æ±‚é‡å®šå‘åˆ°æä¾›èº«ä»½éªŒè¯çš„ URLï¼Œé»˜è®¤ä¸º true</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;satisfy</td>
<td>string</td>
<td>åŒ Nginx é…ç½®æŒ‡ä»¤ satisfy</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;auth-type</td>
<td>basic æˆ– digest</td>
<td>è®¾ç½® HTTP è®¤è¯ç±»å‹ï¼Œæ”¯æŒåŸºæœ¬å’Œæ‘˜è¦ä¸¤ç§ç±»å‹</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;auth-secret</td>
<td>string</td>
<td>æŒ‡å®šå…³è”èµ„æºå¯¹è±¡ secret çš„åç§°</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;auth-realm</td>
<td>string</td>
<td>è®¾ç½®åŸºæœ¬è®¤è¯çš„æç¤ºä¿¡æ¯ auth_basic</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;auth-url</td>
<td>string</td>
<td>è®¾ç½®æä¾›å¤–éƒ¨èº«ä»½è®¤è¯çš„ URLï¼Œç”± Nginx é…ç½®æŒ‡ä»¤ auth_request æä¾›è¯¥åŠŸèƒ½</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;auth-signin</td>
<td>string</td>
<td>è®¾ç½®å½“å¤–éƒ¨è®¤è¯è¿”å› 401 æ—¶è·³è½¬çš„ URLï¼Œé€šå¸¸ä¸ºæç¤ºè¾“å…¥ç”¨æˆ·åå’Œå¯†ç çš„ URL</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;auth-method</td>
<td>string</td>
<td>æŒ‡å®šè®¿é—®å¤–éƒ¨è®¤è¯ URL çš„ HTTP æ–¹æ³•ï¼Œç”± Nginx é…ç½®æŒ‡ä»¤ proxy_method æä¾›è¯¥åŠŸèƒ½</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;auth-request-redirect</td>
<td>string</td>
<td>è®¾ç½®å‘é€ç»™è®¤è¯æœåŠ¡å™¨è¯·æ±‚å¤´ä¸­ X-Auth-Request-Redirect çš„å€¼</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;auth-cache-key</td>
<td>string</td>
<td>å¯ç”¨è®¤è¯ç¼“å­˜ï¼Œå¹¶è®¾ç½®è®¤è¯ç¼“å­˜çš„å…³é”®å­—</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;auth-cache-duration</td>
<td>string</td>
<td>åŸºäºå“åº”ç è®¾ç½®è®¤è¯ç¼“å­˜çš„æœ‰æ•ˆæ—¶é—´</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;auth-response-headers</td>
<td>string</td>
<td>è®¾ç½®è®¤è¯è¯·æ±‚å®Œæˆåä¼ é€’åˆ°çœŸå®åç«¯çš„å¤´ä¿¡æ¯</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;auth-snippet</td>
<td>string</td>
<td>å¯ä»¥è‡ªå®šä¹‰åœ¨å¤–éƒ¨è®¤è¯æŒ‡ä»¤åŒºåŸŸæ·»åŠ  Nginx é…ç½®æŒ‡ä»¤</td>
</tr>
</tbody></table>
<p>åŸºæœ¬è®¤è¯é…ç½®å¦‚ä¸‹ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºåŸºæœ¬è®¤è¯ç”¨æˆ·ånginxbarã€å¯†ç 123456ï¼Œè¾“å‡ºæ–‡ä»¶åå¿…é¡»æ˜¯auth</span></span><br><span class="line"><span class="string">htpasswd</span> <span class="string">-bc</span> <span class="string">auth</span> <span class="string">nginxbar</span> <span class="number">123456</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºèµ„æºå¯¹è±¡secretä¿å­˜è´¦å·å’Œå¯†ç </span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">create</span> <span class="string">secret</span> <span class="string">generic</span> <span class="string">basic-auth</span> <span class="string">--from-file=auth</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹åˆ›å»ºçš„basic-auth</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">secret</span> <span class="string">basic-auth</span> <span class="string">-o</span> <span class="string">yaml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºåŸºæœ¬è®¤è¯çš„Ingresså®ä¾‹</span></span><br><span class="line"><span class="string">cat&gt;auth-nginxbar-org.yaml&lt;&lt;EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">auth-nginxbar-org</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">        <span class="comment"># è®¾ç½®è®¤è¯ç±»å‹</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/auth-type:</span> <span class="string">basic</span></span><br><span class="line">        <span class="comment"># å…³è”è´¦å·å’Œå¯†ç </span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/auth-secret:</span> <span class="string">basic-auth</span></span><br><span class="line">        <span class="comment"># æ˜¾ç¤ºè®¤è¯æç¤ºä¿¡æ¯</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/auth-realm:</span> <span class="string">&#x27;Authentication Required for web.nginxbar.org&#x27;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">auth.nginxbar.org</span>   <span class="comment"># æ­¤serviceçš„è®¿é—®åŸŸå</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">          <span class="attr">paths:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">              <span class="attr">serviceName:</span> <span class="string">nginx-web</span></span><br><span class="line">              <span class="attr">servicePort:</span> <span class="number">8080</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="string">kubectl</span> <span class="string">create</span> <span class="string">-f</span> <span class="string">auth-nginxbar-org.yaml</span></span><br></pre></td></tr></table></figure>

<p>è®¤è¯è½¬å‘é…ç½®æ ·ä¾‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">auth-nginxbar-org</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/auth-url:</span> <span class="string">&quot;http://$host/auth2&quot;</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/auth-signin:</span> <span class="string">&quot;http://$host/auth/start&quot;</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/auth-method:</span> <span class="string">&quot;POST&quot;</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/auth-cache-key:</span> <span class="string">&quot;foo&quot;</span><span class="string">,</span></span><br><span class="line">        <span class="string">nginx.ingress.kubernetes.io/auth-cache-duration&quot;:</span> <span class="string">&quot;200 202 401 30m&quot;</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/auth-snippet:</span> <span class="string">|</span></span><br><span class="line"><span class="string">            proxy_set_header Foo-Header 42;</span></span><br><span class="line"><span class="string"></span><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">auth.nginxbar.org</span>   <span class="comment"># æ­¤serviceçš„è®¿é—®åŸŸå</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">            <span class="attr">serviceName:</span> <span class="string">nginx-web</span></span><br><span class="line">            <span class="attr">servicePort:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure>

<h2 id="5ã€è·¨åŸŸè®¿é—®"><a href="#5ã€è·¨åŸŸè®¿é—®" class="headerlink" title="5ã€è·¨åŸŸè®¿é—®"></a>5ã€è·¨åŸŸè®¿é—®</h2><p>è·¨åŸŸè®¿é—®åŠŸèƒ½é…ç½®è¯´æ˜å¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚</p>
<table>
<thead>
<tr>
<th>æ³¨è§£</th>
<th>ç±»å‹</th>
<th>åŠŸèƒ½æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>nginx.ingress.kubernetes.io&#x2F;enable-cors</td>
<td>true æˆ– false</td>
<td>æ˜¯å¦å¯ç”¨è·¨åŸŸè®¿é—®æ”¯æŒï¼Œé»˜è®¤ä¸º false</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;cors-allow-origin</td>
<td>string</td>
<td>å…è®¸è·¨åŸŸè®¿é—®çš„åŸŸåï¼Œé»˜è®¤ä¸º *ï¼Œè¡¨ç¤ºæ¥å—ä»»æ„åŸŸåçš„è®¿é—®</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;cors-allow-methods</td>
<td>string</td>
<td>å…è®¸è·¨åŸŸè®¿é—®æ–¹æ³•ï¼Œé»˜è®¤ä¸º GETã€PUTã€POSTã€DELETEã€PATCHã€OPTIONS</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;cors-allow-headers</td>
<td>string</td>
<td>å…è®¸è·¨åŸŸè®¿é—®çš„è¯·æ±‚å¤´ï¼Œé»˜è®¤ä¸º DNTï¼ŒX-CustomHeaderã€Keep-Aliveã€User-Agentã€X-Requested-Withã€If-Modified-Sinceã€Cache-Controlã€Content-Typeã€Authorization</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;cors-allow-credentials</td>
<td>true æˆ– false</td>
<td>è®¾ç½®åœ¨å“åº”å¤´ä¸­ Access-Control-Allow-Credentials çš„å€¼ï¼Œè®¾ç½®æ˜¯å¦å…è®¸å®¢æˆ·ç«¯æºå¸¦éªŒè¯ä¿¡æ¯ï¼Œå¦‚ cookie ç­‰ï¼Œé»˜è®¤ä¸º true</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;cors-max-age</td>
<td>number</td>
<td>è®¾ç½®å“åº”å¤´ä¸­ Access-Control-Max-Age çš„å€¼ï¼Œè®¾ç½®è¿”å›ç»“æœå¯ä»¥ç”¨äºç¼“å­˜çš„æœ€é•¿æ—¶é—´ï¼Œé»˜è®¤ä¸º 1728000 ç§’</td>
</tr>
</tbody></table>
<p>é…ç½®æ ·ä¾‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">web-nginxbar-org</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/cors-allow-headers:</span> <span class="string">&gt;-</span></span><br><span class="line"><span class="string">            DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,</span></span><br><span class="line"><span class="string">            If-Modified-Since,Cache-Control,Content-Type,Authorization</span></span><br><span class="line"><span class="string"></span>        <span class="attr">nginx.ingress.kubernetes.io/cors-allow-methods:</span> <span class="string">&#x27;PUT, GET, POST, OPTIONS&#x27;</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/cors-allow-origin:</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/enable-cors:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/cors-max-age:</span> <span class="number">600</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">web.nginxbar.org</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">            <span class="attr">serviceName:</span> <span class="string">nginx-web</span></span><br><span class="line">            <span class="attr">servicePort:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/</span></span><br></pre></td></tr></table></figure>

<h2 id="6ã€ä»£ç†é…ç½®"><a href="#6ã€ä»£ç†é…ç½®" class="headerlink" title="6ã€ä»£ç†é…ç½®"></a>6ã€ä»£ç†é…ç½®</h2><p>Nginx ä»£ç†ç›¸å…³åŠŸèƒ½é…ç½®è¯´æ˜å¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚</p>
<table>
<thead>
<tr>
<th>æ³¨è§£</th>
<th>ç±»å‹&#x2F;é€‰é¡¹</th>
<th>åŠŸèƒ½æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>nginx.ingress.kubernetes.io&#x2F;service-upstream</td>
<td>true æˆ– false</td>
<td>é»˜è®¤ Nginx ä»¥ Service ä¸­ Pod çš„ IP å’Œç«¯å£ä¸º Upstream ä¸­çš„æˆå‘˜åˆ—è¡¨ï¼Œè¯¥å‚æ•°ä¸º true æ—¶ï¼Œå°†ä»¥ Service çš„ ClusterIP å’Œç«¯å£ä¸ºè¢«ä»£ç†å…¥å£ï¼Œè¯¥åŠŸèƒ½é¿å…äº†å›  Pod æ¼‚ç§»å¸¦æ¥çš„ Upstream çš„é…ç½®å˜åŒ–</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;backend-protocol</td>
<td>ĞĞ¢Ğ¢Ğ  æˆ– HTTPS æˆ– GRPC æˆ– GRPCS æˆ– AJP æˆ– FCGI</td>
<td>è®¾ç½®ä»£ç†åç«¯æœåŠ¡å™¨çš„ä»£ç†åè®®ç±»å‹ï¼Œé»˜è®¤ä¸º HTTP</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;proxy-body-size</td>
<td>string</td>
<td>åŒ Nginx é…ç½®æŒ‡ä»¤ client_max_body-sizeï¼Œé»˜è®¤ä¸º 1m</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;proxy-cookie-do-main</td>
<td>string</td>
<td>åŒ Nginx é…ç½®æŒ‡ä»¤ proxy_cookie_domain</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;proxy-cookie-path</td>
<td>string</td>
<td>åŒ Nginx é…ç½®æŒ‡ä»¤ proxy_cookie_path</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;proxy-connect-timeout</td>
<td>number</td>
<td>åŒ Nginx é…ç½®æŒ‡ä»¤ proxy_connect_timeout</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;proxy-send-time-out</td>
<td>number</td>
<td>åŒ Nginx é…ç½®æŒ‡ä»¤ proxy_send_timeout</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;proxy-read-time-out</td>
<td>number</td>
<td>åŒ Nginx é…ç½®æŒ‡ä»¤ proxy_read_timeout</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;proxy-next-up-stream</td>
<td>string</td>
<td>åŒ Nginx é…ç½®æŒ‡ä»¤ proxy_next_upstream</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;proxy-next-up-stream-timeout</td>
<td>number</td>
<td>åŒ Nginx é…ç½®æŒ‡ä»¤ proxy_next_upstream_timeout</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;proxy-next-up-stream-tries</td>
<td>number</td>
<td>åŒ Nginx é…ç½®æŒ‡ä»¤ proxy_next_upstream_tries</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;proxy-buffering</td>
<td>string</td>
<td>åŒ Nginx é…ç½®æŒ‡ä»¤ proxy_buffering</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;proxy-buffers-number</td>
<td>number</td>
<td>åŒ Nginx é…ç½®æŒ‡ä»¤ proxy_buffers</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;proxy-buffer-size</td>
<td>string</td>
<td>åŒ Nginx é…ç½®æŒ‡ä»¤ proxy_buffer_size</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;proxy-request-buffering</td>
<td>string</td>
<td>åŒ Nginx é…ç½®æŒ‡ä»¤ proxy_request_buffering</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;proxy-http-ver-sion</td>
<td>1.0 æˆ– 1.1</td>
<td>åŒ Nginx é…ç½®æŒ‡ä»¤ proxy_http_versionï¼Œé»˜è®¤ä¸º 1.1</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;upstream-vhost</td>
<td>string</td>
<td>è‡ªå®šä¹‰å‘é€åˆ°ä¸Šæ¸¸æœåŠ¡å™¨çš„ä¿¡æ¯å¤´å­—æ®µä¸­ Host çš„å†…å®¹ï¼Œç›¸å½“äº Nginx é…ç½®æŒ‡ä»¤ proxy_set_header Host $host çš„è®¾ç½®</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;proxy-redirect-from</td>
<td>string</td>
<td>è®¾ç½®è¦æ›¿æ¢çš„æºæ–‡æœ¬ï¼ŒåŒ Nginx é…ç½®æŒ‡ä»¤ proxy_redirect</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;proxy-redirect-to</td>
<td>string</td>
<td>è®¾ç½®è¦æ›¿æ¢çš„ç›®æ ‡æ–‡æœ¬ï¼ŒåŒ Nginx é…ç½®æŒ‡ proxy redirect</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;connection-proxy-header</td>
<td>string</td>
<td>è®¾ç½®å‘é€åˆ°è¢«ä»£ç†æœåŠ¡å™¨è¯·æ±‚å¤´ä¸­å­—æ®µå±æ€§ connection çš„å€¼ï¼Œç›¸å½“äº Nginx é…ç½®æŒ‡ä»¤ proxy_set_header Connection çš„çŠ¶æ€ä¸º Keep-Alive</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;x-forwarded-prefix</td>
<td>string</td>
<td>åˆ›å»ºå¹¶è®¾ç½®ä»£ç†è¯·æ±‚å¤´å±æ€§å­—æ®µ X-Forwarded-Prefix å±æ€§ï¼Œç”¨ä»¥å‘åç«¯ä¼ é€’è¯·æ±‚è·¯å¾„</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;http2-push-pre-load</td>
<td>true æˆ– false</td>
<td>åŒ Nginx é…ç½®æŒ‡ä»¤ http2-push-preloadï¼Œé»˜è®¤å€¼ä¸º false</td>
</tr>
</tbody></table>
<h2 id="7ã€è´Ÿè½½å‡è¡¡"><a href="#7ã€è´Ÿè½½å‡è¡¡" class="headerlink" title="7ã€è´Ÿè½½å‡è¡¡"></a>7ã€è´Ÿè½½å‡è¡¡</h2><p>ä¸ºæ–¹ä¾¿ä¸Šæ¸¸æœåŠ¡å™¨ç»„çš„åŠ¨æ€ç®¡ç†ï¼ŒNginx Ingress åŸºäº Lua å®ç°äº†ä¸€è‡´æ€§å“ˆå¸Œã€åŸºäºå­é›†çš„ä¸€è‡´æ€§å“ˆå¸Œã€è½®è¯¢è°ƒåº¦åŠå³°å€¼æŒ‡æ•°åŠ æƒç§»åŠ¨å¹³å‡ï¼ˆPeak Exponentially Weighted Moving-Averageï¼ŒPeak EWMAï¼‰è´Ÿè½½å‡è¡¡ç®—æ³•ã€‚è´Ÿè½½å‡è¡¡é…ç½®è¯´æ˜å¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚</p>
<table>
<thead>
<tr>
<th>æ³¨è§£</th>
<th>ç±»å‹&#x2F;é€‰é¡¹</th>
<th>åŠŸèƒ½æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>nginx.ingress.kubernetes.io&#x2F;upstream-hash-by</td>
<td>string</td>
<td>åŒ Nginx é…ç½®æŒ‡ä»¤ hashï¼Œæ­¤å¤„é»˜è®¤ä¸ºä¸€è‡´æ€§å“ˆå¸Œè´Ÿè½½ç®—æ³•ï¼Œå…è®¸é™¤äº†å®¢æˆ·ç«¯ IP æˆ– cookie ä¹‹å¤–çš„ä¼šè¯ç²˜è¿</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;upstream-hash-by-subset</td>
<td>true æˆ– false</td>
<td>è®¾ç½®æ˜¯å¦ä½¿ç”¨å­é›†æ¨¡å¼çš„ä¸€è‡´æ€§å“ˆå¸Œè´Ÿè½½ç®—æ³•ï¼Œé»˜è®¤ä¸º false</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;upstream-hash-by-subset-size</td>
<td>int</td>
<td>è®¾ç½®å­é›†æ¨¡å¼ä¸­ä¸Šæ¸¸æœåŠ¡å™¨åˆ†ç»„çš„å¤§å°ï¼Œé»˜è®¤ä¸º 3</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;load-balance</td>
<td>round_robin æˆ– ewma</td>
<td>è®¾ç½®è´Ÿè½½å‡è¡¡ç®—æ³•ï¼ŒåŸºäº balancer_by_lua æ¨¡å—å®ç°ï¼Œæ”¯æŒè½®è¯¢å’Œ Peak EWMA ä¸¤ç§è´Ÿè½½ç®—æ³•</td>
</tr>
</tbody></table>
<p>å­é›†æ¨¡å¼çš„ä¸€è‡´æ€§å“ˆå¸Œè´Ÿè½½ç®—æ³•æ˜¯å°†ä¸Šæ¸¸æœåŠ¡å™¨ç»„ä¸­çš„è¢«ä»£ç†æœåŠ¡å™¨åˆ†æˆå›ºå®šæ•°é‡çš„åˆ†ç»„ï¼Œç„¶åæŠŠæ¯ä¸ªåˆ†ç»„å½“ä½œä¸€è‡´æ€§å“ˆå¸Œè®¡ç®—çš„è™šæ‹ŸèŠ‚ç‚¹ã€‚é»˜è®¤ä¸€è‡´æ€§å“ˆå¸Œæ˜¯æŒ‰ç…§æ¯ä¸ªè¢«ä»£ç†æœåŠ¡å™¨ä¸ºè™šæ‹ŸèŠ‚ç‚¹è¿›è¡Œè®¡ç®—çš„ã€‚</p>
<p>Peak EWMA è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œæ˜¯å¯¹æ¯ä¸ª Pod è¯·æ±‚çš„å¾€è¿”å»¶æ—¶ï¼ˆRound-Trip Timeï¼ŒRTTï¼‰è®¡ç®—ç§»åŠ¨å¹³å‡å€¼ï¼Œå¹¶ç”¨è¯¥ Pod çš„æœªå®Œæˆè¯·æ±‚æ•°å¯¹è¿™ä¸ªå¹³å‡å€¼åŠ æƒè®¡ç®—ï¼Œè®¡ç®—å€¼æœ€å°çš„ Pod ç«¯ç‚¹å°†è¢«åˆ†é…æ–°çš„è¯·æ±‚ã€‚</p>
<h2 id="8ã€ä¼šè¯ä¿æŒé…ç½®"><a href="#8ã€ä¼šè¯ä¿æŒé…ç½®" class="headerlink" title="8ã€ä¼šè¯ä¿æŒé…ç½®"></a>8ã€ä¼šè¯ä¿æŒé…ç½®</h2><p>è®¾ç½®åŸºäº cookie çš„ä¼šè¯äº²ç¼˜å…³ç³»ï¼Œä¹Ÿå°±æ˜¯ä¼šè¯ä¿æŒåŠŸèƒ½ã€‚å¯ç”¨åŸºäº cookie çš„ä¼šè¯ä¿æŒåŠŸèƒ½æ—¶ï¼Œå¯ä»¥ä½¿åŒä¸€å®¢æˆ·ç«¯çš„è¯·æ±‚å§‹ç»ˆè½¬å‘ç»™åŒä¸€åç«¯æœåŠ¡å™¨ã€‚Nginx Ingress å¯¹å¯ç”¨ä¼šè¯ä¿æŒåŠŸèƒ½çš„ Service é›†ç¾¤ä½¿ç”¨ä¸€è‡´æ€§å“ˆå¸Œè´Ÿè½½ç®—æ³•ï¼Œå³ä½¿åç«¯ Pod æ•°é‡å˜åŒ–ï¼Œä¹Ÿä¸ä¼šå¯¹ä¼šè¯ä¿æŒåŠŸèƒ½äº§ç”Ÿå¤ªå¤§çš„å½±å“ã€‚ä¼šè¯ä¿æŒé…ç½®è¯´æ˜å¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚</p>
<table>
<thead>
<tr>
<th>æ³¨è§£</th>
<th>ç±»å‹</th>
<th>åŠŸèƒ½æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>nginx.ingress.kubernetes.io&#x2F;affinity</td>
<td>cookie</td>
<td>è®¾ç½®ä¼šè¯ä¿æŒç±»å‹ï¼Œç›®å‰åªæœ‰ cookie ç±»å‹</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;session-cookie-name</td>
<td>string</td>
<td>è®¾ç½® cookie åç§°ï¼Œé»˜è®¤ä¸º INGRESSCOOKIE</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;session-cookie-path</td>
<td>string</td>
<td>è®¾ç½® cookie å­—æ®µ path çš„å€¼ï¼Œé»˜è®¤å€¼ä¸ºå½“å‰èµ„æºå®ä¾‹ path çš„è®¾ç½®ã€‚å¦‚æœå¯ç”¨ use-regex åŠŸèƒ½ï¼Œä½¿ç”¨æ­£åˆ™åŒ¹é…æ—¶ï¼Œå¿…é¡»å•ç‹¬æŒ‡å®šï¼Œä¸èƒ½ä½¿ç”¨é»˜è®¤å€¼</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;session-cookie-max-age</td>
<td>--</td>
<td>è®¾ç½® cookie å­—æ®µ max-age çš„å€¼ï¼Œè¡¨ç¤º cookie è¿‡æœŸæ—¶é—´</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;session-cookie-expires</td>
<td>--</td>
<td>ä¸ºå…¼å®¹æ—§çš„æµè§ˆå™¨ï¼Œè®¾ç½® cookie å­—æ®µ expires çš„å€¼ï¼Œè¡¨ç¤º cookie è¿‡æœŸæ—¶é—´</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;session-cookie-change-on-failure</td>
<td>true æˆ– false</td>
<td>å½“ä¼šè¯ä¿æŒçš„è¢«ä»£ç†æœåŠ¡å™¨è¯·æ±‚å¤±è´¥æ—¶ï¼Œå¦‚æœè®¾ç½®å€¼ä¸º trueï¼Œåˆ™å°†ä¸‹æ¬¡è¯·æ±‚æ›´æ”¹ä¸ºå‘å¦ä¸€å°è¢«ä»£ç†æœåŠ¡å™¨è½¬å‘ï¼Œå¦åˆ™ç»§ç»­å‘å½“å‰è¢«ä»£ç†æœåŠ¡å™¨è½¬å‘è¯·æ±‚</td>
</tr>
</tbody></table>
<p>é…ç½®æ ·ä¾‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">web-nginxbar-org</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/affinity:</span> <span class="string">&quot;cookie&quot;</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/session-cookie-name:</span> <span class="string">&quot;route&quot;</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/session-cookie-expires:</span> <span class="string">&quot;172800&quot;</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/session-cookie-max-age:</span> <span class="string">&quot;172800&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">web.nginxbar.org</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">            <span class="attr">serviceName:</span> <span class="string">nginx-web</span></span><br><span class="line">            <span class="attr">servicePort:</span> <span class="number">8080</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/</span></span><br></pre></td></tr></table></figure>

<h2 id="9ã€HTTPSé…ç½®"><a href="#9ã€HTTPSé…ç½®" class="headerlink" title="9ã€HTTPSé…ç½®"></a>9ã€HTTPSé…ç½®</h2><p>HTTPS åŠŸèƒ½çš„é…ç½®è¯´æ˜å¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚</p>
<table>
<thead>
<tr>
<th>æ³¨è§£</th>
<th>ç±»å‹</th>
<th>åŠŸèƒ½æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>nginx.ingress.kubernetes.io&#x2F;force-ssl-redirect</td>
<td>true æˆ– false</td>
<td>å½“å®¢æˆ·ç«¯çš„ HTTPS è¢«å¤–éƒ¨é›†ç¾¤è¿›è¡Œ SSL å¸è½½ï¼ˆSSL offloadingï¼‰æ—¶ï¼Œä»å°† HTTP çš„è¯·æ±‚å¼ºåˆ¶è·³è½¬åˆ° HTTPS ç«¯å£</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;ssl-redirect</td>
<td>true æˆ– false</td>
<td>è®¾ç½®å½“å‰è™šæ‹Ÿä¸»æœºæ”¯æŒ HTTPS è¯·æ±‚æ—¶ï¼Œæ˜¯å¦å°† HTTP çš„è¯·æ±‚å¼ºåˆ¶è·³è½¬åˆ° HTTPS ç«¯å£ï¼Œå…¨å±€é»˜è®¤ä¸º true</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;ssl-passthrough</td>
<td>true æˆ– false</td>
<td>è®¾ç½®æ˜¯å¦å¯ç”¨ SSL é€ä¼ </td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;auth-tls-secret</td>
<td>string</td>
<td>è®¾ç½®å®¢æˆ·ç«¯è¯ä¹¦çš„èµ„æºå¯¹è±¡åç§°</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;ssl-ciphers</td>
<td>string</td>
<td>è®¾ç½® TLS ç”¨äºåå•†ä½¿ç”¨çš„åŠ å¯†ç®—æ³•ç»„åˆï¼ŒåŒ Nginx é…ç½®æŒ‡ä»¤ ssl_ciphers</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;auth-tls-verify-client</td>
<td>string</td>
<td>æ˜¯å¦å¯ç”¨å®¢æˆ·ç«¯è¯ä¹¦éªŒè¯ï¼ŒåŒ Nginx é…ç½®æŒ‡ä»¤ ssl_verify_client</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;auth-tls-verify-depth</td>
<td>number</td>
<td>å®¢æˆ·ç«¯è¯ä¹¦é“¾çš„éªŒè¯æ·±åº¦åŒ Nginx é…ç½®æŒ‡ä»¤ ssl_verify_depth</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;auth-tls-error-page</td>
<td>string</td>
<td>è®¾ç½®å®¢æˆ·ç«¯è¯ä¹¦éªŒè¯é”™è¯¯æ—¶çš„è·³è½¬é¡µé¢</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;auth-tls-pass-certificate-to-upstream</td>
<td>true æˆ– false</td>
<td>æŒ‡å®šè¯ä¹¦æ˜¯å¦ä¼ é€’åˆ°ä¸Šæ¸¸æœåŠ¡å™¨</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;secure-verify-ca-secret</td>
<td>string</td>
<td>è®¾ç½®æ˜¯å¦å¯ç”¨å¯¹è¢«ä»£ç†æœåŠ¡å™¨çš„ SSL è¯ä¹¦éªŒè¯åŠŸèƒ½</td>
</tr>
<tr>
<td>HTTPS é…ç½®æ ·ä¾‹å¦‚ä¸‹ï¼š</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºTLSè¯ä¹¦</span></span><br><span class="line"><span class="string">openssl</span> <span class="string">req</span> <span class="string">-x509</span> <span class="string">-nodes</span> <span class="string">-days</span> <span class="number">365</span> <span class="string">-newkey</span> <span class="string">rsa:2048</span> <span class="string">-keyout</span> <span class="string">/data/apps/certs/dashboard.key</span> <span class="string">-out</span> <span class="string">/data/apps/certs/dashboard.crt</span> <span class="string">-subj</span> <span class="string">&quot;/CN=dashboard.nginxbar.org/O=dashboard.nginxbar.org&quot;</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">-n</span> <span class="string">kube-system</span>  <span class="string">create</span> <span class="string">secret</span> <span class="string">tls</span> <span class="string">ingress-secret</span> <span class="string">--key</span> <span class="string">/data/apps/certs/dashboard.key</span> <span class="string">--cert</span> <span class="string">/data/apps/certs/dashboard.crt</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºHTTPSæœåŠ¡</span></span><br><span class="line"><span class="string">cat&gt;dashboard-ingress.yaml&lt;&lt;EOF</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">dashboard-ingress</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/ingress.class:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="comment"># ä½¿ç”¨HTTPSåè®®ä»£ç†åç«¯æœåŠ¡å™¨</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/backend-protocol:</span> <span class="string">&quot;HTTPS&quot;</span></span><br><span class="line">        <span class="comment"># å¯ç”¨SSLé€ä¼ </span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/ssl-passthrough:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">tls:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">dashboard.nginxbar.org</span></span><br><span class="line">        <span class="attr">secretName:</span> <span class="string">ingress-secret</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">dashboard.nginxbar.org</span></span><br><span class="line">          <span class="attr">http:</span></span><br><span class="line">            <span class="attr">paths:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">              <span class="attr">backend:</span></span><br><span class="line">                <span class="attr">serviceName:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">                <span class="attr">servicePort:</span> <span class="number">443</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="string">kubectl</span> <span class="string">create</span> <span class="string">-f</span> <span class="string">dashboard-ingress.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="string">curl</span> <span class="string">-k</span> <span class="string">-H</span> <span class="string">&quot;Host:dashboard.nginxbar.org&quot;</span> <span class="string">https://10.103.196.209</span></span><br></pre></td></tr></table></figure>

<p>Nginx-ingress åœ¨ç”¨æˆ·æ²¡æœ‰æä¾›è¯ä¹¦çš„æƒ…å†µä¸‹ä¼šæä¾›ä¸€ä¸ªå†…ç½®çš„é»˜è®¤ TLS è¯ä¹¦ï¼Œå¦‚æœ secretName å‚æ•°æ²¡æœ‰é…ç½®æˆ–é…ç½®é”™è¯¯ï¼ŒNginx ä¼šä½¿ç”¨ç³»ç»Ÿé»˜è®¤çš„è¯ä¹¦ï¼Œæ‰€ä»¥é…ç½®åä»éœ€æ£€æŸ¥ç¡®è®¤ã€‚</p>
<p>HTTPS å®¢æˆ·ç«¯è¯ä¹¦èº«ä»½è®¤è¯é…ç½®æ ·ä¾‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºå®¢æˆ·ç«¯è¯ä¹¦èµ„æºå¯¹è±¡default/ca-secret</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">        <span class="comment"># å¯ç”¨å®¢æˆ·ç«¯è¯ä¹¦éªŒè¯</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/auth-tls-verify-client:</span> <span class="string">&quot;on&quot;</span></span><br><span class="line">        <span class="comment"># ç»‘å®šå®¢æˆ·ç«¯è¯ä¹¦çš„èµ„æºå¯¹è±¡åç§°ï¼Œæ˜¯å‘½åç©ºé—´defaultçš„ca-secret</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/auth-tls-secret:</span> <span class="string">&quot;default/ca-secret&quot;</span></span><br><span class="line">        <span class="comment"># å®¢æˆ·ç«¯è¯ä¹¦é“¾çš„éªŒè¯æ·±åº¦ä¸º1</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/auth-tls-verify-depth:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">        <span class="comment"># è®¾ç½®å®¢æˆ·ç«¯è¯ä¹¦éªŒè¯é”™è¯¯æ—¶çš„è·³è½¬é¡µé¢</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/auth-tls-error-page:</span> <span class="string">&quot;http://www.mysite.com/error-cert.html&quot;</span></span><br><span class="line">        <span class="comment"># æŒ‡å®šè¯ä¹¦ä¼ é€’åˆ°ä¸Šæ¸¸æœåŠ¡å™¨</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/auth-tls-pass-certificate-to-upstream:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx-test</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">mydomain.com</span></span><br><span class="line">        <span class="attr">http:</span></span><br><span class="line">            <span class="attr">paths:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">                <span class="attr">serviceName:</span> <span class="string">http-svc</span></span><br><span class="line">                <span class="attr">servicePort:</span> <span class="number">80</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">    <span class="attr">tls:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">mydomain.com</span></span><br><span class="line">        <span class="attr">secretName:</span> <span class="string">tls-secret</span></span><br></pre></td></tr></table></figure>

<h2 id="10ã€â€œé‡‘ä¸é›€â€å‘å¸ƒ"><a href="#10ã€â€œé‡‘ä¸é›€â€å‘å¸ƒ" class="headerlink" title="10ã€â€œé‡‘ä¸é›€â€å‘å¸ƒ"></a>10ã€â€œé‡‘ä¸é›€â€å‘å¸ƒ</h2><p>â€œé‡‘ä¸é›€â€å‘å¸ƒåˆç§°ä¸ºç°åº¦å‘å¸ƒï¼Œç°åº¦å‘å¸ƒåŠŸèƒ½å¯ä»¥å°†ç”¨æˆ·è¯·æ±‚æŒ‰ç…§æŒ‡å®šçš„ç­–ç•¥è¿›è¡Œåˆ†å‰²ï¼Œå¹¶è½¬å‘åˆ°ä¸åŒçš„ä»£ç†æœåŠ¡å™¨ç»„ï¼Œé€šè¿‡ä¸åŒçš„ä»£ç†æœåŠ¡å™¨éƒ¨ç½²åº”ç”¨ä¸åŒç‰ˆæœ¬å¯è¿›è¡Œå¯¹ç…§æ¯”è¾ƒï¼Œå› è¯¥æ–¹å¼å¯¹äºæ–°ç‰ˆæœ¬è€Œè¨€ç±»ä¼¼äºä½¿ç”¨â€œé‡‘ä¸é›€â€çš„æ–¹å¼è¿›è¡Œæµ‹è¯•ï¼Œæ‰€ä»¥ä¹Ÿå«â€œé‡‘ä¸é›€â€å‘å¸ƒã€‚<br>Nginx Ingress æ”¯æŒ Headerã€cookie å’Œæƒé‡ 3 ç§æ–¹å¼ï¼Œå¯å•ç‹¬ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥ç»„åˆä½¿ç”¨ã€‚â€œé‡‘ä¸é›€â€å‘å¸ƒé…ç½®è¯´æ˜å¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚</p>
<table>
<thead>
<tr>
<th>æ³¨è§£</th>
<th>ç±»å‹</th>
<th>åŠŸèƒ½æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>nginx.ingress.kubernetes.io&#x2F;canary</td>
<td>true æˆ– false</td>
<td>å¯ç”¨â€œé‡‘ä¸é›€â€å‘å¸ƒåŠŸèƒ½</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;canary-by-header</td>
<td>string</td>
<td>è®¾ç½®è¯·æ±‚å¤´å±æ€§å­—æ®µçš„åç§°ï¼Œç”¨äºæ ¹æ®è¯¥å­—æ®µçš„å€¼åˆ¤æ–­æ˜¯å¦å°†è¯·æ±‚è·¯ç”±åˆ°â€œé‡‘ä¸é›€â€æœåŠ¡å™¨ç»„ï¼Œè¯¥å­—æ®µå€¼ä¸º always æ—¶åˆ™è¯¥è¯·æ±‚è¢«è·¯ç”±åˆ°â€œé‡‘ä¸é›€â€æœåŠ¡å™¨ç»„ï¼›è¯¥å­—æ®µå€¼ä¸º never æ—¶åˆ™ä¸è·¯ç”±åˆ°â€œé‡‘ä¸é›€â€æœåŠ¡å™¨ç»„</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;canary-by-header-value</td>
<td>string</td>
<td>è‡ªå®šä¹‰ç”¨äºåˆ¤æ–­æ˜¯å¦è·¯ç”±åˆ°â€œé‡‘ä¸é›€â€æœåŠ¡å™¨ç»„çš„è¯·æ±‚å¤´å­—æ®µå€¼ï¼Œé»˜è®¤ä¸º alwaysï¼Œå¿…é¡»ä¸ canary-by-headeråŒæ—¶ä½¿ç”¨</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;canary-by-cookie</td>
<td>string</td>
<td>è®¾ç½® cookie çš„å­—æ®µåç§°ï¼Œç”¨äºæ ¹æ®è¯¥å­—æ®µçš„å€¼åˆ¤æ–­æ˜¯å¦å°†è¯·æ±‚è·¯ç”±åˆ°â€œé‡‘ä¸é›€â€æœåŠ¡å™¨ç»„ã€‚always åˆ™è·¯ç”±åˆ°â€œé‡‘ä¸é›€â€æœåŠ¡å™¨ç»„ï¼›never åˆ™æ°¸è¿œä¸è·¯ç”±åˆ°â€œé‡‘ä¸é›€â€æœåŠ¡å™¨ç»„</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;canary-weight</td>
<td>number</td>
<td>å°†è¯·æ±‚åŸºäºæ•´æ•°ï¼ˆ0~100ï¼‰çš„è¯·æ±‚ç™¾åˆ†æ¯”éšæœºè·¯ç”±åˆ°â€œé‡‘ä¸é›€â€æœåŠ¡å™¨ç»„ï¼›100 è¡¨ç¤ºæ‰€æœ‰è¯·æ±‚éƒ½è·¯ç”±åˆ°â€œé‡‘ä¸é›€â€æœåŠ¡å™¨ç»„ï¼›0 è¡¨ç¤ºä¸è·¯ç”±ä»»ä½•è¯·æ±‚åˆ°â€œé‡‘ä¸é›€â€æœåŠ¡å™¨ç»„</td>
</tr>
</tbody></table>
<p>â€œé‡‘ä¸é›€â€è·¯ç”±è§„åˆ™åŒæ—¶å­˜åœ¨æ—¶çš„ä¼˜å…ˆé¡ºåºæ˜¯ canary-by-headerã€canary-by-cookieã€canary-weightã€‚</p>
<p>é…ç½®æ ·ä¾‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºä¸»æœºweb.nginxbar.orgçš„Ingressèµ„æºé…ç½®</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">web-nginxbar-org</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/ingress.class:</span> <span class="string">&quot;nginx&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">web.nginxbar.org</span>   <span class="comment"># æ­¤serviceçš„è®¿é—®åŸŸå</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">            <span class="attr">serviceName:</span> <span class="string">nginx-web</span></span><br><span class="line">            <span class="attr">servicePort:</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºä¸»æœºweb.nginxbar.orgé‡‘ä¸é›€ç»„çš„Ingressèµ„æºé…ç½®</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">web-nginxbar-org-canary</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/ingress.class:</span> <span class="string">&quot;nginx&quot;</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/canary:</span> <span class="string">&quot;true&quot;</span><span class="string">,</span></span><br><span class="line">        <span class="comment"># æ ¹æ®è¯·æ±‚å¤´å­—æ®µCanaryByHeaderçš„å€¼è¿›è¡Œåˆ¤æ–­</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/canary-by-header:</span> <span class="string">&quot;CanaryByHeader&quot;</span><span class="string">,</span></span><br><span class="line">        <span class="comment"># è¯·æ±‚å¤´å­—æ®µCanaryByHeaderçš„å€¼ä¸ºDoCanaryæ—¶ï¼Œè·¯ç”±åˆ°â€œé‡‘ä¸é›€â€æœåŠ¡å™¨ç»„</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/canary-by-header-value:</span> <span class="string">&quot;DoCanary&quot;</span><span class="string">,</span></span><br><span class="line">        <span class="comment"># æ ¹æ®Cookieå­—æ®µCanaryByCookieçš„å€¼è¿›è¡Œåˆ¤æ–­</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/canary-by-cookie:</span> <span class="string">&quot;CanaryByCookie&quot;</span><span class="string">,</span></span><br><span class="line">        <span class="comment"># éšæœº10%çš„è¯·æ±‚è·¯ç”±åˆ°â€œé‡‘ä¸é›€â€æœåŠ¡å™¨ç»„</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/canary-weight:</span> <span class="string">&quot;10&quot;</span><span class="string">,</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">web.nginxbar.org</span>   <span class="comment"># æ­¤serviceçš„è®¿é—®åŸŸå</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">            <span class="attr">serviceName:</span> <span class="string">nginx-web-canary</span></span><br><span class="line">            <span class="attr">servicePort:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure>

<h2 id="11ã€lua-resty-wafæ¨¡å—"><a href="#11ã€lua-resty-wafæ¨¡å—" class="headerlink" title="11ã€lua-resty-wafæ¨¡å—"></a>11ã€lua-resty-wafæ¨¡å—</h2><p>lua-resty-waf æ˜¯ä¸€ä¸ªåŸºäº OpenResty çš„é«˜æ€§èƒ½ Web åº”ç”¨é˜²ç«å¢™ï¼Œå¯¹å½“å‰è™šæ‹Ÿä¸»æœºçš„è®¿é—®å¯ä»¥æŒ‰ç…§ç›¸å…³é˜²ç«å¢™è§„åˆ™è¿›è¡Œè®¿é—®è¿‡æ»¤ã€‚æ¨¡å—é…ç½®è¯´æ˜å¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚</p>
<table>
<thead>
<tr>
<th>æ³¨è§£</th>
<th>ç±»å‹</th>
<th>åŠŸèƒ½æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>nginx.ingress.kubernetes.io&#x2F;lua-resty-waf</td>
<td>string</td>
<td>è®¾ç½® WAF é˜²ç«å¢™çš„å·¥ä½œæ¨¡å¼ï¼Œinactive è¡¨ç¤ºä¸æ‰§è¡Œä»»ä½•æ“ä½œï¼›active è¡¨ç¤ºå¯ç”¨ï¼šsimulate æ¨¡å¼ä¸‹ï¼Œå¦‚æœç»™å®šè¯·æ±‚æœ‰åŒ¹é…çš„è§„åˆ™ï¼Œå®ƒå°†è®°å½•ä¸€æ¡è­¦å‘Šæ¶ˆæ¯è€Œä¸è¿›è¡Œå¤„ç†ã€‚è¿™æœ‰åŠ©äºåœ¨å®Œå…¨éƒ¨ç½²è§„åˆ™ä¹‹å‰è°ƒè¯•è§„åˆ™å¹¶æ¶ˆé™¤å¯èƒ½çš„è¯¯æŠ¥</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;lua-resty-waf-debug</td>
<td>true æˆ– false</td>
<td>è®¾ç½®æ˜¯å¦å¯ç”¨è°ƒè¯•åŠŸèƒ½ï¼Œé»˜è®¤å€¼ä¸º false</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;lua-resty-waf-ignore-rulesets</td>
<td>string</td>
<td>è®¾ç½®å¿½ç•¥è§„åˆ™é›†çš„åç§°ï¼Œå½“æŸäº›è§„åˆ™é›†ï¼ˆå¦‚ sqli æˆ– xss crs è§„åˆ™é›†ï¼‰å¤ªå®¹æ˜“è¯¯æŠ¥æˆ–ä¸é€‚ç”¨æ—¶ï¼Œå¯é€šè¿‡è¯¥è®¾ç½®è¿›è¡Œå¿½ç•¥å¤„ç†</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;lua-resty-waf-extra-rules</td>
<td>string</td>
<td>è®¾ç½®è‡ªå®šä¹‰çš„è§„åˆ™</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;lua-resty-waf-allow-unknown-content-types</td>
<td>true æˆ– false</td>
<td>è®¾ç½®åœ¨å‘é€äº†ä¸åœ¨å…è®¸å†…å®¹ç±»å‹è¡¨ä¸­çš„å†…å®¹ç±»å‹å¤´æ—¶æ˜¯å¦ç»§ç»­å¤„ç†è¯·æ±‚ã€‚é»˜è®¤å…è®¸çš„ä¸º text&#x2F;htmlã€text&#x2F;jsonã€application&#x2F;json çš„æ–‡æ¡£ç±»å‹ï¼Œé»˜è®¤å€¼ä¸º false</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;lua-resty-waf-score-threshold</td>
<td>number</td>
<td>è®¾ç½®è¯·æ±‚å¼‚å¸¸è¯„åˆ†çš„é˜ˆå€¼ï¼Œå¦‚æœè¶…è¿‡è¿™ä¸ªé˜ˆå€¼ï¼Œåˆ™æ‹’ç»è¯¥è¯·æ±‚ï¼Œé»˜è®¤å€¼ä¸º 5</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;lua-resty-waf-process-multipart-body</td>
<td>true æˆ– false</td>
<td>è®¾ç½®æ˜¯å¦ä½¿ç”¨ lua-resty-upload æ¨¡å—å¯¹ multipart&#x2F;form-data ç±»å‹è¯·æ±‚ä½“çš„å¤„ç†ï¼Œé»˜è®¤ä¸º true</td>
</tr>
</tbody></table>
<h2 id="12ã€ModSecurityæ¨¡å—é…ç½®"><a href="#12ã€ModSecurityæ¨¡å—é…ç½®" class="headerlink" title="12ã€ModSecurityæ¨¡å—é…ç½®"></a>12ã€ModSecurityæ¨¡å—é…ç½®</h2><p>ModSecurity æ˜¯ä¸€ä¸ªå¼€æºçš„ Web åº”ç”¨é˜²ç«å¢™ã€‚å¿…é¡»é¦–å…ˆé€šè¿‡åœ¨ ConfigMap ä¸­å¯ç”¨ Mod-Security æ¥åŠ è½½ ModSecurity æ¨¡å—ã€‚è¿™å°†ä¸ºæ‰€æœ‰è·¯å¾„å¯ç”¨ ModSecurity è¿‡æ»¤ï¼Œå¯ä»¥æ‰‹åŠ¨åœ¨ Ingress èµ„æºå®ä¾‹ä¸­ç¦ç”¨æ­¤åŠŸèƒ½ã€‚ModSecurity æ¨¡å—é…ç½®è¯´æ˜å¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚</p>
<table>
<thead>
<tr>
<th>æ³¨è§£</th>
<th>ç±»å‹</th>
<th>åŠŸèƒ½æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>nginx.ingress.kubernetes.io&#x2F;enable-mod-security</td>
<td>bool</td>
<td>è®¾ç½®æ˜¯å¦å¯ç”¨ ModSecurity è¿‡æ»¤ï¼Œå¯ç”¨æ—¶åº”ç”¨æ¨èçš„è§„åˆ™ä»¥ä»…æ£€æµ‹ï¼ˆDetection-Onlyï¼‰æ¨¡å¼è¿è¡Œ</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;enable-owasp-core-rules</td>
<td>bool</td>
<td>è®¾ç½®æ˜¯å¦ä½¿ç”¨ OWASP æ ¸å¿ƒè§„åˆ™è¿›è¡Œè¯·æ±‚æ£€æµ‹</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;modsecurity-transaction-id</td>
<td>string</td>
<td>è®¾ç½®ä» Nginx ä¼ é€’äº‹åŠ¡ IDï¼Œè€Œä¸æ˜¯åœ¨åº“ä¸­è‡ªåŠ¨ç”Ÿæˆï¼Œæœ‰åˆ©äºåœ¨ ModSecurity ä¸­è·Ÿè¸ªæŸ¥çœ‹æ£€æµ‹çš„è¯·æ±‚ï¼Œå¯¹åº”æ¨¡å—é…ç½®æŒ‡ä»¤ä¸º modsecurity_transaction_id</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;modsecurity-snippet</td>
<td>string</td>
<td>æ·»åŠ æ¨¡å—é…ç½®æŒ‡ä»¤ modsecurity_rules çš„å†…å®¹</td>
</tr>
</tbody></table>
<p>é…ç½®æ ·ä¾‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">web-nginxbar-org</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/enable-modsecurity:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/enable-owasp-core-rules:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/modsecurity-transaction-id:</span> <span class="string">&quot;$request_id&quot;</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/modsecurity-snippet:</span> <span class="string">|</span></span><br><span class="line"><span class="string">        SecRuleEngine On</span></span><br><span class="line"><span class="string">        SecDebugLog /tmp/modsec_debug.log</span></span><br><span class="line"><span class="string"></span><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">web.nginxbar.org</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">            <span class="attr">serviceName:</span> <span class="string">nginx-web</span></span><br><span class="line">            <span class="attr">servicePort:</span> <span class="number">8080</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/</span></span><br></pre></td></tr></table></figure>

<h2 id="13ã€Influxdbæ¨¡å—é…ç½®"><a href="#13ã€Influxdbæ¨¡å—é…ç½®" class="headerlink" title="13ã€Influxdbæ¨¡å—é…ç½®"></a>13ã€Influxdbæ¨¡å—é…ç½®</h2><p>é€šè¿‡ä½¿ç”¨ Nginx Influxdb æ¨¡å—ï¼Œå¯ä»¥ç”¨ UDP åè®®å°†è¯·æ±‚è®°å½•å®æ—¶å‘é€åˆ°åç«¯çš„ Influxdb æœåŠ¡å™¨ã€‚Influxdb æ¨¡å—é…ç½®è¯´æ˜å¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚</p>
<table>
<thead>
<tr>
<th>æ³¨è§£</th>
<th>ç±»å‹</th>
<th>åŠŸèƒ½æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>nginx.ingress.kubernetes.io&#x2F;enable-influxdb</td>
<td>true æˆ– false</td>
<td>æ˜¯å¦å¯ç”¨ Influxdb è¾“å‡ºåŠŸèƒ½</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;influxdb-measurement</td>
<td>string</td>
<td>æŒ‡å®š Influxdb ä¸­çš„ measurement åç§°</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;influxdb-port</td>
<td>string</td>
<td>æŒ‡å®š Influxdb çš„ç«¯å£</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;influxdb-host</td>
<td>string</td>
<td>æŒ‡å®š Influxdb çš„ IP åœ°å€</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io&#x2F;influxdb-server-name</td>
<td>string</td>
<td>è®¾ç½®è‡ªå·±çš„åº”ç”¨æ ‡è¯†</td>
</tr>
</tbody></table>
<p>é…ç½®æ ·ä¾‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">web-nginxbar-org</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/enable-influxdb:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/influxdb-measurement:</span> <span class="string">&quot;nginxbar-reqs&quot;</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/influxdb-port:</span> <span class="string">&quot;8089&quot;</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/influxdb-host:</span> <span class="string">&quot;192.168.2.110&quot;</span></span><br><span class="line">        <span class="attr">nginx.ingress.kubernetes.io/influxdb-server-name:</span> <span class="string">&quot;nginxbar-com&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">web.nginxbar.org</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">            <span class="attr">serviceName:</span> <span class="string">nginx-web</span></span><br><span class="line">            <span class="attr">servicePort:</span> <span class="number">8080</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/</span></span><br></pre></td></tr></table></figure>

<h2 id="è¯´æ˜"><a href="#è¯´æ˜" class="headerlink" title="è¯´æ˜"></a>è¯´æ˜</h2><h3 id="é‡‘ä¸é›€"><a href="#é‡‘ä¸é›€" class="headerlink" title="é‡‘ä¸é›€"></a>é‡‘ä¸é›€</h3><p>åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ‚¨å¯èƒ½å¸Œæœ›é€šè¿‡å‘å°‘é‡ä¸ç”Ÿäº§æœåŠ¡ä¸åŒçš„æœåŠ¡å‘é€å°‘é‡è¯·æ±‚æ¥â€œå–æ¶ˆâ€ä¸€ç»„æ–°çš„æ›´æ”¹ã€‚Canaryæ³¨é‡Šä½¿Ingressè§„èŒƒå¯ä»¥å……å½“è·¯ç”±è¯·æ±‚çš„æ›¿ä»£æœåŠ¡ï¼Œå…·ä½“å–å†³äºæ‰€åº”ç”¨çš„è§„åˆ™ã€‚<code>nginx.ingress.kubernetes.io/canary: &quot;true&quot;</code>è®¾ç½®åï¼Œå¯ä»¥å¯ç”¨ä»¥ä¸‹ç”¨äºé…ç½®é‡‘ä¸é›€çš„æ³¨é‡Šï¼š</p>
<ul>
<li><code>nginx.ingress.kubernetes.io/canary-by-header</code>ï¼šç”¨äºé€šçŸ¥Ingresså°†è¯·æ±‚è·¯ç”±åˆ°Canary Ingressä¸­æŒ‡å®šçš„æœåŠ¡çš„æ ‡å¤´ã€‚å½“è¯·æ±‚æ ‡å¤´è®¾ç½®<code>always</code>ä¸ºæ—¶ï¼Œå®ƒå°†è¢«è·¯ç”±åˆ°Canaryã€‚å½“æ ‡å¤´è®¾ç½®<code>never</code>ä¸ºæ—¶ï¼Œå®ƒå°†æ°¸è¿œä¸ä¼šè·¯ç”±åˆ°é‡‘ä¸é›€ã€‚å¯¹äºä»»ä½•å…¶ä»–å€¼ï¼Œæ ‡å¤´å°†è¢«å¿½ç•¥ï¼Œå¹¶ä¸”æŒ‰ä¼˜å…ˆçº§å°†è¯·æ±‚ä¸å…¶ä»–é‡‘ä¸é›€è§„åˆ™è¿›è¡Œæ¯”è¾ƒã€‚</li>
<li><code>nginx.ingress.kubernetes.io/canary-by-header-value</code>ï¼šåŒ¹é…çš„æŠ¥å¤´å€¼ï¼Œç”¨äºé€šçŸ¥Ingresså°†è¯·æ±‚è·¯ç”±åˆ°Canary Ingressä¸­æŒ‡å®šçš„æœåŠ¡ã€‚å½“è¯·æ±‚æ ‡å¤´è®¾ç½®ä¸ºæ­¤å€¼æ—¶ï¼Œå®ƒå°†è¢«è·¯ç”±åˆ°Canaryã€‚å¯¹äºä»»ä½•å…¶ä»–æ ‡å¤´å€¼ï¼Œæ ‡å¤´å°†è¢«å¿½ç•¥ï¼Œå¹¶æŒ‰ä¼˜å…ˆçº§å°†è¯·æ±‚ä¸å…¶ä»–é‡‘ä¸é›€è§„åˆ™è¿›è¡Œæ¯”è¾ƒã€‚æ­¤æ³¨é‡Šå¿…é¡»ä¸ä¸€èµ·ä½¿ç”¨ã€‚æ³¨é‡Šæ˜¯çš„æ‰©å±•ï¼Œ<code>nginx.ingress.kubernetes.io/canary-by-header</code>å…è®¸è‡ªå®šä¹‰æ ‡å¤´å€¼ï¼Œè€Œä¸ä½¿ç”¨ç¡¬ç¼–ç å€¼ã€‚å¦‚æœ<code>nginx.ingress.kubernetes.io/canary-by-header</code>æœªå®šä¹‰æ³¨é‡Šï¼Œåˆ™æ²¡æœ‰ä»»ä½•ä½œç”¨ã€‚</li>
<li><code>nginx.ingress.kubernetes.io/canary-by-header-pattern</code>ï¼šè¿™ä¸<code>canary-by-header-value</code>PCRE RegexåŒ¹é…ç›¸åŒã€‚è¯·æ³¨æ„ï¼Œ<code>canary-by-header-value</code>è®¾ç½®æ—¶ï¼Œæ­¤æ³¨é‡Šå°†è¢«å¿½ç•¥ã€‚å½“ç»™å®šçš„æ­£åˆ™è¡¨è¾¾å¼åœ¨è¯·æ±‚å¤„ç†æœŸé—´å¯¼è‡´é”™è¯¯æ—¶ï¼Œè¯¥è¯·æ±‚å°†è¢«è§†ä¸ºä¸åŒ¹é…ã€‚</li>
<li><code>nginx.ingress.kubernetes.io/canary-by-cookie</code>ï¼šç”¨äºé€šçŸ¥Ingresså°†è¯·æ±‚è·¯ç”±åˆ°Canary Ingressä¸­æŒ‡å®šçš„æœåŠ¡çš„cookieã€‚å½“cookieå€¼è®¾ç½®<code>always</code>ä¸ºæ—¶ï¼Œå®ƒå°†è¢«è·¯ç”±åˆ°canaryã€‚å½“cookieè®¾ç½®<code>never</code>ä¸ºæ—¶ï¼Œå®ƒå°†æ°¸è¿œä¸ä¼šè·¯ç”±åˆ°Canaryã€‚å¯¹äºä»»ä½•å…¶ä»–å€¼ï¼Œå°†å¿½ç•¥cookieï¼Œå¹¶æŒ‰ä¼˜å…ˆçº§å°†è¯·æ±‚ä¸å…¶ä»–canaryè§„åˆ™è¿›è¡Œæ¯”è¾ƒã€‚</li>
<li><code>nginx.ingress.kubernetes.io/canary-weight</code>ï¼šéšæœºè¯·æ±‚çš„æ•´æ•°ç™¾åˆ†æ¯”ï¼ˆ0-100ï¼‰ï¼Œåº”å°†å…¶è·¯ç”±åˆ°canary Ingressä¸­æŒ‡å®šçš„æœåŠ¡ã€‚æƒé‡0è¡¨ç¤ºæ­¤Canaryè§„åˆ™ä¸ä¼šåœ¨Canaryå…¥å£ä¸­å°†ä»»ä½•è¯·æ±‚å‘é€åˆ°æœåŠ¡ã€‚æƒé‡ä¸º100è¡¨ç¤ºæ‰€æœ‰è¯·æ±‚éƒ½å°†å‘é€åˆ°Ingressä¸­æŒ‡å®šçš„æ›¿ä»£æœåŠ¡ã€‚</li>
</ul>
<p>é‡‘ä¸é›€è§„åˆ™æŒ‰ä¼˜å…ˆçº§è¿›è¡Œè¯„ä¼°ã€‚ä¼˜å…ˆçº§å¦‚ä¸‹ï¼š <code>canary-by-header -&gt; canary-by-cookie -&gt; canary-weight</code></p>
<p><strong>è¯·æ³¨æ„</strong>ï¼Œå½“æ‚¨å°†æŸä¸ªå…¥å£æ ‡è®°ä¸ºcanaryæ—¶ï¼Œé™¤<code>nginx.ingress.kubernetes.io/load-balance</code>å’Œä¹‹å¤–ï¼Œæ‰€æœ‰å…¶ä»–écanaryæ³¨é‡Šå°†è¢«å¿½ç•¥ï¼ˆä»ç›¸åº”çš„ä¸»è¦å…¥å£ç»§æ‰¿ï¼‰<code>nginx.ingress.kubernetes.io/upstream-hash-by</code>ã€‚</p>
<p><strong>å·²çŸ¥å±€é™æ€§</strong></p>
<p>ç›®å‰ï¼Œæ¯ä¸ªIngressè§„åˆ™æœ€å¤šå¯ä»¥åº”ç”¨ä¸€ä¸ªCanary Ingressã€‚</p>
<h3 id="Rewrite"><a href="#Rewrite" class="headerlink" title="Rewrite"></a>Rewrite</h3><p>åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œåç«¯æœåŠ¡ä¸­å…¬å¼€çš„URLä¸Ingressè§„åˆ™ä¸­æŒ‡å®šçš„è·¯å¾„ä¸åŒã€‚å¦‚æœæ²¡æœ‰é‡å†™ï¼Œåˆ™ä»»ä½•è¯·æ±‚éƒ½å°†è¿”å›404ã€‚å°†æ³¨é‡Šè®¾ç½®<code>nginx.ingress.kubernetes.io/rewrite-target</code>ä¸ºæœåŠ¡æ‰€éœ€çš„è·¯å¾„ã€‚</p>
<p>å¦‚æœåº”ç”¨ç¨‹åºæ ¹ç›®å½•æš´éœ²åœ¨å…¶ä»–è·¯å¾„ä¸­ï¼Œå¹¶ä¸”éœ€è¦é‡å®šå‘ï¼Œè¯·è®¾ç½®æ³¨é‡Š<code>nginx.ingress.kubernetes.io/app-root</code>ä»¥é‡å®šå‘çš„è¯·æ±‚<code>/</code>ã€‚</p>
<h3 id="Session-Affinity"><a href="#Session-Affinity" class="headerlink" title="Session Affinity"></a>Session Affinity</h3><p>æ³¨é‡Š<code>nginx.ingress.kubernetes.io/affinity</code>åœ¨Ingressçš„æ‰€æœ‰ä¸Šæ¸¸ä¸­å¯ç”¨å’Œè®¾ç½®ç›¸ä¼¼æ€§ç±»å‹ã€‚è¿™æ ·ï¼Œè¯·æ±‚å°†å§‹ç»ˆå®šå‘åˆ°åŒä¸€ä¸Šæ¸¸æœåŠ¡å™¨ã€‚NGINXå”¯ä¸€å¯ç”¨çš„ç›¸ä¼¼æ€§ç±»å‹æ˜¯<code>cookie</code>ã€‚</p>
<p>æ³¨é‡Š<code>nginx.ingress.kubernetes.io/affinity-mode</code>å®šä¹‰äº†ä¼šè¯çš„ç²˜æ€§ã€‚<code>balanced</code>å¦‚æœå°†éƒ¨ç½²è§„æ¨¡æ‰©å¤§ï¼Œåˆ™å°†æ­¤é€‰é¡¹è®¾ç½®ä¸ºï¼ˆé»˜è®¤ï¼‰å°†é‡æ–°åˆ†é…ä¸€äº›ä¼šè¯ï¼Œä»è€Œé‡æ–°å¹³è¡¡æœåŠ¡å™¨ä¸Šçš„è´Ÿè½½ã€‚å°†æ­¤è®¾ç½®ä¸º<code>persistent</code>ä¸ä¼šé‡æ–°å¹³è¡¡ä¸æ–°æœåŠ¡å™¨çš„ä¼šè¯ï¼Œå› æ­¤æä¾›äº†æœ€å¤§çš„ç²˜æ€§ã€‚</p>
<p><strong>æ³¨æ„</strong></p>
<p>å¦‚æœä¸ºä¸€ä¸ªä¸»æœºå®šä¹‰äº†å¤šä¸ªIngress <code>nginx.ingress.kubernetes.io/affinity: cookie</code>ï¼Œå¹¶ä¸”è‡³å°‘ä¸€ä¸ªIngressä½¿ç”¨ï¼Œåˆ™åªæœ‰Ingressä½¿ç”¨çš„è·¯å¾„<code>nginx.ingress.kubernetes.io/affinity</code>å°†ä½¿ç”¨ä¼šè¯Cookieç›¸ä¼¼æ€§ã€‚é€šè¿‡éšæœºé€‰æ‹©åç«¯æœåŠ¡å™¨ï¼Œå¯ä»¥åœ¨ä¸»æœºçš„å…¶ä»–å…¥å£å®šä¹‰çš„æ‰€æœ‰è·¯å¾„è¿›è¡Œè´Ÿè½½å‡è¡¡ã€‚</p>
<h4 id="Cookie-Affinity"><a href="#Cookie-Affinity" class="headerlink" title="Cookie Affinity"></a>Cookie Affinity</h4><p>å¦‚æœä½¿ç”¨<code>cookie</code>äº²ç¼˜å…³ç³»ç±»å‹ï¼Œåˆ™è¿˜å¯ä»¥æŒ‡å®šå°†ç”¨äºé€šè¿‡æ³¨é‡Šè·¯ç”±è¯·æ±‚çš„cookieçš„åç§°<code>nginx.ingress.kubernetes.io/session-cookie-name</code>ã€‚é»˜è®¤æ˜¯åˆ›å»ºä¸€ä¸ªåä¸ºâ€œ INGRESSCOOKIEâ€çš„cookieã€‚</p>
<p>NGINXæ‰¹æ³¨<code>nginx.ingress.kubernetes.io/session-cookie-path</code>å®šä¹‰å°†åœ¨cookieä¸Šè®¾ç½®çš„è·¯å¾„ã€‚é™¤éæ³¨é‡Š<code>nginx.ingress.kubernetes.io/use-regex</code>è®¾ç½®ä¸ºtrueï¼Œå¦åˆ™è¿™æ˜¯å¯é€‰çš„ã€‚ä¼šè¯Cookieè·¯å¾„ä¸æ”¯æŒæ­£åˆ™è¡¨è¾¾å¼ã€‚</p>
<p>ä½¿ç”¨<code>nginx.ingress.kubernetes.io/session-cookie-samesite</code>çš„åº”ç”¨<code>SameSite</code>å±æ€§ç²˜é¥¼å¹²ã€‚æµè§ˆå™¨æ¥å—çš„å€¼æ˜¯<code>None</code>ï¼Œ<code>Lax</code>å’Œ<code>Strict</code>ã€‚æŸäº›æµè§ˆå™¨ä¼šæ‹’ç»å¸¦æœ‰çš„cookie <code>SameSite=None</code>ï¼ŒåŒ…æ‹¬åœ¨<code>SameSite=None</code>è§„èŒƒä¹‹å‰åˆ›å»ºçš„cookie ï¼ˆä¾‹å¦‚Chrome 5Xï¼‰ã€‚å…¶ä»–æµè§ˆå™¨é”™è¯¯åœ°å°†<code>SameSite=None</code>cookieè§†ä¸º<code>SameSite=Strict</code>ï¼ˆä¾‹å¦‚ï¼Œåœ¨OSX 14ä¸Šè¿è¡Œçš„Safariï¼‰ã€‚è¦ä»<code>SameSite=None</code>æµè§ˆå™¨ä¸­å¿½ç•¥è¿™äº›ä¸å…¼å®¹çš„å†…å®¹ï¼Œè¯·æ·»åŠ æ³¨é‡Š<code>nginx.ingress.kubernetes.io/session-cookie-conditional-samesite-none: &quot;true&quot;</code>ã€‚</p>
<h3 id="è®¤è¯æ–¹å¼"><a href="#è®¤è¯æ–¹å¼" class="headerlink" title="è®¤è¯æ–¹å¼"></a>è®¤è¯æ–¹å¼</h3><p>å¯ä»¥æ·»åŠ èº«ä»½éªŒè¯ï¼Œå¹¶åœ¨Ingressè§„åˆ™ä¸­æ·»åŠ å…¶ä»–æ³¨é‡Šã€‚èº«ä»½éªŒè¯çš„æ¥æºæ˜¯åŒ…å«ç”¨æˆ·åå’Œå¯†ç çš„æœºå¯†ã€‚</p>
<p>æ³¨é‡Šæ˜¯ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/auth-type: [basic|digest]</span><br></pre></td></tr></table></figure>

<p>æŒ‡ç¤º<a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc2617">HTTPèº«ä»½éªŒè¯ç±»å‹ï¼šåŸºæœ¬æˆ–æ‘˜è¦è®¿é—®èº«ä»½éªŒè¯</a>ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/auth-secret: secretName</span><br></pre></td></tr></table></figure>

<p>Secretçš„åç§°ï¼Œå…¶ä¸­åŒ…å«ç”¨æˆ·åå’Œå¯†ç ï¼Œè¿™äº›ç”¨æˆ·åå’Œå¯†ç è¢«æˆäºˆ<code>path</code>å¯¹Ingressè§„åˆ™ä¸­å®šä¹‰çš„çš„è®¿é—®æƒé™ã€‚æ­¤æ³¨é‡Šè¿˜æ¥å—æ›¿ä»£å½¢å¼â€œåç§°ç©ºé—´&#x2F; secretNameâ€ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç§˜å¯†æŸ¥æ‰¾åœ¨å¼•ç”¨çš„åç§°ç©ºé—´è€Œä¸æ˜¯Ingressåç§°ç©ºé—´ä¸­æ‰§è¡Œã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/auth-secret-type: [auth-file|auth-map]</span><br></pre></td></tr></table></figure>

<p>æœ¬<code>auth-secret</code>å¯ä»¥æœ‰ä¸¤ç§å½¢å¼ï¼š</p>
<ul>
<li><code>auth-file</code>-é»˜è®¤æƒ…å†µä¸‹ï¼Œå¯†é’¥<code>auth</code>å†…çš„htpasswdæ–‡ä»¶ä¸ºç§˜å¯†</li>
<li><code>auth-map</code> -æœºå¯†å¯†é’¥æ˜¯ç”¨æˆ·åï¼Œå€¼æ˜¯å“ˆå¸Œå¯†ç </li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/auth-realm: &quot;realm string&quot;</span><br></pre></td></tr></table></figure>



<h3 id="è‡ªå®šä¹‰NGINXä¸Šæ¸¸å“ˆå¸Œ"><a href="#è‡ªå®šä¹‰NGINXä¸Šæ¸¸å“ˆå¸Œ" class="headerlink" title="è‡ªå®šä¹‰NGINXä¸Šæ¸¸å“ˆå¸Œ"></a>è‡ªå®šä¹‰NGINXä¸Šæ¸¸å“ˆå¸Œ</h3><p>NGINXæ”¯æŒå®¢æˆ·ç«¯-æœåŠ¡å™¨æ˜ å°„çš„è´Ÿè½½å¹³è¡¡ï¼Œè¯¥æ˜ å°„åŸºäºç»™å®šå¯†é’¥çš„<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_upstream_module.html#hash">ä¸€è‡´å“ˆå¸Œ</a>å€¼ã€‚é”®å¯ä»¥åŒ…å«æ–‡æœ¬ï¼Œå˜é‡æˆ–å…¶ä»»ä½•ç»„åˆã€‚æ­¤åŠŸèƒ½å…è®¸è¯·æ±‚ç²˜æ€§è€Œä¸æ˜¯å®¢æˆ·ç«¯IPæˆ–cookieã€‚å°†ä½¿ç”¨<a target="_blank" rel="noopener" href="http://www.last.fm/user/RJ/journal/2007/04/10/392555/">ketama</a>ä¸€è‡´çš„å“ˆå¸Œæ–¹æ³•ï¼Œè¯¥æ–¹æ³•ç¡®ä¿åœ¨ä¸Šæ¸¸ç»„æ›´æ”¹æ—¶ä»…å°†å°‘æ•°å¯†é’¥é‡æ–°æ˜ å°„åˆ°ä¸åŒçš„æœåŠ¡å™¨ã€‚</p>
<p>ä¸Šæ¸¸å“ˆå¸Œçš„ä¸€ç§ç‰¹æ®Šæ¨¡å¼ç§°ä¸ºå­é›†ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œä¸Šæ¸¸æœåŠ¡å™¨è¢«åˆ†ç»„ä¸ºå­é›†ï¼Œç²˜æ€§é€šè¿‡å°†å¯†é’¥æ˜ å°„åˆ°å­é›†è€Œä¸æ˜¯å•ä¸ªä¸Šæ¸¸æœåŠ¡å™¨æ¥å·¥ä½œã€‚ä»é€‰å®šçš„ç²˜æ€§å­é›†ä¸­éšæœºé€‰æ‹©ç‰¹å®šçš„æœåŠ¡å™¨ã€‚å®ƒæä¾›äº†ç²˜æ€§å’Œè´Ÿè½½åˆ†é…ä¹‹é—´çš„å¹³è¡¡ã€‚</p>
<p>è¦ä¸ºåç«¯å¯ç”¨ä¸€è‡´çš„å“ˆå¸Œï¼š</p>
<p><code>nginx.ingress.kubernetes.io/upstream-hash-by</code>ï¼šnginxå˜é‡ï¼Œæ–‡æœ¬å€¼æˆ–å®ƒä»¬çš„ä»»æ„ç»„åˆï¼Œä»¥ç”¨äºä¸€è‡´çš„å“ˆå¸Œã€‚ä¾‹å¦‚<code>nginx.ingress.kubernetes.io/upstream-hash-by: &quot;$request_uri&quot;</code>ï¼Œé€šè¿‡å½“å‰è¯·æ±‚URIä¸€è‡´åœ°å“ˆå¸Œä¸Šæ¸¸è¯·æ±‚ã€‚</p>
<p>å¯ä»¥å¯ç”¨â€œå­é›†â€æ•£åˆ—è®¾ç½®<code>nginx.ingress.kubernetes.io/upstream-hash-by-subset</code>ï¼šâ€œ trueâ€ã€‚è¿™ä¼šå°†è¯·æ±‚æ˜ å°„åˆ°èŠ‚ç‚¹çš„å­é›†ï¼Œè€Œä¸æ˜¯å•ä¸ªè¯·æ±‚ã€‚<code>upstream-hash-by-subset-size</code>ç¡®å®šæ¯ä¸ªå­é›†çš„å¤§å°ï¼ˆé»˜è®¤ä¸º3ï¼‰ã€‚</p>
<p>è¯·æ£€æŸ¥<a target="_blank" rel="noopener" href="https://blog.csdn.net/examples/chashsubset/deployment.yaml">chashsubset</a>ç¤ºä¾‹ã€‚</p>
<h3 id="è‡ªå®šä¹‰NGINXè´Ÿè½½å¹³è¡¡"><a href="#è‡ªå®šä¹‰NGINXè´Ÿè½½å¹³è¡¡" class="headerlink" title="è‡ªå®šä¹‰NGINXè´Ÿè½½å¹³è¡¡"></a>è‡ªå®šä¹‰NGINXè´Ÿè½½å¹³è¡¡</h3><p>è¿™ä¸<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44692256/article/configmap/#load-balance"><code>load-balance</code>ConfigMapä¸­çš„</a>ç±»ä¼¼ï¼Œä½†æ˜¯æ¯ä¸ªå…¥å£é…ç½®è´Ÿè½½å¹³è¡¡ç®—æ³•ã€‚</p>
<blockquote>
<p>è¯·æ³¨æ„ï¼Œ<code>nginx.ingress.kubernetes.io/upstream-hash-by</code>ä¼˜å…ˆäºæ­¤ã€‚å¦‚æœ<code>nginx.ingress.kubernetes.io/upstream-hash-by</code>æœªè®¾ç½®ï¼Œåˆ™æˆ‘ä»¬å°†é€€å›åˆ°ä½¿ç”¨å…¨å±€é…ç½®çš„è´Ÿè½½å¹³è¡¡ç®—æ³•ã€‚</p>
</blockquote>
<h3 id="è‡ªå®šä¹‰NGINXä¸Šæ¸¸è™šæ‹Ÿä¸»æœº"><a href="#è‡ªå®šä¹‰NGINXä¸Šæ¸¸è™šæ‹Ÿä¸»æœº" class="headerlink" title="è‡ªå®šä¹‰NGINXä¸Šæ¸¸è™šæ‹Ÿä¸»æœº"></a>è‡ªå®šä¹‰NGINXä¸Šæ¸¸è™šæ‹Ÿä¸»æœº</h3><p>é€šè¿‡æ­¤é…ç½®è®¾ç½®ï¼Œæ‚¨å¯ä»¥åœ¨ä»¥ä¸‹è¯­å¥ä¸­æ§åˆ¶hostçš„å€¼ï¼š<code>proxy_set_header Host $host</code>ï¼Œå®ƒæ˜¯ä½ç½®å—çš„ä¸€éƒ¨åˆ†ã€‚å¦‚æœæ‚¨éœ€è¦é€šè¿‡ä»¥å¤–çš„æ–¹å¼è°ƒç”¨ä¸Šæ¸¸æœåŠ¡å™¨ï¼Œè¿™å°†éå¸¸æœ‰ç”¨<code>$host</code>ã€‚</p>
<h3 id="å®¢æˆ·ç«¯è¯ä¹¦è®¤è¯"><a href="#å®¢æˆ·ç«¯è¯ä¹¦è®¤è¯" class="headerlink" title="å®¢æˆ·ç«¯è¯ä¹¦è®¤è¯"></a>å®¢æˆ·ç«¯è¯ä¹¦è®¤è¯</h3><p>å¯ä»¥ä½¿ç”¨â€œå…¥å£è§„åˆ™â€ä¸­çš„é™„åŠ æ³¨é‡Šæ¥å¯ç”¨â€œå®¢æˆ·ç«¯è¯ä¹¦è®¤è¯â€ã€‚</p>
<p>æ³¨é‡Šæ˜¯ï¼š</p>
<ul>
<li><code>nginx.ingress.kubernetes.io/auth-tls-secret: secretName</code>ï¼šåŒ…å«å®Œæ•´çš„è¯ä¹¦é¢å‘æœºæ„é“¾çš„å¯†é’¥çš„åç§°ï¼Œè¯¥é“¾<code>ca.crt</code>å¯ä»¥é’ˆå¯¹æ­¤Ingressè¿›è¡Œèº«ä»½éªŒè¯ã€‚æ­¤æ³¨é‡Šè¿˜æ¥å—æ›¿ä»£å½¢å¼â€œåç§°ç©ºé—´&#x2F; secretNameâ€ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç§˜å¯†æŸ¥æ‰¾åœ¨å¼•ç”¨çš„åç§°ç©ºé—´è€Œä¸æ˜¯Ingressåç§°ç©ºé—´ä¸­æ‰§è¡Œã€‚</li>
<li><code>nginx.ingress.kubernetes.io/auth-tls-verify-depth</code>ï¼šæä¾›çš„å®¢æˆ·è¯ä¹¦å’Œè¯ä¹¦é¢å‘æœºæ„é“¾ä¹‹é—´çš„éªŒè¯æ·±åº¦ã€‚</li>
<li><code>nginx.ingress.kubernetes.io/auth-tls-verify-client</code>ï¼šå¯ç”¨å®¢æˆ·ç«¯è¯ä¹¦çš„éªŒè¯ã€‚</li>
<li><code>nginx.ingress.kubernetes.io/auth-tls-error-page</code>ï¼šå¦‚æœå‘ç”Ÿè¯ä¹¦èº«ä»½éªŒè¯é”™è¯¯ï¼Œåº”é‡å®šå‘ç”¨æˆ·çš„URL &#x2F;é¡µé¢</li>
<li><code>nginx.ingress.kubernetes.io/auth-tls-pass-certificate-to-upstream</code>ï¼šæŒ‡ç¤ºæ˜¯å¦åº”å°†æ”¶åˆ°çš„è¯ä¹¦ä¼ é€’ç»™ä¸Šæ¸¸æœåŠ¡å™¨ã€‚é»˜è®¤æƒ…å†µä¸‹æ˜¯ç¦ç”¨çš„ã€‚</li>
</ul>
<p><strong>æ³¨æ„</strong></p>
<p>Cloudflareä¸­<strong>æ— æ³•</strong>ä½¿ç”¨å¸¦æœ‰å®¢æˆ·ç«¯èº«ä»½éªŒè¯çš„TLSï¼Œ<strong>è¿™</strong>å¯èƒ½ä¼šå¯¼è‡´æ„å¤–è¡Œä¸ºã€‚</p>
<p>Cloudflareä»…å…è®¸ä½¿ç”¨Authenticated Origin Pullsï¼Œå¹¶ä¸”éœ€è¦ä½¿ç”¨å…¶è‡ªå·±çš„è¯ä¹¦ï¼š<a target="_blank" rel="noopener" href="https://blog.cloudflare.com/protecting-the-origin-with-tls-authenticated-origin-pulls/">https</a> : <a target="_blank" rel="noopener" href="https://blog.cloudflare.com/protecting-the-origin-with-tls-authenticated-origin-pulls/">&#x2F;&#x2F;blog.cloudflare.com&#x2F;protecting-the-origin-with-tls-authenticated-origin-pulls&#x2F;</a></p>
<p>ä»…å…è®¸é€šè¿‡èº«ä»½éªŒè¯çš„åŸäº§æ‹‰å–ï¼Œå¹¶ä¸”å¯ä»¥æŒ‰ç…§å…¶æ•™ç¨‹è¿›è¡Œé…ç½®ï¼š<a target="_blank" rel="noopener" href="https://support.cloudflare.com/hc/en-us/articles/204494148-Setting-up-NGINX-to-use-TLS-Authenticated-Origin-Pulls">https</a> : <a target="_blank" rel="noopener" href="https://support.cloudflare.com/hc/en-us/articles/204494148-Setting-up-NGINX-to-use-TLS-Authenticated-Origin-Pulls">&#x2F;&#x2F;support.cloudflare.com&#x2F;hc&#x2F;en-us&#x2F;articles&#x2F;204494148-Setting-up-NGINX-to-use-TLS-Authenticated-Origin -æ‹‰</a></p>
<h3 id="åç«¯è¯ä¹¦è®¤è¯"><a href="#åç«¯è¯ä¹¦è®¤è¯" class="headerlink" title="åç«¯è¯ä¹¦è®¤è¯"></a>åç«¯è¯ä¹¦è®¤è¯</h3><p>ä½¿ç”¨å…¥å£è§„åˆ™ä¸­çš„é™„åŠ æ³¨é‡Šï¼Œå¯ä»¥ä½¿ç”¨è¯ä¹¦å¯¹ä»£ç†çš„HTTPSåç«¯è¿›è¡Œèº«ä»½éªŒè¯ã€‚</p>
<ul>
<li><code>nginx.ingress.kubernetes.io/proxy-ssl-secret: secretName</code>ï¼šä½¿ç”¨è¯ä¹¦<code>tls.crt</code>ï¼ˆ<code>tls.key</code>PEMæ ¼å¼çš„å¯†é’¥ï¼‰æŒ‡å®šç”¨äºå¯¹ä»£ç†HTTPSæœåŠ¡å™¨è¿›è¡Œèº«ä»½éªŒè¯çš„å¯†é’¥ã€‚å®ƒè¿˜åº”åŒ…å«<code>ca.crt</code>PEMæ ¼å¼çš„å—ä¿¡ä»»CAè¯ä¹¦ï¼Œè¯¥è¯ä¹¦ç”¨äºéªŒè¯ä»£ç†HTTPSæœåŠ¡å™¨çš„è¯ä¹¦ã€‚æ­¤æ³¨é‡Šè¿˜æ¥å—æ›¿ä»£å½¢å¼â€œåç§°ç©ºé—´&#x2F; secretNameâ€ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç§˜å¯†æŸ¥æ‰¾åœ¨å¼•ç”¨çš„åç§°ç©ºé—´è€Œä¸æ˜¯Ingressåç§°ç©ºé—´ä¸­æ‰§è¡Œã€‚</li>
<li><code>nginx.ingress.kubernetes.io/proxy-ssl-verify</code>ï¼šå¯ç”¨æˆ–ç¦ç”¨å¯¹ä»£ç†HTTPSæœåŠ¡å™¨è¯ä¹¦çš„éªŒè¯ã€‚ï¼ˆé»˜è®¤å€¼ï¼šå…³é—­ï¼‰</li>
<li><code>nginx.ingress.kubernetes.io/proxy-ssl-verify-depth</code>ï¼šè®¾ç½®ä»£ç†HTTPSæœåŠ¡å™¨è¯ä¹¦é“¾ä¸­çš„éªŒè¯æ·±åº¦ã€‚ï¼ˆé»˜è®¤å€¼ï¼š1ï¼‰</li>
<li><code>nginx.ingress.kubernetes.io/proxy-ssl-ciphers</code>ï¼šæŒ‡å®šå¯¹ä»£ç†HTTPSæœåŠ¡å™¨çš„è¯·æ±‚çš„å¯ç”¨<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_ssl_ciphers">å¯†ç </a>ã€‚å¯†ç ä»¥OpenSSLåº“å¯ä»¥ç†è§£çš„æ ¼å¼æŒ‡å®šã€‚</li>
<li><code>nginx.ingress.kubernetes.io/proxy-ssl-name</code>ï¼šå…è®¸è®¾ç½®<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_ssl_name">proxy_ssl_name</a>ã€‚è¿™å…è®¸è¦†ç›–ç”¨äºéªŒè¯ä»£ç†HTTPSæœåŠ¡å™¨çš„è¯ä¹¦çš„æœåŠ¡å™¨åç§°ã€‚å»ºç«‹ä¸ä»£ç†HTTPSæœåŠ¡å™¨çš„è¿æ¥æ—¶ï¼Œä¹Ÿä¼šé€šè¿‡SNIä¼ é€’æ­¤å€¼ã€‚</li>
<li><code>nginx.ingress.kubernetes.io/proxy-ssl-protocols</code>ï¼šå¯ç”¨å¯¹ä»£ç†HTTPSæœåŠ¡å™¨çš„è¯·æ±‚çš„æŒ‡å®š<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_ssl_protocols">åè®®</a>ã€‚</li>
</ul>
<h3 id="é…ç½®ç‰‡æ®µ"><a href="#é…ç½®ç‰‡æ®µ" class="headerlink" title="é…ç½®ç‰‡æ®µ"></a>é…ç½®ç‰‡æ®µ</h3><p>ä½¿ç”¨æ­¤æ³¨é‡Šï¼Œæ‚¨å¯ä»¥å°†å…¶ä»–é…ç½®æ·»åŠ åˆ°NGINXä½ç½®ã€‚ä¾‹å¦‚ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/configuration-snippet: | more_set_headers &quot;Request-Id: $req_id&quot;;</span><br></pre></td></tr></table></figure>

<h3 id="è‡ªå®šä¹‰HTTPé”™è¯¯"><a href="#è‡ªå®šä¹‰HTTPé”™è¯¯" class="headerlink" title="è‡ªå®šä¹‰HTTPé”™è¯¯"></a>è‡ªå®šä¹‰HTTPé”™è¯¯</h3><p>å°±åƒ<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44692256/article/configmap/#custom-http-errors"><code>custom-http-errors</code></a>ConfigMapä¸­çš„å€¼ä¸€æ ·ï¼Œæ­¤æ‰¹æ³¨å°†è®¾ç½®NGINX <code>proxy-intercept-errors</code>ï¼Œä½†ä»…é’ˆå¯¹ä¸æ­¤å…¥å£ç›¸å…³è”çš„NGINXä½ç½®ã€‚å¦‚æœåœ¨å…¥å£ä¸ŠæŒ‡å®šäº†<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44692256/article/details/108581800#default-backend">é»˜è®¤åç«¯æ³¨é‡Š</a>ï¼Œåˆ™é”™è¯¯å°†è·¯ç”±åˆ°è¯¥æ³¨é‡Šçš„é»˜è®¤åç«¯æœåŠ¡ï¼ˆè€Œä¸æ˜¯å…¨å±€é»˜è®¤åç«¯ï¼‰ã€‚ä¸åŒçš„å…¥å£å¯ä»¥æŒ‡å®šä¸åŒçš„é”™è¯¯ä»£ç é›†ã€‚å³ä½¿å¤šä¸ªå…¥å£å¯¹è±¡å…±äº«ç›¸åŒçš„ä¸»æœºåï¼Œæ­¤æ³¨é‡Šä¹Ÿå¯ä»¥ç”¨äºä¸ºæ¯ä¸ªå…¥å£æˆªå–ä¸åŒçš„é”™è¯¯ä»£ç ï¼ˆä¾‹å¦‚ï¼Œå¦‚æœæ¯ä¸ªè·¯å¾„åœ¨ä¸åŒçš„å…¥å£ä¸Šï¼Œåˆ™å¯¹äºåŒä¸€ä¸»æœºåä¸Šçš„ä¸åŒè·¯å¾„å°†æˆªå–ä¸åŒçš„é”™è¯¯ä»£ç ï¼‰ ã€‚å¦‚æœ<code>custom-http-errors</code> ä¹Ÿæ˜¯å…¨å±€æŒ‡å®šçš„ï¼Œåœ¨æ­¤æ‰¹æ³¨ä¸­æŒ‡å®šçš„é”™è¯¯å€¼å°†è¦†ç›–ç»™å®šå…¥å£çš„ä¸»æœºåå’Œè·¯å¾„çš„å…¨å±€å€¼ã€‚</p>
<p>ç”¨æ³•ç¤ºä¾‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/custom-http-errors: &quot;404,415&quot;</span><br></pre></td></tr></table></figure>

<h3 id="é»˜è®¤åç«¯"><a href="#é»˜è®¤åç«¯" class="headerlink" title="é»˜è®¤åç«¯"></a>é»˜è®¤åç«¯</h3><p>æ­¤æ‰¹æ³¨å…·æœ‰<code>nginx.ingress.kubernetes.io/default-backend: &lt;svc name&gt;</code>æŒ‡å®šè‡ªå®šä¹‰é»˜è®¤åç«¯çš„å½¢å¼ã€‚è¿™<code>&lt;svc name&gt;</code>æ˜¯å¯¹æ‚¨åœ¨å…¶ä¸­åº”ç”¨æ­¤æ‰¹æ³¨çš„ç›¸åŒåç§°ç©ºé—´ä¸­çš„æœåŠ¡çš„å¼•ç”¨ã€‚æ­¤æ³¨é‡Šå°†è¦†ç›–å…¨å±€é»˜è®¤åç«¯ã€‚</p>
<p>å½“Ingressè§„åˆ™ä¸­çš„æœåŠ¡æ²¡æœ‰æ´»åŠ¨çš„ç«¯ç‚¹æ—¶ï¼Œå°†å¤„ç†è¯¥æœåŠ¡çš„å“åº”ã€‚å¦‚æœåŒæ—¶è®¾ç½®äº†æ­¤æ³¨é‡Šå’Œ<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44692256/article/details/108581800#custom-http-errors">custom-http-errorsæ³¨é‡Šï¼Œ</a>å®ƒè¿˜å°†å¤„ç†é”™è¯¯å“åº”ã€‚</p>
<h3 id="å¯ç”¨CORS"><a href="#å¯ç”¨CORS" class="headerlink" title="å¯ç”¨CORS"></a>å¯ç”¨CORS</h3><p>è¦åœ¨Ingressè§„åˆ™ä¸­å¯ç”¨è·¨åŸŸèµ„æºå…±äº«ï¼ˆCORSï¼‰ï¼Œè¯·æ·»åŠ æ³¨é‡Š <code>nginx.ingress.kubernetes.io/enable-cors: &quot;true&quot;</code>ã€‚è¿™å°†åœ¨æœåŠ¡å™¨ä½ç½®ä¸­æ·»åŠ ä¸€ä¸ªéƒ¨åˆ†ä»¥å¯ç”¨æ­¤åŠŸèƒ½ã€‚</p>
<p>å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ³¨é‡Šæ¥æ§åˆ¶CORSï¼š</p>
<ul>
<li><code>nginx.ingress.kubernetes.io/cors-allow-methods</code> æ§åˆ¶æ¥å—å“ªäº›æ–¹æ³•ã€‚è¿™æ˜¯ä¸€ä¸ªå¤šå€¼å­—æ®µï¼Œä»¥â€œï¼Œâ€åˆ†éš”ï¼Œä»…æ¥å—å­—æ¯ï¼ˆå¤§å†™å’Œå°å†™ï¼‰ã€‚</li>
<li>é»˜è®¤ï¼š <code>GET, PUT, POST, DELETE, PATCH, OPTIONS</code></li>
<li>ä¾‹ï¼š <code>nginx.ingress.kubernetes.io/cors-allow-methods: &quot;PUT, GET, POST, OPTIONS&quot;</code></li>
<li><code>nginx.ingress.kubernetes.io/cors-allow-headers</code> æ§åˆ¶æ¥å—å“ªäº›æ ‡é¢˜ã€‚è¿™æ˜¯ä¸€ä¸ªå¤šå€¼å­—æ®µï¼Œä»¥â€œï¼Œâ€åˆ†éš”ï¼Œå¹¶æ¥å—å­—æ¯ï¼Œæ•°å­—ï¼Œ_å’Œ-ã€‚</li>
<li>é»˜è®¤ï¼š <code>DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization</code></li>
<li>ä¾‹ï¼š <code>nginx.ingress.kubernetes.io/cors-allow-headers: &quot;X-Forwarded-For, X-app123-XPTO&quot;</code></li>
<li><code>nginx.ingress.kubernetes.io/cors-allow-origin</code> æ§åˆ¶CORSæ¥å—çš„åŸäº§åœ°ã€‚è¿™æ˜¯ä¸€ä¸ªå•å­—æ®µå€¼ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š<code>http(s)://origin-site.com</code>æˆ–<code>http(s)://origin-site.com:port</code></li>
<li>é»˜è®¤ï¼š <code>*</code></li>
<li>ä¾‹ï¼š <code>nginx.ingress.kubernetes.io/cors-allow-origin: &quot;https://origin-site.com:4443&quot;</code></li>
<li><code>nginx.ingress.kubernetes.io/cors-allow-credentials</code> æ§åˆ¶åœ¨CORSæ“ä½œæœŸé—´æ˜¯å¦å¯ä»¥ä¼ é€’å‡­æ®ã€‚</li>
<li>é»˜è®¤ï¼š <code>true</code></li>
<li>ä¾‹ï¼š <code>nginx.ingress.kubernetes.io/cors-allow-credentials: &quot;false&quot;</code></li>
<li><code>nginx.ingress.kubernetes.io/cors-max-age</code> æ§åˆ¶å¯ä»¥å°†é¢„æ£€è¯·æ±‚ç¼“å­˜å¤šé•¿æ—¶é—´ã€‚é»˜è®¤å€¼ï¼š<code>1728000</code> ç¤ºä¾‹ï¼š<code>nginx.ingress.kubernetes.io/cors-max-age: 600</code></li>
</ul>
<h3 id="HTTP2æ¨é€é¢„åŠ è½½ã€‚"><a href="#HTTP2æ¨é€é¢„åŠ è½½ã€‚" class="headerlink" title="HTTP2æ¨é€é¢„åŠ è½½ã€‚"></a>HTTP2æ¨é€é¢„åŠ è½½ã€‚</h3><p>å¯ç”¨å°†â€œé“¾æ¥â€å“åº”æ ‡é¢˜å­—æ®µä¸­æŒ‡å®šçš„é¢„åŠ è½½é“¾æ¥è‡ªåŠ¨è½¬æ¢ä¸ºæ¨é€è¯·æ±‚çš„åŠŸèƒ½ã€‚</p>
<p><code>nginx.ingress.kubernetes.io/http2-push-preload: &quot;true&quot;</code></p>
<h3 id="æœåŠ¡å™¨åˆ«å"><a href="#æœåŠ¡å™¨åˆ«å" class="headerlink" title="æœåŠ¡å™¨åˆ«å"></a>æœåŠ¡å™¨åˆ«å</h3><p>å…è®¸ä½¿ç”¨æ³¨è§£åœ¨NGINXé…ç½®çš„æœåŠ¡å™¨å®šä¹‰ä¸­å®šä¹‰ä¸€ä¸ªæˆ–å¤šä¸ªåˆ«å<code>nginx.ingress.kubernetes.io/server-alias: &quot;&lt;alias 1&gt;,&lt;alias 2&gt;&quot;</code>ã€‚è¿™å°†åˆ›å»ºå…·æœ‰ç›¸åŒé…ç½®çš„æœåŠ¡å™¨ï¼Œä½†æ˜¯ä¼šå‘<code>server_name</code>æŒ‡ä»¤æ·»åŠ æ–°å€¼ã€‚</p>
<p><strong>æ³¨æ„</strong></p>
<p>æœåŠ¡å™¨åˆ«åä¸èƒ½ä¸ç°æœ‰æœåŠ¡å™¨çš„ä¸»æœºåå†²çªã€‚å¦‚æœæ˜¯è¿™æ ·ï¼ŒæœåŠ¡å™¨åˆ«åæ³¨é‡Šå°†è¢«å¿½ç•¥ã€‚å¦‚æœåˆ›å»ºäº†æœåŠ¡å™¨åˆ«åï¼Œç„¶ååˆåˆ›å»ºäº†å…·æœ‰ç›¸åŒä¸»æœºåçš„æ–°æœåŠ¡å™¨ï¼Œåˆ™æ–°æœåŠ¡å™¨é…ç½®å°†å–ä»£åˆ«åé…ç½®ã€‚</p>
<p>æ¬²äº†è§£æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_core_module.html#server_name">è¯¥<code>server_name</code>æ–‡æ¡£</a>ã€‚</p>
<h3 id="Server-Snippetæ®µ"><a href="#Server-Snippetæ®µ" class="headerlink" title="Server Snippetæ®µ"></a>Server Snippetæ®µ</h3><p>ä½¿ç”¨æ³¨é‡Š<code>nginx.ingress.kubernetes.io/server-snippet</code>ï¼Œå¯ä»¥åœ¨æœåŠ¡å™¨é…ç½®å—ä¸­æ·»åŠ è‡ªå®šä¹‰é…ç½®ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">annotations:</span></span><br><span class="line">	<span class="attr">nginx.ingress.kubernetes.io/server-snippet:</span> <span class="string">|</span></span><br><span class="line"><span class="string">        set $agentflag 0;    </span></span><br><span class="line"><span class="string">        if ($http_user_agent ~* &quot;(Mobile)&quot; )&#123;      </span></span><br><span class="line"><span class="string">        set $agentflag 1;    </span></span><br><span class="line"><span class="string">        &#125; </span></span><br><span class="line"><span class="string">        if ( $agentflag = 1 ) &#123;</span></span><br><span class="line"><span class="string">            return 301 https://m.example.com;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>

<p>æ¯ä¸ªä¸»æœºåªèƒ½ä½¿ç”¨ä¸€æ¬¡æ­¤æ³¨é‡Šã€‚</p>
<h3 id="å®¢æˆ·ç«¯ä¸»ä½“ç¼“å†²åŒºå¤§å°"><a href="#å®¢æˆ·ç«¯ä¸»ä½“ç¼“å†²åŒºå¤§å°" class="headerlink" title="å®¢æˆ·ç«¯ä¸»ä½“ç¼“å†²åŒºå¤§å°"></a>å®¢æˆ·ç«¯ä¸»ä½“ç¼“å†²åŒºå¤§å°</h3><p>è®¾ç½®ç¼“å†²åŒºå¤§å°ï¼Œä»¥è¯»å–æ¯ä¸ªä½ç½®çš„å®¢æˆ·ç«¯è¯·æ±‚æ­£æ–‡ã€‚å¦‚æœè¯·æ±‚ä¸»ä½“å¤§äºç¼“å†²åŒºï¼Œåˆ™å°†æ•´ä¸ªä¸»ä½“æˆ–ä»…å°†å…¶ä¸€éƒ¨åˆ†å†™å…¥ä¸´æ—¶æ–‡ä»¶ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œç¼“å†²åŒºå¤§å°ç­‰äºä¸¤ä¸ªå†…å­˜é¡µã€‚åœ¨x86ï¼Œå…¶ä»–32ä½å¹³å°å’Œx86-64ä¸Šä¸º8Kã€‚åœ¨å…¶ä»–64ä½å¹³å°ä¸Šï¼Œé€šå¸¸ä¸º16Kã€‚æ­¤æ³¨é‡Šå°†åº”ç”¨äºå…¥å£è§„åˆ™ä¸­æä¾›çš„æ¯ä¸ªä½ç½®ã€‚</p>
<p><strong>æ³¨æ„</strong></p>
<p>æ³¨é‡Šå€¼å¿…é¡»ä»¥Nginxå¯ä»¥ç†è§£çš„æ ¼å¼ç»™å‡ºã€‚</p>
<p>ä¾‹</p>
<ul>
<li><code>nginx.ingress.kubernetes.io/client-body-buffer-size: &quot;1000&quot;</code> ï¼ƒ1000å­—èŠ‚</li>
<li><code>nginx.ingress.kubernetes.io/client-body-buffer-size: 1k</code> ï¼ƒ1åƒå­—èŠ‚</li>
<li><code>nginx.ingress.kubernetes.io/client-body-buffer-size: 1K</code> ï¼ƒ1åƒå­—èŠ‚</li>
<li><code>nginx.ingress.kubernetes.io/client-body-buffer-size: 1m</code> ï¼ƒ1å…†å­—èŠ‚</li>
<li><code>nginx.ingress.kubernetes.io/client-body-buffer-size: 1M</code> ï¼ƒ1å…†å­—èŠ‚</li>
</ul>
<p>æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_core_module.html#client_body_buffer_size">http://nginx.org</a></p>
<h3 id="å¤–éƒ¨è®¤è¯"><a href="#å¤–éƒ¨è®¤è¯" class="headerlink" title="å¤–éƒ¨è®¤è¯"></a>å¤–éƒ¨è®¤è¯</h3><p>è¦ä½¿ç”¨æä¾›èº«ä»½éªŒè¯çš„ç°æœ‰æœåŠ¡ï¼Œå¯ä»¥å¯¹Ingressè§„åˆ™è¿›è¡Œæ³¨é‡Šï¼Œ<code>nginx.ingress.kubernetes.io/auth-url</code>ä»¥æŒ‡ç¤ºåº”å°†HTTPè¯·æ±‚å‘é€åˆ°çš„URLã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/auth-url: &quot;URL to the authentication service&quot;</span><br></pre></td></tr></table></figure>

<p>å¦å¤–ï¼Œå¯ä»¥è®¾ç½®ï¼š</p>
<ul>
<li><code>nginx.ingress.kubernetes.io/auth-method</code>ï¼š <code>&lt;Method&gt;</code>æŒ‡å®šè¦ä½¿ç”¨çš„HTTPæ–¹æ³•ã€‚</li>
<li><code>nginx.ingress.kubernetes.io/auth-signin</code>ï¼š <code>&lt;SignIn_URL&gt;</code>æŒ‡å®šé”™è¯¯é¡µé¢çš„ä½ç½®ã€‚</li>
<li><code>nginx.ingress.kubernetes.io/auth-response-headers</code>ï¼š <code>&lt;Response_Header_1, ..., Response_Header_n&gt;</code>æŒ‡å®šåœ¨èº«ä»½éªŒè¯è¯·æ±‚å®Œæˆåä¼ é€’ç»™åç«¯çš„æ ‡å¤´ã€‚</li>
<li><code>nginx.ingress.kubernetes.io/auth-proxy-set-headers</code>ï¼š <code>&lt;ConfigMap&gt;</code>ConfigMapçš„åç§°ï¼Œè¯¥åç§°æŒ‡å®šè¦ä¼ é€’ç»™èº«ä»½éªŒè¯æœåŠ¡çš„æ ‡å¤´</li>
<li><code>nginx.ingress.kubernetes.io/auth-request-redirect</code>ï¼š <code>&lt;Request_Redirect_URL&gt;</code> æŒ‡å®šX-Auth-Request-Redirectæ ‡å¤´å€¼ã€‚</li>
<li><code>nginx.ingress.kubernetes.io/auth-cache-key</code>ï¼š <code>&lt;Cache_Key&gt;</code>è¿™å°†å¯ç”¨å¯¹èº«ä»½éªŒè¯è¯·æ±‚çš„ç¼“å­˜ã€‚æŒ‡å®šèº«ä»½éªŒè¯å“åº”çš„æŸ¥æ‰¾é”®ã€‚ä¾‹å¦‚<code>$remote_user$http_authorization</code>ã€‚æ¯ä¸ªæœåŠ¡å™¨å’Œä½ç½®éƒ½æœ‰å…¶è‡ªå·±çš„å¯†é’¥ç©ºé—´ã€‚å› æ­¤ï¼Œç¼“å­˜çš„å“åº”ä»…åœ¨æŒ‰æœåŠ¡å™¨å’ŒæŒ‰ä½ç½®çš„åŸºç¡€ä¸Šæœ‰æ•ˆã€‚</li>
<li><code>nginx.ingress.kubernetes.io/auth-cache-duration</code>ï¼š <code>&lt;Cache_duration&gt;</code>æ ¹æ®èº«ä»½éªŒè¯å“åº”çš„å“åº”ä»£ç ï¼ˆä¾‹å¦‚ï¼‰æŒ‡å®šèº«ä»½éªŒè¯å“åº”çš„ç¼“å­˜æ—¶é—´<code>200 202 30m</code>ã€‚æœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_valid">proxy_cache_valid</a>ã€‚æ‚¨å¯ä»¥æŒ‡å®šå¤šä¸ªé€—å·åˆ†éš”çš„å€¼ï¼š<code>200 202 10m, 401 5m</code>ã€‚é»˜è®¤ä¸º<code>200 202 401 5m</code>ã€‚</li>
<li><code>nginx.ingress.kubernetes.io/auth-snippet</code>ï¼š <code>&lt;Auth_Snippet&gt;</code>æŒ‡å®šç”¨äºå¤–éƒ¨èº«ä»½éªŒè¯çš„è‡ªå®šä¹‰ä»£ç æ®µï¼Œä¾‹å¦‚</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/auth-url: http://foo.com/external-auth nginx.ingress.kubernetes.io/auth-snippet: | proxy_set_header Foo-Header 42;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ³¨æ„ï¼š<code>nginx.ingress.kubernetes.io/auth-snippet</code>æ˜¯å¯é€‰æ³¨é‡Šã€‚ä½†æ˜¯ï¼Œå®ƒåªèƒ½ä¸ç»“åˆä½¿ç”¨<code>nginx.ingress.kubernetes.io/auth-url</code>ï¼Œå¦‚æœ<code>nginx.ingress.kubernetes.io/auth-url</code>æœªè®¾ç½®ï¼Œåˆ™å°†è¢«å¿½ç•¥</p>
</blockquote>
<h4 id="å…¨å±€å¤–éƒ¨è®¤è¯"><a href="#å…¨å±€å¤–éƒ¨è®¤è¯" class="headerlink" title="å…¨å±€å¤–éƒ¨è®¤è¯"></a>å…¨å±€å¤–éƒ¨è®¤è¯</h4><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœ<code>global-auth-url</code>åœ¨NGINX ConfigMapä¸­è®¾ç½®ï¼Œåˆ™æ§åˆ¶å™¨ä¼šå°†æ‰€æœ‰è¯·æ±‚é‡å®šå‘åˆ°æä¾›èº«ä»½éªŒè¯çš„ç°æœ‰æœåŠ¡ã€‚å¦‚æœæ‚¨æƒ³ä¸ºè¯¥å…¥å£ç¦ç”¨æ­¤è¡Œä¸ºï¼Œåˆ™å¯ä»¥<code>enable-global-auth: &quot;false&quot;</code>åœ¨NGINX ConfigMapä¸­ä½¿ç”¨ã€‚ <code>nginx.ingress.kubernetes.io/enable-global-auth</code>ï¼šæŒ‡ç¤ºæ˜¯å¦åº”å°†GlobalExternalAuthé…ç½®åº”ç”¨äºæ­¤Ingressè§„åˆ™ã€‚é»˜è®¤å€¼è®¾ç½®ä¸º<code>&quot;true&quot;</code>ã€‚</p>
<h3 id="é™é€Ÿ"><a href="#é™é€Ÿ" class="headerlink" title="é™é€Ÿ"></a>é™é€Ÿ</h3><p>è¿™äº›æ³¨é‡Šå®šä¹‰äº†å¯¹è¿æ¥å’Œä¼ è¾“é€Ÿç‡çš„é™åˆ¶ã€‚è¿™äº›å¯ä»¥ç”¨æ¥å‡è½»<a target="_blank" rel="noopener" href="https://www.nginx.com/blog/mitigating-ddos-attacks-with-nginx-and-nginx-plus">DDoSæ”»å‡»</a>ã€‚</p>
<ul>
<li><code>nginx.ingress.kubernetes.io/limit-connections</code>ï¼šå•ä¸ªIPåœ°å€å…è®¸çš„å¹¶å‘è¿æ¥æ•°ã€‚è¶…å‡ºæ­¤é™åˆ¶æ—¶ï¼Œå°†è¿”å›503é”™è¯¯ã€‚</li>
<li><code>nginx.ingress.kubernetes.io/limit-rps</code>ï¼šæ¯ç§’ä»ç»™å®šIPæ¥å—çš„è¯·æ±‚æ•°ã€‚çªå‘é™åˆ¶è®¾ç½®ä¸ºé™åˆ¶çš„5å€ã€‚å½“å®¢æˆ·ç«¯è¶…è¿‡æ­¤é™åˆ¶æ—¶ï¼Œ <a target="_blank" rel="noopener" href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/#limit-req-status-code">å°†</a> è¿”å›<a target="_blank" rel="noopener" href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/#limit-req-status-code">limit-req-status-code</a> <strong>é»˜è®¤å€¼ï¼š*</strong> 503ã€‚</li>
<li><code>nginx.ingress.kubernetes.io/limit-rpm</code>ï¼šæ¯åˆ†é’Ÿä»ç»™å®šIPæ¥å—çš„è¯·æ±‚æ•°ã€‚çªå‘é™åˆ¶è®¾ç½®ä¸ºé™åˆ¶çš„5å€ã€‚å½“å®¢æˆ·ç«¯è¶…è¿‡æ­¤é™åˆ¶æ—¶ï¼Œ <a target="_blank" rel="noopener" href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/#limit-req-status-code">å°†</a> è¿”å›<a target="_blank" rel="noopener" href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/#limit-req-status-code">limit-req-status-code</a> *<strong>é»˜è®¤å€¼ï¼š*</strong> 503ã€‚</li>
<li><code>nginx.ingress.kubernetes.io/limit-rate-after</code>ï¼šåˆå§‹åƒå­—èŠ‚æ•°ï¼Œä¹‹åå°†è¿›ä¸€æ­¥é™åˆ¶å¯¹ç»™å®šè¿æ¥çš„å“åº”çš„è¿›ä¸€æ­¥ä¼ è¾“ã€‚å¿…é¡»åœ¨å¯ç”¨<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44692256/article/details/108581800#proxy-buffering">ä»£ç†ç¼“å†²çš„æƒ…å†µ</a>ä¸‹ä½¿ç”¨æ­¤åŠŸèƒ½ã€‚</li>
<li><code>nginx.ingress.kubernetes.io/limit-rate</code>ï¼šæ¯ç§’å…è®¸å‘é€åˆ°ç»™å®šè¿æ¥çš„åƒå­—èŠ‚æ•°ã€‚é›¶å€¼ç¦ç”¨é€Ÿç‡é™åˆ¶ã€‚å¿…é¡»åœ¨å¯ç”¨<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44692256/article/details/108581800#proxy-buffering">ä»£ç†ç¼“å†²çš„æƒ…å†µ</a>ä¸‹ä½¿ç”¨æ­¤åŠŸèƒ½ã€‚</li>
<li><code>nginx.ingress.kubernetes.io/limit-whitelist</code>ï¼šå®¢æˆ·ç«¯IPæºèŒƒå›´è¦ä»é€Ÿç‡é™åˆ¶ä¸­æ’é™¤ã€‚è¯¥å€¼æ˜¯é€—å·åˆ†éš”çš„CIDRåˆ—è¡¨ã€‚</li>
</ul>
<p>å¦‚æœä½ åœ¨ä¸€ä¸ªå•ä¸€çš„å…¥å£è§„åˆ™æŒ‡å®šå¤šä¸ªæ³¨é‡Šï¼Œé™åˆ¶åœ¨é¡ºåºåº”ç”¨<code>limit-connections</code>ï¼Œ<code>limit-rpm</code>ï¼Œ<code>limit-rps</code>ã€‚</p>
<p>è¦ä¸ºæ‰€æœ‰Ingressè§„åˆ™å…¨å±€é…ç½®è®¾ç½®ï¼Œå¯ä»¥åœ¨<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44692256/article/configmap/#limit-rate">NGINX ConfigMapä¸­</a>è®¾ç½®<code>limit-rate-after</code>å’Œ<code>limit-rate</code>å€¼ã€‚åœ¨Ingressæ³¨é‡Šä¸­è®¾ç½®çš„å€¼å°†è¦†ç›–å…¨å±€è®¾ç½®ã€‚</p>
<p>å½“å¯ç”¨<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44692256/article/configmap/#use-forwarded-headers">use-forwarded-header</a>æ—¶ï¼Œå°†åŸºäº<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44692256/article/configmap/#use-proxy-protocol">PROXYåè®®</a>çš„ä½¿ç”¨æˆ–ä»<code>X-Forwarded-For</code>æ ‡å¤´å€¼è®¾ç½®å®¢æˆ·ç«¯IPåœ°å€ã€‚</p>
<h3 id="æ°¸ä¹…é‡å®šå‘"><a href="#æ°¸ä¹…é‡å®šå‘" class="headerlink" title="æ°¸ä¹…é‡å®šå‘"></a>æ°¸ä¹…é‡å®šå‘</h3><p>æ­¤æ³¨é‡Šå…è®¸è¿”å›æ°¸ä¹…é‡å®šå‘ï¼Œè€Œä¸æ˜¯å‘ä¸Šæ¸¸å‘é€æ•°æ®ã€‚ä¾‹å¦‚<code>nginx.ingress.kubernetes.io/permanent-redirect: https://www.google.com</code>ï¼Œå°†æ‰€æœ‰å†…å®¹é‡å®šå‘åˆ°Googleã€‚</p>
<h3 id="æ°¸ä¹…é‡å®šå‘ç "><a href="#æ°¸ä¹…é‡å®šå‘ç " class="headerlink" title="æ°¸ä¹…é‡å®šå‘ç "></a>æ°¸ä¹…é‡å®šå‘ç </h3><p>æ­¤æ³¨é‡Šä½¿æ‚¨å¯ä»¥ä¿®æ”¹ç”¨äºæ°¸ä¹…é‡å®šå‘çš„çŠ¶æ€ä»£ç ã€‚ä¾‹å¦‚ï¼Œ<code>nginx.ingress.kubernetes.io/permanent-redirect-code: &#39;308&#39;</code>å°†ä»¥308è¿”å›æ‚¨çš„æ°¸ä¹…é‡å®šå‘ã€‚</p>
<h3 id="Temporal-Redirect"><a href="#Temporal-Redirect" class="headerlink" title="Temporal Redirect"></a>Temporal Redirect</h3><p>æ­¤æ³¨é‡Šä½¿æ‚¨å¯ä»¥è¿”å›æ—¶é—´é‡å®šå‘ï¼ˆè¿”å›ä»£ç 302ï¼‰ï¼Œè€Œä¸æ˜¯å°†æ•°æ®å‘é€åˆ°ä¸Šæ¸¸ã€‚ä¾‹å¦‚<code>nginx.ingress.kubernetes.io/temporal-redirect: https://www.google.com</code>ï¼Œå°†æ‰€æœ‰å†…å®¹é‡å®šå‘åˆ°Googleï¼Œè¿”å›ç ä¸º302ï¼ˆä¸´æ—¶ç§»åŠ¨ï¼‰</p>
<h3 id="SSLç›´é€š"><a href="#SSLç›´é€š" class="headerlink" title="SSLç›´é€š"></a>SSLç›´é€š</h3><p>æ³¨é‡Š<code>nginx.ingress.kubernetes.io/ssl-passthrough</code>æŒ‡ç¤ºæ§åˆ¶å™¨å°†TLSè¿æ¥ç›´æ¥å‘é€åˆ°åç«¯ï¼Œè€Œä¸æ˜¯è®©NGINXè§£å¯†é€šä¿¡ã€‚å¦è¯·å‚é˜…ã€Šç”¨æˆ·æŒ‡å—ã€‹ä¸­çš„<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44692256/tls/#ssl-passthrough">TLS &#x2F; HTTPS</a>ã€‚</p>
<p>SSLç›´é€š<strong>é»˜è®¤æƒ…å†µä¸‹</strong>å¤„äº<strong>ç¦ç”¨çŠ¶æ€ï¼Œ</strong>å¹¶ä¸”éœ€è¦ä½¿ç”¨è¯¥<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44692256/cli-arguments/"><code>--enable-ssl-passthrough</code></a>æ ‡å¿—å¯åŠ¨æ§åˆ¶å™¨ ã€‚</p>
<p>ç”±äºSSL Passthroughåœ¨OSIæ¨¡å‹ï¼ˆTCPï¼‰çš„ç¬¬4å±‚è€Œä¸æ˜¯ç¬¬7å±‚ï¼ˆHTTPï¼‰ä¸Šèµ·ä½œç”¨ï¼Œå› æ­¤ä½¿ç”¨SSL Passthroughä¼šä½¿åœ¨Ingresså¯¹è±¡ä¸Šè®¾ç½®çš„æ‰€æœ‰å…¶ä»–æ³¨é‡Šæ— æ•ˆã€‚</p>
<h3 id="Service-Upstream"><a href="#Service-Upstream" class="headerlink" title="Service Upstream"></a>Service Upstream</h3><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒNGINXå…¥å£æ§åˆ¶å™¨ä½¿ç”¨NGINXä¸Šæ¸¸é…ç½®ä¸­æ‰€æœ‰ç«¯ç‚¹ï¼ˆPod IP &#x2F;ç«¯å£ï¼‰çš„åˆ—è¡¨ã€‚</p>
<p>è¯¥<code>nginx.ingress.kubernetes.io/service-upstream</code>æ³¨é‡Šç¦ç”¨è¯¥è¡Œä¸ºï¼Œè€Œæ˜¯ä½¿ç”¨åœ¨NGINXï¼Œè¯¥æœåŠ¡çš„ç¾¤é›†IPå’Œç«¯å£çš„å•ä¸€ä¸Šæ¸¸ã€‚</p>
<p>è¿™å¯¹äºé›¶åœæœºæ—¶é—´éƒ¨ç½²ä¹‹ç±»çš„äº‹æƒ…å¯èƒ½æ˜¯ç†æƒ³çš„ï¼Œå› ä¸ºå®ƒå‡å°‘äº†Podä¸Šä¸‹æ—¶é‡æ–°åŠ è½½NGINXé…ç½®çš„éœ€æ±‚ã€‚å‚è§é—®é¢˜<a target="_blank" rel="noopener" href="https://github.com/kubernetes/ingress-nginx/issues/257">ï¼ƒ257</a>ã€‚</p>
<h4 id="å·²çŸ¥çš„é—®é¢˜"><a href="#å·²çŸ¥çš„é—®é¢˜" class="headerlink" title="å·²çŸ¥çš„é—®é¢˜"></a>å·²çŸ¥çš„é—®é¢˜</h4><p>å¦‚æœ<code>service-upstream</code>æŒ‡å®šäº†æ³¨é‡Šï¼Œåˆ™åº”è€ƒè™‘ä»¥ä¸‹äº‹é¡¹ï¼š</p>
<ul>
<li>ç²˜æ€§ä¼šè¯å°†ä¸èµ·ä½œç”¨ï¼Œå› ä¸ºä»…æ”¯æŒå¾ªç¯è´Ÿè½½å¹³è¡¡ã€‚</li>
<li>è¯¥<code>proxy_next_upstream</code>æŒ‡ä»¤ä¸ä¼šæœ‰ä»»ä½•å½±å“ï¼Œå› ä¸ºå¦‚æœå‡ºé”™ï¼Œè¯¥è¯·æ±‚å°†ä¸ä¼šåˆ†æ´¾åˆ°å¦ä¸€ä¸ªä¸Šæ¸¸ã€‚</li>
</ul>
<h3 id="é€šè¿‡é‡å®šå‘æ‰§è¡ŒæœåŠ¡å™¨ç«¯HTTPS"><a href="#é€šè¿‡é‡å®šå‘æ‰§è¡ŒæœåŠ¡å™¨ç«¯HTTPS" class="headerlink" title="é€šè¿‡é‡å®šå‘æ‰§è¡ŒæœåŠ¡å™¨ç«¯HTTPS"></a>é€šè¿‡é‡å®šå‘æ‰§è¡ŒæœåŠ¡å™¨ç«¯HTTPS</h3><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœä¸ºè¯¥å…¥å£å¯ç”¨äº†TLSï¼Œåˆ™æ§åˆ¶å™¨å°†é‡å®šå‘ï¼ˆ308ï¼‰åˆ°HTTPSã€‚å¦‚æœè¦å…¨å±€ç¦ç”¨æ­¤è¡Œä¸ºï¼Œå¯ä»¥<code>ssl-redirect: &quot;false&quot;</code>åœ¨NGINX <a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44692256/article/configmap/#ssl-redirect">ConfigMapä¸­ä½¿ç”¨</a>ã€‚</p>
<p>è¦ä¸ºç‰¹å®šçš„å…¥å£èµ„æºé…ç½®æ­¤åŠŸèƒ½ï¼Œå¯ä»¥<code>nginx.ingress.kubernetes.io/ssl-redirect: &quot;false&quot;</code> åœ¨ç‰¹å®šèµ„æºä¸­ä½¿ç”¨æ³¨é‡Šã€‚</p>
<p>åœ¨ç¾¤é›†å¤–éƒ¨ï¼ˆä¾‹å¦‚AWS ELBï¼‰ä¸Šä½¿ç”¨SSLå¸è½½æ—¶ï¼Œå³ä½¿æ²¡æœ‰å¯ç”¨çš„TLSè¯ä¹¦ï¼Œå¼ºåˆ¶æ‰§è¡Œåˆ°HTTPSçš„é‡å®šå‘ä¹Ÿå¯èƒ½å¾ˆæœ‰ç”¨ã€‚è¿™å¯ä»¥é€šè¿‡ä½¿ç”¨<code>nginx.ingress.kubernetes.io/force-ssl-redirect: &quot;true&quot;</code>ç‰¹å®šèµ„æºä¸­çš„æ³¨é‡Šæ¥å®ç°ã€‚</p>
<h3 id="ä»-x2F-é‡å®šå‘åˆ°www"><a href="#ä»-x2F-é‡å®šå‘åˆ°www" class="headerlink" title="ä»&#x2F;é‡å®šå‘åˆ°www"></a>ä»&#x2F;é‡å®šå‘åˆ°www</h3><p>åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œéœ€è¦ä»é‡å®šå‘<code>www.domain.com</code>åˆ°<code>domain.com</code>ï¼Œåä¹‹äº¦ç„¶ã€‚è¦å¯ç”¨æ­¤åŠŸèƒ½ï¼Œè¯·ä½¿ç”¨æ³¨é‡Š<code>nginx.ingress.kubernetes.io/from-to-www-redirect: &quot;true&quot;</code></p>
<p>å¦‚æœåœ¨æŸä¸ªæ—¶å€™åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„Ingressï¼Œä¸”å…¶å®¿ä¸»ç­‰äºé€‰é¡¹ä¹‹ä¸€ï¼ˆå¦‚<code>domain.com</code>ï¼‰ï¼Œåˆ™æ³¨é‡Šå°†è¢«çœç•¥ã€‚</p>
<p>å¯¹äºä»HTTPSåˆ°HTTPSçš„é‡å®šå‘æ˜¯å¼ºåˆ¶æ€§çš„ï¼Œä½äºIngress TLSéƒ¨åˆ†ä¸­çš„Secretä¸­å®šä¹‰çš„SSLè¯ä¹¦åŒ…å«ä¸¤ä¸ªé€šç”¨åç§°çš„FQDNã€‚</p>
<h3 id="ç™½åå•æ¥æºèŒƒå›´"><a href="#ç™½åå•æ¥æºèŒƒå›´" class="headerlink" title="ç™½åå•æ¥æºèŒƒå›´"></a>ç™½åå•æ¥æºèŒƒå›´</h3><p>æ‚¨å¯ä»¥é€šè¿‡<code>nginx.ingress.kubernetes.io/whitelist-source-range</code>æ³¨é‡ŠæŒ‡å®šå…è®¸çš„å®¢æˆ·ç«¯IPæºèŒƒå›´ã€‚è¯¥å€¼æ˜¯é€—å·åˆ†éš”çš„<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing">CIDR</a>åˆ—è¡¨ï¼Œä¾‹å¦‚ <code>10.0.0.0/24,172.10.0.1</code>ã€‚</p>
<p>è¦ä¸ºæ‰€æœ‰Ingressè§„åˆ™å…¨å±€é…ç½®æ­¤è®¾ç½®ï¼Œ<code>whitelist-source-range</code>å¯ä»¥åœ¨<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44692256/article/configmap/#whitelist-source-range">NGINX ConfigMapä¸­</a>è®¾ç½®è¯¥å€¼ã€‚</p>
<p>å‘Ingressè§„åˆ™æ·»åŠ æ³¨é‡Šä¼šè¦†ç›–æ‰€æœ‰å…¨å±€é™åˆ¶ã€‚</p>
<h3 id="è‡ªå®šä¹‰è¶…æ—¶"><a href="#è‡ªå®šä¹‰è¶…æ—¶" class="headerlink" title="è‡ªå®šä¹‰è¶…æ—¶"></a>è‡ªå®šä¹‰è¶…æ—¶</h3><p>ä½¿ç”¨é…ç½®configmapå¯ä»¥ä¸ºä¸ä¸Šæ¸¸æœåŠ¡å™¨çš„è¿æ¥è®¾ç½®é»˜è®¤çš„å…¨å±€è¶…æ—¶ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œè¦æ±‚å…·æœ‰ä¸åŒçš„å€¼ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬æä¾›äº†å…è®¸è¿›è¡Œæ­¤è‡ªå®šä¹‰çš„æ³¨é‡Šï¼š</p>
<ul>
<li><code>nginx.ingress.kubernetes.io/proxy-connect-timeout</code></li>
<li><code>nginx.ingress.kubernetes.io/proxy-send-timeout</code></li>
<li><code>nginx.ingress.kubernetes.io/proxy-read-timeout</code></li>
<li><code>nginx.ingress.kubernetes.io/proxy-next-upstream</code></li>
<li><code>nginx.ingress.kubernetes.io/proxy-next-upstream-timeout</code></li>
<li><code>nginx.ingress.kubernetes.io/proxy-next-upstream-tries</code></li>
<li><code>nginx.ingress.kubernetes.io/proxy-request-buffering</code></li>
</ul>
<h3 id="ä»£ç†é‡å®šå‘"><a href="#ä»£ç†é‡å®šå‘" class="headerlink" title="ä»£ç†é‡å®šå‘"></a>ä»£ç†é‡å®šå‘</h3><p>ä½¿ç”¨æ³¨é‡Š<code>nginx.ingress.kubernetes.io/proxy-redirect-from</code>ï¼Œ<code>nginx.ingress.kubernetes.io/proxy-redirect-to</code>å¯ä»¥åœ¨<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_redirect">ä»£ç†æœåŠ¡å™¨å“åº”</a>çš„<code>Location</code>å’Œ<code>Refresh</code>æ ‡å¤´å­—æ®µä¸­è®¾ç½®åº”æ›´æ”¹çš„æ–‡æœ¬</p>
<p>åœ¨æ³¨é‡Šä¸­è®¾ç½®ä¸ºâ€œ offâ€æˆ–â€œ defaultâ€ <code>nginx.ingress.kubernetes.io/proxy-redirect-from</code>ä¼šç¦ç”¨<code>nginx.ingress.kubernetes.io/proxy-redirect-to</code>ï¼Œå¦åˆ™ï¼Œå¿…é¡»åŒæ—¶ä½¿ç”¨ä¸¤ä¸ªæ³¨é‡Šã€‚è¯·æ³¨æ„ï¼Œæ¯ä¸ªæ³¨é‡Šå¿…é¡»æ˜¯ä¸å¸¦ç©ºæ ¼çš„å­—ç¬¦ä¸²ã€‚</p>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯ä¸ªæ³¨é‡Šçš„å€¼ä¸ºâ€œ offâ€ã€‚</p>
<h3 id="Custom-max-body-size"><a href="#Custom-max-body-size" class="headerlink" title="Custom max body size"></a>Custom max body size</h3><p>å¯¹äºNGINXï¼Œå½“è¯·æ±‚ä¸­çš„å¤§å°è¶…è¿‡å®¢æˆ·ç«¯è¯·æ±‚æ­£æ–‡çš„æœ€å¤§å…è®¸å¤§å°æ—¶ï¼Œå°†å‘å®¢æˆ·ç«¯è¿”å›413é”™è¯¯ã€‚è¯¥å¤§å°å¯ä»¥é€šè¿‡å‚æ•°æ¥é…ç½®<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_core_module.html#client_max_body_size"><code>client_max_body_size</code></a>ã€‚</p>
<p>è¦ä¸ºæ‰€æœ‰Ingressè§„åˆ™å…¨å±€é…ç½®æ­¤è®¾ç½®ï¼Œ<code>proxy-body-size</code>å¯ä»¥åœ¨<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44692256/article/configmap/#proxy-body-size">NGINX ConfigMapä¸­</a>è®¾ç½®è¯¥å€¼ã€‚è¦åœ¨Ingressè§„åˆ™ä¸­ä½¿ç”¨è‡ªå®šä¹‰å€¼ï¼Œè¯·å®šä¹‰ä»¥ä¸‹æ³¨é‡Šï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/proxy-body-size: 8m</span><br></pre></td></tr></table></figure>

<h3 id="ä»£ç†CookieåŸŸ"><a href="#ä»£ç†CookieåŸŸ" class="headerlink" title="ä»£ç†CookieåŸŸ"></a>ä»£ç†CookieåŸŸ</h3><p>è®¾ç½®<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cookie_domain">åº”åœ¨</a>ä»£ç†æœåŠ¡å™¨å“åº”çš„â€œ Set-Cookieâ€æ ‡å¤´å­—æ®µ<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cookie_domain">çš„domainå±æ€§</a>ä¸­<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cookie_domain">æ›´æ”¹</a>çš„æ–‡æœ¬ã€‚</p>
<p>è¦ä¸ºæ‰€æœ‰Ingressè§„åˆ™å…¨å±€é…ç½®æ­¤è®¾ç½®ï¼Œ<code>proxy-cookie-domain</code>å¯ä»¥åœ¨<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44692256/article/configmap/#proxy-cookie-domain">NGINX ConfigMapä¸­</a>è®¾ç½®è¯¥å€¼ã€‚</p>
<h3 id="ä»£ç†Cookieè·¯å¾„"><a href="#ä»£ç†Cookieè·¯å¾„" class="headerlink" title="ä»£ç†Cookieè·¯å¾„"></a>ä»£ç†Cookieè·¯å¾„</h3><p>è®¾ç½®<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cookie_path">åº”åœ¨</a>ä»£ç†æœåŠ¡å™¨å“åº”çš„â€œ Set-Cookieâ€æ ‡å¤´å­—æ®µ<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cookie_path">çš„pathå±æ€§</a>ä¸­<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cookie_path">æ›´æ”¹</a>çš„æ–‡æœ¬ã€‚</p>
<p>è¦ä¸ºæ‰€æœ‰Ingressè§„åˆ™å…¨å±€é…ç½®æ­¤è®¾ç½®ï¼Œ<code>proxy-cookie-path</code>å¯ä»¥åœ¨<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44692256/article/configmap/#proxy-cookie-path">NGINX ConfigMapä¸­</a>è®¾ç½®è¯¥å€¼ã€‚</p>
<h3 id="ä»£ç†ç¼“å†²"><a href="#ä»£ç†ç¼“å†²" class="headerlink" title="ä»£ç†ç¼“å†²"></a>ä»£ç†ç¼“å†²</h3><p>å¯ç”¨æˆ–ç¦ç”¨ä»£ç†ç¼“å†²<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_buffering"><code>proxy_buffering</code></a>ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒNGINXé…ç½®ä¸­ç¦ç”¨ä»£ç†ç¼“å†²ã€‚</p>
<p>è¦ä¸ºæ‰€æœ‰Ingressè§„åˆ™å…¨å±€é…ç½®æ­¤è®¾ç½®ï¼Œ<code>proxy-buffering</code>å¯ä»¥åœ¨<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44692256/article/configmap/#proxy-buffering">NGINX ConfigMapä¸­</a>è®¾ç½®è¯¥å€¼ã€‚è¦åœ¨Ingressè§„åˆ™ä¸­ä½¿ç”¨è‡ªå®šä¹‰å€¼ï¼Œè¯·å®šä¹‰ä»¥ä¸‹æ³¨é‡Šï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/proxy-buffering: &quot;on&quot;</span><br></pre></td></tr></table></figure>

<h3 id="ä»£ç†ç¼“å†²åŒºæ•°"><a href="#ä»£ç†ç¼“å†²åŒºæ•°" class="headerlink" title="ä»£ç†ç¼“å†²åŒºæ•°"></a>ä»£ç†ç¼“å†²åŒºæ•°</h3><p>è®¾ç½®<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_buffers"><code>proxy_buffers</code></a>ç”¨äºè¯»å–ä»ä»£ç†æœåŠ¡å™¨æ¥æ”¶åˆ°çš„å“åº”çš„ç¬¬ä¸€éƒ¨åˆ†çš„ç¼“å†²åŒºæ•°ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œä»£ç†ç¼“å†²åŒºæ•°è®¾ç½®ä¸º4</p>
<p>è¦å…¨å±€é…ç½®æ­¤è®¾ç½®ï¼Œè¯·<code>proxy-buffers-number</code>åœ¨<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44692256/article/configmap/#proxy-buffers-number">NGINX ConfigMapä¸­è¿›è¡Œ</a>è®¾ç½®ã€‚è¦åœ¨Ingressè§„åˆ™ä¸­ä½¿ç”¨è‡ªå®šä¹‰å€¼ï¼Œè¯·å®šä¹‰ä»¥ä¸‹æ³¨é‡Šï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/proxy-buffers-number: &quot;4&quot;</span><br></pre></td></tr></table></figure>

<h3 id="ä»£ç†ç¼“å†²åŒºå¤§å°"><a href="#ä»£ç†ç¼“å†²åŒºå¤§å°" class="headerlink" title="ä»£ç†ç¼“å†²åŒºå¤§å°"></a>ä»£ç†ç¼“å†²åŒºå¤§å°</h3><p>è®¾ç½®<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_buffer_size"><code>proxy_buffer_size</code></a>ç”¨äºè¯»å–ä»ä»£ç†æœåŠ¡å™¨æ¥æ”¶åˆ°çš„å“åº”çš„ç¬¬ä¸€éƒ¨åˆ†çš„ç¼“å†²åŒºçš„å¤§å°ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œä»£ç†ç¼“å†²åŒºå¤§å°è®¾ç½®ä¸ºâ€œ 4kâ€</p>
<p>è¦å…¨å±€é…ç½®æ­¤è®¾ç½®ï¼Œè¯·<code>proxy-buffer-size</code>åœ¨<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44692256/article/configmap/#proxy-buffer-size">NGINX ConfigMapä¸­è¿›è¡Œ</a>è®¾ç½®ã€‚è¦åœ¨Ingressè§„åˆ™ä¸­ä½¿ç”¨è‡ªå®šä¹‰å€¼ï¼Œè¯·å®šä¹‰ä»¥ä¸‹æ³¨é‡Šï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/proxy-buffer-size: &quot;8k&quot;</span><br></pre></td></tr></table></figure>

<h3 id="ä»£ç†æœ€å¤§ä¸´æ—¶æ–‡ä»¶å¤§å°"><a href="#ä»£ç†æœ€å¤§ä¸´æ—¶æ–‡ä»¶å¤§å°" class="headerlink" title="ä»£ç†æœ€å¤§ä¸´æ—¶æ–‡ä»¶å¤§å°"></a>ä»£ç†æœ€å¤§ä¸´æ—¶æ–‡ä»¶å¤§å°</h3><p>å¦‚æœ<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_buffering"><code>buffering</code></a>å¯ç”¨äº†æ¥è‡ªä»£ç†æœåŠ¡å™¨çš„å“åº”ï¼Œå¹¶ä¸”æ•´ä¸ªå“åº”ä¸é€‚åˆé€šè¿‡<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_buffer_size"><code>proxy_buffer_size</code></a>å’Œ<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_buffers"><code>proxy_buffers</code></a>æŒ‡ä»¤è®¾ç½®çš„ç¼“å†²åŒºï¼Œåˆ™å¯ä»¥å°†å“åº”çš„ä¸€éƒ¨åˆ†ä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶ä¸­ã€‚æ­¤ä¼ªæŒ‡ä»¤è®¾ç½®<code>size</code>ä¸´æ—¶æ–‡ä»¶çš„æœ€å¤§å€¼ï¼Œè®¾ç½®ä¸º<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_max_temp_file_size"><code>proxy_max_temp_file_size</code></a>ã€‚ä¸€æ¬¡å†™å…¥ä¸´æ—¶æ–‡ä»¶çš„æ•°æ®å¤§å°ç”±<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_temp_file_write_size"><code>proxy_temp_file_write_size</code></a>æŒ‡ä»¤è®¾ç½®ã€‚</p>
<p>é›¶å€¼ç¦ç”¨å¯¹ä¸´æ—¶æ–‡ä»¶çš„å“åº”çš„ç¼“å†²ã€‚</p>
<p>è¦åœ¨Ingressè§„åˆ™ä¸­ä½¿ç”¨è‡ªå®šä¹‰å€¼ï¼Œè¯·å®šä¹‰ä»¥ä¸‹æ³¨é‡Šï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/proxy-max-temp-file-size: &quot;1024m&quot;</span><br></pre></td></tr></table></figure>

<h3 id="ä»£ç†HTTPç‰ˆæœ¬"><a href="#ä»£ç†HTTPç‰ˆæœ¬" class="headerlink" title="ä»£ç†HTTPç‰ˆæœ¬"></a>ä»£ç†HTTPç‰ˆæœ¬</h3><p>ä½¿ç”¨æ­¤æ³¨é‡Šè®¾ç½®<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_http_version"><code>proxy_http_version</code></a>Nginxåå‘ä»£ç†å°†ç”¨äºä¸åç«¯é€šä¿¡çš„ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒè®¾ç½®ä¸ºâ€œ 1.1â€ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/proxy-http-version: &quot;1.0&quot;</span><br></pre></td></tr></table></figure>

<h3 id="SSLå¯†ç "><a href="#SSLå¯†ç " class="headerlink" title="SSLå¯†ç "></a>SSLå¯†ç </h3><p>æŒ‡å®š<a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_ssl_module.html#ssl_ciphers">å¯ç”¨çš„å¯†ç </a>ã€‚</p>
<p>ä½¿ç”¨æ­¤æ³¨é‡Šå°†<code>ssl_ciphers</code>åœ¨æœåŠ¡å™¨çº§åˆ«è®¾ç½®æŒ‡ä»¤ã€‚è¯¥é…ç½®å¯¹ä¸»æœºä¸­çš„æ‰€æœ‰è·¯å¾„å‡æœ‰æ•ˆã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/ssl-ciphers: &quot;ALL:!aNULL:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP&quot;</span><br></pre></td></tr></table></figure>

<h3 id="è¿æ¥ä»£ç†å¤´"><a href="#è¿æ¥ä»£ç†å¤´" class="headerlink" title="è¿æ¥ä»£ç†å¤´"></a>è¿æ¥ä»£ç†å¤´</h3><p>ä½¿ç”¨æ­¤æ³¨é‡Šå°†è¦†ç›–NGINXè®¾ç½®çš„é»˜è®¤è¿æ¥å¤´ã€‚è¦åœ¨Ingressè§„åˆ™ä¸­ä½¿ç”¨è‡ªå®šä¹‰å€¼ï¼Œè¯·å®šä¹‰æ³¨é‡Šï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/connection-proxy-header: &quot;keep-alive&quot;</span><br></pre></td></tr></table></figure>

<h3 id="å¯ç”¨è®¿é—®æ—¥å¿—"><a href="#å¯ç”¨è®¿é—®æ—¥å¿—" class="headerlink" title="å¯ç”¨è®¿é—®æ—¥å¿—"></a>å¯ç”¨è®¿é—®æ—¥å¿—</h3><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œè®¿é—®æ—¥å¿—å¤„äºå¯ç”¨çŠ¶æ€ï¼Œä½†åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¯èƒ½éœ€è¦é’ˆå¯¹ç»™å®šçš„å…¥å£ç¦ç”¨è®¿é—®æ—¥å¿—ã€‚ä¸ºæ­¤ï¼Œè¯·ä½¿ç”¨æ³¨é‡Šï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/enable-access-log: &quot;false&quot;</span><br></pre></td></tr></table></figure>

<h3 id="å¯ç”¨é‡å†™æ—¥å¿—"><a href="#å¯ç”¨é‡å†™æ—¥å¿—" class="headerlink" title="å¯ç”¨é‡å†™æ—¥å¿—"></a>å¯ç”¨é‡å†™æ—¥å¿—</h3><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œæœªå¯ç”¨é‡å†™æ—¥å¿—ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¯èƒ½éœ€è¦å¯ç”¨NGINXé‡å†™æ—¥å¿—ã€‚è¯·æ³¨æ„ï¼Œé‡å†™æ—¥å¿—å°†åœ¨é€šçŸ¥çº§åˆ«å‘é€åˆ°error_logæ–‡ä»¶ã€‚è¦å¯ç”¨æ­¤åŠŸèƒ½ï¼Œè¯·ä½¿ç”¨æ³¨é‡Šï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/enable-rewrite-log: &quot;true&quot;</span><br></pre></td></tr></table></figure>

<h3 id="å¯ç”¨å¼€æ”¾è¿½è¸ª"><a href="#å¯ç”¨å¼€æ”¾è¿½è¸ª" class="headerlink" title="å¯ç”¨å¼€æ”¾è¿½è¸ª"></a>å¯ç”¨å¼€æ”¾è¿½è¸ª</h3><p>å¯ä»¥é€šè¿‡ConfigMapåœ¨å…¨å±€èŒƒå›´å†…å¯ç”¨æˆ–ç¦ç”¨Opentracingï¼Œä½†æ˜¯æœ‰æ—¶éœ€è¦é‡å†™å®ƒæ‰èƒ½å¯ç”¨å®ƒæˆ–é’ˆå¯¹ç‰¹å®šå…¥å£ç¦ç”¨å®ƒï¼ˆä¾‹å¦‚ï¼Œå…³é—­å¯¹å¤–éƒ¨è¿è¡ŒçŠ¶å†µæ£€æŸ¥ç«¯ç‚¹çš„è·Ÿè¸ªï¼‰</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/enable-opentracing: &quot;true&quot;</span><br></pre></td></tr></table></figure>

<h3 id="Xè½¬å‘å‰ç¼€æŠ¥å¤´"><a href="#Xè½¬å‘å‰ç¼€æŠ¥å¤´" class="headerlink" title="Xè½¬å‘å‰ç¼€æŠ¥å¤´"></a>Xè½¬å‘å‰ç¼€æŠ¥å¤´</h3><p>è¦<code>X-Forwarded-Prefix</code>ä½¿ç”¨å­—ç¬¦ä¸²å€¼å°†éæ ‡å‡†æ ‡å¤´æ·»åŠ åˆ°ä¸Šæ¸¸è¯·æ±‚ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ³¨é‡Šï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/x-forwarded-prefix: &quot;/path&quot;</span><br></pre></td></tr></table></figure>

<h3 id="ModSecurity"><a href="#ModSecurity" class="headerlink" title="ModSecurity"></a>ModSecurity</h3><p><a target="_blank" rel="noopener" href="http://modsecurity.org/">ModSecurity</a>æ˜¯ä¸€ä¸ªå¼€æºWebåº”ç”¨ç¨‹åºé˜²ç«å¢™ã€‚å¯ä»¥ä¸ºä¸€ç»„ç‰¹å®šçš„å…¥å£ä½ç½®å¯ç”¨å®ƒã€‚é¦–å…ˆå¿…é¡»é€šè¿‡åœ¨<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44692256/article/configmap/#enable-modsecurity">ConfigMapä¸­</a>å¯ç”¨ModSecurityæ¥å¯ç”¨ModSecurityæ¨¡å— ã€‚è¯·æ³¨æ„ï¼Œè¿™å°†ä¸ºæ‰€æœ‰è·¯å¾„å¯ç”¨ModSecurityï¼Œå¹¶ä¸”å¿…é¡»æ‰‹åŠ¨ç¦ç”¨æ¯ä¸ªè·¯å¾„ã€‚</p>
<p>å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ³¨é‡Šå¯ç”¨å®ƒï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/enable-modsecurity: &quot;true&quot;</span><br></pre></td></tr></table></figure>

<p>ModSecurityå°†ä½¿ç”¨<a target="_blank" rel="noopener" href="https://github.com/SpiderLabs/ModSecurity/blob/v3/master/modsecurity.conf-recommended">æ¨èçš„é…ç½®</a>ä»¥â€œä»…æ£€æµ‹â€æ¨¡å¼<a target="_blank" rel="noopener" href="https://github.com/SpiderLabs/ModSecurity/blob/v3/master/modsecurity.conf-recommended">è¿è¡Œ</a>ã€‚</p>
<p>æ‚¨å¯ä»¥é€šè¿‡è®¾ç½®ä»¥ä¸‹æ³¨é‡Šæ¥å¯ç”¨<a target="_blank" rel="noopener" href="https://www.modsecurity.org/CRS/Documentation/">OWASPæ ¸å¿ƒè§„åˆ™é›†</a>ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/enable-owasp-core-rules: &quot;true&quot;</span><br></pre></td></tr></table></figure>

<p>æ‚¨å¯ä»¥é€šè¿‡è®¾ç½®ä»¥ä¸‹å†…å®¹ä»nginxä¼ é€’transactionIDï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/modsecurity-transaction-id: &quot;$request_id&quot;</span><br></pre></td></tr></table></figure>

<p>æ‚¨è¿˜å¯ä»¥é€šè¿‡ä»£ç æ®µæ·»åŠ è‡ªå·±çš„modsecurityè§„åˆ™é›†ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/modsecurity-snippet: | SecRuleEngine On SecDebugLog /tmp/modsec_debug.log</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„ï¼šå¦‚æœåŒæ—¶ä½¿ç”¨<code>enable-owasp-core-rules</code>å’Œå’Œ<code>modsecurity-snippet</code>æ‰¹æ³¨ï¼Œåˆ™åªæœ‰ <code>modsecurity-snippet</code>ä¼šç”Ÿæ•ˆã€‚å¦‚æœè¦åŒ…æ‹¬<a target="_blank" rel="noopener" href="https://www.modsecurity.org/CRS/Documentation/">OWASPæ ¸å¿ƒè§„åˆ™é›†</a>æˆ– <a target="_blank" rel="noopener" href="https://github.com/SpiderLabs/ModSecurity/blob/v3/master/modsecurity.conf-recommended">å»ºè®®çš„é…ç½®ï¼Œ</a>åªéœ€ä½¿ç”¨includeè¯­å¥ï¼š</p>
<p>nginx 0.24.1åŠä»¥ä¸‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/modsecurity-snippet: | Include /etc/nginx/owasp-modsecurity-crs/nginx-modsecurity.conf Include /etc/nginx/modsecurity/modsecurity.conf</span><br></pre></td></tr></table></figure>

<p>nginx 0.25.0åŠæ›´é«˜ç‰ˆæœ¬</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/modsecurity-snippet: | Include /etc/nginx/owasp-modsecurity-crs/nginx-modsecurity.conf</span><br></pre></td></tr></table></figure>

<h3 id="InfluxDB"><a href="#InfluxDB" class="headerlink" title="InfluxDB"></a>InfluxDB</h3><p>ä½¿ç”¨<code>influxdb-*</code>æ‰¹æ³¨ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<a target="_blank" rel="noopener" href="https://github.com/influxdata/nginx-influxdb-module/">nginx-influxdb-module</a>å°†è¯·æ±‚å‘é€åˆ°æš´éœ²UDPå¥—æ¥å­—çš„InfluxDBåç«¯ï¼Œä»è€Œç›‘è§†é€šè¿‡ä½ç½®çš„è¯·æ±‚ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/enable-influxdb: &quot;true&quot; nginx.ingress.kubernetes.io/influxdb-measurement: &quot;nginx-reqs&quot; nginx.ingress.kubernetes.io/influxdb-port: &quot;8089&quot; nginx.ingress.kubernetes.io/influxdb-host: &quot;127.0.0.1&quot; nginx.ingress.kubernetes.io/influxdb-server-name: &quot;nginx-ingress&quot;</span><br></pre></td></tr></table></figure>

<p>å¯¹äº<code>influxdb-host</code>å‚æ•°ï¼Œæ‚¨æœ‰ä¸¤ä¸ªé€‰æ‹©ï¼š</p>
<ul>
<li>ä½¿ç”¨é…ç½®ä¸ºå¯ç”¨<a target="_blank" rel="noopener" href="https://docs.influxdata.com/influxdb/v1.5/supported_protocols/udp/">UDPåè®®</a>çš„InfluxDBæœåŠ¡å™¨ ã€‚</li>
<li>å°†Telegrafä½œä¸ºSidecarä»£ç†éƒ¨ç½²åˆ°Ingressæ§åˆ¶å™¨ï¼Œè¯¥æ§åˆ¶å™¨é…ç½®ä¸ºä½¿ç”¨<a target="_blank" rel="noopener" href="https://github.com/influxdata/telegraf/tree/release-1.6/plugins/inputs/socket_listener">å¥—æ¥å­—ä¾¦å¬å™¨è¾“å…¥</a>ä¾¦å¬UDPï¼Œå¹¶ä½¿ç”¨ä»»ä½•<a target="_blank" rel="noopener" href="https://github.com/influxdata/telegraf/tree/release-1.7/plugins/outputs">è¾“å‡ºæ’ä»¶ï¼ˆ</a>ä¾‹å¦‚InfluxDBï¼ŒApache Kafkaï¼ŒPrometheusç­‰ï¼‰è¿›è¡Œå†™å…¥ã€‚ï¼ˆæ¨èï¼‰</li>
</ul>
<p>é‡è¦çš„æ˜¯è¦è®°ä½ï¼Œæ­¤é˜¶æ®µæ²¡æœ‰DNSè§£æå™¨ï¼Œå› æ­¤æ‚¨å¿…é¡»å°†IPåœ°å€é…ç½®ä¸º<code>nginx.ingress.kubernetes.io/influxdb-host</code>ã€‚å¦‚æœå°†Influxæˆ–Telegraféƒ¨ç½²ä¸ºSidecarï¼ˆåŒä¸€åŠèˆ±ä¸­çš„å¦ä¸€ä¸ªå®¹å™¨ï¼‰ï¼Œè¿™å°†å˜å¾—å¾ˆç®€å•ï¼Œå› ä¸ºæ‚¨å¯ä»¥ç›´æ¥ä½¿ç”¨<code>127.0.0.1</code>ã€‚</p>
<h3 id="åç«¯åè®®"><a href="#åç«¯åè®®" class="headerlink" title="åç«¯åè®®"></a>åç«¯åè®®</h3><p>ä½¿ç”¨<code>backend-protocol</code>æ³¨é‡Šå¯ä»¥æŒ‡ç¤ºNGINXåº”å¦‚ä½•ä¸åç«¯æœåŠ¡é€šä¿¡ã€‚ï¼ˆ<code>secure-backends</code>åœ¨æ—§ç‰ˆæœ¬ä¸­æ›¿æ¢ï¼‰æœ‰æ•ˆå€¼ï¼šHTTPï¼ŒHTTPSï¼ŒGRPCï¼ŒGRPCSå’ŒAJP</p>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒNGINXä½¿ç”¨<code>HTTP</code>ã€‚</p>
<p>ä¾‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/backend-protocol: &quot;HTTPS&quot;</span><br></pre></td></tr></table></figure>

<h3 id="ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼"><a href="#ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼" class="headerlink" title="ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼"></a>ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼</h3><p>æ³¨æ„</p>
<p>å½“å°†æ­¤æ³¨é‡Šä¸<code>nginx.ingress.kubernetes.io/affinity</code>ç±»å‹ä¸ºNGINXçš„æ³¨é‡Šä¸€èµ·ä½¿ç”¨æ—¶<code>cookie</code>ï¼Œ <code>nginx.ingress.kubernetes.io/session-cookie-path</code>è¿˜å¿…é¡»è®¾ç½®ï¼›ä¼šè¯Cookieè·¯å¾„ä¸æ”¯æŒæ­£åˆ™è¡¨è¾¾å¼ã€‚</p>
<p>ä½¿ç”¨<code>nginx.ingress.kubernetes.io/use-regex</code>æ³¨é‡Šå°†æŒ‡ç¤ºIngressä¸Šå®šä¹‰çš„è·¯å¾„æ˜¯å¦ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ã€‚é»˜è®¤å€¼ä¸º<code>false</code>ã€‚</p>
<p>ä¸‹é¢å°†æŒ‡ç¤ºæ­£åœ¨ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼è·¯å¾„ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/use-regex: &quot;true&quot;</span><br></pre></td></tr></table></figure>

<p>ä»¥ä¸‹å†…å®¹å°†æŒ‡ç¤º<strong>æœª</strong>ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼è·¯å¾„ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/use-regex: &quot;false&quot;</span><br></pre></td></tr></table></figure>

<p>å½“æ­¤æ‰¹æ³¨è®¾ç½®ä¸ºæ—¶<code>true</code>ï¼Œä¸åŒºåˆ†å¤§å°å†™çš„æ­£åˆ™è¡¨è¾¾å¼<a target="_blank" rel="noopener" href="https://nginx.org/en/docs/http/ngx_http_core_module.html#location">ä½ç½®ä¿®é¥°ç¬¦</a>å°†åœ¨ç»™å®šä¸»æœºçš„æ‰€æœ‰è·¯å¾„ä¸Šå¼ºåˆ¶æ‰§è¡Œï¼Œæ— è®ºå®ƒä»¬å®šä¹‰åœ¨ä»€ä¹ˆIngressä¸Šã€‚</p>
<p>æ­¤å¤–ï¼Œå¦‚æœåœ¨ç»™å®šä¸»æœºçš„ä»»ä½•Ingressä¸Šä½¿ç”¨äº†<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44692256/article/details/108581800#rewrite"><code>rewrite-target</code>æ³¨é‡Š</a>ï¼Œåˆ™ä¸åŒºåˆ†å¤§å°å†™çš„æ­£åˆ™è¡¨è¾¾å¼<a target="_blank" rel="noopener" href="https://nginx.org/en/docs/http/ngx_http_core_module.html#location">ä½ç½®ä¿®é¥°ç¬¦</a>å°†åœ¨ç»™å®šä¸»æœºçš„æ‰€æœ‰è·¯å¾„ä¸Šå¼ºåˆ¶æ‰§è¡Œï¼Œæ— è®ºå®ƒä»¬å®šä¹‰åœ¨ä»€ä¹ˆIngressä¸Šã€‚</p>
<p>åœ¨ä½¿ç”¨æ­¤ä¿®é¥°ç¬¦ä¹‹å‰ï¼Œè¯·é˜…è¯»æœ‰å…³<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44692256/ingress-path-matching/">å…¥å£è·¯å¾„åŒ¹é…çš„ä¿¡æ¯</a>ã€‚</p>
<h3 id="Satisfy"><a href="#Satisfy" class="headerlink" title="Satisfy"></a>Satisfy</h3><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œè¯·æ±‚å°†éœ€è¦æ»¡è¶³æ‰€æœ‰èº«ä»½éªŒè¯è¦æ±‚æ‰èƒ½è¢«å…è®¸ã€‚é€šè¿‡ä½¿ç”¨æ­¤æ‰¹æ³¨ï¼ŒåŸºäºé…ç½®å€¼ï¼Œå…è®¸æ»¡è¶³ä»»ä½•æˆ–æ‰€æœ‰èº«ä»½éªŒè¯è¦æ±‚çš„è¯·æ±‚ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/satisfy: &quot;any&quot;</span><br></pre></td></tr></table></figure>

<h3 id="Mirror"><a href="#Mirror" class="headerlink" title="Mirror"></a>Mirror</h3><p>å…è®¸å°†è¯·æ±‚é•œåƒåˆ°é•œåƒåç«¯ã€‚é•œåƒåç«¯çš„å“åº”å°†è¢«å¿½ç•¥ã€‚æ­¤åŠŸèƒ½å¾ˆæœ‰ç”¨ï¼Œå¯ä»¥æŸ¥çœ‹è¯·æ±‚åœ¨â€œæµ‹è¯•â€åç«¯ä¸­çš„ååº”ã€‚</p>
<p>å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è®¾ç½®é•œåƒåç«¯ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/mirror-target: https://test.env.com/$request_uri</span><br></pre></td></tr></table></figure>

<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œè¯·æ±‚æ­£æ–‡å‘é€åˆ°é•œåƒåç«¯ï¼Œä½†å¯ä»¥é€šè¿‡åº”ç”¨ä»¥ä¸‹å‘½ä»¤å°†å…¶å…³é—­ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/mirror-request-body: &quot;off&quot;</span><br></pre></td></tr></table></figure>

<p><strong>æ³¨æ„ï¼š</strong> mirroræŒ‡ä»¤å°†åº”ç”¨äºå…¥å£èµ„æºå†…çš„æ‰€æœ‰è·¯å¾„ã€‚</p>
<p>å‘é€åˆ°é•œåƒçš„è¯·æ±‚é“¾æ¥åˆ°åŸå§‹è¯·æ±‚ã€‚å¦‚æœæ‚¨çš„é•œåƒåç«¯é€Ÿåº¦è¾ƒæ…¢ï¼Œåˆ™åŸå§‹è¯·æ±‚å°†å—åˆ°é™åˆ¶ã€‚</p>
<p>æœ‰å…³é•œåƒæ¨¡å—çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§<a target="_blank" rel="noopener" href="https://nginx.org/en/docs/http/ngx_http_mirror_module.html">ngx_http_mirror_module</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="https://wangyyovo.github.io">Blank</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="https://wangyyovo.github.io/posts/5b4d812a/">https://wangyyovo.github.io/posts/5b4d812a/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥è‡ª <a href="https://wangyyovo.github.io" target="_blank">Blank</a>ï¼</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/k8s/">k8s</a></div><div class="post_share"><div class="social-share" data-image="https://raw.githubusercontents.com/wangyyovo/CDN/master/cover/common/7ad9570c1892b128f84b9971f7946fc4.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/ShareJS/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/ShareJS/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/168b0f7a/"><img class="prev-cover" src="https://raw.githubusercontents.com/wangyyovo/CDN/master/cover/common/7.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info">ç»†æ•°TSä¸­é‚£äº›å¥‡æ€ªçš„ç¬¦å·</div></div></a></div><div class="next-post pull-right"><a href="/posts/38d4c25a/"><img class="next-cover" src="https://raw.githubusercontents.com/wangyyovo/CDN/master/cover/common/0f2f8f38bdbff3a5f2b97f26b7ce3752.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info">Nginx Ingressé…ç½®æ˜ å°„ConfigMap</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>ç›¸å…³æ¨è</span></div><div class="relatedPosts-list"><div><a href="/posts/38d4c25a/" title="Nginx Ingressé…ç½®æ˜ å°„ConfigMap"><img class="cover" src="https://raw.githubusercontents.com/wangyyovo/CDN/master/cover/common/0f2f8f38bdbff3a5f2b97f26b7ce3752.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-06-10</div><div class="title">Nginx Ingressé…ç½®æ˜ å°„ConfigMap</div></div></a></div><div><a href="/posts/4353b432/" title="k8sæš´éœ²æœåŠ¡çš„æ–¹å¼"><img class="cover" src="https://raw.githubusercontents.com/wangyyovo/CDN/master/cover/common/181a3c44c19e44a7e153e74abee69a73.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-06-04</div><div class="title">k8sæš´éœ²æœåŠ¡çš„æ–¹å¼</div></div></a></div><div><a href="/posts/a4bf172f/" title="k8sé›†ç¾¤ä¸‰ç§IP"><img class="cover" src="https://raw.githubusercontents.com/wangyyovo/CDN/master/cover/common/57ee6e1c332782e5197f87bccd943163.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-06-03</div><div class="title">k8sé›†ç¾¤ä¸‰ç§IP</div></div></a></div><div><a href="/posts/3b3f4264/" title="k8sç«¯å£è§£æ"><img class="cover" src="https://raw.githubusercontents.com/wangyyovo/CDN/master/cover/common/dfa29b427f1ebb18c78bae22446b062d.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-06-03</div><div class="title">k8sç«¯å£è§£æ</div></div></a></div><div><a href="/posts/a7f60f63/" title="ArgoCDæŒç»­éƒ¨ç½²"><img class="cover" src="https://raw.githubusercontents.com/wangyyovo/CDN/master/cover/common/5.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-06-01</div><div class="title">ArgoCDæŒç»­éƒ¨ç½²</div></div></a></div><div><a href="/posts/438c4ffb/" title="k8sé«˜å¯ç”¨é›†ç¾¤éƒ¨ç½²"><img class="cover" src="https://raw.githubusercontents.com/wangyyovo/CDN/master/cover/common/9.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-05-31</div><div class="title">k8sé«˜å¯ç”¨é›†ç¾¤éƒ¨ç½²</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> è¯„è®º</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://raw.githubusercontents.com/wangyyovo/CDN/master/theme/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Blank</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">356</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">36</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">54</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/wangyyovo" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:xxxxxx@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fas fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>å…¬å‘Š</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Nginx-Ingress%E6%B3%A8%E8%A7%A3Annotations"><span class="toc-text">Nginx Ingressæ³¨è§£Annotations</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81Nginx%E5%8E%9F%E7%94%9F%E9%85%8D%E7%BD%AE%E6%8C%87%E4%BB%A4"><span class="toc-text">1ã€NginxåŸç”Ÿé…ç½®æŒ‡ä»¤</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E9%80%9A%E7%94%A8%E9%85%8D%E7%BD%AE"><span class="toc-text">2ã€é€šç”¨é…ç½®</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6"><span class="toc-text">3ã€è®¿é—®æ§åˆ¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E8%AE%A4%E8%AF%81%E7%AE%A1%E7%90%86"><span class="toc-text">4ã€è®¤è¯ç®¡ç†</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5%E3%80%81%E8%B7%A8%E5%9F%9F%E8%AE%BF%E9%97%AE"><span class="toc-text">5ã€è·¨åŸŸè®¿é—®</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6%E3%80%81%E4%BB%A3%E7%90%86%E9%85%8D%E7%BD%AE"><span class="toc-text">6ã€ä»£ç†é…ç½®</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7%E3%80%81%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-text">7ã€è´Ÿè½½å‡è¡¡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8%E3%80%81%E4%BC%9A%E8%AF%9D%E4%BF%9D%E6%8C%81%E9%85%8D%E7%BD%AE"><span class="toc-text">8ã€ä¼šè¯ä¿æŒé…ç½®</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9%E3%80%81HTTPS%E9%85%8D%E7%BD%AE"><span class="toc-text">9ã€HTTPSé…ç½®</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10%E3%80%81%E2%80%9C%E9%87%91%E4%B8%9D%E9%9B%80%E2%80%9D%E5%8F%91%E5%B8%83"><span class="toc-text">10ã€â€œé‡‘ä¸é›€â€å‘å¸ƒ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11%E3%80%81lua-resty-waf%E6%A8%A1%E5%9D%97"><span class="toc-text">11ã€lua-resty-wafæ¨¡å—</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12%E3%80%81ModSecurity%E6%A8%A1%E5%9D%97%E9%85%8D%E7%BD%AE"><span class="toc-text">12ã€ModSecurityæ¨¡å—é…ç½®</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13%E3%80%81Influxdb%E6%A8%A1%E5%9D%97%E9%85%8D%E7%BD%AE"><span class="toc-text">13ã€Influxdbæ¨¡å—é…ç½®</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%B4%E6%98%8E"><span class="toc-text">è¯´æ˜</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%91%E4%B8%9D%E9%9B%80"><span class="toc-text">é‡‘ä¸é›€</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Rewrite"><span class="toc-text">Rewrite</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Session-Affinity"><span class="toc-text">Session Affinity</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Cookie-Affinity"><span class="toc-text">Cookie Affinity</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81%E6%96%B9%E5%BC%8F"><span class="toc-text">è®¤è¯æ–¹å¼</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89NGINX%E4%B8%8A%E6%B8%B8%E5%93%88%E5%B8%8C"><span class="toc-text">è‡ªå®šä¹‰NGINXä¸Šæ¸¸å“ˆå¸Œ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89NGINX%E8%B4%9F%E8%BD%BD%E5%B9%B3%E8%A1%A1"><span class="toc-text">è‡ªå®šä¹‰NGINXè´Ÿè½½å¹³è¡¡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89NGINX%E4%B8%8A%E6%B8%B8%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA"><span class="toc-text">è‡ªå®šä¹‰NGINXä¸Šæ¸¸è™šæ‹Ÿä¸»æœº</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AF%81%E4%B9%A6%E8%AE%A4%E8%AF%81"><span class="toc-text">å®¢æˆ·ç«¯è¯ä¹¦è®¤è¯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8E%E7%AB%AF%E8%AF%81%E4%B9%A6%E8%AE%A4%E8%AF%81"><span class="toc-text">åç«¯è¯ä¹¦è®¤è¯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%89%87%E6%AE%B5"><span class="toc-text">é…ç½®ç‰‡æ®µ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89HTTP%E9%94%99%E8%AF%AF"><span class="toc-text">è‡ªå®šä¹‰HTTPé”™è¯¯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%BB%98%E8%AE%A4%E5%90%8E%E7%AB%AF"><span class="toc-text">é»˜è®¤åç«¯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E7%94%A8CORS"><span class="toc-text">å¯ç”¨CORS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTP2%E6%8E%A8%E9%80%81%E9%A2%84%E5%8A%A0%E8%BD%BD%E3%80%82"><span class="toc-text">HTTP2æ¨é€é¢„åŠ è½½ã€‚</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%88%AB%E5%90%8D"><span class="toc-text">æœåŠ¡å™¨åˆ«å</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Server-Snippet%E6%AE%B5"><span class="toc-text">Server Snippetæ®µ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%B8%BB%E4%BD%93%E7%BC%93%E5%86%B2%E5%8C%BA%E5%A4%A7%E5%B0%8F"><span class="toc-text">å®¢æˆ·ç«¯ä¸»ä½“ç¼“å†²åŒºå¤§å°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%96%E9%83%A8%E8%AE%A4%E8%AF%81"><span class="toc-text">å¤–éƒ¨è®¤è¯</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E5%A4%96%E9%83%A8%E8%AE%A4%E8%AF%81"><span class="toc-text">å…¨å±€å¤–éƒ¨è®¤è¯</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%99%90%E9%80%9F"><span class="toc-text">é™é€Ÿ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B0%B8%E4%B9%85%E9%87%8D%E5%AE%9A%E5%90%91"><span class="toc-text">æ°¸ä¹…é‡å®šå‘</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B0%B8%E4%B9%85%E9%87%8D%E5%AE%9A%E5%90%91%E7%A0%81"><span class="toc-text">æ°¸ä¹…é‡å®šå‘ç </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Temporal-Redirect"><span class="toc-text">Temporal Redirect</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SSL%E7%9B%B4%E9%80%9A"><span class="toc-text">SSLç›´é€š</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Service-Upstream"><span class="toc-text">Service Upstream</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B7%B2%E7%9F%A5%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-text">å·²çŸ¥çš„é—®é¢˜</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E9%87%8D%E5%AE%9A%E5%90%91%E6%89%A7%E8%A1%8C%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AFHTTPS"><span class="toc-text">é€šè¿‡é‡å®šå‘æ‰§è¡ŒæœåŠ¡å™¨ç«¯HTTPS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8E-x2F-%E9%87%8D%E5%AE%9A%E5%90%91%E5%88%B0www"><span class="toc-text">ä»&#x2F;é‡å®šå‘åˆ°www</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%99%BD%E5%90%8D%E5%8D%95%E6%9D%A5%E6%BA%90%E8%8C%83%E5%9B%B4"><span class="toc-text">ç™½åå•æ¥æºèŒƒå›´</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%B6%85%E6%97%B6"><span class="toc-text">è‡ªå®šä¹‰è¶…æ—¶</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%90%86%E9%87%8D%E5%AE%9A%E5%90%91"><span class="toc-text">ä»£ç†é‡å®šå‘</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Custom-max-body-size"><span class="toc-text">Custom max body size</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%90%86Cookie%E5%9F%9F"><span class="toc-text">ä»£ç†CookieåŸŸ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%90%86Cookie%E8%B7%AF%E5%BE%84"><span class="toc-text">ä»£ç†Cookieè·¯å¾„</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%90%86%E7%BC%93%E5%86%B2"><span class="toc-text">ä»£ç†ç¼“å†²</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%90%86%E7%BC%93%E5%86%B2%E5%8C%BA%E6%95%B0"><span class="toc-text">ä»£ç†ç¼“å†²åŒºæ•°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%90%86%E7%BC%93%E5%86%B2%E5%8C%BA%E5%A4%A7%E5%B0%8F"><span class="toc-text">ä»£ç†ç¼“å†²åŒºå¤§å°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%90%86%E6%9C%80%E5%A4%A7%E4%B8%B4%E6%97%B6%E6%96%87%E4%BB%B6%E5%A4%A7%E5%B0%8F"><span class="toc-text">ä»£ç†æœ€å¤§ä¸´æ—¶æ–‡ä»¶å¤§å°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%90%86HTTP%E7%89%88%E6%9C%AC"><span class="toc-text">ä»£ç†HTTPç‰ˆæœ¬</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SSL%E5%AF%86%E7%A0%81"><span class="toc-text">SSLå¯†ç </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E4%BB%A3%E7%90%86%E5%A4%B4"><span class="toc-text">è¿æ¥ä»£ç†å¤´</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E7%94%A8%E8%AE%BF%E9%97%AE%E6%97%A5%E5%BF%97"><span class="toc-text">å¯ç”¨è®¿é—®æ—¥å¿—</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E7%94%A8%E9%87%8D%E5%86%99%E6%97%A5%E5%BF%97"><span class="toc-text">å¯ç”¨é‡å†™æ—¥å¿—</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E7%94%A8%E5%BC%80%E6%94%BE%E8%BF%BD%E8%B8%AA"><span class="toc-text">å¯ç”¨å¼€æ”¾è¿½è¸ª</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#X%E8%BD%AC%E5%8F%91%E5%89%8D%E7%BC%80%E6%8A%A5%E5%A4%B4"><span class="toc-text">Xè½¬å‘å‰ç¼€æŠ¥å¤´</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ModSecurity"><span class="toc-text">ModSecurity</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#InfluxDB"><span class="toc-text">InfluxDB</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8E%E7%AB%AF%E5%8D%8F%E8%AE%AE"><span class="toc-text">åç«¯åè®®</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-text">ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Satisfy"><span class="toc-text">Satisfy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Mirror"><span class="toc-text">Mirror</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>æœ€æ–°æ–‡ç« </span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/d14168d/" title="è™šæ‹Ÿæœºé—®é¢˜åˆé›†"><img src="https://raw.githubusercontents.com/wangyyovo/CDN/master/cover/hexo/090cfe4e9e60b0ad0de05db822f3ae97.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="è™šæ‹Ÿæœºé—®é¢˜åˆé›†"/></a><div class="content"><a class="title" href="/posts/d14168d/" title="è™šæ‹Ÿæœºé—®é¢˜åˆé›†">è™šæ‹Ÿæœºé—®é¢˜åˆé›†</a><time datetime="2022-07-16T13:30:36.000Z" title="å‘è¡¨äº 2022-07-16 21:30:36">2022-07-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/f540045f/" title="ç”¨goè¯­è¨€ç¼–å†™ç§»åŠ¨ç«¯sdkå’Œappå¼€å‘"><img src="https://raw.githubusercontents.com/wangyyovo/CDN/master/cover/golang/941ed1ec2925719a0c92e76f4f786b6a.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ç”¨goè¯­è¨€ç¼–å†™ç§»åŠ¨ç«¯sdkå’Œappå¼€å‘"/></a><div class="content"><a class="title" href="/posts/f540045f/" title="ç”¨goè¯­è¨€ç¼–å†™ç§»åŠ¨ç«¯sdkå’Œappå¼€å‘">ç”¨goè¯­è¨€ç¼–å†™ç§»åŠ¨ç«¯sdkå’Œappå¼€å‘</a><time datetime="2022-07-04T12:14:21.000Z" title="å‘è¡¨äº 2022-07-04 20:14:21">2022-07-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/5faac006/" title="åœ¨çº¿ç¼–ç¨‹IDE"><img src="https://raw.githubusercontents.com/wangyyovo/CDN/master/cover/hexo/090cfe4e9e60b0ad0de05db822f3ae97.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="åœ¨çº¿ç¼–ç¨‹IDE"/></a><div class="content"><a class="title" href="/posts/5faac006/" title="åœ¨çº¿ç¼–ç¨‹IDE">åœ¨çº¿ç¼–ç¨‹IDE</a><time datetime="2022-06-12T13:30:36.000Z" title="å‘è¡¨äº 2022-06-12 21:30:36">2022-06-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/7594185d/" title="å³æ—¶æ€§èƒ½åˆ†æå·¥å…·Pyroscope"><img src="https://raw.githubusercontents.com/wangyyovo/CDN/master/cover/golang/3bfb3279740bc9a5b5ef436fa887ef07.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="å³æ—¶æ€§èƒ½åˆ†æå·¥å…·Pyroscope"/></a><div class="content"><a class="title" href="/posts/7594185d/" title="å³æ—¶æ€§èƒ½åˆ†æå·¥å…·Pyroscope">å³æ—¶æ€§èƒ½åˆ†æå·¥å…·Pyroscope</a><time datetime="2022-06-12T08:07:36.000Z" title="å‘è¡¨äº 2022-06-12 16:07:36">2022-06-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/82a7aa7c/" title="golangæ€§èƒ½è°ƒè¯•ä¼˜åŒ–æ–¹æ³•"><img src="https://raw.githubusercontents.com/wangyyovo/CDN/master/cover/common/3.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="golangæ€§èƒ½è°ƒè¯•ä¼˜åŒ–æ–¹æ³•"/></a><div class="content"><a class="title" href="/posts/82a7aa7c/" title="golangæ€§èƒ½è°ƒè¯•ä¼˜åŒ–æ–¹æ³•">golangæ€§èƒ½è°ƒè¯•ä¼˜åŒ–æ–¹æ³•</a><time datetime="2022-06-12T03:00:36.000Z" title="å‘è¡¨äº 2022-06-12 11:00:36">2022-06-12</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By Blank</div><div class="framework-info"><span>æ¡†æ¶ </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>ä¸»é¢˜ </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://wangyyovo.github.io/">blog</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="ç®€ç¹è½¬æ¢">ç¹</button><button id="darkmode" type="button" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="è®¾ç½®"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="ç›´è¾¾è¯„è®º"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">æœç´¢</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  æ•°æ®åº“åŠ è½½ä¸­</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="æœç´¢æ–‡ç« " type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@5/instantpage.js" type="module"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(() => {
  const $mermaidWrap = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaidWrap.length) {
    window.runMermaid = () => {
      window.loadMermaid = true
      const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

      Array.from($mermaidWrap).forEach((item, index) => {
        const mermaidSrc = item.firstElementChild
        const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
        const mermaidID = 'mermaid-' + index
        const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent
        mermaid.mermaidAPI.render(mermaidID, mermaidDefinition, (svgCode) => {
          mermaidSrc.insertAdjacentHTML('afterend', svgCode)
        })
      })
    }

    const loadMermaid = () => {
      window.loadMermaid ? runMermaid() : getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaid)
    }

    window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
  }
})()</script><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '49gEIIGN7uRbL6vHhieSpBzM-MdYXbMMI',
      appKey: 'uqts0urLKwikYQ0fKmIkMHBE',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><div class="aplayer no-destroy" data-id="000PeZCQ1i4XVs" data-server="tencent" data-type="artist" data-fixed="true" data-mini="true" data-listFolded="false" data-order="random" data-preload="none" data-autoplay="false" muted></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-heart.min.js" async="async" mobile="false"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer@1/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/MetingJS/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>