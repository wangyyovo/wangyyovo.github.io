<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>consulä½¿ç”¨æ‰‹å†Œ | Blank</title><meta name="author" content="Blank"><meta name="copyright" content="Blank"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="consulä½¿ç”¨æ‰‹å†Œä»‹ç»ConsulåŒ…å«å¤šä¸ªç»„ä»¶,ä½†æ˜¯ä½œä¸ºä¸€ä¸ªæ•´ä½“,ä¸ºä½ çš„åŸºç¡€è®¾æ–½æä¾›æœåŠ¡å‘ç°å’ŒæœåŠ¡é…ç½®çš„å·¥å…·.ä»–æä¾›ä»¥ä¸‹å…³é”®ç‰¹æ€§: æœåŠ¡å‘ç° Consulçš„å®¢æˆ·ç«¯å¯ç”¨æä¾›ä¸€ä¸ªæœåŠ¡,æ¯”å¦‚ api æˆ–è€…mysql ,å¦å¤–ä¸€äº›å®¢æˆ·ç«¯å¯ç”¨ä½¿ç”¨Consulå»å‘ç°ä¸€ä¸ªæŒ‡å®šæœåŠ¡çš„æä¾›è€….é€šè¿‡DNSæˆ–è€…HTTPåº”ç”¨ç¨‹åºå¯ç”¨å¾ˆå®¹æ˜“çš„æ‰¾åˆ°ä»–æ‰€ä¾èµ–çš„æœåŠ¡.å¥åº·æ£€æŸ¥ Consulå®¢æˆ·ç«¯å¯ç”¨æä¾›ä»»æ„æ•°é‡çš„å¥åº·æ£€æŸ¥,æŒ‡å®š">
<meta property="og:type" content="article">
<meta property="og:title" content="consulä½¿ç”¨æ‰‹å†Œ">
<meta property="og:url" content="https://wangyyovo.github.io/posts/6ab3229c/">
<meta property="og:site_name" content="Blank">
<meta property="og:description" content="consulä½¿ç”¨æ‰‹å†Œä»‹ç»ConsulåŒ…å«å¤šä¸ªç»„ä»¶,ä½†æ˜¯ä½œä¸ºä¸€ä¸ªæ•´ä½“,ä¸ºä½ çš„åŸºç¡€è®¾æ–½æä¾›æœåŠ¡å‘ç°å’ŒæœåŠ¡é…ç½®çš„å·¥å…·.ä»–æä¾›ä»¥ä¸‹å…³é”®ç‰¹æ€§: æœåŠ¡å‘ç° Consulçš„å®¢æˆ·ç«¯å¯ç”¨æä¾›ä¸€ä¸ªæœåŠ¡,æ¯”å¦‚ api æˆ–è€…mysql ,å¦å¤–ä¸€äº›å®¢æˆ·ç«¯å¯ç”¨ä½¿ç”¨Consulå»å‘ç°ä¸€ä¸ªæŒ‡å®šæœåŠ¡çš„æä¾›è€….é€šè¿‡DNSæˆ–è€…HTTPåº”ç”¨ç¨‹åºå¯ç”¨å¾ˆå®¹æ˜“çš„æ‰¾åˆ°ä»–æ‰€ä¾èµ–çš„æœåŠ¡.å¥åº·æ£€æŸ¥ Consulå®¢æˆ·ç«¯å¯ç”¨æä¾›ä»»æ„æ•°é‡çš„å¥åº·æ£€æŸ¥,æŒ‡å®š">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/cover/consul/7d0e1704af4e9eed516ba20ec9133112.jpg">
<meta property="article:published_time" content="2019-09-22T03:26:39.000Z">
<meta property="article:modified_time" content="2019-09-22T03:26:39.000Z">
<meta property="article:author" content="Blank">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/cover/consul/7d0e1704af4e9eed516ba20ec9133112.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "consulä½¿ç”¨æ‰‹å†Œ",
  "url": "https://wangyyovo.github.io/posts/6ab3229c/",
  "image": "https://jsd.012700.xyz/gh/wangyyovo/CDN@master/cover/consul/7d0e1704af4e9eed516ba20ec9133112.jpg",
  "datePublished": "2019-09-22T03:26:39.000Z",
  "dateModified": "2019-09-22T03:26:39.000Z",
  "author": [
    {
      "@type": "Person",
      "name": "Blank",
      "url": "https://wangyyovo.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/theme/favicon.ico"><link rel="canonical" href="https://wangyyovo.github.io/posts/6ab3229c/"><link rel="preconnect" href="https://jsd.012700.xyz"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://jsd.012700.xyz/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"æœªæ‰¾åˆ°ç¬¦åˆæ‚¨æŸ¥è¯¢çš„å†…å®¹ï¼š${query}","hits_stats":"å…±æ‰¾åˆ° ${hits} ç¯‡æ–‡ç« "}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"ç¹","msgToSimplifiedChinese":"ç®€"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":400,"highlightFullpage":true,"highlightMacStyle":false},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶å¤±è´¥',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  dateSuffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: {"limitCount":150,"languages":{"author":"ä½œè€…: Blank","link":"é“¾æ¥: ","source":"æ¥æº: Blank","info":"è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚"}},
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://jsd.012700.xyz/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'åŠ è½½æ›´å¤š'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'consulä½¿ç”¨æ‰‹å†Œ',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="alternate" href="/atom.xml" title="Blank" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/theme/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">352</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">46</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">58</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> ä¸»é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> æ—¶é—´è½´</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡ç­¾</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> åˆ†ç±»</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> å‹é“¾</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fas fa-comment-dots"></i><span> ç•™è¨€æ¿</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> å…³äº</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> å¨±ä¹</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> éŸ³ä¹</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> ç”µå½±</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-image"></i><span> ç›¸å†Œ</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-book"></i><span> æ•™ç¨‹</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/posts/21cfbf15/"><span> ğŸš€ å¿«é€Ÿé–‹å§‹</span></a></li><li><a class="site-page child" href="/posts/dc584b87/"><span> ğŸ“‘ ä¸»é¡Œé é¢</span></a></li><li><a class="site-page child" href="/posts/4aa8abbe/"><span> ğŸ›  ä¸»é¡Œé…ç½®</span></a></li><li><a class="site-page child" href="/posts/ceeb73f/"><span> âš”ï¸ æ¨™ç°½å¤–æŒ‚</span></a></li><li><a class="site-page child" href="/posts/98d20436/"><span> â“ ä¸»é¡Œå•ç­”</span></a></li><li><a class="site-page child" href="/posts/4073eda/"><span> âš¡ï¸ é€²éšæ•™ç¨‹</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-language"></i><span> è¯­è¨€</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/"><i class="fa-fw fas fa-c"></i><span> ä¸­æ–‡</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://jsd.012700.xyz/gh/wangyyovo/CDN@master/cover/consul/7d0e1704af4e9eed516ba20ec9133112.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Blank</span></a><a class="nav-page-title" href="/"><span class="site-name">consulä½¿ç”¨æ‰‹å†Œ</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  è¿”å›é¦–é¡µ</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> æœç´¢</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> ä¸»é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> æ—¶é—´è½´</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡ç­¾</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> åˆ†ç±»</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> å‹é“¾</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fas fa-comment-dots"></i><span> ç•™è¨€æ¿</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> å…³äº</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> å¨±ä¹</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> éŸ³ä¹</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> ç”µå½±</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-image"></i><span> ç›¸å†Œ</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-book"></i><span> æ•™ç¨‹</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/posts/21cfbf15/"><span> ğŸš€ å¿«é€Ÿé–‹å§‹</span></a></li><li><a class="site-page child" href="/posts/dc584b87/"><span> ğŸ“‘ ä¸»é¡Œé é¢</span></a></li><li><a class="site-page child" href="/posts/4aa8abbe/"><span> ğŸ›  ä¸»é¡Œé…ç½®</span></a></li><li><a class="site-page child" href="/posts/ceeb73f/"><span> âš”ï¸ æ¨™ç°½å¤–æŒ‚</span></a></li><li><a class="site-page child" href="/posts/98d20436/"><span> â“ ä¸»é¡Œå•ç­”</span></a></li><li><a class="site-page child" href="/posts/4073eda/"><span> âš¡ï¸ é€²éšæ•™ç¨‹</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-language"></i><span> è¯­è¨€</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/"><i class="fa-fw fas fa-c"></i><span> ä¸­æ–‡</span></a></li></ul></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">consulä½¿ç”¨æ‰‹å†Œ</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2019-09-22T03:26:39.000Z" title="å‘è¡¨äº 2019-09-22 11:26:39">2019-09-22</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2019-09-22T03:26:39.000Z" title="æ›´æ–°äº 2019-09-22 11:26:39">2019-09-22</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/microservice/">microservice</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/microservice/consul/">consul</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">æ€»å­—æ•°:</span><span class="word-count">18.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»æ—¶é•¿:</span><span>79åˆ†é’Ÿ</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">æµè§ˆé‡:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">è¯„è®ºæ•°:</span><a href="/posts/6ab3229c/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count" data-xid="/posts/6ab3229c/" itemprop="commentCount"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><script src="\assets\js\APlayer.min.js"> </script><h1 id="consulä½¿ç”¨æ‰‹å†Œ"><a href="#consulä½¿ç”¨æ‰‹å†Œ" class="headerlink" title="consulä½¿ç”¨æ‰‹å†Œ"></a>consulä½¿ç”¨æ‰‹å†Œ</h1><h2 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><p>ConsulåŒ…å«å¤šä¸ªç»„ä»¶,ä½†æ˜¯ä½œä¸ºä¸€ä¸ªæ•´ä½“,ä¸ºä½ çš„åŸºç¡€è®¾æ–½æä¾›æœåŠ¡å‘ç°å’ŒæœåŠ¡é…ç½®çš„å·¥å…·.ä»–æä¾›ä»¥ä¸‹å…³é”®ç‰¹æ€§:</p>
<p><strong>æœåŠ¡å‘ç°</strong> Consulçš„å®¢æˆ·ç«¯å¯ç”¨æä¾›ä¸€ä¸ªæœåŠ¡,æ¯”å¦‚ api æˆ–è€…mysql ,å¦å¤–ä¸€äº›å®¢æˆ·ç«¯å¯ç”¨ä½¿ç”¨Consulå»å‘ç°ä¸€ä¸ªæŒ‡å®šæœåŠ¡çš„æä¾›è€….é€šè¿‡DNSæˆ–è€…HTTPåº”ç”¨ç¨‹åºå¯ç”¨å¾ˆå®¹æ˜“çš„æ‰¾åˆ°ä»–æ‰€ä¾èµ–çš„æœåŠ¡.<br><strong>å¥åº·æ£€æŸ¥</strong> Consulå®¢æˆ·ç«¯å¯ç”¨æä¾›ä»»æ„æ•°é‡çš„å¥åº·æ£€æŸ¥,æŒ‡å®šä¸€ä¸ªæœåŠ¡(æ¯”å¦‚:webserveræ˜¯å¦è¿”å›äº†200  OK çŠ¶æ€ç )æˆ–è€…ä½¿ç”¨æœ¬åœ°èŠ‚ç‚¹(æ¯”å¦‚:å†…å­˜ä½¿ç”¨æ˜¯å¦å¤§äº90%).  è¿™ä¸ªä¿¡æ¯å¯ç”±operatorç”¨æ¥ç›‘è§†é›†ç¾¤çš„å¥åº·.è¢«æœåŠ¡å‘ç°ç»„ä»¶ç”¨æ¥é¿å…å°†æµé‡å‘é€åˆ°ä¸å¥åº·çš„ä¸»æœº.<br><strong>Key&#x2F;Valueå­˜å‚¨</strong> åº”ç”¨ç¨‹åºå¯ç”¨æ ¹æ®è‡ªå·±çš„éœ€è¦ä½¿ç”¨Consulçš„å±‚çº§çš„Key&#x2F;Valueå­˜å‚¨.æ¯”å¦‚åŠ¨æ€é…ç½®,åŠŸèƒ½æ ‡è®°,åè°ƒ,é¢†è¢–é€‰ä¸¾ç­‰ç­‰,ç®€å•çš„HTTP APIè®©ä»–æ›´æ˜“äºä½¿ç”¨.<br><strong>å¤šæ•°æ®ä¸­å¿ƒ</strong> Consulæ”¯æŒå¼€ç®±å³ç”¨çš„å¤šæ•°æ®ä¸­å¿ƒ.è¿™æ„å‘³ç€ç”¨æˆ·ä¸éœ€è¦æ‹…å¿ƒéœ€è¦å»ºç«‹é¢å¤–çš„æŠ½è±¡å±‚è®©ä¸šåŠ¡æ‰©å±•åˆ°å¤šä¸ªåŒºåŸŸ.<br> Consulé¢å‘DevOpså’Œåº”ç”¨å¼€å‘è€…å‹å¥½.æ˜¯ä»–é€‚åˆç°ä»£çš„å¼¹æ€§çš„åŸºç¡€è®¾æ–½.  <img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/blog/consul-manual/cluster.jpg" alt="consul-cluster"></p>
<h2 id="åŸºç¡€æ¶æ„"><a href="#åŸºç¡€æ¶æ„" class="headerlink" title="åŸºç¡€æ¶æ„"></a>åŸºç¡€æ¶æ„</h2><p>Consulæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼é«˜å¯ç”¨çš„ç³»ç»Ÿ. è¿™èŠ‚å°†åŒ…å«ä¸€äº›åŸºç¡€,æˆ‘ä»¬å¿½ç•¥æ‰ä¸€äº›ç»†èŠ‚è¿™æ ·ä½ å¯ä»¥å¿«é€Ÿäº†è§£Consulæ˜¯å¦‚ä½•å·¥ä½œçš„.å¦‚æœè¦äº†è§£æ›´å¤šç»†èŠ‚,è¯·å‚è€ƒæ·±å…¥çš„æ¶æ„æè¿°.</p>
<p>æ¯ä¸ªæä¾›æœåŠ¡ç»™Consulçš„é˜¶æ®µéƒ½è¿è¡Œäº†ä¸€ä¸ªConsul agent . å‘ç°æœåŠ¡æˆ–è€…è®¾ç½®å’Œè·å– key&#x2F;valueå­˜å‚¨çš„æ•°æ®ä¸æ˜¯å¿…é¡»è¿è¡Œagent.è¿™ä¸ªagentæ˜¯è´Ÿè´£å¯¹èŠ‚ç‚¹è‡ªèº«å’ŒèŠ‚ç‚¹ä¸Šçš„æœåŠ¡è¿›è¡Œå¥åº·æ£€æŸ¥çš„.</p>
<p>Agentä¸ä¸€ä¸ªå’Œå¤šä¸ªConsul Server è¿›è¡Œäº¤äº’.Consul Server  ç”¨äºå­˜æ”¾å’Œå¤åˆ¶æ•°æ®.serverè‡ªè¡Œé€‰ä¸¾ä¸€ä¸ªé¢†è¢–.è™½ç„¶Consulå¯ä»¥è¿è¡Œåœ¨ä¸€å°server ,  ä½†æ˜¯å»ºè®®ä½¿ç”¨3åˆ°5å°æ¥é¿å…å¤±è´¥æƒ…å†µä¸‹æ•°æ®çš„ä¸¢å¤±.æ¯ä¸ªæ•°æ®ä¸­å¿ƒå»ºè®®é…ç½®ä¸€ä¸ªserveré›†ç¾¤.</p>
<p>ä½ åŸºç¡€è®¾æ–½ä¸­éœ€è¦å‘ç°å…¶ä»–æœåŠ¡çš„ç»„ä»¶å¯ä»¥æŸ¥è¯¢ä»»ä½•ä¸€ä¸ªConsul çš„serveræˆ–è€… agent.Agentä¼šè‡ªåŠ¨è½¬å‘è¯·æ±‚åˆ°server .</p>
<p>æ¯ä¸ªæ•°æ®ä¸­è¿è¡Œäº†ä¸€ä¸ªConsul serveré›†ç¾¤.å½“ä¸€ä¸ªè·¨æ•°æ®ä¸­å¿ƒçš„æœåŠ¡å‘ç°å’Œé…ç½®è¯·æ±‚åˆ›å»ºæ—¶.æœ¬åœ°Consul Serverè½¬å‘è¯·æ±‚åˆ°è¿œç¨‹çš„æ•°æ®ä¸­å¿ƒå¹¶è¿”å›ç»“æœ.</p>
<p>æ›´å¤šä»‹ç»æŸ¥çœ‹å®˜ç½‘<a target="_blank" rel="noopener" href="https://www.consul.io/">ç‚¹å‡»å‰å¾€</a></p>
<h2 id="å®‰è£…Consul"><a href="#å®‰è£…Consul" class="headerlink" title="å®‰è£…Consul"></a>å®‰è£…Consul</h2><p>å®‰è£…Consul,æ‰¾åˆ°é€‚åˆä½ ç³»ç»Ÿçš„åŒ…ä¸‹è½½ä»–.Consulæ‰“åŒ…ä¸ºä¸€ä¸ªâ€™Zipâ€™æ–‡ä»¶.<a target="_blank" rel="noopener" href="https://www.consul.io/downloads.html">å‰å¾€ä¸‹è½½</a></p>
<p>ä¸‹è½½åè§£å¼€å‹ç¼©åŒ….æ‹·è´Consulåˆ°ä½ çš„PATHè·¯å¾„ä¸­,åœ¨Unixç³»ç»Ÿä¸­<code>~/bin</code>å’Œ<code>/usr/local/bin</code>æ˜¯é€šå¸¸çš„å®‰è£…ç›®å½•.æ ¹æ®ä½ æ˜¯æƒ³ä¸ºå•ä¸ªç”¨æˆ·å®‰è£…è¿˜æ˜¯ç»™æ•´ä¸ªç³»ç»Ÿå®‰è£…æ¥é€‰æ‹©.åœ¨Windowsç³»ç»Ÿä¸­æœ‰å¯ä»¥å®‰è£…åˆ°<code>%PATH%</code>çš„è·¯å¾„ä¸­.</p>
<h2 id="éªŒè¯å®‰è£…"><a href="#éªŒè¯å®‰è£…" class="headerlink" title="éªŒè¯å®‰è£…"></a>éªŒè¯å®‰è£…</h2><p>å®Œæˆå®‰è£…å,é€šè¿‡æ‰“å¼€ä¸€ä¸ªæ–°ç»ˆç«¯çª—å£æ£€æŸ¥<code>consul</code>å®‰è£…æ˜¯å¦æˆåŠŸ.é€šè¿‡æ‰§è¡Œ <code>consul</code>ä½ åº”è¯¥çœ‹åˆ°ç±»ä¼¼ä¸‹é¢çš„è¾“å‡º</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@dhcp-10-201-102-248 ~]# consul</span><br><span class="line">usage: consul [--version] [--help] &lt;command&gt; [&lt;args&gt;]</span><br><span class="line">Available commands are:</span><br><span class="line">    agent          Runs a Consul agent</span><br><span class="line">    configtest     Validate config file</span><br><span class="line">    event          Fire a new event</span><br><span class="line">    exec           Executes a command on Consul nodes</span><br><span class="line">    force-leave    Forces a member of the cluster to enter the &quot;left&quot; state</span><br><span class="line">    info           Provides debugging information for operators</span><br><span class="line">    join           Tell Consul agent to join cluster</span><br><span class="line">    keygen         Generates a new encryption key</span><br><span class="line">    keyring        Manages gossip layer encryption keys</span><br><span class="line">    kv             Interact with the key-value store</span><br><span class="line">    leave          Gracefully leaves the Consul cluster and shuts down</span><br><span class="line">    lock           Execute a command holding a lock</span><br><span class="line">    maint          Controls node or service maintenance mode</span><br><span class="line">    members        Lists the members of a Consul cluster</span><br><span class="line">    monitor        Stream logs from a Consul agent</span><br><span class="line">    operator       Provides cluster-level tools for Consul operators</span><br><span class="line">    reload         Triggers the agent to reload configuration files</span><br><span class="line">    rtt            Estimates network round trip time between nodes</span><br><span class="line">    snapshot       Saves, restores and inspects snapshots of Consul server state</span><br><span class="line">    version        Prints the Consul version</span><br><span class="line">    watch          Watch for changes in Consul123456789101112131415161718192021222324</span><br></pre></td></tr></table></figure>

<p>å¦‚æœä½ å¾—åˆ°ä¸€ä¸ª<code>consul not be found</code>çš„é”™è¯¯,ä½ çš„<code>PATH</code>å¯èƒ½æ²¡æœ‰æ­£ç¡®è®¾ç½®.è¯·è¿”å›æ£€æŸ¥ä½ çš„consulçš„å®‰è£…è·¯å¾„æ˜¯å¦åŒ…å«åœ¨<code>PATH</code>ä¸­.</p>
<h2 id="è¿è¡ŒAgent"><a href="#è¿è¡ŒAgent" class="headerlink" title="è¿è¡ŒAgent"></a>è¿è¡ŒAgent</h2><p>å®ŒæˆConsulçš„å®‰è£…å,å¿…é¡»è¿è¡Œagent. agentå¯ä»¥è¿è¡Œä¸º<code>server</code>æˆ–<code>client</code>æ¨¡å¼.æ¯ä¸ªæ•°æ®ä¸­å¿ƒè‡³å°‘å¿…é¡»æ‹¥æœ‰ä¸€å°server . å»ºè®®åœ¨ä¸€ä¸ªé›†ç¾¤ä¸­æœ‰3æˆ–è€…5ä¸ªserver.éƒ¨ç½²å•ä¸€çš„server,åœ¨å‡ºç°å¤±è´¥æ—¶ä¼šä¸å¯é¿å…çš„é€ æˆæ•°æ®ä¸¢å¤±.</p>
<p>å…¶ä»–çš„agentè¿è¡Œä¸ºclientæ¨¡å¼.ä¸€ä¸ªclientæ˜¯ä¸€ä¸ªéå¸¸è½»é‡çº§çš„è¿›ç¨‹.ç”¨äºæ³¨å†ŒæœåŠ¡,è¿è¡Œå¥åº·æ£€æŸ¥å’Œè½¬å‘å¯¹serverçš„æŸ¥è¯¢.agentå¿…é¡»åœ¨é›†ç¾¤ä¸­çš„æ¯ä¸ªä¸»æœºä¸Šè¿è¡Œ.</p>
<p>æŸ¥çœ‹å¯åŠ¨æ•°æ®ä¸­å¿ƒçš„ç»†èŠ‚è¯·æŸ¥çœ‹<a target="_blank" rel="noopener" href="https://www.consul.io/docs/guides/bootstrapping.html">è¿™é‡Œ</a>.</p>
<h2 id="å¯åŠ¨-Consul-Server"><a href="#å¯åŠ¨-Consul-Server" class="headerlink" title="å¯åŠ¨ Consul Server"></a>å¯åŠ¨ Consul Server</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consul agent -server -bootstrap-expect 3 -data-dir /tmp/consul -node=s1 -bind=10.201.102.198 -ui-dir ./consul_ui/ -rejoin -config-dir=/etc/consul.d/ -client 0.0.0.01</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œcosnul agentä»¥<code>server</code>æ¨¡å¼ï¼Œ</p>
<ul>
<li><code>-server</code> ï¼š å®šä¹‰agentè¿è¡Œåœ¨serveræ¨¡å¼</li>
<li><code>-bootstrap-expect</code> ï¼šåœ¨ä¸€ä¸ªdatacenterä¸­æœŸæœ›æä¾›çš„serverèŠ‚ç‚¹æ•°ç›®ï¼Œå½“è¯¥å€¼æä¾›çš„æ—¶å€™ï¼Œconsulä¸€ç›´ç­‰åˆ°è¾¾åˆ°æŒ‡å®šseveræ•°ç›®çš„æ—¶å€™æ‰ä¼šå¼•å¯¼æ•´ä¸ªé›†ç¾¤ï¼Œè¯¥æ ‡è®°ä¸èƒ½å’Œbootstrapå…±ç”¨</li>
<li><code>-bind</code>ï¼šè¯¥åœ°å€ç”¨æ¥åœ¨é›†ç¾¤å†…éƒ¨çš„é€šè®¯ï¼Œé›†ç¾¤å†…çš„æ‰€æœ‰èŠ‚ç‚¹åˆ°åœ°å€éƒ½å¿…é¡»æ˜¯å¯è¾¾çš„ï¼Œé»˜è®¤æ˜¯0.0.0.0</li>
<li><code>-node</code>ï¼šèŠ‚ç‚¹åœ¨é›†ç¾¤ä¸­çš„åç§°ï¼Œåœ¨ä¸€ä¸ªé›†ç¾¤ä¸­å¿…é¡»æ˜¯å”¯ä¸€çš„ï¼Œé»˜è®¤æ˜¯è¯¥èŠ‚ç‚¹çš„ä¸»æœºå</li>
<li><code>-ui-dir</code>ï¼š æä¾›å­˜æ”¾web uièµ„æºçš„è·¯å¾„ï¼Œè¯¥ç›®å½•å¿…é¡»æ˜¯å¯è¯»çš„</li>
<li><code>-rejoin</code>ï¼šä½¿consulå¿½ç•¥å…ˆå‰çš„ç¦»å¼€ï¼Œåœ¨å†æ¬¡å¯åŠ¨åä»æ—§å°è¯•åŠ å…¥é›†ç¾¤ä¸­ã€‚</li>
<li><code>-config-dir</code>ï¼šé…ç½®æ–‡ä»¶ç›®å½•ï¼Œé‡Œé¢æ‰€æœ‰ä»¥.jsonç»“å°¾çš„æ–‡ä»¶éƒ½ä¼šè¢«åŠ è½½</li>
<li><code>-client</code>ï¼šconsulæœåŠ¡ä¾¦å¬åœ°å€ï¼Œè¿™ä¸ªåœ°å€æä¾›HTTPã€DNSã€RPCç­‰æœåŠ¡ï¼Œé»˜è®¤æ˜¯127.0.0.1æ‰€ä»¥ä¸å¯¹å¤–æä¾›æœåŠ¡ï¼Œå¦‚æœä½ è¦å¯¹å¤–æä¾›æœåŠ¡æ”¹æˆ0.0.0.0</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@dhcp-10-201-102-198 consul]# consul agent -server -bootstrap-expect 1 -data-dir /tmp/consul -node=s1 -bind=10.201.102.198 -ui-dir ./consul_ui/ -rejoin -config-dir=/etc/consul.d/ -client 0.0.0.0</span><br><span class="line">==&gt; WARNING: Expect Mode enabled, expecting 3 servers</span><br><span class="line">==&gt; Starting Consul agent...</span><br><span class="line">==&gt; Starting Consul agent RPC...</span><br><span class="line">==&gt; Consul agent running!</span><br><span class="line">           Version: &#x27;v0.7.4&#x27;</span><br><span class="line">           Node ID: &#x27;422ec677-74ef-8f29-2f22-01effeed6334&#x27;</span><br><span class="line">         Node name: &#x27;s1&#x27;</span><br><span class="line">        Datacenter: &#x27;dc1&#x27;</span><br><span class="line">            Server: true (bootstrap: false)</span><br><span class="line">       Client Addr: 0.0.0.0 (HTTP: 8500, HTTPS: -1, DNS: 8600, RPC: 8400)</span><br><span class="line">      Cluster Addr: 10.201.102.198 (LAN: 8301, WAN: 8302)</span><br><span class="line">    Gossip encrypt: false, RPC-TLS: false, TLS-Incoming: false</span><br><span class="line">             Atlas: &lt;disabled&gt;</span><br><span class="line">==&gt; Log data will now stream in as it occurs:</span><br><span class="line">    2017/03/17 18:03:08 [INFO] raft: Restored from snapshot 139-352267-1489707086023</span><br><span class="line">    2017/03/17 18:03:08 [INFO] raft: Initial configuration (index=6982): [&#123;Suffrage:Voter ID:10.201.102.199:8300 Address:10.201.102.199:8300&#125; &#123;Suffrage:Voter ID:10.201.102.200:8300 Address:10.201.102.200:8300&#125; &#123;Suffrage:Voter ID:10.201.102.198:8300 Address:10.201.102.198:8300&#125;]</span><br><span class="line">    2017/03/17 18:03:08 [INFO] raft: Node at 10.201.102.198:8300 [Follower] entering Follower state (Leader: &quot;&quot;)</span><br><span class="line">    2017/03/17 18:03:08 [INFO] serf: EventMemberJoin: s1 10.201.102.198</span><br><span class="line">    2017/03/17 18:03:08 [INFO] serf: Attempting re-join to previously known node: s2: 10.201.102.199:8301</span><br><span class="line">    2017/03/17 18:03:08 [INFO] consul: Adding LAN server s1 (Addr: tcp/10.201.102.198:8300) (DC: dc1)</span><br><span class="line">    2017/03/17 18:03:08 [INFO] consul: Raft data found, disabling bootstrap mode</span><br><span class="line">    2017/03/17 18:03:08 [INFO] serf: EventMemberJoin: s2 10.201.102.199</span><br><span class="line">    2017/03/17 18:03:08 [INFO] serf: EventMemberJoin: s3 10.201.102.200</span><br><span class="line">    2017/03/17 18:03:08 [INFO] serf: Re-joined to previously known node: s2: 10.201.102.199:8301</span><br><span class="line">    2017/03/17 18:03:08 [INFO] consul: Adding LAN server s2 (Addr: tcp/10.201.102.199:8300) (DC: dc1)</span><br><span class="line">    2017/03/17 18:03:08 [INFO] consul: Adding LAN server s3 (Addr: tcp/10.201.102.200:8300) (DC: dc1)</span><br><span class="line">    2017/03/17 18:03:08 [INFO] serf: EventMemberJoin: s1.dc1 10.201.102.198</span><br><span class="line">    2017/03/17 18:03:08 [INFO] consul: Adding WAN server s1.dc1 (Addr: tcp/10.201.102.198:8300) (DC: dc1)</span><br><span class="line">    2017/03/17 18:03:08 [WARN] serf: Failed to re-join any previously known node</span><br><span class="line">    2017/03/17 18:03:14 [INFO] agent: Synced service &#x27;consul&#x27;</span><br><span class="line">    2017/03/17 18:03:14 [INFO] agent: Deregistered service &#x27;consul01&#x27;</span><br><span class="line">    2017/03/17 18:03:14 [INFO] agent: Deregistered service &#x27;consul02&#x27;</span><br><span class="line">    2017/03/17 18:03:14 [INFO] agent: Deregistered service &#x27;consul03&#x27;12345678910111213141516171819202122232425262728293031323334</span><br></pre></td></tr></table></figure>

<p><strong>æŸ¥çœ‹é›†ç¾¤æˆå‘˜</strong><br> æ–°å¼€ä¸€ä¸ªç»ˆç«¯çª—å£è¿è¡Œ<code>consul members</code>, ä½ å¯ä»¥çœ‹åˆ°Consulé›†ç¾¤çš„æˆå‘˜.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@dhcp-10-201-102-198 ~]# consul members</span><br><span class="line">Node  Address              Status  Type    Build  Protocol  DC</span><br><span class="line">s1    10.201.102.198:8301  alive   server  0.7.4  2         dc1</span><br><span class="line">s2    10.201.102.199:8301  alive   server  0.7.4  2         dc1</span><br><span class="line">s3    10.201.102.200:8301  alive   server  0.7.4  2         dc112345</span><br></pre></td></tr></table></figure>

<h2 id="å¯åŠ¨-Consul-Client"><a href="#å¯åŠ¨-Consul-Client" class="headerlink" title="å¯åŠ¨ Consul Client"></a>å¯åŠ¨ Consul Client</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consul agent -data-dir /tmp/consul -node=c1 -bind=10.201.102.248 -config-dir=/etc/consul.d/ -join 10.201.102.1981</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œcosnul agentä»¥clientæ¨¡å¼ï¼Œ<code>-join</code> åŠ å…¥åˆ°å·²æœ‰çš„é›†ç¾¤ä¸­å»ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@dhcp-10-201-102-248 ~]# consul agent -data-dir /tmp/consul -node=c1 -bind=10.201.102.248 -config-dir=/etc/consul.d/ -join 10.201.102.198</span><br><span class="line">==&gt; Starting Consul agent...</span><br><span class="line">==&gt; Starting Consul agent RPC...</span><br><span class="line">==&gt; Joining cluster...</span><br><span class="line">    Join completed. Synced with 1 initial agents</span><br><span class="line">==&gt; Consul agent running!</span><br><span class="line">           Version: &#x27;v0.7.4&#x27;</span><br><span class="line">           Node ID: &#x27;564dc0c7-7f4f-7402-a301-cebe7f024294&#x27;</span><br><span class="line">         Node name: &#x27;c1&#x27;</span><br><span class="line">        Datacenter: &#x27;dc1&#x27;</span><br><span class="line">            Server: false (bootstrap: false)</span><br><span class="line">       Client Addr: 127.0.0.1 (HTTP: 8500, HTTPS: -1, DNS: 8600, RPC: 8400)</span><br><span class="line">      Cluster Addr: 10.201.102.248 (LAN: 8301, WAN: 8302)</span><br><span class="line">    Gossip encrypt: false, RPC-TLS: false, TLS-Incoming: false</span><br><span class="line">             Atlas: &lt;disabled&gt;</span><br><span class="line">==&gt; Log data will now stream in as it occurs:</span><br><span class="line">    2017/03/17 15:35:16 [INFO] serf: EventMemberJoin: c1 10.201.102.248</span><br><span class="line">    2017/03/17 15:35:16 [INFO] agent: (LAN) joining: [10.201.102.198]</span><br><span class="line">    2017/03/17 15:35:16 [INFO] serf: EventMemberJoin: s2 10.201.102.199</span><br><span class="line">    2017/03/17 15:35:16 [INFO] serf: EventMemberJoin: s3 10.201.102.200</span><br><span class="line">    2017/03/17 15:35:16 [INFO] serf: EventMemberJoin: s1 10.201.102.198</span><br><span class="line">    2017/03/17 15:35:16 [INFO] agent: (LAN) joined: 1 Err: &lt;nil&gt;</span><br><span class="line">    2017/03/17 15:35:16 [INFO] consul: adding server s2 (Addr: tcp/10.201.102.199:8300) (DC: dc1)</span><br><span class="line">    2017/03/17 15:35:16 [INFO] consul: adding server s3 (Addr: tcp/10.201.102.200:8300) (DC: dc1)</span><br><span class="line">    2017/03/17 15:35:16 [INFO] consul: adding server s1 (Addr: tcp/10.201.102.198:8300) (DC: dc1)</span><br><span class="line">    2017/03/17 15:35:16 [INFO] agent: Synced node info1234567891011121314151617181920212223242526</span><br></pre></td></tr></table></figure>

<p><strong>æŸ¥çœ‹é›†ç¾¤æˆå‘˜</strong><br> æ–°å¼€ä¸€ä¸ªç»ˆç«¯çª—å£è¿è¡Œ<code>consul members</code>, ä½ å¯ä»¥çœ‹åˆ°Consulé›†ç¾¤çš„æˆå‘˜.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@dhcp-10-201-102-248 ~]# consul members</span><br><span class="line">Node  Address              Status  Type    Build  Protocol  DC</span><br><span class="line">c1    10.201.102.248:8301  alive   client  0.7.4  2         dc1</span><br><span class="line">s1    10.201.102.198:8301  alive   server  0.7.4  2         dc1</span><br><span class="line">s2    10.201.102.199:8301  alive   server  0.7.4  2         dc1</span><br><span class="line">s3    10.201.102.200:8301  alive   server  0.7.4  2         dc1123456</span><br></pre></td></tr></table></figure>

<p><strong>åŠ å…¥é›†ç¾¤</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@dhcp-10-201-102-248 ~]# consul join 10.201.102.198</span><br><span class="line">Node  Address              Status  Type    Build  Protocol  DC</span><br><span class="line">c1    10.201.102.248:8301  alive   client  0.7.4  2         dc1</span><br><span class="line">s1    10.201.102.198:8301  alive   server  0.7.4  2         dc1</span><br><span class="line">s2    10.201.102.199:8301  alive   server  0.7.4  2         dc1</span><br><span class="line">s3    10.201.102.200:8301  alive   server  0.7.4  2         dc1123456</span><br></pre></td></tr></table></figure>

<h2 id="åœæ­¢Agent"><a href="#åœæ­¢Agent" class="headerlink" title="åœæ­¢Agent"></a>åœæ­¢Agent</h2><p>ä½ å¯ä»¥ä½¿ç”¨<code>Ctrl-C</code> ä¼˜é›…çš„å…³é—­Agent. ä¸­æ–­Agentä¹‹åä½ å¯ä»¥çœ‹åˆ°ä»–ç¦»å¼€äº†é›†ç¾¤å¹¶å…³é—­.</p>
<p>åœ¨é€€å‡ºä¸­,Consulæé†’å…¶ä»–é›†ç¾¤æˆå‘˜,è¿™ä¸ªèŠ‚ç‚¹ç¦»å¼€äº†.å¦‚æœä½ å¼ºè¡Œæ€æ‰è¿›ç¨‹.é›†ç¾¤çš„å…¶ä»–æˆå‘˜åº”è¯¥èƒ½æ£€æµ‹åˆ°è¿™ä¸ªèŠ‚ç‚¹å¤±æ•ˆäº†.å½“ä¸€ä¸ªæˆå‘˜ç¦»å¼€,ä»–çš„æœåŠ¡å’Œæ£€æµ‹ä¹Ÿä¼šä»ç›®å½•ä¸­ç§»é™¤.å½“ä¸€ä¸ªæˆå‘˜å¤±æ•ˆäº†,ä»–çš„å¥åº·çŠ¶å†µè¢«ç®€å•çš„æ ‡è®°ä¸ºå±é™©,ä½†æ˜¯ä¸ä¼šä»ç›®å½•ä¸­ç§»é™¤.Consulä¼šè‡ªåŠ¨å°è¯•å¯¹å¤±æ•ˆçš„èŠ‚ç‚¹è¿›è¡Œé‡è¿.å…è®¸ä»–ä»æŸäº›ç½‘ç»œæ¡ä»¶ä¸‹æ¢å¤è¿‡æ¥.ç¦»å¼€çš„èŠ‚ç‚¹åˆ™ä¸ä¼šå†ç»§ç»­è”ç³».</p>
<p>æ­¤å¤–,å¦‚æœä¸€ä¸ªagentä½œä¸ºä¸€ä¸ªæœåŠ¡å™¨,ä¸€ä¸ªä¼˜é›…çš„ç¦»å¼€æ˜¯å¾ˆé‡è¦çš„,å¯ä»¥é¿å…å¼•èµ·æ½œåœ¨çš„å¯ç”¨æ€§æ•…éšœå½±å“è¾¾æˆ<a target="_blank" rel="noopener" href="https://www.consul.io/docs/internals/consensus.html">ä¸€è‡´æ€§åè®®</a>.</p>
<p>æŸ¥çœ‹<a target="_blank" rel="noopener" href="https://www.consul.io/docs/internals/consensus.html">è¿™é‡Œ</a>äº†è§£æ·»åŠ å’Œç§»é™¤server.</p>
<h2 id="æ›´æ–°æœåŠ¡"><a href="#æ›´æ–°æœåŠ¡" class="headerlink" title="æ›´æ–°æœåŠ¡"></a>æ›´æ–°æœåŠ¡</h2><p>æœåŠ¡å®šä¹‰å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶å¹¶å‘é€<code>SIGHUP</code>ç»™agentæ¥è¿›è¡Œæ›´æ–°.è¿™æ ·ä½ å¯ä»¥è®©ä½ åœ¨ä¸å…³é—­æœåŠ¡æˆ–è€…ä¿æŒæœåŠ¡è¯·æ±‚å¯ç”¨çš„æƒ…å†µä¸‹è¿›è¡Œæ›´æ–°.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consul reload1</span><br></pre></td></tr></table></figure>

<p>å¦å¤– HTTP APIå¯ä»¥ç”¨æ¥åŠ¨æ€çš„æ·»åŠ ,ç§»é™¤å’Œä¿®æ”¹æœåŠ¡.</p>
<p>æ³¨å†ŒæœåŠ¡<br> æ­å»ºå¥½conuslé›†ç¾¤åï¼Œç”¨æˆ·æˆ–è€…ç¨‹åºå°±èƒ½åˆ°consulä¸­å»æŸ¥è¯¢æˆ–è€…æ³¨å†ŒæœåŠ¡ã€‚å¯ä»¥é€šè¿‡æä¾›æœåŠ¡å®šä¹‰æ–‡ä»¶æˆ–è€…è°ƒç”¨HTTP APIæ¥æ³¨å†Œä¸€ä¸ªæœåŠ¡.</p>
<p>é¦–å…ˆ,ä¸ºConsulé…ç½®åˆ›å»ºä¸€ä¸ªç›®å½•.Consulä¼šè½½å…¥é…ç½®æ–‡ä»¶å¤¹é‡Œçš„æ‰€æœ‰é…ç½®æ–‡ä»¶.åœ¨Unixç³»ç»Ÿä¸­é€šå¸¸ç±»ä¼¼ <code>/etc/consul.d</code> (.d åç¼€æ„æ€æ˜¯è¿™ä¸ªè·¯å¾„åŒ…å«äº†ä¸€ç»„é…ç½®æ–‡ä»¶).</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir /etc/consul.d1</span><br></pre></td></tr></table></figure>

<p>ç„¶å,æˆ‘ä»¬å°†ç¼–å†™æœåŠ¡å®šä¹‰é…ç½®æ–‡ä»¶.å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªåå«webçš„æœåŠ¡è¿è¡Œåœ¨ 80ç«¯å£.å¦å¤–,æˆ‘ä»¬å°†ç»™ä»–è®¾ç½®ä¸€ä¸ªæ ‡ç­¾.è¿™æ ·æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»–ä½œä¸ºé¢å¤–çš„æŸ¥è¯¢æ–¹å¼:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &#x27;&#123;&quot;service&quot;: &#123;&quot;name&quot;: &quot;web&quot;, &quot;tags&quot;: [&quot;rails&quot;], &quot;port&quot;: 80&#125;&#125;&#x27; &gt;/etc/consul.d/web.json1</span><br></pre></td></tr></table></figure>

<p>ç°åœ¨é‡å¯agent , è®¾ç½®é…ç½®ç›®å½•:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">consul agent -server -bootstrap-expect 1 -data-dir /tmp/consul -node=s1 -<span class="built_in">bind</span>=10.201.102.198 -rejoin -config-dir=/etc/consul.d/ -client 0.0.0.0</span></span><br><span class="line">...</span><br><span class="line">    [INFO] agent: Synced service &#x27;web&#x27;</span><br><span class="line">...1234</span><br></pre></td></tr></table></figure>

<ul>
<li><code>-data-dir</code>ï¼šæä¾›ä¸€ä¸ªç›®å½•ç”¨æ¥å­˜æ”¾agentçš„çŠ¶æ€ï¼Œæ‰€æœ‰çš„agentå…è®¸éƒ½éœ€è¦è¯¥ç›®å½•ï¼Œè¯¥ç›®å½•å¿…é¡»æ˜¯ç¨³å®šçš„ï¼Œç³»ç»Ÿé‡å¯åéƒ½ç»§ç»­å­˜åœ¨<br> ä½ å¯èƒ½æ³¨æ„åˆ°äº†è¾“å‡ºäº† â€œsyncedâ€ äº† webè¿™ä¸ªæœåŠ¡.æ„æ€æ˜¯è¿™ä¸ªagentä»é…ç½®æ–‡ä»¶ä¸­è½½å…¥äº†æœåŠ¡å®šä¹‰,å¹¶ä¸”æˆåŠŸæ³¨å†Œåˆ°æœåŠ¡ç›®å½•.</li>
</ul>
<p>å¦‚æœä½ æƒ³æ³¨å†Œå¤šä¸ªæœåŠ¡,ä½ åº”è¯¥åœ¨Consulé…ç½®ç›®å½•åˆ›å»ºå¤šä¸ªæœåŠ¡å®šä¹‰æ–‡ä»¶.</p>
<p>HTTP APIæ³¨å†ŒæœåŠ¡,curlå‘½ä»¤æˆ–è€…postman ä»¥<code>PUT</code>æ–¹å¼è¯·æ±‚consul HTTP APIæ›´å¤šç»†èŠ‚<a target="_blank" rel="noopener" href="https://www.consul.io/docs/agent/http/catalog.html#catalog_register">ç‚¹å‡»æŸ¥çœ‹</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X PUT -d &#x27;&#123;&quot;Datacenter&quot;: &quot;dc1&quot;, &quot;Node&quot;: &quot;c2&quot;, &quot;Address&quot;: &quot;10.155.0.106&quot;, &quot;Service&quot;: &#123;&quot;Service&quot;: &quot;MAC&quot;, &quot;tags&quot;: [&quot;lianglian&quot;, &quot;Mac&quot;], &quot;Port&quot;: 22&#125;&#125;&#x27; http://127.0.0.1:8500/v1/catalog/register1</span><br></pre></td></tr></table></figure>

<h2 id="æŸ¥è¯¢æœåŠ¡"><a href="#æŸ¥è¯¢æœåŠ¡" class="headerlink" title="æŸ¥è¯¢æœåŠ¡"></a>æŸ¥è¯¢æœåŠ¡</h2><p>ä¸€æ—¦agentå¯åŠ¨å¹¶ä¸”æœåŠ¡åŒæ­¥äº†.æˆ‘ä»¬å¯ä»¥é€šè¿‡DNSæˆ–è€…HTTPçš„APIæ¥æŸ¥è¯¢æœåŠ¡.</p>
<p><strong>DNS API</strong><br> è®©æˆ‘ä»¬é¦–å…ˆä½¿ç”¨DNS APIæ¥æŸ¥è¯¢.åœ¨DNS APIä¸­,æœåŠ¡çš„DNSåå­—æ˜¯ <code>NAME.service.consul</code>. è™½ç„¶æ˜¯å¯é…ç½®çš„,ä½†é»˜è®¤çš„æ‰€æœ‰DNSåå­—ä¼šéƒ½åœ¨<code>consul</code>å‘½åç©ºé—´ä¸‹.è¿™ä¸ªå­åŸŸå‘Šè¯‰Consul,æˆ‘ä»¬åœ¨æŸ¥è¯¢æœåŠ¡,<code>NAME</code>åˆ™æ˜¯æœåŠ¡çš„åç§°.</p>
<p>å¯¹äºæˆ‘ä»¬ä¸Šé¢æ³¨å†Œçš„WebæœåŠ¡.å®ƒçš„åŸŸåæ˜¯ <code>web.service.consul</code> :</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@dhcp-10-201-102-198 ~]# dig @127.0.0.1 -p 8600 web.service.consul</span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.8.2rc1-RedHat-9.8.2-0.17.rc1.el6 &lt;&lt;&gt;&gt; @127.0.0.1 -p 8600 web.service.consul</span><br><span class="line">; (1 server found)</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 39468</span><br><span class="line">;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0</span><br><span class="line">;; WARNING: recursion requested but not available</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;web.service.consul.            IN      A</span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">web.service.consul.     0       IN      A       10.201.102.198</span><br><span class="line">;; Query time: 0 msec</span><br><span class="line">;; SERVER: 127.0.0.1#8600(127.0.0.1)</span><br><span class="line">;; WHEN: Tue Mar 28 16:10:24 2017</span><br><span class="line">;; MSG SIZE  rcvd: 52</span><br><span class="line">[root@dhcp-10-201-102-198 ~]#1234567891011121314151617</span><br></pre></td></tr></table></figure>

<p>å¦‚ä½ æ‰€è§,ä¸€ä¸ª<code>A</code>è®°å½•è¿”å›äº†ä¸€ä¸ªå¯ç”¨çš„æœåŠ¡æ‰€åœ¨çš„èŠ‚ç‚¹çš„IPåœ°å€.<code>A</code>è®°å½•åªèƒ½è®¾ç½®ä¸ºIPåœ°å€. æœ‰ä¹Ÿå¯ç”¨ä½¿ç”¨ DNS API æ¥æ¥æ”¶åŒ…å« åœ°å€å’Œç«¯å£çš„ SRVè®°å½•:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@dhcp-10-201-102-198 ~]# dig @127.0.0.1 -p 8600 web.service.consul SRV</span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.8.2rc1-RedHat-9.8.2-0.17.rc1.el6 &lt;&lt;&gt;&gt; @127.0.0.1 -p 8600 web.service.consul SRV</span><br><span class="line">; (1 server found)</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 13331</span><br><span class="line">;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1</span><br><span class="line">;; WARNING: recursion requested but not available</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;web.service.consul.            IN      SRV</span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">web.service.consul.     0       IN      SRV     1 1 80 s1.node.dc1.consul.</span><br><span class="line">;; ADDITIONAL SECTION:</span><br><span class="line">s1.node.dc1.consul.     0       IN      A       10.201.102.198</span><br><span class="line">;; Query time: 0 msec</span><br><span class="line">;; SERVER: 127.0.0.1#8600(127.0.0.1)</span><br><span class="line">;; WHEN: Tue Mar 28 16:10:56 2017</span><br><span class="line">;; MSG SIZE  rcvd: 84</span><br><span class="line">[root@dhcp-10-201-102-198 ~]#12345678910111213141516171819</span><br></pre></td></tr></table></figure>

<p><code>SRV</code>è®°å½•å‘Šè¯‰æˆ‘ä»¬ web è¿™ä¸ªæœåŠ¡è¿è¡ŒäºèŠ‚ç‚¹<code>dhcp-10-201-102-198</code> çš„<code>80</code>ç«¯å£. DNSé¢å¤–è¿”å›äº†èŠ‚ç‚¹çš„Aè®°å½•.</p>
<p>æœ€å,æˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨ DNS API é€šè¿‡æ ‡ç­¾æ¥è¿‡æ»¤æœåŠ¡.åŸºäºæ ‡ç­¾çš„æœåŠ¡æŸ¥è¯¢æ ¼å¼ä¸º<code>TAG.NAME.service.consul</code>. åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­,æˆ‘ä»¬è¯·æ±‚Consulè¿”å›æœ‰ <code>rails</code>æ ‡ç­¾çš„ <code>web</code>æœåŠ¡.æˆ‘ä»¬æˆåŠŸè·å–äº†æˆ‘ä»¬æ³¨å†Œä¸ºè¿™ä¸ªæ ‡ç­¾çš„æœåŠ¡:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@dhcp-10-201-102-198 ~]# dig @127.0.0.1 -p 8600 rails.web.service.consul SRV</span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.8.2rc1-RedHat-9.8.2-0.17.rc1.el6 &lt;&lt;&gt;&gt; @127.0.0.1 -p 8600 rails.web.service.consul SRV</span><br><span class="line">; (1 server found)</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 37307</span><br><span class="line">;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1</span><br><span class="line">;; WARNING: recursion requested but not available</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;rails.web.service.consul.      IN      SRV</span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">rails.web.service.consul. 0     IN      SRV     1 1 80 s1.node.dc1.consul.</span><br><span class="line">;; ADDITIONAL SECTION:</span><br><span class="line">s1.node.dc1.consul.     0       IN      A       10.201.102.198</span><br><span class="line">;; Query time: 0 msec</span><br><span class="line">;; SERVER: 127.0.0.1#8600(127.0.0.1)</span><br><span class="line">;; WHEN: Tue Mar 28 16:11:45 2017</span><br><span class="line">;; MSG SIZE  rcvd: 90</span><br><span class="line">[root@dhcp-10-201-102-198 ~]#12345678910111213141516171819</span><br></pre></td></tr></table></figure>

<p><strong>HTTP API</strong><br> é™¤äº†DNS APIä¹‹å¤–,HTTP APIä¹Ÿå¯ä»¥ç”¨æ¥è¿›è¡ŒæœåŠ¡æŸ¥è¯¢:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@dhcp-10-201-102-198 ~]# curl -s 127.0.0.1:8500/v1/catalog/service/web | python -m json.tool</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;Address&quot;: &quot;10.201.102.198&quot;,</span><br><span class="line">        &quot;CreateIndex&quot;: 492843,</span><br><span class="line">        &quot;ID&quot;: &quot;422ec677-74ef-8f29-2f22-01effeed6334&quot;,</span><br><span class="line">        &quot;ModifyIndex&quot;: 492843,</span><br><span class="line">        &quot;Node&quot;: &quot;s1&quot;,</span><br><span class="line">        &quot;NodeMeta&quot;: &#123;&#125;,</span><br><span class="line">        &quot;ServiceAddress&quot;: &quot;&quot;,</span><br><span class="line">        &quot;ServiceEnableTagOverride&quot;: false,</span><br><span class="line">        &quot;ServiceID&quot;: &quot;web&quot;,</span><br><span class="line">        &quot;ServiceName&quot;: &quot;web&quot;,</span><br><span class="line">        &quot;ServicePort&quot;: 80,</span><br><span class="line">        &quot;ServiceTags&quot;: [</span><br><span class="line">            &quot;rails&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;TaggedAddresses&quot;: &#123;</span><br><span class="line">            &quot;lan&quot;: &quot;10.201.102.198&quot;,</span><br><span class="line">            &quot;wan&quot;: &quot;10.201.102.198&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]1234567891011121314151617181920212223</span><br></pre></td></tr></table></figure>

<p>ç›®å½•APIç»™å‡ºæ‰€æœ‰èŠ‚ç‚¹æä¾›çš„æœåŠ¡.ç¨åæˆ‘ä»¬ä¼šåƒé€šå¸¸çš„é‚£æ ·å¸¦ä¸Šå¥åº·æ£€æŸ¥è¿›è¡ŒæŸ¥è¯¢.å°±åƒDNSå†…éƒ¨å¤„ç†çš„é‚£æ ·.è¿™æ˜¯åªæŸ¥çœ‹å¥åº·çš„å®ä¾‹çš„æŸ¥è¯¢æ–¹æ³•:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@dhcp-10-201-102-198 ~]# curl -s 127.0.0.1:8500/v1/catalog/service/web?passing | python -m json.tool</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;Address&quot;: &quot;10.201.102.198&quot;,</span><br><span class="line">        &quot;CreateIndex&quot;: 492843,</span><br><span class="line">        &quot;ID&quot;: &quot;422ec677-74ef-8f29-2f22-01effeed6334&quot;,</span><br><span class="line">        &quot;ModifyIndex&quot;: 492843,</span><br><span class="line">        &quot;Node&quot;: &quot;s1&quot;,</span><br><span class="line">        &quot;NodeMeta&quot;: &#123;&#125;,</span><br><span class="line">        &quot;ServiceAddress&quot;: &quot;&quot;,</span><br><span class="line">        &quot;ServiceEnableTagOverride&quot;: false,</span><br><span class="line">        &quot;ServiceID&quot;: &quot;web&quot;,</span><br><span class="line">        &quot;ServiceName&quot;: &quot;web&quot;,</span><br><span class="line">        &quot;ServicePort&quot;: 80,</span><br><span class="line">        &quot;ServiceTags&quot;: [</span><br><span class="line">            &quot;rails&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;TaggedAddresses&quot;: &#123;</span><br><span class="line">            &quot;lan&quot;: &quot;10.201.102.198&quot;,</span><br><span class="line">            &quot;wan&quot;: &quot;10.201.102.198&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]1234567891011121314151617181920212223</span><br></pre></td></tr></table></figure>

<h2 id="WEBç®¡ç†ç•Œé¢"><a href="#WEBç®¡ç†ç•Œé¢" class="headerlink" title="WEBç®¡ç†ç•Œé¢"></a>WEBç®¡ç†ç•Œé¢</h2><p>ConsulåŒæ—¶æä¾›äº†ä¸€ä¸ªæ¼‚äº®çš„åŠŸèƒ½é½å…¨çš„WEBç•Œé¢,å¼€ç®±å³ç”¨.ç•Œé¢å¯ä»¥ç”¨æ¥æŸ¥çœ‹æ‰€æœ‰çš„èŠ‚ç‚¹,å¯ä»¥æŸ¥çœ‹å¥åº·æ£€æŸ¥å’Œä»–ä»¬çš„å½“å‰çŠ¶æ€.å¯ä»¥è¯»å–å’Œè®¾ç½®K&#x2F;V å­˜å‚¨çš„æ•°æ®.UIè‡ªåŠ¨æ”¯æŒå¤šæ•°æ®ä¸­å¿ƒ.<a target="_blank" rel="noopener" href="https://www.consul.io/downloads.html">ç‚¹å‡»å‰å¾€ä¸‹è½½</a></p>
<p><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/blog/consul-manual/ui_download.jpg" alt="UI_Download"></p>
<p>ä¸‹è½½å®Œåä¸Šä¼ è‡³æœåŠ¡å™¨ï¼Œå»ºè®®æ‰€æœ‰serverè§’è‰²éƒ½ä½¿ç”¨WebUIã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consul agent -server -bootstrap-expect 1 -data-dir /tmp/consul -node=s1 -bind=10.201.102.198 -ui-dir ./consul_ui/ -rejoin -config-dir=/etc/consul.d/ -client 0.0.0.01</span><br></pre></td></tr></table></figure>

<ul>
<li><code>-ui-dir</code>ï¼š æä¾›å­˜æ”¾web uièµ„æºçš„è·¯å¾„ï¼ŒæŒ‡å‘è¯¥ç›®å½•å¿…é¡»æ˜¯å¯è¯»çš„</li>
<li><code>-client</code>ï¼šconsulæœåŠ¡ä¾¦å¬åœ°å€ï¼Œè¿™ä¸ªåœ°å€æä¾›HTTPã€DNSã€RPCç­‰æœåŠ¡ï¼Œé»˜è®¤æ˜¯127.0.0.1æ‰€ä»¥ä¸å¯¹å¤–æä¾›æœåŠ¡ï¼Œå¦‚æœä½ è¦å¯¹å¤–æä¾›æœåŠ¡æ”¹æˆ0.0.0.0<br> å¯é€šè¿‡<a target="_blank" rel="noopener" href="http://10.201.102.198:8500/">http://10.201.102.198:8500</a>è®¿é—®WEBç®¡ç†ç•Œé¢ã€‚</li>
</ul>
<p><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/blog/consul-manual/ui.jpg" alt="UI_Download"></p>
<h2 id="å¥åº·æ£€æŸ¥"><a href="#å¥åº·æ£€æŸ¥" class="headerlink" title="å¥åº·æ£€æŸ¥"></a>å¥åº·æ£€æŸ¥</h2><p>æˆ‘ä»¬ç°åœ¨çœ‹åˆ°Consulè¿è¡Œæ—¶å¦‚æ­¤ç®€å•.æ·»åŠ èŠ‚ç‚¹å’ŒæœåŠ¡,æŸ¥è¯¢èŠ‚ç‚¹å’ŒæœåŠ¡.åœ¨è¿™ä¸€èŠ‚.æˆ‘ä»¬å°†ç»§ç»­æ·»åŠ å¥åº·æ£€æŸ¥åˆ°èŠ‚ç‚¹å’ŒæœåŠ¡.å¥åº·æ£€æŸ¥æ˜¯æœåŠ¡å‘ç°çš„å…³é”®ç»„ä»¶.é¢„é˜²ä½¿ç”¨åˆ°ä¸å¥åº·çš„æœåŠ¡.</p>
<p>è¿™ä¸€æ­¥å»ºç«‹åœ¨å‰ä¸€èŠ‚çš„Consulé›†ç¾¤åˆ›å»ºä¹‹ä¸Š.ç›®å‰ä½ åº”è¯¥æœ‰ä¸€ä¸ªåŒ…å«å¤šä¸ªèŠ‚ç‚¹çš„Consulé›†ç¾¤.</p>
<p><strong>è‡ªå®šä¹‰æ£€æŸ¥</strong><br> å’ŒæœåŠ¡æ³¨å†Œç±»ä¼¼,ä¸€ä¸ªæ£€æŸ¥å¯ä»¥é€šè¿‡æ£€æŸ¥å®šä¹‰æˆ–HTTP APIè¯·æ±‚æ¥æ³¨å†Œ.</p>
<p>æˆ‘ä»¬å°†ä½¿ç”¨å’Œæ£€æŸ¥å®šä¹‰æ¥æ³¨å†Œæ£€æŸ¥.å’ŒæœåŠ¡ç±»ä¼¼,å› ä¸ºè¿™æ˜¯å»ºç«‹æ£€æŸ¥æœ€å¸¸ç”¨çš„æ–¹å¼.</p>
<p>åœ¨ç¬¬äºŒä¸ªèŠ‚ç‚¹çš„é…ç½®ç›®å½•å»ºç«‹å®šä¹‰æ–‡ä»¶:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/etc/consul.d/web.json1</span><br><span class="line">&#123;&quot;service&quot;: &#123;</span><br><span class="line">    &quot;name&quot;: &quot;Faceid&quot;,</span><br><span class="line">    &quot;tags&quot;: [&quot;extract&quot;, &quot;verify&quot;, &quot;compare&quot;, &quot;idcard&quot;],</span><br><span class="line">    &quot;address&quot;: &quot;10.201.102.198&quot;,</span><br><span class="line">    &quot;port&quot;: 9000,</span><br><span class="line">    &quot;check&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;ping&quot;,</span><br><span class="line">        &quot;script&quot;: &quot;curl -s localhost:9000&quot;,</span><br><span class="line">        &quot;interval&quot;: &quot;3s&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;123456789101112</span><br></pre></td></tr></table></figure>

<p>or</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">/etc/consul.d/web.json1</span><br><span class="line">&#123;&quot;service&quot;: &#123;</span><br><span class="line">    &quot;name&quot;: &quot;Faceid&quot;,</span><br><span class="line">    &quot;tags&quot;: [&quot;extract&quot;, &quot;verify&quot;, &quot;compare&quot;, &quot;idcard&quot;],</span><br><span class="line">    &quot;address&quot;: &quot;10.201.102.199&quot;,</span><br><span class="line">    &quot;port&quot;: 9000,</span><br><span class="line">    &quot;check&quot;: &#123;</span><br><span class="line">        &quot;id&quot;: &quot;api&quot;,</span><br><span class="line">           &quot;name&quot;: &quot;HTTP API on port 9000&quot;,</span><br><span class="line">        &quot;http&quot;: &quot;http://localhost:9000&quot;,</span><br><span class="line">        &quot;interval&quot;: &quot;10s&quot;,</span><br><span class="line">        &quot;timeout&quot;: &quot;1s&quot;</span><br><span class="line">        &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;1234567891011121314</span><br></pre></td></tr></table></figure>

<p>more</p>
<h2 id="æ£€æŸ¥å¥åº·çŠ¶æ€"><a href="#æ£€æŸ¥å¥åº·çŠ¶æ€" class="headerlink" title="æ£€æŸ¥å¥åº·çŠ¶æ€"></a>æ£€æŸ¥å¥åº·çŠ¶æ€</h2><p>æˆ‘ä»¬èƒ½é€‚åº”HTTP APIæ¥æ£€æŸ¥ä»–ä»¬.é¦–å…ˆæˆ‘ä»¬æ£€æŸ¥æœ‰å“ªäº›å¤±è´¥çš„æ£€æŸ¥.ä½¿ç”¨è¿™ä¸ªå‘½ä»¤(æ³¨æ„:è¿™ä¸ªå‘½ä»¤å¯ä»¥è¿è¡Œåœ¨ä»»ä½•èŠ‚ç‚¹)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@dhcp-10-201-102-198 ~]# curl -s http://localhost:8500/v1/health/state/critical | python -m json.tool</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;CheckID&quot;: &quot;service:Faceid&quot;,</span><br><span class="line">        &quot;CreateIndex&quot;: 493398,</span><br><span class="line">        &quot;ModifyIndex&quot;: 493846,</span><br><span class="line">        &quot;Name&quot;: &quot;Service &#x27;Faceid&#x27; check&quot;,</span><br><span class="line">        &quot;Node&quot;: &quot;s1&quot;,</span><br><span class="line">        &quot;Notes&quot;: &quot;&quot;,</span><br><span class="line">        &quot;Output&quot;: &quot;&quot;,</span><br><span class="line">        &quot;ServiceID&quot;: &quot;Faceid&quot;,</span><br><span class="line">        &quot;ServiceName&quot;: &quot;Faceid&quot;,</span><br><span class="line">        &quot;Status&quot;: &quot;critical&quot;</span><br><span class="line">    &#125;</span><br><span class="line">]123456789101112131415</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°,åªæœ‰ä¸€ä¸ªæ£€æŸ¥æˆ‘ä»¬çš„<code>web</code>æœåŠ¡åœ¨<code>critical</code>çŠ¶æ€</p>
<p>å¦å¤–,æˆ‘ä»¬å¯ä»¥å°è¯•ç”¨DNSæŸ¥è¯¢webæœåŠ¡,Consulå°†ä¸ä¼šè¿”å›ç»“æœ.å› ä¸ºæœåŠ¡ä¸å¥åº·.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@dhcp-10-201-102-198 ~]# dig @127.0.0.1 -p 8600 Faceid.service.consul SRV</span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.8.2rc1-RedHat-9.8.2-0.17.rc1.el6 &lt;&lt;&gt;&gt; @127.0.0.1 -p 8600 Faceid.service.consul SRV</span><br><span class="line">; (1 server found)</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 40884</span><br><span class="line">;; flags: qr aa rd; QUERY: 1, ANSWER: 3, AUTHORITY: 0, ADDITIONAL: 3</span><br><span class="line">;; WARNING: recursion requested but not available</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;Faceid.service.consul.         IN      SRV</span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">Faceid.service.consul.  0       IN      SRV     1 1 9000 s3.node.dc1.consul.</span><br><span class="line">Faceid.service.consul.  0       IN      SRV     1 1 9000 s1.node.dc1.consul.</span><br><span class="line">Faceid.service.consul.  0       IN      SRV     1 1 9000 s2.node.dc1.consul.</span><br><span class="line">;; ADDITIONAL SECTION:</span><br><span class="line">s3.node.dc1.consul.     0       IN      A       10.201.102.200</span><br><span class="line">s1.node.dc1.consul.     0       IN      A       10.201.102.198</span><br><span class="line">s2.node.dc1.consul.     0       IN      A       10.201.102.199</span><br><span class="line">;; Query time: 0 msec</span><br><span class="line">;; SERVER: 127.0.0.1#8600(127.0.0.1)</span><br><span class="line">;; WHEN: Tue Mar 28 18:20:15 2017</span><br><span class="line">;; MSG SIZE  rcvd: 16512345678910111213141516171819202122</span><br></pre></td></tr></table></figure>

<h2 id="K-ï¼V"><a href="#K-ï¼V" class="headerlink" title="K ï¼V"></a>K ï¼V</h2><p>é™¤äº†æä¾›æœåŠ¡å‘ç°å’Œå¥åº·æ£€æŸ¥çš„é›†æˆ.Consulæä¾›äº†ä¸€ä¸ªæ˜“ç”¨çš„é”®&#x2F;å€¼å­˜å‚¨.è¿™å¯ä»¥ç”¨æ¥ä¿æŒåŠ¨æ€é…ç½®,ååŠ©æœåŠ¡åè°ƒ,é¢†è¢–é€‰ä¸¾,åšå¼€å‘è€…å¯ä»¥æƒ³åˆ°çš„ä»»ä½•äº‹æƒ….</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@dhcp-10-201-102-198 ~]# curl -v http://localhost:8500/v1/kv/?recurse</span><br><span class="line">* About to connect() to localhost port 8500 (#0)</span><br><span class="line">*   Trying ::1... æ‹’ç»è¿æ¥</span><br><span class="line">*   Trying 127.0.0.1... connected</span><br><span class="line">* Connected to localhost (127.0.0.1) port 8500 (#0)</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">GET /v1/kv/?recurse HTTP/1.1</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">User-Agent: curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.21 Basic ECC zlib/1.2.3 libidn/1.18 libssh2/1.4.2</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">Host: localhost:8500</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">Accept: */*</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">&lt; HTTP/1.1 404 Not Found</span></span><br><span class="line">&lt; X-Consul-Index: 1</span><br><span class="line">&lt; X-Consul-Knownleader: true</span><br><span class="line">&lt; X-Consul-Lastcontact: 0</span><br><span class="line">&lt; Date: Thu, 18 Aug 2016 08:21:39 GMT</span><br><span class="line">&lt; Content-Length: 0</span><br><span class="line">&lt; Content-Type: text/plain; charset=utf-8</span><br><span class="line">&lt;</span><br><span class="line">* Connection #0 to host localhost left intact</span><br><span class="line">* Closing connection #01234567891011121314151617181920</span><br></pre></td></tr></table></figure>

<p>å› ä¸ºæ²¡æœ‰keyæ‰€ä»¥æˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ª404å“åº”.ç°åœ¨æˆ‘ä»¬<code>PUT</code>ä¸€äº›ç¤ºä¾‹çš„Key:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dhcp-10-201-102-198 ~]# curl -X PUT -d &#x27;test&#x27; http://localhost:8500/v1/kv/web/key1</span><br><span class="line">[root@dhcp-10-201-102-198 ~]# curl -X PUT -d &#x27;test&#x27; http://localhost:8500/v1/kv/web/key2?flags=42</span><br><span class="line">[root@dhcp-10-201-102-198 ~]# curl -X PUT -d &#x27;test&#x27;  http://localhost:8500/v1/kv/web/sub/key3123</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬åˆ›å»ºäº†å€¼ä¸ºâ€testâ€çš„3ä¸ªKey,æ³¨æ„è¿”å›çš„å€¼æ˜¯ç»è¿‡äº†<code>base64</code>ç¼–ç çš„.ç”¨æ¥æ”¯æŒéUTF8ç¼–ç å­—ç¬¦.å¯¹Key <code>web/key2</code>æˆ‘ä»¬è®¾ç½®äº†ä¸€ä¸ªæ ‡å¿—å€¼ä¸º <code>42</code>.æ‰€æœ‰çš„keyæ”¯æŒè®¾ç½®ä¸€ä¸ª64ä½çš„æ•´å½¢æ•°å­—æ ‡å¿—.Consulå†…éƒ¨ä¸é€‚ç”¨è¿™ä¸ªå€¼.ä½†æ˜¯ä»–å¯ä»¥è¢«å®¢æˆ·ç«¯é€‚ç”¨æ¥åšä¸€äº›å…ƒæ•°æ®.</p>
<p>å®Œæˆè®¾ç½®å,æˆ‘ä»¬å‘èµ·äº†ä¸€ä¸ª<code>GET</code>è¯·æ±‚æ¥æ¥æ”¶å¤šä¸ªkeyçš„å€¼,ä½¿ç”¨<code>?recurse</code>å‚æ•°.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@dhcp-10-201-102-198 ~]# curl -s http://localhost:8500/v1/kv/web/?recurse | python -m json.tool</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;CreateIndex&quot;: 502660,</span><br><span class="line">        &quot;Flags&quot;: 0,</span><br><span class="line">        &quot;Key&quot;: &quot;web/key1&quot;,</span><br><span class="line">        &quot;LockIndex&quot;: 0,</span><br><span class="line">        &quot;ModifyIndex&quot;: 502660,</span><br><span class="line">        &quot;Value&quot;: &quot;dGVzdA==&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;CreateIndex&quot;: 502663,</span><br><span class="line">        &quot;Flags&quot;: 42,</span><br><span class="line">        &quot;Key&quot;: &quot;web/key2&quot;,</span><br><span class="line">        &quot;LockIndex&quot;: 0,</span><br><span class="line">        &quot;ModifyIndex&quot;: 502663,</span><br><span class="line">        &quot;Value&quot;: &quot;dGVzdA==&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;CreateIndex&quot;: 502665,</span><br><span class="line">        &quot;Flags&quot;: 0,</span><br><span class="line">        &quot;Key&quot;: &quot;web/sub/key3&quot;,</span><br><span class="line">        &quot;LockIndex&quot;: 0,</span><br><span class="line">        &quot;ModifyIndex&quot;: 502665,</span><br><span class="line">        &quot;Value&quot;: &quot;dGVzdA==&quot;</span><br><span class="line">    &#125;</span><br><span class="line">]123456789101112131415161718192021222324252627</span><br></pre></td></tr></table></figure>

<p>ä½ å¯ä»¥è·å–<strong>å•ä¸ª</strong>çš„key</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@dhcp-10-201-102-198 ~]# curl -s http://localhost:8500/v1/kv/web/key1 | python -m json.tool</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;CreateIndex&quot;: 502660,</span><br><span class="line">        &quot;Flags&quot;: 0,</span><br><span class="line">        &quot;Key&quot;: &quot;web/key1&quot;,</span><br><span class="line">        &quot;LockIndex&quot;: 0,</span><br><span class="line">        &quot;ModifyIndex&quot;: 502660,</span><br><span class="line">        &quot;Value&quot;: &quot;dGVzdA==&quot;</span><br><span class="line">    &#125;</span><br><span class="line">]1234567891011</span><br></pre></td></tr></table></figure>

<p>åˆ é™¤keyä¹Ÿå¾ˆç®€å•.é€šè¿‡<code>DELETE</code>åŠ¨ä½œæ¥å®Œæˆ.æˆ‘ä»¬å¯ä»¥é€šè¿‡æŒ‡å®šå®Œæ•´è·¯å¾„æ¥åˆ é™¤ä¸€ä¸ªå•ç‹¬çš„key.æˆ–è€…æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>?recurse</code><strong>é€’å½’</strong>çš„åˆ é™¤ä¸»è·¯å¾„ä¸‹æ‰€æœ‰key.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@dhcp-10-201-102-198 ~]# curl -X DELETE http://localhost:8500/v1/kv/web/sub?recurse</span><br><span class="line">true12</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥é€šè¿‡å‘é€ç›¸åŒçš„URLå¹¶æä¾›ä¸åŒçš„æ¶ˆæ¯ä½“çš„<code>PUT</code>è¯·æ±‚å»ä¿®æ”¹ä¸€ä¸ªKey.å¦å¤–,Consulæä¾›ä¸€ä¸ªæ£€æŸ¥å¹¶è®¾ç½®çš„æ“ä½œ,å®ç°åŸå­çš„Keyä¿®æ”¹.é€šè¿‡<code>?cas=å‚æ•°</code>åŠ ä¸Š<code>GET</code>ä¸­æœ€è¿‘çš„<code>ModifyIndex</code>æ¥è¾¾åˆ°. ä¾‹å¦‚æˆ‘ä»¬æƒ³ä¿®æ”¹ â€œweb&#x2F;key1â€:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl -X PUT -d &#x27;newval&#x27; http://localhost:8500/v1/kv/web/key1?cas=502660</span><br><span class="line">true</span><br><span class="line">curl -X PUT -d &#x27;newval&#x27; http://localhost:8500/v1/kv/web/key1?cas=502660</span><br><span class="line">false1234</span><br></pre></td></tr></table></figure>

<p>åœ¨è¿™ç§æƒ…å†µä¸‹,ç¬¬ä¸€æ¬¡<code>CAS</code> æ›´æ–°æˆåŠŸå› ä¸º<code>ModifyIndex</code>æ˜¯<code>502660</code>.è€Œç¬¬äºŒæ¬¡å¤±è´¥æ˜¯å› ä¸º<code>ModifyIndex</code>åœ¨ç¬¬ä¸€æ¬¡æ›´æ–°åå·²ç»ä¸æ˜¯<code>502660</code>äº† .</p>
<p>æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨<code>ModifyIndex</code>æ¥ç­‰å¾…keyå€¼çš„æ”¹å˜.ä¾‹å¦‚æˆ‘ä»¬æƒ³ç­‰å¾…<code>key2</code>è¢«ä¿®æ”¹:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@dhcp-10-201-102-198 ~]# curl &quot;http://localhost:8500/v1/kv/web/key2&quot;</span><br><span class="line">[&#123;&quot;LockIndex&quot;:0,&quot;Key&quot;:&quot;web/key2&quot;,&quot;Flags&quot;:42,&quot;Value&quot;:&quot;dGVzdA==&quot;,&quot;CreateIndex&quot;:502663,&quot;ModifyIndex&quot;:502663&#125;]</span><br><span class="line">[root@dhcp-10-201-102-198 ~]# curl &quot;http://localhost:8500/v1/kv/web/key2?index=502663&amp;wait=5s&quot;</span><br><span class="line">[&#123;&quot;LockIndex&quot;:0,&quot;Key&quot;:&quot;web/key2&quot;,&quot;Flags&quot;:42,&quot;Value&quot;:&quot;dGVzdA==&quot;,&quot;CreateIndex&quot;:502663,&quot;ModifyIndex&quot;:502663&#125;]1234</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡æä¾› <code>?index=</code>,æˆ‘ä»¬è¯·æ±‚ç­‰å¾…keyå€¼æœ‰ä¸€ä¸ªæ¯”<code>502663</code>æ›´å¤§çš„<code>ModifyIndex</code>.è™½ç„¶<code>?wait=5s</code>å‚æ•°é™åˆ¶äº†è¿™ä¸ªè¯·æ±‚æœ€å¤š5ç§’,å¦åˆ™è¿”å›å½“å‰çš„æœªæ”¹å˜çš„å€¼. è¿™æ ·å¯ä»¥æœ‰æ•ˆçš„ç­‰å¾…keyçš„æ”¹å˜.å¦å¤–,è¿™ä¸ªåŠŸèƒ½å¯ä»¥ç”¨äºç­‰å¾…ä¸€ç»„key.ç›´åˆ°å…¶ä¸­çš„æŸä¸ªkeyæœ‰ä¿®æ”¹.</p>
<h1 id="Conusl-å‘½ä»¤è¡Œ"><a href="#Conusl-å‘½ä»¤è¡Œ" class="headerlink" title="Conusl å‘½ä»¤è¡Œ"></a>Conusl å‘½ä»¤è¡Œ</h1><p>è§è¯†äº†consulçš„å¼ºå¤§ï¼Œconsulå¯ä»¥é€šè¿‡ä¸€ä¸ªç®€å•çš„CLIæ¥æ§åˆ¶ï¼Œconsulåªæœ‰ä¸€ä¸ªå‘½ä»¤è¡Œåº”ç”¨ï¼Œå°±æ˜¯consulå‘½ä»¤ï¼Œconsulå‘½ä»¤å¯ä»¥åŒ…å«agentã€membersç­‰å‚æ•°è¿›è¡Œä½¿ç”¨ï¼Œè¿™ä¸€ç¯‡æ¥å…·ä½“çœ‹çœ‹consul  CLIçš„å…·ä½“ç”¨æ³•ï¼Œconsul -hå³å¯çœ‹åˆ°consul cliæ‰€æ”¯æŒçš„å‚æ•°ï¼Œè€Œæ¯ä¸ªå‚æ•°é‡Œé¢åˆæ”¯æŒå…¶ä»–å‚æ•°ï¼Œä¸‹é¢æˆ‘ä»¬å°±æ¥å…·ä½“çœ‹çœ‹ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@dhcp-10-201-102-198 ~]# consul</span><br><span class="line">usage: consul [--version] [--help] &lt;command&gt; [&lt;args&gt;]</span><br><span class="line">Available commands are:</span><br><span class="line">    agent          Runs a Consul agent  è¿è¡Œä¸€ä¸ªconsul agent</span><br><span class="line">    configtest     Validate config file</span><br><span class="line">    event          Fire a new event</span><br><span class="line">    exec           Executes a command on Consul nodes  åœ¨consulèŠ‚ç‚¹ä¸Šæ‰§è¡Œä¸€ä¸ªå‘½ä»¤</span><br><span class="line">    force-leave    Forces a member of the cluster to enter the &quot;left&quot; state   å¼ºåˆ¶èŠ‚ç‚¹æˆå‘˜åœ¨é›†ç¾¤ä¸­çš„çŠ¶æ€è½¬æ¢åˆ°leftçŠ¶æ€</span><br><span class="line">    info           Provides debugging information for operators  æä¾›æ“ä½œçš„debugçº§åˆ«çš„ä¿¡æ¯</span><br><span class="line">    join           Tell Consul agent to join cluster   åŠ å…¥consulèŠ‚ç‚¹åˆ°é›†ç¾¤ä¸­</span><br><span class="line">    keygen         Generates a new encryption key  ç”Ÿæˆä¸€ä¸ªæ–°çš„åŠ å¯†key</span><br><span class="line">    keyring        Manages gossip layer encryption keys</span><br><span class="line">    kv             Interact with the key-value store</span><br><span class="line">    leave          Gracefully leaves the Consul cluster and shuts down</span><br><span class="line">    lock           Execute a command holding a lock</span><br><span class="line">    maint          Controls node or service maintenance mode</span><br><span class="line">    members        Lists the members of a Consul cluster    åˆ—å‡ºé›†ç¾¤ä¸­æˆå‘˜</span><br><span class="line">    monitor        Stream logs from a Consul agent  æ‰“å°consulèŠ‚ç‚¹çš„æ—¥å¿—ä¿¡æ¯</span><br><span class="line">    operator       Provides cluster-level tools for Consul operators</span><br><span class="line">    reload         Triggers the agent to reload configuration files   è§¦å‘èŠ‚ç‚¹é‡æ–°åŠ è½½é…ç½®æ–‡ä»¶</span><br><span class="line">    rtt            Estimates network round trip time between nodes</span><br><span class="line">    snapshot       Saves, restores and inspects snapshots of Consul server state</span><br><span class="line">    version        Prints the Consul version    æ‰“å°consulçš„ç‰ˆæœ¬ä¿¡æ¯</span><br><span class="line">    watch          Watch for changes in Consul   ç›‘æ§consulçš„æ”¹å˜123456789101112131415161718192021222324</span><br></pre></td></tr></table></figure>

<p>æ›´è¯¦ç»†è§<a target="_blank" rel="noopener" href="https://www.consul.io/docs/commands/index.html">å®˜ç½‘</a></p>
<h2 id="Agent"><a href="#Agent" class="headerlink" title="Agent"></a>Agent</h2><p><code>agent</code>æŒ‡ä»¤æ˜¯consulçš„æ ¸å¿ƒï¼Œå®ƒè¿è¡Œagentæ¥ç»´æŠ¤æˆå‘˜çš„é‡è¦ä¿¡æ¯ã€è¿è¡Œæ£€æŸ¥ã€æœåŠ¡å®£å¸ƒã€æŸ¥è¯¢å¤„ç†ç­‰ç­‰ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">==&gt; Usage: consul agent [options]</span><br><span class="line">  Starts the Consul agent and runs until an interrupt is received. The</span><br><span class="line">  agent represents a single node in a cluster.</span><br><span class="line">Options:</span><br><span class="line">  -advertise=addr                  Sets the advertise address to use</span><br><span class="line">  -advertise-wan=addr              Sets address to advertise on wan instead of</span><br><span class="line">                                   advertise addr</span><br><span class="line">  -bootstrap                       Sets server to bootstrap mode</span><br><span class="line">  -bind=0.0.0.0                    Sets the bind address for cluster</span><br><span class="line">                                   communication</span><br><span class="line">  -http-port=8500                  Sets the HTTP API port to listen on</span><br><span class="line">  -bootstrap-expect=0              Sets server to expect bootstrap mode.</span><br><span class="line">  -client=127.0.0.1                Sets the address to bind for client access.</span><br><span class="line">                                   This includes RPC, DNS, HTTP and HTTPS (if</span><br><span class="line">                                   configured)</span><br><span class="line">  -config-file=foo                 Path to a JSON file to read configuration</span><br><span class="line">                                   from. This can be specified multiple times.</span><br><span class="line">  -config-dir=foo                  Path to a directory to read configuration</span><br><span class="line">                                   files from. This will read every file ending</span><br><span class="line">                                   in &quot;.json&quot; as configuration in this</span><br><span class="line">                                   directory in alphabetical order. This can be</span><br><span class="line">                                   specified multiple times.</span><br><span class="line">  -data-dir=path                   Path to a data directory to store agent</span><br><span class="line">                                   state</span><br><span class="line">  -dev                             Starts the agent in development mode.</span><br><span class="line">  -recursor=1.2.3.4                Address of an upstream DNS server.</span><br><span class="line">                                   Can be specified multiple times.</span><br><span class="line">  -dc=east-aws                     Datacenter of the agent (deprecated: use</span><br><span class="line">                                   &#x27;datacenter&#x27; instead).</span><br><span class="line">  -datacenter=east-aws             Datacenter of the agent.</span><br><span class="line">  -encrypt=key                     Provides the gossip encryption key</span><br><span class="line">  -join=1.2.3.4                    Address of an agent to join at start time.</span><br><span class="line">                                   Can be specified multiple times.</span><br><span class="line">  -join-wan=1.2.3.4                Address of an agent to join -wan at start</span><br><span class="line">                                   time. Can be specified multiple times.</span><br><span class="line">  -retry-join=1.2.3.4              Address of an agent to join at start time</span><br><span class="line">                                   with retries enabled. Can be specified</span><br><span class="line">                                   multiple times.</span><br><span class="line">  -retry-interval=30s              Time to wait between join attempts.</span><br><span class="line">  -retry-max=0                     Maximum number of join attempts. Defaults to</span><br><span class="line">                                   0, which will retry indefinitely.</span><br><span class="line">  -retry-join-ec2-region           EC2 Region to use for discovering servers to</span><br><span class="line">                                   join.</span><br><span class="line">  -retry-join-ec2-tag-key          EC2 tag key to filter on for server</span><br><span class="line">                                   discovery</span><br><span class="line">  -retry-join-ec2-tag-value        EC2 tag value to filter on for server</span><br><span class="line">                                   discovery</span><br><span class="line">  -retry-join-gce-project-name     Google Compute Engine project to discover</span><br><span class="line">                                   servers in</span><br><span class="line">  -retry-join-gce-zone-pattern     Google Compute Engine region or zone to</span><br><span class="line">                                   discover servers in (regex pattern)</span><br><span class="line">  -retry-join-gce-tag-value        Google Compute Engine tag value to filter</span><br><span class="line">                                   for server discovery</span><br><span class="line">  -retry-join-gce-credentials-file Path to credentials JSON file to use with</span><br><span class="line">                                   Google Compute Engine</span><br><span class="line">  -retry-join-wan=1.2.3.4          Address of an agent to join -wan at start</span><br><span class="line">                                   time with retries enabled. Can be specified</span><br><span class="line">                                   multiple times.</span><br><span class="line">  -retry-interval-wan=30s          Time to wait between join -wan attempts.</span><br><span class="line">  -retry-max-wan=0                 Maximum number of join -wan attempts.</span><br><span class="line">                                   Defaults to 0, which will retry</span><br><span class="line">                                   indefinitely.</span><br><span class="line">  -log-level=info                  Log level of the agent.</span><br><span class="line">  -node=hostname                   Name of this node. Must be unique in the</span><br><span class="line">                                   cluster</span><br><span class="line">  -node-meta=key:value             An arbitrary metadata key/value pair for</span><br><span class="line">                                   this node.</span><br><span class="line">                                   This can be specified multiple times.</span><br><span class="line">  -protocol=N                      Sets the protocol version. Defaults to</span><br><span class="line">                                   latest.</span><br><span class="line">  -rejoin                          Ignores a previous leave and attempts to</span><br><span class="line">                                   rejoin the cluster.</span><br><span class="line">  -server                          Switches agent to server mode.</span><br><span class="line">  -syslog                          Enables logging to syslog</span><br><span class="line">  -ui                              Enables the built-in static web UI server</span><br><span class="line">  -ui-dir=path                     Path to directory containing the Web UI</span><br><span class="line">                                   resources</span><br><span class="line">  -pid-file=path                   Path to file to store agent PID123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778</span><br></pre></td></tr></table></figure>

<h2 id="event"><a href="#event" class="headerlink" title="event"></a>event</h2><p><code>event</code>å‘½ä»¤æä¾›äº†ä¸€ç§æœºåˆ¶ï¼Œç”¨æ¥fireè‡ªå®šä¹‰çš„ç”¨æˆ·äº‹ä»¶ï¼Œè¿™äº›äº‹ä»¶å¯¹consulæ¥è¯´æ˜¯ä¸é€æ˜çš„ï¼Œä½†å®ƒä»¬å¯ä»¥ç”¨æ¥æ„å»ºè‡ªåŠ¨éƒ¨ç½²ã€é‡å¯æœåŠ¡æˆ–è€…å…¶ä»–è¡ŒåŠ¨çš„è„šæœ¬ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-http-addrï¼šhttpæœåŠ¡çš„åœ°å€ï¼Œagentå¯ä»¥é“¾æ¥ä¸Šæ¥å‘é€å‘½ä»¤ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œåˆ™é»˜è®¤æ˜¯127.0.0.1:8500ã€‚</span><br><span class="line">-datacenterï¼šæ•°æ®ä¸­å¿ƒã€‚</span><br><span class="line">-nameï¼šäº‹ä»¶çš„åç§°</span><br><span class="line">-nodeï¼šä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ï¼Œç”¨æ¥è¿‡æ»¤èŠ‚ç‚¹</span><br><span class="line">-serviceï¼šä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ï¼Œç”¨æ¥è¿‡æ»¤èŠ‚ç‚¹ä¸ŠåŒ¹é…çš„æœåŠ¡</span><br><span class="line">-tagï¼šä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ï¼Œç”¨æ¥è¿‡æ»¤èŠ‚ç‚¹ä¸Šç¬¦åˆtagçš„æœåŠ¡ï¼Œå¿…é¡»å’Œ-serviceä¸€èµ·ä½¿ç”¨ã€‚123456</span><br></pre></td></tr></table></figure>

<h2 id="exec"><a href="#exec" class="headerlink" title="exec"></a>exec</h2><p><code>exec</code>æŒ‡ä»¤æä¾›äº†ä¸€ç§è¿œç¨‹æ‰§è¡Œæœºåˆ¶ï¼Œæ¯”å¦‚ä½ è¦åœ¨æ‰€æœ‰çš„æœºå™¨ä¸Šæ‰§è¡Œuptimeå‘½ä»¤ï¼Œè¿œç¨‹æ‰§è¡Œçš„å·¥ä½œé€šè¿‡jobæ¥æŒ‡å®šï¼Œå­˜å‚¨åœ¨KVä¸­ï¼Œagentä½¿ç”¨eventç³»ç»Ÿå¯ä»¥å¿«é€Ÿçš„çŸ¥é“æœ‰æ–°çš„jobäº§ç”Ÿï¼Œæ¶ˆæ¯æ˜¯é€šè¿‡gossipåè®®æ¥ä¼ é€’çš„ï¼Œå› æ­¤æ¶ˆæ¯ä¼ é€’æ˜¯æœ€ä½³çš„ï¼Œä½†æ˜¯å¹¶ä¸ä¿è¯å‘½ä»¤çš„æ‰§è¡Œã€‚äº‹ä»¶é€šè¿‡gossipæ¥é©±åŠ¨ï¼Œè¿œç¨‹æ‰§è¡Œä¾èµ–KVå­˜å‚¨ç³»ç»Ÿ(å°±åƒæ¶ˆæ¯ä»£ç†ä¸€æ ·)ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">-http-addrï¼šhttpæœåŠ¡çš„åœ°å€ï¼Œagentå¯ä»¥é“¾æ¥ä¸Šæ¥å‘é€å‘½ä»¤ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œåˆ™é»˜è®¤æ˜¯127.0.0.1:8500ã€‚</span><br><span class="line">-datacenterï¼šæ•°æ®ä¸­å¿ƒã€‚</span><br><span class="line">-prefixï¼škeyåœ¨KVç³»ç»Ÿä¸­çš„å‰ç¼€ï¼Œç”¨æ¥å­˜å‚¨è¯·æ±‚æ•°æ®ï¼Œé»˜è®¤æ˜¯_rexec</span><br><span class="line">-nodeï¼šä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ï¼Œç”¨æ¥è¿‡æ»¤èŠ‚ç‚¹ï¼Œè¯„ä¼°äº‹ä»¶</span><br><span class="line">-serviceï¼šä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ï¼Œç”¨æ¥è¿‡æ»¤èŠ‚ç‚¹ä¸ŠåŒ¹é…çš„æœåŠ¡</span><br><span class="line">-tagï¼šä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ï¼Œç”¨æ¥è¿‡æ»¤èŠ‚ç‚¹ä¸Šç¬¦åˆtagçš„æœåŠ¡ï¼Œå¿…é¡»å’Œ-serviceä¸€èµ·ä½¿ç”¨ã€‚</span><br><span class="line">-waitï¼šåœ¨èŠ‚ç‚¹å¤šé•¿æ—¶é—´æ²¡æœ‰å“åº”åï¼Œè®¤ä¸ºjobå·²ç»å®Œæˆã€‚</span><br><span class="line">-wait-replï¼š</span><br><span class="line">-verboseï¼šè¾“å‡ºæ›´å¤šä¿¡æ¯123456789</span><br></pre></td></tr></table></figure>

<h2 id="force-leave"><a href="#force-leave" class="headerlink" title="force-leave"></a>force-leave</h2><p><code>force-leave</code>æ²»ç–—å¯ä»¥å¼ºåˆ¶consulé›†ç¾¤ä¸­çš„æˆå‘˜è¿›å…¥leftçŠ¶æ€(ç©ºé—²çŠ¶æ€)ï¼Œè®°ä½ï¼Œå³ä½¿ä¸€ä¸ªæˆå‘˜å¤„äºæ´»è·ƒçŠ¶æ€ï¼Œå®ƒä»æ—§å¯ä»¥å†æ¬¡åŠ å…¥é›†ç¾¤ä¸­ï¼Œè¿™ä¸ªæ–¹æ³•çš„çœŸå®ç›®çš„æ˜¯å¼ºåˆ¶ç§»é™¤failedçš„èŠ‚ç‚¹ã€‚å¦‚æœfailedçš„èŠ‚ç‚¹è¿˜æ˜¯ç½‘ç»œçš„ä¸€éƒ¨åˆ†ï¼Œåˆ™consulä¼šå‘¨æœŸæ€§çš„é‡æ–°é“¾æ¥failedçš„èŠ‚ç‚¹ï¼Œå¦‚æœç»è¿‡ä¸€æ®µæ—¶é—´å(é»˜è®¤æ˜¯72å°æ—¶)ï¼Œconsulåˆ™ä¼šå®£å¸ƒåœæ­¢å°è¯•é“¾æ¥failedçš„èŠ‚ç‚¹ã€‚force-leaveæŒ‡ä»¤å¯ä»¥å¿«é€Ÿçš„æŠŠfailedèŠ‚ç‚¹è½¬æ¢åˆ°leftçŠ¶æ€ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-rpc-addr:ä¸€ä¸ªrpcåœ°å€ï¼Œagentå¯ä»¥é“¾æ¥ä¸Šæ¥å‘é€å‘½ä»¤ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œé»˜è®¤æ˜¯127.0.0.1:8400ã€‚1</span><br></pre></td></tr></table></figure>

<h2 id="info"><a href="#info" class="headerlink" title="info"></a>info</h2><p><code>info</code>æŒ‡ä»¤æä¾›äº†å„ç§æ“ä½œæ—¶å¯ä»¥ç”¨åˆ°çš„debugä¿¡æ¯ï¼Œå¯¹äºclientå’Œserverï¼Œinfoæœ‰è¿”å›ä¸åŒçš„å­ç³»ç»Ÿä¿¡æ¯ï¼Œç›®å‰æœ‰ä»¥ä¸‹å‡ ä¸ªKVä¿¡æ¯ï¼šagent(æä¾›agentä¿¡æ¯)ï¼Œconsul(æä¾›consulåº“çš„ä¿¡æ¯)ï¼Œraft(æä¾›raftåº“çš„ä¿¡æ¯)ï¼Œserf_lan(æä¾›LAN  gossip pool),serf_wan(æä¾›WAN gossip pool)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-rpc-addrï¼šä¸€ä¸ªrpcåœ°å€ï¼Œagentå¯ä»¥é“¾æ¥ä¸Šæ¥å‘é€å‘½ä»¤ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œé»˜è®¤æ˜¯127.0.0.1:84001</span><br></pre></td></tr></table></figure>

<h2 id="join"><a href="#join" class="headerlink" title="join"></a>join</h2><p><code>join</code>æŒ‡ä»¤å‘Šè¯‰consul agentåŠ å…¥ä¸€ä¸ªå·²ç»å­˜åœ¨çš„é›†ç¾¤ä¸­ï¼Œä¸€ä¸ªæ–°çš„consul  agentå¿…é¡»åŠ å…¥ä¸€ä¸ªå·²ç»æœ‰è‡³å°‘ä¸€ä¸ªæˆå‘˜çš„é›†ç¾¤ä¸­ï¼Œè¿™æ ·å®ƒæ‰èƒ½åŠ å…¥å·²ç»å­˜åœ¨çš„é›†ç¾¤ä¸­ï¼Œå¦‚æœä½ ä¸åŠ å…¥ä¸€ä¸ªå·²ç»å­˜åœ¨çš„é›†ç¾¤ï¼Œåˆ™agentæ˜¯å®ƒè‡ªèº«é›†ç¾¤çš„ä¸€éƒ¨åˆ†ï¼Œå…¶ä»–agentåˆ™å¯ä»¥åŠ å…¥è¿›æ¥ã€‚agentså¯ä»¥åŠ å…¥å…¶ä»–agentå¤šæ¬¡ã€‚consul  join [options] addressã€‚å¦‚æœä½ æƒ³åŠ å…¥å¤šä¸ªé›†ç¾¤ï¼Œåˆ™å¯ä»¥å†™å¤šä¸ªåœ°å€ï¼Œconsulä¼šåŠ å…¥æ‰€æœ‰çš„åœ°å€ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-wanï¼šagentè¿è¡Œåœ¨serveræ¨¡å¼ï¼Œxxxxxxx</span><br><span class="line">-rpc-addrï¼šä¸€ä¸ªrpcåœ°å€ï¼Œagentå¯ä»¥é“¾æ¥ä¸Šæ¥å‘é€å‘½ä»¤ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œé»˜è®¤æ˜¯127.0.0.1:8400ã€‚12</span><br></pre></td></tr></table></figure>

<h2 id="keygen"><a href="#keygen" class="headerlink" title="keygen"></a>keygen</h2><p><code>keygen</code>æŒ‡ä»¤ç”ŸæˆåŠ å¯†çš„å¯†é’¥ï¼Œå¯ä»¥ç”¨åœ¨consul agenté€šè®¯åŠ å¯†</p>
<p>ç”Ÿæˆä¸€ä¸ªkey</p>
<h2 id="leave"><a href="#leave" class="headerlink" title="leave"></a>leave</h2><p><code>leave</code>æŒ‡ä»¤è§¦å‘ä¸€ä¸ªä¼˜é›…çš„ç¦»å¼€åŠ¨ä½œå¹¶å…³é—­agentï¼ŒèŠ‚ç‚¹ç¦»å¼€åä¸ä¼šå°è¯•é‡æ–°åŠ å…¥é›†ç¾¤ä¸­ã€‚è¿è¡Œåœ¨serverçŠ¶æ€çš„èŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹ä¼šè¢«ä¼˜é›…çš„åˆ é™¤ï¼Œè¿™æ˜¯å¾ˆä¸¥é‡çš„ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ä¸€ä¸ªä¸ä¼˜é›…çš„ç¦»å¼€ä¼šå½±å“åˆ°é›†ç¾¤çš„å¯ç”¨æ€§ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-rpc-addr:ä¸€ä¸ªrpcåœ°å€ï¼Œagentå¯ä»¥é“¾æ¥ä¸Šæ¥å‘é€å‘½ä»¤ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œé»˜è®¤æ˜¯127.0.0.1:8400ã€‚1</span><br></pre></td></tr></table></figure>

<h2 id="members"><a href="#members" class="headerlink" title="members"></a>members</h2><p><code>members</code>æŒ‡ä»¤è¾“å‡ºconsul agentç›®å‰æ‰€çŸ¥é“çš„æ‰€æœ‰çš„æˆå‘˜ä»¥åŠå®ƒä»¬çš„çŠ¶æ€ï¼ŒèŠ‚ç‚¹çš„çŠ¶æ€åªæœ‰aliveã€leftã€failedä¸‰ç§çŠ¶æ€ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-detailedï¼šè¾“å‡ºæ¯ä¸ªèŠ‚ç‚¹æ›´è¯¦ç»†çš„ä¿¡æ¯ã€‚</span><br><span class="line">-rpc-addrï¼šä¸€ä¸ªrpcåœ°å€ï¼Œagentå¯ä»¥é“¾æ¥ä¸Šæ¥å‘é€å‘½ä»¤ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œé»˜è®¤æ˜¯127.0.0.1:8400ã€‚</span><br><span class="line">-statusï¼šè¿‡æ»¤å‡ºç¬¦åˆæ­£åˆ™è§„åˆ™çš„èŠ‚ç‚¹</span><br><span class="line">-wanï¼šxxxxxx1234</span><br></pre></td></tr></table></figure>

<h2 id="monitor"><a href="#monitor" class="headerlink" title="monitor"></a>monitor</h2><p><code>monitor</code>æŒ‡ä»¤ç”¨æ¥é“¾æ¥è¿è¡Œçš„agentï¼Œå¹¶æ˜¾ç¤ºæ—¥å¿—ã€‚monitorä¼šæ˜¾ç¤ºæœ€è¿‘çš„æ—¥å¿—ï¼Œå¹¶æŒç»­çš„æ˜¾ç¤ºæ—¥å¿—æµï¼Œä¸ä¼šè‡ªåŠ¨é€€å‡ºï¼Œé™¤éä½ æ‰‹åŠ¨æˆ–è€…è¿œç¨‹agentè‡ªå·±é€€å‡ºã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-log-levelï¼šæ˜¾ç¤ºå“ªä¸ªçº§åˆ«çš„æ—¥å¿—ï¼Œé»˜è®¤æ˜¯info</span><br><span class="line">-rpc-addrï¼šä¸€ä¸ªrpcåœ°å€ï¼Œagentå¯ä»¥é“¾æ¥ä¸Šæ¥å‘é€å‘½ä»¤ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œé»˜è®¤æ˜¯127.0.0.1:840012</span><br></pre></td></tr></table></figure>

<h2 id="reload"><a href="#reload" class="headerlink" title="reload"></a>reload</h2><p><code>reload</code>æŒ‡ä»¤å¯ä»¥é‡æ–°åŠ è½½agentçš„é…ç½®æ–‡ä»¶ã€‚SIGHUPæŒ‡ä»¤åœ¨é‡æ–°åŠ è½½é…ç½®æ–‡ä»¶æ—¶ä½¿ç”¨ï¼Œä»»ä½•é‡æ–°åŠ è½½çš„é”™è¯¯éƒ½ä¼šå†™åœ¨agentçš„logæ–‡ä»¶ä¸­ï¼Œå¹¶ä¸ä¼šæ‰“å°åˆ°å±å¹•ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-rpc-addrï¼šä¸€ä¸ªrpcåœ°å€ï¼Œagentå¯ä»¥é“¾æ¥ä¸Šæ¥å‘é€å‘½ä»¤ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œé»˜è®¤æ˜¯127.0.0.1:84001</span><br></pre></td></tr></table></figure>

<h2 id="version"><a href="#version" class="headerlink" title="version"></a>version</h2><p>æ‰“å°consulçš„ç‰ˆæœ¬</p>
<h2 id="watch"><a href="#watch" class="headerlink" title="watch"></a>watch</h2><p><code>watch</code>æŒ‡ä»¤æä¾›äº†ä¸€ä¸ªæœºåˆ¶ï¼Œç”¨æ¥ç›‘è§†å®é™…æ•°æ®è§†å›¾çš„æ”¹å˜(èŠ‚ç‚¹åˆ—è¡¨ã€æˆå‘˜æœåŠ¡ã€KV)ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šè¿›ç¨‹ï¼Œå½“å‰å€¼ä¼šè¢«dumpå‡ºæ¥</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">-http-addrï¼šhttpæœåŠ¡çš„åœ°å€ï¼Œagentå¯ä»¥é“¾æ¥ä¸Šæ¥å‘é€å‘½ä»¤ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œåˆ™é»˜è®¤æ˜¯127.0.0.1:8500ã€‚</span><br><span class="line">-datacenterï¼šæ•°æ®ä¸­å¿ƒæŸ¥è¯¢ã€‚</span><br><span class="line">-tokenï¼šACL token</span><br><span class="line">-keyï¼šç›‘è§†keyï¼Œåªé’ˆå¯¹keyç±»å‹</span><br><span class="line">-nameï¼šç›‘è§†eventï¼Œåªé’ˆå¯¹eventç±»å‹</span><br><span class="line">-prefixï¼šç›‘è§†key prefixï¼Œåªé’ˆå¯¹keyprefixç±»å‹</span><br><span class="line">-serviceï¼šç›‘æ§serviceï¼Œåªé’ˆå¯¹serviceç±»å‹</span><br><span class="line">-stateï¼šè¿‡ç•¥check state</span><br><span class="line">-tagï¼šè¿‡æ»¤service tag</span><br><span class="line">-typeï¼šç›‘æ§ç±»å‹ï¼Œä¸€èˆ¬æœ‰keyã€keyprefixã€serviceã€nodesã€checksã€event12345678910</span><br></pre></td></tr></table></figure>

<h1 id="Consul-é…ç½®"><a href="#Consul-é…ç½®" class="headerlink" title="Consul é…ç½®"></a>Consul é…ç½®</h1><p>agentæœ‰å„ç§å„æ ·çš„é…ç½®é¡¹å¯ä»¥åœ¨å‘½ä»¤è¡Œæˆ–è€…é…ç½®æ–‡ä»¶è¿›è¡Œå®šä¹‰ï¼Œæ‰€æœ‰çš„é…ç½®é¡¹éƒ½æ˜¯å¯é€‰æ‹©çš„ï¼Œå½“åŠ è½½é…ç½®æ–‡ä»¶çš„æ—¶å€™ï¼Œconsulä»é…ç½®æ–‡ä»¶æˆ–è€…é…ç½®ç›®å½•åŠ è½½é…ç½®ã€‚åé¢å®šä¹‰çš„é…ç½®ä¼šåˆå¹¶å‰é¢å®šä¹‰çš„é…ç½®ï¼Œä½†æ˜¯å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œåˆå¹¶çš„æ„æ€æ˜¯åé¢å®šä¹‰çš„é…ç½®ä¼šè¦†ç›–å‰é¢å®šä¹‰çš„é…ç½®ï¼Œä½†æ˜¯æœ‰äº›æƒ…å†µï¼Œä¾‹å¦‚eventå¥æŸ„ï¼Œåˆå¹¶ä»…ä»…æ˜¯æ·»åŠ åˆ°å‰é¢å®šä¹‰çš„å¥æŸ„åé¢ã€‚consulé‡æ–°åŠ è½½é…ç½®æ–‡ä»¶ä¹Ÿæ”¯æŒä»¥ä¿¡å·çš„æ–¹å¼æ¥æ”¶updateä¿¡å·ã€‚</p>
<p>ä¸‹é¢çœ‹çœ‹å‘½ä»¤è¡Œå‚æ•°ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">-advertiseï¼šé€šçŸ¥å±•ç°åœ°å€ç”¨æ¥æ”¹å˜æˆ‘ä»¬ç»™é›†ç¾¤ä¸­çš„å…¶ä»–èŠ‚ç‚¹å±•ç°çš„åœ°å€ï¼Œä¸€èˆ¬æƒ…å†µä¸‹-bindåœ°å€å°±æ˜¯å±•ç°åœ°å€</span><br><span class="line">-bootstrapï¼šç”¨æ¥æ§åˆ¶ä¸€ä¸ªserveræ˜¯å¦åœ¨bootstrapæ¨¡å¼ï¼Œåœ¨ä¸€ä¸ªdatacenterä¸­åªèƒ½æœ‰ä¸€ä¸ªserverå¤„äºbootstrapæ¨¡å¼ï¼Œå½“ä¸€ä¸ªserverå¤„äºbootstrapæ¨¡å¼æ—¶ï¼Œå¯ä»¥è‡ªå·±é€‰ä¸¾ä¸ºraft leaderã€‚</span><br><span class="line">-bootstrap-expectï¼šåœ¨ä¸€ä¸ªdatacenterä¸­æœŸæœ›æä¾›çš„serverèŠ‚ç‚¹æ•°ç›®ï¼Œå½“è¯¥å€¼æä¾›çš„æ—¶å€™ï¼Œconsulä¸€ç›´ç­‰åˆ°è¾¾åˆ°æŒ‡å®šseveræ•°ç›®çš„æ—¶å€™æ‰ä¼šå¼•å¯¼æ•´ä¸ªé›†ç¾¤ï¼Œè¯¥æ ‡è®°ä¸èƒ½å’Œbootstrapå…¬ç”¨</span><br><span class="line">-bindï¼šè¯¥åœ°å€ç”¨æ¥åœ¨é›†ç¾¤å†…éƒ¨çš„é€šè®¯ï¼Œé›†ç¾¤å†…çš„æ‰€æœ‰èŠ‚ç‚¹åˆ°åœ°å€éƒ½å¿…é¡»æ˜¯å¯è¾¾çš„ï¼Œé»˜è®¤æ˜¯0.0.0.0</span><br><span class="line">-clientï¼šconsulç»‘å®šåœ¨å“ªä¸ªclientåœ°å€ä¸Šï¼Œè¿™ä¸ªåœ°å€æä¾›HTTPã€DNSã€RPCç­‰æœåŠ¡ï¼Œé»˜è®¤æ˜¯127.0.0.1</span><br><span class="line">-config-fileï¼šæ˜ç¡®çš„æŒ‡å®šè¦åŠ è½½å“ªä¸ªé…ç½®æ–‡ä»¶</span><br><span class="line">-config-dirï¼šé…ç½®æ–‡ä»¶ç›®å½•ï¼Œé‡Œé¢æ‰€æœ‰ä»¥.jsonç»“å°¾çš„æ–‡ä»¶éƒ½ä¼šè¢«åŠ è½½</span><br><span class="line">-data-dirï¼šæä¾›ä¸€ä¸ªç›®å½•ç”¨æ¥å­˜æ”¾agentçš„çŠ¶æ€ï¼Œæ‰€æœ‰çš„agentå…è®¸éƒ½éœ€è¦è¯¥ç›®å½•ï¼Œè¯¥ç›®å½•å¿…é¡»æ˜¯ç¨³å®šçš„ï¼Œç³»ç»Ÿé‡å¯åéƒ½ç»§ç»­å­˜åœ¨</span><br><span class="line">-dcï¼šè¯¥æ ‡è®°æ§åˆ¶agentå…è®¸çš„datacenterçš„åç§°ï¼Œé»˜è®¤æ˜¯dc1</span><br><span class="line">-encryptï¼šæŒ‡å®šsecret keyï¼Œä½¿consulåœ¨é€šè®¯æ—¶è¿›è¡ŒåŠ å¯†ï¼Œkeyå¯ä»¥é€šè¿‡consul keygenç”Ÿæˆï¼ŒåŒä¸€ä¸ªé›†ç¾¤ä¸­çš„èŠ‚ç‚¹å¿…é¡»ä½¿ç”¨ç›¸åŒçš„key</span><br><span class="line">-joinï¼šåŠ å…¥ä¸€ä¸ªå·²ç»å¯åŠ¨çš„agentçš„ipåœ°å€ï¼Œå¯ä»¥å¤šæ¬¡æŒ‡å®šå¤šä¸ªagentçš„åœ°å€ã€‚å¦‚æœconsulä¸èƒ½åŠ å…¥ä»»ä½•æŒ‡å®šçš„åœ°å€ä¸­ï¼Œåˆ™agentä¼šå¯åŠ¨å¤±è´¥ï¼Œé»˜è®¤agentå¯åŠ¨æ—¶ä¸ä¼šåŠ å…¥ä»»ä½•èŠ‚ç‚¹ã€‚</span><br><span class="line">-retry-joinï¼šå’Œjoinç±»ä¼¼ï¼Œä½†æ˜¯å…è®¸ä½ åœ¨ç¬¬ä¸€æ¬¡å¤±è´¥åè¿›è¡Œå°è¯•ã€‚</span><br><span class="line">-retry-intervalï¼šä¸¤æ¬¡joinä¹‹é—´çš„æ—¶é—´é—´éš”ï¼Œé»˜è®¤æ˜¯30s</span><br><span class="line">-retry-maxï¼šå°è¯•é‡å¤joinçš„æ¬¡æ•°ï¼Œé»˜è®¤æ˜¯0ï¼Œä¹Ÿå°±æ˜¯æ— é™æ¬¡å°è¯•</span><br><span class="line">-log-levelï¼šconsul agentå¯åŠ¨åæ˜¾ç¤ºçš„æ—¥å¿—ä¿¡æ¯çº§åˆ«ã€‚é»˜è®¤æ˜¯infoï¼Œå¯é€‰ï¼štraceã€debugã€infoã€warnã€errã€‚</span><br><span class="line">-nodeï¼šèŠ‚ç‚¹åœ¨é›†ç¾¤ä¸­çš„åç§°ï¼Œåœ¨ä¸€ä¸ªé›†ç¾¤ä¸­å¿…é¡»æ˜¯å”¯ä¸€çš„ï¼Œé»˜è®¤æ˜¯è¯¥èŠ‚ç‚¹çš„ä¸»æœºå</span><br><span class="line">-protocolï¼šconsulä½¿ç”¨çš„åè®®ç‰ˆæœ¬</span><br><span class="line">-rejoinï¼šä½¿consulå¿½ç•¥å…ˆå‰çš„ç¦»å¼€ï¼Œåœ¨å†æ¬¡å¯åŠ¨åä»æ—§å°è¯•åŠ å…¥é›†ç¾¤ä¸­ã€‚</span><br><span class="line">-serverï¼šå®šä¹‰agentè¿è¡Œåœ¨serveræ¨¡å¼ï¼Œæ¯ä¸ªé›†ç¾¤è‡³å°‘æœ‰ä¸€ä¸ªserverï¼Œå»ºè®®æ¯ä¸ªé›†ç¾¤çš„serverä¸è¦è¶…è¿‡5ä¸ª</span><br><span class="line">-syslogï¼šå¼€å¯ç³»ç»Ÿæ—¥å¿—åŠŸèƒ½ï¼Œåªåœ¨linux/osxä¸Šç”Ÿæ•ˆ</span><br><span class="line">-ui-dir:æä¾›å­˜æ”¾web uièµ„æºçš„è·¯å¾„ï¼Œè¯¥ç›®å½•å¿…é¡»æ˜¯å¯è¯»çš„</span><br><span class="line">-pid-file:æä¾›ä¸€ä¸ªè·¯å¾„æ¥å­˜æ”¾pidæ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨è¯¥æ–‡ä»¶è¿›è¡ŒSIGINT/SIGHUP(å…³é—­/æ›´æ–°)agent12345678910111213141516171819202122</span><br></pre></td></tr></table></figure>

<p>é™¤äº†å‘½ä»¤è¡Œå‚æ•°å¤–ï¼Œé…ç½®ä¹Ÿå¯ä»¥å†™å…¥æ–‡ä»¶ä¸­ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹é…ç½®æ–‡ä»¶ä¼šæ›´ç®€å•ä¸€äº›ï¼Œä¾‹å¦‚ï¼šåˆ©ç”¨consulè¢«ç”¨æ¥ç®¡ç†ç³»ç»Ÿã€‚é…ç½®æ–‡ä»¶æ˜¯jsonæ ¼å¼çš„ï¼Œå¾ˆå®¹æ˜“ç¼–å†™ã€‚é…ç½®æ–‡ä»¶ä¸ä»…è¢«ç”¨æ¥è®¾ç½®agentçš„å¯åŠ¨ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥æä¾›å¥åº·æ£€æµ‹å’ŒæœåŠ¡å‘ç°çš„å®šä¹‰ã€‚é…ç½®æ–‡ä»¶çš„ä¸€èˆ¬æ ·ä¾‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;datacenter&quot;: &quot;dc1&quot;,</span><br><span class="line">  &quot;data_dir&quot;: &quot;/opt/consul&quot;,</span><br><span class="line">  &quot;log_level&quot;: &quot;INFO&quot;,</span><br><span class="line">  &quot;node_name&quot;: &quot;s1&quot;,</span><br><span class="line">  &quot;server&quot;: true,</span><br><span class="line">  &quot;bootstrap_expect&quot;: 3,</span><br><span class="line">  &quot;bind_addr&quot;: &quot;10.201.102.198&quot;,</span><br><span class="line">  &quot;client_addr&quot;: &quot;0.0.0.0&quot;,</span><br><span class="line">  &quot;ui_dir&quot;: &quot;/root/consul_ui&quot;,</span><br><span class="line">  &quot;retry_join&quot;: [&quot;10.201.102.198&quot;,&quot;10.201.102.199&quot;,&quot;10.201.102.200&quot;,&quot;10.201.102.248&quot;],</span><br><span class="line">  &quot;retry_interval&quot;: &quot;30s&quot;,</span><br><span class="line">  &quot;enable_debug&quot;: false,</span><br><span class="line">  &quot;rejoin_after_leave&quot;: true,</span><br><span class="line">  &quot;start_join&quot;: [&quot;10.201.102.198&quot;,&quot;10.201.102.199&quot;,&quot;10.201.102.200&quot;,&quot;10.201.102.248&quot;],</span><br><span class="line">  &quot;enable_syslog&quot;: true,</span><br><span class="line">  &quot;syslog_facility&quot;: &quot;local5&quot;</span><br><span class="line">&#125;123456789101112131415161718</span><br></pre></td></tr></table></figure>

<p>ä¸‹é¢çœ‹çœ‹è¯¦ç»†çš„é…ç½®æ–‡ä»¶å‚æ•°ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">acl_datacenterï¼šåªç”¨äºserverï¼ŒæŒ‡å®šçš„datacenterçš„æƒå¨ACLä¿¡æ¯ï¼Œæ‰€æœ‰çš„serverså’Œdatacenterå¿…é¡»åŒæ„ACL datacenter</span><br><span class="line">acl_default_policyï¼šé»˜è®¤æ˜¯allow</span><br><span class="line">acl_down_policyï¼š</span><br><span class="line">acl_master_tokenï¼š</span><br><span class="line">acl_tokenï¼šagentä¼šä½¿ç”¨è¿™ä¸ªtokenå’Œconsul serverè¿›è¡Œè¯·æ±‚</span><br><span class="line">acl_ttlï¼šæ§åˆ¶TTLçš„cacheï¼Œé»˜è®¤æ˜¯30s</span><br><span class="line">addressesï¼šä¸€ä¸ªåµŒå¥—å¯¹è±¡ï¼Œå¯ä»¥è®¾ç½®ä»¥ä¸‹keyï¼šdnsã€httpã€rpc</span><br><span class="line">advertise_addrï¼šç­‰åŒäº-advertise</span><br><span class="line">bootstrapï¼šç­‰åŒäº-bootstrap</span><br><span class="line">bootstrap_expectï¼šç­‰åŒäº-bootstrap-expect</span><br><span class="line">bind_addrï¼šç­‰åŒäº-bind</span><br><span class="line">ca_fileï¼šæä¾›CAæ–‡ä»¶è·¯å¾„ï¼Œç”¨æ¥æ£€æŸ¥å®¢æˆ·ç«¯æˆ–è€…æœåŠ¡ç«¯çš„é“¾æ¥</span><br><span class="line">cert_fileï¼šå¿…é¡»å’Œkey_fileä¸€èµ·</span><br><span class="line">check_update_intervalï¼š</span><br><span class="line">client_addrï¼šç­‰åŒäº-client</span><br><span class="line">datacenterï¼šç­‰åŒäº-dc</span><br><span class="line">data_dirï¼šç­‰åŒäº-data-dir</span><br><span class="line">disable_anonymous_signatureï¼šåœ¨è¿›è¡Œæ›´æ–°æ£€æŸ¥æ—¶ç¦æ­¢åŒ¿åç­¾å</span><br><span class="line">disable_remote_execï¼šç¦æ­¢æ”¯æŒè¿œç¨‹æ‰§è¡Œï¼Œè®¾ç½®ä¸ºtrueï¼Œagentä¼šå¿½è§†æ‰€æœ‰è¿›å…¥çš„è¿œç¨‹æ‰§è¡Œè¯·æ±‚</span><br><span class="line">disable_update_checkï¼šç¦æ­¢è‡ªåŠ¨æ£€æŸ¥å®‰å…¨å…¬å‘Šå’Œæ–°ç‰ˆæœ¬ä¿¡æ¯</span><br><span class="line">dns_configï¼šæ˜¯ä¸€ä¸ªåµŒå¥—å¯¹è±¡ï¼Œå¯ä»¥è®¾ç½®ä»¥ä¸‹å‚æ•°ï¼šallow_staleã€max_staleã€node_ttl ã€service_ttlã€enable_truncate</span><br><span class="line">domainï¼šé»˜è®¤æƒ…å†µä¸‹consulåœ¨è¿›è¡ŒDNSæŸ¥è¯¢æ—¶ï¼ŒæŸ¥è¯¢çš„æ˜¯consulåŸŸï¼Œå¯ä»¥é€šè¿‡è¯¥å‚æ•°è¿›è¡Œä¿®æ”¹</span><br><span class="line">enable_debugï¼šå¼€å¯debugæ¨¡å¼</span><br><span class="line">enable_syslogï¼šç­‰åŒäº-syslog</span><br><span class="line">encryptï¼šç­‰åŒäº-encrypt</span><br><span class="line">key_fileï¼šæä¾›ç§é’¥çš„è·¯å¾„</span><br><span class="line">leave_on_terminateï¼šé»˜è®¤æ˜¯falseï¼Œå¦‚æœä¸ºtrueï¼Œå½“agentæ”¶åˆ°ä¸€ä¸ªTERMä¿¡å·çš„æ—¶å€™ï¼Œå®ƒä¼šå‘é€leaveä¿¡æ¯åˆ°é›†ç¾¤ä¸­çš„å…¶ä»–èŠ‚ç‚¹ä¸Šã€‚</span><br><span class="line">log_levelï¼šç­‰åŒäº-log-level</span><br><span class="line">node_name:ç­‰åŒäº-node</span><br><span class="line">portsï¼šè¿™æ˜¯ä¸€ä¸ªåµŒå¥—å¯¹è±¡ï¼Œå¯ä»¥è®¾ç½®ä»¥ä¸‹keyï¼šdns(dnsåœ°å€ï¼š8600)ã€http(http apiåœ°å€ï¼š8500)ã€rpc(rpc:8400)ã€serf_lan(lan port:8301)ã€serf_wan(wan port:8302)ã€server(server rpc:8300)</span><br><span class="line">protocolï¼šç­‰åŒäº-protocol</span><br><span class="line">recursorï¼š</span><br><span class="line">rejoin_after_leaveï¼šç­‰åŒäº-rejoin</span><br><span class="line">retry_joinï¼šç­‰åŒäº-retry-join</span><br><span class="line">retry_intervalï¼šç­‰åŒäº-retry-interval</span><br><span class="line">serverï¼šç­‰åŒäº-server</span><br><span class="line">server_nameï¼šä¼šè¦†ç›–TLS CAçš„node_nameï¼Œå¯ä»¥ç”¨æ¥ç¡®è®¤CA nameå’Œhostnameç›¸åŒ¹é…</span><br><span class="line">skip_leave_on_interruptï¼šå’Œleave_on_terminateæ¯”è¾ƒç±»ä¼¼ï¼Œä¸è¿‡åªå½±å“å½“å‰å¥æŸ„</span><br><span class="line">start_joinï¼šä¸€ä¸ªå­—ç¬¦æ•°ç»„æä¾›çš„èŠ‚ç‚¹åœ°å€ä¼šåœ¨å¯åŠ¨æ—¶è¢«åŠ å…¥</span><br><span class="line">statsd_addrï¼š</span><br><span class="line">statsite_addrï¼š</span><br><span class="line">syslog_facilityï¼šå½“enable_syslogè¢«æä¾›åï¼Œè¯¥å‚æ•°æ§åˆ¶å“ªä¸ªçº§åˆ«çš„ä¿¡æ¯è¢«å‘é€ï¼Œé»˜è®¤Local0</span><br><span class="line">ui_dirï¼šç­‰åŒäº-ui-dir</span><br><span class="line">verify_incomingï¼šé»˜è®¤falseï¼Œå¦‚æœä¸ºtrueï¼Œåˆ™æ‰€æœ‰è¿›å…¥é“¾æ¥éƒ½éœ€è¦ä½¿ç”¨TLSï¼Œéœ€è¦å®¢æˆ·ç«¯ä½¿ç”¨ca_fileæä¾›caæ–‡ä»¶ï¼Œåªç”¨äºconsul serverç«¯ï¼Œå› ä¸ºclientä»æ¥æ²¡æœ‰è¿›å…¥çš„é“¾æ¥</span><br><span class="line">verify_outgoingï¼šé»˜è®¤falseï¼Œå¦‚æœä¸ºtrueï¼Œåˆ™æ‰€æœ‰å‡ºå»é“¾æ¥éƒ½éœ€è¦ä½¿ç”¨TLSï¼Œéœ€è¦æœåŠ¡ç«¯ä½¿ç”¨ca_fileæä¾›caæ–‡ä»¶ï¼Œconsul serverå’Œclientéƒ½éœ€è¦ä½¿ç”¨ï¼Œå› ä¸ºä¸¤è€…éƒ½æœ‰å‡ºå»çš„é“¾æ¥</span><br><span class="line">watchesï¼šwatchä¸€ä¸ªè¯¦ç»†åå•12345678910111213141516171819202122232425262728293031323334353637383940414243444546</span><br></pre></td></tr></table></figure>

<h1 id="HTTP-API"><a href="#HTTP-API" class="headerlink" title="HTTP API"></a>HTTP API</h1><p>consulçš„ä¸»è¦æ¥å£æ˜¯RESTful HTTP APIï¼Œè¯¥APIå¯ä»¥ç”¨æ¥å¢åˆ æŸ¥æ”¹nodesã€servicesã€checksã€configgurationã€‚æ‰€æœ‰çš„endpointsä¸»è¦åˆ†ä¸ºä»¥ä¸‹ç±»åˆ«ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">kv - Key/Valueå­˜å‚¨</span><br><span class="line">agent - Agentæ§åˆ¶</span><br><span class="line">catalog - ç®¡ç†nodeså’Œservices</span><br><span class="line">health - ç®¡ç†å¥åº·ç›‘æµ‹</span><br><span class="line">session - Sessionæ“ä½œ</span><br><span class="line">acl - ACLåˆ›å»ºå’Œç®¡ç†</span><br><span class="line">event - ç”¨æˆ·Events</span><br><span class="line">status - Consulç³»ç»ŸçŠ¶æ€12345678</span><br></pre></td></tr></table></figure>

<p>ä¸‹é¢æˆ‘ä»¬å°±å•ç‹¬çœ‹çœ‹æ¯ä¸ªæ¨¡å—çš„å…·ä½“å†…å®¹ã€‚</p>
<h2 id="agent"><a href="#agent" class="headerlink" title="agent"></a>agent</h2><p>agent endpointsç”¨æ¥å’Œæœ¬åœ°agentè¿›è¡Œäº¤äº’ï¼Œä¸€èˆ¬ç”¨æ¥æœåŠ¡æ³¨å†Œå’Œæ£€æŸ¥æ³¨å†Œï¼Œæ”¯æŒä»¥ä¸‹æ¥å£</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/v1/agent/checks : è¿”å›æœ¬åœ°agentæ³¨å†Œçš„æ‰€æœ‰æ£€æŸ¥(åŒ…æ‹¬é…ç½®æ–‡ä»¶å’ŒHTTPæ¥å£)</span><br><span class="line">/v1/agent/services : è¿”å›æœ¬åœ°agentæ³¨å†Œçš„æ‰€æœ‰ æœåŠ¡</span><br><span class="line">/v1/agent/members : è¿”å›agentåœ¨é›†ç¾¤çš„gossip poolä¸­çœ‹åˆ°çš„æˆå‘˜</span><br><span class="line">/v1/agent/self : è¿”å›æœ¬åœ°agentçš„é…ç½®å’Œæˆå‘˜ä¿¡æ¯</span><br><span class="line">/v1/agent/join/&lt;address&gt; : è§¦å‘æœ¬åœ°agentåŠ å…¥node</span><br><span class="line">/v1/agent/force-leave/&lt;node&gt;&gt;: å¼ºåˆ¶åˆ é™¤node</span><br><span class="line">/v1/agent/check/register : åœ¨æœ¬åœ°agentå¢åŠ ä¸€ä¸ªæ£€æŸ¥é¡¹ï¼Œä½¿ç”¨PUTæ–¹æ³•ä¼ è¾“ä¸€ä¸ªjsonæ ¼å¼çš„æ•°æ®</span><br><span class="line">/v1/agent/check/deregister/&lt;checkID&gt; : æ³¨é”€ä¸€ä¸ªæœ¬åœ°agentçš„æ£€æŸ¥é¡¹</span><br><span class="line">/v1/agent/check/pass/&lt;checkID&gt; : è®¾ç½®ä¸€ä¸ªæœ¬åœ°æ£€æŸ¥é¡¹çš„çŠ¶æ€ä¸ºpassing</span><br><span class="line">/v1/agent/check/warn/&lt;checkID&gt; : è®¾ç½®ä¸€ä¸ªæœ¬åœ°æ£€æŸ¥é¡¹çš„çŠ¶æ€ä¸ºwarning</span><br><span class="line">/v1/agent/check/fail/&lt;checkID&gt; : è®¾ç½®ä¸€ä¸ªæœ¬åœ°æ£€æŸ¥é¡¹çš„çŠ¶æ€ä¸ºcritical</span><br><span class="line">/v1/agent/service/register : åœ¨æœ¬åœ°agentå¢åŠ ä¸€ä¸ªæ–°çš„æœåŠ¡é¡¹ï¼Œä½¿ç”¨PUTæ–¹æ³•ä¼ è¾“ä¸€ä¸ªjsonæ ¼å¼çš„æ•°æ®</span><br><span class="line">/v1/agent/service/deregister/&lt;serviceID&gt; : æ³¨é”€ä¸€ä¸ªæœ¬åœ°agentçš„æœåŠ¡é¡¹12345678910111213</span><br></pre></td></tr></table></figure>

<h2 id="catalog"><a href="#catalog" class="headerlink" title="catalog"></a>catalog</h2><p>catalog endpointsç”¨æ¥æ³¨å†Œ&#x2F;æ³¨é”€nodesã€servicesã€checks</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/v1/catalog/register : Registers a new node, service, or check</span><br><span class="line">/v1/catalog/deregister : Deregisters a node, service, or check</span><br><span class="line">/v1/catalog/datacenters : Lists known datacenters</span><br><span class="line">/v1/catalog/nodes : Lists nodes in a given DC</span><br><span class="line">/v1/catalog/services : Lists services in a given DC</span><br><span class="line">/v1/catalog/service/&lt;service&gt; : Lists the nodes in a given service</span><br><span class="line">/v1/catalog/node/&lt;node&gt; : Lists the services provided by a node1234567</span><br></pre></td></tr></table></figure>

<h2 id="health"><a href="#health" class="headerlink" title="health"></a>health</h2><p>health endpointsç”¨æ¥æŸ¥è¯¢å¥åº·çŠ¶å†µç›¸å…³ä¿¡æ¯ï¼Œè¯¥åŠŸèƒ½ä»catalogä¸­å•ç‹¬åˆ†ç¦»å‡ºæ¥</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/v1/healt/node/&lt;node&gt;: è¿”å›nodeæ‰€å®šä¹‰çš„æ£€æŸ¥ï¼Œå¯ç”¨å‚æ•°?dc=</span><br><span class="line">/v1/health/checks/&lt;service&gt;: è¿”å›å’ŒæœåŠ¡ç›¸å…³è”çš„æ£€æŸ¥ï¼Œå¯ç”¨å‚æ•°?dc=</span><br><span class="line">/v1/health/service/&lt;service&gt;: è¿”å›ç»™å®šdatacenterä¸­ç»™å®šnodeä¸­service</span><br><span class="line">/v1/health/state/&lt;state&gt;: è¿”å›ç»™å®šdatacenterä¸­æŒ‡å®šçŠ¶æ€çš„æœåŠ¡ï¼Œstateå¯ä»¥æ˜¯&quot;any&quot;, &quot;unknown&quot;, &quot;passing&quot;, &quot;warning&quot;, or &quot;critical&quot;ï¼Œå¯ç”¨å‚æ•°?dc=1234</span><br></pre></td></tr></table></figure>

<h2 id="session"><a href="#session" class="headerlink" title="session"></a>session</h2><p>session endpointsç”¨æ¥createã€updateã€destoryã€query sessions</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/v1/session/create: Creates a new session</span><br><span class="line">/v1/session/destroy/&lt;session&gt;: Destroys a given session</span><br><span class="line">/v1/session/info/&lt;session&gt;: Queries a given session</span><br><span class="line">/v1/session/node/&lt;node&gt;: Lists sessions belonging to a node</span><br><span class="line">/v1/session/list: Lists all the active sessions12345</span><br></pre></td></tr></table></figure>

<h2 id="acl"><a href="#acl" class="headerlink" title="acl"></a>acl</h2><p>acl endpointsç”¨æ¥createã€updateã€destoryã€query acl</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/v1/acl/create: Creates a new token with policy</span><br><span class="line">/v1/acl/update: Update the policy of a token</span><br><span class="line">/v1/acl/destroy/&lt;id&gt;: Destroys a given token</span><br><span class="line">/v1/acl/info/&lt;id&gt;: Queries the policy of a given token</span><br><span class="line">/v1/acl/clone/&lt;id&gt;: Creates a new token by cloning an existing token</span><br><span class="line">/v1/acl/list: Lists all the active tokens123456</span><br></pre></td></tr></table></figure>

<h2 id="event-1"><a href="#event-1" class="headerlink" title="event"></a>event</h2><p>event endpointsç”¨æ¥fireæ–°çš„eventsã€æŸ¥è¯¢å·²æœ‰çš„events</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/v1/event/fire/&lt;name&gt;: è§¦å‘ä¸€ä¸ªæ–°çš„eventï¼Œç”¨æˆ·eventéœ€è¦nameå’Œå…¶ä»–å¯é€‰çš„å‚æ•°ï¼Œä½¿ç”¨PUTæ–¹æ³•</span><br><span class="line">/v1/event/list: è¿”å›agentçŸ¥é“çš„events12</span><br></pre></td></tr></table></figure>

<h2 id="status"><a href="#status" class="headerlink" title="status"></a>status</h2><p>status endpointsç”¨æ¥æˆ–è€…consul é›†ç¾¤çš„ä¿¡æ¯</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/v1/status/leader : è¿”å›å½“å‰é›†ç¾¤çš„Raft leader</span><br><span class="line">/v1/status/peers : è¿”å›å½“å‰é›†ç¾¤ä¸­åŒäº‹12</span><br></pre></td></tr></table></figure>

<h1 id="Consul-Template"><a href="#Consul-Template" class="headerlink" title="Consul-Template"></a>Consul-Template</h1><p>åœ¨consul-templateæ²¡å‡ºç°ä¹‹å‰ï¼Œå¤§å®¶æ„å»ºæœåŠ¡å‘ç°ç³»ç»Ÿï¼Œå¤§å¤šé‡‡ç”¨çš„æ˜¯zookeeperã€etcd+confdè¿™æ ·ç±»ä¼¼çš„ç³»ç»Ÿï¼Œä¹‹å‰å†™è¿‡ä¸€ç¯‡consul+confdçš„æ–‡ï¼Œè®²çš„æ˜¯å¦‚ä½•åŠ¨æ€ç”Ÿæˆé…ç½®æ–‡ä»¶çš„ï¼Œå¦‚ä»Šconsulå®˜æ–¹æ¨å‡ºäº†è‡ªå·±çš„æ¨¡æ¿ç³»ç»Ÿï¼Œå°±æ˜¯consul-templateï¼Œè¿™æ ·çš„è¯åŠ¨æ€çš„é…ç½®ç³»ç»Ÿå¯ä»¥åˆ†åŒ–ä¸ºetcd+confdå’Œconsul+consul-templateä¸¤å¤§é˜µè¥ã€‚consulæ˜¯ä¸€ä¸ªå’Œetcdç±»ä¼¼ä½†åˆå¼ºäºetcdçš„ç³»ç»Ÿï¼Œå…³äºetcdå’Œconsulå¯ä»¥ç¿»é˜…ä»¥å‰çš„æ–‡ç« ï¼Œconsul-templateçš„å®šä½å°±å’Œconfdå·®ä¸å¤šä¸€æ ·äº†ï¼Œconfdçš„åç«¯å¯ä»¥æ˜¯etcdæˆ–è€…consulï¼Œç›¸ä¿¡consulæ­é…consul-templateèƒ½å‘æŒ¥æ›´å¤§çš„æ•ˆæœã€‚consul-templateæä¾›äº†ä¸€ä¸ªä¾¿æ·çš„æ–¹å¼ä»consulä¸­è·å–å­˜å‚¨çš„å€¼ï¼Œconsul-templateå®ˆæŠ¤è¿›ç¨‹ä¼šæŸ¥è¯¢consulå®ä¾‹ï¼Œæ¥æ›´æ–°ç³»ç»Ÿä¸ŠæŒ‡å®šçš„ä»»ä½•æ¨¡æ¿ï¼Œå½“æ›´æ–°å®Œæˆåï¼Œæ¨¡æ¿å¯ä»¥é€‰æ‹©è¿è¡Œä¸€äº›ä»»æ„çš„å‘½ä»¤ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consul templateçš„ä½¿ç”¨åœºæ™¯ï¼šconsul templateå¯ä»¥æŸ¥è¯¢consulä¸­çš„æœåŠ¡ç›®å½•ã€keyã€key-valuesç­‰ã€‚è¿™ç§å¼ºå¤§çš„æŠ½è±¡åŠŸèƒ½å’ŒæŸ¥è¯¢è¯­è¨€æ¨¡æ¿å¯ä»¥ä½¿consul templateç‰¹åˆ«é€‚åˆåŠ¨æ€çš„åˆ›å»ºé…ç½®æ–‡ä»¶ã€‚ä¾‹å¦‚ï¼šåˆ›å»ºapache/nginx proxy balancersã€haproxy backendsã€varnish serversã€application configurationsã€‚1</span><br></pre></td></tr></table></figure>

<p>consul templateçš„ç‰¹æ€§ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">quiescenceï¼šconsul templateå†…åˆ¶é™æ­¢å¹³è¡¡åŠŸèƒ½ï¼Œå¯ä»¥æ™ºèƒ½çš„å‘ç°consulå®ä¾‹ä¸­çš„æ›´æ”¹ä¿¡æ¯ã€‚è¿™ä¸ªåŠŸèƒ½å¯ä»¥é˜²æ­¢é¢‘ç¹çš„æ›´æ–°æ¨¡æ¿è€Œå¼•èµ·ç³»ç»Ÿçš„æ³¢åŠ¨ã€‚</span><br><span class="line">dry modeï¼šä¸ç¡®å®šå½“å‰æ¶æ„çš„çŠ¶æ€ï¼Ÿæ‹…å¿ƒæ¨¡æ¿çš„å˜åŒ–ä¼šç ´åå­ç³»ç»Ÿï¼Ÿæ— é¡»æ‹…å¿ƒï¼Œå› ä¸ºconsul templateè¿˜æœ‰-dryæ¨¡å¼ã€‚åœ¨dryæ¨¡å¼ï¼Œconsul templateä¼šå°†ç»“æœå‘ˆç°åœ¨STDOUTï¼Œæ‰€ä»¥æ“ä½œå‘˜å¯ä»¥æ£€æŸ¥è¾“å‡ºæ˜¯å¦æ­£å¸¸ï¼Œä»¥å†³å®šæ›´æ¢æ¨¡æ¿æ˜¯å¦å®‰å…¨</span><br><span class="line">CLI and Configï¼šå¦‚æœä½ å–œæ¬¢åœ¨å‘½ä»¤è¡Œä¸ŠæŒ‡å®šä¸€åˆ‡ï¼Œconsul templateéƒ½å¯ä»¥holdä½ã€‚éšç€å†…ç½®HCLçš„æ”¯æŒï¼Œconsul templateæ¥æ”¶ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œå‘½ä»¤è¡Œå‚æ•°ï¼Œæˆ–è€…ä¸¤è€…çš„æ··åˆã€‚é€šè¿‡è¿™ç§æ–¹å¼ä½ å¯ä»¥ç»§ç»­ä½¿ç”¨ä½ ç°åœ¨å·²æœ‰çš„é…ç½®ç®¡ç†å·¥å…·å’Œconsul templateæ¥é…åˆã€‚</span><br><span class="line">verbose debuggingï¼šå³ä½¿æ¯ä»¶äº‹ä½ éƒ½åšçš„è¿‘ä¹å®Œç¾ï¼Œä½†æ˜¯æœ‰æ—¶å€™è¿˜æ˜¯ä¼šæœ‰å¤±è´¥å‘ç”Ÿã€‚consul templateå¯ä»¥æä¾›æ›´è¯¦ç»†çš„debugæ—¥å¿—ä¿¡æ¯ã€‚1234</span><br></pre></td></tr></table></figure>

<h2 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><p>ä½ å¯ä»¥åœ¨<a target="_blank" rel="noopener" href="https://releases.hashicorp.com/consul-template/">å‘å¸ƒé¡µ</a>ä¸‹è½½å‘å¸ƒåŒ….å¦‚æœä½ å¸Œæœ›è‡ªå·±ç¼–è¯‘è¯·æŸ¥çœ‹<a target="_blank" rel="noopener" href="https://github.com/hashicorp/consul-template#contributing">è¯´æ˜æ–‡æ¡£</a>.</p>
<h2 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">-auth=&lt;user[:pass]&gt;      è®¾ç½®åŸºæœ¬çš„è®¤è¯ç”¨æˆ·åå’Œå¯†ç </span><br><span class="line">  -consul-addr=&lt;address&gt;   è®¾ç½®Consulå®ä¾‹çš„åœ°å€</span><br><span class="line">  -max-stale=&lt;duration&gt;    æŸ¥è¯¢è¿‡æœŸçš„æœ€å¤§é¢‘ç‡ï¼Œé»˜è®¤æ˜¯1s</span><br><span class="line">  -dedup                   å¯ç”¨é‡å¤æ•°æ®åˆ é™¤ï¼Œå½“è®¸å¤šconsul templateå®ä¾‹æ¸²æŸ“ä¸€ä¸ªæ¨¡æ¿çš„æ—¶å€™å¯ä»¥é™ä½consulçš„è´Ÿè½½</span><br><span class="line">  -ssl                     ä½¿ç”¨httpsè¿æ¥Consulä½¿ç”¨SSL</span><br><span class="line">  -ssl-verify              é€šè¿‡SSLè¿æ¥çš„æ—¶å€™æ£€æŸ¥è¯ä¹¦</span><br><span class="line">  -ssl-cert                SSLå®¢æˆ·ç«¯è¯ä¹¦å‘é€ç»™æœåŠ¡å™¨</span><br><span class="line">  -ssl-key                 å®¢æˆ·ç«¯è®¤è¯æ—¶ä½¿ç”¨çš„SSL/TLSç§é’¥</span><br><span class="line">  -ssl-ca-cert             éªŒè¯æœåŠ¡å™¨çš„CAè¯ä¹¦åˆ—è¡¨</span><br><span class="line">  -token=&lt;token&gt;           è®¾ç½®Consul APIçš„token</span><br><span class="line">  -syslog                  æŠŠæ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯é‡å®šå‘åˆ°syslogï¼Œsyslogçš„é»˜è®¤çº§åˆ«æ˜¯local0ã€‚</span><br><span class="line">  -syslog-facility=&lt;f&gt;     è®¾ç½®syslogçº§åˆ«ï¼Œé»˜è®¤æ˜¯local0ï¼Œå¿…é¡»å’Œ-syslogé…åˆä½¿ç”¨</span><br><span class="line">  -template=&lt;template&gt;     å¢åŠ ä¸€ä¸ªéœ€è¦ç›‘æ§çš„æ¨¡æ¿ï¼Œæ ¼å¼æ˜¯ï¼š&#x27;templatePath:outputPath(:command)&#x27;ï¼Œå¤šä¸ªæ¨¡æ¿åˆ™å¯ä»¥è®¾ç½®å¤šæ¬¡</span><br><span class="line">  -wait=&lt;duration&gt;         å½“å‘ˆç°ä¸€ä¸ªæ–°çš„æ¨¡æ¿åˆ°ç³»ç»Ÿå’Œè§¦å‘ä¸€ä¸ªå‘½ä»¤çš„æ—¶å€™ï¼Œç­‰å¾…çš„æœ€å¤§æœ€å°æ—¶é—´ã€‚å¦‚æœæœ€å¤§å€¼è¢«å¿½ç•¥ï¼Œé»˜è®¤æ˜¯æœ€å°å€¼çš„4å€ã€‚</span><br><span class="line">  -retry=&lt;duration&gt;        å½“åœ¨å’Œconsul apiäº¤äº’çš„è¿”å›å€¼æ˜¯errorçš„æ—¶å€™ï¼Œç­‰å¾…çš„æ—¶é—´ï¼Œé»˜è®¤æ˜¯5sã€‚</span><br><span class="line">  -config=&lt;path&gt;           é…ç½®æ–‡ä»¶æˆ–è€…é…ç½®ç›®å½•çš„è·¯å¾„</span><br><span class="line">  -pid-file=&lt;path&gt;         PIDæ–‡ä»¶çš„è·¯å¾„</span><br><span class="line">  -log-level=&lt;level&gt;       è®¾ç½®æ—¥å¿—çº§åˆ«ï¼Œå¯ä»¥æ˜¯&quot;debug&quot;,&quot;info&quot;, &quot;warn&quot; (default), and &quot;err&quot;</span><br><span class="line">  -dry                     Dumpç”Ÿæˆçš„æ¨¡æ¿åˆ°æ ‡å‡†è¾“å‡ºï¼Œä¸ä¼šç”Ÿæˆåˆ°ç£ç›˜</span><br><span class="line">  -once                    è¿è¡Œconsul-templateä¸€æ¬¡åé€€å‡ºï¼Œä¸ä»¥å®ˆæŠ¤è¿›ç¨‹è¿è¡Œ</span><br><span class="line">  -reap                    å­è¿›ç¨‹è‡ªåŠ¨æ”¶å‰²123456789101112131415161718192021</span><br></pre></td></tr></table></figure>

<p>æŸ¥çœ‹å…¨éƒ¨é€‰é¡¹,ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consul-template -h1</span><br></pre></td></tr></table></figure>

<h2 id="å‘½ä»¤è¡Œ"><a href="#å‘½ä»¤è¡Œ" class="headerlink" title="å‘½ä»¤è¡Œ"></a>å‘½ä»¤è¡Œ</h2><p>1ã€æŸ¥è¯¢æœ¬åœ°conslå®ä¾‹ï¼Œç”Ÿæˆæ¨¡æ¿åé‡å¯nginxï¼Œå¦‚æœconsulä¸å¯ç”¨ï¼Œå¦‚æœapiæ•…éšœåˆ™æ¯30så°è¯•æ£€æµ‹ä¸€æ¬¡å€¼ï¼Œconsul-templateè¿è¡Œä¸€æ¬¡åé€€å‡º</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consul-template -retry 30s -once -consul-addr=10.201.102.198:8500 -template &quot;test.ctmpl:test.out&quot;1</span><br></pre></td></tr></table></figure>

<p>test.ctmpl</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;range service &quot;Faceid&quot;&#125;&#125;</span><br><span class="line">&#123;&#123;.ID&#125;&#125; &#123;&#123;.Address&#125;&#125;:&#123;&#123;.Port&#125;&#125; check inter 5000 fall 1 rise 2 weight 2&#123;&#123;end&#125;&#125;12</span><br></pre></td></tr></table></figure>

<p>test.out</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Faceid 10.201.102.198:9000 check inter 5000 fall 1 rise 2 weight 2</span><br><span class="line">Faceid 10.201.102.199:9000 check inter 5000 fall 1 rise 2 weight 2</span><br><span class="line">Faceid 10.201.102.200:9000 check inter 5000 fall 1 rise 2 weight 2123</span><br></pre></td></tr></table></figure>

<p>2ã€è¿è¡Œconsul-templeä½œä¸ºä¸€ä¸ªæœåŠ¡</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consul-template -consul-addr=10.201.102.198:8500 -template &quot;test.ctmpl:test.out&quot;1</span><br></pre></td></tr></table></figure>

<p>3ã€æŸ¥è¯¢ä¸€ä¸ªå®ä¾‹ï¼Œæ¸²æŸ“å¤šä¸ªæ¨¡æ¿ï¼Œç„¶åé‡å¯ç›¸å…³æœåŠ¡</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">consul-template -retry 30s -once -consul-addr=10.201.102.198:8500 -template &quot;test.ctmpl:test.out&quot;\</span><br><span class="line"> -template &quot;/tmp/redis.ctmpl:/var/redis/redis.conf:service redis restart&quot; \</span><br><span class="line"> -template &quot;/tmp/haproxy.ctmpl:/var/haproxy/haproxy.conf&quot;123</span><br></pre></td></tr></table></figure>

<p>4ã€æŸ¥è¯¢ä¸€ä¸ªå®ä¾‹ï¼Œdumpæ¨¡æ¿åˆ°æ ‡å‡†è¾“å‡ºï¼Œå‚æ•°ä¸­çš„-templateåˆ™ä¼šè¢«å¿½ç•¥</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consul-template -dry -consul-addr=10.201.102.198:8500 -template &quot;test.ctmpl:test.out&quot;1</span><br></pre></td></tr></table></figure>

<p>ä»¥ä¸Šå‚æ•°é™¤äº†åœ¨å‘½ä»¤è¡Œä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥ç›´æ¥é…ç½®åœ¨æ–‡ä»¶ä¸­ï¼Œä¸‹é¢çœ‹çœ‹Consul-Templateçš„é…ç½®æ–‡ä»¶ï¼Œç®€ç§°HCL(HashiCorp Configuration Language)ï¼Œå®ƒæ˜¯å’ŒJSONå…¼å®¹çš„ï¼Œä¸‹é¢çœ‹ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">### é…ç½®æ–‡ä»¶</span></span></span><br><span class="line">â€‹```Consul-Template```é…ç½®æ–‡ä»¶æ˜¯ä½¿ç”¨[HashiCorp Configuration Language (HCL)](https://github.com/hashicorp/hcl)ç¼–å†™çš„.è¿™æ„å‘³ç€```Consul Template```æ˜¯å’ŒJSONå…¼å®¹çš„,æŸ¥çœ‹æ›´å¤šä¿¡æ¯è¯·æŸ¥çœ‹ [HCL è§„èŒƒ](https://github.com/hashicorp/hcl)</span><br><span class="line">é…ç½®æ–‡ä»¶è¯­æ³•æ”¯æŒä¸Šé¢çš„æ‰€æœ‰çš„é€‰é¡¹,é™¤éåœ¨è¡¨æ ¼ä¸­è¿›è¡Œæ ‡æ˜.</span><br><span class="line">â€‹```json</span><br><span class="line">// è¿™æ˜¯è¦è¿æ¥çš„Consul Agentçš„åœ°å€.é»˜è®¤ä¸º127.0.0.1:8500.è¿™æ˜¯Consulçš„é»˜è®¤ç»‘å®šåœ°å€å’Œç«¯å£.</span><br><span class="line">// ä¸å»ºè®®ä½ ç›´æ¥ä¸ Consulçš„ Serverç›´æ¥è¿›è¡Œäº¤äº’,è¯·ä¸æœ¬åœ°çš„Consul Agentè¿›è¡Œäº¤äº’.è¿™æ ·åšæ˜¯æœ‰ä¸€äº›åŸå› </span><br><span class="line">// æœ€é‡è¦çš„æ˜¯æœ¬åœ°agentå¯ä»¥å¤ç”¨ä¸serverçš„è¿æ¥.å‡å°‘HTTPçš„è¿æ¥æ•°.å¦å¤–è¿™ä¸ªåœ°å€æ›´å¥½è®°.</span><br><span class="line">consul = &quot;127.0.0.1:8500&quot;</span><br><span class="line">// è¿™æ˜¯ç”¨äºè¿æ¥Consulçš„ACL token. å¦‚æœä½ çš„é›†ç¾¤æœªå¯ç”¨å°±ä¸éœ€è¦è®¾ç½®.</span><br><span class="line">//</span><br><span class="line">// è¿™ä¸ªé€‰é¡¹ä¹Ÿå¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡ CONSUL_TOKEN æ¥è¿›è¡Œè®¾ç½®</span><br><span class="line">token = &quot;abcd1234&quot;</span><br><span class="line">// è¿™æ˜¯ç›‘å¬å‡ºå‘reloadäº‹ä»¶çš„ä¿¡å·,é»˜è®¤å€¼å¦‚ä¸‹æ‰€ç¤º.å°†è¿™ä¸ªå€¼è®¾ç½®ä¸ºç©ºå°†å¼•èµ· CT ,ä»è€Œä¸ç›‘å¬reloadäº‹ä»¶</span><br><span class="line">reload_signal = &quot;SIGHUP&quot;</span><br><span class="line">// è¿™æ˜¯ç›‘å¬å‡ºå‘core dumpäº‹ä»¶çš„ä¿¡å·,é»˜è®¤å€¼å¦‚ä¸‹æ‰€ç¤º.å°†è¿™ä¸ªå€¼è®¾ç½®ä¸ºç©ºå°†å¼•èµ· CT ,ä»è€Œä¸ç›‘å¬core dumpä¿¡å·</span><br><span class="line">dump_signal = &quot;SIGQUIT&quot;</span><br><span class="line">// è¿™æ˜¯ç›‘å¬å‡ºå‘graceful stopäº‹ä»¶çš„ä¿¡å·,é»˜è®¤å€¼å¦‚ä¸‹æ‰€ç¤º.å°†è¿™ä¸ªå€¼è®¾ç½®ä¸ºç©ºå°†å¼•èµ· CT ,ä»è€Œä¸ç›‘å¬graceful stopä¿¡å·</span><br><span class="line">kill_signal = &quot;SIGINT&quot;</span><br><span class="line">// è¿™æ˜¯è¿æ¥Consulçš„é‡è¯•æ—¶é—´.Consul Templateæ˜¯é«˜å®¹é”™çš„è®¾è®¡.è¿™æ„å‘³ç€,å‡ºç°å¤±è´¥ä»–ä¸ä¼šé€€å‡º.è€ŒæŒ‰ç…§</span><br><span class="line">// åˆ†å¸ƒå¼ç³»ç»Ÿçš„æƒ¯ä¾‹è¿›è¡ŒæŒ‡æ•°è¡¥å¿å’Œé‡è¯•æ¥ç­‰å¾…é›†ç¾¤æ¢å¤.</span><br><span class="line">retry = &quot;10s&quot;</span><br><span class="line">// This is the maximum interval to allow &quot;stale&quot; data. By default, only the</span><br><span class="line">// Consul leader will respond to queries; any requests to a follower will</span><br><span class="line">// forward to the leader. In large clusters with many requests, this is not as</span><br><span class="line">// scalable, so this option allows any follower to respond to a query, so long</span><br><span class="line">// as the last-replicated data is within these bounds. Higher values result in</span><br><span class="line">// less cluster load, but are more likely to have outdated data.</span><br><span class="line">// è¿™æ˜¯å…è®¸é™ˆæ—§æ•°æ®çš„æœ€å¤§æ—¶é—´.Consulé»˜è®¤åªæœ‰é¢†è¢–å¯¹è¯·æ±‚è¿›è¡Œç›¸åº”.æ‰€æœ‰å¯¹è¿½éšè€…çš„è¯·æ±‚å°†è¢«è½¬å‘ç»™é¢†è¢–.</span><br><span class="line">// åœ¨æœ‰å¤§é‡è¯·æ±‚çš„å¤§å‹é›†ç¾¤ä¸­,è¿™æ˜¾å¾—ä¸å¤Ÿæœ‰æ‰©å±•æ€§.æ‰€ä»¥è¿™ä¸ªé€‰é¡¹å…è®¸ä»»ä½•è¿½éšè€…å“åº”æŸ¥è¯¢,åªè¦æœ€åå¤åˆ¶çš„æ•°æ®</span><br><span class="line">// åœ¨è¿™ä¸ªèŒƒå›´å†….æ•°å€¼è¶Šé«˜,è¶Šå‡å°‘é›†ç¾¤è´Ÿè½½,ä½†æ˜¯æ›´å®¹æ˜“æ¥å—åˆ°è¿‡æœŸæ•°æ®.</span><br><span class="line">max_stale = &quot;10m&quot;</span><br><span class="line">// è¿™æ˜¯logçš„ç­‰çº§,å¦‚æœä½ æ‰¾åˆ°äº†bug,è¯·æ‰“å¼€debug æ—¥å¿—,è¿™æ ·æˆ‘ä»¬å¯ä»¥æ›´å¥½çš„å®šä½é—®é¢˜.è¿™ä¸ªé€‰é¡¹ä¹Ÿå¯ç”¨åœ¨å‘½ä»¤è¡Œ.</span><br><span class="line">log_level = &quot;warn&quot;</span><br><span class="line">// è¿™æ˜¯å­˜æ”¾Consul Template è¿›ç¨‹çš„PIDæ–‡ä»¶çš„è·¯å¾„,å¦‚æœä½ è®¡åˆ’å‘é€å®šåˆ¶çš„ä¿¡å·åˆ°è¿™ä¸ªè¿›ç¨‹è¿™ä¼šæ¯”è¾ƒæœ‰ç”¨.</span><br><span class="line">pid_file = &quot;/path/to/pid&quot;</span><br><span class="line">// è¿™æ˜¯ä¸€ä¸ªé™æ­¢å®šæ—¶å™¨,ä»–å®šä¹‰äº†åœ¨æ¨¡æ¿æ¸²æŸ“ä¹‹å‰ç­‰å¾…é›†ç¾¤è¾¾åˆ°ä¸€è‡´çŠ¶æ€çš„æœ€å°å’Œæœ€å¤§æ—¶é—´.</span><br><span class="line">// è¿™å¯¹äºä¸€äº›å˜åŒ–è¾ƒå¤§çš„ç³»ç»Ÿä¸­æ¯”è¾ƒæœ‰ç”¨,å¯ä»¥å‡å°‘æ¨¡æ¿æ¸²æŸ“çš„æ¬¡æ•°</span><br><span class="line">wait = &quot;5s:10s&quot;</span><br><span class="line">// è¿™æ˜¯ Vaulté…ç½®çš„å¼€å§‹</span><br><span class="line">// Vaultæ˜¯HashiCorpçš„å¦å¤–ä¸€ä¸ªäº§å“</span><br><span class="line">vault &#123;</span><br><span class="line">  // This is the address of the Vault leader. The protocol (http(s)) portion</span><br><span class="line">  // of the address is required.</span><br><span class="line">  address = &quot;https://vault.service.consul:8200&quot;</span><br><span class="line">  // This is the token to use when communicating with the Vault server.</span><br><span class="line">  // Like other tools that integrate with Vault, Consul Template makes the</span><br><span class="line">  // assumption that you provide it with a Vault token; it does not have the</span><br><span class="line">  // incorporated logic to generate tokens via Vault&#x27;s auth methods.</span><br><span class="line">  //</span><br><span class="line">  // This value can also be specified via the environment variable VAULT_TOKEN.</span><br><span class="line">  token = &quot;abcd1234&quot;</span><br><span class="line">  // This option tells Consul Template to automatically renew the Vault token</span><br><span class="line">  // given. If you are unfamiliar with Vault&#x27;s architecture, Vault requires</span><br><span class="line">  // tokens be renewed at some regular interval or they will be revoked. Consul</span><br><span class="line">  // Template will automatically renew the token at half the lease duration of</span><br><span class="line">  // the token. The default value is true, but this option can be disabled if</span><br><span class="line">  // you want to renew the Vault token using an out-of-band process.</span><br><span class="line">  //</span><br><span class="line">  // Note that secrets specified in a template (using &#123;&#123;secret&#125;&#125; for example)</span><br><span class="line">  // are always renewed, even if this option is set to false. This option only</span><br><span class="line">  // applies to the top-level Vault token itself.</span><br><span class="line">  renew = true</span><br><span class="line">  // This section details the SSL options for connecting to the Vault server.</span><br><span class="line">  // Please see the SSL options below for more information (they are the same).</span><br><span class="line">  ssl &#123;</span><br><span class="line">    // ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">// è¿™éƒ¨åˆ†é…ç½®è¯·æ±‚çš„åŸºæœ¬çš„æƒé™éªŒè¯ä¿¡æ¯</span><br><span class="line">auth &#123;</span><br><span class="line">  enabled  = true</span><br><span class="line">  username = &quot;test&quot;</span><br><span class="line">  password = &quot;test&quot;</span><br><span class="line">&#125;</span><br><span class="line">// è¿™éƒ¨åˆ†é…ç½®è¿æ¥åˆ°ConsulæœåŠ¡å™¨çš„SSLä¿¡æ¯.</span><br><span class="line">ssl &#123;</span><br><span class="line">  // ä½¿ç”¨SSLéœ€è¦å…ˆæ‰“å¼€è¿™ä¸ªå¼€å…³</span><br><span class="line">  enabled = true</span><br><span class="line">  // This enables SSL peer verification. The default value is &quot;true&quot;, which</span><br><span class="line">  // will check the global CA chain to make sure the given certificates are</span><br><span class="line">  // valid. If you are using a self-signed certificate that you have not added</span><br><span class="line">  // to the CA chain, you may want to disable SSL verification. However, please</span><br><span class="line">  // understand this is a potential security vulnerability.</span><br><span class="line">  verify = false</span><br><span class="line">  // This is the path to the certificate to use to authenticate. If just a</span><br><span class="line">  // certificate is provided, it is assumed to contain both the certificate and</span><br><span class="line">  // the key to convert to an X509 certificate. If both the certificate and</span><br><span class="line">  // key are specified, Consul Template will automatically combine them into an</span><br><span class="line">  // X509 certificate for you.</span><br><span class="line">  cert = &quot;/path/to/client/cert&quot;</span><br><span class="line">  key = &quot;/path/to/client/key&quot;</span><br><span class="line">  // This is the path to the certificate authority to use as a CA. This is</span><br><span class="line">  // useful for self-signed certificates or for organizations using their own</span><br><span class="line">  // internal certificate authority.</span><br><span class="line">  ca_cert = &quot;/path/to/ca&quot;</span><br><span class="line">&#125;</span><br><span class="line">// è®¾ç½®è¿æ¥åˆ°syslogæœåŠ¡å™¨çš„é…ç½®</span><br><span class="line">// ç”¨äºè¿›è¡Œæ—¥å¿—è®°å½•syslog &#123;</span><br><span class="line">  // æ‰“å¼€å¼€å…³</span><br><span class="line">  enabled = true</span><br><span class="line">  // è®¾å¤‡åç§°</span><br><span class="line">  facility = &quot;LOCAL5&quot;</span><br><span class="line">&#125;</span><br><span class="line">// This block defines the configuration for de-duplication mode. Please see the</span><br><span class="line">// de-duplication mode documentation later in the README for more information</span><br><span class="line">// on how de-duplication mode operates.</span><br><span class="line">deduplicate &#123;</span><br><span class="line">  // This enables de-duplication mode. Specifying any other options also enables</span><br><span class="line">  // de-duplication mode.</span><br><span class="line">  enabled = true</span><br><span class="line">  // This is the prefix to the path in Consul&#x27;s KV store where de-duplication</span><br><span class="line">  // templates will be pre-rendered and stored.</span><br><span class="line">  prefix = &quot;consul-template/dedup/&quot;</span><br><span class="line">&#125;</span><br><span class="line">// This block defines the configuration for exec mode. Please see the exec mode</span><br><span class="line">// documentation at the bottom of this README for more information on how exec</span><br><span class="line">// mode operates and the caveats of this mode.</span><br><span class="line">exec &#123;</span><br><span class="line">  // This is the command to exec as a child process. There can be only one</span><br><span class="line">  // command per Consul Template process.</span><br><span class="line">  command = &quot;/usr/bin/app&quot;</span><br><span class="line">  // This is a random splay to wait before killing the command. The default</span><br><span class="line">  // value is 0 (no wait), but large clusters should consider setting a splay</span><br><span class="line">  // value to prevent all child processes from reloading at the same time when</span><br><span class="line">  // data changes occur. When this value is set to non-zero, Consul Template</span><br><span class="line">  // will wait a random period of time up to the splay value before reloading</span><br><span class="line">  // or killing the child process. This can be used to prevent the thundering</span><br><span class="line">  // herd problem on applications that do not gracefully reload.</span><br><span class="line">  splay = &quot;5s&quot;</span><br><span class="line">  // This defines the signal that will be sent to the child process when a</span><br><span class="line">  // change occurs in a watched template. The signal will only be sent after</span><br><span class="line">  // the process is started, and the process will only be started after all</span><br><span class="line">  // dependent templates have been rendered at least once. The default value</span><br><span class="line">  // is &quot;&quot; (empty or nil), which tells Consul Template to restart the child</span><br><span class="line">  // process instead of sending it a signal. This is useful for legacy</span><br><span class="line">  // applications or applications that cannot properly reload their</span><br><span class="line">  // configuration without a full reload.</span><br><span class="line">  reload_signal = &quot;SIGUSR1&quot;</span><br><span class="line">  // This defines the signal sent to the child process when Consul Template is</span><br><span class="line">  // gracefully shutting down. The application should begin a graceful cleanup.</span><br><span class="line">  // If the application does not terminate before the `kill_timeout`, it will</span><br><span class="line">  // be terminated (effectively &quot;kill -9&quot;). The default value is &quot;SIGTERM&quot;.</span><br><span class="line">  kill_signal = &quot;SIGINT&quot;</span><br><span class="line">  // This defines the amount of time to wait for the child process to gracefully</span><br><span class="line">  // terminate when Consul Template exits. After this specified time, the child</span><br><span class="line">  // process will be force-killed (effectively &quot;kill -9&quot;). The default value is</span><br><span class="line">  // &quot;30s&quot;.</span><br><span class="line">  kill_timeout = &quot;2s&quot;</span><br><span class="line">&#125;</span><br><span class="line">// è¿™éƒ¨åˆ†å®šä¹‰äº†å¯¹æ¨¡æ¿çš„é…ç½®,å’Œå…¶ä»–é…ç½®å—ä¸åŒ.è¿™éƒ¨åˆ†å¯ä»¥é’ˆå¯¹ä¸åŒæ¨¡æ¿é…ç½®å¤šæ¬¡.ä¹Ÿå¯ä»¥åœ¨CLIå‘½ä»¤</span><br><span class="line">// ç›´æ¥è¿›è¡Œé…ç½®</span><br><span class="line">template &#123;</span><br><span class="line">  // è¿™æ˜¯è¾“å…¥æ¨¡æ¿çš„é…ç½®æ–‡ä»¶è·¯å¾„,å¿…é€‰é¡¹</span><br><span class="line">  source = &quot;/path/on/disk/to/template.ctmpl&quot;</span><br><span class="line">  // è¿™æ˜¯æºæ¨¡æ¿æ¸²æŸ“ä¹‹åå­˜æ”¾çš„è·¯å¾„,å¦‚æœçˆ¶ç›®å½•ä¸å­˜åœ¨Consul Templateä¼šå°è¯•è¿›è¡Œåˆ›å»º</span><br><span class="line">  destination = &quot;/path/on/disk/where/template/will/render.txt&quot;</span><br><span class="line">  // This is the optional command to run when the template is rendered. The</span><br><span class="line">  // command will only run if the resulting template changes. The command must</span><br><span class="line">  // return within 30s (configurable), and it must have a successful exit code.</span><br><span class="line">  // Consul Template is not a replacement for a process monitor or init system.</span><br><span class="line">  // è¿™æ˜¯å½“æ¨¡æ¿æ¸²æŸ“å®Œæˆåå¯é€‰çš„è¦æ‰§è¡Œçš„å‘½ä»¤.è¿™ä¸ªå‘½ä»¤åªä¼šåœ¨æ¨¡æ¿å‘ç”Ÿæ”¹å˜åæ‰ä¼šè¿è¡Œ.è¿™ä¸ªå‘½ä»¤å¿…é¡»è¦åœ¨30ç§’</span><br><span class="line">  // å†…è¿›è¡Œè¿”å›(å¯é…ç½®),å¿…é¡»è¿”å›ä¸€ä¸ªæˆåŠŸçš„é€€å‡ºç .Consul Templateä¸èƒ½æ›¿ä»£è¿›ç¨‹ç›‘è§†æˆ–è€…init ç³»ç»Ÿ</span><br><span class="line">  // çš„åŠŸèƒ½</span><br><span class="line">  command = &quot;restart service foo&quot;</span><br><span class="line">  // è¿™æ˜¯æœ€å¤§çš„ç­‰å¾…å‘½ä»¤è¿”å›çš„æ—¶é—´,é»˜è®¤æ˜¯30ç§’</span><br><span class="line">  command_timeout = &quot;60s&quot;</span><br><span class="line">  // è¿™æ˜¯æ¸²æŸ“åçš„æ–‡ä»¶çš„æƒé™,å¦‚æœä¸è®¾ç½®,Consul Templateå°†å»åŒ¹é…ä¹‹å‰å·²ç»å­˜åœ¨çš„æ–‡ä»¶çš„æƒé™.</span><br><span class="line">  // å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨,æƒé™ä¼šè¢«è®¾ç½®ä¸º 0644</span><br><span class="line">  perms = 0600</span><br><span class="line">  // è¿™ä¸ªé€‰é¡¹å¯¹æ¸²æŸ“ä¹‹å‰çš„æ–‡ä»¶è¿›è¡Œå¤‡ä»½.ä»–ä¿æŒä¸€ä¸ªå¤‡ä»½.</span><br><span class="line">  // è¿™ä¸ªé€‰é¡¹åœ¨å‘ç”Ÿæ„å¤–æ›´é«˜æ—¶,æœ‰ä¸€ä¸ªå›æ»šç­–ç•¥.</span><br><span class="line">  backup = true</span><br><span class="line">  // æ¨¡æ¿çš„åˆ†éš”ç¬¦,é»˜è®¤æ˜¯ &quot;&#123;&#123;&quot;å’Œ&quot;&#125;&#125;&quot;.ä½†æ˜¯å¯¹äºä¸€äº›æ¨¡æ¿ç”¨å…¶ä»–çš„åˆ†éš”ç¬¦å¯èƒ½æ›´å¥½</span><br><span class="line">  // å¯ä»¥é¿å…ä¸æœ¬èº«çš„å†²çª</span><br><span class="line">  left_delimiter  = &quot;&#123;&#123;&quot;</span><br><span class="line">  right_delimiter = &quot;&#125;&#125;&quot;</span><br><span class="line">  // è¿™æ˜¯æœ€å°å’Œæœ€å¤§ç­‰å¾…æ¸²æŸ“ä¸€ä¸ªæ–°æ¨¡æ¿å’Œæ‰§è¡Œå‘½ä»¤çš„æ—¶é—´.ä½¿ç”¨ åˆ†å· ä¸ªå·.å¦‚æœå¿½ç•¥æœ€å¤§å€¼,æœ€å¤§</span><br><span class="line">  // å€¼ä¼šè¢«è®¾ç½®ä¸ºæœ€å°å€¼çš„4å€.è¿™ä¸ªé€‰é¡¹æ²¡æœ‰é»˜è®¤å€¼.è¿™ä¸ªå€¼ç›¸å¯¹å…¨å±€æ‰€ä»¥çš„ç­‰å¾…æ—¶é—´æœ‰æœ€é«˜ä¼˜å…ˆçº§</span><br><span class="line">  wait = &quot;2s:6s&quot;</span><br><span class="line">&#125;123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180</span><br></pre></td></tr></table></figure>

<p><strong>æ³¨æ„</strong>: ä¸æ˜¯æ‰€æœ‰çš„é€‰é¡¹éƒ½æ˜¯å¿…é€‰çš„.ä¾‹å¦‚: å¦‚æœä½ æ²¡æœ‰ä½¿ç”¨Vaultä½ ä¸ç”¨è®¾ç½®è¿™ä¸€å—. ç±»ä¼¼çš„ä½ æ²¡æœ‰ä½¿ç”¨syslogç³»ç»Ÿä½ ä¹Ÿä¸éœ€è¦æŒ‡å®šsyslogé…ç½®.</p>
<p>ä¸ºäº†æ›´åŠ å®‰å…¨,<code>token</code>ä¹Ÿå¯ä»¥ä»ç¯å¢ƒå˜é‡é‡Œè¯»å–,ä½¿ç”¨ <code>CONSUL_TOKEN</code> å’Œ <code>VAULT_TOKEN</code>.å¼ºçƒˆå»ºè®®ä½ ä¸è¦æŠŠtokenæ”¾åˆ°æœªåŠ å¯†çš„æ–‡æœ¬é…ç½®æ–‡ä»¶ä¸­.</p>
<h2 id="æ¨¡ç‰ˆè¯­æ³•"><a href="#æ¨¡ç‰ˆè¯­æ³•" class="headerlink" title="æ¨¡ç‰ˆè¯­æ³•"></a>æ¨¡ç‰ˆè¯­æ³•</h2><p>Consul Template ä½¿ç”¨äº†Goçš„æ¨¡æ¿è¯­æ³•.å¦‚æœä½ å¯¹ä»–çš„è¯­æ³•ä¸ç†Ÿæ‚‰å»ºè®®ä½ è¯»ä¸‹æ–‡æ¡£.ä»–çš„è¯­æ³•çœ‹èµ·æ¥ä¸ Mustache, Handlebars, æˆ–è€… Liquid ç±»ä¼¼.</p>
<p>åœ¨Go æä¾›çš„æ¨¡æ¿å‡½æ•°ä¹‹å¤–,Consul Templateæš´éœ²äº†ä»¥ä¸‹çš„å‡½æ•°:</p>
<h2 id="API-å‡½æ•°"><a href="#API-å‡½æ•°" class="headerlink" title="API å‡½æ•°"></a>API å‡½æ•°</h2><p><strong>datacenters</strong><br> æŸ¥è¯¢ç›®å½•ä¸­çš„æ‰€æœ‰æ•°æ®ä¸­å¿ƒ.ä½¿ç”¨ä»¥ä¸‹è¯­æ³•:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;datacenters&#125;&#125;1</span><br></pre></td></tr></table></figure>

<p><strong>file</strong><br> è¯»å–å¹¶è¾“å‡ºç£ç›˜ä¸Šçš„æœ¬åœ°æ–‡ä»¶,å¦‚æœæ— æ³•è¯»å–äº§ç”Ÿä¸€ä¸ªé”™è¯¯.ä½¿ç”¨å¦‚ä¸‹è¯­æ³•</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;file &quot;/path/to/local/file&quot;&#125;&#125;1</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªä¾‹å­å°†è¾“å‡º <code>/path/to/local/file</code> æ–‡ä»¶å†…å®¹åˆ°æ¨¡æ¿. æ³¨æ„:è¿™ä¸ä¼šåœ¨åµŒå¥—æ¨¡æ¿ä¸­è¢«å¤„ç†</p>
<p><strong>key</strong><br> æŸ¥è¯¢ConsulæŒ‡å®škeyçš„å€¼,å¦‚æœkeyçš„å€¼ä¸èƒ½è½¬æ¢ä¸ºå­—ç¬¦ä¸²,å°†äº§ç”Ÿé”™è¯¯.ä½¿ç”¨å¦‚ä¸‹è¯­æ³•:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;key &quot;service/redis/maxconns@east-aws&quot;&#125;&#125;1</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢çš„ä¾‹å­æŸ¥è¯¢äº†åœ¨<code>east-aws</code>æ•°æ®ä¸­å¿ƒçš„ <code>service/redis/maxconns</code>çš„å€¼.å¦‚æœå¿½ç•¥æ•°æ®ä¸­å¿ƒå‚æ•°,å°†ä¼šæŸ¥è¯¢æœ¬åœ°æ•°æ®ä¸­å¿ƒçš„å€¼:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;key &quot;service/redis/maxconns&quot;&#125;&#125;1</span><br></pre></td></tr></table></figure>

<p>Consulé”®å€¼ç»“æ„çš„ç¾å¦™åœ¨äº,è¿™å®Œå…¨å–å†³äºä½ !</p>
<p><strong>key_or_default</strong><br> æŸ¥è¯¢Consulä¸­æŒ‡å®šçš„keyçš„å€¼,å¦‚æœkeyä¸å­˜åœ¨,åˆ™è¿”å›é»˜è®¤å€¼.ä½¿ç”¨æ–¹å¼å¦‚ä¸‹</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;key_or_default &quot;service/redis/maxconns@east-aws&quot; &quot;5&quot;&#125;&#125;1</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„Consul Templateä½¿ç”¨äº†å¤šä¸ªé˜¶æ®µçš„è¿ç®—.åœ¨ç¬¬ä¸€é˜¶æ®µçš„è¿ç®—å¦‚æœConsulæ²¡æœ‰è¿”å›å€¼,åˆ™ä¼šä¸€ç›´ä½¿ç”¨é»˜è®¤å€¼.åç»­æ¨¡æ¿è§£æä¸­å¦‚æœå€¼å­˜åœ¨äº†åˆ™ä¼šè¯»å–çœŸå®çš„å€¼.è¿™å¾ˆé‡è¦,è¿ç»´Consul Templaeä¸ä¼šå› ä¸º<code>key_or_default</code>æ²¡æ‰¾åˆ°keyè€Œé˜»å¡æ¨¡æ¿çš„çš„æ¸²æŸ“.å³ä½¿keyå­˜åœ¨å¦‚æœConsulæ²¡æœ‰æŒ‰æ—¶è¿”å›è¿™ä¸ªæ•°æ®,ä¹Ÿä¼šä½¿ç”¨é»˜è®¤å€¼æ¥è¿›è¡Œæ›¿ä»£.</p>
<p><strong>ls</strong><br> æŸ¥çœ‹Consulçš„æ‰€æœ‰ä»¥æŒ‡å®šå‰ç¼€å¼€å¤´çš„key-valueå¯¹.å¦‚æœæœ‰å€¼æ— æ³•è½¬æ¢æˆå­—ç¬¦ä¸²åˆ™ä¼šäº§ç”Ÿä¸€ä¸ªé”™è¯¯:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;range ls &quot;service/redis@east-aws&quot;&#125;&#125;</span><br><span class="line">&#123;&#123;.Key&#125;&#125; &#123;&#123;.Value&#125;&#125;&#123;&#123;end&#125;&#125;12</span><br></pre></td></tr></table></figure>

<p>å¦‚æœConsulå®ä¾‹åœ¨<code>east-aws</code>æ•°æ®ä¸­å¿ƒå­˜åœ¨è¿™ä¸ªç»“æ„<code>service/redis</code>,æ¸²æŸ“åçš„æ¨¡æ¿åº”è¯¥ç±»ä¼¼è¿™æ ·:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">minconns 2</span><br><span class="line">maxconns 1212</span><br></pre></td></tr></table></figure>

<p>å¦‚æœä½ å¿½ç•¥æ•°æ®ä¸­å¿ƒå±æ€§,åˆ™ä¼šè¿”å›æœ¬åœ°æ•°æ®ä¸­å¿ƒçš„æŸ¥è¯¢ç»“æœ.</p>
<p><strong>node</strong><br> æŸ¥è¯¢ç›®å½•ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹ä¿¡æ¯</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;node &quot;node1&quot;&#125;&#125;1</span><br></pre></td></tr></table></figure>

<p>å¦‚æœæœªæŒ‡å®šä»»ä½•å‚æ•°,åˆ™å½“å‰agentæ‰€åœ¨èŠ‚ç‚¹å°†ä¼šè¢«è¿”å›:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;node&#125;&#125;1</span><br></pre></td></tr></table></figure>

<p>ä½ å¯ä»¥æŒ‡å®šä¸€ä¸ªå¯é€‰çš„å‚æ•°æ¥æŒ‡å®šæ•°æ®ä¸­å¿ƒ:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;node &quot;node1&quot; &quot;@east-aws&quot;&#125;&#125;1</span><br></pre></td></tr></table></figure>

<p>å¦‚æœæŒ‡å®šçš„èŠ‚ç‚¹æ²¡æœ‰æ‰¾åˆ°åˆ™ä¼šè¿”å›<code>nil</code>.å¦‚æœèŠ‚ç‚¹å­˜åœ¨å°±ä¼šåˆ—å‡ºèŠ‚ç‚¹çš„ä¿¡æ¯å’ŒèŠ‚ç‚¹æä¾›çš„æœåŠ¡.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;with node&#125;&#125;&#123;&#123;.Node.Node&#125;&#125; (&#123;&#123;.Node.Address&#125;&#125;)&#123;&#123;range .Services&#125;&#125;</span><br><span class="line">  &#123;&#123;.Service&#125;&#125; &#123;&#123;.Port&#125;&#125; (&#123;&#123;.Tags | join &quot;,&quot;&#125;&#125;)&#123;&#123;end&#125;&#125;</span><br><span class="line">&#123;&#123;end&#125;&#125;123</span><br></pre></td></tr></table></figure>

<p><strong>nodes</strong><br> æŸ¥è¯¢ç›®å½•ä¸­çš„å…¨éƒ¨èŠ‚ç‚¹,ä½¿ç”¨å¦‚ä¸‹è¯­æ³•</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;nodes&#125;&#125;1</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªä¾‹å­ä¼šæŸ¥è¯¢Consulçš„é»˜è®¤æ•°æ®ä¸­å¿ƒ.ä½ å¯ä»¥ä½¿ç”¨å¯é€‰å‚æ•°æŒ‡å®šä¸€ä¸ªå¯é€‰å‚æ•°æ¥æŒ‡å®šæ•°æ®ä¸­å¿ƒ:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;nodes &quot;@east-aws&quot;&#125;&#125;1</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªä¾‹å­ä¼šæŸ¥è¯¢east-awsæ•°æ®ä¸­å¿ƒçš„æ‰€æœ‰å‡ ç‚¹.</p>
<p><strong>secret</strong><br> æŸ¥è¯¢<code>Vault</code>ä¸­æŒ‡å®šè·¯å¾„çš„å¯†åŒ™.å¦‚æœæŒ‡å®šçš„è·¯å¾„ä¸å­˜åœ¨æˆ–è€…<code>Vault</code>çš„<code>Token</code>æ²¡æœ‰è¶³å¤Ÿæƒé™å»è¯»å–æŒ‡å®šçš„è·¯å¾„,å°†ä¼šäº§ç”Ÿä¸€ä¸ªé”™è¯¯.å¦‚æœè·¯å¾„å­˜åœ¨ä½†æ˜¯keyä¸å­˜åœ¨åˆ™è¿”å›â€œ.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;with secret &quot;secret/passwords&quot;&#125;&#125;&#123;&#123;.Data.password&#125;&#125;&#123;&#123;end&#125;&#125;1</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å­—æ®µ:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">LeaseID - the unique lease identifier</span><br><span class="line">LeaseDuration - the number of seconds the lease is valid</span><br><span class="line">Renewable - if the secret is renewable</span><br><span class="line">Data - the raw data - this is a map[string]interface&#123;&#125;, so it can be queried using Go&#x27;s templating &quot;dot notation&quot;</span><br><span class="line">If the map key has dots &quot;.&quot; in it, you need to access the value using the index function:</span><br><span class="line">&#123;&#123;index .Data &quot;my.key.with.dots&quot;&#125;&#125;</span><br><span class="line">If additional arguments are passed to the function, then the operation is assumed to be a write operation instead of a read operation. The write operation must return data in order to be valid. This is especially useful for the PKI secret backend, for example.</span><br><span class="line">&#123;&#123; with secret &quot;pki/issue/my-domain-dot-com&quot; &quot;common_name=foo.example.com&quot; &#125;&#125;</span><br><span class="line">&#123;&#123; .Data.certificate &#125;&#125;</span><br><span class="line">&#123;&#123; end &#125;&#125;</span><br><span class="line">The parameters must be key=value pairs, and each pair must be its own argument to the function:</span><br><span class="line">&#123;&#123; secret &quot;path/&quot; &quot;a=b&quot; &quot;c=d&quot; &quot;e=f&quot; &#125;&#125;</span><br><span class="line">Please always consider the security implications of having the contents of a secret in plain-text on disk. If an attacker is able to get access to the file, they will have access to plain-text secrets.12345678910111213</span><br></pre></td></tr></table></figure>

<p>Please note that Vault does not support blocking queries. As a  result, Consul Template will not immediately reload in the event a  secret is changed as it does with Consulâ€™s key-value store. Consul  Template will fetch a new secret at half the lease duration of the  original secret. For example, most items in Vaultâ€™s generic secret  backend have a default 30 day lease. This means Consul Template will  renew the secret every 15 days. As such, it is recommended that a  smaller lease duration be used when generating the initial secret to  force Consul Template to renew more often.</p>
<p><strong>secrets</strong><br> Query Vault to list the secrets at the given path. Please note this  requires Vault 0.5+ and the endpoint you want to list secrets must  support listing. Not all endpoints support listing. The result is the  list of secret names as strings.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;range secrets &quot;secret/&quot;&#125;&#125;&#123;&#123;.&#125;&#125;&#123;&#123;end&#125;&#125;1</span><br></pre></td></tr></table></figure>

<p>The trailing slash is optional in the template, but the generated  secret dependency will always have a trailing slash in log output.</p>
<p>To iterate and list over every secret in the generic secret backend  in Vault, for example, you would need to do something like this:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;range secrets &quot;secret/&quot;&#125;&#125;</span><br><span class="line">&#123;&#123;with secret (printf &quot;secret/%s&quot; .)&#125;&#125;</span><br><span class="line">&#123;&#123;range $k, $v := .Data&#125;&#125;</span><br><span class="line">&#123;&#123;$k&#125;&#125;: &#123;&#123;$v&#125;&#125;</span><br><span class="line">&#123;&#123;end&#125;&#125;</span><br><span class="line">&#123;&#123;end&#125;&#125;</span><br><span class="line">&#123;&#123;end&#125;&#125;1234567</span><br></pre></td></tr></table></figure>

<p>You should probably never do this. Please also note that Vault does  not support blocking queries. To understand the implications, please  read the note at the end of the secret function.</p>
<p><strong>service</strong><br> æŸ¥è¯¢Consulä¸­åŒ¹é…è¡¨è¾¾å¼çš„æœåŠ¡.è¯­æ³•å¦‚ä¸‹:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;service &quot;release.web@east-aws&quot;&#125;&#125;1</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢çš„ä¾‹å­æŸ¥è¯¢Consulä¸­,åœ¨<code>east-aws</code>æ•°æ®ä¸­å¿ƒå­˜åœ¨çš„å¥åº·çš„ <code>web</code>æœåŠ¡.tagå’Œæ•°æ®ä¸­å¿ƒå‚æ•°æ˜¯å¯é€‰çš„.ä»å½“å‰æ•°æ®ä¸­å¿ƒæŸ¥è¯¢æ‰€æœ‰èŠ‚ç‚¹çš„<code>web</code>æœåŠ¡è€Œä¸ç®¡tag,æŸ¥è¯¢è¯­æ³•å¦‚ä¸‹:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;service &quot;web&quot;&#125;&#125;1</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªå‡½æ•°è¿”å›<code>[]*HealthService</code>ç»“æ„.å¯æŒ‰ç…§å¦‚ä¸‹æ–¹å¼åº”ç”¨åˆ°æ¨¡æ¿:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;range service &quot;web@data center&quot;&#125;&#125;</span><br><span class="line">server &#123;&#123;.Name&#125;&#125; &#123;&#123;.Address&#125;&#125;:&#123;&#123;.Port&#125;&#125;&#123;&#123;end&#125;&#125;12</span><br></pre></td></tr></table></figure>

<p>äº§ç”Ÿå¦‚ä¸‹è¾“å‡º:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">server nyc_web_01 123.456.789.10:8080</span><br><span class="line">server nyc_web_02 456.789.101.213:808012</span><br></pre></td></tr></table></figure>

<p>é»˜è®¤å€¼ä¼šè¿”å›å¥åº·çš„æœåŠ¡,å¦‚æœä½ æƒ³è·å–æ‰€æœ‰æœåŠ¡,å¯ä»¥å¢åŠ <code>any</code>é€‰é¡¹,å¦‚ä¸‹:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;service &quot;web&quot; &quot;any&quot;&#125;&#125;1</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·å°±ä¼šè¿”å›æ³¨å†Œè¿‡çš„æ‰€æœ‰æœåŠ¡,è€Œä¸è®ºä»–çš„çŠ¶æ€å¦‚ä½•.</p>
<p>å¦‚æœä½ æƒ³è¿‡æ»¤æŒ‡å®šçš„ä¸€ä¸ªæˆ–è€…å¤šä¸ªå¥åº·çŠ¶æ€,ä½ å¯ä»¥é€šè¿‡é€—å·éš”å¼€å¤šä¸ªå¥åº·çŠ¶æ€:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;service &quot;web&quot; &quot;passing, warning&quot;&#125;&#125;1</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·å°†ä¼šè¿”å›è¢«ä»–ä»¬çš„èŠ‚ç‚¹å’ŒæœåŠ¡çº§åˆ«çš„æ£€æŸ¥å®šä¹‰æ ‡è®°ä¸º â€œpassingâ€ æˆ–è€… â€œwarningâ€çš„æœåŠ¡. è¯·æ³¨æ„é€—å·æ˜¯ <code>OR</code>è€Œä¸æ˜¯<code>AND</code>çš„æ„æ€.</p>
<p>æŒ‡å®šäº†è¶…è¿‡ä¸€ä¸ªçŠ¶æ€è¿‡æ»¤,å¹¶åŒ…å«<code>any</code>å°†ä¼šè¿”å›ä¸€ä¸ªé”™è¯¯.å› ä¸º<code>any</code>æ˜¯æ¯”æ‰€æœ‰çŠ¶æ€æ›´é«˜çº§çš„è¿‡æ»¤.</p>
<p>åé¢è¿™2ç§æ–¹å¼æœ‰äº›æ¶æ„ä¸Šçš„ä¸åŒ:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;service &quot;web&quot;&#125;&#125;</span><br><span class="line">&#123;&#123;service &quot;web&quot; &quot;passing&quot;&#125;&#125;12</span><br></pre></td></tr></table></figure>

<p>å‰è€…ä¼šè¿”å›Consulè®¤ä¸º<code>healthy</code>å’Œ<code>passing</code>çš„æ‰€æœ‰æœåŠ¡.åè€…å°†è¿”å›æ‰€æœ‰å·²ç»åœ¨Consulæ³¨å†Œçš„æœåŠ¡.ç„¶åä¼šæ‰§è¡Œä¸€ä¸ªå®¢æˆ·ç«¯çš„è¿‡æ»¤.é€šå¸¸å¦‚æœä½ æƒ³è·å–å¥åº·çš„æœåŠ¡,ä½ åº”è¯¥ä¸è¦ä½¿ç”¨<code>passing</code>å‚æ•°,ç›´æ¥å¿½ç•¥ç¬¬ä¸‰ä¸ªå‚æ•°å³å¯.ç„¶è€Œç¬¬ä¸‰ä¸ªå‚æ•°åœ¨ä½ æƒ³æŸ¥è¯¢ passingæˆ–è€…<code>warning</code>çš„æœåŠ¡ä¼šæ¯”è¾ƒæœ‰ç”¨,å¦‚ä¸‹:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;service &quot;web&quot; &quot;passing, warning&quot;&#125;&#125;1</span><br></pre></td></tr></table></figure>

<p>æœåŠ¡çš„çŠ¶æ€ä¹Ÿæ˜¯å¯è§çš„,å¦‚æœä½ æƒ³è‡ªå·±åšä¸€äº›é¢å¤–çš„è¿‡æ»¤,è¯­æ³•å¦‚ä¸‹:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;range service &quot;web&quot; &quot;any&quot;&#125;&#125;</span><br><span class="line">&#123;&#123;if eq .Status &quot;critical&quot;&#125;&#125;</span><br><span class="line">// Critical state!&#123;&#123;end&#125;&#125;</span><br><span class="line">&#123;&#123;if eq .Status &quot;passing&quot;&#125;&#125;</span><br><span class="line">// Ok&#123;&#123;end&#125;&#125;12345</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œå‘½ä»¤æ—¶,åœ¨Consulå°†æœåŠ¡è®¾ç½®ä¸ºç»´æŠ¤æ¨¡å¼,åªéœ€è¦åœ¨ä½ çš„å‘½ä»¤ä¸ŠåŒ…ä¸ŠConsulçš„ <code>maint</code> è°ƒç”¨:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line">set -e</span><br><span class="line">consul maint -enable -service web -reason &quot;Consul Template updated&quot;</span><br><span class="line">service nginx reload</span><br><span class="line">consul maint -disable -service web12345</span><br></pre></td></tr></table></figure>

<p>å¦å¤–å¦‚æœä½ æ²¡æœ‰å®‰è£…Consul agent,ä½ å¯ä»¥ç›´æ¥è°ƒç”¨APIè¯·æ±‚:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line">set -e</span><br><span class="line">curl -X PUT &quot;http://$CONSUL_HTTP_ADDR/v1/agent/service/maintenance/web?enable=true&amp;reason=Consul+Template+Updated&quot;</span><br><span class="line">service nginx reload</span><br><span class="line">curl -X PUT &quot;http://$CONSUL_HTTP_ADDR/v1/agent/service/maintenance/web?enable=false&quot;12345</span><br></pre></td></tr></table></figure>

<p><strong>services</strong><br> æŸ¥è¯¢Consulç›®å½•ä¸­çš„æ‰€æœ‰æœåŠ¡,ä½¿ç”¨å¦‚ä¸‹è¯­æ³•:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;services&#125;&#125;1</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªä¾‹å­å°†æŸ¥è¯¢Consulçš„é»˜è®¤æ•°æ®ä¸­å¿ƒ,ä½ å¯ä»¥æŒ‡å®šä¸€ä¸ªå¯é€‰å‚æ•°æ¥æŒ‡å®šæ•°æ®ä¸­å¿ƒ:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;services &quot;@east-aws&quot;&#125;&#125;1</span><br></pre></td></tr></table></figure>

<p>è¯·æ³¨æ„: serviceså‡½æ•°ä¸serviceæ˜¯ä¸åŒçš„,serviceæ¥å—æ›´å¤šå‚æ•°å¹¶ä¸”æŸ¥è¯¢ç›‘æ§çš„æœåŠ¡åˆ—è¡¨.è¿™ä¸ªæŸ¥è¯¢Consulç›®å½•å¹¶è¿”å›ä¸€ä¸ªæœåŠ¡çš„tagçš„Map,å¦‚ä¸‹:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;range services&#125;&#125;</span><br><span class="line">&#123;&#123;.Name&#125;&#125;</span><br><span class="line">&#123;&#123;range .Tags&#125;&#125;</span><br><span class="line">  &#123;&#123;.&#125;&#125;&#123;&#123;end&#125;&#125;</span><br><span class="line">&#123;&#123;end&#125;&#125;12345</span><br></pre></td></tr></table></figure>

<p><strong>tree</strong><br> æŸ¥è¯¢æ‰€æœ‰æŒ‡å®šå‰ç¼€çš„key-valueå€¼å¯¹,å¦‚æœå…¶ä¸­çš„å€¼æœ‰æ— æ³•è½¬æ¢ä¸ºå­—ç¬¦ä¸²çš„åˆ™å¼•å‘é”™è¯¯:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;range tree &quot;service/redis@east-aws&quot;&#125;&#125;</span><br><span class="line">&#123;&#123;.Key&#125;&#125; &#123;&#123;.Value&#125;&#125;&#123;&#123;end&#125;&#125;12</span><br></pre></td></tr></table></figure>

<p>å¦‚æœConsulå®ä¾‹åœ¨<code>east-aws</code>æ•°æ®ä¸­å¿ƒæœ‰ä¸€ä¸ª<code>service/redis</code>ç»“æ„,æ¨¡æ¿çš„æ¸²æŸ“ç»“æœç±»ä¼¼ä¸‹é¢:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">minconns 2</span><br><span class="line">maxconns 12</span><br><span class="line">nested/config/value &quot;value&quot;123</span><br></pre></td></tr></table></figure>

<p>å’Œ<code>ls</code>ä¸åŒ,<code>tree</code>è¿”å›å‰ç¼€ä¸‹çš„æ‰€æœ‰key.å’ŒUnixçš„treeå‘½ä»¤æ¯”è¾ƒåƒ.å¦‚æœå¿½ç•¥æ•°æ®ä¸­å¿ƒå‚æ•°,åˆ™ä¼šä½¿ç”¨æœ¬åœ°æ•°æ®ä¸­å¿ƒ</p>
<p><a target="_blank" rel="noopener" href="https://book-consul-guide.vnzmi.com/11_consul_template.html">æŸ¥çœ‹æ›´å¤š</a></p>
<p><a target="_blank" rel="noopener" href="https://book-consul-guide.vnzmi.com/11_consul_template.html">é¡¹ç›®Githubåœ°å€</a></p>
<h2 id="Haproxy-å®ä¾‹"><a href="#Haproxy-å®ä¾‹" class="headerlink" title="Haproxy å®ä¾‹"></a>Haproxy å®ä¾‹</h2><p>æ ¹æ®haproxyæœåŠ¡çš„é…ç½®æ–‡ä»¶åˆ›å»ºä¸€ä¸ªconsul-templateæ¨¡ç‰ˆæ¸²æŸ“æ–‡ä»¶ï¼š<code>haproxy.ctmpl</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Consul Haproxy configured</span></span><br><span class="line">global</span><br><span class="line">        maxconn         20480</span><br><span class="line">        ulimit-n        65535</span><br><span class="line">        log             127.0.0.1 local5</span><br><span class="line">        uid             200</span><br><span class="line">        gid             200</span><br><span class="line">        chroot          /usr/local/haproxy</span><br><span class="line">        nbproc          1</span><br><span class="line">        daemon</span><br><span class="line">        pidfile         /usr/local/haproxy/logs/haproxy.pid</span><br><span class="line">defaults</span><br><span class="line">        log             global</span><br><span class="line">        mode            http</span><br><span class="line">        option          httplog</span><br><span class="line">        option          dontlognull</span><br><span class="line">        option          forwardfor</span><br><span class="line">        option          abortonclose</span><br><span class="line">        retries         3</span><br><span class="line">        maxconn         3000</span><br><span class="line">        stats           enable</span><br><span class="line">        stats           hide-version</span><br><span class="line">        stats   uri     /admin</span><br><span class="line">        stats   auth    admin:admin</span><br><span class="line">        stats   refresh 10s</span><br><span class="line">        balance         roundrobin</span><br><span class="line">        timeout connect 5000ms</span><br><span class="line">        timeout client 50000ms</span><br><span class="line">        timeout server 50000ms</span><br><span class="line">        timeout check 2000ms</span><br><span class="line">listen web_haproxy</span><br><span class="line">        bind 0.0.0.0:8080</span><br><span class="line">        mode http</span><br><span class="line">        log     127.0.0.1 local5 err</span><br><span class="line">        stats   refresh 5s</span><br><span class="line">        stats   uri /admin</span><br><span class="line">        stats   realm liang lian</span><br><span class="line">        stats   auth admin:admin</span><br><span class="line">        stats   hide-version</span><br><span class="line">        stats   admin if TRUE</span><br><span class="line">frontend consul</span><br><span class="line">        bind    0.0.0.0:8500</span><br><span class="line">        mode    http</span><br><span class="line">        log     global</span><br><span class="line">        default_backend consul-cluster</span><br><span class="line">backend consul-cluster</span><br><span class="line">        mode http</span><br><span class="line">        &#123;&#123;range service &quot;Faceid&quot;&#125;&#125;</span><br><span class="line">        server &#123;&#123;.ID&#125;&#125; &#123;&#123;.Address&#125;&#125;:&#123;&#123;.Port&#125;&#125; check inter 5000 fall 1 rise 2 weight 2&#123;&#123;end&#125;&#125;12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œconsul-templateä½œä¸ºä¸€ä¸ªæœåŠ¡,é€šè¿‡ä¸Šé¢çš„æ¸²æŸ“æ¨¡ç‰ˆæ¸²æŸ“ä¸€ä¸ªhaproxy.cfgçš„é…ç½®æ–‡ä»¶ï¼Œç„¶åé‡å¯haproxyæœåŠ¡</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consul-template -consul-addr=10.201.102.185:8500 -template &quot;/root/haproxy.ctmpl:/etc/haproxy.cfg:service haproxy restart&quot;1</span><br></pre></td></tr></table></figure>

<p>10.201.102.185 çœ‹æˆ‘ä¸Šç¯‡æ–‡ç« <a target="_blank" rel="noopener" href="http://www.liangxiansen.cn/2017/03/06/haproxy/">Haproxy</a>ï¼Œè¿™æ˜¯consulé›†ç¾¤çš„VIPï¼Œä¸ºäº†é¿å…å•ç‹¬è°ƒæŸä¸€å°æœåŠ¡å™¨æœåŠ¡å™¨å‡ºç°æ•…éšœåconsul-templateæ— æ³•å·¥ä½œã€‚</p>
<p>æ¸²æŸ“åçš„<code>haproxy.cfg</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Consul Haproxy configured</span></span><br><span class="line">global</span><br><span class="line">        maxconn         20480</span><br><span class="line">        ulimit-n        65535</span><br><span class="line">        log             127.0.0.1 local5</span><br><span class="line">        uid             200</span><br><span class="line">        gid             200</span><br><span class="line">        chroot          /usr/local/haproxy</span><br><span class="line">        nbproc          1</span><br><span class="line">        daemon</span><br><span class="line">        pidfile         /usr/local/haproxy/logs/haproxy.pid</span><br><span class="line">defaults</span><br><span class="line">        log             global</span><br><span class="line">        mode            http</span><br><span class="line">        option          httplog</span><br><span class="line">        option          dontlognull</span><br><span class="line">        option          forwardfor</span><br><span class="line">        option          abortonclose</span><br><span class="line">        retries         3</span><br><span class="line">        maxconn         3000</span><br><span class="line">        stats           enable</span><br><span class="line">        stats           hide-version</span><br><span class="line">        stats   uri     /admin</span><br><span class="line">        stats   auth    admin:admin</span><br><span class="line">        stats   refresh 10s</span><br><span class="line">        balance         roundrobin</span><br><span class="line">        timeout connect 5000ms</span><br><span class="line">        timeout client 50000ms</span><br><span class="line">        timeout server 50000ms</span><br><span class="line">        timeout check 2000ms</span><br><span class="line">listen web_haproxy</span><br><span class="line">        bind 0.0.0.0:8080</span><br><span class="line">        mode http</span><br><span class="line">        log     127.0.0.1 local5 err</span><br><span class="line">        stats   refresh 5s</span><br><span class="line">        stats   uri /admin</span><br><span class="line">        stats   realm liang lian</span><br><span class="line">        stats   auth admin:admin</span><br><span class="line">        stats   hide-version</span><br><span class="line">        stats   admin if TRUE</span><br><span class="line">frontend consul</span><br><span class="line">        bind    0.0.0.0:8500</span><br><span class="line">        mode    http</span><br><span class="line">        log     global</span><br><span class="line">        default_backend consul-cluster</span><br><span class="line">backend consul-cluster</span><br><span class="line">        mode http</span><br><span class="line">        server Faceid 10.201.102.198:9000 check inter 5000 fall 1 rise 2 weight 2</span><br><span class="line">        server Faceid 10.201.102.199:9000 check inter 5000 fall 1 rise 2 weight 2</span><br><span class="line">        server Faceid 10.201.102.200:9000 check inter 5000 fall 1 rise 2 weight 21234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950</span><br></pre></td></tr></table></figure>

<p>æ•´ä¸ªå°±æ˜¯æ­å»ºconsulé›†ç¾¤ï¼Œå¹³å°ä¸­çš„æœåŠ¡ä¼šæ³¨å†Œåˆ°consulé›†ç¾¤ä¸­ï¼Œhaproxyé¿å…consul-templateè°ƒconsulæ—¶å‡ºç°å•ç‚¹æ•…éšœconsul-templateæ— æ³•å·¥ä½œåšçš„é«˜å¯ç”¨ï¼ŒConsul-templateå°±æ˜¯èƒ½åœ¨æ•´ä¸ªå¹³å°çš„å„ä¸ªç³»ç»Ÿå’Œåº”ç”¨ä¸­ä½¿ç”¨ï¼ŒæŸ¥è¯¢consulé›†ç¾¤æ¥è·å–å¹³å°ä¸Šå„ä¸ªåº”ç”¨çš„å­˜æ´»çŠ¶æ€å’ŒIPã€‚</p>
<p>æ•´å¥—ä¸‹æ¥å®ç°äº†ä¸¤ä¸ªé‡ç‚¹ï¼š</p>
<p>å®ç°äº†ä¸­å¿ƒæœåŠ¡æ³¨å†ŒæŸ¥è¯¢<br>å¹³å°ä¸­å…¶ä»–èŠ‚ç‚¹çš„æŸ¥è¯¢æœåŠ¡å’Œé…ç½®æ–‡ä»¶è‡ªåŠ¨æ›´æ–°</p>
<h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><p><a target="_blank" rel="noopener" href="https://my.oschina.net/guol/blog/675281">https://my.oschina.net/guol/blog/675281</a> </p>
<p><a target="_blank" rel="noopener" href="https://www.consul.io/docs/guides/index.html">https://www.consul.io/docs/guides/index.html</a> </p>
<p><a target="_blank" rel="noopener" href="https://www.gitbook.com/book/vincentmi/consul-guide/details">https://www.gitbook.com/book/vincentmi/consul-guide/details</a></p>
<p><a target="_blank" rel="noopener" href="https://my.oschina.net/abcfy2/blog/675665">https://my.oschina.net/abcfy2/blog/675665</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="https://wangyyovo.github.io">Blank</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="https://wangyyovo.github.io/posts/6ab3229c/">https://wangyyovo.github.io/posts/6ab3229c/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥æº <a href="https://wangyyovo.github.io" target="_blank">Blank</a>ï¼</span></div></div><div class="tag_share"><div class="post-share"><div class="social-share" data-image="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/cover/consul/7d0e1704af4e9eed516ba20ec9133112.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://jsd.012700.xyz/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://jsd.012700.xyz/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/4a17b156/" title="Hello World"><img class="cover" src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/cover/other/729ec1c3071758c9cf65c190cf68801d.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">ä¸Šä¸€ç¯‡</div><div class="info-item-2">Hello World</div></div><div class="info-2"><div class="info-item-1"> Welcome to note   Welcome to Hexo! This is your very first post. Check documentation for more info. If you get any problems when using Hexo, you can find the answer in troubleshooting or you can ask me on GitHub. Quick StartCreate a new post1$ hexo new &quot;My New Post&quot;  More info: Writing Run server1$ hexo server  More info: Server Generate static files1$ hexo generate  More info: Generating Deploy to remote sites1$ hexo deploy  More info: Deployment </div></div></div></a><a class="pagination-related" href="/posts/bfc2ca32/" title="consul"><img class="cover" src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/cover/consul/19e8db84b9cccfc9a8f4636230c25cc6.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">ä¸‹ä¸€ç¯‡</div><div class="info-item-2">consul</div></div><div class="info-2"><div class="info-item-1"> Consulå¸¸ç”¨å‘½ä»¤ agent è¿è¡Œä¸€ä¸ªconsul agent consul agent -dev  join å°†agentåŠ å…¥åˆ°consulé›†ç¾¤ consul join IP  members åˆ—å‡ºconsul clusteré›†ç¾¤ä¸­çš„members consul members  leave å°†èŠ‚ç‚¹ç§»é™¤æ‰€åœ¨é›†ç¾¤ consul leave   Consul agent å‘½ä»¤è¯¦è§£è¾“å…¥consul agent --help ï¼Œå¯ä»¥çœ‹åˆ°consul agent çš„é€‰é¡¹ consul agent å‘½ä»¤çš„å¸¸ç”¨é€‰é¡¹ï¼Œå¦‚ä¸‹ï¼š  -data-dir ä½œç”¨ï¼šæŒ‡å®šagentå‚¨å­˜çŠ¶æ€çš„æ•°æ®ç›®å½• è¿™æ˜¯æ‰€æœ‰agentéƒ½å¿…é¡»çš„ å¯¹äºserverå°¤å…¶é‡è¦ï¼Œå› ä¸ºä»–ä»¬å¿…é¡»æŒä¹…åŒ–é›†ç¾¤çš„çŠ¶æ€   -config-dir ä½œç”¨ï¼šæŒ‡å®šserviceçš„é…ç½®æ–‡ä»¶å’Œæ£€æŸ¥å®šä¹‰æ‰€åœ¨çš„ä½ç½® é€šå¸¸ä¼šæŒ‡å®šä¸ºâ€æŸä¸€ä¸ªè·¯å¾„&#x2F;consul.dâ€ï¼ˆé€šå¸¸æƒ…å†µä¸‹ï¼Œ.dè¡¨ç¤ºä¸€ç³»åˆ—é…ç½®æ–‡ä»¶å­˜æ”¾çš„ç›®å½•ï¼‰   -config-file ä½œç”¨ï¼šæŒ‡å®šä¸€ä¸ªè¦è£…è½½çš„é…ç½®æ–‡ä»¶ è¯¥é€‰é¡¹å¯ä»¥é…ç½®å¤šæ¬¡ï¼Œè¿›è€Œé…ç½®å¤šä¸ªé…ç½®æ–‡ä»¶ï¼ˆåè¾¹çš„ä¼šåˆå¹¶å‰è¾¹çš„ï¼Œç›¸åŒçš„å€¼è¦†ç›–...</div></div></div></a></nav><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> è¯„è®º</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/theme/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Blank</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">352</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">46</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">58</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>ä¸»é¢˜ GitHub</span></a><div class="card-info-social-icons"><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fas fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>å…¬å‘Š</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#consul%E4%BD%BF%E7%94%A8%E6%89%8B%E5%86%8C"><span class="toc-number">1.</span> <span class="toc-text">consulä½¿ç”¨æ‰‹å†Œ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.1.</span> <span class="toc-text">ä»‹ç»</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E6%9E%B6%E6%9E%84"><span class="toc-number">1.2.</span> <span class="toc-text">åŸºç¡€æ¶æ„</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85Consul"><span class="toc-number">1.3.</span> <span class="toc-text">å®‰è£…Consul</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E5%AE%89%E8%A3%85"><span class="toc-number">1.4.</span> <span class="toc-text">éªŒè¯å®‰è£…</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%90%E8%A1%8CAgent"><span class="toc-number">1.5.</span> <span class="toc-text">è¿è¡ŒAgent</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8-Consul-Server"><span class="toc-number">1.6.</span> <span class="toc-text">å¯åŠ¨ Consul Server</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8-Consul-Client"><span class="toc-number">1.7.</span> <span class="toc-text">å¯åŠ¨ Consul Client</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%81%9C%E6%AD%A2Agent"><span class="toc-number">1.8.</span> <span class="toc-text">åœæ­¢Agent</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.9.</span> <span class="toc-text">æ›´æ–°æœåŠ¡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.10.</span> <span class="toc-text">æŸ¥è¯¢æœåŠ¡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#WEB%E7%AE%A1%E7%90%86%E7%95%8C%E9%9D%A2"><span class="toc-number">1.11.</span> <span class="toc-text">WEBç®¡ç†ç•Œé¢</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5"><span class="toc-number">1.12.</span> <span class="toc-text">å¥åº·æ£€æŸ¥</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E5%81%A5%E5%BA%B7%E7%8A%B6%E6%80%81"><span class="toc-number">1.13.</span> <span class="toc-text">æ£€æŸ¥å¥åº·çŠ¶æ€</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#K-%EF%BC%8FV"><span class="toc-number">1.14.</span> <span class="toc-text">K ï¼V</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Conusl-%E5%91%BD%E4%BB%A4%E8%A1%8C"><span class="toc-number">2.</span> <span class="toc-text">Conusl å‘½ä»¤è¡Œ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Agent"><span class="toc-number">2.1.</span> <span class="toc-text">Agent</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#event"><span class="toc-number">2.2.</span> <span class="toc-text">event</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exec"><span class="toc-number">2.3.</span> <span class="toc-text">exec</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#force-leave"><span class="toc-number">2.4.</span> <span class="toc-text">force-leave</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#info"><span class="toc-number">2.5.</span> <span class="toc-text">info</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#join"><span class="toc-number">2.6.</span> <span class="toc-text">join</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#keygen"><span class="toc-number">2.7.</span> <span class="toc-text">keygen</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#leave"><span class="toc-number">2.8.</span> <span class="toc-text">leave</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#members"><span class="toc-number">2.9.</span> <span class="toc-text">members</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#monitor"><span class="toc-number">2.10.</span> <span class="toc-text">monitor</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#reload"><span class="toc-number">2.11.</span> <span class="toc-text">reload</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#version"><span class="toc-number">2.12.</span> <span class="toc-text">version</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#watch"><span class="toc-number">2.13.</span> <span class="toc-text">watch</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Consul-%E9%85%8D%E7%BD%AE"><span class="toc-number">3.</span> <span class="toc-text">Consul é…ç½®</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#HTTP-API"><span class="toc-number">4.</span> <span class="toc-text">HTTP API</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#agent"><span class="toc-number">4.1.</span> <span class="toc-text">agent</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#catalog"><span class="toc-number">4.2.</span> <span class="toc-text">catalog</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#health"><span class="toc-number">4.3.</span> <span class="toc-text">health</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#session"><span class="toc-number">4.4.</span> <span class="toc-text">session</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#acl"><span class="toc-number">4.5.</span> <span class="toc-text">acl</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#event-1"><span class="toc-number">4.6.</span> <span class="toc-text">event</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#status"><span class="toc-number">4.7.</span> <span class="toc-text">status</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Consul-Template"><span class="toc-number">5.</span> <span class="toc-text">Consul-Template</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-number">5.1.</span> <span class="toc-text">å®‰è£…</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8"><span class="toc-number">5.2.</span> <span class="toc-text">ä½¿ç”¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E8%A1%8C"><span class="toc-number">5.3.</span> <span class="toc-text">å‘½ä»¤è¡Œ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%A1%E7%89%88%E8%AF%AD%E6%B3%95"><span class="toc-number">5.4.</span> <span class="toc-text">æ¨¡ç‰ˆè¯­æ³•</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#API-%E5%87%BD%E6%95%B0"><span class="toc-number">5.5.</span> <span class="toc-text">API å‡½æ•°</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Haproxy-%E5%AE%9E%E4%BE%8B"><span class="toc-number">5.6.</span> <span class="toc-text">Haproxy å®ä¾‹</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">6.</span> <span class="toc-text">å‚è€ƒèµ„æ–™</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>æœ€æ–°æ–‡ç« </span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/d14168d/" title="è™šæ‹Ÿæœºé—®é¢˜åˆé›†"><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/cover/hexo/090cfe4e9e60b0ad0de05db822f3ae97.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="è™šæ‹Ÿæœºé—®é¢˜åˆé›†"/></a><div class="content"><a class="title" href="/posts/d14168d/" title="è™šæ‹Ÿæœºé—®é¢˜åˆé›†">è™šæ‹Ÿæœºé—®é¢˜åˆé›†</a><time datetime="2022-07-16T13:30:36.000Z" title="å‘è¡¨äº 2022-07-16 21:30:36">2022-07-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/f540045f/" title="ç”¨goè¯­è¨€ç¼–å†™ç§»åŠ¨ç«¯sdkå’Œappå¼€å‘"><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/cover/golang/941ed1ec2925719a0c92e76f4f786b6a.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ç”¨goè¯­è¨€ç¼–å†™ç§»åŠ¨ç«¯sdkå’Œappå¼€å‘"/></a><div class="content"><a class="title" href="/posts/f540045f/" title="ç”¨goè¯­è¨€ç¼–å†™ç§»åŠ¨ç«¯sdkå’Œappå¼€å‘">ç”¨goè¯­è¨€ç¼–å†™ç§»åŠ¨ç«¯sdkå’Œappå¼€å‘</a><time datetime="2022-07-04T12:14:21.000Z" title="å‘è¡¨äº 2022-07-04 20:14:21">2022-07-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/5faac006/" title="åœ¨çº¿ç¼–ç¨‹IDE"><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/cover/hexo/090cfe4e9e60b0ad0de05db822f3ae97.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="åœ¨çº¿ç¼–ç¨‹IDE"/></a><div class="content"><a class="title" href="/posts/5faac006/" title="åœ¨çº¿ç¼–ç¨‹IDE">åœ¨çº¿ç¼–ç¨‹IDE</a><time datetime="2022-06-12T13:30:36.000Z" title="å‘è¡¨äº 2022-06-12 21:30:36">2022-06-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/7594185d/" title="å³æ—¶æ€§èƒ½åˆ†æå·¥å…·Pyroscope"><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/cover/golang/3bfb3279740bc9a5b5ef436fa887ef07.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="å³æ—¶æ€§èƒ½åˆ†æå·¥å…·Pyroscope"/></a><div class="content"><a class="title" href="/posts/7594185d/" title="å³æ—¶æ€§èƒ½åˆ†æå·¥å…·Pyroscope">å³æ—¶æ€§èƒ½åˆ†æå·¥å…·Pyroscope</a><time datetime="2022-06-12T08:07:36.000Z" title="å‘è¡¨äº 2022-06-12 16:07:36">2022-06-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/82a7aa7c/" title="golangæ€§èƒ½è°ƒè¯•ä¼˜åŒ–æ–¹æ³•"><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/cover/common/3.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="golangæ€§èƒ½è°ƒè¯•ä¼˜åŒ–æ–¹æ³•"/></a><div class="content"><a class="title" href="/posts/82a7aa7c/" title="golangæ€§èƒ½è°ƒè¯•ä¼˜åŒ–æ–¹æ³•">golangæ€§èƒ½è°ƒè¯•ä¼˜åŒ–æ–¹æ³•</a><time datetime="2022-06-12T03:00:36.000Z" title="å‘è¡¨äº 2022-06-12 11:00:36">2022-06-12</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 By Blank</span><span class="framework-info"><span>æ¡†æ¶ </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 5.4.2</a><span class="footer-separator">|</span><span>ä¸»é¢˜ </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.4.3</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="æ—¥é—´å’Œå¤œé—´æ¨¡å¼åˆ‡æ¢"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="è®¾ç½®"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><button id="translateLink" type="button" title="ç®€ç¹è½¬æ¢">ç¹</button><a id="to_comment" href="#post-comment" title="å‰å¾€è¯„è®º"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://jsd.012700.xyz/npm/hexo-theme-butterfly/source/js/utils.min.js"></script><script src="https://jsd.012700.xyz/npm/hexo-theme-butterfly/source/js/main.min.js"></script><script src="https://jsd.012700.xyz/npm/hexo-theme-butterfly/source/js/tw_cn.min.js"></script><div class="js-pjax"><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = {"placeholder":"è¯·ç•™ä¸‹ä½ çš„è„šå°","pageSize":10,"lang":"zh-CN","requiredFields":["nick","mail","link"]}

  const initValine = (el, path) => {
    if (isShuoshuo) {
      window.shuoshuoComment.destroyValine = () => {
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }

    const valineConfig = {
      el: '#vcomment',
      appId: 'BSfgwCPLOvPHVPaSoBCGSENf-MdYXbMMI',
      appKey: '2Q8qq5060qxycL6FPL26LnMG',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      visitor: false,
      ...option,
      path: isShuoshuo ? path : (option && option.path) || window.location.pathname
    }

    new Valine(valineConfig)
  }

  const loadValine = async (el, path) => {
    if (typeof Valine === 'function') {
      initValine(el, path)
    } else {
      await btf.getScript('https://jsd.012700.xyz/npm/valine/dist/Valine.min.js')
      initValine(el, path)
    }
  }

  if (isShuoshuo) {
    'Valine' === 'Valine'
      ? window.shuoshuoComment = { loadComment: loadValine }
      : window.loadOtherComment = loadValine
    return
  }

  if ('Valine' === 'Valine' || !false) {
    if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">æœç´¢</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  æ•°æ®åŠ è½½ä¸­</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="æœç´¢æ–‡ç« " type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="https://jsd.012700.xyz/npm/hexo-theme-butterfly/source/js/search/local-search.min.js"></script></div></div></body></html>