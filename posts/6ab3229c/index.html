<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>consul使用手册 | Blank</title><meta name="author" content="Blank"><meta name="copyright" content="Blank"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="consul使用手册介绍Consul包含多个组件,但是作为一个整体,为你的基础设施提供服务发现和服务配置的工具.他提供以下关键特性: 服务发现 Consul的客户端可用提供一个服务,比如 api 或者mysql ,另外一些客户端可用使用Consul去发现一个指定服务的提供者.通过DNS或者HTTP应用程序可用很容易的找到他所依赖的服务.健康检查 Consul客户端可用提供任意数量的健康检查,指定">
<meta property="og:type" content="article">
<meta property="og:title" content="consul使用手册">
<meta property="og:url" content="https://wangyyovo.github.io/posts/6ab3229c/">
<meta property="og:site_name" content="Blank">
<meta property="og:description" content="consul使用手册介绍Consul包含多个组件,但是作为一个整体,为你的基础设施提供服务发现和服务配置的工具.他提供以下关键特性: 服务发现 Consul的客户端可用提供一个服务,比如 api 或者mysql ,另外一些客户端可用使用Consul去发现一个指定服务的提供者.通过DNS或者HTTP应用程序可用很容易的找到他所依赖的服务.健康检查 Consul客户端可用提供任意数量的健康检查,指定">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/cover/consul/7d0e1704af4e9eed516ba20ec9133112.jpg">
<meta property="article:published_time" content="2019-09-22T03:26:39.000Z">
<meta property="article:modified_time" content="2019-09-22T03:26:39.000Z">
<meta property="article:author" content="Blank">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/cover/consul/7d0e1704af4e9eed516ba20ec9133112.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "consul使用手册",
  "url": "https://wangyyovo.github.io/posts/6ab3229c/",
  "image": "https://jsd.012700.xyz/gh/wangyyovo/CDN@master/cover/consul/7d0e1704af4e9eed516ba20ec9133112.jpg",
  "datePublished": "2019-09-22T03:26:39.000Z",
  "dateModified": "2019-09-22T03:26:39.000Z",
  "author": [
    {
      "@type": "Person",
      "name": "Blank",
      "url": "https://wangyyovo.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/theme/favicon.ico"><link rel="canonical" href="https://wangyyovo.github.io/posts/6ab3229c/"><link rel="preconnect" href="https://jsd.012700.xyz"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://jsd.012700.xyz/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":400,"highlightFullpage":true,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":150,"languages":{"author":"作者: Blank","link":"链接: ","source":"来源: Blank","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://jsd.012700.xyz/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'consul使用手册',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="alternate" href="/atom.xml" title="Blank" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/theme/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">352</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">46</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">58</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fas fa-comment-dots"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 娱乐</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-image"></i><span> 相册</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-book"></i><span> 教程</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/posts/21cfbf15/"><span> 🚀 快速開始</span></a></li><li><a class="site-page child" href="/posts/dc584b87/"><span> 📑 主題頁面</span></a></li><li><a class="site-page child" href="/posts/4aa8abbe/"><span> 🛠 主題配置</span></a></li><li><a class="site-page child" href="/posts/ceeb73f/"><span> ⚔️ 標簽外挂</span></a></li><li><a class="site-page child" href="/posts/98d20436/"><span> ❓ 主題問答</span></a></li><li><a class="site-page child" href="/posts/4073eda/"><span> ⚡️ 進階教程</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-language"></i><span> 语言</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/"><i class="fa-fw fas fa-c"></i><span> 中文</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://jsd.012700.xyz/gh/wangyyovo/CDN@master/cover/consul/7d0e1704af4e9eed516ba20ec9133112.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Blank</span></a><a class="nav-page-title" href="/"><span class="site-name">consul使用手册</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fas fa-comment-dots"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 娱乐</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-image"></i><span> 相册</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-book"></i><span> 教程</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/posts/21cfbf15/"><span> 🚀 快速開始</span></a></li><li><a class="site-page child" href="/posts/dc584b87/"><span> 📑 主題頁面</span></a></li><li><a class="site-page child" href="/posts/4aa8abbe/"><span> 🛠 主題配置</span></a></li><li><a class="site-page child" href="/posts/ceeb73f/"><span> ⚔️ 標簽外挂</span></a></li><li><a class="site-page child" href="/posts/98d20436/"><span> ❓ 主題問答</span></a></li><li><a class="site-page child" href="/posts/4073eda/"><span> ⚡️ 進階教程</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-language"></i><span> 语言</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/"><i class="fa-fw fas fa-c"></i><span> 中文</span></a></li></ul></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">consul使用手册</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2019-09-22T03:26:39.000Z" title="发表于 2019-09-22 11:26:39">2019-09-22</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2019-09-22T03:26:39.000Z" title="更新于 2019-09-22 11:26:39">2019-09-22</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/microservice/">microservice</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/microservice/consul/">consul</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">18.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>79分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/posts/6ab3229c/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count" data-xid="/posts/6ab3229c/" itemprop="commentCount"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><script src="\assets\js\APlayer.min.js"> </script><h1 id="consul使用手册"><a href="#consul使用手册" class="headerlink" title="consul使用手册"></a>consul使用手册</h1><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>Consul包含多个组件,但是作为一个整体,为你的基础设施提供服务发现和服务配置的工具.他提供以下关键特性:</p>
<p><strong>服务发现</strong> Consul的客户端可用提供一个服务,比如 api 或者mysql ,另外一些客户端可用使用Consul去发现一个指定服务的提供者.通过DNS或者HTTP应用程序可用很容易的找到他所依赖的服务.<br><strong>健康检查</strong> Consul客户端可用提供任意数量的健康检查,指定一个服务(比如:webserver是否返回了200  OK 状态码)或者使用本地节点(比如:内存使用是否大于90%).  这个信息可由operator用来监视集群的健康.被服务发现组件用来避免将流量发送到不健康的主机.<br><strong>Key&#x2F;Value存储</strong> 应用程序可用根据自己的需要使用Consul的层级的Key&#x2F;Value存储.比如动态配置,功能标记,协调,领袖选举等等,简单的HTTP API让他更易于使用.<br><strong>多数据中心</strong> Consul支持开箱即用的多数据中心.这意味着用户不需要担心需要建立额外的抽象层让业务扩展到多个区域.<br> Consul面向DevOps和应用开发者友好.是他适合现代的弹性的基础设施.  <img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/blog/consul-manual/cluster.jpg" alt="consul-cluster"></p>
<h2 id="基础架构"><a href="#基础架构" class="headerlink" title="基础架构"></a>基础架构</h2><p>Consul是一个分布式高可用的系统. 这节将包含一些基础,我们忽略掉一些细节这样你可以快速了解Consul是如何工作的.如果要了解更多细节,请参考深入的架构描述.</p>
<p>每个提供服务给Consul的阶段都运行了一个Consul agent . 发现服务或者设置和获取 key&#x2F;value存储的数据不是必须运行agent.这个agent是负责对节点自身和节点上的服务进行健康检查的.</p>
<p>Agent与一个和多个Consul Server 进行交互.Consul Server  用于存放和复制数据.server自行选举一个领袖.虽然Consul可以运行在一台server ,  但是建议使用3到5台来避免失败情况下数据的丢失.每个数据中心建议配置一个server集群.</p>
<p>你基础设施中需要发现其他服务的组件可以查询任何一个Consul 的server或者 agent.Agent会自动转发请求到server .</p>
<p>每个数据中运行了一个Consul server集群.当一个跨数据中心的服务发现和配置请求创建时.本地Consul Server转发请求到远程的数据中心并返回结果.</p>
<p>更多介绍查看官网<a target="_blank" rel="noopener" href="https://www.consul.io/">点击前往</a></p>
<h2 id="安装Consul"><a href="#安装Consul" class="headerlink" title="安装Consul"></a>安装Consul</h2><p>安装Consul,找到适合你系统的包下载他.Consul打包为一个’Zip’文件.<a target="_blank" rel="noopener" href="https://www.consul.io/downloads.html">前往下载</a></p>
<p>下载后解开压缩包.拷贝Consul到你的PATH路径中,在Unix系统中<code>~/bin</code>和<code>/usr/local/bin</code>是通常的安装目录.根据你是想为单个用户安装还是给整个系统安装来选择.在Windows系统中有可以安装到<code>%PATH%</code>的路径中.</p>
<h2 id="验证安装"><a href="#验证安装" class="headerlink" title="验证安装"></a>验证安装</h2><p>完成安装后,通过打开一个新终端窗口检查<code>consul</code>安装是否成功.通过执行 <code>consul</code>你应该看到类似下面的输出</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@dhcp-10-201-102-248 ~]# consul</span><br><span class="line">usage: consul [--version] [--help] &lt;command&gt; [&lt;args&gt;]</span><br><span class="line">Available commands are:</span><br><span class="line">    agent          Runs a Consul agent</span><br><span class="line">    configtest     Validate config file</span><br><span class="line">    event          Fire a new event</span><br><span class="line">    exec           Executes a command on Consul nodes</span><br><span class="line">    force-leave    Forces a member of the cluster to enter the &quot;left&quot; state</span><br><span class="line">    info           Provides debugging information for operators</span><br><span class="line">    join           Tell Consul agent to join cluster</span><br><span class="line">    keygen         Generates a new encryption key</span><br><span class="line">    keyring        Manages gossip layer encryption keys</span><br><span class="line">    kv             Interact with the key-value store</span><br><span class="line">    leave          Gracefully leaves the Consul cluster and shuts down</span><br><span class="line">    lock           Execute a command holding a lock</span><br><span class="line">    maint          Controls node or service maintenance mode</span><br><span class="line">    members        Lists the members of a Consul cluster</span><br><span class="line">    monitor        Stream logs from a Consul agent</span><br><span class="line">    operator       Provides cluster-level tools for Consul operators</span><br><span class="line">    reload         Triggers the agent to reload configuration files</span><br><span class="line">    rtt            Estimates network round trip time between nodes</span><br><span class="line">    snapshot       Saves, restores and inspects snapshots of Consul server state</span><br><span class="line">    version        Prints the Consul version</span><br><span class="line">    watch          Watch for changes in Consul123456789101112131415161718192021222324</span><br></pre></td></tr></table></figure>

<p>如果你得到一个<code>consul not be found</code>的错误,你的<code>PATH</code>可能没有正确设置.请返回检查你的consul的安装路径是否包含在<code>PATH</code>中.</p>
<h2 id="运行Agent"><a href="#运行Agent" class="headerlink" title="运行Agent"></a>运行Agent</h2><p>完成Consul的安装后,必须运行agent. agent可以运行为<code>server</code>或<code>client</code>模式.每个数据中心至少必须拥有一台server . 建议在一个集群中有3或者5个server.部署单一的server,在出现失败时会不可避免的造成数据丢失.</p>
<p>其他的agent运行为client模式.一个client是一个非常轻量级的进程.用于注册服务,运行健康检查和转发对server的查询.agent必须在集群中的每个主机上运行.</p>
<p>查看启动数据中心的细节请查看<a target="_blank" rel="noopener" href="https://www.consul.io/docs/guides/bootstrapping.html">这里</a>.</p>
<h2 id="启动-Consul-Server"><a href="#启动-Consul-Server" class="headerlink" title="启动 Consul Server"></a>启动 Consul Server</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consul agent -server -bootstrap-expect 3 -data-dir /tmp/consul -node=s1 -bind=10.201.102.198 -ui-dir ./consul_ui/ -rejoin -config-dir=/etc/consul.d/ -client 0.0.0.01</span><br></pre></td></tr></table></figure>

<p>运行cosnul agent以<code>server</code>模式，</p>
<ul>
<li><code>-server</code> ： 定义agent运行在server模式</li>
<li><code>-bootstrap-expect</code> ：在一个datacenter中期望提供的server节点数目，当该值提供的时候，consul一直等到达到指定sever数目的时候才会引导整个集群，该标记不能和bootstrap共用</li>
<li><code>-bind</code>：该地址用来在集群内部的通讯，集群内的所有节点到地址都必须是可达的，默认是0.0.0.0</li>
<li><code>-node</code>：节点在集群中的名称，在一个集群中必须是唯一的，默认是该节点的主机名</li>
<li><code>-ui-dir</code>： 提供存放web ui资源的路径，该目录必须是可读的</li>
<li><code>-rejoin</code>：使consul忽略先前的离开，在再次启动后仍旧尝试加入集群中。</li>
<li><code>-config-dir</code>：配置文件目录，里面所有以.json结尾的文件都会被加载</li>
<li><code>-client</code>：consul服务侦听地址，这个地址提供HTTP、DNS、RPC等服务，默认是127.0.0.1所以不对外提供服务，如果你要对外提供服务改成0.0.0.0</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@dhcp-10-201-102-198 consul]# consul agent -server -bootstrap-expect 1 -data-dir /tmp/consul -node=s1 -bind=10.201.102.198 -ui-dir ./consul_ui/ -rejoin -config-dir=/etc/consul.d/ -client 0.0.0.0</span><br><span class="line">==&gt; WARNING: Expect Mode enabled, expecting 3 servers</span><br><span class="line">==&gt; Starting Consul agent...</span><br><span class="line">==&gt; Starting Consul agent RPC...</span><br><span class="line">==&gt; Consul agent running!</span><br><span class="line">           Version: &#x27;v0.7.4&#x27;</span><br><span class="line">           Node ID: &#x27;422ec677-74ef-8f29-2f22-01effeed6334&#x27;</span><br><span class="line">         Node name: &#x27;s1&#x27;</span><br><span class="line">        Datacenter: &#x27;dc1&#x27;</span><br><span class="line">            Server: true (bootstrap: false)</span><br><span class="line">       Client Addr: 0.0.0.0 (HTTP: 8500, HTTPS: -1, DNS: 8600, RPC: 8400)</span><br><span class="line">      Cluster Addr: 10.201.102.198 (LAN: 8301, WAN: 8302)</span><br><span class="line">    Gossip encrypt: false, RPC-TLS: false, TLS-Incoming: false</span><br><span class="line">             Atlas: &lt;disabled&gt;</span><br><span class="line">==&gt; Log data will now stream in as it occurs:</span><br><span class="line">    2017/03/17 18:03:08 [INFO] raft: Restored from snapshot 139-352267-1489707086023</span><br><span class="line">    2017/03/17 18:03:08 [INFO] raft: Initial configuration (index=6982): [&#123;Suffrage:Voter ID:10.201.102.199:8300 Address:10.201.102.199:8300&#125; &#123;Suffrage:Voter ID:10.201.102.200:8300 Address:10.201.102.200:8300&#125; &#123;Suffrage:Voter ID:10.201.102.198:8300 Address:10.201.102.198:8300&#125;]</span><br><span class="line">    2017/03/17 18:03:08 [INFO] raft: Node at 10.201.102.198:8300 [Follower] entering Follower state (Leader: &quot;&quot;)</span><br><span class="line">    2017/03/17 18:03:08 [INFO] serf: EventMemberJoin: s1 10.201.102.198</span><br><span class="line">    2017/03/17 18:03:08 [INFO] serf: Attempting re-join to previously known node: s2: 10.201.102.199:8301</span><br><span class="line">    2017/03/17 18:03:08 [INFO] consul: Adding LAN server s1 (Addr: tcp/10.201.102.198:8300) (DC: dc1)</span><br><span class="line">    2017/03/17 18:03:08 [INFO] consul: Raft data found, disabling bootstrap mode</span><br><span class="line">    2017/03/17 18:03:08 [INFO] serf: EventMemberJoin: s2 10.201.102.199</span><br><span class="line">    2017/03/17 18:03:08 [INFO] serf: EventMemberJoin: s3 10.201.102.200</span><br><span class="line">    2017/03/17 18:03:08 [INFO] serf: Re-joined to previously known node: s2: 10.201.102.199:8301</span><br><span class="line">    2017/03/17 18:03:08 [INFO] consul: Adding LAN server s2 (Addr: tcp/10.201.102.199:8300) (DC: dc1)</span><br><span class="line">    2017/03/17 18:03:08 [INFO] consul: Adding LAN server s3 (Addr: tcp/10.201.102.200:8300) (DC: dc1)</span><br><span class="line">    2017/03/17 18:03:08 [INFO] serf: EventMemberJoin: s1.dc1 10.201.102.198</span><br><span class="line">    2017/03/17 18:03:08 [INFO] consul: Adding WAN server s1.dc1 (Addr: tcp/10.201.102.198:8300) (DC: dc1)</span><br><span class="line">    2017/03/17 18:03:08 [WARN] serf: Failed to re-join any previously known node</span><br><span class="line">    2017/03/17 18:03:14 [INFO] agent: Synced service &#x27;consul&#x27;</span><br><span class="line">    2017/03/17 18:03:14 [INFO] agent: Deregistered service &#x27;consul01&#x27;</span><br><span class="line">    2017/03/17 18:03:14 [INFO] agent: Deregistered service &#x27;consul02&#x27;</span><br><span class="line">    2017/03/17 18:03:14 [INFO] agent: Deregistered service &#x27;consul03&#x27;12345678910111213141516171819202122232425262728293031323334</span><br></pre></td></tr></table></figure>

<p><strong>查看集群成员</strong><br> 新开一个终端窗口运行<code>consul members</code>, 你可以看到Consul集群的成员.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@dhcp-10-201-102-198 ~]# consul members</span><br><span class="line">Node  Address              Status  Type    Build  Protocol  DC</span><br><span class="line">s1    10.201.102.198:8301  alive   server  0.7.4  2         dc1</span><br><span class="line">s2    10.201.102.199:8301  alive   server  0.7.4  2         dc1</span><br><span class="line">s3    10.201.102.200:8301  alive   server  0.7.4  2         dc112345</span><br></pre></td></tr></table></figure>

<h2 id="启动-Consul-Client"><a href="#启动-Consul-Client" class="headerlink" title="启动 Consul Client"></a>启动 Consul Client</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consul agent -data-dir /tmp/consul -node=c1 -bind=10.201.102.248 -config-dir=/etc/consul.d/ -join 10.201.102.1981</span><br></pre></td></tr></table></figure>

<p>运行cosnul agent以client模式，<code>-join</code> 加入到已有的集群中去。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@dhcp-10-201-102-248 ~]# consul agent -data-dir /tmp/consul -node=c1 -bind=10.201.102.248 -config-dir=/etc/consul.d/ -join 10.201.102.198</span><br><span class="line">==&gt; Starting Consul agent...</span><br><span class="line">==&gt; Starting Consul agent RPC...</span><br><span class="line">==&gt; Joining cluster...</span><br><span class="line">    Join completed. Synced with 1 initial agents</span><br><span class="line">==&gt; Consul agent running!</span><br><span class="line">           Version: &#x27;v0.7.4&#x27;</span><br><span class="line">           Node ID: &#x27;564dc0c7-7f4f-7402-a301-cebe7f024294&#x27;</span><br><span class="line">         Node name: &#x27;c1&#x27;</span><br><span class="line">        Datacenter: &#x27;dc1&#x27;</span><br><span class="line">            Server: false (bootstrap: false)</span><br><span class="line">       Client Addr: 127.0.0.1 (HTTP: 8500, HTTPS: -1, DNS: 8600, RPC: 8400)</span><br><span class="line">      Cluster Addr: 10.201.102.248 (LAN: 8301, WAN: 8302)</span><br><span class="line">    Gossip encrypt: false, RPC-TLS: false, TLS-Incoming: false</span><br><span class="line">             Atlas: &lt;disabled&gt;</span><br><span class="line">==&gt; Log data will now stream in as it occurs:</span><br><span class="line">    2017/03/17 15:35:16 [INFO] serf: EventMemberJoin: c1 10.201.102.248</span><br><span class="line">    2017/03/17 15:35:16 [INFO] agent: (LAN) joining: [10.201.102.198]</span><br><span class="line">    2017/03/17 15:35:16 [INFO] serf: EventMemberJoin: s2 10.201.102.199</span><br><span class="line">    2017/03/17 15:35:16 [INFO] serf: EventMemberJoin: s3 10.201.102.200</span><br><span class="line">    2017/03/17 15:35:16 [INFO] serf: EventMemberJoin: s1 10.201.102.198</span><br><span class="line">    2017/03/17 15:35:16 [INFO] agent: (LAN) joined: 1 Err: &lt;nil&gt;</span><br><span class="line">    2017/03/17 15:35:16 [INFO] consul: adding server s2 (Addr: tcp/10.201.102.199:8300) (DC: dc1)</span><br><span class="line">    2017/03/17 15:35:16 [INFO] consul: adding server s3 (Addr: tcp/10.201.102.200:8300) (DC: dc1)</span><br><span class="line">    2017/03/17 15:35:16 [INFO] consul: adding server s1 (Addr: tcp/10.201.102.198:8300) (DC: dc1)</span><br><span class="line">    2017/03/17 15:35:16 [INFO] agent: Synced node info1234567891011121314151617181920212223242526</span><br></pre></td></tr></table></figure>

<p><strong>查看集群成员</strong><br> 新开一个终端窗口运行<code>consul members</code>, 你可以看到Consul集群的成员.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@dhcp-10-201-102-248 ~]# consul members</span><br><span class="line">Node  Address              Status  Type    Build  Protocol  DC</span><br><span class="line">c1    10.201.102.248:8301  alive   client  0.7.4  2         dc1</span><br><span class="line">s1    10.201.102.198:8301  alive   server  0.7.4  2         dc1</span><br><span class="line">s2    10.201.102.199:8301  alive   server  0.7.4  2         dc1</span><br><span class="line">s3    10.201.102.200:8301  alive   server  0.7.4  2         dc1123456</span><br></pre></td></tr></table></figure>

<p><strong>加入集群</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@dhcp-10-201-102-248 ~]# consul join 10.201.102.198</span><br><span class="line">Node  Address              Status  Type    Build  Protocol  DC</span><br><span class="line">c1    10.201.102.248:8301  alive   client  0.7.4  2         dc1</span><br><span class="line">s1    10.201.102.198:8301  alive   server  0.7.4  2         dc1</span><br><span class="line">s2    10.201.102.199:8301  alive   server  0.7.4  2         dc1</span><br><span class="line">s3    10.201.102.200:8301  alive   server  0.7.4  2         dc1123456</span><br></pre></td></tr></table></figure>

<h2 id="停止Agent"><a href="#停止Agent" class="headerlink" title="停止Agent"></a>停止Agent</h2><p>你可以使用<code>Ctrl-C</code> 优雅的关闭Agent. 中断Agent之后你可以看到他离开了集群并关闭.</p>
<p>在退出中,Consul提醒其他集群成员,这个节点离开了.如果你强行杀掉进程.集群的其他成员应该能检测到这个节点失效了.当一个成员离开,他的服务和检测也会从目录中移除.当一个成员失效了,他的健康状况被简单的标记为危险,但是不会从目录中移除.Consul会自动尝试对失效的节点进行重连.允许他从某些网络条件下恢复过来.离开的节点则不会再继续联系.</p>
<p>此外,如果一个agent作为一个服务器,一个优雅的离开是很重要的,可以避免引起潜在的可用性故障影响达成<a target="_blank" rel="noopener" href="https://www.consul.io/docs/internals/consensus.html">一致性协议</a>.</p>
<p>查看<a target="_blank" rel="noopener" href="https://www.consul.io/docs/internals/consensus.html">这里</a>了解添加和移除server.</p>
<h2 id="更新服务"><a href="#更新服务" class="headerlink" title="更新服务"></a>更新服务</h2><p>服务定义可以通过配置文件并发送<code>SIGHUP</code>给agent来进行更新.这样你可以让你在不关闭服务或者保持服务请求可用的情况下进行更新.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consul reload1</span><br></pre></td></tr></table></figure>

<p>另外 HTTP API可以用来动态的添加,移除和修改服务.</p>
<p>注册服务<br> 搭建好conusl集群后，用户或者程序就能到consul中去查询或者注册服务。可以通过提供服务定义文件或者调用HTTP API来注册一个服务.</p>
<p>首先,为Consul配置创建一个目录.Consul会载入配置文件夹里的所有配置文件.在Unix系统中通常类似 <code>/etc/consul.d</code> (.d 后缀意思是这个路径包含了一组配置文件).</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir /etc/consul.d1</span><br></pre></td></tr></table></figure>

<p>然后,我们将编写服务定义配置文件.假设我们有一个名叫web的服务运行在 80端口.另外,我们将给他设置一个标签.这样我们可以使用他作为额外的查询方式:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &#x27;&#123;&quot;service&quot;: &#123;&quot;name&quot;: &quot;web&quot;, &quot;tags&quot;: [&quot;rails&quot;], &quot;port&quot;: 80&#125;&#125;&#x27; &gt;/etc/consul.d/web.json1</span><br></pre></td></tr></table></figure>

<p>现在重启agent , 设置配置目录:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">consul agent -server -bootstrap-expect 1 -data-dir /tmp/consul -node=s1 -<span class="built_in">bind</span>=10.201.102.198 -rejoin -config-dir=/etc/consul.d/ -client 0.0.0.0</span></span><br><span class="line">...</span><br><span class="line">    [INFO] agent: Synced service &#x27;web&#x27;</span><br><span class="line">...1234</span><br></pre></td></tr></table></figure>

<ul>
<li><code>-data-dir</code>：提供一个目录用来存放agent的状态，所有的agent允许都需要该目录，该目录必须是稳定的，系统重启后都继续存在<br> 你可能注意到了输出了 “synced” 了 web这个服务.意思是这个agent从配置文件中载入了服务定义,并且成功注册到服务目录.</li>
</ul>
<p>如果你想注册多个服务,你应该在Consul配置目录创建多个服务定义文件.</p>
<p>HTTP API注册服务,curl命令或者postman 以<code>PUT</code>方式请求consul HTTP API更多细节<a target="_blank" rel="noopener" href="https://www.consul.io/docs/agent/http/catalog.html#catalog_register">点击查看</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X PUT -d &#x27;&#123;&quot;Datacenter&quot;: &quot;dc1&quot;, &quot;Node&quot;: &quot;c2&quot;, &quot;Address&quot;: &quot;10.155.0.106&quot;, &quot;Service&quot;: &#123;&quot;Service&quot;: &quot;MAC&quot;, &quot;tags&quot;: [&quot;lianglian&quot;, &quot;Mac&quot;], &quot;Port&quot;: 22&#125;&#125;&#x27; http://127.0.0.1:8500/v1/catalog/register1</span><br></pre></td></tr></table></figure>

<h2 id="查询服务"><a href="#查询服务" class="headerlink" title="查询服务"></a>查询服务</h2><p>一旦agent启动并且服务同步了.我们可以通过DNS或者HTTP的API来查询服务.</p>
<p><strong>DNS API</strong><br> 让我们首先使用DNS API来查询.在DNS API中,服务的DNS名字是 <code>NAME.service.consul</code>. 虽然是可配置的,但默认的所有DNS名字会都在<code>consul</code>命名空间下.这个子域告诉Consul,我们在查询服务,<code>NAME</code>则是服务的名称.</p>
<p>对于我们上面注册的Web服务.它的域名是 <code>web.service.consul</code> :</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@dhcp-10-201-102-198 ~]# dig @127.0.0.1 -p 8600 web.service.consul</span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.8.2rc1-RedHat-9.8.2-0.17.rc1.el6 &lt;&lt;&gt;&gt; @127.0.0.1 -p 8600 web.service.consul</span><br><span class="line">; (1 server found)</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 39468</span><br><span class="line">;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0</span><br><span class="line">;; WARNING: recursion requested but not available</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;web.service.consul.            IN      A</span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">web.service.consul.     0       IN      A       10.201.102.198</span><br><span class="line">;; Query time: 0 msec</span><br><span class="line">;; SERVER: 127.0.0.1#8600(127.0.0.1)</span><br><span class="line">;; WHEN: Tue Mar 28 16:10:24 2017</span><br><span class="line">;; MSG SIZE  rcvd: 52</span><br><span class="line">[root@dhcp-10-201-102-198 ~]#1234567891011121314151617</span><br></pre></td></tr></table></figure>

<p>如你所见,一个<code>A</code>记录返回了一个可用的服务所在的节点的IP地址.<code>A</code>记录只能设置为IP地址. 有也可用使用 DNS API 来接收包含 地址和端口的 SRV记录:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@dhcp-10-201-102-198 ~]# dig @127.0.0.1 -p 8600 web.service.consul SRV</span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.8.2rc1-RedHat-9.8.2-0.17.rc1.el6 &lt;&lt;&gt;&gt; @127.0.0.1 -p 8600 web.service.consul SRV</span><br><span class="line">; (1 server found)</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 13331</span><br><span class="line">;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1</span><br><span class="line">;; WARNING: recursion requested but not available</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;web.service.consul.            IN      SRV</span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">web.service.consul.     0       IN      SRV     1 1 80 s1.node.dc1.consul.</span><br><span class="line">;; ADDITIONAL SECTION:</span><br><span class="line">s1.node.dc1.consul.     0       IN      A       10.201.102.198</span><br><span class="line">;; Query time: 0 msec</span><br><span class="line">;; SERVER: 127.0.0.1#8600(127.0.0.1)</span><br><span class="line">;; WHEN: Tue Mar 28 16:10:56 2017</span><br><span class="line">;; MSG SIZE  rcvd: 84</span><br><span class="line">[root@dhcp-10-201-102-198 ~]#12345678910111213141516171819</span><br></pre></td></tr></table></figure>

<p><code>SRV</code>记录告诉我们 web 这个服务运行于节点<code>dhcp-10-201-102-198</code> 的<code>80</code>端口. DNS额外返回了节点的A记录.</p>
<p>最后,我们也可以用 DNS API 通过标签来过滤服务.基于标签的服务查询格式为<code>TAG.NAME.service.consul</code>. 在下面的例子中,我们请求Consul返回有 <code>rails</code>标签的 <code>web</code>服务.我们成功获取了我们注册为这个标签的服务:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@dhcp-10-201-102-198 ~]# dig @127.0.0.1 -p 8600 rails.web.service.consul SRV</span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.8.2rc1-RedHat-9.8.2-0.17.rc1.el6 &lt;&lt;&gt;&gt; @127.0.0.1 -p 8600 rails.web.service.consul SRV</span><br><span class="line">; (1 server found)</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 37307</span><br><span class="line">;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1</span><br><span class="line">;; WARNING: recursion requested but not available</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;rails.web.service.consul.      IN      SRV</span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">rails.web.service.consul. 0     IN      SRV     1 1 80 s1.node.dc1.consul.</span><br><span class="line">;; ADDITIONAL SECTION:</span><br><span class="line">s1.node.dc1.consul.     0       IN      A       10.201.102.198</span><br><span class="line">;; Query time: 0 msec</span><br><span class="line">;; SERVER: 127.0.0.1#8600(127.0.0.1)</span><br><span class="line">;; WHEN: Tue Mar 28 16:11:45 2017</span><br><span class="line">;; MSG SIZE  rcvd: 90</span><br><span class="line">[root@dhcp-10-201-102-198 ~]#12345678910111213141516171819</span><br></pre></td></tr></table></figure>

<p><strong>HTTP API</strong><br> 除了DNS API之外,HTTP API也可以用来进行服务查询:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@dhcp-10-201-102-198 ~]# curl -s 127.0.0.1:8500/v1/catalog/service/web | python -m json.tool</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;Address&quot;: &quot;10.201.102.198&quot;,</span><br><span class="line">        &quot;CreateIndex&quot;: 492843,</span><br><span class="line">        &quot;ID&quot;: &quot;422ec677-74ef-8f29-2f22-01effeed6334&quot;,</span><br><span class="line">        &quot;ModifyIndex&quot;: 492843,</span><br><span class="line">        &quot;Node&quot;: &quot;s1&quot;,</span><br><span class="line">        &quot;NodeMeta&quot;: &#123;&#125;,</span><br><span class="line">        &quot;ServiceAddress&quot;: &quot;&quot;,</span><br><span class="line">        &quot;ServiceEnableTagOverride&quot;: false,</span><br><span class="line">        &quot;ServiceID&quot;: &quot;web&quot;,</span><br><span class="line">        &quot;ServiceName&quot;: &quot;web&quot;,</span><br><span class="line">        &quot;ServicePort&quot;: 80,</span><br><span class="line">        &quot;ServiceTags&quot;: [</span><br><span class="line">            &quot;rails&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;TaggedAddresses&quot;: &#123;</span><br><span class="line">            &quot;lan&quot;: &quot;10.201.102.198&quot;,</span><br><span class="line">            &quot;wan&quot;: &quot;10.201.102.198&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]1234567891011121314151617181920212223</span><br></pre></td></tr></table></figure>

<p>目录API给出所有节点提供的服务.稍后我们会像通常的那样带上健康检查进行查询.就像DNS内部处理的那样.这是只查看健康的实例的查询方法:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@dhcp-10-201-102-198 ~]# curl -s 127.0.0.1:8500/v1/catalog/service/web?passing | python -m json.tool</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;Address&quot;: &quot;10.201.102.198&quot;,</span><br><span class="line">        &quot;CreateIndex&quot;: 492843,</span><br><span class="line">        &quot;ID&quot;: &quot;422ec677-74ef-8f29-2f22-01effeed6334&quot;,</span><br><span class="line">        &quot;ModifyIndex&quot;: 492843,</span><br><span class="line">        &quot;Node&quot;: &quot;s1&quot;,</span><br><span class="line">        &quot;NodeMeta&quot;: &#123;&#125;,</span><br><span class="line">        &quot;ServiceAddress&quot;: &quot;&quot;,</span><br><span class="line">        &quot;ServiceEnableTagOverride&quot;: false,</span><br><span class="line">        &quot;ServiceID&quot;: &quot;web&quot;,</span><br><span class="line">        &quot;ServiceName&quot;: &quot;web&quot;,</span><br><span class="line">        &quot;ServicePort&quot;: 80,</span><br><span class="line">        &quot;ServiceTags&quot;: [</span><br><span class="line">            &quot;rails&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;TaggedAddresses&quot;: &#123;</span><br><span class="line">            &quot;lan&quot;: &quot;10.201.102.198&quot;,</span><br><span class="line">            &quot;wan&quot;: &quot;10.201.102.198&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]1234567891011121314151617181920212223</span><br></pre></td></tr></table></figure>

<h2 id="WEB管理界面"><a href="#WEB管理界面" class="headerlink" title="WEB管理界面"></a>WEB管理界面</h2><p>Consul同时提供了一个漂亮的功能齐全的WEB界面,开箱即用.界面可以用来查看所有的节点,可以查看健康检查和他们的当前状态.可以读取和设置K&#x2F;V 存储的数据.UI自动支持多数据中心.<a target="_blank" rel="noopener" href="https://www.consul.io/downloads.html">点击前往下载</a></p>
<p><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/blog/consul-manual/ui_download.jpg" alt="UI_Download"></p>
<p>下载完后上传至服务器，建议所有server角色都使用WebUI。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consul agent -server -bootstrap-expect 1 -data-dir /tmp/consul -node=s1 -bind=10.201.102.198 -ui-dir ./consul_ui/ -rejoin -config-dir=/etc/consul.d/ -client 0.0.0.01</span><br></pre></td></tr></table></figure>

<ul>
<li><code>-ui-dir</code>： 提供存放web ui资源的路径，指向该目录必须是可读的</li>
<li><code>-client</code>：consul服务侦听地址，这个地址提供HTTP、DNS、RPC等服务，默认是127.0.0.1所以不对外提供服务，如果你要对外提供服务改成0.0.0.0<br> 可通过<a target="_blank" rel="noopener" href="http://10.201.102.198:8500/">http://10.201.102.198:8500</a>访问WEB管理界面。</li>
</ul>
<p><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/blog/consul-manual/ui.jpg" alt="UI_Download"></p>
<h2 id="健康检查"><a href="#健康检查" class="headerlink" title="健康检查"></a>健康检查</h2><p>我们现在看到Consul运行时如此简单.添加节点和服务,查询节点和服务.在这一节.我们将继续添加健康检查到节点和服务.健康检查是服务发现的关键组件.预防使用到不健康的服务.</p>
<p>这一步建立在前一节的Consul集群创建之上.目前你应该有一个包含多个节点的Consul集群.</p>
<p><strong>自定义检查</strong><br> 和服务注册类似,一个检查可以通过检查定义或HTTP API请求来注册.</p>
<p>我们将使用和检查定义来注册检查.和服务类似,因为这是建立检查最常用的方式.</p>
<p>在第二个节点的配置目录建立定义文件:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/etc/consul.d/web.json1</span><br><span class="line">&#123;&quot;service&quot;: &#123;</span><br><span class="line">    &quot;name&quot;: &quot;Faceid&quot;,</span><br><span class="line">    &quot;tags&quot;: [&quot;extract&quot;, &quot;verify&quot;, &quot;compare&quot;, &quot;idcard&quot;],</span><br><span class="line">    &quot;address&quot;: &quot;10.201.102.198&quot;,</span><br><span class="line">    &quot;port&quot;: 9000,</span><br><span class="line">    &quot;check&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;ping&quot;,</span><br><span class="line">        &quot;script&quot;: &quot;curl -s localhost:9000&quot;,</span><br><span class="line">        &quot;interval&quot;: &quot;3s&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;123456789101112</span><br></pre></td></tr></table></figure>

<p>or</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">/etc/consul.d/web.json1</span><br><span class="line">&#123;&quot;service&quot;: &#123;</span><br><span class="line">    &quot;name&quot;: &quot;Faceid&quot;,</span><br><span class="line">    &quot;tags&quot;: [&quot;extract&quot;, &quot;verify&quot;, &quot;compare&quot;, &quot;idcard&quot;],</span><br><span class="line">    &quot;address&quot;: &quot;10.201.102.199&quot;,</span><br><span class="line">    &quot;port&quot;: 9000,</span><br><span class="line">    &quot;check&quot;: &#123;</span><br><span class="line">        &quot;id&quot;: &quot;api&quot;,</span><br><span class="line">           &quot;name&quot;: &quot;HTTP API on port 9000&quot;,</span><br><span class="line">        &quot;http&quot;: &quot;http://localhost:9000&quot;,</span><br><span class="line">        &quot;interval&quot;: &quot;10s&quot;,</span><br><span class="line">        &quot;timeout&quot;: &quot;1s&quot;</span><br><span class="line">        &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;1234567891011121314</span><br></pre></td></tr></table></figure>

<p>more</p>
<h2 id="检查健康状态"><a href="#检查健康状态" class="headerlink" title="检查健康状态"></a>检查健康状态</h2><p>我们能适应HTTP API来检查他们.首先我们检查有哪些失败的检查.使用这个命令(注意:这个命令可以运行在任何节点)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@dhcp-10-201-102-198 ~]# curl -s http://localhost:8500/v1/health/state/critical | python -m json.tool</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;CheckID&quot;: &quot;service:Faceid&quot;,</span><br><span class="line">        &quot;CreateIndex&quot;: 493398,</span><br><span class="line">        &quot;ModifyIndex&quot;: 493846,</span><br><span class="line">        &quot;Name&quot;: &quot;Service &#x27;Faceid&#x27; check&quot;,</span><br><span class="line">        &quot;Node&quot;: &quot;s1&quot;,</span><br><span class="line">        &quot;Notes&quot;: &quot;&quot;,</span><br><span class="line">        &quot;Output&quot;: &quot;&quot;,</span><br><span class="line">        &quot;ServiceID&quot;: &quot;Faceid&quot;,</span><br><span class="line">        &quot;ServiceName&quot;: &quot;Faceid&quot;,</span><br><span class="line">        &quot;Status&quot;: &quot;critical&quot;</span><br><span class="line">    &#125;</span><br><span class="line">]123456789101112131415</span><br></pre></td></tr></table></figure>

<p>我们可以看到,只有一个检查我们的<code>web</code>服务在<code>critical</code>状态</p>
<p>另外,我们可以尝试用DNS查询web服务,Consul将不会返回结果.因为服务不健康.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@dhcp-10-201-102-198 ~]# dig @127.0.0.1 -p 8600 Faceid.service.consul SRV</span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.8.2rc1-RedHat-9.8.2-0.17.rc1.el6 &lt;&lt;&gt;&gt; @127.0.0.1 -p 8600 Faceid.service.consul SRV</span><br><span class="line">; (1 server found)</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 40884</span><br><span class="line">;; flags: qr aa rd; QUERY: 1, ANSWER: 3, AUTHORITY: 0, ADDITIONAL: 3</span><br><span class="line">;; WARNING: recursion requested but not available</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;Faceid.service.consul.         IN      SRV</span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">Faceid.service.consul.  0       IN      SRV     1 1 9000 s3.node.dc1.consul.</span><br><span class="line">Faceid.service.consul.  0       IN      SRV     1 1 9000 s1.node.dc1.consul.</span><br><span class="line">Faceid.service.consul.  0       IN      SRV     1 1 9000 s2.node.dc1.consul.</span><br><span class="line">;; ADDITIONAL SECTION:</span><br><span class="line">s3.node.dc1.consul.     0       IN      A       10.201.102.200</span><br><span class="line">s1.node.dc1.consul.     0       IN      A       10.201.102.198</span><br><span class="line">s2.node.dc1.consul.     0       IN      A       10.201.102.199</span><br><span class="line">;; Query time: 0 msec</span><br><span class="line">;; SERVER: 127.0.0.1#8600(127.0.0.1)</span><br><span class="line">;; WHEN: Tue Mar 28 18:20:15 2017</span><br><span class="line">;; MSG SIZE  rcvd: 16512345678910111213141516171819202122</span><br></pre></td></tr></table></figure>

<h2 id="K-／V"><a href="#K-／V" class="headerlink" title="K ／V"></a>K ／V</h2><p>除了提供服务发现和健康检查的集成.Consul提供了一个易用的键&#x2F;值存储.这可以用来保持动态配置,协助服务协调,领袖选举,做开发者可以想到的任何事情.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@dhcp-10-201-102-198 ~]# curl -v http://localhost:8500/v1/kv/?recurse</span><br><span class="line">* About to connect() to localhost port 8500 (#0)</span><br><span class="line">*   Trying ::1... 拒绝连接</span><br><span class="line">*   Trying 127.0.0.1... connected</span><br><span class="line">* Connected to localhost (127.0.0.1) port 8500 (#0)</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">GET /v1/kv/?recurse HTTP/1.1</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">User-Agent: curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.21 Basic ECC zlib/1.2.3 libidn/1.18 libssh2/1.4.2</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">Host: localhost:8500</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">Accept: */*</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">&lt; HTTP/1.1 404 Not Found</span></span><br><span class="line">&lt; X-Consul-Index: 1</span><br><span class="line">&lt; X-Consul-Knownleader: true</span><br><span class="line">&lt; X-Consul-Lastcontact: 0</span><br><span class="line">&lt; Date: Thu, 18 Aug 2016 08:21:39 GMT</span><br><span class="line">&lt; Content-Length: 0</span><br><span class="line">&lt; Content-Type: text/plain; charset=utf-8</span><br><span class="line">&lt;</span><br><span class="line">* Connection #0 to host localhost left intact</span><br><span class="line">* Closing connection #01234567891011121314151617181920</span><br></pre></td></tr></table></figure>

<p>因为没有key所以我们得到了一个404响应.现在我们<code>PUT</code>一些示例的Key:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@dhcp-10-201-102-198 ~]# curl -X PUT -d &#x27;test&#x27; http://localhost:8500/v1/kv/web/key1</span><br><span class="line">[root@dhcp-10-201-102-198 ~]# curl -X PUT -d &#x27;test&#x27; http://localhost:8500/v1/kv/web/key2?flags=42</span><br><span class="line">[root@dhcp-10-201-102-198 ~]# curl -X PUT -d &#x27;test&#x27;  http://localhost:8500/v1/kv/web/sub/key3123</span><br></pre></td></tr></table></figure>

<p>我们创建了值为”test”的3个Key,注意返回的值是经过了<code>base64</code>编码的.用来支持非UTF8编码字符.对Key <code>web/key2</code>我们设置了一个标志值为 <code>42</code>.所有的key支持设置一个64位的整形数字标志.Consul内部不适用这个值.但是他可以被客户端适用来做一些元数据.</p>
<p>完成设置后,我们发起了一个<code>GET</code>请求来接收多个key的值,使用<code>?recurse</code>参数.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@dhcp-10-201-102-198 ~]# curl -s http://localhost:8500/v1/kv/web/?recurse | python -m json.tool</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;CreateIndex&quot;: 502660,</span><br><span class="line">        &quot;Flags&quot;: 0,</span><br><span class="line">        &quot;Key&quot;: &quot;web/key1&quot;,</span><br><span class="line">        &quot;LockIndex&quot;: 0,</span><br><span class="line">        &quot;ModifyIndex&quot;: 502660,</span><br><span class="line">        &quot;Value&quot;: &quot;dGVzdA==&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;CreateIndex&quot;: 502663,</span><br><span class="line">        &quot;Flags&quot;: 42,</span><br><span class="line">        &quot;Key&quot;: &quot;web/key2&quot;,</span><br><span class="line">        &quot;LockIndex&quot;: 0,</span><br><span class="line">        &quot;ModifyIndex&quot;: 502663,</span><br><span class="line">        &quot;Value&quot;: &quot;dGVzdA==&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;CreateIndex&quot;: 502665,</span><br><span class="line">        &quot;Flags&quot;: 0,</span><br><span class="line">        &quot;Key&quot;: &quot;web/sub/key3&quot;,</span><br><span class="line">        &quot;LockIndex&quot;: 0,</span><br><span class="line">        &quot;ModifyIndex&quot;: 502665,</span><br><span class="line">        &quot;Value&quot;: &quot;dGVzdA==&quot;</span><br><span class="line">    &#125;</span><br><span class="line">]123456789101112131415161718192021222324252627</span><br></pre></td></tr></table></figure>

<p>你可以获取<strong>单个</strong>的key</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@dhcp-10-201-102-198 ~]# curl -s http://localhost:8500/v1/kv/web/key1 | python -m json.tool</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;CreateIndex&quot;: 502660,</span><br><span class="line">        &quot;Flags&quot;: 0,</span><br><span class="line">        &quot;Key&quot;: &quot;web/key1&quot;,</span><br><span class="line">        &quot;LockIndex&quot;: 0,</span><br><span class="line">        &quot;ModifyIndex&quot;: 502660,</span><br><span class="line">        &quot;Value&quot;: &quot;dGVzdA==&quot;</span><br><span class="line">    &#125;</span><br><span class="line">]1234567891011</span><br></pre></td></tr></table></figure>

<p>删除key也很简单.通过<code>DELETE</code>动作来完成.我们可以通过指定完整路径来删除一个单独的key.或者我们可以使用<code>?recurse</code><strong>递归</strong>的删除主路径下所有key.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@dhcp-10-201-102-198 ~]# curl -X DELETE http://localhost:8500/v1/kv/web/sub?recurse</span><br><span class="line">true12</span><br></pre></td></tr></table></figure>

<p>可以通过发送相同的URL并提供不同的消息体的<code>PUT</code>请求去修改一个Key.另外,Consul提供一个检查并设置的操作,实现原子的Key修改.通过<code>?cas=参数</code>加上<code>GET</code>中最近的<code>ModifyIndex</code>来达到. 例如我们想修改 “web&#x2F;key1”:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl -X PUT -d &#x27;newval&#x27; http://localhost:8500/v1/kv/web/key1?cas=502660</span><br><span class="line">true</span><br><span class="line">curl -X PUT -d &#x27;newval&#x27; http://localhost:8500/v1/kv/web/key1?cas=502660</span><br><span class="line">false1234</span><br></pre></td></tr></table></figure>

<p>在这种情况下,第一次<code>CAS</code> 更新成功因为<code>ModifyIndex</code>是<code>502660</code>.而第二次失败是因为<code>ModifyIndex</code>在第一次更新后已经不是<code>502660</code>了 .</p>
<p>我们也可以使用<code>ModifyIndex</code>来等待key值的改变.例如我们想等待<code>key2</code>被修改:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@dhcp-10-201-102-198 ~]# curl &quot;http://localhost:8500/v1/kv/web/key2&quot;</span><br><span class="line">[&#123;&quot;LockIndex&quot;:0,&quot;Key&quot;:&quot;web/key2&quot;,&quot;Flags&quot;:42,&quot;Value&quot;:&quot;dGVzdA==&quot;,&quot;CreateIndex&quot;:502663,&quot;ModifyIndex&quot;:502663&#125;]</span><br><span class="line">[root@dhcp-10-201-102-198 ~]# curl &quot;http://localhost:8500/v1/kv/web/key2?index=502663&amp;wait=5s&quot;</span><br><span class="line">[&#123;&quot;LockIndex&quot;:0,&quot;Key&quot;:&quot;web/key2&quot;,&quot;Flags&quot;:42,&quot;Value&quot;:&quot;dGVzdA==&quot;,&quot;CreateIndex&quot;:502663,&quot;ModifyIndex&quot;:502663&#125;]1234</span><br></pre></td></tr></table></figure>

<p>通过提供 <code>?index=</code>,我们请求等待key值有一个比<code>502663</code>更大的<code>ModifyIndex</code>.虽然<code>?wait=5s</code>参数限制了这个请求最多5秒,否则返回当前的未改变的值. 这样可以有效的等待key的改变.另外,这个功能可以用于等待一组key.直到其中的某个key有修改.</p>
<h1 id="Conusl-命令行"><a href="#Conusl-命令行" class="headerlink" title="Conusl 命令行"></a>Conusl 命令行</h1><p>见识了consul的强大，consul可以通过一个简单的CLI来控制，consul只有一个命令行应用，就是consul命令，consul命令可以包含agent、members等参数进行使用，这一篇来具体看看consul  CLI的具体用法，consul -h即可看到consul cli所支持的参数，而每个参数里面又支持其他参数，下面我们就来具体看看。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@dhcp-10-201-102-198 ~]# consul</span><br><span class="line">usage: consul [--version] [--help] &lt;command&gt; [&lt;args&gt;]</span><br><span class="line">Available commands are:</span><br><span class="line">    agent          Runs a Consul agent  运行一个consul agent</span><br><span class="line">    configtest     Validate config file</span><br><span class="line">    event          Fire a new event</span><br><span class="line">    exec           Executes a command on Consul nodes  在consul节点上执行一个命令</span><br><span class="line">    force-leave    Forces a member of the cluster to enter the &quot;left&quot; state   强制节点成员在集群中的状态转换到left状态</span><br><span class="line">    info           Provides debugging information for operators  提供操作的debug级别的信息</span><br><span class="line">    join           Tell Consul agent to join cluster   加入consul节点到集群中</span><br><span class="line">    keygen         Generates a new encryption key  生成一个新的加密key</span><br><span class="line">    keyring        Manages gossip layer encryption keys</span><br><span class="line">    kv             Interact with the key-value store</span><br><span class="line">    leave          Gracefully leaves the Consul cluster and shuts down</span><br><span class="line">    lock           Execute a command holding a lock</span><br><span class="line">    maint          Controls node or service maintenance mode</span><br><span class="line">    members        Lists the members of a Consul cluster    列出集群中成员</span><br><span class="line">    monitor        Stream logs from a Consul agent  打印consul节点的日志信息</span><br><span class="line">    operator       Provides cluster-level tools for Consul operators</span><br><span class="line">    reload         Triggers the agent to reload configuration files   触发节点重新加载配置文件</span><br><span class="line">    rtt            Estimates network round trip time between nodes</span><br><span class="line">    snapshot       Saves, restores and inspects snapshots of Consul server state</span><br><span class="line">    version        Prints the Consul version    打印consul的版本信息</span><br><span class="line">    watch          Watch for changes in Consul   监控consul的改变123456789101112131415161718192021222324</span><br></pre></td></tr></table></figure>

<p>更详细见<a target="_blank" rel="noopener" href="https://www.consul.io/docs/commands/index.html">官网</a></p>
<h2 id="Agent"><a href="#Agent" class="headerlink" title="Agent"></a>Agent</h2><p><code>agent</code>指令是consul的核心，它运行agent来维护成员的重要信息、运行检查、服务宣布、查询处理等等。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">==&gt; Usage: consul agent [options]</span><br><span class="line">  Starts the Consul agent and runs until an interrupt is received. The</span><br><span class="line">  agent represents a single node in a cluster.</span><br><span class="line">Options:</span><br><span class="line">  -advertise=addr                  Sets the advertise address to use</span><br><span class="line">  -advertise-wan=addr              Sets address to advertise on wan instead of</span><br><span class="line">                                   advertise addr</span><br><span class="line">  -bootstrap                       Sets server to bootstrap mode</span><br><span class="line">  -bind=0.0.0.0                    Sets the bind address for cluster</span><br><span class="line">                                   communication</span><br><span class="line">  -http-port=8500                  Sets the HTTP API port to listen on</span><br><span class="line">  -bootstrap-expect=0              Sets server to expect bootstrap mode.</span><br><span class="line">  -client=127.0.0.1                Sets the address to bind for client access.</span><br><span class="line">                                   This includes RPC, DNS, HTTP and HTTPS (if</span><br><span class="line">                                   configured)</span><br><span class="line">  -config-file=foo                 Path to a JSON file to read configuration</span><br><span class="line">                                   from. This can be specified multiple times.</span><br><span class="line">  -config-dir=foo                  Path to a directory to read configuration</span><br><span class="line">                                   files from. This will read every file ending</span><br><span class="line">                                   in &quot;.json&quot; as configuration in this</span><br><span class="line">                                   directory in alphabetical order. This can be</span><br><span class="line">                                   specified multiple times.</span><br><span class="line">  -data-dir=path                   Path to a data directory to store agent</span><br><span class="line">                                   state</span><br><span class="line">  -dev                             Starts the agent in development mode.</span><br><span class="line">  -recursor=1.2.3.4                Address of an upstream DNS server.</span><br><span class="line">                                   Can be specified multiple times.</span><br><span class="line">  -dc=east-aws                     Datacenter of the agent (deprecated: use</span><br><span class="line">                                   &#x27;datacenter&#x27; instead).</span><br><span class="line">  -datacenter=east-aws             Datacenter of the agent.</span><br><span class="line">  -encrypt=key                     Provides the gossip encryption key</span><br><span class="line">  -join=1.2.3.4                    Address of an agent to join at start time.</span><br><span class="line">                                   Can be specified multiple times.</span><br><span class="line">  -join-wan=1.2.3.4                Address of an agent to join -wan at start</span><br><span class="line">                                   time. Can be specified multiple times.</span><br><span class="line">  -retry-join=1.2.3.4              Address of an agent to join at start time</span><br><span class="line">                                   with retries enabled. Can be specified</span><br><span class="line">                                   multiple times.</span><br><span class="line">  -retry-interval=30s              Time to wait between join attempts.</span><br><span class="line">  -retry-max=0                     Maximum number of join attempts. Defaults to</span><br><span class="line">                                   0, which will retry indefinitely.</span><br><span class="line">  -retry-join-ec2-region           EC2 Region to use for discovering servers to</span><br><span class="line">                                   join.</span><br><span class="line">  -retry-join-ec2-tag-key          EC2 tag key to filter on for server</span><br><span class="line">                                   discovery</span><br><span class="line">  -retry-join-ec2-tag-value        EC2 tag value to filter on for server</span><br><span class="line">                                   discovery</span><br><span class="line">  -retry-join-gce-project-name     Google Compute Engine project to discover</span><br><span class="line">                                   servers in</span><br><span class="line">  -retry-join-gce-zone-pattern     Google Compute Engine region or zone to</span><br><span class="line">                                   discover servers in (regex pattern)</span><br><span class="line">  -retry-join-gce-tag-value        Google Compute Engine tag value to filter</span><br><span class="line">                                   for server discovery</span><br><span class="line">  -retry-join-gce-credentials-file Path to credentials JSON file to use with</span><br><span class="line">                                   Google Compute Engine</span><br><span class="line">  -retry-join-wan=1.2.3.4          Address of an agent to join -wan at start</span><br><span class="line">                                   time with retries enabled. Can be specified</span><br><span class="line">                                   multiple times.</span><br><span class="line">  -retry-interval-wan=30s          Time to wait between join -wan attempts.</span><br><span class="line">  -retry-max-wan=0                 Maximum number of join -wan attempts.</span><br><span class="line">                                   Defaults to 0, which will retry</span><br><span class="line">                                   indefinitely.</span><br><span class="line">  -log-level=info                  Log level of the agent.</span><br><span class="line">  -node=hostname                   Name of this node. Must be unique in the</span><br><span class="line">                                   cluster</span><br><span class="line">  -node-meta=key:value             An arbitrary metadata key/value pair for</span><br><span class="line">                                   this node.</span><br><span class="line">                                   This can be specified multiple times.</span><br><span class="line">  -protocol=N                      Sets the protocol version. Defaults to</span><br><span class="line">                                   latest.</span><br><span class="line">  -rejoin                          Ignores a previous leave and attempts to</span><br><span class="line">                                   rejoin the cluster.</span><br><span class="line">  -server                          Switches agent to server mode.</span><br><span class="line">  -syslog                          Enables logging to syslog</span><br><span class="line">  -ui                              Enables the built-in static web UI server</span><br><span class="line">  -ui-dir=path                     Path to directory containing the Web UI</span><br><span class="line">                                   resources</span><br><span class="line">  -pid-file=path                   Path to file to store agent PID123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778</span><br></pre></td></tr></table></figure>

<h2 id="event"><a href="#event" class="headerlink" title="event"></a>event</h2><p><code>event</code>命令提供了一种机制，用来fire自定义的用户事件，这些事件对consul来说是不透明的，但它们可以用来构建自动部署、重启服务或者其他行动的脚本。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-http-addr：http服务的地址，agent可以链接上来发送命令，如果没有设置，则默认是127.0.0.1:8500。</span><br><span class="line">-datacenter：数据中心。</span><br><span class="line">-name：事件的名称</span><br><span class="line">-node：一个正则表达式，用来过滤节点</span><br><span class="line">-service：一个正则表达式，用来过滤节点上匹配的服务</span><br><span class="line">-tag：一个正则表达式，用来过滤节点上符合tag的服务，必须和-service一起使用。123456</span><br></pre></td></tr></table></figure>

<h2 id="exec"><a href="#exec" class="headerlink" title="exec"></a>exec</h2><p><code>exec</code>指令提供了一种远程执行机制，比如你要在所有的机器上执行uptime命令，远程执行的工作通过job来指定，存储在KV中，agent使用event系统可以快速的知道有新的job产生，消息是通过gossip协议来传递的，因此消息传递是最佳的，但是并不保证命令的执行。事件通过gossip来驱动，远程执行依赖KV存储系统(就像消息代理一样)。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">-http-addr：http服务的地址，agent可以链接上来发送命令，如果没有设置，则默认是127.0.0.1:8500。</span><br><span class="line">-datacenter：数据中心。</span><br><span class="line">-prefix：key在KV系统中的前缀，用来存储请求数据，默认是_rexec</span><br><span class="line">-node：一个正则表达式，用来过滤节点，评估事件</span><br><span class="line">-service：一个正则表达式，用来过滤节点上匹配的服务</span><br><span class="line">-tag：一个正则表达式，用来过滤节点上符合tag的服务，必须和-service一起使用。</span><br><span class="line">-wait：在节点多长时间没有响应后，认为job已经完成。</span><br><span class="line">-wait-repl：</span><br><span class="line">-verbose：输出更多信息123456789</span><br></pre></td></tr></table></figure>

<h2 id="force-leave"><a href="#force-leave" class="headerlink" title="force-leave"></a>force-leave</h2><p><code>force-leave</code>治疗可以强制consul集群中的成员进入left状态(空闲状态)，记住，即使一个成员处于活跃状态，它仍旧可以再次加入集群中，这个方法的真实目的是强制移除failed的节点。如果failed的节点还是网络的一部分，则consul会周期性的重新链接failed的节点，如果经过一段时间后(默认是72小时)，consul则会宣布停止尝试链接failed的节点。force-leave指令可以快速的把failed节点转换到left状态。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-rpc-addr:一个rpc地址，agent可以链接上来发送命令，如果没有指定，默认是127.0.0.1:8400。1</span><br></pre></td></tr></table></figure>

<h2 id="info"><a href="#info" class="headerlink" title="info"></a>info</h2><p><code>info</code>指令提供了各种操作时可以用到的debug信息，对于client和server，info有返回不同的子系统信息，目前有以下几个KV信息：agent(提供agent信息)，consul(提供consul库的信息)，raft(提供raft库的信息)，serf_lan(提供LAN  gossip pool),serf_wan(提供WAN gossip pool)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-rpc-addr：一个rpc地址，agent可以链接上来发送命令，如果没有指定，默认是127.0.0.1:84001</span><br></pre></td></tr></table></figure>

<h2 id="join"><a href="#join" class="headerlink" title="join"></a>join</h2><p><code>join</code>指令告诉consul agent加入一个已经存在的集群中，一个新的consul  agent必须加入一个已经有至少一个成员的集群中，这样它才能加入已经存在的集群中，如果你不加入一个已经存在的集群，则agent是它自身集群的一部分，其他agent则可以加入进来。agents可以加入其他agent多次。consul  join [options] address。如果你想加入多个集群，则可以写多个地址，consul会加入所有的地址。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-wan：agent运行在server模式，xxxxxxx</span><br><span class="line">-rpc-addr：一个rpc地址，agent可以链接上来发送命令，如果没有指定，默认是127.0.0.1:8400。12</span><br></pre></td></tr></table></figure>

<h2 id="keygen"><a href="#keygen" class="headerlink" title="keygen"></a>keygen</h2><p><code>keygen</code>指令生成加密的密钥，可以用在consul agent通讯加密</p>
<p>生成一个key</p>
<h2 id="leave"><a href="#leave" class="headerlink" title="leave"></a>leave</h2><p><code>leave</code>指令触发一个优雅的离开动作并关闭agent，节点离开后不会尝试重新加入集群中。运行在server状态的节点，节点会被优雅的删除，这是很严重的，在某些情况下一个不优雅的离开会影响到集群的可用性。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-rpc-addr:一个rpc地址，agent可以链接上来发送命令，如果没有指定，默认是127.0.0.1:8400。1</span><br></pre></td></tr></table></figure>

<h2 id="members"><a href="#members" class="headerlink" title="members"></a>members</h2><p><code>members</code>指令输出consul agent目前所知道的所有的成员以及它们的状态，节点的状态只有alive、left、failed三种状态。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-detailed：输出每个节点更详细的信息。</span><br><span class="line">-rpc-addr：一个rpc地址，agent可以链接上来发送命令，如果没有指定，默认是127.0.0.1:8400。</span><br><span class="line">-status：过滤出符合正则规则的节点</span><br><span class="line">-wan：xxxxxx1234</span><br></pre></td></tr></table></figure>

<h2 id="monitor"><a href="#monitor" class="headerlink" title="monitor"></a>monitor</h2><p><code>monitor</code>指令用来链接运行的agent，并显示日志。monitor会显示最近的日志，并持续的显示日志流，不会自动退出，除非你手动或者远程agent自己退出。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-log-level：显示哪个级别的日志，默认是info</span><br><span class="line">-rpc-addr：一个rpc地址，agent可以链接上来发送命令，如果没有指定，默认是127.0.0.1:840012</span><br></pre></td></tr></table></figure>

<h2 id="reload"><a href="#reload" class="headerlink" title="reload"></a>reload</h2><p><code>reload</code>指令可以重新加载agent的配置文件。SIGHUP指令在重新加载配置文件时使用，任何重新加载的错误都会写在agent的log文件中，并不会打印到屏幕。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-rpc-addr：一个rpc地址，agent可以链接上来发送命令，如果没有指定，默认是127.0.0.1:84001</span><br></pre></td></tr></table></figure>

<h2 id="version"><a href="#version" class="headerlink" title="version"></a>version</h2><p>打印consul的版本</p>
<h2 id="watch"><a href="#watch" class="headerlink" title="watch"></a>watch</h2><p><code>watch</code>指令提供了一个机制，用来监视实际数据视图的改变(节点列表、成员服务、KV)，如果没有指定进程，当前值会被dump出来</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">-http-addr：http服务的地址，agent可以链接上来发送命令，如果没有设置，则默认是127.0.0.1:8500。</span><br><span class="line">-datacenter：数据中心查询。</span><br><span class="line">-token：ACL token</span><br><span class="line">-key：监视key，只针对key类型</span><br><span class="line">-name：监视event，只针对event类型</span><br><span class="line">-prefix：监视key prefix，只针对keyprefix类型</span><br><span class="line">-service：监控service，只针对service类型</span><br><span class="line">-state：过略check state</span><br><span class="line">-tag：过滤service tag</span><br><span class="line">-type：监控类型，一般有key、keyprefix、service、nodes、checks、event12345678910</span><br></pre></td></tr></table></figure>

<h1 id="Consul-配置"><a href="#Consul-配置" class="headerlink" title="Consul 配置"></a>Consul 配置</h1><p>agent有各种各样的配置项可以在命令行或者配置文件进行定义，所有的配置项都是可选择的，当加载配置文件的时候，consul从配置文件或者配置目录加载配置。后面定义的配置会合并前面定义的配置，但是大多数情况下，合并的意思是后面定义的配置会覆盖前面定义的配置，但是有些情况，例如event句柄，合并仅仅是添加到前面定义的句柄后面。consul重新加载配置文件也支持以信号的方式接收update信号。</p>
<p>下面看看命令行参数：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">-advertise：通知展现地址用来改变我们给集群中的其他节点展现的地址，一般情况下-bind地址就是展现地址</span><br><span class="line">-bootstrap：用来控制一个server是否在bootstrap模式，在一个datacenter中只能有一个server处于bootstrap模式，当一个server处于bootstrap模式时，可以自己选举为raft leader。</span><br><span class="line">-bootstrap-expect：在一个datacenter中期望提供的server节点数目，当该值提供的时候，consul一直等到达到指定sever数目的时候才会引导整个集群，该标记不能和bootstrap公用</span><br><span class="line">-bind：该地址用来在集群内部的通讯，集群内的所有节点到地址都必须是可达的，默认是0.0.0.0</span><br><span class="line">-client：consul绑定在哪个client地址上，这个地址提供HTTP、DNS、RPC等服务，默认是127.0.0.1</span><br><span class="line">-config-file：明确的指定要加载哪个配置文件</span><br><span class="line">-config-dir：配置文件目录，里面所有以.json结尾的文件都会被加载</span><br><span class="line">-data-dir：提供一个目录用来存放agent的状态，所有的agent允许都需要该目录，该目录必须是稳定的，系统重启后都继续存在</span><br><span class="line">-dc：该标记控制agent允许的datacenter的名称，默认是dc1</span><br><span class="line">-encrypt：指定secret key，使consul在通讯时进行加密，key可以通过consul keygen生成，同一个集群中的节点必须使用相同的key</span><br><span class="line">-join：加入一个已经启动的agent的ip地址，可以多次指定多个agent的地址。如果consul不能加入任何指定的地址中，则agent会启动失败，默认agent启动时不会加入任何节点。</span><br><span class="line">-retry-join：和join类似，但是允许你在第一次失败后进行尝试。</span><br><span class="line">-retry-interval：两次join之间的时间间隔，默认是30s</span><br><span class="line">-retry-max：尝试重复join的次数，默认是0，也就是无限次尝试</span><br><span class="line">-log-level：consul agent启动后显示的日志信息级别。默认是info，可选：trace、debug、info、warn、err。</span><br><span class="line">-node：节点在集群中的名称，在一个集群中必须是唯一的，默认是该节点的主机名</span><br><span class="line">-protocol：consul使用的协议版本</span><br><span class="line">-rejoin：使consul忽略先前的离开，在再次启动后仍旧尝试加入集群中。</span><br><span class="line">-server：定义agent运行在server模式，每个集群至少有一个server，建议每个集群的server不要超过5个</span><br><span class="line">-syslog：开启系统日志功能，只在linux/osx上生效</span><br><span class="line">-ui-dir:提供存放web ui资源的路径，该目录必须是可读的</span><br><span class="line">-pid-file:提供一个路径来存放pid文件，可以使用该文件进行SIGINT/SIGHUP(关闭/更新)agent12345678910111213141516171819202122</span><br></pre></td></tr></table></figure>

<p>除了命令行参数外，配置也可以写入文件中，在某些情况下配置文件会更简单一些，例如：利用consul被用来管理系统。配置文件是json格式的，很容易编写。配置文件不仅被用来设置agent的启动，也可以用来提供健康检测和服务发现的定义。配置文件的一般样例如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;datacenter&quot;: &quot;dc1&quot;,</span><br><span class="line">  &quot;data_dir&quot;: &quot;/opt/consul&quot;,</span><br><span class="line">  &quot;log_level&quot;: &quot;INFO&quot;,</span><br><span class="line">  &quot;node_name&quot;: &quot;s1&quot;,</span><br><span class="line">  &quot;server&quot;: true,</span><br><span class="line">  &quot;bootstrap_expect&quot;: 3,</span><br><span class="line">  &quot;bind_addr&quot;: &quot;10.201.102.198&quot;,</span><br><span class="line">  &quot;client_addr&quot;: &quot;0.0.0.0&quot;,</span><br><span class="line">  &quot;ui_dir&quot;: &quot;/root/consul_ui&quot;,</span><br><span class="line">  &quot;retry_join&quot;: [&quot;10.201.102.198&quot;,&quot;10.201.102.199&quot;,&quot;10.201.102.200&quot;,&quot;10.201.102.248&quot;],</span><br><span class="line">  &quot;retry_interval&quot;: &quot;30s&quot;,</span><br><span class="line">  &quot;enable_debug&quot;: false,</span><br><span class="line">  &quot;rejoin_after_leave&quot;: true,</span><br><span class="line">  &quot;start_join&quot;: [&quot;10.201.102.198&quot;,&quot;10.201.102.199&quot;,&quot;10.201.102.200&quot;,&quot;10.201.102.248&quot;],</span><br><span class="line">  &quot;enable_syslog&quot;: true,</span><br><span class="line">  &quot;syslog_facility&quot;: &quot;local5&quot;</span><br><span class="line">&#125;123456789101112131415161718</span><br></pre></td></tr></table></figure>

<p>下面看看详细的配置文件参数：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">acl_datacenter：只用于server，指定的datacenter的权威ACL信息，所有的servers和datacenter必须同意ACL datacenter</span><br><span class="line">acl_default_policy：默认是allow</span><br><span class="line">acl_down_policy：</span><br><span class="line">acl_master_token：</span><br><span class="line">acl_token：agent会使用这个token和consul server进行请求</span><br><span class="line">acl_ttl：控制TTL的cache，默认是30s</span><br><span class="line">addresses：一个嵌套对象，可以设置以下key：dns、http、rpc</span><br><span class="line">advertise_addr：等同于-advertise</span><br><span class="line">bootstrap：等同于-bootstrap</span><br><span class="line">bootstrap_expect：等同于-bootstrap-expect</span><br><span class="line">bind_addr：等同于-bind</span><br><span class="line">ca_file：提供CA文件路径，用来检查客户端或者服务端的链接</span><br><span class="line">cert_file：必须和key_file一起</span><br><span class="line">check_update_interval：</span><br><span class="line">client_addr：等同于-client</span><br><span class="line">datacenter：等同于-dc</span><br><span class="line">data_dir：等同于-data-dir</span><br><span class="line">disable_anonymous_signature：在进行更新检查时禁止匿名签名</span><br><span class="line">disable_remote_exec：禁止支持远程执行，设置为true，agent会忽视所有进入的远程执行请求</span><br><span class="line">disable_update_check：禁止自动检查安全公告和新版本信息</span><br><span class="line">dns_config：是一个嵌套对象，可以设置以下参数：allow_stale、max_stale、node_ttl 、service_ttl、enable_truncate</span><br><span class="line">domain：默认情况下consul在进行DNS查询时，查询的是consul域，可以通过该参数进行修改</span><br><span class="line">enable_debug：开启debug模式</span><br><span class="line">enable_syslog：等同于-syslog</span><br><span class="line">encrypt：等同于-encrypt</span><br><span class="line">key_file：提供私钥的路径</span><br><span class="line">leave_on_terminate：默认是false，如果为true，当agent收到一个TERM信号的时候，它会发送leave信息到集群中的其他节点上。</span><br><span class="line">log_level：等同于-log-level</span><br><span class="line">node_name:等同于-node</span><br><span class="line">ports：这是一个嵌套对象，可以设置以下key：dns(dns地址：8600)、http(http api地址：8500)、rpc(rpc:8400)、serf_lan(lan port:8301)、serf_wan(wan port:8302)、server(server rpc:8300)</span><br><span class="line">protocol：等同于-protocol</span><br><span class="line">recursor：</span><br><span class="line">rejoin_after_leave：等同于-rejoin</span><br><span class="line">retry_join：等同于-retry-join</span><br><span class="line">retry_interval：等同于-retry-interval</span><br><span class="line">server：等同于-server</span><br><span class="line">server_name：会覆盖TLS CA的node_name，可以用来确认CA name和hostname相匹配</span><br><span class="line">skip_leave_on_interrupt：和leave_on_terminate比较类似，不过只影响当前句柄</span><br><span class="line">start_join：一个字符数组提供的节点地址会在启动时被加入</span><br><span class="line">statsd_addr：</span><br><span class="line">statsite_addr：</span><br><span class="line">syslog_facility：当enable_syslog被提供后，该参数控制哪个级别的信息被发送，默认Local0</span><br><span class="line">ui_dir：等同于-ui-dir</span><br><span class="line">verify_incoming：默认false，如果为true，则所有进入链接都需要使用TLS，需要客户端使用ca_file提供ca文件，只用于consul server端，因为client从来没有进入的链接</span><br><span class="line">verify_outgoing：默认false，如果为true，则所有出去链接都需要使用TLS，需要服务端使用ca_file提供ca文件，consul server和client都需要使用，因为两者都有出去的链接</span><br><span class="line">watches：watch一个详细名单12345678910111213141516171819202122232425262728293031323334353637383940414243444546</span><br></pre></td></tr></table></figure>

<h1 id="HTTP-API"><a href="#HTTP-API" class="headerlink" title="HTTP API"></a>HTTP API</h1><p>consul的主要接口是RESTful HTTP API，该API可以用来增删查改nodes、services、checks、configguration。所有的endpoints主要分为以下类别：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">kv - Key/Value存储</span><br><span class="line">agent - Agent控制</span><br><span class="line">catalog - 管理nodes和services</span><br><span class="line">health - 管理健康监测</span><br><span class="line">session - Session操作</span><br><span class="line">acl - ACL创建和管理</span><br><span class="line">event - 用户Events</span><br><span class="line">status - Consul系统状态12345678</span><br></pre></td></tr></table></figure>

<p>下面我们就单独看看每个模块的具体内容。</p>
<h2 id="agent"><a href="#agent" class="headerlink" title="agent"></a>agent</h2><p>agent endpoints用来和本地agent进行交互，一般用来服务注册和检查注册，支持以下接口</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/v1/agent/checks : 返回本地agent注册的所有检查(包括配置文件和HTTP接口)</span><br><span class="line">/v1/agent/services : 返回本地agent注册的所有 服务</span><br><span class="line">/v1/agent/members : 返回agent在集群的gossip pool中看到的成员</span><br><span class="line">/v1/agent/self : 返回本地agent的配置和成员信息</span><br><span class="line">/v1/agent/join/&lt;address&gt; : 触发本地agent加入node</span><br><span class="line">/v1/agent/force-leave/&lt;node&gt;&gt;: 强制删除node</span><br><span class="line">/v1/agent/check/register : 在本地agent增加一个检查项，使用PUT方法传输一个json格式的数据</span><br><span class="line">/v1/agent/check/deregister/&lt;checkID&gt; : 注销一个本地agent的检查项</span><br><span class="line">/v1/agent/check/pass/&lt;checkID&gt; : 设置一个本地检查项的状态为passing</span><br><span class="line">/v1/agent/check/warn/&lt;checkID&gt; : 设置一个本地检查项的状态为warning</span><br><span class="line">/v1/agent/check/fail/&lt;checkID&gt; : 设置一个本地检查项的状态为critical</span><br><span class="line">/v1/agent/service/register : 在本地agent增加一个新的服务项，使用PUT方法传输一个json格式的数据</span><br><span class="line">/v1/agent/service/deregister/&lt;serviceID&gt; : 注销一个本地agent的服务项12345678910111213</span><br></pre></td></tr></table></figure>

<h2 id="catalog"><a href="#catalog" class="headerlink" title="catalog"></a>catalog</h2><p>catalog endpoints用来注册&#x2F;注销nodes、services、checks</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/v1/catalog/register : Registers a new node, service, or check</span><br><span class="line">/v1/catalog/deregister : Deregisters a node, service, or check</span><br><span class="line">/v1/catalog/datacenters : Lists known datacenters</span><br><span class="line">/v1/catalog/nodes : Lists nodes in a given DC</span><br><span class="line">/v1/catalog/services : Lists services in a given DC</span><br><span class="line">/v1/catalog/service/&lt;service&gt; : Lists the nodes in a given service</span><br><span class="line">/v1/catalog/node/&lt;node&gt; : Lists the services provided by a node1234567</span><br></pre></td></tr></table></figure>

<h2 id="health"><a href="#health" class="headerlink" title="health"></a>health</h2><p>health endpoints用来查询健康状况相关信息，该功能从catalog中单独分离出来</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/v1/healt/node/&lt;node&gt;: 返回node所定义的检查，可用参数?dc=</span><br><span class="line">/v1/health/checks/&lt;service&gt;: 返回和服务相关联的检查，可用参数?dc=</span><br><span class="line">/v1/health/service/&lt;service&gt;: 返回给定datacenter中给定node中service</span><br><span class="line">/v1/health/state/&lt;state&gt;: 返回给定datacenter中指定状态的服务，state可以是&quot;any&quot;, &quot;unknown&quot;, &quot;passing&quot;, &quot;warning&quot;, or &quot;critical&quot;，可用参数?dc=1234</span><br></pre></td></tr></table></figure>

<h2 id="session"><a href="#session" class="headerlink" title="session"></a>session</h2><p>session endpoints用来create、update、destory、query sessions</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/v1/session/create: Creates a new session</span><br><span class="line">/v1/session/destroy/&lt;session&gt;: Destroys a given session</span><br><span class="line">/v1/session/info/&lt;session&gt;: Queries a given session</span><br><span class="line">/v1/session/node/&lt;node&gt;: Lists sessions belonging to a node</span><br><span class="line">/v1/session/list: Lists all the active sessions12345</span><br></pre></td></tr></table></figure>

<h2 id="acl"><a href="#acl" class="headerlink" title="acl"></a>acl</h2><p>acl endpoints用来create、update、destory、query acl</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/v1/acl/create: Creates a new token with policy</span><br><span class="line">/v1/acl/update: Update the policy of a token</span><br><span class="line">/v1/acl/destroy/&lt;id&gt;: Destroys a given token</span><br><span class="line">/v1/acl/info/&lt;id&gt;: Queries the policy of a given token</span><br><span class="line">/v1/acl/clone/&lt;id&gt;: Creates a new token by cloning an existing token</span><br><span class="line">/v1/acl/list: Lists all the active tokens123456</span><br></pre></td></tr></table></figure>

<h2 id="event-1"><a href="#event-1" class="headerlink" title="event"></a>event</h2><p>event endpoints用来fire新的events、查询已有的events</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/v1/event/fire/&lt;name&gt;: 触发一个新的event，用户event需要name和其他可选的参数，使用PUT方法</span><br><span class="line">/v1/event/list: 返回agent知道的events12</span><br></pre></td></tr></table></figure>

<h2 id="status"><a href="#status" class="headerlink" title="status"></a>status</h2><p>status endpoints用来或者consul 集群的信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/v1/status/leader : 返回当前集群的Raft leader</span><br><span class="line">/v1/status/peers : 返回当前集群中同事12</span><br></pre></td></tr></table></figure>

<h1 id="Consul-Template"><a href="#Consul-Template" class="headerlink" title="Consul-Template"></a>Consul-Template</h1><p>在consul-template没出现之前，大家构建服务发现系统，大多采用的是zookeeper、etcd+confd这样类似的系统，之前写过一篇consul+confd的文，讲的是如何动态生成配置文件的，如今consul官方推出了自己的模板系统，就是consul-template，这样的话动态的配置系统可以分化为etcd+confd和consul+consul-template两大阵营。consul是一个和etcd类似但又强于etcd的系统，关于etcd和consul可以翻阅以前的文章，consul-template的定位就和confd差不多一样了，confd的后端可以是etcd或者consul，相信consul搭配consul-template能发挥更大的效果。consul-template提供了一个便捷的方式从consul中获取存储的值，consul-template守护进程会查询consul实例，来更新系统上指定的任何模板，当更新完成后，模板可以选择运行一些任意的命令。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consul template的使用场景：consul template可以查询consul中的服务目录、key、key-values等。这种强大的抽象功能和查询语言模板可以使consul template特别适合动态的创建配置文件。例如：创建apache/nginx proxy balancers、haproxy backends、varnish servers、application configurations。1</span><br></pre></td></tr></table></figure>

<p>consul template的特性：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">quiescence：consul template内制静止平衡功能，可以智能的发现consul实例中的更改信息。这个功能可以防止频繁的更新模板而引起系统的波动。</span><br><span class="line">dry mode：不确定当前架构的状态？担心模板的变化会破坏子系统？无须担心，因为consul template还有-dry模式。在dry模式，consul template会将结果呈现在STDOUT，所以操作员可以检查输出是否正常，以决定更换模板是否安全</span><br><span class="line">CLI and Config：如果你喜欢在命令行上指定一切，consul template都可以hold住。随着内置HCL的支持，consul template接收一个配置文件，命令行参数，或者两者的混合。通过这种方式你可以继续使用你现在已有的配置管理工具和consul template来配合。</span><br><span class="line">verbose debugging：即使每件事你都做的近乎完美，但是有时候还是会有失败发生。consul template可以提供更详细的debug日志信息。1234</span><br></pre></td></tr></table></figure>

<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>你可以在<a target="_blank" rel="noopener" href="https://releases.hashicorp.com/consul-template/">发布页</a>下载发布包.如果你希望自己编译请查看<a target="_blank" rel="noopener" href="https://github.com/hashicorp/consul-template#contributing">说明文档</a>.</p>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">-auth=&lt;user[:pass]&gt;      设置基本的认证用户名和密码</span><br><span class="line">  -consul-addr=&lt;address&gt;   设置Consul实例的地址</span><br><span class="line">  -max-stale=&lt;duration&gt;    查询过期的最大频率，默认是1s</span><br><span class="line">  -dedup                   启用重复数据删除，当许多consul template实例渲染一个模板的时候可以降低consul的负载</span><br><span class="line">  -ssl                     使用https连接Consul使用SSL</span><br><span class="line">  -ssl-verify              通过SSL连接的时候检查证书</span><br><span class="line">  -ssl-cert                SSL客户端证书发送给服务器</span><br><span class="line">  -ssl-key                 客户端认证时使用的SSL/TLS私钥</span><br><span class="line">  -ssl-ca-cert             验证服务器的CA证书列表</span><br><span class="line">  -token=&lt;token&gt;           设置Consul API的token</span><br><span class="line">  -syslog                  把标准输出和标准错误重定向到syslog，syslog的默认级别是local0。</span><br><span class="line">  -syslog-facility=&lt;f&gt;     设置syslog级别，默认是local0，必须和-syslog配合使用</span><br><span class="line">  -template=&lt;template&gt;     增加一个需要监控的模板，格式是：&#x27;templatePath:outputPath(:command)&#x27;，多个模板则可以设置多次</span><br><span class="line">  -wait=&lt;duration&gt;         当呈现一个新的模板到系统和触发一个命令的时候，等待的最大最小时间。如果最大值被忽略，默认是最小值的4倍。</span><br><span class="line">  -retry=&lt;duration&gt;        当在和consul api交互的返回值是error的时候，等待的时间，默认是5s。</span><br><span class="line">  -config=&lt;path&gt;           配置文件或者配置目录的路径</span><br><span class="line">  -pid-file=&lt;path&gt;         PID文件的路径</span><br><span class="line">  -log-level=&lt;level&gt;       设置日志级别，可以是&quot;debug&quot;,&quot;info&quot;, &quot;warn&quot; (default), and &quot;err&quot;</span><br><span class="line">  -dry                     Dump生成的模板到标准输出，不会生成到磁盘</span><br><span class="line">  -once                    运行consul-template一次后退出，不以守护进程运行</span><br><span class="line">  -reap                    子进程自动收割123456789101112131415161718192021</span><br></pre></td></tr></table></figure>

<p>查看全部选项,使用以下命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consul-template -h1</span><br></pre></td></tr></table></figure>

<h2 id="命令行"><a href="#命令行" class="headerlink" title="命令行"></a>命令行</h2><p>1、查询本地consl实例，生成模板后重启nginx，如果consul不可用，如果api故障则每30s尝试检测一次值，consul-template运行一次后退出</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consul-template -retry 30s -once -consul-addr=10.201.102.198:8500 -template &quot;test.ctmpl:test.out&quot;1</span><br></pre></td></tr></table></figure>

<p>test.ctmpl</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;range service &quot;Faceid&quot;&#125;&#125;</span><br><span class="line">&#123;&#123;.ID&#125;&#125; &#123;&#123;.Address&#125;&#125;:&#123;&#123;.Port&#125;&#125; check inter 5000 fall 1 rise 2 weight 2&#123;&#123;end&#125;&#125;12</span><br></pre></td></tr></table></figure>

<p>test.out</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Faceid 10.201.102.198:9000 check inter 5000 fall 1 rise 2 weight 2</span><br><span class="line">Faceid 10.201.102.199:9000 check inter 5000 fall 1 rise 2 weight 2</span><br><span class="line">Faceid 10.201.102.200:9000 check inter 5000 fall 1 rise 2 weight 2123</span><br></pre></td></tr></table></figure>

<p>2、运行consul-temple作为一个服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consul-template -consul-addr=10.201.102.198:8500 -template &quot;test.ctmpl:test.out&quot;1</span><br></pre></td></tr></table></figure>

<p>3、查询一个实例，渲染多个模板，然后重启相关服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">consul-template -retry 30s -once -consul-addr=10.201.102.198:8500 -template &quot;test.ctmpl:test.out&quot;\</span><br><span class="line"> -template &quot;/tmp/redis.ctmpl:/var/redis/redis.conf:service redis restart&quot; \</span><br><span class="line"> -template &quot;/tmp/haproxy.ctmpl:/var/haproxy/haproxy.conf&quot;123</span><br></pre></td></tr></table></figure>

<p>4、查询一个实例，dump模板到标准输出，参数中的-template则会被忽略</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consul-template -dry -consul-addr=10.201.102.198:8500 -template &quot;test.ctmpl:test.out&quot;1</span><br></pre></td></tr></table></figure>

<p>以上参数除了在命令行使用，也可以直接配置在文件中，下面看看Consul-Template的配置文件，简称HCL(HashiCorp Configuration Language)，它是和JSON兼容的，下面看个例子：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">### 配置文件</span></span></span><br><span class="line">​```Consul-Template```配置文件是使用[HashiCorp Configuration Language (HCL)](https://github.com/hashicorp/hcl)编写的.这意味着```Consul Template```是和JSON兼容的,查看更多信息请查看 [HCL 规范](https://github.com/hashicorp/hcl)</span><br><span class="line">配置文件语法支持上面的所有的选项,除非在表格中进行标明.</span><br><span class="line">​```json</span><br><span class="line">// 这是要连接的Consul Agent的地址.默认为127.0.0.1:8500.这是Consul的默认绑定地址和端口.</span><br><span class="line">// 不建议你直接与 Consul的 Server直接进行交互,请与本地的Consul Agent进行交互.这样做是有一些原因</span><br><span class="line">// 最重要的是本地agent可以复用与server的连接.减少HTTP的连接数.另外这个地址更好记.</span><br><span class="line">consul = &quot;127.0.0.1:8500&quot;</span><br><span class="line">// 这是用于连接Consul的ACL token. 如果你的集群未启用就不需要设置.</span><br><span class="line">//</span><br><span class="line">// 这个选项也可以通过环境变量 CONSUL_TOKEN 来进行设置</span><br><span class="line">token = &quot;abcd1234&quot;</span><br><span class="line">// 这是监听出发reload事件的信号,默认值如下所示.将这个值设置为空将引起 CT ,从而不监听reload事件</span><br><span class="line">reload_signal = &quot;SIGHUP&quot;</span><br><span class="line">// 这是监听出发core dump事件的信号,默认值如下所示.将这个值设置为空将引起 CT ,从而不监听core dump信号</span><br><span class="line">dump_signal = &quot;SIGQUIT&quot;</span><br><span class="line">// 这是监听出发graceful stop事件的信号,默认值如下所示.将这个值设置为空将引起 CT ,从而不监听graceful stop信号</span><br><span class="line">kill_signal = &quot;SIGINT&quot;</span><br><span class="line">// 这是连接Consul的重试时间.Consul Template是高容错的设计.这意味着,出现失败他不会退出.而按照</span><br><span class="line">// 分布式系统的惯例进行指数补偿和重试来等待集群恢复.</span><br><span class="line">retry = &quot;10s&quot;</span><br><span class="line">// This is the maximum interval to allow &quot;stale&quot; data. By default, only the</span><br><span class="line">// Consul leader will respond to queries; any requests to a follower will</span><br><span class="line">// forward to the leader. In large clusters with many requests, this is not as</span><br><span class="line">// scalable, so this option allows any follower to respond to a query, so long</span><br><span class="line">// as the last-replicated data is within these bounds. Higher values result in</span><br><span class="line">// less cluster load, but are more likely to have outdated data.</span><br><span class="line">// 这是允许陈旧数据的最大时间.Consul默认只有领袖对请求进行相应.所有对追随者的请求将被转发给领袖.</span><br><span class="line">// 在有大量请求的大型集群中,这显得不够有扩展性.所以这个选项允许任何追随者响应查询,只要最后复制的数据</span><br><span class="line">// 在这个范围内.数值越高,越减少集群负载,但是更容易接受到过期数据.</span><br><span class="line">max_stale = &quot;10m&quot;</span><br><span class="line">// 这是log的等级,如果你找到了bug,请打开debug 日志,这样我们可以更好的定位问题.这个选项也可用在命令行.</span><br><span class="line">log_level = &quot;warn&quot;</span><br><span class="line">// 这是存放Consul Template 进程的PID文件的路径,如果你计划发送定制的信号到这个进程这会比较有用.</span><br><span class="line">pid_file = &quot;/path/to/pid&quot;</span><br><span class="line">// 这是一个静止定时器,他定义了在模板渲染之前等待集群达到一致状态的最小和最大时间.</span><br><span class="line">// 这对于一些变化较大的系统中比较有用,可以减少模板渲染的次数</span><br><span class="line">wait = &quot;5s:10s&quot;</span><br><span class="line">// 这是 Vault配置的开始</span><br><span class="line">// Vault是HashiCorp的另外一个产品</span><br><span class="line">vault &#123;</span><br><span class="line">  // This is the address of the Vault leader. The protocol (http(s)) portion</span><br><span class="line">  // of the address is required.</span><br><span class="line">  address = &quot;https://vault.service.consul:8200&quot;</span><br><span class="line">  // This is the token to use when communicating with the Vault server.</span><br><span class="line">  // Like other tools that integrate with Vault, Consul Template makes the</span><br><span class="line">  // assumption that you provide it with a Vault token; it does not have the</span><br><span class="line">  // incorporated logic to generate tokens via Vault&#x27;s auth methods.</span><br><span class="line">  //</span><br><span class="line">  // This value can also be specified via the environment variable VAULT_TOKEN.</span><br><span class="line">  token = &quot;abcd1234&quot;</span><br><span class="line">  // This option tells Consul Template to automatically renew the Vault token</span><br><span class="line">  // given. If you are unfamiliar with Vault&#x27;s architecture, Vault requires</span><br><span class="line">  // tokens be renewed at some regular interval or they will be revoked. Consul</span><br><span class="line">  // Template will automatically renew the token at half the lease duration of</span><br><span class="line">  // the token. The default value is true, but this option can be disabled if</span><br><span class="line">  // you want to renew the Vault token using an out-of-band process.</span><br><span class="line">  //</span><br><span class="line">  // Note that secrets specified in a template (using &#123;&#123;secret&#125;&#125; for example)</span><br><span class="line">  // are always renewed, even if this option is set to false. This option only</span><br><span class="line">  // applies to the top-level Vault token itself.</span><br><span class="line">  renew = true</span><br><span class="line">  // This section details the SSL options for connecting to the Vault server.</span><br><span class="line">  // Please see the SSL options below for more information (they are the same).</span><br><span class="line">  ssl &#123;</span><br><span class="line">    // ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">// 这部分配置请求的基本的权限验证信息</span><br><span class="line">auth &#123;</span><br><span class="line">  enabled  = true</span><br><span class="line">  username = &quot;test&quot;</span><br><span class="line">  password = &quot;test&quot;</span><br><span class="line">&#125;</span><br><span class="line">// 这部分配置连接到Consul服务器的SSL信息.</span><br><span class="line">ssl &#123;</span><br><span class="line">  // 使用SSL需要先打开这个开关</span><br><span class="line">  enabled = true</span><br><span class="line">  // This enables SSL peer verification. The default value is &quot;true&quot;, which</span><br><span class="line">  // will check the global CA chain to make sure the given certificates are</span><br><span class="line">  // valid. If you are using a self-signed certificate that you have not added</span><br><span class="line">  // to the CA chain, you may want to disable SSL verification. However, please</span><br><span class="line">  // understand this is a potential security vulnerability.</span><br><span class="line">  verify = false</span><br><span class="line">  // This is the path to the certificate to use to authenticate. If just a</span><br><span class="line">  // certificate is provided, it is assumed to contain both the certificate and</span><br><span class="line">  // the key to convert to an X509 certificate. If both the certificate and</span><br><span class="line">  // key are specified, Consul Template will automatically combine them into an</span><br><span class="line">  // X509 certificate for you.</span><br><span class="line">  cert = &quot;/path/to/client/cert&quot;</span><br><span class="line">  key = &quot;/path/to/client/key&quot;</span><br><span class="line">  // This is the path to the certificate authority to use as a CA. This is</span><br><span class="line">  // useful for self-signed certificates or for organizations using their own</span><br><span class="line">  // internal certificate authority.</span><br><span class="line">  ca_cert = &quot;/path/to/ca&quot;</span><br><span class="line">&#125;</span><br><span class="line">// 设置连接到syslog服务器的配置</span><br><span class="line">// 用于进行日志记录syslog &#123;</span><br><span class="line">  // 打开开关</span><br><span class="line">  enabled = true</span><br><span class="line">  // 设备名称</span><br><span class="line">  facility = &quot;LOCAL5&quot;</span><br><span class="line">&#125;</span><br><span class="line">// This block defines the configuration for de-duplication mode. Please see the</span><br><span class="line">// de-duplication mode documentation later in the README for more information</span><br><span class="line">// on how de-duplication mode operates.</span><br><span class="line">deduplicate &#123;</span><br><span class="line">  // This enables de-duplication mode. Specifying any other options also enables</span><br><span class="line">  // de-duplication mode.</span><br><span class="line">  enabled = true</span><br><span class="line">  // This is the prefix to the path in Consul&#x27;s KV store where de-duplication</span><br><span class="line">  // templates will be pre-rendered and stored.</span><br><span class="line">  prefix = &quot;consul-template/dedup/&quot;</span><br><span class="line">&#125;</span><br><span class="line">// This block defines the configuration for exec mode. Please see the exec mode</span><br><span class="line">// documentation at the bottom of this README for more information on how exec</span><br><span class="line">// mode operates and the caveats of this mode.</span><br><span class="line">exec &#123;</span><br><span class="line">  // This is the command to exec as a child process. There can be only one</span><br><span class="line">  // command per Consul Template process.</span><br><span class="line">  command = &quot;/usr/bin/app&quot;</span><br><span class="line">  // This is a random splay to wait before killing the command. The default</span><br><span class="line">  // value is 0 (no wait), but large clusters should consider setting a splay</span><br><span class="line">  // value to prevent all child processes from reloading at the same time when</span><br><span class="line">  // data changes occur. When this value is set to non-zero, Consul Template</span><br><span class="line">  // will wait a random period of time up to the splay value before reloading</span><br><span class="line">  // or killing the child process. This can be used to prevent the thundering</span><br><span class="line">  // herd problem on applications that do not gracefully reload.</span><br><span class="line">  splay = &quot;5s&quot;</span><br><span class="line">  // This defines the signal that will be sent to the child process when a</span><br><span class="line">  // change occurs in a watched template. The signal will only be sent after</span><br><span class="line">  // the process is started, and the process will only be started after all</span><br><span class="line">  // dependent templates have been rendered at least once. The default value</span><br><span class="line">  // is &quot;&quot; (empty or nil), which tells Consul Template to restart the child</span><br><span class="line">  // process instead of sending it a signal. This is useful for legacy</span><br><span class="line">  // applications or applications that cannot properly reload their</span><br><span class="line">  // configuration without a full reload.</span><br><span class="line">  reload_signal = &quot;SIGUSR1&quot;</span><br><span class="line">  // This defines the signal sent to the child process when Consul Template is</span><br><span class="line">  // gracefully shutting down. The application should begin a graceful cleanup.</span><br><span class="line">  // If the application does not terminate before the `kill_timeout`, it will</span><br><span class="line">  // be terminated (effectively &quot;kill -9&quot;). The default value is &quot;SIGTERM&quot;.</span><br><span class="line">  kill_signal = &quot;SIGINT&quot;</span><br><span class="line">  // This defines the amount of time to wait for the child process to gracefully</span><br><span class="line">  // terminate when Consul Template exits. After this specified time, the child</span><br><span class="line">  // process will be force-killed (effectively &quot;kill -9&quot;). The default value is</span><br><span class="line">  // &quot;30s&quot;.</span><br><span class="line">  kill_timeout = &quot;2s&quot;</span><br><span class="line">&#125;</span><br><span class="line">// 这部分定义了对模板的配置,和其他配置块不同.这部分可以针对不同模板配置多次.也可以在CLI命令</span><br><span class="line">// 直接进行配置</span><br><span class="line">template &#123;</span><br><span class="line">  // 这是输入模板的配置文件路径,必选项</span><br><span class="line">  source = &quot;/path/on/disk/to/template.ctmpl&quot;</span><br><span class="line">  // 这是源模板渲染之后存放的路径,如果父目录不存在Consul Template会尝试进行创建</span><br><span class="line">  destination = &quot;/path/on/disk/where/template/will/render.txt&quot;</span><br><span class="line">  // This is the optional command to run when the template is rendered. The</span><br><span class="line">  // command will only run if the resulting template changes. The command must</span><br><span class="line">  // return within 30s (configurable), and it must have a successful exit code.</span><br><span class="line">  // Consul Template is not a replacement for a process monitor or init system.</span><br><span class="line">  // 这是当模板渲染完成后可选的要执行的命令.这个命令只会在模板发生改变后才会运行.这个命令必须要在30秒</span><br><span class="line">  // 内进行返回(可配置),必须返回一个成功的退出码.Consul Template不能替代进程监视或者init 系统</span><br><span class="line">  // 的功能</span><br><span class="line">  command = &quot;restart service foo&quot;</span><br><span class="line">  // 这是最大的等待命令返回的时间,默认是30秒</span><br><span class="line">  command_timeout = &quot;60s&quot;</span><br><span class="line">  // 这是渲染后的文件的权限,如果不设置,Consul Template将去匹配之前已经存在的文件的权限.</span><br><span class="line">  // 如果文件不存在,权限会被设置为 0644</span><br><span class="line">  perms = 0600</span><br><span class="line">  // 这个选项对渲染之前的文件进行备份.他保持一个备份.</span><br><span class="line">  // 这个选项在发生意外更高时,有一个回滚策略.</span><br><span class="line">  backup = true</span><br><span class="line">  // 模板的分隔符,默认是 &quot;&#123;&#123;&quot;和&quot;&#125;&#125;&quot;.但是对于一些模板用其他的分隔符可能更好</span><br><span class="line">  // 可以避免与本身的冲突</span><br><span class="line">  left_delimiter  = &quot;&#123;&#123;&quot;</span><br><span class="line">  right_delimiter = &quot;&#125;&#125;&quot;</span><br><span class="line">  // 这是最小和最大等待渲染一个新模板和执行命令的时间.使用 分号 个号.如果忽略最大值,最大</span><br><span class="line">  // 值会被设置为最小值的4倍.这个选项没有默认值.这个值相对全局所以的等待时间有最高优先级</span><br><span class="line">  wait = &quot;2s:6s&quot;</span><br><span class="line">&#125;123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>: 不是所有的选项都是必选的.例如: 如果你没有使用Vault你不用设置这一块. 类似的你没有使用syslog系统你也不需要指定syslog配置.</p>
<p>为了更加安全,<code>token</code>也可以从环境变量里读取,使用 <code>CONSUL_TOKEN</code> 和 <code>VAULT_TOKEN</code>.强烈建议你不要把token放到未加密的文本配置文件中.</p>
<h2 id="模版语法"><a href="#模版语法" class="headerlink" title="模版语法"></a>模版语法</h2><p>Consul Template 使用了Go的模板语法.如果你对他的语法不熟悉建议你读下文档.他的语法看起来与 Mustache, Handlebars, 或者 Liquid 类似.</p>
<p>在Go 提供的模板函数之外,Consul Template暴露了以下的函数:</p>
<h2 id="API-函数"><a href="#API-函数" class="headerlink" title="API 函数"></a>API 函数</h2><p><strong>datacenters</strong><br> 查询目录中的所有数据中心.使用以下语法:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;datacenters&#125;&#125;1</span><br></pre></td></tr></table></figure>

<p><strong>file</strong><br> 读取并输出磁盘上的本地文件,如果无法读取产生一个错误.使用如下语法</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;file &quot;/path/to/local/file&quot;&#125;&#125;1</span><br></pre></td></tr></table></figure>

<p>这个例子将输出 <code>/path/to/local/file</code> 文件内容到模板. 注意:这不会在嵌套模板中被处理</p>
<p><strong>key</strong><br> 查询Consul指定key的值,如果key的值不能转换为字符串,将产生错误.使用如下语法:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;key &quot;service/redis/maxconns@east-aws&quot;&#125;&#125;1</span><br></pre></td></tr></table></figure>

<p>上面的例子查询了在<code>east-aws</code>数据中心的 <code>service/redis/maxconns</code>的值.如果忽略数据中心参数,将会查询本地数据中心的值:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;key &quot;service/redis/maxconns&quot;&#125;&#125;1</span><br></pre></td></tr></table></figure>

<p>Consul键值结构的美妙在于,这完全取决于你!</p>
<p><strong>key_or_default</strong><br> 查询Consul中指定的key的值,如果key不存在,则返回默认值.使用方式如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;key_or_default &quot;service/redis/maxconns@east-aws&quot; &quot;5&quot;&#125;&#125;1</span><br></pre></td></tr></table></figure>

<p>注意Consul Template使用了多个阶段的运算.在第一阶段的运算如果Consul没有返回值,则会一直使用默认值.后续模板解析中如果值存在了则会读取真实的值.这很重要,运维Consul Templae不会因为<code>key_or_default</code>没找到key而阻塞模板的的渲染.即使key存在如果Consul没有按时返回这个数据,也会使用默认值来进行替代.</p>
<p><strong>ls</strong><br> 查看Consul的所有以指定前缀开头的key-value对.如果有值无法转换成字符串则会产生一个错误:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;range ls &quot;service/redis@east-aws&quot;&#125;&#125;</span><br><span class="line">&#123;&#123;.Key&#125;&#125; &#123;&#123;.Value&#125;&#125;&#123;&#123;end&#125;&#125;12</span><br></pre></td></tr></table></figure>

<p>如果Consul实例在<code>east-aws</code>数据中心存在这个结构<code>service/redis</code>,渲染后的模板应该类似这样:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">minconns 2</span><br><span class="line">maxconns 1212</span><br></pre></td></tr></table></figure>

<p>如果你忽略数据中心属性,则会返回本地数据中心的查询结果.</p>
<p><strong>node</strong><br> 查询目录中的一个节点信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;node &quot;node1&quot;&#125;&#125;1</span><br></pre></td></tr></table></figure>

<p>如果未指定任何参数,则当前agent所在节点将会被返回:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;node&#125;&#125;1</span><br></pre></td></tr></table></figure>

<p>你可以指定一个可选的参数来指定数据中心:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;node &quot;node1&quot; &quot;@east-aws&quot;&#125;&#125;1</span><br></pre></td></tr></table></figure>

<p>如果指定的节点没有找到则会返回<code>nil</code>.如果节点存在就会列出节点的信息和节点提供的服务.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;with node&#125;&#125;&#123;&#123;.Node.Node&#125;&#125; (&#123;&#123;.Node.Address&#125;&#125;)&#123;&#123;range .Services&#125;&#125;</span><br><span class="line">  &#123;&#123;.Service&#125;&#125; &#123;&#123;.Port&#125;&#125; (&#123;&#123;.Tags | join &quot;,&quot;&#125;&#125;)&#123;&#123;end&#125;&#125;</span><br><span class="line">&#123;&#123;end&#125;&#125;123</span><br></pre></td></tr></table></figure>

<p><strong>nodes</strong><br> 查询目录中的全部节点,使用如下语法</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;nodes&#125;&#125;1</span><br></pre></td></tr></table></figure>

<p>这个例子会查询Consul的默认数据中心.你可以使用可选参数指定一个可选参数来指定数据中心:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;nodes &quot;@east-aws&quot;&#125;&#125;1</span><br></pre></td></tr></table></figure>

<p>这个例子会查询east-aws数据中心的所有几点.</p>
<p><strong>secret</strong><br> 查询<code>Vault</code>中指定路径的密匙.如果指定的路径不存在或者<code>Vault</code>的<code>Token</code>没有足够权限去读取指定的路径,将会产生一个错误.如果路径存在但是key不存在则返回“.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;with secret &quot;secret/passwords&quot;&#125;&#125;&#123;&#123;.Data.password&#125;&#125;&#123;&#123;end&#125;&#125;1</span><br></pre></td></tr></table></figure>

<p>可以使用如下字段:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">LeaseID - the unique lease identifier</span><br><span class="line">LeaseDuration - the number of seconds the lease is valid</span><br><span class="line">Renewable - if the secret is renewable</span><br><span class="line">Data - the raw data - this is a map[string]interface&#123;&#125;, so it can be queried using Go&#x27;s templating &quot;dot notation&quot;</span><br><span class="line">If the map key has dots &quot;.&quot; in it, you need to access the value using the index function:</span><br><span class="line">&#123;&#123;index .Data &quot;my.key.with.dots&quot;&#125;&#125;</span><br><span class="line">If additional arguments are passed to the function, then the operation is assumed to be a write operation instead of a read operation. The write operation must return data in order to be valid. This is especially useful for the PKI secret backend, for example.</span><br><span class="line">&#123;&#123; with secret &quot;pki/issue/my-domain-dot-com&quot; &quot;common_name=foo.example.com&quot; &#125;&#125;</span><br><span class="line">&#123;&#123; .Data.certificate &#125;&#125;</span><br><span class="line">&#123;&#123; end &#125;&#125;</span><br><span class="line">The parameters must be key=value pairs, and each pair must be its own argument to the function:</span><br><span class="line">&#123;&#123; secret &quot;path/&quot; &quot;a=b&quot; &quot;c=d&quot; &quot;e=f&quot; &#125;&#125;</span><br><span class="line">Please always consider the security implications of having the contents of a secret in plain-text on disk. If an attacker is able to get access to the file, they will have access to plain-text secrets.12345678910111213</span><br></pre></td></tr></table></figure>

<p>Please note that Vault does not support blocking queries. As a  result, Consul Template will not immediately reload in the event a  secret is changed as it does with Consul’s key-value store. Consul  Template will fetch a new secret at half the lease duration of the  original secret. For example, most items in Vault’s generic secret  backend have a default 30 day lease. This means Consul Template will  renew the secret every 15 days. As such, it is recommended that a  smaller lease duration be used when generating the initial secret to  force Consul Template to renew more often.</p>
<p><strong>secrets</strong><br> Query Vault to list the secrets at the given path. Please note this  requires Vault 0.5+ and the endpoint you want to list secrets must  support listing. Not all endpoints support listing. The result is the  list of secret names as strings.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;range secrets &quot;secret/&quot;&#125;&#125;&#123;&#123;.&#125;&#125;&#123;&#123;end&#125;&#125;1</span><br></pre></td></tr></table></figure>

<p>The trailing slash is optional in the template, but the generated  secret dependency will always have a trailing slash in log output.</p>
<p>To iterate and list over every secret in the generic secret backend  in Vault, for example, you would need to do something like this:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;range secrets &quot;secret/&quot;&#125;&#125;</span><br><span class="line">&#123;&#123;with secret (printf &quot;secret/%s&quot; .)&#125;&#125;</span><br><span class="line">&#123;&#123;range $k, $v := .Data&#125;&#125;</span><br><span class="line">&#123;&#123;$k&#125;&#125;: &#123;&#123;$v&#125;&#125;</span><br><span class="line">&#123;&#123;end&#125;&#125;</span><br><span class="line">&#123;&#123;end&#125;&#125;</span><br><span class="line">&#123;&#123;end&#125;&#125;1234567</span><br></pre></td></tr></table></figure>

<p>You should probably never do this. Please also note that Vault does  not support blocking queries. To understand the implications, please  read the note at the end of the secret function.</p>
<p><strong>service</strong><br> 查询Consul中匹配表达式的服务.语法如下:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;service &quot;release.web@east-aws&quot;&#125;&#125;1</span><br></pre></td></tr></table></figure>

<p>上面的例子查询Consul中,在<code>east-aws</code>数据中心存在的健康的 <code>web</code>服务.tag和数据中心参数是可选的.从当前数据中心查询所有节点的<code>web</code>服务而不管tag,查询语法如下:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;service &quot;web&quot;&#125;&#125;1</span><br></pre></td></tr></table></figure>

<p>这个函数返回<code>[]*HealthService</code>结构.可按照如下方式应用到模板:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;range service &quot;web@data center&quot;&#125;&#125;</span><br><span class="line">server &#123;&#123;.Name&#125;&#125; &#123;&#123;.Address&#125;&#125;:&#123;&#123;.Port&#125;&#125;&#123;&#123;end&#125;&#125;12</span><br></pre></td></tr></table></figure>

<p>产生如下输出:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">server nyc_web_01 123.456.789.10:8080</span><br><span class="line">server nyc_web_02 456.789.101.213:808012</span><br></pre></td></tr></table></figure>

<p>默认值会返回健康的服务,如果你想获取所有服务,可以增加<code>any</code>选项,如下:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;service &quot;web&quot; &quot;any&quot;&#125;&#125;1</span><br></pre></td></tr></table></figure>

<p>这样就会返回注册过的所有服务,而不论他的状态如何.</p>
<p>如果你想过滤指定的一个或者多个健康状态,你可以通过逗号隔开多个健康状态:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;service &quot;web&quot; &quot;passing, warning&quot;&#125;&#125;1</span><br></pre></td></tr></table></figure>

<p>这样将会返回被他们的节点和服务级别的检查定义标记为 “passing” 或者 “warning”的服务. 请注意逗号是 <code>OR</code>而不是<code>AND</code>的意思.</p>
<p>指定了超过一个状态过滤,并包含<code>any</code>将会返回一个错误.因为<code>any</code>是比所有状态更高级的过滤.</p>
<p>后面这2种方式有些架构上的不同:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;service &quot;web&quot;&#125;&#125;</span><br><span class="line">&#123;&#123;service &quot;web&quot; &quot;passing&quot;&#125;&#125;12</span><br></pre></td></tr></table></figure>

<p>前者会返回Consul认为<code>healthy</code>和<code>passing</code>的所有服务.后者将返回所有已经在Consul注册的服务.然后会执行一个客户端的过滤.通常如果你想获取健康的服务,你应该不要使用<code>passing</code>参数,直接忽略第三个参数即可.然而第三个参数在你想查询 passing或者<code>warning</code>的服务会比较有用,如下:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;service &quot;web&quot; &quot;passing, warning&quot;&#125;&#125;1</span><br></pre></td></tr></table></figure>

<p>服务的状态也是可见的,如果你想自己做一些额外的过滤,语法如下:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;range service &quot;web&quot; &quot;any&quot;&#125;&#125;</span><br><span class="line">&#123;&#123;if eq .Status &quot;critical&quot;&#125;&#125;</span><br><span class="line">// Critical state!&#123;&#123;end&#125;&#125;</span><br><span class="line">&#123;&#123;if eq .Status &quot;passing&quot;&#125;&#125;</span><br><span class="line">// Ok&#123;&#123;end&#125;&#125;12345</span><br></pre></td></tr></table></figure>

<p>执行命令时,在Consul将服务设置为维护模式,只需要在你的命令上包上Consul的 <code>maint</code> 调用:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line">set -e</span><br><span class="line">consul maint -enable -service web -reason &quot;Consul Template updated&quot;</span><br><span class="line">service nginx reload</span><br><span class="line">consul maint -disable -service web12345</span><br></pre></td></tr></table></figure>

<p>另外如果你没有安装Consul agent,你可以直接调用API请求:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line">set -e</span><br><span class="line">curl -X PUT &quot;http://$CONSUL_HTTP_ADDR/v1/agent/service/maintenance/web?enable=true&amp;reason=Consul+Template+Updated&quot;</span><br><span class="line">service nginx reload</span><br><span class="line">curl -X PUT &quot;http://$CONSUL_HTTP_ADDR/v1/agent/service/maintenance/web?enable=false&quot;12345</span><br></pre></td></tr></table></figure>

<p><strong>services</strong><br> 查询Consul目录中的所有服务,使用如下语法:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;services&#125;&#125;1</span><br></pre></td></tr></table></figure>

<p>这个例子将查询Consul的默认数据中心,你可以指定一个可选参数来指定数据中心:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;services &quot;@east-aws&quot;&#125;&#125;1</span><br></pre></td></tr></table></figure>

<p>请注意: services函数与service是不同的,service接受更多参数并且查询监控的服务列表.这个查询Consul目录并返回一个服务的tag的Map,如下:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;range services&#125;&#125;</span><br><span class="line">&#123;&#123;.Name&#125;&#125;</span><br><span class="line">&#123;&#123;range .Tags&#125;&#125;</span><br><span class="line">  &#123;&#123;.&#125;&#125;&#123;&#123;end&#125;&#125;</span><br><span class="line">&#123;&#123;end&#125;&#125;12345</span><br></pre></td></tr></table></figure>

<p><strong>tree</strong><br> 查询所有指定前缀的key-value值对,如果其中的值有无法转换为字符串的则引发错误:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;range tree &quot;service/redis@east-aws&quot;&#125;&#125;</span><br><span class="line">&#123;&#123;.Key&#125;&#125; &#123;&#123;.Value&#125;&#125;&#123;&#123;end&#125;&#125;12</span><br></pre></td></tr></table></figure>

<p>如果Consul实例在<code>east-aws</code>数据中心有一个<code>service/redis</code>结构,模板的渲染结果类似下面:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">minconns 2</span><br><span class="line">maxconns 12</span><br><span class="line">nested/config/value &quot;value&quot;123</span><br></pre></td></tr></table></figure>

<p>和<code>ls</code>不同,<code>tree</code>返回前缀下的所有key.和Unix的tree命令比较像.如果忽略数据中心参数,则会使用本地数据中心</p>
<p><a target="_blank" rel="noopener" href="https://book-consul-guide.vnzmi.com/11_consul_template.html">查看更多</a></p>
<p><a target="_blank" rel="noopener" href="https://book-consul-guide.vnzmi.com/11_consul_template.html">项目Github地址</a></p>
<h2 id="Haproxy-实例"><a href="#Haproxy-实例" class="headerlink" title="Haproxy 实例"></a>Haproxy 实例</h2><p>根据haproxy服务的配置文件创建一个consul-template模版渲染文件：<code>haproxy.ctmpl</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Consul Haproxy configured</span></span><br><span class="line">global</span><br><span class="line">        maxconn         20480</span><br><span class="line">        ulimit-n        65535</span><br><span class="line">        log             127.0.0.1 local5</span><br><span class="line">        uid             200</span><br><span class="line">        gid             200</span><br><span class="line">        chroot          /usr/local/haproxy</span><br><span class="line">        nbproc          1</span><br><span class="line">        daemon</span><br><span class="line">        pidfile         /usr/local/haproxy/logs/haproxy.pid</span><br><span class="line">defaults</span><br><span class="line">        log             global</span><br><span class="line">        mode            http</span><br><span class="line">        option          httplog</span><br><span class="line">        option          dontlognull</span><br><span class="line">        option          forwardfor</span><br><span class="line">        option          abortonclose</span><br><span class="line">        retries         3</span><br><span class="line">        maxconn         3000</span><br><span class="line">        stats           enable</span><br><span class="line">        stats           hide-version</span><br><span class="line">        stats   uri     /admin</span><br><span class="line">        stats   auth    admin:admin</span><br><span class="line">        stats   refresh 10s</span><br><span class="line">        balance         roundrobin</span><br><span class="line">        timeout connect 5000ms</span><br><span class="line">        timeout client 50000ms</span><br><span class="line">        timeout server 50000ms</span><br><span class="line">        timeout check 2000ms</span><br><span class="line">listen web_haproxy</span><br><span class="line">        bind 0.0.0.0:8080</span><br><span class="line">        mode http</span><br><span class="line">        log     127.0.0.1 local5 err</span><br><span class="line">        stats   refresh 5s</span><br><span class="line">        stats   uri /admin</span><br><span class="line">        stats   realm liang lian</span><br><span class="line">        stats   auth admin:admin</span><br><span class="line">        stats   hide-version</span><br><span class="line">        stats   admin if TRUE</span><br><span class="line">frontend consul</span><br><span class="line">        bind    0.0.0.0:8500</span><br><span class="line">        mode    http</span><br><span class="line">        log     global</span><br><span class="line">        default_backend consul-cluster</span><br><span class="line">backend consul-cluster</span><br><span class="line">        mode http</span><br><span class="line">        &#123;&#123;range service &quot;Faceid&quot;&#125;&#125;</span><br><span class="line">        server &#123;&#123;.ID&#125;&#125; &#123;&#123;.Address&#125;&#125;:&#123;&#123;.Port&#125;&#125; check inter 5000 fall 1 rise 2 weight 2&#123;&#123;end&#125;&#125;12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849</span><br></pre></td></tr></table></figure>

<p>运行consul-template作为一个服务,通过上面的渲染模版渲染一个haproxy.cfg的配置文件，然后重启haproxy服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consul-template -consul-addr=10.201.102.185:8500 -template &quot;/root/haproxy.ctmpl:/etc/haproxy.cfg:service haproxy restart&quot;1</span><br></pre></td></tr></table></figure>

<p>10.201.102.185 看我上篇文章<a target="_blank" rel="noopener" href="http://www.liangxiansen.cn/2017/03/06/haproxy/">Haproxy</a>，这是consul集群的VIP，为了避免单独调某一台服务器服务器出现故障后consul-template无法工作。</p>
<p>渲染后的<code>haproxy.cfg</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Consul Haproxy configured</span></span><br><span class="line">global</span><br><span class="line">        maxconn         20480</span><br><span class="line">        ulimit-n        65535</span><br><span class="line">        log             127.0.0.1 local5</span><br><span class="line">        uid             200</span><br><span class="line">        gid             200</span><br><span class="line">        chroot          /usr/local/haproxy</span><br><span class="line">        nbproc          1</span><br><span class="line">        daemon</span><br><span class="line">        pidfile         /usr/local/haproxy/logs/haproxy.pid</span><br><span class="line">defaults</span><br><span class="line">        log             global</span><br><span class="line">        mode            http</span><br><span class="line">        option          httplog</span><br><span class="line">        option          dontlognull</span><br><span class="line">        option          forwardfor</span><br><span class="line">        option          abortonclose</span><br><span class="line">        retries         3</span><br><span class="line">        maxconn         3000</span><br><span class="line">        stats           enable</span><br><span class="line">        stats           hide-version</span><br><span class="line">        stats   uri     /admin</span><br><span class="line">        stats   auth    admin:admin</span><br><span class="line">        stats   refresh 10s</span><br><span class="line">        balance         roundrobin</span><br><span class="line">        timeout connect 5000ms</span><br><span class="line">        timeout client 50000ms</span><br><span class="line">        timeout server 50000ms</span><br><span class="line">        timeout check 2000ms</span><br><span class="line">listen web_haproxy</span><br><span class="line">        bind 0.0.0.0:8080</span><br><span class="line">        mode http</span><br><span class="line">        log     127.0.0.1 local5 err</span><br><span class="line">        stats   refresh 5s</span><br><span class="line">        stats   uri /admin</span><br><span class="line">        stats   realm liang lian</span><br><span class="line">        stats   auth admin:admin</span><br><span class="line">        stats   hide-version</span><br><span class="line">        stats   admin if TRUE</span><br><span class="line">frontend consul</span><br><span class="line">        bind    0.0.0.0:8500</span><br><span class="line">        mode    http</span><br><span class="line">        log     global</span><br><span class="line">        default_backend consul-cluster</span><br><span class="line">backend consul-cluster</span><br><span class="line">        mode http</span><br><span class="line">        server Faceid 10.201.102.198:9000 check inter 5000 fall 1 rise 2 weight 2</span><br><span class="line">        server Faceid 10.201.102.199:9000 check inter 5000 fall 1 rise 2 weight 2</span><br><span class="line">        server Faceid 10.201.102.200:9000 check inter 5000 fall 1 rise 2 weight 21234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950</span><br></pre></td></tr></table></figure>

<p>整个就是搭建consul集群，平台中的服务会注册到consul集群中，haproxy避免consul-template调consul时出现单点故障consul-template无法工作做的高可用，Consul-template就是能在整个平台的各个系统和应用中使用，查询consul集群来获取平台上各个应用的存活状态和IP。</p>
<p>整套下来实现了两个重点：</p>
<p>实现了中心服务注册查询<br>平台中其他节点的查询服务和配置文件自动更新</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a target="_blank" rel="noopener" href="https://my.oschina.net/guol/blog/675281">https://my.oschina.net/guol/blog/675281</a> </p>
<p><a target="_blank" rel="noopener" href="https://www.consul.io/docs/guides/index.html">https://www.consul.io/docs/guides/index.html</a> </p>
<p><a target="_blank" rel="noopener" href="https://www.gitbook.com/book/vincentmi/consul-guide/details">https://www.gitbook.com/book/vincentmi/consul-guide/details</a></p>
<p><a target="_blank" rel="noopener" href="https://my.oschina.net/abcfy2/blog/675665">https://my.oschina.net/abcfy2/blog/675665</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://wangyyovo.github.io">Blank</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://wangyyovo.github.io/posts/6ab3229c/">https://wangyyovo.github.io/posts/6ab3229c/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://wangyyovo.github.io" target="_blank">Blank</a>！</span></div></div><div class="tag_share"><div class="post-share"><div class="social-share" data-image="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/cover/consul/7d0e1704af4e9eed516ba20ec9133112.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://jsd.012700.xyz/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://jsd.012700.xyz/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/4a17b156/" title="Hello World"><img class="cover" src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/cover/other/729ec1c3071758c9cf65c190cf68801d.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">Hello World</div></div><div class="info-2"><div class="info-item-1"> Welcome to note   Welcome to Hexo! This is your very first post. Check documentation for more info. If you get any problems when using Hexo, you can find the answer in troubleshooting or you can ask me on GitHub. Quick StartCreate a new post1$ hexo new &quot;My New Post&quot;  More info: Writing Run server1$ hexo server  More info: Server Generate static files1$ hexo generate  More info: Generating Deploy to remote sites1$ hexo deploy  More info: Deployment </div></div></div></a><a class="pagination-related" href="/posts/bfc2ca32/" title="consul"><img class="cover" src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/cover/consul/19e8db84b9cccfc9a8f4636230c25cc6.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">consul</div></div><div class="info-2"><div class="info-item-1"> Consul常用命令 agent 运行一个consul agent consul agent -dev  join 将agent加入到consul集群 consul join IP  members 列出consul cluster集群中的members consul members  leave 将节点移除所在集群 consul leave   Consul agent 命令详解输入consul agent --help ，可以看到consul agent 的选项 consul agent 命令的常用选项，如下：  -data-dir 作用：指定agent储存状态的数据目录 这是所有agent都必须的 对于server尤其重要，因为他们必须持久化集群的状态   -config-dir 作用：指定service的配置文件和检查定义所在的位置 通常会指定为”某一个路径&#x2F;consul.d”（通常情况下，.d表示一系列配置文件存放的目录）   -config-file 作用：指定一个要装载的配置文件 该选项可以配置多次，进而配置多个配置文件（后边的会合并前边的，相同的值覆盖...</div></div></div></a></nav><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/theme/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Blank</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">352</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">46</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">58</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>主题 GitHub</span></a><div class="card-info-social-icons"><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fas fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#consul%E4%BD%BF%E7%94%A8%E6%89%8B%E5%86%8C"><span class="toc-number">1.</span> <span class="toc-text">consul使用手册</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.1.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E6%9E%B6%E6%9E%84"><span class="toc-number">1.2.</span> <span class="toc-text">基础架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85Consul"><span class="toc-number">1.3.</span> <span class="toc-text">安装Consul</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E5%AE%89%E8%A3%85"><span class="toc-number">1.4.</span> <span class="toc-text">验证安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%90%E8%A1%8CAgent"><span class="toc-number">1.5.</span> <span class="toc-text">运行Agent</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8-Consul-Server"><span class="toc-number">1.6.</span> <span class="toc-text">启动 Consul Server</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8-Consul-Client"><span class="toc-number">1.7.</span> <span class="toc-text">启动 Consul Client</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%81%9C%E6%AD%A2Agent"><span class="toc-number">1.8.</span> <span class="toc-text">停止Agent</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.9.</span> <span class="toc-text">更新服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.10.</span> <span class="toc-text">查询服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#WEB%E7%AE%A1%E7%90%86%E7%95%8C%E9%9D%A2"><span class="toc-number">1.11.</span> <span class="toc-text">WEB管理界面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5"><span class="toc-number">1.12.</span> <span class="toc-text">健康检查</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E5%81%A5%E5%BA%B7%E7%8A%B6%E6%80%81"><span class="toc-number">1.13.</span> <span class="toc-text">检查健康状态</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#K-%EF%BC%8FV"><span class="toc-number">1.14.</span> <span class="toc-text">K ／V</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Conusl-%E5%91%BD%E4%BB%A4%E8%A1%8C"><span class="toc-number">2.</span> <span class="toc-text">Conusl 命令行</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Agent"><span class="toc-number">2.1.</span> <span class="toc-text">Agent</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#event"><span class="toc-number">2.2.</span> <span class="toc-text">event</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exec"><span class="toc-number">2.3.</span> <span class="toc-text">exec</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#force-leave"><span class="toc-number">2.4.</span> <span class="toc-text">force-leave</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#info"><span class="toc-number">2.5.</span> <span class="toc-text">info</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#join"><span class="toc-number">2.6.</span> <span class="toc-text">join</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#keygen"><span class="toc-number">2.7.</span> <span class="toc-text">keygen</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#leave"><span class="toc-number">2.8.</span> <span class="toc-text">leave</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#members"><span class="toc-number">2.9.</span> <span class="toc-text">members</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#monitor"><span class="toc-number">2.10.</span> <span class="toc-text">monitor</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#reload"><span class="toc-number">2.11.</span> <span class="toc-text">reload</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#version"><span class="toc-number">2.12.</span> <span class="toc-text">version</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#watch"><span class="toc-number">2.13.</span> <span class="toc-text">watch</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Consul-%E9%85%8D%E7%BD%AE"><span class="toc-number">3.</span> <span class="toc-text">Consul 配置</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#HTTP-API"><span class="toc-number">4.</span> <span class="toc-text">HTTP API</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#agent"><span class="toc-number">4.1.</span> <span class="toc-text">agent</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#catalog"><span class="toc-number">4.2.</span> <span class="toc-text">catalog</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#health"><span class="toc-number">4.3.</span> <span class="toc-text">health</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#session"><span class="toc-number">4.4.</span> <span class="toc-text">session</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#acl"><span class="toc-number">4.5.</span> <span class="toc-text">acl</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#event-1"><span class="toc-number">4.6.</span> <span class="toc-text">event</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#status"><span class="toc-number">4.7.</span> <span class="toc-text">status</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Consul-Template"><span class="toc-number">5.</span> <span class="toc-text">Consul-Template</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-number">5.1.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8"><span class="toc-number">5.2.</span> <span class="toc-text">使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E8%A1%8C"><span class="toc-number">5.3.</span> <span class="toc-text">命令行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%A1%E7%89%88%E8%AF%AD%E6%B3%95"><span class="toc-number">5.4.</span> <span class="toc-text">模版语法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#API-%E5%87%BD%E6%95%B0"><span class="toc-number">5.5.</span> <span class="toc-text">API 函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Haproxy-%E5%AE%9E%E4%BE%8B"><span class="toc-number">5.6.</span> <span class="toc-text">Haproxy 实例</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">6.</span> <span class="toc-text">参考资料</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/d14168d/" title="虚拟机问题合集"><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/cover/hexo/090cfe4e9e60b0ad0de05db822f3ae97.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="虚拟机问题合集"/></a><div class="content"><a class="title" href="/posts/d14168d/" title="虚拟机问题合集">虚拟机问题合集</a><time datetime="2022-07-16T13:30:36.000Z" title="发表于 2022-07-16 21:30:36">2022-07-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/f540045f/" title="用go语言编写移动端sdk和app开发"><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/cover/golang/941ed1ec2925719a0c92e76f4f786b6a.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="用go语言编写移动端sdk和app开发"/></a><div class="content"><a class="title" href="/posts/f540045f/" title="用go语言编写移动端sdk和app开发">用go语言编写移动端sdk和app开发</a><time datetime="2022-07-04T12:14:21.000Z" title="发表于 2022-07-04 20:14:21">2022-07-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/5faac006/" title="在线编程IDE"><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/cover/hexo/090cfe4e9e60b0ad0de05db822f3ae97.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="在线编程IDE"/></a><div class="content"><a class="title" href="/posts/5faac006/" title="在线编程IDE">在线编程IDE</a><time datetime="2022-06-12T13:30:36.000Z" title="发表于 2022-06-12 21:30:36">2022-06-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/7594185d/" title="即时性能分析工具Pyroscope"><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/cover/golang/3bfb3279740bc9a5b5ef436fa887ef07.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="即时性能分析工具Pyroscope"/></a><div class="content"><a class="title" href="/posts/7594185d/" title="即时性能分析工具Pyroscope">即时性能分析工具Pyroscope</a><time datetime="2022-06-12T08:07:36.000Z" title="发表于 2022-06-12 16:07:36">2022-06-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/82a7aa7c/" title="golang性能调试优化方法"><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/cover/common/3.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="golang性能调试优化方法"/></a><div class="content"><a class="title" href="/posts/82a7aa7c/" title="golang性能调试优化方法">golang性能调试优化方法</a><time datetime="2022-06-12T03:00:36.000Z" title="发表于 2022-06-12 11:00:36">2022-06-12</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 By Blank</span><span class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 5.4.2</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.4.3</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://jsd.012700.xyz/npm/hexo-theme-butterfly/source/js/utils.min.js"></script><script src="https://jsd.012700.xyz/npm/hexo-theme-butterfly/source/js/main.min.js"></script><script src="https://jsd.012700.xyz/npm/hexo-theme-butterfly/source/js/tw_cn.min.js"></script><div class="js-pjax"><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = {"placeholder":"请留下你的脚印","pageSize":10,"lang":"zh-CN","requiredFields":["nick","mail","link"]}

  const initValine = (el, path) => {
    if (isShuoshuo) {
      window.shuoshuoComment.destroyValine = () => {
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }

    const valineConfig = {
      el: '#vcomment',
      appId: 'BSfgwCPLOvPHVPaSoBCGSENf-MdYXbMMI',
      appKey: '2Q8qq5060qxycL6FPL26LnMG',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      visitor: false,
      ...option,
      path: isShuoshuo ? path : (option && option.path) || window.location.pathname
    }

    new Valine(valineConfig)
  }

  const loadValine = async (el, path) => {
    if (typeof Valine === 'function') {
      initValine(el, path)
    } else {
      await btf.getScript('https://jsd.012700.xyz/npm/valine/dist/Valine.min.js')
      initValine(el, path)
    }
  }

  if (isShuoshuo) {
    'Valine' === 'Valine'
      ? window.shuoshuoComment = { loadComment: loadValine }
      : window.loadOtherComment = loadValine
    return
  }

  if ('Valine' === 'Valine' || !false) {
    if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="https://jsd.012700.xyz/npm/hexo-theme-butterfly/source/js/search/local-search.min.js"></script></div></div></body></html>