<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Etcd的简单使用 | Blank</title><meta name="author" content="Blank"><meta name="copyright" content="Blank"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="https:&#x2F;&#x2F;github.com&#x2F;etcd-io&#x2F;etcd&#x2F;releases  Etcd的简单使用API V2与V3区别 事务：ETCD V3提供了多键条件事务（multi-key conditional transactions），应用各种需要使用事务代替原来的Compare-And-Swap操作。 平键空间（Flat key space）：ETCD V3不再使用目录结构，只保留键。例如">
<meta property="og:type" content="article">
<meta property="og:title" content="Etcd的简单使用">
<meta property="og:url" content="https://wangyyovo.github.io/posts/5baaccef/">
<meta property="og:site_name" content="Blank">
<meta property="og:description" content="https:&#x2F;&#x2F;github.com&#x2F;etcd-io&#x2F;etcd&#x2F;releases  Etcd的简单使用API V2与V3区别 事务：ETCD V3提供了多键条件事务（multi-key conditional transactions），应用各种需要使用事务代替原来的Compare-And-Swap操作。 平键空间（Flat key space）：ETCD V3不再使用目录结构，只保留键。例如">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/etcd/85724a45f3babbdb451f3ef24d36a303.jpg">
<meta property="article:published_time" content="2019-10-31T08:00:36.000Z">
<meta property="article:modified_time" content="2019-10-31T08:00:36.000Z">
<meta property="article:author" content="Blank">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/etcd/85724a45f3babbdb451f3ef24d36a303.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Etcd的简单使用",
  "url": "https://wangyyovo.github.io/posts/5baaccef/",
  "image": "https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/etcd/85724a45f3babbdb451f3ef24d36a303.jpg",
  "datePublished": "2019-10-31T08:00:36.000Z",
  "dateModified": "2019-10-31T08:00:36.000Z",
  "author": [
    {
      "@type": "Person",
      "name": "Blank",
      "url": "https://wangyyovo.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/theme/favicon.ico"><link rel="canonical" href="https://wangyyovo.github.io/posts/5baaccef/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":400,"highlightFullpage":true,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":150,"languages":{"author":"作者: Blank","link":"链接: ","source":"来源: Blank","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Etcd的简单使用',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="alternate" href="/atom.xml" title="Blank" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/theme/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">352</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">46</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">58</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fas fa-comment-dots"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 娱乐</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-image"></i><span> 相册</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-book"></i><span> 教程</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/posts/21cfbf15/"><span> 🚀 快速開始</span></a></li><li><a class="site-page child" href="/posts/dc584b87/"><span> 📑 主題頁面</span></a></li><li><a class="site-page child" href="/posts/4aa8abbe/"><span> 🛠 主題配置</span></a></li><li><a class="site-page child" href="/posts/ceeb73f/"><span> ⚔️ 標簽外挂</span></a></li><li><a class="site-page child" href="/posts/98d20436/"><span> ❓ 主題問答</span></a></li><li><a class="site-page child" href="/posts/4073eda/"><span> ⚡️ 進階教程</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-language"></i><span> 语言</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/"><i class="fa-fw fas fa-c"></i><span> 中文</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/etcd/85724a45f3babbdb451f3ef24d36a303.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Blank</span></a><a class="nav-page-title" href="/"><span class="site-name">Etcd的简单使用</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fas fa-comment-dots"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 娱乐</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-image"></i><span> 相册</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-book"></i><span> 教程</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/posts/21cfbf15/"><span> 🚀 快速開始</span></a></li><li><a class="site-page child" href="/posts/dc584b87/"><span> 📑 主題頁面</span></a></li><li><a class="site-page child" href="/posts/4aa8abbe/"><span> 🛠 主題配置</span></a></li><li><a class="site-page child" href="/posts/ceeb73f/"><span> ⚔️ 標簽外挂</span></a></li><li><a class="site-page child" href="/posts/98d20436/"><span> ❓ 主題問答</span></a></li><li><a class="site-page child" href="/posts/4073eda/"><span> ⚡️ 進階教程</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-language"></i><span> 语言</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/"><i class="fa-fw fas fa-c"></i><span> 中文</span></a></li></ul></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Etcd的简单使用</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2019-10-31T08:00:36.000Z" title="发表于 2019-10-31 16:00:36">2019-10-31</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2019-10-31T08:00:36.000Z" title="更新于 2019-10-31 16:00:36">2019-10-31</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/microservice/">microservice</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/microservice/etcd/">etcd</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">5.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>30分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><script src="\assets\js\APlayer.min.js"> </script><blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/etcd-io/etcd/releases">https://github.com/etcd-io/etcd/releases</a></p>
</blockquote>
<h1 id="Etcd的简单使用"><a href="#Etcd的简单使用" class="headerlink" title="Etcd的简单使用"></a>Etcd的简单使用</h1><h2 id="API-V2与V3区别"><a href="#API-V2与V3区别" class="headerlink" title="API V2与V3区别"></a>API V2与V3区别</h2><ul>
<li>事务：ETCD V3提供了多键条件事务（multi-key conditional transactions），应用各种需要使用事务代替原来的Compare-And-Swap操作。</li>
<li>平键空间（Flat key space）：ETCD V3不再使用目录结构，只保留键。例如：”&#x2F;a&#x2F;b&#x2F;c&#x2F;“是一个键，而不是目录。V3中提供了前缀查询，来获取符合前缀条件的所有键值，这变向实现了V2中查询一个目录下所有子目录和节点的功能。</li>
<li>简洁的响应：像DELETE这类操作成功后将不再返回操作前的值。如果希望获得删除前的值，可以使用事务，来实现一个原子操作，先获取键值，然后再删除。</li>
<li>租约：租约代替了V2中的TTL实现，TTL绑定到一个租约上，键再附加到这个租约上。当TTL过期时，租约将被销毁，同时附加到这个租约上的键也被删除。</li>
</ul>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>手动安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">WORKSPACE=/etcd</span><br><span class="line">ETCD_DIR=etcd</span><br><span class="line">ETCD_VER=v3.4.3</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">choose either URL</span></span><br><span class="line">GOOGLE_URL=https://storage.googleapis.com/etcd</span><br><span class="line">GITHUB_URL=https://github.com/etcd-io/etcd/releases/download</span><br><span class="line">DOWNLOAD_URL=$&#123;GOOGLE_URL&#125;</span><br><span class="line"></span><br><span class="line">rm -f $&#123;WORKSPACE&#125;/etcd-$&#123;ETCD_VER&#125;-linux-amd64.tar.gz</span><br><span class="line">rm -rf $&#123;WORKSPACE&#125;/$&#123;ETCD_DIR&#125; &amp;&amp; mkdir -p $&#123;WORKSPACE&#125;/$&#123;ETCD_DIR&#125;</span><br><span class="line"></span><br><span class="line">curl -L $&#123;DOWNLOAD_URL&#125;/$&#123;ETCD_VER&#125;/etcd-$&#123;ETCD_VER&#125;-linux-amd64.tar.gz -o $&#123;WORKSPACE&#125;/etcd-$&#123;ETCD_VER&#125;-linux-amd64.tar.gz</span><br><span class="line">tar xzvf $&#123;WORKSPACE&#125;/etcd-$&#123;ETCD_VER&#125;-linux-amd64.tar.gz -C $&#123;WORKSPACE&#125;/$&#123;ETCD_DIR&#125; --strip-components=1</span><br><span class="line">rm -f $&#123;WORKSPACE&#125;/etcd-$&#123;ETCD_VER&#125;-linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">/etcd/etcd/etcd --version</span><br><span class="line">/etcd/etcd/etcdctl version</span><br></pre></td></tr></table></figure>

<p>需要翻墙</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">rm -rf /tmp/etcd-data.tmp &amp;&amp; mkdir -p /tmp/etcd-data.tmp &amp;&amp; \</span><br><span class="line">  docker rmi gcr.io/etcd-development/etcd:v3.4.3 || true &amp;&amp; \</span><br><span class="line">  docker run \</span><br><span class="line">  -p 2379:2379 \</span><br><span class="line">  -p 2380:2380 \</span><br><span class="line">  --mount type=bind,source=/tmp/etcd-data.tmp,destination=/etcd-data \</span><br><span class="line">  --name etcd-gcr-v3.4.3 \</span><br><span class="line">  gcr.io/etcd-development/etcd:v3.4.3 \</span><br><span class="line">  /usr/local/bin/etcd \</span><br><span class="line">  --name s1 \</span><br><span class="line">  --data-dir /etcd-data \</span><br><span class="line">  --listen-client-urls http://0.0.0.0:2379 \</span><br><span class="line">  --advertise-client-urls http://0.0.0.0:2379 \</span><br><span class="line">  --listen-peer-urls http://0.0.0.0:2380 \</span><br><span class="line">  --initial-advertise-peer-urls http://0.0.0.0:2380 \</span><br><span class="line">  --initial-cluster s1=http://0.0.0.0:2380 \</span><br><span class="line">  --initial-cluster-token tkn \</span><br><span class="line">  --initial-cluster-state new \</span><br><span class="line">  --log-level info \</span><br><span class="line">  --logger zap \</span><br><span class="line">  --log-outputs stderr</span><br><span class="line"></span><br><span class="line">docker exec etcd-gcr-v3.4.3 /bin/sh -c &quot;/usr/local/bin/etcd --version&quot;</span><br><span class="line">docker exec etcd-gcr-v3.4.3 /bin/sh -c &quot;/usr/local/bin/etcdctl version&quot;</span><br><span class="line">docker exec etcd-gcr-v3.4.3 /bin/sh -c &quot;/usr/local/bin/etcdctl endpoint health&quot;</span><br><span class="line">docker exec etcd-gcr-v3.4.3 /bin/sh -c &quot;/usr/local/bin/etcdctl put foo bar&quot;</span><br><span class="line">docker exec etcd-gcr-v3.4.3 /bin/sh -c &quot;/usr/local/bin/etcdctl get foo&quot;</span><br></pre></td></tr></table></figure>

<h2 id="简单读写"><a href="#简单读写" class="headerlink" title="简单读写"></a>简单读写</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">start a <span class="built_in">local</span> etcd server</span></span><br><span class="line">/etcd/etcd/etcd</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">write,<span class="built_in">read</span> to etcd</span></span><br><span class="line">/etcd/etcd/etcdctl --endpoints=localhost:2379 put foo bar</span><br><span class="line">/etcd/etcd/etcdctl --endpoints=localhost:2379 get foo</span><br></pre></td></tr></table></figure>

<h2 id="Etcd可视化工具"><a href="#Etcd可视化工具" class="headerlink" title="Etcd可视化工具"></a>Etcd可视化工具</h2><p><a target="_blank" rel="noopener" href="https://github.com/shiguanghuxian/etcd-manage">https://github.com/shiguanghuxian/etcd-manage</a> </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cd /etcd/</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下载</span></span><br><span class="line">wget https://github.com/shiguanghuxian/etcd-manage/releases/download/1.1.5/etcd-manage_linux_amd64.zip</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">解压</span></span><br><span class="line">unzip etcd-manage_linux_amd64.zip</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置</span></span><br><span class="line">vi ./config/cfg.toml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">运行</span></span><br><span class="line">./etcd-manage</span><br></pre></td></tr></table></figure>

<h2 id="Etcd单机启动"><a href="#Etcd单机启动" class="headerlink" title="Etcd单机启动"></a>Etcd单机启动</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etcd/etcdrun/data.etcd/</span><br><span class="line">mkdir -p /etcd/etcdrun/log/</span><br><span class="line">cd /etcd/etcdrun/</span><br><span class="line">/etcd/etcd/etcd  --data-dir ./data.etcd/  --listen-client-urls http://localhost:2379 --advertise-client-urls http://localhost:2379 &amp; &gt;./log/etcd.log</span><br></pre></td></tr></table></figure>

<ul>
<li><p>-listen-client-urls</p>
<p>用于指定etcd和客户端的连接端口</p>
</li>
<li><p>-advertise-client-urls</p>
<p>用于指定etcd服务器之间通讯的端口</p>
</li>
</ul>
<p>etcd有要求，如果-listen-client-urls被设置了，那么就必须同时设置-advertise-client-urls，所以即使设置和默认相同，也必须显式设置.</p>
<h2 id="Etcd单机docker-compose"><a href="#Etcd单机docker-compose" class="headerlink" title="Etcd单机docker-compose"></a>Etcd单机docker-compose</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">etcd:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">etcd-s1</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">quay.io/coreos/etcd:v3.5.12</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ETCD_NAME=etcd-s1</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ETCD_DATA_DIR=/var/etcd</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ETCD_ADVERTISE_CLIENT_URLS=http://0.0.0.0:2379</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ETCD_LISTEN_PEER_URLS=http://0.0.0.0:2380</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ETCD_INITIAL_ADVERTISE_PEER_URLS=http://0.0.0.0:2380</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ETCD_INITIAL_CLUSTER_TOKEN=etcd-cluster</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ETCD_INITIAL_CLUSTER=etcd-s1=http://0.0.0.0:2380</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ETCD_INITIAL_CLUSTER_STATE=new</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ETCD_LOGGER=zap</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ETCD_LOG_LeveL=info</span>      </span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/data/etcd:/var/etcd</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;/etc/localtime:/etc/localtime:ro&quot;</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">2379</span><span class="string">:2379</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">2380</span><span class="string">:2380</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">  <span class="attr">etcdkeeper:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">deltaprojects/etcdkeeper</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">etcdkeeper</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8088</span><span class="string">:8080</span></span><br></pre></td></tr></table></figure>





<h2 id="Etcd数据操作"><a href="#Etcd数据操作" class="headerlink" title="Etcd数据操作"></a>Etcd数据操作</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export ETCDCTL_API=3</span><br></pre></td></tr></table></figure>

<h3 id="etcdctl命令"><a href="#etcdctl命令" class="headerlink" title="etcdctl命令"></a>etcdctl命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">COMMANDS:</span><br><span class="line">        alarm disarm            Disarms all alarms</span><br><span class="line">        alarm list              Lists all alarms</span><br><span class="line">        auth disable            Disables authentication</span><br><span class="line">        auth enable             Enables authentication</span><br><span class="line">        check datascale         Check the memory usage of holding data for different workloads on a given server endpoint.</span><br><span class="line">        check perf              Check the performance of the etcd cluster</span><br><span class="line">        compaction              Compacts the event history in etcd</span><br><span class="line">        defrag                  Defragments the storage of the etcd members with given endpoints</span><br><span class="line">        del                     Removes the specified key or range of keys [key, range_end)</span><br><span class="line">        elect                   Observes and participates in leader election</span><br><span class="line">        endpoint hashkv         Prints the KV history hash for each endpoint in --endpoints</span><br><span class="line">        endpoint health         Checks the healthiness of endpoints specified in `--endpoints` flag</span><br><span class="line">        endpoint status         Prints out the status of endpoints specified in `--endpoints` flag</span><br><span class="line">        get                     Gets the key or a range of keys</span><br><span class="line">        help                    Help about any command</span><br><span class="line">        lease grant             Creates leases</span><br><span class="line">        lease keep-alive        Keeps leases alive (renew)</span><br><span class="line">        lease list              List all active leases</span><br><span class="line">        lease revoke            Revokes leases</span><br><span class="line">        lease timetolive        Get lease information</span><br><span class="line">        lock                    Acquires a named lock</span><br><span class="line">        make-mirror             Makes a mirror at the destination etcd cluster</span><br><span class="line">        member add              Adds a member into the cluster</span><br><span class="line">        member list             Lists all members in the cluster</span><br><span class="line">        member promote          Promotes a non-voting member in the cluster</span><br><span class="line">        member remove           Removes a member from the cluster</span><br><span class="line">        member update           Updates a member in the cluster</span><br><span class="line">        migrate                 Migrates keys in a v2 store to a mvcc store</span><br><span class="line">        move-leader             Transfers leadership to another etcd cluster member.</span><br><span class="line">        put                     Puts the given key into the store</span><br><span class="line">        role add                Adds a new role</span><br><span class="line">        role delete             Deletes a role</span><br><span class="line">        role get                Gets detailed information of a role</span><br><span class="line">        role grant-permission   Grants a key to a role</span><br><span class="line">        role list               Lists all roles</span><br><span class="line">        role revoke-permission  Revokes a key from a role</span><br><span class="line">        snapshot restore        Restores an etcd member snapshot to an etcd directory</span><br><span class="line">        snapshot save           Stores an etcd node backend snapshot to a given file</span><br><span class="line">        snapshot status         Gets backend snapshot status of a given file</span><br><span class="line">        txn                     Txn processes all the requests in one transaction</span><br><span class="line">        user add                Adds a new user</span><br><span class="line">        user delete             Deletes a user</span><br><span class="line">        user get                Gets detailed information of a user</span><br><span class="line">        user grant-role         Grants a role to a user</span><br><span class="line">        user list               Lists all users</span><br><span class="line">        user passwd             Changes password of user</span><br><span class="line">        user revoke-role        Revokes a role from a user</span><br><span class="line">        version                 Prints the version of etcdctl</span><br><span class="line">        watch                   Watches events stream on keys or prefixes</span><br><span class="line"></span><br><span class="line">OPTIONS:</span><br><span class="line">      --cacert=&quot;&quot;                               verify certificates of TLS-enabled secure servers using this CA bundle</span><br><span class="line">      --cert=&quot;&quot;                                 identify secure client using this TLS certificate file</span><br><span class="line">      --command-timeout=5s                      timeout for short running command (excluding dial timeout)</span><br><span class="line">      --debug[=false]                           enable client-side debug logging</span><br><span class="line">      --dial-timeout=2s                         dial timeout for client connections</span><br><span class="line">  -d, --discovery-srv=&quot;&quot;                        domain name to query for SRV records describing cluster endpoints</span><br><span class="line">      --discovery-srv-name=&quot;&quot;                   service name to query when using DNS discovery</span><br><span class="line">      --endpoints=[127.0.0.1:2379]              gRPC endpoints</span><br><span class="line">  -h, --help[=false]                            help for etcdctl</span><br><span class="line">      --hex[=false]                             print byte strings as hex encoded strings</span><br><span class="line">      --insecure-discovery[=true]               accept insecure SRV records describing cluster endpoints</span><br><span class="line">      --insecure-skip-tls-verify[=false]        skip server certificate verification</span><br><span class="line">      --insecure-transport[=true]               disable transport security for client connections</span><br><span class="line">      --keepalive-time=2s                       keepalive time for client connections</span><br><span class="line">      --keepalive-timeout=6s                    keepalive timeout for client connections</span><br><span class="line">      --key=&quot;&quot;                                  identify secure client using this TLS key file</span><br><span class="line">      --password=&quot;&quot;                             password for authentication (if this option is used, --user option shouldn&#x27;t include password)</span><br><span class="line">      --user=&quot;&quot;                                 username[:password] for authentication (prompt if password is not supplied)</span><br><span class="line">  -w, --write-out=&quot;simple&quot;                      set the output format (fields, json, protobuf, simple, table)</span><br></pre></td></tr></table></figure>



<h3 id="设置、更新key"><a href="#设置、更新key" class="headerlink" title="设置、更新key"></a>设置、更新key</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">/etcd/etcd/etcdctl --endpoints=localhost:2379 put /test/1 <span class="string">&quot;Hello world1&quot;</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">更新</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">/etcd/etcd/etcdctl --endpoints=localhost:2379 put /test/1 <span class="string">&quot;Hello world2&quot;</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="获取key"><a href="#获取key" class="headerlink" title="获取key"></a>获取key</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">/etcd/etcd/etcdctl --endpoints=localhost:2379 get /test/1</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">匹配前缀查询</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">/etcd/etcd/etcdctl --endpoints=localhost:2379 get /test --prefix</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">/etcd/etcd/etcdctl --endpoints=localhost:2379 --write-out=<span class="string">&quot;json&quot;</span> get /test/1</span></span><br></pre></td></tr></table></figure>

<h3 id="删除key"><a href="#删除key" class="headerlink" title="删除key"></a>删除key</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">/etcd/etcd/etcdctl --endpoints=localhost:2379 del /test/1</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">匹配前缀删除</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">/etcd/etcd/etcdctl --endpoints=localhost:2379 del /test --prefix</span></span><br></pre></td></tr></table></figure>

<h3 id="监听一个key"><a href="#监听一个key" class="headerlink" title="监听一个key"></a>监听一个key</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">/etcd/etcd/etcdctl --endpoints=localhost:2379 watch /test/1</span></span><br></pre></td></tr></table></figure>

<h3 id="申请租约"><a href="#申请租约" class="headerlink" title="申请租约"></a>申请租约</h3><p>从申请开始计算时间</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">/etcd/etcd/etcdctl --endpoints=localhost:2379 lease grant 100</span></span><br><span class="line">lease 694d680edbc7579e granted with TTL(100s)</span><br></pre></td></tr></table></figure>

<h3 id="授权租约"><a href="#授权租约" class="headerlink" title="授权租约"></a>授权租约</h3><p>节点的生命伴随着租约到期将会被删除</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">/etcd/etcd/etcdctl --endpoints=localhost:2379 put --lease=694d680edbc7579e /key/1 1</span></span><br></pre></td></tr></table></figure>

<h3 id="租约续约"><a href="#租约续约" class="headerlink" title="租约续约"></a>租约续约</h3><p>每当到期将会续约</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">/etcd/etcd/etcdctl --endpoints=localhost:2379 lease grant 100</span></span><br><span class="line">lease 694d680edbc757a2 granted with TTL(100s)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">/etcd/etcd/etcdctl --endpoints=localhost:2379 lease keep-alive 694d680edbc757a2</span></span><br><span class="line">lease 694d680edbc757a2 keepalived with TTL(100)</span><br><span class="line">lease 694d680edbc757a2 keepalived with TTL(100)</span><br><span class="line">lease 694d680edbc757a2 keepalived with TTL(100)</span><br></pre></td></tr></table></figure>



<h3 id="集群"><a href="#集群" class="headerlink" title="集群"></a>集群</h3><p>查看集群节点</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">/etcd/etcd/etcdctl member list</span></span><br><span class="line">8e9e05c52164694d, started, default, http://localhost:2380, http://localhost:2379, false</span><br></pre></td></tr></table></figure>

<p>删除集群中存在的节点</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">/etcd/etcd/etcdctl member remove 8e9e05c52164694d</span></span><br></pre></td></tr></table></figure>

<p> 向集群中新加节点</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">/etcd/etcd/etcdctl member add etcd3 http://192.168.1.100:2380</span></span><br></pre></td></tr></table></figure>

<p> 更新集群中节点</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">/etcd/etcd/etcdctl member update 8e9e05c52164694d</span></span><br></pre></td></tr></table></figure>

<p>提升集群中节点</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">/etcd/etcd/etcdctl member promote 8e9e05c52164694d</span></span><br></pre></td></tr></table></figure>



<h3 id="备份和恢复"><a href="#备份和恢复" class="headerlink" title="备份和恢复"></a>备份和恢复</h3><p>备份</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">/etcd/etcd/etcdctl snapshot save backup.db</span></span><br></pre></td></tr></table></figure>

<p> 查看备份文件信息 </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">/etcd/etcd/etcdctl --write-out=table snapshot status backup.db</span></span><br></pre></td></tr></table></figure>

<p>恢复</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">etcdctl snapshot restore backup.db \  </span><br><span class="line">-name etcd1 \ </span><br><span class="line">-initialcluster etcd1=https://192.168.2.10:2380,etcd2=https://192.168.2.11:2380,etcd3=https://192.168.2.12:2380 \</span><br><span class="line">-initial-cluster-token etcd-cluster-0 \</span><br><span class="line">--initial-advertise-peer-urls https://192.168.2.10:2380</span><br></pre></td></tr></table></figure>





<h3 id="etcd命令"><a href="#etcd命令" class="headerlink" title="etcd命令"></a>etcd命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br></pre></td><td class="code"><pre><span class="line">Usage:</span><br><span class="line"></span><br><span class="line">  etcd [flags]</span><br><span class="line">    Start an etcd server.</span><br><span class="line"></span><br><span class="line">  etcd --version</span><br><span class="line">    Show the version of etcd.</span><br><span class="line"></span><br><span class="line">  etcd -h | --help</span><br><span class="line">    Show the help information about etcd.</span><br><span class="line"></span><br><span class="line">  etcd --config-file</span><br><span class="line">    Path to the server configuration file. Note that if a configuration file is provided, other command line flags and environment variables will be ignored.</span><br><span class="line"></span><br><span class="line">  etcd gateway</span><br><span class="line">    Run the stateless pass-through etcd TCP connection forwarding proxy.</span><br><span class="line"></span><br><span class="line">  etcd grpc-proxy</span><br><span class="line">    Run the stateless etcd v3 gRPC L7 reverse proxy.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Member:</span><br><span class="line">  --name &#x27;default&#x27;</span><br><span class="line">    Human-readable name for this member.</span><br><span class="line">  --data-dir &#x27;$&#123;name&#125;.etcd&#x27;</span><br><span class="line">    Path to the data directory.</span><br><span class="line">  --wal-dir &#x27;&#x27;</span><br><span class="line">    Path to the dedicated wal directory.</span><br><span class="line">  --snapshot-count &#x27;100000&#x27;</span><br><span class="line">    Number of committed transactions to trigger a snapshot to disk.</span><br><span class="line">  --heartbeat-interval &#x27;100&#x27;</span><br><span class="line">    Time (in milliseconds) of a heartbeat interval.</span><br><span class="line">  --election-timeout &#x27;1000&#x27;</span><br><span class="line">    Time (in milliseconds) for an election to timeout. See tuning documentation for details.</span><br><span class="line">  --initial-election-tick-advance &#x27;true&#x27;</span><br><span class="line">    Whether to fast-forward initial election ticks on boot for faster election.</span><br><span class="line">  --listen-peer-urls &#x27;http://localhost:2380&#x27;</span><br><span class="line">    List of URLs to listen on for peer traffic.</span><br><span class="line">  --listen-client-urls &#x27;http://localhost:2379&#x27;</span><br><span class="line">    List of URLs to listen on for client traffic.</span><br><span class="line">  --max-snapshots &#x27;5&#x27;</span><br><span class="line">    Maximum number of snapshot files to retain (0 is unlimited).</span><br><span class="line">  --max-wals &#x27;5&#x27;</span><br><span class="line">    Maximum number of wal files to retain (0 is unlimited).</span><br><span class="line">  --quota-backend-bytes &#x27;0&#x27;</span><br><span class="line">    Raise alarms when backend size exceeds the given quota (0 defaults to low space quota).</span><br><span class="line">  --backend-batch-interval &#x27;&#x27;</span><br><span class="line">    BackendBatchInterval is the maximum time before commit the backend transaction.</span><br><span class="line">  --backend-batch-limit &#x27;0&#x27;</span><br><span class="line">    BackendBatchLimit is the maximum operations before commit the backend transaction.</span><br><span class="line">  --max-txn-ops &#x27;128&#x27;</span><br><span class="line">    Maximum number of operations permitted in a transaction.</span><br><span class="line">  --max-request-bytes &#x27;1572864&#x27;</span><br><span class="line">    Maximum client request size in bytes the server will accept.</span><br><span class="line">  --grpc-keepalive-min-time &#x27;5s&#x27;</span><br><span class="line">    Minimum duration interval that a client should wait before pinging server.</span><br><span class="line">  --grpc-keepalive-interval &#x27;2h&#x27;</span><br><span class="line">    Frequency duration of server-to-client ping to check if a connection is alive (0 to disable).</span><br><span class="line">  --grpc-keepalive-timeout &#x27;20s&#x27;</span><br><span class="line">    Additional duration of wait before closing a non-responsive connection (0 to disable).</span><br><span class="line"></span><br><span class="line">Clustering:</span><br><span class="line">  --initial-advertise-peer-urls &#x27;http://localhost:2380&#x27;</span><br><span class="line">    List of this member&#x27;s peer URLs to advertise to the rest of the cluster.</span><br><span class="line">  --initial-cluster &#x27;default=http://localhost:2380&#x27;</span><br><span class="line">    Initial cluster configuration for bootstrapping.</span><br><span class="line">  --initial-cluster-state &#x27;new&#x27;</span><br><span class="line">    Initial cluster state (&#x27;new&#x27; or &#x27;existing&#x27;).</span><br><span class="line">  --initial-cluster-token &#x27;etcd-cluster&#x27;</span><br><span class="line">    Initial cluster token for the etcd cluster during bootstrap.</span><br><span class="line">    Specifying this can protect you from unintended cross-cluster interaction when running multiple clusters.</span><br><span class="line">  --advertise-client-urls &#x27;http://localhost:2379&#x27;</span><br><span class="line">    List of this member&#x27;s client URLs to advertise to the public.</span><br><span class="line">    The client URLs advertised should be accessible to machines that talk to etcd cluster. etcd client libraries parse these URLs to connect to the cluster.</span><br><span class="line">  --discovery &#x27;&#x27;</span><br><span class="line">    Discovery URL used to bootstrap the cluster.</span><br><span class="line">  --discovery-fallback &#x27;proxy&#x27;</span><br><span class="line">    Expected behavior (&#x27;exit&#x27; or &#x27;proxy&#x27;) when discovery services fails.</span><br><span class="line">    &quot;proxy&quot; supports v2 API only.</span><br><span class="line">  --discovery-proxy &#x27;&#x27;</span><br><span class="line">    HTTP proxy to use for traffic to discovery service.</span><br><span class="line">  --discovery-srv &#x27;&#x27;</span><br><span class="line">    DNS srv domain used to bootstrap the cluster.</span><br><span class="line">  --discovery-srv-name &#x27;&#x27;</span><br><span class="line">    Suffix to the dns srv name queried when bootstrapping.</span><br><span class="line">  --strict-reconfig-check &#x27;true&#x27;</span><br><span class="line">    Reject reconfiguration requests that would cause quorum loss.</span><br><span class="line">  --pre-vote &#x27;false&#x27;</span><br><span class="line">    Enable to run an additional Raft election phase.</span><br><span class="line">  --auto-compaction-retention &#x27;0&#x27;</span><br><span class="line">    Auto compaction retention length. 0 means disable auto compaction.</span><br><span class="line">  --auto-compaction-mode &#x27;periodic&#x27;</span><br><span class="line">    Interpret &#x27;auto-compaction-retention&#x27; one of: periodic|revision. &#x27;periodic&#x27; for duration based retention, defaulting to hours if no time unit is provided (e.g. &#x27;5m&#x27;). &#x27;revision&#x27; for revision number based retention.</span><br><span class="line">  --enable-v2 &#x27;false&#x27;</span><br><span class="line">    Accept etcd V2 client requests.</span><br><span class="line"></span><br><span class="line">Security:</span><br><span class="line">  --cert-file &#x27;&#x27;</span><br><span class="line">    Path to the client server TLS cert file.</span><br><span class="line">  --key-file &#x27;&#x27;</span><br><span class="line">    Path to the client server TLS key file.</span><br><span class="line">  --client-cert-auth &#x27;false&#x27;</span><br><span class="line">    Enable client cert authentication.</span><br><span class="line">  --client-crl-file &#x27;&#x27;</span><br><span class="line">    Path to the client certificate revocation list file.</span><br><span class="line">  --client-cert-allowed-hostname &#x27;&#x27;</span><br><span class="line">    Allowed TLS hostname for client cert authentication.</span><br><span class="line">  --trusted-ca-file &#x27;&#x27;</span><br><span class="line">    Path to the client server TLS trusted CA cert file.</span><br><span class="line">  --auto-tls &#x27;false&#x27;</span><br><span class="line">    Client TLS using generated certificates.</span><br><span class="line">  --peer-cert-file &#x27;&#x27;</span><br><span class="line">    Path to the peer server TLS cert file.</span><br><span class="line">  --peer-key-file &#x27;&#x27;</span><br><span class="line">    Path to the peer server TLS key file.</span><br><span class="line">  --peer-client-cert-auth &#x27;false&#x27;</span><br><span class="line">    Enable peer client cert authentication.</span><br><span class="line">  --peer-trusted-ca-file &#x27;&#x27;</span><br><span class="line">    Path to the peer server TLS trusted CA file.</span><br><span class="line">  --peer-cert-allowed-cn &#x27;&#x27;</span><br><span class="line">    Required CN for client certs connecting to the peer endpoint.</span><br><span class="line">  --peer-cert-allowed-hostname &#x27;&#x27;</span><br><span class="line">    Allowed TLS hostname for inter peer authentication.</span><br><span class="line">  --peer-auto-tls &#x27;false&#x27;</span><br><span class="line">    Peer TLS using self-generated certificates if --peer-key-file and --peer-cert-file are not provided.</span><br><span class="line">  --peer-crl-file &#x27;&#x27;</span><br><span class="line">    Path to the peer certificate revocation list file.</span><br><span class="line">  --cipher-suites &#x27;&#x27;</span><br><span class="line">    Comma-separated list of supported TLS cipher suites between client/server and peers (empty will be auto-populated by Go).</span><br><span class="line">  --cors &#x27;*&#x27;</span><br><span class="line">    Comma-separated whitelist of origins for CORS, or cross-origin resource sharing, (empty or * means allow all).</span><br><span class="line">  --host-whitelist &#x27;*&#x27;</span><br><span class="line">    Acceptable hostnames from HTTP client requests, if server is not secure (empty or * means allow all).</span><br><span class="line"></span><br><span class="line">Auth:</span><br><span class="line">  --auth-token &#x27;simple&#x27;</span><br><span class="line">    Specify a v3 authentication token type and its options (&#x27;simple&#x27; or &#x27;jwt&#x27;).</span><br><span class="line">  --bcrypt-cost 10</span><br><span class="line">    Specify the cost / strength of the bcrypt algorithm for hashing auth passwords. Valid values are between 4 and 31.</span><br><span class="line"></span><br><span class="line">Profiling and Monitoring:</span><br><span class="line">  --enable-pprof &#x27;false&#x27;</span><br><span class="line">    Enable runtime profiling data via HTTP server. Address is at client URL + &quot;/debug/pprof/&quot;</span><br><span class="line">  --metrics &#x27;basic&#x27;</span><br><span class="line">    Set level of detail for exported metrics, specify &#x27;extensive&#x27; to include histogram metrics.</span><br><span class="line">  --listen-metrics-urls &#x27;&#x27;</span><br><span class="line">    List of URLs to listen on for the metrics and health endpoints.</span><br><span class="line"></span><br><span class="line">Logging:</span><br><span class="line">  --logger &#x27;capnslog&#x27;</span><br><span class="line">    Specify &#x27;zap&#x27; for structured logging or &#x27;capnslog&#x27;. [WARN] &#x27;capnslog&#x27; will be deprecated in v3.5.</span><br><span class="line">  --log-outputs &#x27;default&#x27;</span><br><span class="line">    Specify &#x27;stdout&#x27; or &#x27;stderr&#x27; to skip journald logging even when running under systemd, or list of comma separated output targets.</span><br><span class="line">  --log-level &#x27;info&#x27;</span><br><span class="line">    Configures log level. Only supports debug, info, warn, error, panic, or fatal.</span><br><span class="line"></span><br><span class="line">v2 Proxy (to be deprecated in v4):</span><br><span class="line">  --proxy &#x27;off&#x27;</span><br><span class="line">    Proxy mode setting (&#x27;off&#x27;, &#x27;readonly&#x27; or &#x27;on&#x27;).</span><br><span class="line">  --proxy-failure-wait 5000</span><br><span class="line">    Time (in milliseconds) an endpoint will be held in a failed state.</span><br><span class="line">  --proxy-refresh-interval 30000</span><br><span class="line">    Time (in milliseconds) of the endpoints refresh interval.</span><br><span class="line">  --proxy-dial-timeout 1000</span><br><span class="line">    Time (in milliseconds) for a dial to timeout.</span><br><span class="line">  --proxy-write-timeout 5000</span><br><span class="line">    Time (in milliseconds) for a write to timeout.</span><br><span class="line">  --proxy-read-timeout 0</span><br><span class="line">    Time (in milliseconds) for a read to timeout.</span><br><span class="line"></span><br><span class="line">Experimental feature:</span><br><span class="line">  --experimental-initial-corrupt-check &#x27;false&#x27;</span><br><span class="line">    Enable to check data corruption before serving any client/peer traffic.</span><br><span class="line">  --experimental-corrupt-check-time &#x27;0s&#x27;</span><br><span class="line">    Duration of time between cluster corruption check passes.</span><br><span class="line">  --experimental-enable-v2v3 &#x27;&#x27;</span><br><span class="line">    Serve v2 requests through the v3 backend under a given prefix.</span><br><span class="line">  --experimental-backend-bbolt-freelist-type &#x27;array&#x27;</span><br><span class="line">    ExperimentalBackendFreelistType specifies the type of freelist that boltdb backend uses(array and map are supported types).</span><br><span class="line">  --experimental-enable-lease-checkpoint &#x27;false&#x27;</span><br><span class="line">    ExperimentalEnableLeaseCheckpoint enables primary lessor to persist lease remainingTTL to prevent indefinite auto-renewal of long lived leases.</span><br><span class="line">  --experimental-compaction-batch-limit 1000</span><br><span class="line">    ExperimentalCompactionBatchLimit sets the maximum revisions deleted in each compaction batch.</span><br><span class="line">  --experimental-peer-skip-client-san-verification &#x27;false&#x27;</span><br><span class="line">    Skip verification of SAN field in client certificate for peer connections.</span><br><span class="line"></span><br><span class="line">Unsafe feature:</span><br><span class="line">  --force-new-cluster &#x27;false&#x27;</span><br><span class="line">    Force to create a new one-member cluster.</span><br><span class="line"></span><br><span class="line">CAUTIOUS with unsafe flag! It may break the guarantees given by the consensus protocol!</span><br><span class="line"></span><br><span class="line">TO BE DEPRECATED:</span><br><span class="line"></span><br><span class="line">  --debug &#x27;false&#x27;</span><br><span class="line">    Enable debug-level logging for etcd. [WARN] Will be deprecated in v3.5. Use &#x27;--log-level=debug&#x27; instead.</span><br><span class="line">  --log-package-levels &#x27;&#x27;</span><br><span class="line">    Specify a particular log level for each etcd package (eg: &#x27;etcdmain=CRITICAL,etcdserver=DEBUG&#x27;).</span><br></pre></td></tr></table></figure>

<h3 id="go实例"><a href="#go实例" class="headerlink" title="go实例"></a>go实例</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;context&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/coreos/etcd/clientv3&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">	dialTimeout    = <span class="number">5</span> * time.Second</span><br><span class="line">	requestTimeout = <span class="number">2</span> * time.Second</span><br><span class="line">    <span class="comment">//endpoints      = []string&#123;&quot;192.168.221.136:2379&quot;&#125;</span></span><br><span class="line">	endpoints      = []<span class="type">string</span>&#123;<span class="string">&quot;127.0.0.1:2379&quot;</span>&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	cli, err := clientv3.New(clientv3.Config&#123;</span><br><span class="line">		Endpoints:   endpoints,</span><br><span class="line">		DialTimeout: dialTimeout,</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> cli.Close()</span><br><span class="line"></span><br><span class="line">	log.Println(<span class="string">&quot;存储值&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> _, err := cli.Put(context.TODO(), <span class="string">&quot;/sensors&quot;</span>, <span class="string">`&#123;sensor01:&#123;topic:&quot;w_sensor01&quot;&#125;&#125;`</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	log.Println(<span class="string">&quot;获取值&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> resp, err := cli.Get(context.TODO(), <span class="string">&quot;/sensors&quot;</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		log.Println(<span class="string">&quot;resp: &quot;</span>, resp)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// see https://github.com/coreos/etcd/blob/master/clientv3/example_kv_test.go#L220</span></span><br><span class="line">	log.Println(<span class="string">&quot;事务&amp;超时&quot;</span>)</span><br><span class="line">	ctx, cancel := context.WithTimeout(context.Background(), requestTimeout)</span><br><span class="line">	_, err = cli.Txn(ctx).</span><br><span class="line">		If(clientv3.Compare(clientv3.Value(<span class="string">&quot;key&quot;</span>), <span class="string">&quot;&gt;&quot;</span>, <span class="string">&quot;abc&quot;</span>)). <span class="comment">// txn value comparisons are lexical</span></span><br><span class="line">		Then(clientv3.OpPut(<span class="string">&quot;key&quot;</span>, <span class="string">&quot;XYZ&quot;</span>)).                      <span class="comment">// this runs, since &#x27;xyz&#x27; &gt; &#x27;abc&#x27;</span></span><br><span class="line">		Else(clientv3.OpPut(<span class="string">&quot;key&quot;</span>, <span class="string">&quot;ABC&quot;</span>)).</span><br><span class="line">		Commit()</span><br><span class="line">	cancel()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// see https://github.com/coreos/etcd/blob/master/clientv3/example_watch_test.go</span></span><br><span class="line">	log.Println(<span class="string">&quot;监视&quot;</span>)</span><br><span class="line">	rch := cli.Watch(context.Background(), <span class="string">&quot;&quot;</span>, clientv3.WithPrefix())</span><br><span class="line">	<span class="keyword">for</span> wresp := <span class="keyword">range</span> rch &#123;</span><br><span class="line">		<span class="keyword">for</span> _, ev := <span class="keyword">range</span> wresp.Events &#123;</span><br><span class="line">			fmt.Printf(<span class="string">&quot;%s %q : %q\n&quot;</span>, ev.Type, ev.Kv.Key, ev.Kv.Value)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="集群配置"><a href="#集群配置" class="headerlink" title="集群配置"></a>集群配置</h2><h3 id="配置项"><a href="#配置项" class="headerlink" title="配置项"></a>配置项</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">--name etcd0 //节点名称，默认为 default</span><br><span class="line"></span><br><span class="line">--data-dir //服务运行数据保存的路径，默认为$&#123;name&#125;.etcd</span><br><span class="line"></span><br><span class="line">--snapshot-count //指定有多少事务（transaction）被提交时，触发截取快照保存到磁盘</span><br><span class="line"></span><br><span class="line">--heartbeat-interval //leader 多久发送一次心跳到 followers。默认值是 100ms</span><br><span class="line"></span><br><span class="line">--eletion-timeout //重新投票的超时时间，如果 follow 在该时间间隔没有收到心跳包，会触发重新投票，默认为 1000 ms。</span><br><span class="line"></span><br><span class="line">--listen-peer-urls  //和同伴通信的地址，比如http://ip:2380，如果有多个，使用逗号分隔。需要所有节点都能够访问，所以不要使用 localhost</span><br><span class="line"></span><br><span class="line">--listen-client-urls //对外提供服务的地址：比如http://ip:2379,http://127.0.0.1:2379，客户端会连接到这里和 etcd 交互</span><br><span class="line"></span><br><span class="line">--advertise-client-urls：对外公告的该节点客户端监听地址，这个值会告诉集群中其他节点</span><br><span class="line"></span><br><span class="line">--initial-advertise-peer-urls http://192.168.2.55:2380 //其他member使用，其他member通过该地址与本member交互信息。一定要保证从其他member能可访问该地址。静态配置方式下，该参数的value一定要同时在--initial-cluster参数中存在。</span><br><span class="line"></span><br><span class="line">memberID的生成受--initial-cluster-token和--initial-advertise-peer-urls影响。该节点同伴监听地址，这个值会告诉集群中其他节点</span><br><span class="line"></span><br><span class="line">--initial-cluster //集群中所有节点的信息，格式为node1=http://ip1:2380,node2=http://ip2:2380,…，注意：这里的 node1 是节点的 --name 指定的名字；后面的 ip1:2380 是 --initial-advertise-peer-urls 指定的值。</span><br><span class="line"></span><br><span class="line">--initial-cluster-state //新建集群的时候，这个值为 new；假如已经存在的集群，这个值为 existing。</span><br><span class="line"></span><br><span class="line">--initial-cluster-token//创建集群的 token，这个值每个集群保持唯一。这样的话，如果你要重新创建集群，即使配置和之前一样，也会再次生成新的集群和节点 uuid；否则会导致多个集群之间的冲突，造成未知的错误。</span><br><span class="line"></span><br><span class="line">--initial-cluster-token etcd-cluster-2    //用于区分不同集群。本地如有多个集群要设为不同。</span><br><span class="line"></span><br><span class="line">--initial-cluster-state new    //用于指示本次是否为新建集群。有两个取值new和existing。如果填为existing，则该member启动时会尝试与其他member交互。集群初次建立时，要填为new，经尝试最后一个节点填existing也正常，其他节点不能填为existing。集群运行过程中，一个member故障后恢复时填为existing，经尝试填为new也正常。</span><br></pre></td></tr></table></figure>

<h3 id="集群启动脚本"><a href="#集群启动脚本" class="headerlink" title="集群启动脚本"></a>集群启动脚本</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">export ETCDCTL_API=3</span><br><span class="line">IP=&quot;192.168.221.136&quot;</span><br><span class="line"></span><br><span class="line">CLUSTER=&quot;s11=http://$&#123;IP&#125;:2380,s12=http://$&#123;IP&#125;:2480,s13=http://$&#123;IP&#125;:2580&quot;</span><br><span class="line"></span><br><span class="line">nohup /etcd/etcd/etcd --name s11 --initial-advertise-peer-urls http://$&#123;IP&#125;:2380 \</span><br><span class="line">  --listen-peer-urls http://$&#123;IP&#125;:2380 \</span><br><span class="line">  --listen-client-urls http://$&#123;IP&#125;:2379,http://127.0.0.1:2379 \</span><br><span class="line">  --advertise-client-urls http://$&#123;IP&#125;:2379,http://127.0.0.1:2379 \</span><br><span class="line">  --initial-cluster-token etcd-cluster-1 \</span><br><span class="line">  --initial-cluster $&#123;CLUSTER&#125; \</span><br><span class="line">  --initial-cluster-state new &gt; /dev/null 2&gt;&amp;1 &amp;</span><br><span class="line">  </span><br><span class="line">nohup /etcd/etcd/etcd --name s12 --initial-advertise-peer-urls http://$&#123;IP&#125;:2480 \</span><br><span class="line">  --listen-peer-urls http://$&#123;IP&#125;:2480 \</span><br><span class="line">  --listen-client-urls http://$&#123;IP&#125;:2479,http://127.0.0.1:2479 \</span><br><span class="line">  --advertise-client-urls http://$&#123;IP&#125;:2479,http://127.0.0.1:2479 \</span><br><span class="line">  --initial-cluster-token etcd-cluster-1 \</span><br><span class="line">  --initial-cluster $&#123;CLUSTER&#125; \</span><br><span class="line">  --initial-cluster-state new &gt; /dev/null 2&gt;&amp;1 &amp;</span><br><span class="line"></span><br><span class="line">nohup /etcd/etcd/etcd --name s13 --initial-advertise-peer-urls http://$&#123;IP&#125;:2580 \</span><br><span class="line">  --listen-peer-urls http://$&#123;IP&#125;:2580 \</span><br><span class="line">  --listen-client-urls http://$&#123;IP&#125;:2579,http://127.0.0.1:2579 \</span><br><span class="line">  --advertise-client-urls http://$&#123;IP&#125;:2579,http://127.0.0.1:2579 \</span><br><span class="line">  --initial-cluster-token etcd-cluster-1 \</span><br><span class="line">  --initial-cluster $&#123;CLUSTER&#125; \</span><br><span class="line">  --initial-cluster-state new &gt; /dev/null 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>

<p>查看集群</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">etcdctl member list</span></span><br><span class="line"></span><br><span class="line">cfdda6f4fce7ec9, started, s13, http://192.168.221.136:2580, http://127.0.0.1:2579,http://192.168.221.136:2579, false</span><br><span class="line">b0a4b6bdd1efe123, started, s11, http://192.168.221.136:2380, http://127.0.0.1:2379,http://192.168.221.136:2379, false</span><br><span class="line">bba82993c0bc3537, started, s12, http://192.168.221.136:2480, http://127.0.0.1:2479,http://192.168.221.136:2479, false</span><br></pre></td></tr></table></figure>

<h3 id="go实例-1"><a href="#go实例-1" class="headerlink" title="go实例"></a>go实例</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	&quot;context&quot;</span><br><span class="line">	&quot;fmt&quot;</span><br><span class="line">	&quot;log&quot;</span><br><span class="line">	&quot;time&quot;</span><br><span class="line"></span><br><span class="line">	&quot;github.com/coreos/etcd/clientv3&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">var (</span><br><span class="line">	dialTimeout    = 5 * time.Second</span><br><span class="line">	requestTimeout = 2 * time.Second</span><br><span class="line">    endpoints      = []string&#123;&quot;192.168.221.136:2379&quot;,&quot;192.168.221.136:2479&quot;,&quot;192.168.221.136:2579&quot;&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">	cli, err := clientv3.New(clientv3.Config&#123;</span><br><span class="line">		Endpoints:   endpoints,</span><br><span class="line">		DialTimeout: dialTimeout,</span><br><span class="line">	&#125;)</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	defer cli.Close()</span><br><span class="line"></span><br><span class="line">	log.Println(&quot;存储值&quot;)</span><br><span class="line">	if _, err := cli.Put(context.TODO(), &quot;/sensors&quot;, `&#123;sensor01:&#123;topic:&quot;w_sensor01&quot;&#125;&#125;`); err != nil &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	log.Println(&quot;获取值&quot;)</span><br><span class="line">	if resp, err := cli.Get(context.TODO(), &quot;/sensors&quot;); err != nil &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125; else &#123;</span><br><span class="line">		log.Println(&quot;resp: &quot;, resp)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// see https://github.com/coreos/etcd/blob/master/clientv3/example_kv_test.go#L220</span><br><span class="line">	log.Println(&quot;事务&amp;超时&quot;)</span><br><span class="line">	ctx, cancel := context.WithTimeout(context.Background(), requestTimeout)</span><br><span class="line">	_, err = cli.Txn(ctx).</span><br><span class="line">		If(clientv3.Compare(clientv3.Value(&quot;key&quot;), &quot;&gt;&quot;, &quot;abc&quot;)). // txn value comparisons are lexical</span><br><span class="line">		Then(clientv3.OpPut(&quot;key&quot;, &quot;XYZ&quot;)).                      // this runs, since &#x27;xyz&#x27; &gt; &#x27;abc&#x27;</span><br><span class="line">		Else(clientv3.OpPut(&quot;key&quot;, &quot;ABC&quot;)).</span><br><span class="line">		Commit()</span><br><span class="line">	cancel()</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// see https://github.com/coreos/etcd/blob/master/clientv3/example_watch_test.go</span><br><span class="line">	log.Println(&quot;监视&quot;)</span><br><span class="line">	rch := cli.Watch(context.Background(), &quot;&quot;, clientv3.WithPrefix())</span><br><span class="line">	for wresp := range rch &#123;</span><br><span class="line">		for _, ev := range wresp.Events &#123;</span><br><span class="line">			fmt.Printf(&quot;%s %q : %q\n&quot;, ev.Type, ev.Kv.Key, ev.Kv.Value)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="docker部署etcd集群"><a href="#docker部署etcd集群" class="headerlink" title="docker部署etcd集群"></a>docker部署etcd集群</h2><p>配置环境变量</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /var/log/etcd/			      #建议创建etcd日志保存目录</span><br><span class="line">mkdir -p /data/etcd				      #建议创建单独的etcd数据目录</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">REGISTRY=quay.io/coreos/etcd:latest  <span class="comment">#官方仓库</span></span></span><br><span class="line">REGISTRY=willdockerhub/etcd:v3.3.12   #个人仓库</span><br><span class="line">TOKEN=my-etcd-01				      #设置唯一集群ID</span><br><span class="line">CLUSTER_STATE=new				      #设置为新建集群</span><br><span class="line">NAME_1=etcd1</span><br><span class="line">NAME_2=etcd2</span><br><span class="line">NAME_3=etcd3					      #设置三个节点的name</span><br><span class="line">HOST_1=192.168.92.11</span><br><span class="line">HOST_2=192.168.92.12</span><br><span class="line">HOST_3=192.168.92.13			      #设置三个节点的IP</span><br><span class="line">CLUSTER=$&#123;NAME_1&#125;=http://$&#123;HOST_1&#125;:2380,$&#123;NAME_2&#125;=http://$&#123;HOST_2&#125;:2380,$&#123;NAME_3&#125;=http://$&#123;HOST_3&#125;:2380</span><br><span class="line">DATA_DIR=/data/etcd				      #设置集群etcd数据节点</span><br></pre></td></tr></table></figure>

<p>提示：以上所有操作需要在所有节点操作。</p>
<p>节点1执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">THIS_NAME=$&#123;NAME_1&#125;</span><br><span class="line">THIS_IP=$&#123;HOST_1&#125;</span><br><span class="line">docker run -d --restart=always \</span><br><span class="line">  -p 2379:2379 \</span><br><span class="line">  -p 2380:2380 \</span><br><span class="line">  --volume=$&#123;DATA_DIR&#125;:/etcd-data \</span><br><span class="line">  --name etcd $&#123;REGISTRY&#125; \</span><br><span class="line">  /usr/local/bin/etcd \</span><br><span class="line">  --data-dir=/etcd-data --name $&#123;THIS_NAME&#125; \</span><br><span class="line">  --initial-advertise-peer-urls http://$&#123;THIS_IP&#125;:2380 --listen-peer-urls http://0.0.0.0:2380 \</span><br><span class="line">  --advertise-client-urls http://$&#123;THIS_IP&#125;:2379 --listen-client-urls http://0.0.0.0:2379 \</span><br><span class="line">  --initial-cluster $&#123;CLUSTER&#125; \</span><br><span class="line">  --initial-cluster-state $&#123;CLUSTER_STATE&#125; --initial-cluster-token $&#123;TOKEN&#125;</span><br></pre></td></tr></table></figure>

<p>节点2执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">THIS_NAME=$&#123;NAME_2&#125;</span><br><span class="line">THIS_IP=$&#123;HOST_2&#125;</span><br><span class="line">docker run -d --restart=always \</span><br><span class="line">  -p 2379:2379 \</span><br><span class="line">  -p 2380:2380 \</span><br><span class="line">  --volume=$&#123;DATA_DIR&#125;:/etcd-data \</span><br><span class="line">  --name etcd $&#123;REGISTRY&#125; \</span><br><span class="line">  /usr/local/bin/etcd \</span><br><span class="line">  --data-dir=/etcd-data --name $&#123;THIS_NAME&#125; \</span><br><span class="line">  --initial-advertise-peer-urls http://$&#123;THIS_IP&#125;:2380 --listen-peer-urls http://0.0.0.0:2380 \</span><br><span class="line">  --advertise-client-urls http://$&#123;THIS_IP&#125;:2379 --listen-client-urls http://0.0.0.0:2379 \</span><br><span class="line">  --initial-cluster $&#123;CLUSTER&#125; \</span><br><span class="line">  --initial-cluster-state $&#123;CLUSTER_STATE&#125; --initial-cluster-token $&#123;TOKEN&#125;</span><br></pre></td></tr></table></figure>

<p>节点3执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">THIS_NAME=$&#123;NAME_3&#125;</span><br><span class="line">THIS_IP=$&#123;HOST_3&#125;</span><br><span class="line">docker run -d --restart=always \</span><br><span class="line">  -p 2379:2379 \</span><br><span class="line">  -p 2380:2380 \</span><br><span class="line">  --volume=$&#123;DATA_DIR&#125;:/etcd-data \</span><br><span class="line">  --name etcd $&#123;REGISTRY&#125; \</span><br><span class="line">  /usr/local/bin/etcd \</span><br><span class="line">  --data-dir=/etcd-data --name $&#123;THIS_NAME&#125; \</span><br><span class="line">  --initial-advertise-peer-urls http://$&#123;THIS_IP&#125;:2380 --listen-peer-urls http://0.0.0.0:2380 \</span><br><span class="line">  --advertise-client-urls http://$&#123;THIS_IP&#125;:2379 --listen-client-urls http://0.0.0.0:2379 \</span><br><span class="line">  --initial-cluster $&#123;CLUSTER&#125; \</span><br><span class="line">  --initial-cluster-state $&#123;CLUSTER_STATE&#125; --initial-cluster-token $&#123;TOKEN&#125;</span><br></pre></td></tr></table></figure>

<p>1.2 验证集群</p>
<p>查看容器状态</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker ps</span><br><span class="line">CONTAINER ID        IMAGE                        COMMAND                  CREATED              STATUS              PORTS                              NAMES</span><br><span class="line">36b1c9db2321        willdockerhub/etcd:v3.3.12   &quot;/usr/local/bin/et...&quot;   About a minute ago   Up About a minute   0.0.0.0:2379-2380-&gt;2379-2380/tcp   etcd</span><br></pre></td></tr></table></figure>

<p>查看集群状态</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker exec -it etcd /usr/local/bin/etcdctl cluster-health</span><br><span class="line">member 1d5a95e7cc3da4a2 is healthy: got healthy result from http://192.168.92.11:2379</span><br><span class="line">member 2324302b6450f04d is healthy: got healthy result from http://192.168.92.12:2379</span><br><span class="line">member 7f413d967727fb2b is healthy: got healthy result from http://192.168.92.13:2379</span><br><span class="line">cluster is healthy</span><br></pre></td></tr></table></figure>

<p>查看主机监听端口</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# netstat -nltp | grep 2380</span><br><span class="line">tcp6       0      0 :::2380                 :::*                    LISTEN      19601/docker-proxy- </span><br><span class="line">[root@localhost ~]#</span><br></pre></td></tr></table></figure>



















</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://wangyyovo.github.io">Blank</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://wangyyovo.github.io/posts/5baaccef/">https://wangyyovo.github.io/posts/5baaccef/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://wangyyovo.github.io" target="_blank">Blank</a>！</span></div></div><div class="tag_share"><div class="post-share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/etcd/85724a45f3babbdb451f3ef24d36a303.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/6b7ef58d/" title="Etcd集群指南"><img class="cover" src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/etcd/55556e54209b5be718614c259f8aca64.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">Etcd集群指南</div></div><div class="info-2"><div class="info-item-1"> Etcd集群指南概述启动 etcd 集群要求每个成员知道集群中的其他成员。在一些场景中，集群成员的 IP 地址可能无法提前知道。在这种情况下，etcd 集群可以在发现服务的帮助下启动。 一旦 etcd 集群启动并运行，可以通过 运行时重配置 来添加或者移除成员。为了更好的理解运行时重配置背后的设计，建议阅读 运行时重配置的设计。 这份指南将覆盖下列用于启动 etcd 集群的机制：  静态 etcd 发现 DNS 发现  启动机制的每一种都将用于启动三台机器的 etcd 集群，详情如下：    名字 地址 主机    infra0 10.0.1.10 infra0.example.com   infra1 10.0.1.11 infra1.example.com   infra2 10.0.1.12 infra2.example.com   静态如果在启动前我们知道集群成员，他们的地址和集群的大小，我们可以使用通过设置 initial-cluster 标记来离线启动配置。每个机器将得到下列环境变量或者命令行： 1234ETCD_INITIAL_CLUSTER=&quot;infr...</div></div></div></a><a class="pagination-related" href="/posts/589ab773/" title="Etcd应用"><img class="cover" src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/etcd/41896216ab5517c3b870d9ed6bb1b126.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">Etcd应用</div></div><div class="info-2"><div class="info-item-1"> Etcd应用随着CoreOS和Kubernetes等项目在开源社区日益火热，它们项目中都用到的etcd组件作为一个高可用强一致性的服务发现存储仓库，渐渐为开发人员所关注。在云计算时代，如何让服务快速透明地接入到计算集群中，如何让共享配置信息快速被集群中的所有机器发现，更为重要的是，如何构建这样一套高可用、安全、易于部署以及响应快速的服务集群，已经成为了迫切需要解决的问题。etcd为解决这类问题带来了福音，本文将从etcd的应用场景开始，深入解读etcd的实现方式，以供开发者们更为充分地享用etcd所带来的便利。 经典应用场景要问etcd是什么？很多人第一反应可能是一个键值存储仓库，却没有重视官方定义的后半句，用于配置共享和服务发现。  A highly-available key value store for shared configuration and service discovery.  实际上，etcd作为一个受到ZooKeeper与doozer启发而催生的项目，除了拥有与之类似的功能外，更专注于以下四点。  简单：基于HTTP+JSON的API让你用curl就可...</div></div></div></a></nav><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/theme/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Blank</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">352</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">46</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">58</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>主题 GitHub</span></a><div class="card-info-social-icons"><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fas fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Etcd%E7%9A%84%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8"><span class="toc-number">1.</span> <span class="toc-text">Etcd的简单使用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#API-V2%E4%B8%8EV3%E5%8C%BA%E5%88%AB"><span class="toc-number">1.1.</span> <span class="toc-text">API V2与V3区别</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-number">1.2.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E8%AF%BB%E5%86%99"><span class="toc-number">1.3.</span> <span class="toc-text">简单读写</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Etcd%E5%8F%AF%E8%A7%86%E5%8C%96%E5%B7%A5%E5%85%B7"><span class="toc-number">1.4.</span> <span class="toc-text">Etcd可视化工具</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Etcd%E5%8D%95%E6%9C%BA%E5%90%AF%E5%8A%A8"><span class="toc-number">1.5.</span> <span class="toc-text">Etcd单机启动</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Etcd%E5%8D%95%E6%9C%BAdocker-compose"><span class="toc-number">1.6.</span> <span class="toc-text">Etcd单机docker-compose</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Etcd%E6%95%B0%E6%8D%AE%E6%93%8D%E4%BD%9C"><span class="toc-number">1.7.</span> <span class="toc-text">Etcd数据操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#etcdctl%E5%91%BD%E4%BB%A4"><span class="toc-number">1.7.1.</span> <span class="toc-text">etcdctl命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E3%80%81%E6%9B%B4%E6%96%B0key"><span class="toc-number">1.7.2.</span> <span class="toc-text">设置、更新key</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96key"><span class="toc-number">1.7.3.</span> <span class="toc-text">获取key</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A0%E9%99%A4key"><span class="toc-number">1.7.4.</span> <span class="toc-text">删除key</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%91%E5%90%AC%E4%B8%80%E4%B8%AAkey"><span class="toc-number">1.7.5.</span> <span class="toc-text">监听一个key</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%B3%E8%AF%B7%E7%A7%9F%E7%BA%A6"><span class="toc-number">1.7.6.</span> <span class="toc-text">申请租约</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%88%E6%9D%83%E7%A7%9F%E7%BA%A6"><span class="toc-number">1.7.7.</span> <span class="toc-text">授权租约</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A7%9F%E7%BA%A6%E7%BB%AD%E7%BA%A6"><span class="toc-number">1.7.8.</span> <span class="toc-text">租约续约</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4"><span class="toc-number">1.7.9.</span> <span class="toc-text">集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%87%E4%BB%BD%E5%92%8C%E6%81%A2%E5%A4%8D"><span class="toc-number">1.7.10.</span> <span class="toc-text">备份和恢复</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#etcd%E5%91%BD%E4%BB%A4"><span class="toc-number">1.7.11.</span> <span class="toc-text">etcd命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#go%E5%AE%9E%E4%BE%8B"><span class="toc-number">1.7.12.</span> <span class="toc-text">go实例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E9%85%8D%E7%BD%AE"><span class="toc-number">1.8.</span> <span class="toc-text">集群配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E9%A1%B9"><span class="toc-number">1.8.1.</span> <span class="toc-text">配置项</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E5%90%AF%E5%8A%A8%E8%84%9A%E6%9C%AC"><span class="toc-number">1.8.2.</span> <span class="toc-text">集群启动脚本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#go%E5%AE%9E%E4%BE%8B-1"><span class="toc-number">1.8.3.</span> <span class="toc-text">go实例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#docker%E9%83%A8%E7%BD%B2etcd%E9%9B%86%E7%BE%A4"><span class="toc-number">1.9.</span> <span class="toc-text">docker部署etcd集群</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/d14168d/" title="虚拟机问题合集"><img src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/hexo/090cfe4e9e60b0ad0de05db822f3ae97.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="虚拟机问题合集"/></a><div class="content"><a class="title" href="/posts/d14168d/" title="虚拟机问题合集">虚拟机问题合集</a><time datetime="2022-07-16T13:30:36.000Z" title="发表于 2022-07-16 21:30:36">2022-07-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/f540045f/" title="用go语言编写移动端sdk和app开发"><img src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/golang/941ed1ec2925719a0c92e76f4f786b6a.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="用go语言编写移动端sdk和app开发"/></a><div class="content"><a class="title" href="/posts/f540045f/" title="用go语言编写移动端sdk和app开发">用go语言编写移动端sdk和app开发</a><time datetime="2022-07-04T12:14:21.000Z" title="发表于 2022-07-04 20:14:21">2022-07-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/5faac006/" title="在线编程IDE"><img src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/hexo/090cfe4e9e60b0ad0de05db822f3ae97.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="在线编程IDE"/></a><div class="content"><a class="title" href="/posts/5faac006/" title="在线编程IDE">在线编程IDE</a><time datetime="2022-06-12T13:30:36.000Z" title="发表于 2022-06-12 21:30:36">2022-06-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/7594185d/" title="即时性能分析工具Pyroscope"><img src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/golang/3bfb3279740bc9a5b5ef436fa887ef07.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="即时性能分析工具Pyroscope"/></a><div class="content"><a class="title" href="/posts/7594185d/" title="即时性能分析工具Pyroscope">即时性能分析工具Pyroscope</a><time datetime="2022-06-12T08:07:36.000Z" title="发表于 2022-06-12 16:07:36">2022-06-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/82a7aa7c/" title="golang性能调试优化方法"><img src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/common/3.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="golang性能调试优化方法"/></a><div class="content"><a class="title" href="/posts/82a7aa7c/" title="golang性能调试优化方法">golang性能调试优化方法</a><time datetime="2022-06-12T03:00:36.000Z" title="发表于 2022-06-12 11:00:36">2022-06-12</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 By Blank</span><span class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 5.4.2</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.4.3</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><div class="js-pjax"><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = null

  const initValine = (el, path) => {
    if (isShuoshuo) {
      window.shuoshuoComment.destroyValine = () => {
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }

    const valineConfig = {
      el: '#vcomment',
      appId: '49gEIIGN7uRbL6vHhieSpBzM-MdYXbMMI',
      appKey: 'uqts0urLKwikYQ0fKmIkMHBE',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      visitor: false,
      ...option,
      path: isShuoshuo ? path : (option && option.path) || window.location.pathname
    }

    new Valine(valineConfig)
  }

  const loadValine = async (el, path) => {
    if (typeof Valine === 'function') {
      initValine(el, path)
    } else {
      await btf.getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js')
      initValine(el, path)
    }
  }

  if (isShuoshuo) {
    'Valine' === 'Valine'
      ? window.shuoshuoComment = { loadComment: loadValine }
      : window.loadOtherComment = loadValine
    return
  }

  if ('Valine' === 'Valine' || !false) {
    if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>