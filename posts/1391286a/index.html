<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>gqlgen文档 | Blank</title><meta name="author" content="Blank"><meta name="copyright" content="Blank"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="1.介绍什么是gqlgen？gqlgen是用于构建GraphQL服务器的Go库。  gqlgen is based on a Schema first approach-您可以使用GraphQL模式定义语言来定义API。  gqlgen优先考虑类型安全性-您在此永远都不会看到map [string] interface {}。  gqlgen启用了Codegen-我们生成了无聊的代码，因此您可以">
<meta property="og:type" content="article">
<meta property="og:title" content="gqlgen文档">
<meta property="og:url" content="https://wangyyovo.github.io/posts/1391286a/">
<meta property="og:site_name" content="Blank">
<meta property="og:description" content="1.介绍什么是gqlgen？gqlgen是用于构建GraphQL服务器的Go库。  gqlgen is based on a Schema first approach-您可以使用GraphQL模式定义语言来定义API。  gqlgen优先考虑类型安全性-您在此永远都不会看到map [string] interface {}。  gqlgen启用了Codegen-我们生成了无聊的代码，因此您可以">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/microservice/b45a976cf0d74608645a7327efbef5e5.jpg">
<meta property="article:published_time" content="2020-10-22T17:30:11.000Z">
<meta property="article:modified_time" content="2020-10-22T17:30:11.000Z">
<meta property="article:author" content="Blank">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/microservice/b45a976cf0d74608645a7327efbef5e5.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "gqlgen文档",
  "url": "https://wangyyovo.github.io/posts/1391286a/",
  "image": "https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/microservice/b45a976cf0d74608645a7327efbef5e5.jpg",
  "datePublished": "2020-10-22T17:30:11.000Z",
  "dateModified": "2020-10-22T17:30:11.000Z",
  "author": [
    {
      "@type": "Person",
      "name": "Blank",
      "url": "https://wangyyovo.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/theme/favicon.ico"><link rel="canonical" href="https://wangyyovo.github.io/posts/1391286a/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":400,"highlightFullpage":true,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":150,"languages":{"author":"作者: Blank","link":"链接: ","source":"来源: Blank","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'gqlgen文档',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="alternate" href="/atom.xml" title="Blank" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/theme/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">352</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">46</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">58</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fas fa-comment-dots"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 娱乐</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-image"></i><span> 相册</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-book"></i><span> 教程</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/posts/21cfbf15/"><span> 🚀 快速開始</span></a></li><li><a class="site-page child" href="/posts/dc584b87/"><span> 📑 主題頁面</span></a></li><li><a class="site-page child" href="/posts/4aa8abbe/"><span> 🛠 主題配置</span></a></li><li><a class="site-page child" href="/posts/ceeb73f/"><span> ⚔️ 標簽外挂</span></a></li><li><a class="site-page child" href="/posts/98d20436/"><span> ❓ 主題問答</span></a></li><li><a class="site-page child" href="/posts/4073eda/"><span> ⚡️ 進階教程</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-language"></i><span> 语言</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/"><i class="fa-fw fas fa-c"></i><span> 中文</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/microservice/b45a976cf0d74608645a7327efbef5e5.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Blank</span></a><a class="nav-page-title" href="/"><span class="site-name">gqlgen文档</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fas fa-comment-dots"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 娱乐</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-image"></i><span> 相册</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-book"></i><span> 教程</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/posts/21cfbf15/"><span> 🚀 快速開始</span></a></li><li><a class="site-page child" href="/posts/dc584b87/"><span> 📑 主題頁面</span></a></li><li><a class="site-page child" href="/posts/4aa8abbe/"><span> 🛠 主題配置</span></a></li><li><a class="site-page child" href="/posts/ceeb73f/"><span> ⚔️ 標簽外挂</span></a></li><li><a class="site-page child" href="/posts/98d20436/"><span> ❓ 主題問答</span></a></li><li><a class="site-page child" href="/posts/4073eda/"><span> ⚡️ 進階教程</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-language"></i><span> 语言</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/"><i class="fa-fw fas fa-c"></i><span> 中文</span></a></li></ul></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">gqlgen文档</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-10-22T17:30:11.000Z" title="发表于 2020-10-23 01:30:11">2020-10-23</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2020-10-22T17:30:11.000Z" title="更新于 2020-10-23 01:30:11">2020-10-23</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/microservice/">microservice</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">11.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>52分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><script src="\assets\js\APlayer.min.js"> </script><h1 id="1-介绍"><a href="#1-介绍" class="headerlink" title="1.介绍"></a>1.介绍</h1><h2 id="什么是gqlgen？"><a href="#什么是gqlgen？" class="headerlink" title="什么是gqlgen？"></a>什么是gqlgen？</h2><p>gqlgen是用于构建GraphQL服务器的Go库。</p>
<ul>
<li><p><strong>gqlgen is based on a Schema first approach</strong>-您可以使用GraphQL模式定义语言来定义API。</p>
</li>
<li><p>gqlgen优先考虑类型安全性-您在此永远都不会看到map [string] interface {}。</p>
</li>
<li><p>gqlgen启用了Codegen-我们生成了无聊的代码，因此您可以专注于快速构建应用程序。</p>
</li>
</ul>
<p>仍不足以说服使用gqlgen？将gqlgen与其他Go graphql实现进行比较</p>
<h2 id="入门"><a href="#入门" class="headerlink" title="入门"></a>入门</h2><ul>
<li>要安装gqlgen，请运行以下命令：在项目目录中运行<code>go get github.com/99designs/gqlgen</code>。</li>
<li>您可以通过运行以下命令来初始化新项目：<code>go run github.com/99designs/gqlgen init</code>。</li>
</ul>
<p>您可以在这里找到更全面的指南来帮助您入门。我们还有两个真实的示例，展示了如何使用gqlgen无缝实现GraphQL应用程序。您可以在此处查看这些<a target="_blank" rel="noopener" href="https://github.com/99designs/gqlgen/tree/master/example">示例</a>或访问<a target="_blank" rel="noopener" href="https://godoc.org/github.com/99designs/gqlgen">godoc</a>。</p>
<h2 id="报告问题"><a href="#报告问题" class="headerlink" title="报告问题"></a>报告问题</h2><p>如果您认为已发现错误，或某些行为不符合您的预期，请在GitHub上提出<a target="_blank" rel="noopener" href="https://github.com/99designs/gqlgen/issues">问题</a>。</p>
<h2 id="贡献"><a href="#贡献" class="headerlink" title="贡献"></a>贡献</h2><p>我们欢迎您的贡献，请阅读我们的贡献准则，以了解有关为gqlgen做出贡献的更多信息</p>
<h2 id="经常问的问题"><a href="#经常问的问题" class="headerlink" title="经常问的问题"></a>经常问的问题</h2><p>如何防止获取可能不使用的子对象？<br>当您像这样嵌套或递归架构时：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">type User &#123;</span><br><span class="line">  id: ID!</span><br><span class="line">  name: String!</span><br><span class="line">  friends: [User!]!</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>您需要告诉gqlgen，它仅应在用户请求时获取friends。有两种方法可以做到这一点;</p>
<ul>
<li>使用自定义模型</li>
</ul>
<p>编写忽略friends 字段的自定义模型：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">type User struct &#123;</span><br><span class="line">  ID int</span><br><span class="line">  Name string</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>并在gqlgen.yml中引用该模型：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># gqlgen.yml</span></span><br><span class="line"><span class="attr">models:</span></span><br><span class="line">  <span class="attr">User:</span></span><br><span class="line">    <span class="attr">model:</span> <span class="string">github.com/you/pkg/model.User</span> <span class="comment"># go import path to the User struct above</span></span><br></pre></td></tr></table></figure>

<ul>
<li>使用显式解析器</li>
</ul>
<p>如果要继续使用生成的模型，请在gqlgen.yml中将字段明确标记为需要解析器，如下所示：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># gqlgen.yml</span></span><br><span class="line"><span class="attr">models:</span></span><br><span class="line">  <span class="attr">User:</span></span><br><span class="line">    <span class="attr">fields:</span></span><br><span class="line">      <span class="attr">friends:</span></span><br><span class="line">        <span class="attr">resolver:</span> <span class="literal">true</span> <span class="comment"># force a resolver to be generated</span></span><br></pre></td></tr></table></figure>

<p>完成以上任一操作并运行generate之后，我们需要为friends提供一个解析器：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *userResolver)</span></span> Friends(ctx context.Context, obj *User) ([]*User, <span class="type">error</span>) &#123;</span><br><span class="line">  	<span class="comment">// select * from user where friendid = obj.ID</span></span><br><span class="line">	<span class="keyword">return</span> friends,  <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>我可以将ID的类型从String更改为Int类型吗？</strong><br>是!您可以通过如下所示在config中重新映射它：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">models:</span></span><br><span class="line">  <span class="attr">ID:</span> <span class="comment"># The GraphQL type ID is backed by</span></span><br><span class="line">    <span class="attr">model:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">github.com/99designs/gqlgen/graphql.IntID</span> <span class="comment"># An go integer</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">github.com/99designs/gqlgen/graphql.ID</span> <span class="comment"># or a go string</span></span><br></pre></td></tr></table></figure>

<p>这意味着gqlgen将能够自动绑定到您自己编写的模型的字符串或整数，但是此列表中的第一个模型用作默认类型，并且在以下情况下将始终使用：</p>
<ul>
<li>基于schema生成模型</li>
<li>作为解析器中的参数</li>
</ul>
<p>对此没有任何办法，gqlgen无法在给定的上下文中知道您想要什么。</p>
<h1 id="2-入门"><a href="#2-入门" class="headerlink" title="2.入门"></a>2.入门</h1><p>在Golang中建立GraphQL服务器</p>
<p>本教程将指导您完成使用gqlgen构建GraphQL服务器的过程，该服务器可以：</p>
<ul>
<li>返回待办事项清单</li>
<li>创建新的待办事项</li>
<li>标记待办事项待办事项</li>
</ul>
<p>您可以在这里找到本教程的完成代码</p>
<h2 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h2><p>为您的项目创建一个目录，并将其初始化为Go模块：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">mkdir</span> gqlgen-todos</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> gqlgen-todos</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">go mod init github.com/[username]/gqlgen-todos</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">go get github.com/99designs/gqlgen</span></span><br></pre></td></tr></table></figure>

<h2 id="构建服务器"><a href="#构建服务器" class="headerlink" title="构建服务器"></a>构建服务器</h2><p>创建项目框架</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">go run github.com/99designs/gqlgen init</span></span><br></pre></td></tr></table></figure>

<p>这将创建我们建议的项目布局。 如果需要，可以在gqlgen.yml中修改这些路径。</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">├── go.mod</span><br><span class="line">├── go.sum</span><br><span class="line">├── gqlgen.yml               - The gqlgen config file, knobs for controlling the generated code.</span><br><span class="line">├── graph</span><br><span class="line">│   ├── generated            - A package that only contains the generated runtime</span><br><span class="line">│   │   └── generated.go</span><br><span class="line">│   ├── model                - A package for all your graph models, generated or otherwise</span><br><span class="line">│   │   └── models_gen.go</span><br><span class="line">│   ├── resolver.go          - The root graph resolver type. This file wont get regenerated</span><br><span class="line">│   ├── schema.graphqls      - Some schema. You can split the schema into as many graphql files as you like</span><br><span class="line">│   └── schema.resolvers.go  - the resolver implementation for schema.graphql</span><br><span class="line">└── server.go                - The entry point to your app. Customize it however you see fit</span><br></pre></td></tr></table></figure>

<p>定义您的schema<br>gqlgen是一个架构优先的库-在编写代码之前，您使用GraphQL架构定义语言描述您的API。 默认情况下，它进入一个名为schema.graphql的文件中，但是您可以根据需要将其分解为<strong>多个不同</strong>的文件。</p>
<p>为我们生成的schema是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">type Todo &#123;</span><br><span class="line">  id: ID!</span><br><span class="line">  text: String!</span><br><span class="line">  done: Boolean!</span><br><span class="line">  user: User!</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type User &#123;</span><br><span class="line">  id: ID!</span><br><span class="line">  name: String!</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type Query &#123;</span><br><span class="line">  todos: [Todo!]!</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">input NewTodo &#123;</span><br><span class="line">  text: String!</span><br><span class="line">  userId: String!</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type Mutation &#123;</span><br><span class="line">  createTodo(input: NewTodo!): Todo!</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>实现解析器</strong><br><code>gqlgen generate</code>将模式文件（<code>graph/schema.graphqls</code>）与模型<code>graph/model/*</code>进行比较，并且它将在任何可能的地方直接绑定到模型。</p>
<p>如果我们查看<code>graph/schema.resolvers.go</code>，我们将看到gqlgen无法匹配它们的所有情况。 对我们来说是两次：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">func (r *mutationResolver) CreateTodo(ctx context.Context, input model.NewTodo) (*model.Todo, error) &#123;</span><br><span class="line">	panic(fmt.Errorf(&quot;not implemented&quot;))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (r *queryResolver) Todos(ctx context.Context) ([]*model.Todo, error) &#123;</span><br><span class="line">	panic(fmt.Errorf(&quot;not implemented&quot;))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们只需要实现以下两种方法即可使服务器工作：</p>
<p>首先，我们需要一个跟踪状态的地方，将其放入<code>graph/resolver.go</code>：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Resolver <span class="keyword">struct</span>&#123;</span><br><span class="line">	todos []*model.Todo</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这是我们在其中声明应用程序（如数据库）的任何依赖关系的地方，当我们创建graph时，它将在server.go中初始化一次。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *mutationResolver)</span></span> CreateTodo(ctx context.Context, input model.NewTodo) (*model.Todo, <span class="type">error</span>) &#123;</span><br><span class="line">	todo := &amp;model.Todo&#123;</span><br><span class="line">		Text:   input.Text,</span><br><span class="line">		ID:     fmt.Sprintf(<span class="string">&quot;T%d&quot;</span>, rand.Int()),</span><br><span class="line">		User: &amp;model.User&#123;ID: input.UserID, Name: <span class="string">&quot;user &quot;</span> + input.UserID&#125;,</span><br><span class="line">	&#125;</span><br><span class="line">	r.todos = <span class="built_in">append</span>(r.todos, todo)</span><br><span class="line">	<span class="keyword">return</span> todo, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *queryResolver)</span></span> Todos(ctx context.Context) ([]*model.Todo, <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="keyword">return</span> r.todos, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在，我们有一个正常工作的服务器来启动它：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go run server.go</span><br></pre></td></tr></table></figure>

<p>然后在浏览器中打开<a href="http://localhost:8080。这是一些查询尝试：">http://localhost:8080。这是一些查询尝试：</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">mutation createTodo &#123;</span><br><span class="line">  createTodo(input:&#123;text:&quot;todo&quot;, userId:&quot;1&quot;&#125;) &#123;</span><br><span class="line">    user &#123;</span><br><span class="line">      id</span><br><span class="line">    &#125;</span><br><span class="line">    text</span><br><span class="line">    done</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">query findTodos &#123;</span><br><span class="line">    todos &#123;</span><br><span class="line">      text</span><br><span class="line">      done</span><br><span class="line">      user &#123;</span><br><span class="line">        name</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>不要急于吸引用户</strong><br>这个例子很棒，但是在现实世界中，获取大多数对象很多余。 除非用户实际要求，否则我们不希望将用户加载到待办事项上。 因此，让我们将生成的Todo模型替换为更实际的东西。</p>
<p>创建一个名为<code>graph/model/todo.go</code>的新文件</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> model</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Todo <span class="keyword">struct</span> &#123;</span><br><span class="line">	ID     <span class="type">string</span> <span class="string">`json:&quot;id&quot;`</span></span><br><span class="line">	Text   <span class="type">string</span> <span class="string">`json:&quot;text&quot;`</span></span><br><span class="line">	Done   <span class="type">bool</span>   <span class="string">`json:&quot;done&quot;`</span></span><br><span class="line">	UserID <span class="type">string</span> <span class="string">`json:&quot;user&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意</p>
<p>默认情况下，gqlgen将使用模型目录中名称匹配的任何模型，可以在gqlgen.yml中进行配置。</p>
</blockquote>
<p>然后运行<code>github.com/99designs/gqlgen generate</code>。</p>
<p>现在，如果我们在<code>graph/schema.resolvers.go</code>中查看，我们可以看到一个新的解析器，实现它并修复CreateTodo。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *mutationResolver)</span></span> CreateTodo(ctx context.Context, input model.NewTodo) (*model.Todo, <span class="type">error</span>) &#123;</span><br><span class="line">	todo := &amp;model.Todo&#123;</span><br><span class="line">		Text:   input.Text,</span><br><span class="line">		ID:     fmt.Sprintf(<span class="string">&quot;T%d&quot;</span>, rand.Int()),</span><br><span class="line">		UserID: input.UserID, <span class="comment">// fix this line</span></span><br><span class="line">	&#125;</span><br><span class="line">	r.todos = <span class="built_in">append</span>(r.todos, todo)</span><br><span class="line">	<span class="keyword">return</span> todo, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *todoResolver)</span></span> User(ctx context.Context, obj *model.Todo) (*model.User, <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;model.User&#123;ID: obj.UserID, Name: <span class="string">&quot;user &quot;</span> + obj.UserID&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="画龙点睛"><a href="#画龙点睛" class="headerlink" title="画龙点睛"></a>画龙点睛</h2><p>在我们的<code>resolver.go</code>的顶部，在<code>package</code>和<code>import</code>之间，添加以下行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">//go:generate go run github.com/99designs/gqlgen</span><br></pre></td></tr></table></figure>

<p>这个神奇的注释告诉<code>go generate</code>当我们想重新生成代码时要运行什么命令。 要在整个项目中递归运行go generate，请使用以下命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go generate ./...</span><br></pre></td></tr></table></figure>

<h1 id="3-配置"><a href="#3-配置" class="headerlink" title="3.配置"></a>3.配置</h1><p>如何使用gqlgen.yml配置gqlgen</p>
<p>可以使用gqlgen.yml文件配置gqlgen，默认情况下将从当前目录或任何父目录中加载它。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Where are all the schema files located? globs are supported eg  src/**/*.graphqls</span></span><br><span class="line"><span class="attr">schema:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">graph/*.graphqls</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Where should the generated server code go?</span></span><br><span class="line"><span class="attr">exec:</span></span><br><span class="line">  <span class="attr">filename:</span> <span class="string">graph/generated/generated.go</span></span><br><span class="line">  <span class="attr">package:</span> <span class="string">generated</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Enable Apollo federation support</span></span><br><span class="line"><span class="attr">federation:</span></span><br><span class="line">  <span class="attr">filename:</span> <span class="string">graph/generated/federation.go</span></span><br><span class="line">  <span class="attr">package:</span> <span class="string">generated</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Where should any generated models go?</span></span><br><span class="line"><span class="attr">model:</span></span><br><span class="line">  <span class="attr">filename:</span> <span class="string">graph/model/models_gen.go</span></span><br><span class="line">  <span class="attr">package:</span> <span class="string">model</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Where should the resolver implementations go?</span></span><br><span class="line"><span class="attr">resolver:</span></span><br><span class="line">  <span class="attr">layout:</span> <span class="string">follow-schema</span></span><br><span class="line">  <span class="attr">dir:</span> <span class="string">graph</span></span><br><span class="line">  <span class="attr">package:</span> <span class="string">graph</span></span><br><span class="line">  <span class="attr">filename_template:</span> <span class="string">&quot;&#123;name&#125;.resolvers.go&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Optional: turn on use ` + &quot;`&quot; + `gqlgen:&quot;fieldName&quot;` + &quot;`&quot; + ` tags in your models</span></span><br><span class="line"><span class="comment"># struct_tag: json</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Optional: turn on to use []Thing instead of []*Thing</span></span><br><span class="line"><span class="comment"># omit_slice_element_pointers: false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Optional: set to speed up generation time by not performing a final validation pass.</span></span><br><span class="line"><span class="comment"># skip_validation: true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># gqlgen will search for any type names in the schema in these go packages</span></span><br><span class="line"><span class="comment"># if they match it will use them, otherwise it will generate them.</span></span><br><span class="line"><span class="attr">autobind:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;github.com/your/app/graph/model&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># This section declares type mapping between the GraphQL and go type systems</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># The first line in each type will be used as defaults for resolver arguments and</span></span><br><span class="line"><span class="comment"># modelgen, the others will be allowed when binding to fields. Configure them to</span></span><br><span class="line"><span class="comment"># your liking</span></span><br><span class="line"><span class="attr">models:</span></span><br><span class="line">  <span class="attr">ID:</span></span><br><span class="line">    <span class="attr">model:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">github.com/99designs/gqlgen/graphql.ID</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">github.com/99designs/gqlgen/graphql.Int</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">github.com/99designs/gqlgen/graphql.Int64</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">github.com/99designs/gqlgen/graphql.Int32</span></span><br><span class="line">  <span class="attr">Int:</span></span><br><span class="line">    <span class="attr">model:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">github.com/99designs/gqlgen/graphql.Int</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">github.com/99designs/gqlgen/graphql.Int64</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">github.com/99designs/gqlgen/graphql.Int3</span></span><br></pre></td></tr></table></figure>

<p>一切都有默认值，因此可以根据需要添加。</p>
<h2 id="带指令的内联配置"><a href="#带指令的内联配置" class="headerlink" title="带指令的内联配置"></a>带指令的内联配置</h2><p>gqlgen附带了一些内置指令，这使得管理接线更加容易。</p>
<p>要开始使用它们，您首先需要定义它们：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">directive @goModel(model: String, models: [String!]) on OBJECT</span><br><span class="line">    | INPUT_OBJECT</span><br><span class="line">    | SCALAR</span><br><span class="line">    | ENUM</span><br><span class="line">    | INTERFACE</span><br><span class="line">    | UNION</span><br><span class="line"></span><br><span class="line">directive @goField(forceResolver: Boolean, name: String) on INPUT_FIELD_DEFINITION</span><br><span class="line">    | FIELD_DEFINITION</span><br></pre></td></tr></table></figure>

<blockquote>
<p>gqlgen当前不支持SCALAR，ENUM，INTERFACE或UNION的用户可配置指令。 这仅适用于内部指令。 您可以在此处跟踪进度</p>
</blockquote>
<p>现在，您可以在schema中定义类型时使用以下指令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">type User @goModel(model: &quot;github.com/my/app/models.User&quot;) &#123;</span><br><span class="line">    id: ID!         @goField(name: &quot;todoId&quot;)</span><br><span class="line">    name: String!   @goField(forceResolver: true)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="4-参考"><a href="#4-参考" class="headerlink" title="4.参考"></a>4.参考</h1><h2 id="4-1-APQ"><a href="#4-1-APQ" class="headerlink" title="4.1 APQ"></a>4.1 APQ</h2><p>自动持久查询</p>
<p>默认情况下，当您使用GraphQL时，查询将随每个请求一起传输。 这会浪费大量带宽。 为避免这种情况，您可以使用自动持久查询（APQ）。</p>
<p>使用APQ，您仅将查询哈希发送到服务器。 如果在服务器上未找到哈希，则客户端会再次请求在服务器上向原始查询注册查询哈希。</p>
<h3 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h3><p>为了启用自动持久查询，您需要更改客户端。 有关更多信息，请参见<a target="_blank" rel="noopener" href="https://github.com/apollographql/apollo-link-persisted-queries">自动持久查询链接</a>文档。</p>
<p>对于服务器，您需要实现<code>PersistedQueryCache</code>接口并将实例传递给<code>handler.EnablePersistedQueryCache</code>选项。</p>
<p>请参阅以下使用<a target="_blank" rel="noopener" href="https://github.com/go-redis/redis">go-redis</a>软件包的示例：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;context&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/99designs/gqlgen/graphql/handler&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/99designs/gqlgen/graphql/handler/extension&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/99designs/gqlgen/graphql/handler/transport&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/go-redis/redis&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Cache <span class="keyword">struct</span> &#123;</span><br><span class="line">	client redis.UniversalClient</span><br><span class="line">	ttl    time.Duration</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> apqPrefix = <span class="string">&quot;apq:&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewCache</span><span class="params">(redisAddress <span class="type">string</span>, password <span class="type">string</span>, ttl time.Duration)</span></span> (*Cache, <span class="type">error</span>) &#123;</span><br><span class="line">	client := redis.NewClient(&amp;redis.Options&#123;</span><br><span class="line">		Addr:     redisAddress,</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	err := client.Ping().Err()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;could not create cache: %w&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> &amp;Cache&#123;client: client, ttl: ttl&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Cache)</span></span> Add(ctx context.Context, key <span class="type">string</span>, value <span class="keyword">interface</span>&#123;&#125;) &#123;</span><br><span class="line">	c.client.Set(apqPrefix+key, value, c.ttl)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Cache)</span></span> Get(ctx context.Context, key <span class="type">string</span>) (<span class="keyword">interface</span>&#123;&#125;, <span class="type">bool</span>) &#123;</span><br><span class="line">	s, err := c.client.Get(apqPrefix + key).Result()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">struct</span>&#123;&#125;&#123;&#125;, <span class="literal">false</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> s, <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	cache, err := NewCache(cfg.RedisAddress, <span class="number">24</span>*time.Hour)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;cannot create APQ redis cache: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	c := Config&#123; Resolvers: &amp;resolvers&#123;&#125; &#125;</span><br><span class="line">	gqlHandler := handler.New(</span><br><span class="line">		generated.NewExecutableSchema(c),</span><br><span class="line">	)</span><br><span class="line">	gqlHandler.AddTransport(transport.POST&#123;&#125;)</span><br><span class="line">	gqlHandler.Use(extension.AutomaticPersistedQuery&#123;Cache: cache&#125;)</span><br><span class="line">	http.Handle(<span class="string">&quot;/query&quot;</span>, gqlHandler)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="4-2-变更集"><a href="#4-2-变更集" class="headerlink" title="4.2 变更集"></a>4.2 变更集</h2><p>使用地图作为变更集</p>
<p>有时，您需要将状态与nil（未定义和空）区分开。 在gqlgen中，我们使用地图进行此操作：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">type Query &#123;</span><br><span class="line">	updateUser(id: ID!, changes: UserChanges!): User</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type UserChanges &#123;</span><br><span class="line">	name: String</span><br><span class="line">	email: String</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在配置中将类型设置为<code>map [string] interface &#123;&#125;</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">models:</span></span><br><span class="line">  <span class="attr">UserChanges:</span></span><br><span class="line">    <span class="attr">model:</span> <span class="string">&quot;map[string]interface&#123;&#125;&quot;</span></span><br></pre></td></tr></table></figure>

<p>运行<code>go generate</code>之后，您应该得到一个看起来像这样的解析器：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *queryResolver)</span></span> UpdateUser(ctx context.Context, id <span class="type">int</span>, changes <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;) (*User, <span class="type">error</span>) &#123;</span><br><span class="line">	u := fetchFromDb(id)</span><br><span class="line">	<span class="comment">/// apply the changes</span></span><br><span class="line">	saveToDb(u)</span><br><span class="line">	<span class="keyword">return</span> u, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们经常使用<code>mapstructure</code>库通过反射将这些变更集直接直接应用于对象：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ApplyChanges</span><span class="params">(changes <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;, to <span class="keyword">interface</span>&#123;&#125;)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">	dec, err := mapstructure.NewDecoder(&amp;mapstructure.DecoderConfig&#123;</span><br><span class="line">		ErrorUnused: <span class="literal">true</span>,</span><br><span class="line">		TagName:     <span class="string">&quot;json&quot;</span>,</span><br><span class="line">		Result:      to,</span><br><span class="line">		ZeroFields:  <span class="literal">true</span>,</span><br><span class="line">		<span class="comment">// This is needed to get mapstructure to call the gqlgen unmarshaler func for custom scalars (eg Date)</span></span><br><span class="line">		DecodeHook: <span class="function"><span class="keyword">func</span><span class="params">(a reflect.Type, b reflect.Type, v <span class="keyword">interface</span>&#123;&#125;)</span></span> (<span class="keyword">interface</span>&#123;&#125;, <span class="type">error</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span> reflect.PtrTo(b).Implements(reflect.TypeOf((*graphql.Unmarshaler)(<span class="literal">nil</span>)).Elem()) &#123;</span><br><span class="line">				resultType := reflect.New(b)</span><br><span class="line">				result := resultType.MethodByName(<span class="string">&quot;UnmarshalGQL&quot;</span>).Call([]reflect.Value&#123;reflect.ValueOf(v)&#125;)</span><br><span class="line">				err, _ := result[<span class="number">0</span>].Interface().(<span class="type">error</span>)</span><br><span class="line">				<span class="keyword">return</span> resultType.Elem().Interface(), err</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">return</span> v, <span class="literal">nil</span></span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> dec.Decode(changes)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-3-数据加载器"><a href="#4-3-数据加载器" class="headerlink" title="4.3 数据加载器"></a>4.3 数据加载器</h2><p>使用数据加载器优化N + 1数据库查询</p>
<p>您是否注意到某些GraphQL查询端可以进行数百个数据库查询，这些查询通常包含重复的数据？ 让我们来看看为什么以及如何修复它。</p>
<h3 id="查询解析"><a href="#查询解析" class="headerlink" title="查询解析"></a>查询解析</h3><p>想象一下，如果您有一个简单的查询，例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">query &#123; todos &#123; users &#123; name &#125; &#125; &#125;</span><br></pre></td></tr></table></figure>

<p>我们的<code>todo.user</code>解析器如下所示：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *todoResolver)</span></span> UserRaw(ctx context.Context, obj *model.Todo) (*model.User, <span class="type">error</span>) &#123;</span><br><span class="line">	res := db.LogAndQuery(r.Conn, <span class="string">&quot;SELECT id, name FROM dataloader_example.user WHERE id = ?&quot;</span>, obj.UserID)</span><br><span class="line">	<span class="keyword">defer</span> res.Close()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> !res.Next() &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">var</span> user model.User</span><br><span class="line">	<span class="keyword">if</span> err := res.Scan(&amp;user.ID, &amp;user.Name); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> &amp;user, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>：我将在此处使用go的低级sql.DB。 所有这一切都将与您喜欢的ORM一起使用。</p>
<p>查询执行程序将调用<code>Query.Todos</code>解析器，该解析器<code>select * from todo</code>，并返回N个todos。 然后，对于每个待办事项，同时调用Todo_user解析程序，<code>SELECT * from USER where id = todo.user_id</code>。</p>
<p>eg:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> id, todo, user_id <span class="keyword">FROM</span> todo</span><br><span class="line"><span class="keyword">SELECT</span> id, name <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> ?</span><br><span class="line"><span class="keyword">SELECT</span> id, name <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> ?</span><br><span class="line"><span class="keyword">SELECT</span> id, name <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> ?</span><br><span class="line"><span class="keyword">SELECT</span> id, name <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> ?</span><br><span class="line"><span class="keyword">SELECT</span> id, name <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> ?</span><br><span class="line"><span class="keyword">SELECT</span> id, name <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> ?</span><br><span class="line"><span class="keyword">SELECT</span> id, name <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> ?</span><br><span class="line"><span class="keyword">SELECT</span> id, name <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> ?</span><br><span class="line"><span class="keyword">SELECT</span> id, name <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> ?</span><br><span class="line"><span class="keyword">SELECT</span> id, name <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> ?</span><br><span class="line"><span class="keyword">SELECT</span> id, name <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> ?</span><br><span class="line"><span class="keyword">SELECT</span> id, name <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> ?</span><br><span class="line"><span class="keyword">SELECT</span> id, name <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> ?</span><br><span class="line"><span class="keyword">SELECT</span> id, name <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> ?</span><br><span class="line"><span class="keyword">SELECT</span> id, name <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> ?</span><br><span class="line"><span class="keyword">SELECT</span> id, name <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> ?</span><br><span class="line"><span class="keyword">SELECT</span> id, name <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> ?</span><br><span class="line"><span class="keyword">SELECT</span> id, name <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> ?</span><br><span class="line"><span class="keyword">SELECT</span> id, name <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> ?</span><br><span class="line"><span class="keyword">SELECT</span> id, name <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> ?</span><br></pre></td></tr></table></figure>

<p>更糟的是？ 这些待办事项大多数都由同一用户拥有！ 我们可以做得更好。</p>
<h2 id="4-4-Dataloader"><a href="#4-4-Dataloader" class="headerlink" title="4.4 Dataloader"></a>4.4 Dataloader</h2><p>我们需要的是一种对所有并发请求进行分组，取出所有重复项并进行存储的方式，以备日后在请求中需要时使用。 数据加载器就是这样，它是一种由Facebook普及的请求范围的批处理和缓存解决方案。</p>
<p>我们将使用dataloaden构建数据加载器。 在具有泛型的语言中，我们可能只是创建一个DataLoader，但golang没有泛型。 相反，我们为实例手动生成代码。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">go get github.com/vektah/dataloaden</span><br><span class="line">mkdir dataloader</span><br><span class="line">cd dataloader</span><br><span class="line">go run github.com/vektah/dataloaden UserLoader int *gqlgen-tutorials/dataloader/graph/model.User</span><br></pre></td></tr></table></figure>

<p>接下来，我们需要创建新数据加载器的实例，并告诉您如何获取数据。 由于数据加载器是请求范围的，因此非常适合上下文。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> loadersKey = <span class="string">&quot;dataloaders&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Loaders <span class="keyword">struct</span> &#123;</span><br><span class="line">	UserById UserLoader</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Middleware</span><span class="params">(conn *sql.DB, next http.Handler)</span></span> http.Handler &#123;</span><br><span class="line">	<span class="keyword">return</span> http.HandlerFunc(<span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">		ctx := context.WithValue(r.Context(), loadersKey, &amp;Loaders&#123;</span><br><span class="line">			UserById: UserLoader&#123;</span><br><span class="line">				maxBatch: <span class="number">100</span>,</span><br><span class="line">				wait:     <span class="number">1</span> * time.Millisecond,</span><br><span class="line">				fetch: <span class="function"><span class="keyword">func</span><span class="params">(ids []<span class="type">int</span>)</span></span> ([]*model.User, []<span class="type">error</span>) &#123;</span><br><span class="line">					placeholders := <span class="built_in">make</span>([]<span class="type">string</span>, <span class="built_in">len</span>(ids))</span><br><span class="line">					args := <span class="built_in">make</span>([]<span class="keyword">interface</span>&#123;&#125;, <span class="built_in">len</span>(ids))</span><br><span class="line">					<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(ids); i++ &#123;</span><br><span class="line">						placeholders[i] = <span class="string">&quot;?&quot;</span></span><br><span class="line">						args[i] = i</span><br><span class="line">					&#125;</span><br><span class="line"></span><br><span class="line">					res := db.LogAndQuery(conn,</span><br><span class="line">						<span class="string">&quot;SELECT id, name from dataloader_example.user WHERE id IN (&quot;</span>+strings.Join(placeholders, <span class="string">&quot;,&quot;</span>)+<span class="string">&quot;)&quot;</span>,</span><br><span class="line">						args...,</span><br><span class="line">					)</span><br><span class="line">					<span class="keyword">defer</span> res.Close()</span><br><span class="line"></span><br><span class="line">					userById := <span class="keyword">map</span>[<span class="type">int</span>]*model.User&#123;&#125;</span><br><span class="line">					<span class="keyword">for</span> res.Next() &#123;</span><br><span class="line">						user := model.User&#123;&#125;</span><br><span class="line">						err := res.Scan(&amp;user.ID, &amp;user.Name)</span><br><span class="line">						<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">							<span class="built_in">panic</span>(err)</span><br><span class="line">						&#125;</span><br><span class="line">						userById[user.ID] = &amp;user</span><br><span class="line">					&#125;</span><br><span class="line"></span><br><span class="line">					users := <span class="built_in">make</span>([]*model.User, <span class="built_in">len</span>(ids))</span><br><span class="line">					<span class="keyword">for</span> i, id := <span class="keyword">range</span> ids &#123;</span><br><span class="line">						users[i] = userById[id]</span><br><span class="line">					&#125;</span><br><span class="line"></span><br><span class="line">					<span class="keyword">return</span> users, <span class="literal">nil</span></span><br><span class="line">				&#125;,</span><br><span class="line">			&#125;,</span><br><span class="line">		&#125;)</span><br><span class="line">		r = r.WithContext(ctx)</span><br><span class="line">		next.ServeHTTP(w, r)</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">For</span><span class="params">(ctx context.Context)</span></span> *Loaders &#123;</span><br><span class="line">	<span class="keyword">return</span> ctx.Value(loadersKey).(*Loaders)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该数据加载器将等待1毫秒以获取100个唯一请求，然后调用提取函数。 这个函数有点丑陋，但是其中一半只是构建SQL！</p>
<p>现在，让我们更新解析器以调用数据加载器：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *todoResolver)</span></span> UserLoader(ctx context.Context, obj *model.Todo) (*model.User, <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="keyword">return</span> dataloader.For(ctx).UserById.Load(obj.UserID)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最终结果？仅2个查询！</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> id, todo, user_id <span class="keyword">FROM</span> todo</span><br><span class="line"><span class="keyword">SELECT</span> id, name <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> id <span class="keyword">IN</span> (?,?,?,?,?)</span><br></pre></td></tr></table></figure>

<p>生成的UserLoader上还有其他一些有用的方法：</p>
<ul>
<li>LoadAll（keys）：如果您预先知道，则需要一堆用户</li>
<li>Prime（key，user）：用于在类似的加载器（usersById，usersByNote）之间同步状态</li>
</ul>
<p>您可以在此处查看完整的工作<a target="_blank" rel="noopener" href="https://github.com/vektah/gqlgen-tutorials/tree/master/dataloader">示例</a>。</p>
<h2 id="4-5-字段收集"><a href="#4-5-字段收集" class="headerlink" title="4.5 字段收集"></a>4.5 字段收集</h2><p>确定查询请求哪些字段</p>
<p>知道在解析器中查询哪些字段通常很有用。 拥有此信息可以使解析程序仅从数据源获取所需的字段集，而不是过度获取所有内容并允许gqlgen进行其余操作。</p>
<p>此过程称为字段收集gqlgen自动执行此操作，以便知道哪些字段应成为响应有效负载的一部分。 但是，收集的字段集确实取决于要解析的类型。 查询可以包含片段，而解析程序可以返回接口和联合，因此在知道解析对象的类型之前，无法完全确定所收集字段的集合。</p>
<p>在解析程序中，有几种API方法可用于查询所选字段。</p>
<h3 id="CollectAllFields"><a href="#CollectAllFields" class="headerlink" title="CollectAllFields"></a>CollectAllFields</h3><p><code>CollectAllFields</code>是获取查询字段集的最简单方法。 它将从查询中返回字段名称的字符串片段。 这将是一组唯一的字段，并且将返回所有片段字段，而忽略片段类型条件。</p>
<p>给定以下示例查询：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">query &#123;</span><br><span class="line">    foo &#123;</span><br><span class="line">        fieldA</span><br><span class="line">        ... on Bar &#123;</span><br><span class="line">            fieldB</span><br><span class="line">        &#125;</span><br><span class="line">        ... on Baz &#123;</span><br><span class="line">            fieldC</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从解析器调用<code>CollectAllFields</code>将产生一个包含fieldA，fieldB和fieldC的字符串切片。</p>
<h3 id="CollectFieldsCtx"><a href="#CollectFieldsCtx" class="headerlink" title="CollectFieldsCtx"></a>CollectFieldsCtx</h3><p>如果需要更多有关匹配的信息，或者收集的字段集应与解析类型的片段类型条件匹配，则<code>CollectFieldsCtx</code>很有用。<code>CollectFieldsCtx</code>带有一个令人满意的参数，该参数应该是解析类型将满足的类型的字符串的一部分。</p>
<p>例如，给定以下架构：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">interface Shape &#123;</span><br><span class="line">    area: Float</span><br><span class="line">&#125;</span><br><span class="line">type Circle implements Shape &#123;</span><br><span class="line">    radius: Float</span><br><span class="line">    area: Float</span><br><span class="line">&#125;</span><br><span class="line">union Shapes = Circle</span><br></pre></td></tr></table></figure>

<p><code>Circle</code>类型将满足<code>Circle</code>，<code>Shape</code>和<code>Shapes</code>的类型-这些值应传递给<code>CollectFieldsCtx</code>以获取已解析的<code>Circle</code>对象的一组收集字段。</p>
<blockquote>
<p>注意</p>
<p>CollectFieldsCtx只是CollectFields的便利包装，它使用解析器上下文中自动传递的选择集调用后面的内容。</p>
</blockquote>
<h3 id="实际例子"><a href="#实际例子" class="headerlink" title="实际例子"></a>实际例子</h3><p>我们有以下GraphQL查询</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">query &#123;</span><br><span class="line">  flowBlocks &#123;</span><br><span class="line">    id</span><br><span class="line">    block &#123;</span><br><span class="line">      id</span><br><span class="line">      title</span><br><span class="line">      type</span><br><span class="line">      choices &#123;</span><br><span class="line">        id</span><br><span class="line">        title</span><br><span class="line">        description</span><br><span class="line">        slug</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们不想超载我们的数据库，所以我们想知道请求哪个字段。 这是一个示例，该示例将所有请求的字段都作为方便的字符串片段，可以方便地进行检查。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetPreloads</span><span class="params">(ctx context.Context)</span></span> []<span class="type">string</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> GetNestedPreloads(</span><br><span class="line">		graphql.GetOperationContext(ctx),</span><br><span class="line">		graphql.CollectFieldsCtx(ctx, <span class="literal">nil</span>),</span><br><span class="line">		<span class="string">&quot;&quot;</span>,</span><br><span class="line">	)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetNestedPreloads</span><span class="params">(ctx *graphql.OperationContext, fields []graphql.CollectedField, prefix <span class="type">string</span>)</span></span> (preloads []<span class="type">string</span>) &#123;</span><br><span class="line">	<span class="keyword">for</span> _, column := <span class="keyword">range</span> fields &#123;</span><br><span class="line">		prefixColumn := GetPreloadString(prefix, column.Name)</span><br><span class="line">		preloads = <span class="built_in">append</span>(preloads, prefixColumn)</span><br><span class="line">		preloads = <span class="built_in">append</span>(preloads, GetNestedPreloads(ctx, graphql.CollectFields(ctx, column.Selections, <span class="literal">nil</span>), prefixColumn)...)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetPreloadString</span><span class="params">(prefix, name <span class="type">string</span>)</span></span> <span class="type">string</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(prefix) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> prefix + <span class="string">&quot;.&quot;</span> + name</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> name</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因此，如果我们在解析器中调用这些助手：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *queryResolver)</span></span> FlowBlocks(ctx context.Context) ([]*FlowBlock, <span class="type">error</span>) &#123;</span><br><span class="line">	preloads := getPreloads(ctx)</span><br></pre></td></tr></table></figure>

<p>它将导致以下字符串切片：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&quot;id&quot;, &quot;block&quot;, &quot;block.id&quot;, &quot;block.title&quot;, &quot;block.type&quot;, &quot;block.choices&quot;, &quot;block.choices.id&quot;, &quot;block.choices.title&quot;, &quot;block.choices.description&quot;, &quot;block.choices.slug&quot;]</span><br></pre></td></tr></table></figure>

<h2 id="4-6-上传文件"><a href="#4-6-上传文件" class="headerlink" title="4.6 上传文件"></a>4.6 上传文件</h2><p>Graphql服务器具有内置的Upload标量，可使用分段请求上传文件。<br>它实现了以下规范<a target="_blank" rel="noopener" href="https://github.com/jaydenseric/graphql-multipart-request-spec%EF%BC%8C%E8%AF%A5%E8%A7%84%E8%8C%83%E5%AE%9A%E4%B9%89%E4%BA%86%E7%94%A8%E4%BA%8EGraphQL%E8%AF%B7%E6%B1%82%E7%9A%84%E5%8F%AF%E4%BA%92%E6%93%8D%E4%BD%9C%E7%9A%84%E5%A4%9A%E9%83%A8%E5%88%86%E8%A1%A8%E5%8D%95%E5%AD%97%E6%AE%B5%E7%BB%93%E6%9E%84%EF%BC%8C%E4%BE%9B%E5%90%84%E7%A7%8D%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%AE%9E%E7%8E%B0%E4%BD%BF%E7%94%A8%E3%80%82">https://github.com/jaydenseric/graphql-multipart-request-spec，该规范定义了用于GraphQL请求的可互操作的多部分表单字段结构，供各种文件上传客户端实现使用。</a></p>
<p>要使用它，您需要在架构中添加Upload标量，它将自动将编组行为添加到Go类型。</p>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>可以配置两个用于上传文件的特定选项：</p>
<ul>
<li>uploadMaxSize<br>此选项指定用于将请求正文解析为<code>multipart/form-data</code>的最大字节数。</li>
<li>uploadMaxMemory<br>此选项指定用于将请求正文解析为内存中的<code>multipart/form-data</code>的最大字节数，其余部分存储在磁盘上的临时文件中。</li>
</ul>
<h3 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h3><h4 id="单文件上传"><a href="#单文件上传" class="headerlink" title="单文件上传"></a>单文件上传</h4><p>对于此用例，架构可能如下所示。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&quot;The `UploadFile, // b.txt` scalar type represents a multipart file upload.&quot;</span><br><span class="line">scalar Upload</span><br><span class="line"></span><br><span class="line">&quot;The `Query` type, represents all of the entry points into our object graph.&quot;</span><br><span class="line">type Query &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&quot;The `Mutation` type, represents all updates we can make to our data.&quot;</span><br><span class="line">type Mutation &#123;</span><br><span class="line">    singleUpload(file: Upload!): Bool!</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以使用cURL进行查询，如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl localhost:4000/graphql \</span><br><span class="line">  -F operations=&#x27;&#123; &quot;query&quot;: &quot;mutation ($file: Upload!) &#123; singleUpload(file: $file) &#123; id &#125; &#125;&quot;, &quot;variables&quot;: &#123; &quot;file&quot;: null &#125; &#125;&#x27; \</span><br><span class="line">  -F map=&#x27;&#123; &quot;0&quot;: [&quot;variables.file&quot;] &#125;&#x27; \</span><br><span class="line">  -F 0=@a.txt</span><br></pre></td></tr></table></figure>

<p>这将调用以下操作：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  query: `</span><br><span class="line">    mutation($file: Upload!) &#123;</span><br><span class="line">      singleUpload(file: $file) &#123;</span><br><span class="line">        id</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  `,</span><br><span class="line">  variables: &#123;</span><br><span class="line">    file: File // a.txt</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="多文件上传"><a href="#多文件上传" class="headerlink" title="多文件上传"></a>多文件上传</h4><p>对于此用例，架构可能如下所示。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&quot;The `Upload` scalar type represents a multipart file upload.&quot;</span><br><span class="line">scalar Upload</span><br><span class="line"></span><br><span class="line">&quot;The `File` type, represents the response of uploading a file.&quot;</span><br><span class="line">type File &#123;</span><br><span class="line">    id: Int!</span><br><span class="line">    name: String!</span><br><span class="line">    content: String!</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&quot;The `UploadFile` type, represents the request for uploading a file with a certain payload.&quot;</span><br><span class="line">input UploadFile &#123;</span><br><span class="line">    id: Int!</span><br><span class="line">    file: Upload!</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&quot;The `Query` type, represents all of the entry points into our object graph.&quot;</span><br><span class="line">type Query &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&quot;The `Mutation` type, represents all updates we can make to our data.&quot;</span><br><span class="line">type Mutation &#123;</span><br><span class="line">    multipleUpload(req: [UploadFile!]!): [File!]!</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以使用cURL进行查询，如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl localhost:4000/query \</span><br><span class="line">  -F operations=&#x27;&#123; &quot;query&quot;: &quot;mutation($req: [UploadFile!]!) &#123; multipleUpload(req: $req) &#123; id, name, content &#125; &#125;&quot;, &quot;variables&quot;: &#123; &quot;req&quot;: [ &#123; &quot;id&quot;: 1, &quot;file&quot;: null &#125;, &#123; &quot;id&quot;: 2, &quot;file&quot;: null &#125; ] &#125; &#125;&#x27; \</span><br><span class="line">  -F map=&#x27;&#123; &quot;0&quot;: [&quot;variables.req.0.file&quot;], &quot;1&quot;: [&quot;variables.req.1.file&quot;] &#125;&#x27; \</span><br><span class="line">  -F 0=@b.txt \</span><br><span class="line">  -F 1=@c.txt</span><br></pre></td></tr></table></figure>

<p>这将调用以下操作：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  query: `</span><br><span class="line">    mutation($req: [UploadFile!]!)</span><br><span class="line">      multipleUpload(req: $req) &#123;</span><br><span class="line">        id,</span><br><span class="line">        name,</span><br><span class="line">        content</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  `,</span><br><span class="line">  variables: &#123;</span><br><span class="line">    req: [</span><br><span class="line">        &#123;</span><br><span class="line">            id: 1,</span><br><span class="line">            File, // b.txt</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            id: 2,</span><br><span class="line">            File, // c.txt</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有关更多示例，请参见<a href="example/fileupload">example&#x2F;fileupload</a>软件包。</p>
<h3 id="Apollo的用法"><a href="#Apollo的用法" class="headerlink" title="Apollo的用法"></a>Apollo的用法</h3><p>需要安装apollo-upload-client才能使文件上传与Apollo一起使用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">ApolloClient</span> <span class="keyword">from</span> <span class="string">&quot;apollo-client&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; createUploadLink &#125; <span class="keyword">from</span> <span class="string">&quot;apollo-upload-client&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> client = <span class="keyword">new</span> <span class="title class_">ApolloClient</span>(&#123;</span><br><span class="line">	<span class="attr">cache</span>: <span class="keyword">new</span> <span class="title class_">InMemoryCache</span>(),</span><br><span class="line">	<span class="attr">link</span>: <span class="title function_">createUploadLink</span>(&#123; <span class="attr">uri</span>: <span class="string">&quot;/graphql&quot;</span> &#125;)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>然后可以将<code>File</code>对象作为变量传递到您的mutation中：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  query: `</span><br><span class="line">    mutation($file: Upload!) &#123;</span><br><span class="line">      singleUpload(file: $file) &#123;</span><br><span class="line">        id</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  `,</span><br><span class="line">  variables: &#123;</span><br><span class="line">    file: new File(...)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-7-处理错误"><a href="#4-7-处理错误" class="headerlink" title="4.7 处理错误"></a>4.7 处理错误</h2><p>在graphql响应中发送自定义错误数据</p>
<h3 id="返回错误"><a href="#返回错误" class="headerlink" title="返回错误"></a>返回错误</h3><p>所有解析器仅返回错误并发送给用户。 假定此处返回的任何错误消息都适合最终用户。 如果某些消息不安全，请自定义错误提示器。</p>
<p>多重错误<br>要返回多个错误，您可以像这样调用<code>graphql.Error</code>函数：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> foo</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;context&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/vektah/gqlparser/v2/gqlerror&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/99designs/gqlgen/graphql&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r Query)</span></span> DoThings(ctx context.Context) (<span class="type">bool</span>, <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="comment">// Print a formatted string</span></span><br><span class="line">	graphql.AddErrorf(ctx, <span class="string">&quot;Error %d&quot;</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Pass an existing error out</span></span><br><span class="line">	graphql.AddError(ctx, gqlerror.Errorf(<span class="string">&quot;zzzzzt&quot;</span>))</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Or fully customize the error</span></span><br><span class="line">	graphql.AddError(ctx, &amp;gqlerror.Error&#123;</span><br><span class="line">		Path:       graphql.GetPath(ctx),</span><br><span class="line">		Message:    <span class="string">&quot;A descriptive error message&quot;</span>,</span><br><span class="line">		Extensions: <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">			<span class="string">&quot;code&quot;</span>: <span class="string">&quot;10-4&quot;</span>,</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// And you can still return an error if you need</span></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>, gqlerror.Errorf(<span class="string">&quot;BOOM! Headshot&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>它们将在响应中以相同顺序返回，例如：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;todo&quot;</span><span class="punctuation">:</span> <span class="keyword">null</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;errors&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span> <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Error 1&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="string">&quot;todo&quot;</span> <span class="punctuation">]</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span> <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;zzzzzt&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="string">&quot;todo&quot;</span> <span class="punctuation">]</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span> <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;A descriptive error message&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="string">&quot;todo&quot;</span> <span class="punctuation">]</span><span class="punctuation">,</span> <span class="attr">&quot;extensions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="string">&quot;10-4&quot;</span> <span class="punctuation">&#125;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span> <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;BOOM! Headshot&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="string">&quot;todo&quot;</span> <span class="punctuation">]</span> <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="钩子"><a href="#钩子" class="headerlink" title="钩子"></a>钩子</h3><p>错误提示器<br>解析程序返回或从验证返回的所有错误在显示给用户之前都要经过一个钩子。 该挂钩使您能够自定义错误，但是在您的应用中有意义。</p>
<p>默认错误提示器将捕获解析器路径，并在响应中使用<code>Error()</code>消息。</p>
<p>您在创建服务器时更改此设置：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> bar</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;context&quot;</span></span><br><span class="line">	<span class="string">&quot;errors&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/vektah/gqlparser/v2/gqlerror&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/99designs/gqlgen/graphql&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/99designs/gqlgen/graphql/handler&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	server := handler.NewDefaultServer(MakeExecutableSchema(resolvers))</span><br><span class="line">	server.SetErrorPresenter(<span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context, e <span class="type">error</span>)</span></span> *gqlerror.Error &#123;</span><br><span class="line">		err := graphql.DefaultErrorPresenter(ctx, e)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">var</span> myErr *MyError</span><br><span class="line">		<span class="keyword">if</span> errors.As(e, &amp;myErr) &#123;</span><br><span class="line">			err.Message = <span class="string">&quot;Eeek!&quot;</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将使用与生成该函数相同的解析器上下文来调用此函数，因此您可以提取当前的解析器路径以及可能要通知客户端的其他任何状态。</p>
<p>紧急处理程序<br>还有一个恐慌处理程序，每当发生恐慌以在停止解析之前向用户正常返回消息时，就会调用该处理程序。 这是通知您的错误跟踪器并将自定义消息发送给用户的好地方。 从这里返回的任何错误也将通过错误提示器。</p>
<p>您在创建服务器时更改此设置：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">server := handler.NewDefaultServer(MakeExecutableSchema(resolvers)</span><br><span class="line">server.SetRecoverFunc(<span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context, err <span class="keyword">interface</span>&#123;&#125;)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// notify bug tracker...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> errors.New(<span class="string">&quot;Internal server error!&quot;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="4-8-内省"><a href="#4-8-内省" class="headerlink" title="4.8 内省"></a>4.8 内省</h2><p>GraphQL的最佳功能之一是强大的发现能力，但有时您不想让其他人探索您的端点。</p>
<h3 id="禁用服务器的自省"><a href="#禁用服务器的自省" class="headerlink" title="禁用服务器的自省"></a>禁用服务器的自省</h3><p>要在运行时打开和关闭自省功能，请在启动服务器时传递IntrospectionEnabled处理程序选项：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">srv := httptest.NewServer(</span><br><span class="line">	handler.GraphQL(</span><br><span class="line">		NewExecutableSchema(Config&#123;Resolvers: resolvers&#125;),</span><br><span class="line">		handler.IntrospectionEnabled(<span class="literal">false</span>),</span><br><span class="line">	),</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h3 id="禁用身份验证的自省"><a href="#禁用身份验证的自省" class="headerlink" title="禁用身份验证的自省"></a>禁用身份验证的自省</h3><p>也可以基于每个请求上下文启用自省。 例如，您可以在基于用户身份验证的中间件中对其进行修改：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">srv := httptest.NewServer(</span><br><span class="line">	handler.GraphQL(</span><br><span class="line">		NewExecutableSchema(Config&#123;Resolvers: resolvers&#125;),</span><br><span class="line">		handler.RequestMiddleware(<span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context, next <span class="keyword">func</span>(ctx context.Context)</span></span> []<span class="type">byte</span>) []<span class="type">byte</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> !userForContext(ctx).IsAdmin &#123;</span><br><span class="line">				graphql.GetOperationContext(ctx).DisableIntrospection = <span class="literal">true</span></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">return</span> next(ctx)</span><br><span class="line">		&#125;),</span><br><span class="line">	),</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h2 id="4-9-插件"><a href="#4-9-插件" class="headerlink" title="4.9 插件"></a>4.9 插件</h2><p>如何为gqlgen编写插件</p>
<p>插件提供了一种进入gqlgen代码生成生命周期的方式。 为了使用默认插件以外的任何东西，您将需要创建自己的入口点：</p>
<h3 id="使用插件"><a href="#使用插件" class="headerlink" title="使用插件"></a>使用插件</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// +build ignore</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;flag&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;io/ioutil&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/99designs/gqlgen/api&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/99designs/gqlgen/codegen/config&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/99designs/gqlgen/plugin/stubgen&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	cfg, err := config.LoadConfigFromDefaultLocations()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Fprintln(os.Stderr, <span class="string">&quot;failed to load config&quot;</span>, err.Error())</span><br><span class="line">		os.Exit(<span class="number">2</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	err = api.Generate(cfg,</span><br><span class="line">		api.AddPlugin(yourplugin.New()), <span class="comment">// This is the magic line</span></span><br><span class="line">	)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Fprintln(os.Stderr, err.Error())</span><br><span class="line">		os.Exit(<span class="number">3</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="编写插件"><a href="#编写插件" class="headerlink" title="编写插件"></a>编写插件</h3><p>当前只有两个钩子：</p>
<ul>
<li>MutateConfig：允许插件在代码生成开始之前对配置进行更改。 这使插件可以添加自定义指令，定义类型并实现解析器。 参见<a target="_blank" rel="noopener" href="https://github.com/99designs/gqlgen/tree/master/plugin/modelgen">modelgen</a>的例子</li>
<li>GenerateCode：允许插件生成新的输出文件，有关示例，请参见<a target="_blank" rel="noopener" href="https://github.com/99designs/gqlgen/tree/master/plugin/stubgen">stubgen</a></li>
</ul>
<p>请查看plugin.go以获取可用钩子的完整列表。 这些可能随每个发行版而改变。</p>
<h2 id="4-10-查询复杂度"><a href="#4-10-查询复杂度" class="headerlink" title="4.10 查询复杂度"></a>4.10 查询复杂度</h2><p>防止过于复杂的查询<br>GraphQL提供了一种强大的查询数据的方法，但是将强大的功能掌握在API客户端上也使您面临拒绝服务攻击的风险。 您可以通过限制允许的查询的复杂性，使用gqlgen减轻这种风险。</p>
<h3 id="代价高的查询"><a href="#代价高的查询" class="headerlink" title="代价高的查询"></a>代价高的查询</h3><p>考虑一种允许列出博客文章的架构。 每个博客帖子也与其他帖子相关。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">type Query &#123;</span><br><span class="line">	posts(count: Int = 10): [Post!]!</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type Post &#123;</span><br><span class="line">	title: String!</span><br><span class="line">	text: String!</span><br><span class="line">	related(count: Int = 10): [Post!]!</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>It’s not too hard to craft a query that will cause a very large response:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	posts(count: 100) &#123;</span><br><span class="line">		related(count: 100) &#123;</span><br><span class="line">			related(count: 100) &#123;</span><br><span class="line">				related(count: 100) &#123;</span><br><span class="line">					title</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>响应的大小随相关字段的每个附加级别呈指数增长。 幸运的是，gqlgen的http.Handler包含了一种防止此类查询的方法。</p>
<h3 id="限制查询复杂度"><a href="#限制查询复杂度" class="headerlink" title="限制查询复杂度"></a>限制查询复杂度</h3><p>限制查询复杂度就像使用提供的扩展包进行指定一样简单。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    c := Config&#123; Resolvers: &amp;resolvers&#123;&#125; &#125;</span><br><span class="line">		srv := handler.NewDefaultServer(blog.NewExecutableSchema(c))</span><br><span class="line">		srv.Use(extension.FixedComplexityLimit(<span class="number">5</span>)) <span class="comment">// This line is key</span></span><br><span class="line">    r.Handle(<span class="string">&quot;/query&quot;</span>, srv)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在，任何复杂度大于5的查询都会被API拒绝。 默认情况下，每个字段和深度级别都会使整体查询复杂性加一。 您还可以使用<code>extension.ComplexityLimit</code>动态配置每个请求的复杂度限制。</p>
<p>这有帮助，但是我们仍然有一个问题：返回数组的<code>posts</code>和<code>related</code>字段比标量<code>title</code>和<code>text</code>字段要昂贵得多。 但是，默认复杂度计算对它们进行平均加权。 将较高的成本应用于数组字段会更有意义。</p>
<h3 id="自定义复杂度计算"><a href="#自定义复杂度计算" class="headerlink" title="自定义复杂度计算"></a>自定义复杂度计算</h3><p>为了将更高的成本应用于某些领域，我们可以使用自定义复杂度函数。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    c := Config&#123; Resolvers: &amp;resolvers&#123;&#125; &#125;</span><br><span class="line"></span><br><span class="line">    countComplexity := <span class="function"><span class="keyword">func</span><span class="params">(childComplexity, count <span class="type">int</span>)</span></span> <span class="type">int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> count * childComplexity</span><br><span class="line">    &#125;</span><br><span class="line">    c.Complexity.Query.Posts = countComplexity</span><br><span class="line">    c.Complexity.Post.Related = countComplexity</span><br><span class="line"></span><br><span class="line">    srv := handler.NewDefaultServer(blog.NewExecutableSchema(c))</span><br><span class="line">		srv.Use(extension.FixedComplexityLimit(<span class="number">5</span>))</span><br><span class="line">    http.Handle(<span class="string">&quot;/query&quot;</span>, gqlHandler)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当我们将函数分配给适当的“Complexity”字段时，该函数将用于复杂度计算。 在这里，<code>posts</code>及其<code>related</code>字段根据其<code>count</code>参数的值进行加权。 这意味着客户请求发布的内容越多，查询的复杂度就越高。 就像响应的大小在原始查询中以指数方式增加一样，复杂性也将以指数方式增加，因此任何尝试滥用API的客户端都会很快遇到限制。</p>
<p>通过应用查询复杂性限制并在正确的位置指定自定义复杂性功能，可以轻松地防止客户端使用过多的资源并破坏您的服务。</p>
<h2 id="4-11-解析器"><a href="#4-11-解析器" class="headerlink" title="4.11 解析器"></a>4.11 解析器</h2><p>解决graphQL请求<br>graphQL类型可以通过多种方式绑定到允许许多用例的Go结构。</p>
<h3 id="直接绑定到结构字段名称"><a href="#直接绑定到结构字段名称" class="headerlink" title="直接绑定到结构字段名称"></a>直接绑定到结构字段名称</h3><p>这是最常见的用例，其中Go结构上的字段名称与graphQL类型的字段名称匹配。 如果未导出Go struct字段，则不会将其绑定到graphQL类型。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Car <span class="keyword">struct</span> &#123;</span><br><span class="line">    Make <span class="type">string</span></span><br><span class="line">    Model <span class="type">string</span></span><br><span class="line">    Color <span class="type">string</span></span><br><span class="line">    OdometerReading <span class="type">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在您的graphQL模式中：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">type Car &#123;</span><br><span class="line">    make: String!</span><br><span class="line">    model: String!</span><br><span class="line">    color: String!</span><br><span class="line">    odometerReading: Int!</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>并在gqlgen配置文件中：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">models:</span></span><br><span class="line">    <span class="attr">Car:</span></span><br><span class="line">        <span class="attr">model:</span> <span class="string">github.com/my/app/models.Car</span></span><br></pre></td></tr></table></figure>

<p>在这种情况下，graphQL类型的每个字段都将绑定到go结构上的相应字段，而忽略字段的大小写</p>
<h3 id="绑定到方法名称"><a href="#绑定到方法名称" class="headerlink" title="绑定到方法名称"></a>绑定到方法名称</h3><p>这也是我们要将graphQL字段绑定到Go struct方法的非常常见的用例</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> &#123;</span><br><span class="line">    Name <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Car <span class="keyword">struct</span> &#123;</span><br><span class="line">    Make <span class="type">string</span></span><br><span class="line">    Model <span class="type">string</span></span><br><span class="line">    Color <span class="type">string</span></span><br><span class="line">    OwnerID *<span class="type">string</span></span><br><span class="line">    OdometerReading <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Car)</span></span> Owner() (*Person) &#123;</span><br><span class="line">    <span class="comment">// get the car owner</span></span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">    <span class="keyword">return</span> owner</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在您的graphQL模式中：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">type Car &#123;</span><br><span class="line">    make: String!</span><br><span class="line">    model: String!</span><br><span class="line">    color: String!</span><br><span class="line">    odometerReading: Int!</span><br><span class="line">    owner: Person</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>并在gqlgen配置文件中：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">models:</span></span><br><span class="line">    <span class="attr">Car:</span></span><br><span class="line">        <span class="attr">model:</span> <span class="string">github.com/my/app/models.Car</span></span><br><span class="line">    <span class="attr">Person:</span></span><br><span class="line">        <span class="attr">model:</span> <span class="string">github.com/my/app/models.Person</span></span><br></pre></td></tr></table></figure>

<p>在这里，我们看到在<code>Car</code>上有一个名为<code>Owner</code>的方法，因此，如果<code>graphQL</code>请求包含要解析的字段，则将调用<code>Owner</code>函数。</p>
<p>模型方法可以选择将上下文作为其第一个参数。 如果需要上下文，则模型方法也将并行运行。</p>
<h3 id="字段名称不匹配时绑定"><a href="#字段名称不匹配时绑定" class="headerlink" title="字段名称不匹配时绑定"></a>字段名称不匹配时绑定</h3><p>当Go结构和graphQL类型不匹配时，可以通过两种方式绑定到字段。</p>
<p>第一种方法是可以将解析器绑定到基于struct标记的结构，如下所示：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Car <span class="keyword">struct</span> &#123;</span><br><span class="line">    Make <span class="type">string</span></span><br><span class="line">    ShortState <span class="type">string</span></span><br><span class="line">    LongState <span class="type">string</span> <span class="string">`gqlgen:&quot;state&quot;`</span></span><br><span class="line">    Model <span class="type">string</span></span><br><span class="line">    Color <span class="type">string</span></span><br><span class="line">    OdometerReading <span class="type">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在您的graphQL模式中：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">type Car &#123;</span><br><span class="line">    make: String!</span><br><span class="line">    model: String!</span><br><span class="line">    state: String!</span><br><span class="line">    color: String!</span><br><span class="line">    odometerReading: Int!</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在gqlgen配置文件中添加以下行：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">struct_tag:</span> <span class="string">gqlgen</span></span><br><span class="line"></span><br><span class="line"><span class="attr">models:</span></span><br><span class="line">    <span class="attr">Car:</span></span><br><span class="line">        <span class="attr">model:</span> <span class="string">github.com/my/app/models.Car</span></span><br></pre></td></tr></table></figure>

<p>在这里，即使graphQL类型和Go结构具有不同的字段名称，在longState上也会有一个Go结构标签字段匹配，因此state将绑定到LongState。</p>
<p>绑定字段的第二种方法是在配置文件中添加一行，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Car <span class="keyword">struct</span> &#123;</span><br><span class="line">    Make <span class="type">string</span></span><br><span class="line">    ShortState <span class="type">string</span></span><br><span class="line">    LongState <span class="type">string</span></span><br><span class="line">    Model <span class="type">string</span></span><br><span class="line">    Color <span class="type">string</span></span><br><span class="line">    OdometerReading <span class="type">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在您的graphQL模式中：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">type Car &#123;</span><br><span class="line">    make: String!</span><br><span class="line">    model: String!</span><br><span class="line">    state: String!</span><br><span class="line">    color: String!</span><br><span class="line">    odometerReading: Int!</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在gqlgen配置文件中添加以下行：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">models:</span></span><br><span class="line">    <span class="attr">Car:</span></span><br><span class="line">        <span class="attr">model:</span> <span class="string">github.com/my/app/models.Car</span></span><br><span class="line">        <span class="attr">fields:</span></span><br><span class="line">            <span class="attr">state:</span></span><br><span class="line">                <span class="attr">fieldName:</span> <span class="string">LongState</span></span><br></pre></td></tr></table></figure>

<h3 id="绑定到匿名或嵌入式结构"><a href="#绑定到匿名或嵌入式结构" class="headerlink" title="绑定到匿名或嵌入式结构"></a>绑定到匿名或嵌入式结构</h3><p>上面的所有规则都适用于具有嵌入式结构的结构。 这是一个例子</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Truck <span class="keyword">struct</span> &#123;</span><br><span class="line">    Car</span><br><span class="line"></span><br><span class="line">    Is4x4 <span class="type">bool</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Car <span class="keyword">struct</span> &#123;</span><br><span class="line">    Make <span class="type">string</span></span><br><span class="line">    ShortState <span class="type">string</span></span><br><span class="line">    LongState <span class="type">string</span></span><br><span class="line">    Model <span class="type">string</span></span><br><span class="line">    Color <span class="type">string</span></span><br><span class="line">    OdometerReading <span class="type">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在您的graphQL模式中：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">type Truck &#123;</span><br><span class="line">    make: String!</span><br><span class="line">    model: String!</span><br><span class="line">    state: String!</span><br><span class="line">    color: String!</span><br><span class="line">    odometerReading: Int!</span><br><span class="line">    is4x4: Bool!</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这里，来自Go struct Car的所有字段仍将绑定到graphQL模式中与之匹配的各个字段</p>
<p>嵌入式结构是围绕数据访问类型创建精简包装的好方法，示例如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Cat <span class="keyword">struct</span> &#123;</span><br><span class="line">    db.Cat</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Cat)</span></span> ID() <span class="type">string</span> &#123;</span><br><span class="line">    <span class="comment">// return a custom id based on the db shard and the cat&#x27;s id</span></span><br><span class="line">     <span class="keyword">return</span> fmt.Sprintf(<span class="string">&quot;%d:%d&quot;</span>, c.Shard, c.Id)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>它将与以下的gqlgen配置文件相关：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">models:</span></span><br><span class="line">    <span class="attr">Cat:</span></span><br><span class="line">        <span class="attr">model:</span> <span class="string">github.com/my/app/models.Cat</span></span><br></pre></td></tr></table></figure>

<h3 id="绑定优先"><a href="#绑定优先" class="headerlink" title="绑定优先"></a>绑定优先</h3><p>如果存在struct_tags配置，则结构标记绑定的优先级高于所有其他类型的绑定。 在所有其他情况下，找到的第一个与graphQL type字段匹配的Go struct字段将是绑定的字段。</p>
<h2 id="4-12-标量"><a href="#4-12-标量" class="headerlink" title="4.12 标量"></a>4.12 标量</h2><p>将GraphQL标量类型映射到Go类型</p>
<h3 id="内置助手"><a href="#内置助手" class="headerlink" title="内置助手"></a>内置助手</h3><p>gqlgen附带了一些内置的帮助程序，用于常见的自定义标量用例，时间，任意，上载和映射。 将任何这些添加到架构中将自动将编组行为添加到Go类型。</p>
<h4 id="Time"><a href="#Time" class="headerlink" title="Time"></a>Time</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scalar Time</span><br></pre></td></tr></table></figure>

<p>将Time GraphQL标量映射到Go time.Time结构。</p>
<h4 id="Map"><a href="#Map" class="headerlink" title="Map"></a>Map</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scalar Map</span><br></pre></td></tr></table></figure>

<p>将任意GraphQL值映射到map [string] interface {} Go类型。</p>
<h4 id="Upload"><a href="#Upload" class="headerlink" title="Upload"></a>Upload</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scalar Upload</span><br></pre></td></tr></table></figure>

<p>将Upload GraphQL标量映射到graphql.Upload结构，定义如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Upload <span class="keyword">struct</span> &#123;</span><br><span class="line">	File        io.Reader</span><br><span class="line">	Filename    <span class="type">string</span></span><br><span class="line">	Size        <span class="type">int64</span></span><br><span class="line">	ContentType <span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Any"><a href="#Any" class="headerlink" title="Any"></a>Any</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scalar Any</span><br></pre></td></tr></table></figure>

<p>将任意GraphQL值映射到interface {} Go类型。</p>
<h3 id="具有用户定义类型的自定义标量"><a href="#具有用户定义类型的自定义标量" class="headerlink" title="具有用户定义类型的自定义标量"></a>具有用户定义类型的自定义标量</h3><p>对于用户定义的类型，您可以实现graphql.Marshaler和graphql.Unmarshaler接口，它们将被调用。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> mypkg</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;io&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> YesNo <span class="type">bool</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// UnmarshalGQL implements the graphql.Unmarshaler interface</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(y *YesNo)</span></span> UnmarshalGQL(v <span class="keyword">interface</span>&#123;&#125;) <span class="type">error</span> &#123;</span><br><span class="line">	yes, ok := v.(<span class="type">string</span>)</span><br><span class="line">	<span class="keyword">if</span> !ok &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;YesNo must be a string&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> yes == <span class="string">&quot;yes&quot;</span> &#123;</span><br><span class="line">		*y = <span class="literal">true</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		*y = <span class="literal">false</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// MarshalGQL implements the graphql.Marshaler interface</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(y YesNo)</span></span> MarshalGQL(w io.Writer) &#123;</span><br><span class="line">	<span class="keyword">if</span> y &#123;</span><br><span class="line">		w.Write([]<span class="type">byte</span>(<span class="string">`&quot;yes&quot;`</span>))</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		w.Write([]<span class="type">byte</span>(<span class="string">`&quot;no&quot;`</span>))</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在.gqlgen.yml中或通过像正常的指令连接类型：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">models:</span></span><br><span class="line">  <span class="attr">YesNo:</span></span><br><span class="line">    <span class="attr">model:</span> <span class="string">github.com/me/mypkg.YesNo</span></span><br></pre></td></tr></table></figure>

<h3 id="具有第三方类型的自定义标量"><a href="#具有第三方类型的自定义标量" class="headerlink" title="具有第三方类型的自定义标量"></a>具有第三方类型的自定义标量</h3><p>有时您无法为类型添加add方法-也许您不拥有该类型，或者它是标准库的一部分（例如，字符串或time.Time）。 为此，我们可以构建一个外部封送处理程序：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> mypkg</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;io&quot;</span></span><br><span class="line">	<span class="string">&quot;strings&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/99designs/gqlgen/graphql&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">MarshalMyCustomBooleanScalar</span><span class="params">(b <span class="type">bool</span>)</span></span> graphql.Marshaler &#123;</span><br><span class="line">	<span class="keyword">return</span> graphql.WriterFunc(<span class="function"><span class="keyword">func</span><span class="params">(w io.Writer)</span></span> &#123;</span><br><span class="line">		<span class="keyword">if</span> b &#123;</span><br><span class="line">			w.Write([]<span class="type">byte</span>(<span class="string">&quot;true&quot;</span>))</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			w.Write([]<span class="type">byte</span>(<span class="string">&quot;false&quot;</span>))</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">UnmarshalMyCustomBooleanScalar</span><span class="params">(v <span class="keyword">interface</span>&#123;&#125;)</span></span> (<span class="type">bool</span>, <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="keyword">switch</span> v := v.(<span class="keyword">type</span>) &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="type">string</span>:</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;true&quot;</span> == strings.ToLower(v), <span class="literal">nil</span></span><br><span class="line">	<span class="keyword">case</span> <span class="type">int</span>:</span><br><span class="line">		<span class="keyword">return</span> v != <span class="number">0</span>, <span class="literal">nil</span></span><br><span class="line">	<span class="keyword">case</span> <span class="type">bool</span>:</span><br><span class="line">		<span class="keyword">return</span> v, <span class="literal">nil</span></span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>, fmt.Errorf(<span class="string">&quot;%T is not a bool&quot;</span>, v)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在.gqlgen.yml中指向前面没有Marshal | Unmarshal的名称：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">models:</span></span><br><span class="line">  <span class="attr">MyCustomBooleanScalar:</span></span><br><span class="line">    <span class="attr">model:</span> <span class="string">github.com/me/mypkg.MyCustomBooleanScalar</span></span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>：您也可以通过这种方法取消&#x2F;编组指针类型，只需在<code>Marshal ...</code> func中接受一个指针，然后在<code>Unmarshal ...</code> func中返回一个指针。</p>
<p>有关更多示例，请参见<a href="example/scalars">example&#x2F;scalars</a>软件包。</p>
<h3 id="解析错误"><a href="#解析错误" class="headerlink" title="解析错误"></a>解析错误</h3><p>作为自定义标量解组的一部分而发生的错误将返回该字段的完整路径。 例如，给定以下架构...</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">extend type Mutation&#123;</span><br><span class="line">    updateUser(userInput: UserInput!): User!</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">input UserInput &#123;</span><br><span class="line">    name: String!</span><br><span class="line">    primaryContactDetails: ContactDetailsInput!</span><br><span class="line">    secondaryContactDetails: ContactDetailsInput!</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">scalar Email</span><br><span class="line">input ContactDetailsInput &#123;</span><br><span class="line">    email: Email!</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>…以及以下变量：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;userInput&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;George&quot;</span>,</span><br><span class="line">    <span class="string">&quot;primaryContactDetails&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;email&quot;</span>: <span class="string">&quot;not-an-email&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;secondaryContactDetails&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;email&quot;</span>: <span class="string">&quot;george@gmail.com&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>…以及取消整理功能，如果电子邮件无效，该功能将返回错误。 变异将返回包含完整路径的错误：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;email invalid&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;updateUser&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;userInput&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;primaryContactDetails&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;email&quot;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="4-13-模式指令"><a href="#4-13-模式指令" class="headerlink" title="4.13 模式指令"></a>4.13 模式指令</h2><p>使用架构指令实施权限检查</p>
<p>指令有点像其他任何语言的注释。 它们为您提供了一种无需直接绑定到实现即可指定某些行为的方式。 这对于诸如权限检查之类的跨领域问题非常有用。</p>
<p>注意：当前的指令实现仍然相当有限，旨在涵盖最常见的“现场中间件”情况。</p>
<h3 id="在schema中声明"><a href="#在schema中声明" class="headerlink" title="在schema中声明"></a>在schema中声明</h3><p>指令与所有其他类型一起在您的模式中声明。 让我们定义一个@hasRole指令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">directive @hasRole(role: Role!) on FIELD_DEFINITION</span><br><span class="line"></span><br><span class="line">enum Role &#123;</span><br><span class="line">    ADMIN</span><br><span class="line">    USER</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下次运行go generate时，gqlgen会将此指令添加到DirectiveRoot中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">type DirectiveRoot struct &#123;</span><br><span class="line">	HasRole func(ctx context.Context, obj interface&#123;&#125;, next graphql.Resolver, role Role) (res interface&#123;&#125;, err error)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>参数为：</p>
<ul>
<li>ctx：父上下文</li>
<li>obj：包含要应用的值的对象，例如：<ul>
<li>对于字段定义指令，包含字段的对象&#x2F;输入对象</li>
<li>对于参数指令，包含所有参数的映射</li>
</ul>
</li>
<li>next：指令链中的下一个指令，或字段解析器。 应该调用它以获取字段&#x2F;参数&#x2F;任何值。 您可以通过不调用下一步进行权限检查等来阻止对该字段的访问。</li>
<li>…args：指令的所有args也将被传入。</li>
</ul>
<h3 id="在模式中使用它"><a href="#在模式中使用它" class="headerlink" title="在模式中使用它"></a>在模式中使用它</h3><p>我们现在可以在任何字段定义上调用它：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">type Mutation &#123;</span><br><span class="line">	deleteUser(userID: ID!): Bool @hasRole(role: ADMIN)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="实现指令"><a href="#实现指令" class="headerlink" title="实现指令"></a>实现指令</h3><p>最后，我们需要实现指令，并在启动服务器时将其传递给它：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	c := Config&#123; Resolvers: &amp;resolvers&#123;&#125; &#125;</span><br><span class="line">	c.Directives.HasRole = <span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context, obj <span class="keyword">interface</span>&#123;&#125;, next graphql.Resolver, role Role)</span></span> (<span class="keyword">interface</span>&#123;&#125;, <span class="type">error</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> !getCurrentUser(ctx).HasRole(role) &#123;</span><br><span class="line">			<span class="comment">// block calling the next resolver</span></span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;Access denied&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// or let it pass through</span></span><br><span class="line">		<span class="keyword">return</span> next(ctx)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	http.Handle(<span class="string">&quot;/query&quot;</span>, handler.GraphQL(todo.NewExecutableSchema(c), ))</span><br><span class="line">	log.Fatal(http.ListenAndServe(<span class="string">&quot;:8081&quot;</span>, <span class="literal">nil</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="5-秘笈"><a href="#5-秘笈" class="headerlink" title="5.秘笈"></a>5.秘笈</h1><h2 id="5-1-Apollo"><a href="#5-1-Apollo" class="headerlink" title="5.1 Apollo"></a>5.1 Apollo</h2><p>在此快速指南中，我们将在gqlgen中实现示例Apollo Federation服务器。 您可以在示例目录中找到完成的结果。</p>
<h3 id="启用联盟"><a href="#启用联盟" class="headerlink" title="启用联盟"></a>启用联盟</h3><p>在您的gqlgen.yml中取消注释federation配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Uncomment to enable federation</span></span><br><span class="line"><span class="attr">federation:</span></span><br><span class="line">  <span class="attr">filename:</span> <span class="string">graph/generated/federation.go</span></span><br><span class="line">  <span class="attr">package:</span> <span class="string">generated</span></span><br></pre></td></tr></table></figure>

<h3 id="创建联合服务器"><a href="#创建联合服务器" class="headerlink" title="创建联合服务器"></a>创建联合服务器</h3><p>对于要联合的每个服务器，我们将创建一个新的gqlgen项目。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go run github.com/99designs/gqlgen</span><br></pre></td></tr></table></figure>

<p>更新schema反应federated示例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">type Review &#123;</span><br><span class="line">  body: String</span><br><span class="line">  author: User @provides(fields: &quot;username&quot;)</span><br><span class="line">  product: Product</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">extend type User @key(fields: &quot;id&quot;) &#123;</span><br><span class="line">  id: ID! @external</span><br><span class="line">  reviews: [Review]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">extend type Product @key(fields: &quot;upc&quot;) &#123;</span><br><span class="line">  upc: String! @external</span><br><span class="line">  reviews: [Review]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>生成</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go run github.com/99designs/gqlgen</span><br></pre></td></tr></table></figure>

<p>然后实现解析器</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// These two methods are required for gqlgen to resolve the internal id-only wrapper structs.</span></span><br><span class="line"><span class="comment">// This boilerplate might be removed in a future version of gqlgen that can no-op id only nodes.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *entityResolver)</span></span> FindProductByUpc(ctx context.Context, upc <span class="type">string</span>) (*model.Product, <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;model.Product&#123;</span><br><span class="line">		Upc: upc,</span><br><span class="line">	&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *entityResolver)</span></span> FindUserByID(ctx context.Context, id <span class="type">string</span>) (*model.User, <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;model.User&#123;</span><br><span class="line">		ID: id,</span><br><span class="line">	&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Here we implement the stitched part of this service, returning reviews for a product. Of course normally you would</span></span><br><span class="line"><span class="comment">// go back to the database, but we are just making some data up here.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *productResolver)</span></span> Reviews(ctx context.Context, obj *model.Product) ([]*model.Review, <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="keyword">switch</span> obj.Upc &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&quot;top-1&quot;</span>:</span><br><span class="line">		<span class="keyword">return</span> []*model.Review&#123;&#123;</span><br><span class="line">			Body: <span class="string">&quot;A highly effective form of birth control.&quot;</span>,</span><br><span class="line">		&#125;&#125;, <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">case</span> <span class="string">&quot;top-2&quot;</span>:</span><br><span class="line">		<span class="keyword">return</span> []*model.Review&#123;&#123;</span><br><span class="line">			Body: <span class="string">&quot;Fedoras are one of the most fashionable hats around and can look great with a variety of outfits.&quot;</span>,</span><br><span class="line">		&#125;&#125;, <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">case</span> <span class="string">&quot;top-3&quot;</span>:</span><br><span class="line">		<span class="keyword">return</span> []*model.Review&#123;&#123;</span><br><span class="line">			Body: <span class="string">&quot;This is the last straw. Hat you will wear. 11/10&quot;</span>,</span><br><span class="line">		&#125;&#125;, <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *userResolver)</span></span> Reviews(ctx context.Context, obj *model.User) ([]*model.Review, <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="keyword">if</span> obj.ID == <span class="string">&quot;1234&quot;</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> []*model.Review&#123;&#123;</span><br><span class="line">			Body: <span class="string">&quot;Has an odd fascination with hats.&quot;</span>,</span><br><span class="line">		&#125;&#125;, <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建federation网关</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save @apollo/gateway apollo-server graphql</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">ApolloServer</span> &#125; = <span class="built_in">require</span>(<span class="string">&#x27;apollo-server&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">ApolloGateway</span> &#125; = <span class="built_in">require</span>(<span class="string">&quot;@apollo/gateway&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> gateway = <span class="keyword">new</span> <span class="title class_">ApolloGateway</span>(&#123;</span><br><span class="line">    <span class="attr">serviceList</span>: [</span><br><span class="line">        &#123; <span class="attr">name</span>: <span class="string">&#x27;accounts&#x27;</span>, <span class="attr">url</span>: <span class="string">&#x27;http://localhost:4001/query&#x27;</span> &#125;,</span><br><span class="line">        &#123; <span class="attr">name</span>: <span class="string">&#x27;products&#x27;</span>, <span class="attr">url</span>: <span class="string">&#x27;http://localhost:4002/query&#x27;</span> &#125;,</span><br><span class="line">        &#123; <span class="attr">name</span>: <span class="string">&#x27;reviews&#x27;</span>, <span class="attr">url</span>: <span class="string">&#x27;http://localhost:4003/query&#x27;</span> &#125;</span><br><span class="line">    ],</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = <span class="keyword">new</span> <span class="title class_">ApolloServer</span>(&#123;</span><br><span class="line">    gateway,</span><br><span class="line"></span><br><span class="line">    <span class="attr">subscriptions</span>: <span class="literal">false</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.<span class="title function_">listen</span>().<span class="title function_">then</span>(<span class="function">(<span class="params">&#123; url &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`🚀 Server ready at <span class="subst">$&#123;url&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="启动所有服务"><a href="#启动所有服务" class="headerlink" title="启动所有服务"></a>启动所有服务</h3><p>在单独的终端中：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">go run accounts/server.go</span><br><span class="line">go run products/server.go</span><br><span class="line">go run reviews/server.go</span><br><span class="line">node gateway/index.js</span><br></pre></td></tr></table></figure>

<p>查询federated网关<br>apollo文档中的示例都应该起作用，例如</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">query &#123;</span><br><span class="line">  me &#123;</span><br><span class="line">    username</span><br><span class="line">    reviews &#123;</span><br><span class="line">      body</span><br><span class="line">      product &#123;</span><br><span class="line">        name</span><br><span class="line">        upc</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;me&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Me&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;reviews&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;body&quot;</span><span class="punctuation">:</span> <span class="string">&quot;A highly effective form of birth control.&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;product&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Trilby&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;upc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;top-1&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;body&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Fedoras are one of the most fashionable hats around and can look great with a variety of outfits.&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;product&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Trilby&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;upc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;top-1&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="5-2-认证方式"><a href="#5-2-认证方式" class="headerlink" title="5.2 认证方式"></a>5.2 认证方式</h2><p>通过上下文提供身份验证详细信息</p>
<p>我们有一个应用程序，使用HTTP请求中的cookie对用户进行身份验证，我们想在图形中的某个位置检查此身份验证状态。 由于GraphQL与传输无关，我们无法假设甚至会有HTTP请求，因此我们需要使用中间件将这些身份验证详细信息公开给我们的graph。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> auth</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;database/sql&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">	<span class="string">&quot;context&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// A private key for context that only this package can access. This is important</span></span><br><span class="line"><span class="comment">// to prevent collisions between different context uses</span></span><br><span class="line"><span class="keyword">var</span> userCtxKey = &amp;contextKey&#123;<span class="string">&quot;user&quot;</span>&#125;</span><br><span class="line"><span class="keyword">type</span> contextKey <span class="keyword">struct</span> &#123;</span><br><span class="line">	name <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// A stand-in for our database backed user object</span></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">	Name <span class="type">string</span></span><br><span class="line">	IsAdmin <span class="type">bool</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Middleware decodes the share session cookie and packs the session into context</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Middleware</span><span class="params">(db *sql.DB)</span></span> <span class="function"><span class="keyword">func</span><span class="params">(http.Handler)</span></span> http.Handler &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(next http.Handler)</span></span> http.Handler &#123;</span><br><span class="line">		<span class="keyword">return</span> http.HandlerFunc(<span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">			c, err := r.Cookie(<span class="string">&quot;auth-cookie&quot;</span>)</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Allow unauthenticated users in</span></span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> || c == <span class="literal">nil</span> &#123;</span><br><span class="line">				next.ServeHTTP(w, r)</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			userId, err := validateAndGetUserID(c)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				http.Error(w, <span class="string">&quot;Invalid cookie&quot;</span>, http.StatusForbidden)</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// get the user from the database</span></span><br><span class="line">			user := getUserByID(db, userId)</span><br><span class="line"></span><br><span class="line">			<span class="comment">// put it in context</span></span><br><span class="line">			ctx := context.WithValue(r.Context(), userCtxKey, user)</span><br><span class="line"></span><br><span class="line">			<span class="comment">// and call the next with our new context</span></span><br><span class="line">			r = r.WithContext(ctx)</span><br><span class="line">			next.ServeHTTP(w, r)</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ForContext finds the user from the context. REQUIRES Middleware to have run.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ForContext</span><span class="params">(ctx context.Context)</span></span> *User &#123;</span><br><span class="line">	raw, _ := ctx.Value(userCtxKey).(*User)</span><br><span class="line">	<span class="keyword">return</span> raw</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>：<code>getUserByID</code>和<code>validateAndGetUserID</code>已留给用户实现。</p>
<p>现在，当我们创建服务器时，应该将其包装在身份验证中间件中：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/99designs/gqlgen/example/starwars&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/99designs/gqlgen/graphql/handler&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/99designs/gqlgen/graphql/playground&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/go-chi/chi&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	router := chi.NewRouter()</span><br><span class="line"></span><br><span class="line">	router.Use(auth.Middleware(db))</span><br><span class="line"></span><br><span class="line">    srv := handler.NewDefaultServer(starwars.NewExecutableSchema(starwars.NewResolver()))</span><br><span class="line">	router.Handle(<span class="string">&quot;/&quot;</span>, playground.Handler(<span class="string">&quot;Starwars&quot;</span>, <span class="string">&quot;/query&quot;</span>))</span><br><span class="line">	router.Handle(<span class="string">&quot;/query&quot;</span>, srv)</span><br><span class="line"></span><br><span class="line">	err := http.ListenAndServe(<span class="string">&quot;:8080&quot;</span>, router)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在我们的解析器（或指令）中，我们可以调用ForContext来取回数据：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *queryResolver)</span></span> Hero(ctx context.Context, episode Episode) (Character, <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="keyword">if</span> user := auth.ForContext(ctx) ; user == <span class="literal">nil</span> || !user.IsAdmin &#123;</span><br><span class="line">		<span class="keyword">return</span> Character&#123;&#125;, fmt.Errorf(<span class="string">&quot;Access denied&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> episode == EpisodeEmpire &#123;</span><br><span class="line">		<span class="keyword">return</span> r.humans[<span class="string">&quot;1000&quot;</span>], <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> r.droid[<span class="string">&quot;2001&quot;</span>], <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Websockets"><a href="#Websockets" class="headerlink" title="Websockets"></a>Websockets</h3><p>如果您需要访问websocket初始化有效负载，我们可以使用WebsocketInitFunc执行相同的操作：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	router := chi.NewRouter()</span><br><span class="line"></span><br><span class="line">	router.Use(auth.Middleware(db))</span><br><span class="line"></span><br><span class="line">	router.Handle(<span class="string">&quot;/&quot;</span>, handler.Playground(<span class="string">&quot;Starwars&quot;</span>, <span class="string">&quot;/query&quot;</span>))</span><br><span class="line">	router.Handle(<span class="string">&quot;/query&quot;</span>,</span><br><span class="line">		handler.GraphQL(starwars.NewExecutableSchema(starwars.NewResolver())),</span><br><span class="line">		WebsocketInitFunc(<span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context, initPayload InitPayload)</span></span> (context.Context, <span class="type">error</span>) &#123;</span><br><span class="line">			userId, err := validateAndGetUserID(payload[<span class="string">&quot;token&quot;</span>])</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// get the user from the database</span></span><br><span class="line">			user := getUserByID(db, userId)</span><br><span class="line"></span><br><span class="line">			<span class="comment">// put it in context</span></span><br><span class="line">			userCtx := context.WithValue(r.Context(), userCtxKey, user)</span><br><span class="line"></span><br><span class="line">			<span class="comment">// and return it so the resolvers can see it</span></span><br><span class="line">			<span class="keyword">return</span> userCtx, <span class="literal">nil</span></span><br><span class="line">		&#125;))</span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	err := http.ListenAndServe(<span class="string">&quot;:8080&quot;</span>, router)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意</p>
<p>订阅的寿命很长，如果您的令牌可能超时或需要刷新，则您也应该将该令牌保留在上下文中，并验证它在auth.ForContext中仍然有效。</p>
<h2 id="5-3-CORS"><a href="#5-3-CORS" class="headerlink" title="5.3 CORS"></a>5.3 CORS</h2><p>使用rs&#x2F;cors为gqlgen设置CORS标头</p>
<p>当您的graphql服务器与提供客户端代码的域位于不同的域时，需要跨域资源共享（CORS）标头。 您可以在MDN文档中阅读有关CORS的更多信息。</p>
<h3 id="rs-cors"><a href="#rs-cors" class="headerlink" title="rs&#x2F;cors"></a>rs&#x2F;cors</h3><p>gqlgen不包含CORS实施，但可以与所有标准的http中间件一起使用。 在这里，我们将使用奇妙的<code>chi</code>和<code>rs/cors</code>来构建服务器。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;net/http&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/99designs/gqlgen/graphql/handler/transport&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/99designs/gqlgen/example/starwars&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/99designs/gqlgen/graphql/handler&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/go-chi/chi&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/rs/cors&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	router := chi.NewRouter()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Add CORS middleware around every request</span></span><br><span class="line">	<span class="comment">// See https://github.com/rs/cors for full option listing</span></span><br><span class="line">	router.Use(cors.New(cors.Options&#123;</span><br><span class="line">		AllowedOrigins:   []<span class="type">string</span>&#123;<span class="string">&quot;http://localhost:8080&quot;</span>&#125;,</span><br><span class="line">		AllowCredentials: <span class="literal">true</span>,</span><br><span class="line">		Debug:            <span class="literal">true</span>,</span><br><span class="line">	&#125;).Handler)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    srv := handler.NewDefaultServer(starwars.NewExecutableSchema(starwars.NewResolver()))</span><br><span class="line">    srv.AddTransport(&amp;transport.Websocket&#123;</span><br><span class="line">        Upgrader: websocket.Upgrader&#123;</span><br><span class="line">            CheckOrigin: <span class="function"><span class="keyword">func</span><span class="params">(r *http.Request)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">                <span class="comment">// Check against your desired domains here</span></span><br><span class="line">                 <span class="keyword">return</span> r.Host == <span class="string">&quot;example.org&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            ReadBufferSize:  <span class="number">1024</span>,</span><br><span class="line">            WriteBufferSize: <span class="number">1024</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">	router.Handle(<span class="string">&quot;/&quot;</span>, handler.Playground(<span class="string">&quot;Starwars&quot;</span>, <span class="string">&quot;/query&quot;</span>))</span><br><span class="line">	router.Handle(<span class="string">&quot;/query&quot;</span>, srv)</span><br><span class="line"></span><br><span class="line">	err := http.ListenAndServe(<span class="string">&quot;:8080&quot;</span>, router)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-4-gin"><a href="#5-4-gin" class="headerlink" title="5.4 gin"></a>5.4 gin</h2><p>使用Gin设置HTTP处理程序<br>Gin是net&#x2F;http路由器的绝佳替代品。 在他们的官方<a target="_blank" rel="noopener" href="https://github.com/gin-gonic/gin">GitHub页面上</a>：</p>
<p>Gin是用Go（Golang）编写的Web框架。 它具有类似于martini的API，性能更高，由于使用了httprouter，速度提高了40倍。 如果您需要性能和良好的生产力，您会喜欢Gin的。</p>
<p>以下是一起设置Gin和gqlgen的步骤：</p>
<p>安装gin：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">go get github.com/gin-gonic/gin</span></span><br></pre></td></tr></table></figure>

<p>在路由器文件中，以两种不同的方法定义GraphQL和Playground端点的处理程序，然后在Gin路由器中进行绑定：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/99designs/gqlgen/graphql/handler&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/99designs/gqlgen/graphql/playground&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Defining the Graphql handler</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">graphqlHandler</span><span class="params">()</span></span> gin.HandlerFunc &#123;</span><br><span class="line">	<span class="comment">// NewExecutableSchema and Config are in the generated.go file</span></span><br><span class="line">	<span class="comment">// Resolver is in the resolver.go file</span></span><br><span class="line">	h := handler.NewDefaultServer(NewExecutableSchema(Config&#123;Resolvers: &amp;Resolver&#123;&#125;&#125;))</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">		h.ServeHTTP(c.Writer, c.Request)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Defining the Playground handler</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">playgroundHandler</span><span class="params">()</span></span> gin.HandlerFunc &#123;</span><br><span class="line">	h := playground.Handler(<span class="string">&quot;GraphQL&quot;</span>, <span class="string">&quot;/query&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">		h.ServeHTTP(c.Writer, c.Request)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// Setting up Gin</span></span><br><span class="line">	r := gin.Default()</span><br><span class="line">	r.POST(<span class="string">&quot;/query&quot;</span>, graphqlHandler())</span><br><span class="line">	r.GET(<span class="string">&quot;/&quot;</span>, playgroundHandler())</span><br><span class="line">	r.Run()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="访问gin-Context"><a href="#访问gin-Context" class="headerlink" title="访问gin.Context"></a>访问gin.Context</h3><p>在解析程序级别，gqlgen使您可以访问context.Context对象。 访问gin.Context的一种方法是将其添加到上下文中，然后再次检索它。</p>
<p>首先，创建一个gin中间件以将其上下文添加到上下文中。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GinContextToContextMiddleware</span><span class="params">()</span></span> gin.HandlerFunc &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">		ctx := context.WithValue(c.Request.Context(), <span class="string">&quot;GinContextKey&quot;</span>, c)</span><br><span class="line">		c.Request = c.Request.WithContext(ctx)</span><br><span class="line">		c.Next()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在路由器定义中，使用中间件：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">r.Use(GinContextToContextMiddleware())</span><br></pre></td></tr></table></figure>

<p>定义一个函数以从context.Context结构中恢复gin.Context：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GinContextFromContext</span><span class="params">(ctx context.Context)</span></span> (*gin.Context, <span class="type">error</span>) &#123;</span><br><span class="line">	ginContext := ctx.Value(<span class="string">&quot;GinContextKey&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> ginContext == <span class="literal">nil</span> &#123;</span><br><span class="line">		err := fmt.Errorf(<span class="string">&quot;could not retrieve gin.Context&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	gc, ok := ginContext.(*gin.Context)</span><br><span class="line">	<span class="keyword">if</span> !ok &#123;</span><br><span class="line">		err := fmt.Errorf(<span class="string">&quot;gin.Context has wrong type&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> gc, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后，在解析器中，使用先前定义的函数检索gin.Context：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *resolver)</span></span> Todo(ctx context.Context) (*Todo, <span class="type">error</span>) &#123;</span><br><span class="line">	gc, err := GinContextFromContext(ctx)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://wangyyovo.github.io">Blank</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://wangyyovo.github.io/posts/1391286a/">https://wangyyovo.github.io/posts/1391286a/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://wangyyovo.github.io" target="_blank">Blank</a>！</span></div></div><div class="tag_share"><div class="post-share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/microservice/b45a976cf0d74608645a7327efbef5e5.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/4a325b27/" title="GraphQL搭建服务端API"><img class="cover" src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/microservice/0a9a446deb87fd5eabf61735b860d658.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">GraphQL搭建服务端API</div></div><div class="info-2"><div class="info-item-1"> GraphQL搭建服务端API graphql库: github.com&#x2F;99designs&#x2F;gqlgen 基于gqlgen加密版: github.com&#x2F;vndocker&#x2F;encrypted-graphql 网络框架: github.com&#x2F;gin-gonic&#x2F;gin golang: 1.15.2  项目结构1234567891011121314151617181920212223.├── go.mod├── go.sum├── gqlgen.yml├── Dockerfile├── Makefile├── internal│   ├── auth│   │   └── auth.go│   ├── bff│   │   └── bff.go              #代码生成│   ├── model│   │   └── model.go			#代码生成	│   ├── resolver│   │   ├── resolver.go			#代码生成│   │   └── server.resolvers.go ...</div></div></div></a><a class="pagination-related" href="/posts/260dbad6/" title="GraphQL文档"><img class="cover" src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/microservice/1975ab13a16d7203e5f79efb3e499123.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">GraphQL文档</div></div><div class="info-2"><div class="info-item-1"> GraphQL文档 https://graphql.cn/learn/   GraphQL 入门 在接下来的一系列文章中，我们会了解 GraphQL 是什么，它是如何运作以及如何使用它。在找如何搭建 GraphQL 服务的文档？这有一些类库可以帮你用多种不同语言实现 GraphQL。通过实用教程深入学习体验，请访问 How to GraphQL 全栈教程网站。我们还与 edX 合作创建了免费的在线课程，探索 GraphQL：一种用于 API 的查询语言。  GraphQL 是一个用于 API 的查询语言，是一个使用基于类型系统来执行查询的服务端运行时（类型系统由你的数据定义）。GraphQL 并没有和任何特定数据库或者存储引擎绑定，而是依靠你现有的代码和数据支撑。 一个 GraphQL 服务是通过定义类型和类型上的字段来创建的，然后给每个类型上的每个字段提供解析函数。例如，一个 GraphQL 服务告诉我们当前登录用户是 me，这个用户的名称可能像这样： 12345678type Query &#123;  me: User&#125;type User &#123;  id:...</div></div></div></a></nav><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/theme/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Blank</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">352</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">46</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">58</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>主题 GitHub</span></a><div class="card-info-social-icons"><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fas fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">1.介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFgqlgen%EF%BC%9F"><span class="toc-number">1.1.</span> <span class="toc-text">什么是gqlgen？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%A5%E9%97%A8"><span class="toc-number">1.2.</span> <span class="toc-text">入门</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%A5%E5%91%8A%E9%97%AE%E9%A2%98"><span class="toc-number">1.3.</span> <span class="toc-text">报告问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B4%A1%E7%8C%AE"><span class="toc-number">1.4.</span> <span class="toc-text">贡献</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%8F%E5%B8%B8%E9%97%AE%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">1.5.</span> <span class="toc-text">经常问的问题</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-%E5%85%A5%E9%97%A8"><span class="toc-number">2.</span> <span class="toc-text">2.入门</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E9%A1%B9%E7%9B%AE"><span class="toc-number">2.1.</span> <span class="toc-text">创建项目</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">2.2.</span> <span class="toc-text">构建服务器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%BB%E9%BE%99%E7%82%B9%E7%9D%9B"><span class="toc-number">2.3.</span> <span class="toc-text">画龙点睛</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-%E9%85%8D%E7%BD%AE"><span class="toc-number">3.</span> <span class="toc-text">3.配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%A6%E6%8C%87%E4%BB%A4%E7%9A%84%E5%86%85%E8%81%94%E9%85%8D%E7%BD%AE"><span class="toc-number">3.1.</span> <span class="toc-text">带指令的内联配置</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-%E5%8F%82%E8%80%83"><span class="toc-number">4.</span> <span class="toc-text">4.参考</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-APQ"><span class="toc-number">4.1.</span> <span class="toc-text">4.1 APQ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E6%B3%95"><span class="toc-number">4.1.1.</span> <span class="toc-text">用法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-%E5%8F%98%E6%9B%B4%E9%9B%86"><span class="toc-number">4.2.</span> <span class="toc-text">4.2 变更集</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-%E6%95%B0%E6%8D%AE%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="toc-number">4.3.</span> <span class="toc-text">4.3 数据加载器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E8%A7%A3%E6%9E%90"><span class="toc-number">4.3.1.</span> <span class="toc-text">查询解析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-Dataloader"><span class="toc-number">4.4.</span> <span class="toc-text">4.4 Dataloader</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-5-%E5%AD%97%E6%AE%B5%E6%94%B6%E9%9B%86"><span class="toc-number">4.5.</span> <span class="toc-text">4.5 字段收集</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CollectAllFields"><span class="toc-number">4.5.1.</span> <span class="toc-text">CollectAllFields</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CollectFieldsCtx"><span class="toc-number">4.5.2.</span> <span class="toc-text">CollectFieldsCtx</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%99%85%E4%BE%8B%E5%AD%90"><span class="toc-number">4.5.3.</span> <span class="toc-text">实际例子</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-6-%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6"><span class="toc-number">4.6.</span> <span class="toc-text">4.6 上传文件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE"><span class="toc-number">4.6.1.</span> <span class="toc-text">配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B"><span class="toc-number">4.6.2.</span> <span class="toc-text">实例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%95%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="toc-number">4.6.2.1.</span> <span class="toc-text">单文件上传</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%9A%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="toc-number">4.6.2.2.</span> <span class="toc-text">多文件上传</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Apollo%E7%9A%84%E7%94%A8%E6%B3%95"><span class="toc-number">4.6.3.</span> <span class="toc-text">Apollo的用法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-7-%E5%A4%84%E7%90%86%E9%94%99%E8%AF%AF"><span class="toc-number">4.7.</span> <span class="toc-text">4.7 处理错误</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%94%E5%9B%9E%E9%94%99%E8%AF%AF"><span class="toc-number">4.7.1.</span> <span class="toc-text">返回错误</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%92%A9%E5%AD%90"><span class="toc-number">4.7.2.</span> <span class="toc-text">钩子</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-8-%E5%86%85%E7%9C%81"><span class="toc-number">4.8.</span> <span class="toc-text">4.8 内省</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A6%81%E7%94%A8%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E8%87%AA%E7%9C%81"><span class="toc-number">4.8.1.</span> <span class="toc-text">禁用服务器的自省</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A6%81%E7%94%A8%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E7%9A%84%E8%87%AA%E7%9C%81"><span class="toc-number">4.8.2.</span> <span class="toc-text">禁用身份验证的自省</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-9-%E6%8F%92%E4%BB%B6"><span class="toc-number">4.9.</span> <span class="toc-text">4.9 插件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%8F%92%E4%BB%B6"><span class="toc-number">4.9.1.</span> <span class="toc-text">使用插件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E6%8F%92%E4%BB%B6"><span class="toc-number">4.9.2.</span> <span class="toc-text">编写插件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-10-%E6%9F%A5%E8%AF%A2%E5%A4%8D%E6%9D%82%E5%BA%A6"><span class="toc-number">4.10.</span> <span class="toc-text">4.10 查询复杂度</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E4%BB%B7%E9%AB%98%E7%9A%84%E6%9F%A5%E8%AF%A2"><span class="toc-number">4.10.1.</span> <span class="toc-text">代价高的查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%99%90%E5%88%B6%E6%9F%A5%E8%AF%A2%E5%A4%8D%E6%9D%82%E5%BA%A6"><span class="toc-number">4.10.2.</span> <span class="toc-text">限制查询复杂度</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%A4%8D%E6%9D%82%E5%BA%A6%E8%AE%A1%E7%AE%97"><span class="toc-number">4.10.3.</span> <span class="toc-text">自定义复杂度计算</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-11-%E8%A7%A3%E6%9E%90%E5%99%A8"><span class="toc-number">4.11.</span> <span class="toc-text">4.11 解析器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B4%E6%8E%A5%E7%BB%91%E5%AE%9A%E5%88%B0%E7%BB%93%E6%9E%84%E5%AD%97%E6%AE%B5%E5%90%8D%E7%A7%B0"><span class="toc-number">4.11.1.</span> <span class="toc-text">直接绑定到结构字段名称</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%91%E5%AE%9A%E5%88%B0%E6%96%B9%E6%B3%95%E5%90%8D%E7%A7%B0"><span class="toc-number">4.11.2.</span> <span class="toc-text">绑定到方法名称</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E6%AE%B5%E5%90%8D%E7%A7%B0%E4%B8%8D%E5%8C%B9%E9%85%8D%E6%97%B6%E7%BB%91%E5%AE%9A"><span class="toc-number">4.11.3.</span> <span class="toc-text">字段名称不匹配时绑定</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%91%E5%AE%9A%E5%88%B0%E5%8C%BF%E5%90%8D%E6%88%96%E5%B5%8C%E5%85%A5%E5%BC%8F%E7%BB%93%E6%9E%84"><span class="toc-number">4.11.4.</span> <span class="toc-text">绑定到匿名或嵌入式结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%91%E5%AE%9A%E4%BC%98%E5%85%88"><span class="toc-number">4.11.5.</span> <span class="toc-text">绑定优先</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-12-%E6%A0%87%E9%87%8F"><span class="toc-number">4.12.</span> <span class="toc-text">4.12 标量</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E7%BD%AE%E5%8A%A9%E6%89%8B"><span class="toc-number">4.12.1.</span> <span class="toc-text">内置助手</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Time"><span class="toc-number">4.12.1.1.</span> <span class="toc-text">Time</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Map"><span class="toc-number">4.12.1.2.</span> <span class="toc-text">Map</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Upload"><span class="toc-number">4.12.1.3.</span> <span class="toc-text">Upload</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Any"><span class="toc-number">4.12.1.4.</span> <span class="toc-text">Any</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B7%E6%9C%89%E7%94%A8%E6%88%B7%E5%AE%9A%E4%B9%89%E7%B1%BB%E5%9E%8B%E7%9A%84%E8%87%AA%E5%AE%9A%E4%B9%89%E6%A0%87%E9%87%8F"><span class="toc-number">4.12.2.</span> <span class="toc-text">具有用户定义类型的自定义标量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B7%E6%9C%89%E7%AC%AC%E4%B8%89%E6%96%B9%E7%B1%BB%E5%9E%8B%E7%9A%84%E8%87%AA%E5%AE%9A%E4%B9%89%E6%A0%87%E9%87%8F"><span class="toc-number">4.12.3.</span> <span class="toc-text">具有第三方类型的自定义标量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90%E9%94%99%E8%AF%AF"><span class="toc-number">4.12.4.</span> <span class="toc-text">解析错误</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-13-%E6%A8%A1%E5%BC%8F%E6%8C%87%E4%BB%A4"><span class="toc-number">4.13.</span> <span class="toc-text">4.13 模式指令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8schema%E4%B8%AD%E5%A3%B0%E6%98%8E"><span class="toc-number">4.13.1.</span> <span class="toc-text">在schema中声明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8%E6%A8%A1%E5%BC%8F%E4%B8%AD%E4%BD%BF%E7%94%A8%E5%AE%83"><span class="toc-number">4.13.2.</span> <span class="toc-text">在模式中使用它</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E6%8C%87%E4%BB%A4"><span class="toc-number">4.13.3.</span> <span class="toc-text">实现指令</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-%E7%A7%98%E7%AC%88"><span class="toc-number">5.</span> <span class="toc-text">5.秘笈</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-Apollo"><span class="toc-number">5.1.</span> <span class="toc-text">5.1 Apollo</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E7%94%A8%E8%81%94%E7%9B%9F"><span class="toc-number">5.1.1.</span> <span class="toc-text">启用联盟</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%81%94%E5%90%88%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">5.1.2.</span> <span class="toc-text">创建联合服务器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E6%89%80%E6%9C%89%E6%9C%8D%E5%8A%A1"><span class="toc-number">5.1.3.</span> <span class="toc-text">启动所有服务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-%E8%AE%A4%E8%AF%81%E6%96%B9%E5%BC%8F"><span class="toc-number">5.2.</span> <span class="toc-text">5.2 认证方式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Websockets"><span class="toc-number">5.2.1.</span> <span class="toc-text">Websockets</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-CORS"><span class="toc-number">5.3.</span> <span class="toc-text">5.3 CORS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#rs-cors"><span class="toc-number">5.3.1.</span> <span class="toc-text">rs&#x2F;cors</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-4-gin"><span class="toc-number">5.4.</span> <span class="toc-text">5.4 gin</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BF%E9%97%AEgin-Context"><span class="toc-number">5.4.1.</span> <span class="toc-text">访问gin.Context</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/d14168d/" title="虚拟机问题合集"><img src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/hexo/090cfe4e9e60b0ad0de05db822f3ae97.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="虚拟机问题合集"/></a><div class="content"><a class="title" href="/posts/d14168d/" title="虚拟机问题合集">虚拟机问题合集</a><time datetime="2022-07-16T13:30:36.000Z" title="发表于 2022-07-16 21:30:36">2022-07-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/f540045f/" title="用go语言编写移动端sdk和app开发"><img src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/golang/941ed1ec2925719a0c92e76f4f786b6a.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="用go语言编写移动端sdk和app开发"/></a><div class="content"><a class="title" href="/posts/f540045f/" title="用go语言编写移动端sdk和app开发">用go语言编写移动端sdk和app开发</a><time datetime="2022-07-04T12:14:21.000Z" title="发表于 2022-07-04 20:14:21">2022-07-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/5faac006/" title="在线编程IDE"><img src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/hexo/090cfe4e9e60b0ad0de05db822f3ae97.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="在线编程IDE"/></a><div class="content"><a class="title" href="/posts/5faac006/" title="在线编程IDE">在线编程IDE</a><time datetime="2022-06-12T13:30:36.000Z" title="发表于 2022-06-12 21:30:36">2022-06-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/7594185d/" title="即时性能分析工具Pyroscope"><img src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/golang/3bfb3279740bc9a5b5ef436fa887ef07.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="即时性能分析工具Pyroscope"/></a><div class="content"><a class="title" href="/posts/7594185d/" title="即时性能分析工具Pyroscope">即时性能分析工具Pyroscope</a><time datetime="2022-06-12T08:07:36.000Z" title="发表于 2022-06-12 16:07:36">2022-06-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/82a7aa7c/" title="golang性能调试优化方法"><img src="https://cdn.jsdelivr.net/gh/wangyyovo/CDN@master/cover/common/3.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="golang性能调试优化方法"/></a><div class="content"><a class="title" href="/posts/82a7aa7c/" title="golang性能调试优化方法">golang性能调试优化方法</a><time datetime="2022-06-12T03:00:36.000Z" title="发表于 2022-06-12 11:00:36">2022-06-12</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 By Blank</span><span class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 5.4.2</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.4.3</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><div class="js-pjax"><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = {"placeholder":"说些什么吧"}

  const initValine = (el, path) => {
    if (isShuoshuo) {
      window.shuoshuoComment.destroyValine = () => {
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }

    const valineConfig = {
      el: '#vcomment',
      appId: 'BSfgwCPLOvPHVPaSoBCGSENf-MdYXbMMI',
      appKey: '2Q8qq5060qxycL6FPL26LnMG',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      visitor: false,
      ...option,
      path: isShuoshuo ? path : (option && option.path) || window.location.pathname
    }

    new Valine(valineConfig)
  }

  const loadValine = async (el, path) => {
    if (typeof Valine === 'function') {
      initValine(el, path)
    } else {
      await btf.getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js')
      initValine(el, path)
    }
  }

  if (isShuoshuo) {
    'Valine' === 'Valine'
      ? window.shuoshuoComment = { loadComment: loadValine }
      : window.loadOtherComment = loadValine
    return
  }

  if ('Valine' === 'Valine' || !false) {
    if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>