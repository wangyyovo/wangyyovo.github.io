<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Blank</title>
  
  
  <link href="https://wangyyovo.github.io/atom.xml" rel="self"/>
  
  <link href="https://wangyyovo.github.io/"/>
  <updated>2022-07-16T13:30:36.000Z</updated>
  <id>https://wangyyovo.github.io/</id>
  
  <author>
    <name>Blank</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>虚拟机问题合集</title>
    <link href="https://wangyyovo.github.io/posts/d14168d/"/>
    <id>https://wangyyovo.github.io/posts/d14168d/</id>
    <published>2022-07-16T13:30:36.000Z</published>
    <updated>2022-07-16T13:30:36.000Z</updated>
    
    <content type="html"><![CDATA[<script src="\assets\js\APlayer.min.js"> </script><h1 id="虚拟机问题合集"><a href="#虚拟机问题合集" class="headerlink" title="虚拟机问题合集"></a>虚拟机问题合集</h1><h2 id="Vmware"><a href="#Vmware" class="headerlink" title="Vmware"></a>Vmware</h2><p>网络无法连接</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo service network-manager stop</span><br><span class="line">sudo vi  /var/lib/NetworkManager/NetworkManager.state   # NetworkingEnabled=true</span><br><span class="line">sudo service network-manager start</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;script src=&quot;\assets\js\APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;h1 id=&quot;虚拟机问题合集&quot;&gt;&lt;a href=&quot;#虚拟机问题合集&quot; class=&quot;headerlink&quot; title=&quot;虚拟机问题合集&quot;&gt;&lt;/a&gt;虚拟机问题合集&lt;/h1&gt;&lt;h2</summary>
      
    
    
    
    <category term="other" scheme="https://wangyyovo.github.io/categories/other/"/>
    
    
  </entry>
  
  <entry>
    <title>用go语言编写移动端sdk和app开发</title>
    <link href="https://wangyyovo.github.io/posts/f540045f/"/>
    <id>https://wangyyovo.github.io/posts/f540045f/</id>
    <published>2022-07-04T12:14:21.000Z</published>
    <updated>2022-07-04T12:14:21.000Z</updated>
    
    <content type="html"><![CDATA[<script src="\assets\js\APlayer.min.js"> </script><h1 id="用go语言编写移动端sdk和app开发"><a href="#用go语言编写移动端sdk和app开发" class="headerlink" title="用go语言编写移动端sdk和app开发"></a>用go语言编写移动端sdk和app开发</h1><blockquote><p>window 11</p></blockquote><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>使用go开发sdk在Android，ios中调，这就需要用到gomobile这个工具来完成</p><h2 id="文档"><a href="#文档" class="headerlink" title="文档"></a>文档</h2><p><a href="https://github.com/golang/go/wiki/Mobile">https://github.com/golang/go/wiki/Mobile</a></p><h2 id="安装Golang"><a href="#安装Golang" class="headerlink" title="安装Golang"></a>安装Golang</h2><p><a href="https://studygolang.com/dl">https://studygolang.com/dl</a></p><p><a href="https://studygolang.com/dl/golang/go1.18.3.windows-amd64.zip">https://studygolang.com/dl/golang/go1.18.3.windows-amd64.zip</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GOPROXY=https://goproxy.cn</span><br><span class="line">GOPATH=c:/gopath  # src bin pkg</span><br><span class="line">GOROOT=c:/go</span><br><span class="line">PATH=%GOPATH%/bin;%GOROOT%/bin</span><br><span class="line"></span><br><span class="line">go version</span><br></pre></td></tr></table></figure><h2 id="安装JDK"><a href="#安装JDK" class="headerlink" title="安装JDK"></a>安装JDK</h2><p>下载地址:<a href="https://www.oracle.com/java/technologies/downloads/#java8-windows">https://www.oracle.com/java/technologies/downloads/#java8-windows</a></p><p>现在下载jdk需要注册账号，<a href="http://bugmenot.com/view/oracle.com">http://bugmenot.com/view/oracle.com</a> 这个网址有提供账号</p><p>设置环境变量</p><p>JAVA_HOME&#x3D;&lt;安装目录&gt;</p><p>PATH&#x3D;%JAVA_HOME%\bin</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java <span class="literal">-version</span></span><br></pre></td></tr></table></figure><h2 id="安装Android-SDK"><a href="#安装Android-SDK" class="headerlink" title="安装Android SDK"></a>安装Android SDK</h2><p>Android SDK包下载</p><ul><li>官网下载: <a href="http://android-sdk.en.softonic.com/download">Download Android SDK - free - latest version</a></li><li>网盘下载: <a href="http://tools.android-studio.org/index.php/sdk">Android SDK 百度网盘下载地址链接</a></li><li>下载地址: <a href="https://www.androiddevtools.cn/">https://www.androiddevtools.cn/</a></li><li>google: <a href="https://developer.android.google.cn/sdk/older_releases?hl=en">https://developer.android.google.cn/sdk/older_releases?hl=en</a></li><li>jetbrians intellij IDEA</li><li>android studio</li><li><a href="https://developer.android.google.cn/studio/command-line/sdkmanager">https://developer.android.google.cn/studio/command-line/sdkmanager</a></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://dl.google.com/android/android-sdk_r24.4.1-windows.zip</span><br></pre></td></tr></table></figure><p>在安装<code>java sdk</code>后运行<code>SDK Manager.exe</code></p><p>添加系统变量，变量名：ANDROID_HOME，变量值为：SDK安装路径（如下：）</p><p>添加Path路径：</p><p>1）添加 build-tools\29.0.3 安装路径（在SDK安装目录下）</p><p>2）添加 tools安装路径（在SDK安装目录下）</p><p>3）添加platform-tools 安装路径（在SDK安装目录下）</p><h2 id="安装NDK"><a href="#安装NDK" class="headerlink" title="安装NDK"></a>安装NDK</h2><h3 id="方式一"><a href="#方式一" class="headerlink" title="方式一"></a>方式一</h3><ul><li><a href="https://developer.android.google.cn/ndk/downloads/">https://developer.android.google.cn/ndk/downloads/</a></li><li>jetbrians intellij IDEA</li><li>android studio</li></ul><p>环境变量</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">NDK=C:\android-ndk-r24</span><br><span class="line">PATH=%NDK%</span><br><span class="line">ANDROID_NDK=%NDK%</span><br><span class="line">ANDROID_NDK_HOME=%NDK%</span><br></pre></td></tr></table></figure><p>检查是否安装成功</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ndk-build</span><br><span class="line"></span><br><span class="line">Android NDK: Could not find application project directory !</span><br><span class="line">Android NDK: Please define the NDK_PROJECT_PATH variable to point to it.</span><br><span class="line">C:\android-ndk-r24\build\\..\build\core\build-local.mk:151: *** Android NDK: Aborting    .  Stop.</span><br></pre></td></tr></table></figure><h3 id="方式二（使用方式二）"><a href="#方式二（使用方式二）" class="headerlink" title="方式二（使用方式二）"></a>方式二（使用方式二）</h3><p>由于您使用的是独立的Android SDK Manager，因此需要使用</p><p>关闭 <strong>Android SDK Manager</strong></p><p>以管理员身份启动<strong>命令提示符</strong></p><p><code>cd </code><em>安装Android SDK Manager的路径</em> <code>\tools\bin</code></p><p><code>sdkmanager ndk-bundle</code></p><p>接受许可协议</p><p>等待很长时间.安装完成，没有任何进度指示器.</p><p>最终报告<code>完成</code>时，启动 <strong>Android SDK Manager</strong></p><p>在<strong>其他</strong>下查看，您会发现 <strong>Ndk捆绑包</strong></p><p>gomobile init -ndk ~&#x2F;Library&#x2F;Android&#x2F;sdk&#x2F;ndk-bundle&#x2F;</p><h2 id="安装gomobile"><a href="#安装gomobile" class="headerlink" title="安装gomobile"></a>安装gomobile</h2><p>地址：<a href="https://github.com/golang/mobile/">https://github.com/golang/mobile/</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">go install golang.org/x/mobile/cmd/gomobile@latest</span><br><span class="line">go install golang.org/x/mobile/cmd/gobind@latest</span><br><span class="line"></span><br><span class="line">gomobile init</span><br><span class="line"></span><br><span class="line">gomobile build -target=android golang.org/x/mobile/example/basic</span><br></pre></td></tr></table></figure><p>检查是否安装成功(<code>c:/gopath/bin</code>)</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">gomobile</span><br><span class="line"></span><br><span class="line">Gomobile is a tool for building and running mobile apps written in Go.</span><br><span class="line"></span><br><span class="line">To install:</span><br><span class="line"></span><br><span class="line">        $ go install golang.org/x/mobile/cmd/gomobile@latest</span><br><span class="line">        $ gomobile init</span><br><span class="line"></span><br><span class="line">At least Go 1.16 is required.</span><br><span class="line">For detailed instructions, see https://golang.org/wiki/Mobile.</span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line"></span><br><span class="line">        gomobile command [arguments]</span><br><span class="line"></span><br><span class="line">Commands:</span><br><span class="line"></span><br><span class="line">        bind        build a library for Android and iOS</span><br><span class="line">        build       compile android APK and iOS app</span><br><span class="line">        clean       remove object files and cached gomobile files</span><br><span class="line">        init        build OpenAL for Android</span><br><span class="line">        install     compile android APK and install on device</span><br><span class="line">        version     print version</span><br><span class="line"></span><br><span class="line">Use &#x27;gomobile help [command]&#x27; for more information about that command.</span><br></pre></td></tr></table></figure><h2 id="gomobile命令"><a href="#gomobile命令" class="headerlink" title="gomobile命令"></a>gomobile命令</h2><h3 id="为Android和iOS构建一个库"><a href="#为Android和iOS构建一个库" class="headerlink" title="为Android和iOS构建一个库"></a>为Android和iOS构建一个库</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gomobile bind [-target android|ios|iossimulator|macos|maccatalyst] [-bootclasspath &lt;path&gt;] [-classpath &lt;path&gt;] [-o output] [build flags] [package]</span><br></pre></td></tr></table></figure><p>Bind 为导入路径命名的包生成语言绑定，并为命名的目标系统编译一个库。</p><p><code>-target</code>标志采用 android（默认）或一个或多个以逗号分隔的 Apple 平台（ios、iossimulator、macos、maccatalyst）。</p><p>对于 -target android，bind 命令会生成一个 AAR（Android ARchive）文件，该文件将预编译的 Java API 存根类、编译的共享库以及包目录下 &#x2F;assets 子目录中的所有资产文件存档。默认情况下，输出名为“<package_name>.aar”。此 AAR 文件通常用于 Android 库项目的二进制分发，并且大多数 Android IDE 都支持 AAR 导入。例如，在 Android Studio (1.2+) 中，可以使用模块导入向导 (File &gt; New &gt; New Module &gt; Import .JAR or .AAR package) 导入 AAR 文件，并将其设置为新依赖项 (File &gt; Project结构 &gt; 依赖项）。这需要“javac”（版本 1.7+）和 Android SDK（API 级别 15 或更高版本）来为 Android 构建库。环境变量 ANDROID_HOME 必须设置为 Android SDK 的路径。使用 -javapkg 标志为生成的类指定 Java 包前缀。</p><p>默认情况下，-target&#x3D;android 为所有支持的指令集（arm、arm64、386、amd64）构建共享库。可以通过使用架构名称指定目标类型来选择指令集的子集。例如，-target&#x3D;android&#x2F;arm,android&#x2F;386。 对于 Apple 目标平台，gomobile 必须在安装了 Xcode 的 OS X 机器上运行。生成的 Objective-C 类型可以使用 -prefix 标志作为前缀。 对于 -target android，-bootclasspath 和 -classpath 标志用于控制引导类路径和 Go 包装器到 Java 类的类路径。</p><p>-v 标志提供详细的输出，包括构建的包列表。 构建标志 -a、-n、-x、-gcflags、-ldflags、-tags、-trimpath 和 -work 与构建命令共享。</p><p>有关文档，请参阅“help build”。</p><h3 id="编译安卓-APK-和-iOS-应用"><a href="#编译安卓-APK-和-iOS-应用" class="headerlink" title="编译安卓 APK 和 iOS 应用"></a>编译安卓 APK 和 iOS 应用</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gomobile build [-target android|ios|iossimulator|macos|maccatalyst] [-o output] [-bundleid bundleID] [build flags] [package]</span><br></pre></td></tr></table></figure><p>Build 编译并编码由导入路径命名的应用程序。 命名包必须定义一个主函数。 -target 标志采用 android（默认）或一个或多个以逗号分隔的 Apple 平台（ios、iossimulator、macos、maccatalyst）。 </p><p>对于 -target android，如果在包目录中定义了 AndroidManifest.xml，则会将其添加到 APK 输出中。否则，将生成默认清单。默认情况下，这会为所有支持的指令集（arm、386、amd64、arm64）构建一个&quot;fat&quot; APK。可以通过使用架构名称指定目标类型来选择指令集的子集。例如。-target&#x3D;android&#x2F;arm,android&#x2F;386。</p><p> 对于 Apple 目标平台，gomobile 必须在安装了 Xcode 的 OS X 机器上运行。</p><p>默认情况下，-target ios 将为 ios 和 iossimulator 生成一个 XCFramework。可以指定多个 Apple 目标，为每个切片创建一个“fat”XCFramework。要为所有 supportec 架构（amd64 和 arm64）生成支持 iOS、macOS 和 macCatalyst 的fat XCFramework，请指定 -target ios,macos,maccatalyst。可以通过使用架构名称指定平台来选择指令集的子集。例如。 --target&#x3D;ios&#x2F;arm64,maccatalyst&#x2F;arm64。</p><p>如果包目录包含 assets 子目录，则其内容将复制到输出中。 </p><p>标志 -iosversion 设置要编译的 iOS SDK 的最低版本。默认版本为 13.0。 </p><p>标志 -androidapi 设置要编译的 Android API 版本。默认值和最小值为 15。</p><p> -target ios 需要 -bundleid 标志，并设置捆绑 ID 以与应用程序一起使用。 </p><p>-o 标志指定输出文件名。如果未指定，则输出文件名取决于构建的包。</p><p> -v 标志提供详细的输出，包括构建的包列表。 构建标志 -a、-i、-n、-x、-gcflags、-ldflags、-tags、-trimpath 和 -work 与构建命令共享。</p><p>有关文档，请参阅“help build”。</p><h3 id="删除目标文件和缓存的-gomobile-文件"><a href="#删除目标文件和缓存的-gomobile-文件" class="headerlink" title="删除目标文件和缓存的 gomobile 文件"></a>删除目标文件和缓存的 gomobile 文件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gomobile clean</span><br></pre></td></tr></table></figure><p>Clean 删除 gomobile init 下载的目标文件和缓存的 NDK 文件</p><h3 id="为-Android-构建-OpenAL"><a href="#为-Android-构建-OpenAL" class="headerlink" title="为 Android 构建 OpenAL"></a>为 Android 构建 OpenAL</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gomobile init [-openal dir]</span><br></pre></td></tr></table></figure><p>如果使用 -openal 指定 OpenAL 源目录，则 init 将构建 Android 版本的 OpenAL 以用于 gomobile 构建和 gomobile 安装。</p><h3 id="编译安卓APK并安装在设备上"><a href="#编译安卓APK并安装在设备上" class="headerlink" title="编译安卓APK并安装在设备上"></a>编译安卓APK并安装在设备上</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gomobile install [-target android] [build flags] [package]</span><br></pre></td></tr></table></figure><p>Install 在附加的移动设备上编译并安装由导入路径命名的应用程序。 仅支持 -target android。 “adb”工具必须在 PATH 上。 构建标志 -a、-i、-n、-x、-gcflags、-ldflags、-tags、-trimpath 和 -work 与构建命令共享。有关文档，请参阅“帮助构建”。</p><h3 id="打印版本"><a href="#打印版本" class="headerlink" title="打印版本"></a>打印版本</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gomobile version</span><br></pre></td></tr></table></figure><p>打印 gomobile 二进制文件和工具的版本</p><h2 id="库示例"><a href="#库示例" class="headerlink" title="库示例"></a>库示例</h2><h3 id="生成库aar"><a href="#生成库aar" class="headerlink" title="生成库aar"></a>生成库aar</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir go-mobile-demo</span><br><span class="line">cd go-mobile-demo</span><br><span class="line">go mod init go-mobile-demo</span><br><span class="line">mkdir test1 test2</span><br><span class="line">go get golang.org/x/mobile/bind</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">├── go.mod</span><br><span class="line">├── test1</span><br><span class="line">│   └── test1.go</span><br><span class="line">└── test2</span><br><span class="line">    └── test2.go</span><br></pre></td></tr></table></figure><p>go.mod</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">module go-mobile-demo</span><br><span class="line"></span><br><span class="line">go 1.18</span><br><span class="line"></span><br><span class="line">require (</span><br><span class="line">golang.org/x/mobile v0.0.0-20220518205345-8578da9835fd // indirect</span><br><span class="line">golang.org/x/mod v0.4.2 // indirect</span><br><span class="line">golang.org/x/sys v0.0.0-20210809222454-d867a43fc93e // indirect</span><br><span class="line">golang.org/x/tools v0.1.8-0.20211022200916-316ba0b74098 // indirect</span><br><span class="line">golang.org/x/xerrors v0.0.0-20200804184101-5ec99f83aff1 // indirect</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>test1.go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> test1</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Version = <span class="string">&quot;v0.0.1&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Test1 <span class="keyword">struct</span> &#123;</span><br><span class="line">Name <span class="type">string</span></span><br><span class="line">Age  <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *Test1)</span></span> EchoName() <span class="type">string</span> &#123;</span><br><span class="line"><span class="keyword">return</span> t.Name</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *Test1)</span></span> EchoAge() <span class="type">int</span> &#123;</span><br><span class="line"><span class="keyword">return</span> t.Age</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">PrintVersion</span><span class="params">()</span></span> &#123;</span><br><span class="line">fmt.Println(Version)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 以下方法名是不允许的</span></span><br><span class="line"><span class="comment">//func (t *Test1) GetAge() int &#123;</span></span><br><span class="line"><span class="comment">//return t.Age</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//func (t *Test1) SetAge(age int) &#123;</span></span><br><span class="line"><span class="comment">//t.Age = age</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>test2.go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> test2</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Test2 <span class="keyword">struct</span> &#123;</span><br><span class="line">Name <span class="type">string</span></span><br><span class="line">Age  <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *Test2)</span></span> EchoName() <span class="type">string</span> &#123;</span><br><span class="line"><span class="keyword">return</span> t.Name</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *Test2)</span></span> EchoAge() <span class="type">int</span> &#123;</span><br><span class="line"><span class="keyword">return</span> t.Age</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>生成android aar</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd go-mobile-demo</span><br><span class="line"></span><br><span class="line">gomobile bind -target=android -ldflags=-extldflags=-Wl,-soname,libgojni.so -o demo.aar ./test1 ./test2</span><br></pre></td></tr></table></figure><p>生成ios </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd go-mobile-demo</span><br><span class="line"></span><br><span class="line">gomobile bind -target=ios -ldflags=-extldflags=-Wl,-soname,libgojni.so -o demo.framework ./test1 ./test2</span><br></pre></td></tr></table></figure><h3 id="Android中引用"><a href="#Android中引用" class="headerlink" title="Android中引用"></a>Android中引用</h3><p>假设jar和aar都放到module的libs目录下，在module目录下的build.gradle的dependencies中,添加在项目中添加如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">implementation fileTree(include: [&#x27;*.jar&#x27;, &#x27;*.aar&#x27;], dir: &#x27;libs&#x27;)</span><br></pre></td></tr></table></figure><p>此种方式简单粗暴,但是不允许同时出现同一模块不同编译类型的jar(或aar),</p><p>例如,如果libs同时存在test-release.aar和test-debug.aar,他们都是来自同一个module的打包,但是只是编译类型不一样,如果同时存在的话,会编译不过.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">apply plugin: &#x27;com.android.application&#x27;</span><br><span class="line"></span><br><span class="line">android &#123;</span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    implementation fileTree(dir: &#x27;libs&#x27;, include: [&#x27;*.jar&#x27;, &#x27;*.aar&#x27;])</span><br><span class="line">    或</span><br><span class="line">    api fileTree(dir: &#x27;libs&#x27;, include: [&#x27;*.jar&#x27;, &#x27;*.aar&#x27;])</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Ios中引用"><a href="#Ios中引用" class="headerlink" title="Ios中引用"></a>Ios中引用</h3><p><a href="https://github.com/golang/go/wiki/Mobile#building-and-deploying-to-ios-1">https://github.com/golang/go/wiki/Mobile#building-and-deploying-to-ios-1</a></p><h2 id="android-ios项目"><a href="#android-ios项目" class="headerlink" title="android&#x2F;ios项目"></a>android&#x2F;ios项目</h2><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="https://links.jianshu.com/go?to=https://medium.com/@matryer/tutorial-calling-go-code-from-swift-on-ios-and-vice-versa-with-gomobile-7925620c17a4">Calling Go code from Swift on iOS and vice versa with Gomobile</a></li></ul><p>注意版本问题</p>]]></content>
    
    
      
      
    <summary type="html">&lt;script src=&quot;\assets\js\APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;h1 id=&quot;用go语言编写移动端sdk和app开发&quot;&gt;&lt;a href=&quot;#用go语言编写移动端sdk和app开发&quot; class=&quot;headerlink&quot; title=&quot;用go语</summary>
      
    
    
    
    <category term="golang" scheme="https://wangyyovo.github.io/categories/golang/"/>
    
    
  </entry>
  
  <entry>
    <title>在线编程IDE</title>
    <link href="https://wangyyovo.github.io/posts/5faac006/"/>
    <id>https://wangyyovo.github.io/posts/5faac006/</id>
    <published>2022-06-12T13:30:36.000Z</published>
    <updated>2022-06-12T13:30:36.000Z</updated>
    
    <content type="html"><![CDATA[<script src="\assets\js\APlayer.min.js"> </script><h1 id="在线编程IDE"><a href="#在线编程IDE" class="headerlink" title="在线编程IDE"></a>在线编程IDE</h1><h2 id="code-server"><a href="#code-server" class="headerlink" title="code-server"></a>code-server</h2><blockquote><p><a href="https://coder.com/docs/code-server/latest">https://coder.com/docs/code-server/latest</a></p></blockquote><h3 id="docker部署"><a href="#docker部署" class="headerlink" title="docker部署"></a>docker部署</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p ~/.config</span><br><span class="line"></span><br><span class="line">docker run -it --name code-server -p 5001:8080 \</span><br><span class="line">  -v &quot;$HOME/.config:/home/coder/.config&quot; \</span><br><span class="line">  -v &quot;/root/code:/home/coder/project&quot; \</span><br><span class="line">  -u &quot;$(id -u):$(id -g)&quot; \</span><br><span class="line">  -e &quot;DOCKER_USER=$USER&quot; \</span><br><span class="line">  -e PASSWORD=&#x27;wyy&#x27; \</span><br><span class="line">  codercom/code-server:latest</span><br></pre></td></tr></table></figure><h3 id="二进制部署"><a href="#二进制部署" class="headerlink" title="二进制部署"></a>二进制部署</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">vi ~/.config/code-server/config.yaml</span><br><span class="line"></span><br><span class="line">bind-addr: 0.0.0.0:5001</span><br><span class="line">auth: password</span><br><span class="line">password: wyy</span><br><span class="line">cert: false</span><br><span class="line"></span><br><span class="line">nohup ./code-server-4.4.0-linux-amd64/code-server /root/code &gt;&gt; log.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure><h2 id="openvscode-server"><a href="#openvscode-server" class="headerlink" title="openvscode-server"></a>openvscode-server</h2><blockquote><p><a href="https://github.com/gitpod-io/openvscode-server">https://github.com/gitpod-io/openvscode-server</a></p></blockquote><p>基于微软vscode</p><h3 id="docker部署-1"><a href="#docker部署-1" class="headerlink" title="docker部署"></a>docker部署</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --init \</span><br><span class="line">-p 5002:3000 \</span><br><span class="line">-v /root/openvscode-server/code:/home/workspace:cached \</span><br><span class="line">gitpod/openvscode-server</span><br></pre></td></tr></table></figure><h3 id="二进制部署-1"><a href="#二进制部署-1" class="headerlink" title="二进制部署"></a>二进制部署</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./openvscode-server --host=0.0.0.0 --port=5002 --server-data-dir=./server-data --user-data-dir=./user-data --extensions-dir=./extensions-data --connection-token=wyy</span><br></pre></td></tr></table></figure><h2 id="OpenSumi"><a href="#OpenSumi" class="headerlink" title="OpenSumi"></a>OpenSumi</h2><blockquote><p><a href="https://opensumi.com/zh/docs/integrate/quick-start/web">https://opensumi.com/zh/docs/integrate/quick-start/web</a></p><p><a href="https://github.com/opensumi/core">https://github.com/opensumi/core</a></p></blockquote><h3 id="docker部署-2"><a href="#docker部署-2" class="headerlink" title="docker部署"></a>docker部署</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">运行</span></span><br><span class="line">docker run --rm -d  -p 5002:8000/tcp ghcr.io/opensumi/opensumi-web:latest</span><br></pre></td></tr></table></figure><h2 id="theia"><a href="#theia" class="headerlink" title="theia"></a>theia</h2><p><a href="https://github.com/eclipse-theia/theia">https://github.com/eclipse-theia/theia</a><br><a href="https://github.com/theia-ide/theia-apps">https://github.com/theia-ide/theia-apps</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;script src=&quot;\assets\js\APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;h1 id=&quot;在线编程IDE&quot;&gt;&lt;a href=&quot;#在线编程IDE&quot; class=&quot;headerlink&quot; title=&quot;在线编程IDE&quot;&gt;&lt;/a&gt;在线编程IDE&lt;/h1&gt;&lt;h2</summary>
      
    
    
    
    <category term="other" scheme="https://wangyyovo.github.io/categories/other/"/>
    
    
  </entry>
  
  <entry>
    <title>即时性能分析工具Pyroscope</title>
    <link href="https://wangyyovo.github.io/posts/7594185d/"/>
    <id>https://wangyyovo.github.io/posts/7594185d/</id>
    <published>2022-06-12T08:07:36.000Z</published>
    <updated>2022-06-12T08:07:36.000Z</updated>
    
    <content type="html"><![CDATA[<script src="\assets\js\APlayer.min.js"> </script><h1 id="即时性能分析工具Pyroscope"><a href="#即时性能分析工具Pyroscope" class="headerlink" title="即时性能分析工具Pyroscope"></a>即时性能分析工具Pyroscope</h1><blockquote><p><a href="https://pyroscope.io/docs/installing-pyroscope-overview/">https://pyroscope.io/docs/installing-pyroscope-overview/</a></p><p><a href="https://pyroscope.io/blog/">https://pyroscope.io/blog/</a></p></blockquote><p>目前支持的语言</p><ul><li>Go</li><li>Python</li><li>eBPF</li><li>Java</li><li>Ruby</li><li>Rust</li><li>PHP</li><li>.NET</li><li>NodeJS</li></ul><h2 id="分析go性能"><a href="#分析go性能" class="headerlink" title="分析go性能"></a>分析go性能</h2><h3 id="安装Pyroscope-server"><a href="#安装Pyroscope-server" class="headerlink" title="安装Pyroscope server"></a>安装Pyroscope server</h3><p>window暂不支持server</p><h4 id="二进制"><a href="#二进制" class="headerlink" title="二进制"></a>二进制</h4><blockquote><p>window管理员运行终端</p></blockquote><p>下载地址：<a href="https://github.com/pyroscope-io/pyroscope/releases">https://github.com/pyroscope-io/pyroscope/releases</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./pyroscope server --api-bind-addr=:5002 --adhoc-data-path /root/.local/share/pyroscope</span><br></pre></td></tr></table></figure><h4 id="docker"><a href="#docker" class="headerlink" title="docker"></a>docker</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it -p 4040:4040 pyroscope/pyroscope:latest server</span><br></pre></td></tr></table></figure><p>docker-compose</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">pyroscope:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">&quot;pyroscope/pyroscope:latest&quot;</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;4040:4040&quot;</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;server&quot;</span></span><br></pre></td></tr></table></figure><h3 id="在Go里面安装agent"><a href="#在Go里面安装agent" class="headerlink" title="在Go里面安装agent"></a>在Go里面安装agent</h3><p><a href="https://github.com/pyroscope-io/pyroscope/tree/main/examples/golang-push">https://github.com/pyroscope-io/pyroscope/tree/main/examples/golang-push</a></p><h4 id="push模式"><a href="#push模式" class="headerlink" title="push模式"></a>push模式</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;context&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line"><span class="string">&quot;runtime/pprof&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;github.com/pyroscope-io/client/pyroscope&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">//go:noinline</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">work</span><span class="params">(n <span class="type">int</span>)</span></span> &#123;</span><br><span class="line"><span class="comment">// revive:disable:empty-block this is fine because this is a example app, not real production code</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; n; i++ &#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// revive:enable:empty-block</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">fastFunction</span><span class="params">(c context.Context)</span></span> &#123;</span><br><span class="line">pyroscope.TagWrapper(c, pyroscope.Labels(<span class="string">&quot;function&quot;</span>, <span class="string">&quot;fast&quot;</span>), <span class="function"><span class="keyword">func</span><span class="params">(c context.Context)</span></span> &#123;</span><br><span class="line">work(<span class="number">20000000</span>)</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">slowFunction</span><span class="params">(c context.Context)</span></span> &#123;</span><br><span class="line"><span class="comment">// standard pprof.Do wrappers work as well</span></span><br><span class="line">pprof.Do(c, pprof.Labels(<span class="string">&quot;function&quot;</span>, <span class="string">&quot;slow&quot;</span>), <span class="function"><span class="keyword">func</span><span class="params">(c context.Context)</span></span> &#123;</span><br><span class="line">work(<span class="number">80000000</span>)</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">serverAddress := os.Getenv(<span class="string">&quot;PYROSCOPE_SERVER_ADDRESS&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> serverAddress == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">serverAddress = <span class="string">&quot;http://localhost:4040&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">pyroscope.Start(pyroscope.Config&#123;</span><br><span class="line">ApplicationName: <span class="string">&quot;test.golang.app&quot;</span>,</span><br><span class="line">ServerAddress:   serverAddress,</span><br><span class="line">Logger:          pyroscope.StandardLogger,</span><br><span class="line">&#125;)</span><br><span class="line">pyroscope.TagWrapper(context.Background(), pyroscope.Labels(<span class="string">&quot;foo&quot;</span>, <span class="string">&quot;bar&quot;</span>), <span class="function"><span class="keyword">func</span><span class="params">(c context.Context)</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">fastFunction(c)</span><br><span class="line">slowFunction(c)</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go run test.go</span><br></pre></td></tr></table></figure><h4 id="pull模式"><a href="#pull模式" class="headerlink" title="pull模式"></a>pull模式</h4><blockquote><p><a href="https://pyroscope.io/docs/golang-pull-mode/">https://pyroscope.io/docs/golang-pull-mode/</a></p><p><a href="https://pyroscope.io/docs/server-configuration/">https://pyroscope.io/docs/server-configuration/</a></p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;math&quot;</span></span><br><span class="line"><span class="string">&quot;math/rand&quot;</span></span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line">_ <span class="string">&quot;net/http/pprof&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">isPrime</span><span class="params">(n <span class="type">int64</span>)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line"><span class="keyword">for</span> i := <span class="type">int64</span>(<span class="number">2</span>); i &lt;= n; i++ &#123;</span><br><span class="line"><span class="keyword">if</span> i*i &gt; n &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> n%i == <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">slow</span><span class="params">(n <span class="type">int64</span>)</span></span> <span class="type">int64</span> &#123;</span><br><span class="line">sum := <span class="type">int64</span>(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">for</span> i := <span class="type">int64</span>(<span class="number">1</span>); i &lt;= n; i++ &#123;</span><br><span class="line">sum += i</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> sum</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">fast</span><span class="params">(n <span class="type">int64</span>)</span></span> <span class="type">int64</span> &#123;</span><br><span class="line">sum := <span class="type">int64</span>(<span class="number">0</span>)</span><br><span class="line">root := <span class="type">int64</span>(math.Sqrt(<span class="type">float64</span>(n)))</span><br><span class="line"><span class="keyword">for</span> a := <span class="type">int64</span>(<span class="number">1</span>); a &lt;= n; a += root &#123;</span><br><span class="line">b := a + root - <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> n &lt; b &#123;</span><br><span class="line">b = n</span><br><span class="line">&#125;</span><br><span class="line">sum += (b - a + <span class="number">1</span>) * (a + b) / <span class="number">2</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> sum</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">run</span><span class="params">()</span></span> &#123;</span><br><span class="line">base := rand.Int63n(<span class="number">1000000</span>) + <span class="number">1</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="type">int64</span>(<span class="number">0</span>); i &lt; <span class="number">40000000</span>; i++ &#123;</span><br><span class="line">n := rand.Int63n(<span class="number">10000</span>) + <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> isPrime(base + i) &#123;</span><br><span class="line">slow(n)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">fast(n)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">log.Println(http.ListenAndServe(<span class="string">&quot;:6060&quot;</span>, <span class="literal">nil</span>))</span><br><span class="line">&#125;()</span><br><span class="line">run()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&#x2F;etc&#x2F;pyroscope&#x2F;server.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">mkdir</span> <span class="string">-p</span> <span class="string">/etc/pyroscope/</span></span><br><span class="line"><span class="string">vi</span> <span class="string">/etc/pyroscope/server.yml</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># A list of scrape configurations.</span></span><br><span class="line"><span class="attr">scrape-configs:</span></span><br><span class="line">  <span class="comment"># The job name assigned to scraped profiles by default.</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job-name:</span> <span class="string">pyroscope</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># The list of profiles to be scraped from the targets.</span></span><br><span class="line">    <span class="attr">enabled-profiles:</span> [<span class="string">cpu</span>, <span class="string">mem</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># List of labeled statically configured targets for this job.</span></span><br><span class="line">    <span class="attr">static-configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">application:</span> <span class="string">test.app.www</span></span><br><span class="line">        <span class="attr">spy-name:</span> <span class="string">gospy</span></span><br><span class="line">        <span class="attr">targets:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:6060</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">env:</span> <span class="string">dev</span></span><br></pre></td></tr></table></figure><p>启动go程序</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go run test.go</span><br></pre></td></tr></table></figure><p>启动pyroscope server</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./pyroscope server --api-bind-addr=:5002 --adhoc-data-path /root/.local/share/pyroscope --config /etc/pyroscope/server.yml</span><br></pre></td></tr></table></figure><h3 id="dhoc-profiling-使用方式"><a href="#dhoc-profiling-使用方式" class="headerlink" title="dhoc profiling 使用方式"></a>dhoc profiling 使用方式</h3><blockquote><p><a href="https://github.com/pyroscope-io/pyroscope/tree/main/examples/adhoc">https://github.com/pyroscope-io/pyroscope/tree/main/examples/adhoc</a></p></blockquote><p>不需要Pyroscope server，在本地进行性能测试产生数据。</p><h4 id="push模式-1"><a href="#push模式-1" class="headerlink" title="push模式"></a>push模式</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;context&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line"><span class="string">&quot;runtime/pprof&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;github.com/pyroscope-io/client/pyroscope&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">//go:noinline</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">work</span><span class="params">(n <span class="type">int</span>)</span></span> &#123;</span><br><span class="line"><span class="comment">// revive:disable:empty-block this is fine because this is a example app, not real production code</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; n; i++ &#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// revive:enable:empty-block</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">fastFunction</span><span class="params">(c context.Context)</span></span> &#123;</span><br><span class="line">pyroscope.TagWrapper(c, pyroscope.Labels(<span class="string">&quot;function&quot;</span>, <span class="string">&quot;fast&quot;</span>), <span class="function"><span class="keyword">func</span><span class="params">(c context.Context)</span></span> &#123;</span><br><span class="line">work(<span class="number">20000000</span>)</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">slowFunction</span><span class="params">(c context.Context)</span></span> &#123;</span><br><span class="line"><span class="comment">// standard pprof.Do wrappers work as well</span></span><br><span class="line">pprof.Do(c, pprof.Labels(<span class="string">&quot;function&quot;</span>, <span class="string">&quot;slow&quot;</span>), <span class="function"><span class="keyword">func</span><span class="params">(c context.Context)</span></span> &#123;</span><br><span class="line">work(<span class="number">80000000</span>)</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">serverAddress := os.Getenv(<span class="string">&quot;PYROSCOPE_SERVER_ADDRESS&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> serverAddress == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">serverAddress = <span class="string">&quot;http://localhost:4040&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">pyroscope.Start(pyroscope.Config&#123;</span><br><span class="line">ApplicationName: <span class="string">&quot;test.golang.app&quot;</span>,</span><br><span class="line">ServerAddress:   serverAddress,</span><br><span class="line">Logger:          pyroscope.StandardLogger,</span><br><span class="line">&#125;)</span><br><span class="line">pyroscope.TagWrapper(context.Background(), pyroscope.Labels(<span class="string">&quot;foo&quot;</span>, <span class="string">&quot;bar&quot;</span>), <span class="function"><span class="keyword">func</span><span class="params">(c context.Context)</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">fastFunction(c)</span><br><span class="line">slowFunction(c)</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">pyroscope adhoc --data-path ./ --output-format pprof --push go run test.go</span></span><br><span class="line">pyroscope adhoc --output-format pprof --data-path ./ go run test.go</span><br></pre></td></tr></table></figure><h4 id="pull模式-1"><a href="#pull模式-1" class="headerlink" title="pull模式"></a>pull模式</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;math&quot;</span></span><br><span class="line"><span class="string">&quot;math/rand&quot;</span></span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line">_ <span class="string">&quot;net/http/pprof&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">isPrime</span><span class="params">(n <span class="type">int64</span>)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line"><span class="keyword">for</span> i := <span class="type">int64</span>(<span class="number">2</span>); i &lt;= n; i++ &#123;</span><br><span class="line"><span class="keyword">if</span> i*i &gt; n &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> n%i == <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">slow</span><span class="params">(n <span class="type">int64</span>)</span></span> <span class="type">int64</span> &#123;</span><br><span class="line">sum := <span class="type">int64</span>(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">for</span> i := <span class="type">int64</span>(<span class="number">1</span>); i &lt;= n; i++ &#123;</span><br><span class="line">sum += i</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> sum</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">fast</span><span class="params">(n <span class="type">int64</span>)</span></span> <span class="type">int64</span> &#123;</span><br><span class="line">sum := <span class="type">int64</span>(<span class="number">0</span>)</span><br><span class="line">root := <span class="type">int64</span>(math.Sqrt(<span class="type">float64</span>(n)))</span><br><span class="line"><span class="keyword">for</span> a := <span class="type">int64</span>(<span class="number">1</span>); a &lt;= n; a += root &#123;</span><br><span class="line">b := a + root - <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> n &lt; b &#123;</span><br><span class="line">b = n</span><br><span class="line">&#125;</span><br><span class="line">sum += (b - a + <span class="number">1</span>) * (a + b) / <span class="number">2</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> sum</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">run</span><span class="params">()</span></span> &#123;</span><br><span class="line">base := rand.Int63n(<span class="number">1000000</span>) + <span class="number">1</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="type">int64</span>(<span class="number">0</span>); i &lt; <span class="number">40000000</span>; i++ &#123;</span><br><span class="line">n := rand.Int63n(<span class="number">10000</span>) + <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> isPrime(base + i) &#123;</span><br><span class="line">slow(n)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">fast(n)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">log.Println(http.ListenAndServe(<span class="string">&quot;:6060&quot;</span>, <span class="literal">nil</span>))</span><br><span class="line">&#125;()</span><br><span class="line">run()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">go run test.go &amp;</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">pyroscope adhoc --url localhost:6060</span></span><br><span class="line">pyroscope adhoc  --application-name wangyangyang.app --data-path ./ --output-format pprof --url localhost:6060 go run test.go</span><br></pre></td></tr></table></figure><p>执行完毕后，你可以看到在同一层目录多了很多 HTML 文件，而这些文件就可以分享给其他同事参考，先相当方便来当作团队协作的工具。</p><p> 除了点开 HTML 文件之外，大家也可以用 pyroscope CLI 在本机端打开 Server 服务，此時 Server服务回去读取家目录內 <code>~/.pyroscope/pyroscope/</code> 位置，里面存放每次生成的 Profiling JSON 格式数据。打开<code>http://localhost:4040</code>可以查看</p><h2 id="Server配置"><a href="#Server配置" class="headerlink" title="Server配置"></a>Server配置</h2><p>有 3 种方式来配置 pyroscope。配置优先级按以下顺序评估： </p><ul><li><p>命令行参数 </p></li><li><p>环境变量 </p></li><li><p>配置文件</p></li></ul><h3 id="命令行参数"><a href="#命令行参数" class="headerlink" title="命令行参数"></a>命令行参数</h3><p>这是配置 pyroscope 的最简单方法。对于命令行参数和默认值的列表，运行<code>pyroscope server -help</code>：</p><table><thead><tr><th>Name</th><th>Default Value</th><th>Usage</th></tr></thead><tbody><tr><td>adhoc-data-path</td><td>OS dependent</td><td>pyroscope 存储临时配置文件的目录</td></tr><tr><td>analytics-opt-out</td><td>false</td><td>禁用分析</td></tr><tr><td>log-level</td><td>info</td><td>日志级别: debug|info|warn|error.</td></tr><tr><td>badger-log-level</td><td>error</td><td>日志级别: debug|info|warn|error.</td></tr><tr><td>storage-path</td><td>&#x2F;var&#x2F;lib&#x2F;pyroscope</td><td>pyroscope 存储分析数据的目录</td></tr><tr><td>api-bind-addr</td><td>:4040</td><td>用于数据采集和 Web UI 访问端口</td></tr><tr><td>base-url</td><td></td><td>当服务器位于具有不同路径的反向代理后面时的基本 URL</td></tr><tr><td>cache-evict-threshold</td><td>0.25</td><td>Percentage of memory at which cache evictions start.</td></tr><tr><td>cache-evict-volume</td><td>0.33</td><td>Percentage of cache that is evicted per eviction run.</td></tr><tr><td>badger-no-truncate</td><td>false</td><td>Indicates whether value log files should be truncated to delete corrupt data, if any.</td></tr><tr><td>disable-pprof-endpoint</td><td>false</td><td>Disables &#x2F;debug&#x2F;pprof route.</td></tr><tr><td>max-nodes-serialization</td><td>2048</td><td>Max number of nodes used when saving profiles to disk.</td></tr><tr><td>max-nodes-render</td><td>8192</td><td>Max number of nodes used to display data on the frontend.</td></tr><tr><td>no-adhoc-ui</td><td>false</td><td>Disable the adhoc UI interface.</td></tr><tr><td>hide-applications</td><td>[]</td><td>Please don&#39;t use, this will soon be deprecated.</td></tr><tr><td>retention</td><td>0s</td><td>Sets the maximum amount of time the profiling data is stored for. Data before this threshold is deleted. Disabled by default.</td></tr><tr><td>exemplars-retention</td><td>0s</td><td>Sets the maximum amount of time profile exemplars are stored for. Data before this threshold is deleted. Disabled by default.</td></tr><tr><td>retention-levels</td><td>{}</td><td>Specifies how long the profiling data is stored per aggregation level. Disabled by default.</td></tr><tr><td>tls-certificate-file</td><td>&quot;&quot;</td><td>Location of TLS Certificate file (.crt).</td></tr><tr><td>tls-key-file</td><td>&quot;&quot;</td><td>Location of TLS Private key file (.key).</td></tr></tbody></table><h3 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h3><p>环境变量必须具有<code>PYROSCOPE_</code> 前缀并采用 <code>UPPER_SNAKE_CASE</code> 格式，例如：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PYROSCOPE_API_BIND_ADDR=:9999 pyroscope server</span><br></pre></td></tr></table></figure><h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><p>配置文件以 YAML 格式存储。默认配置文件路径位于：</p><ul><li><code>/etc/pyroscope/server.yml</code> on Linux</li><li><code>/usr/local/etc/pyroscope/server.yml</code> on Intel macOS</li><li><code>/opt/homebrew/etc/pyroscope/server.yml</code> on M1 macOS</li></ul><p><strong>windows不支持server</strong></p><p>您可以使用 <code>-config &lt;path&gt;</code> 参数覆盖默认配置文件，例如：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pyroscope server -config my-custom-config.yml</span><br></pre></td></tr></table></figure><p>或环境变量：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PYROSCOPE_CONFIG=/tmp/pyroscope-server.yml pyroscope server</span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Disables analytics.</span></span><br><span class="line"><span class="attr">analytics-opt-out:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Log level: debug|info|warn|error.</span></span><br><span class="line"><span class="attr">log-level:</span> <span class="string">&quot;info&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Log level: debug|info|warn|error.</span></span><br><span class="line"><span class="attr">badger-log-level:</span> <span class="string">&quot;error&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Directory where pyroscope stores profiling data.</span></span><br><span class="line"><span class="attr">storage-path:</span> <span class="string">&quot;/var/lib/pyroscope&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Port for the HTTP server used for data ingestion and web UI.</span></span><br><span class="line"><span class="attr">api-bind-addr:</span> <span class="string">&quot;:4040&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Base URL for when the server is behind a reverse proxy with a different path.</span></span><br><span class="line"><span class="attr">base-url:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Percentage of memory at which cache evictions start.</span></span><br><span class="line"><span class="attr">cache-evict-threshold:</span> <span class="string">&quot;0.25&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Percentage of cache that is evicted per eviction run.</span></span><br><span class="line"><span class="attr">cache-evict-volume:</span> <span class="string">&quot;0.33&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Database configuration. By default, Pyroscope Server uses embedded sqlite3 database.</span></span><br><span class="line"><span class="attr">database:</span></span><br><span class="line">  <span class="comment"># Indicates the database type. Supported DB engines: sqlite3.</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">&quot;sqlite3&quot;</span></span><br><span class="line">  <span class="comment"># Database connection string. Specific to the engine.</span></span><br><span class="line">  <span class="attr">url:</span> <span class="string">&quot;/var/lib/pyroscope/pyroscope.db&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Indicates whether value log files should be truncated to delete corrupt data, if any.</span></span><br><span class="line"><span class="attr">badger-no-truncate:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Disables /debug/pprof route.</span></span><br><span class="line"><span class="attr">disable-pprof-endpoint:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Max number of nodes used when saving profiles to disk.</span></span><br><span class="line"><span class="attr">max-nodes-serialization:</span> <span class="string">&quot;2048&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Max number of nodes used to display data on the frontend.</span></span><br><span class="line"><span class="attr">max-nodes-render:</span> <span class="string">&quot;8192&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Please don&#x27;t use, this will soon be deprecated.</span></span><br><span class="line"><span class="attr">hide-applications:</span> []</span><br><span class="line"></span><br><span class="line"><span class="comment"># Sets the maximum amount of time the profiling data is stored for. Data before this threshold is deleted. Disabled by default.</span></span><br><span class="line"><span class="attr">retention:</span> <span class="string">&quot;0s&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Sets the maximum amount of time profile exemplars are stored for. Data before this threshold is deleted. Disabled by default.</span></span><br><span class="line"><span class="attr">exemplars-retention:</span> <span class="string">&quot;0s&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Specifies how long the profiling data is stored per aggregation level. Disabled by default.</span></span><br><span class="line"><span class="attr">retention-levels:</span> &#123;&#125;</span><br><span class="line"><span class="comment"># 0: 720h  # 30 days</span></span><br><span class="line"><span class="comment"># 1: 2160h # 90 days</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Metrics export rules.</span></span><br><span class="line"><span class="attr">metrics-export-rules:</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># A list of scrape configurations.</span></span><br><span class="line"><span class="attr">scrape-configs:</span> []</span><br><span class="line"></span><br><span class="line"><span class="comment"># Location of TLS Certificate file (.crt).</span></span><br><span class="line"><span class="attr">tls-certificate-file:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Location of TLS Private key file (.key).</span></span><br><span class="line"><span class="attr">tls-key-file:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="Agent配置"><a href="#Agent配置" class="headerlink" title="Agent配置"></a>Agent配置</h2><p>有 3 种配置 Pyroscope 代理的方法。配置优先级按以下顺序评估： </p><ul><li><p>命令行参数</p></li><li><p>环境变量 </p></li><li><p>配置文件</p></li></ul><p>根据 Pyroscope 代理的运行方式，配置选项会有所不同</p><ul><li><a href="https://pyroscope.io/docs/agent-configuration-exec/"><code>pyroscope exec</code></a></li><li><a href="https://pyroscope.io/docs/agent-configuration-connect/"><code>pyroscope connect</code></a></li><li><a href="https://pyroscope.io/docs/agent-configuration-agent/"><code>pyroscope agent</code></a></li><li><a href="https://pyroscope.io/docs/agent-configuration-adhoc/"><code>pyroscope adhoc</code></a></li></ul><h3 id="命令行参数-1"><a href="#命令行参数-1" class="headerlink" title="命令行参数"></a>命令行参数</h3><p>配置文件以 YAML 格式存储。您可以使用 <code>-config &lt;path&gt;</code> 参数指定配置文件位置，例如：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pyroscope agent -config /tmp/my-config.yml &#123;args&#125;</span><br></pre></td></tr></table></figure><p>或者一个环境变量，例如：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PYROSCOPE_CONFIG=/tmp/my-config.yml pyroscope exec &#123;args&#125;</span><br></pre></td></tr></table></figure><h3 id="环境变量-1"><a href="#环境变量-1" class="headerlink" title="环境变量"></a>环境变量</h3><p>环境变量必须具有 <code>PYROSCOPE_</code> 前缀并采用 <code>UPPER_SNAKE_CASE</code> 格式，例如：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PYROSCOPE_API_BIND_ADDR=:9999 pyroscope server</span><br></pre></td></tr></table></figure><h3 id="pyroscope-exec"><a href="#pyroscope-exec" class="headerlink" title="pyroscope exec"></a>pyroscope exec</h3><p>该命令生成一个新进程并附加配置的探查器。一旦 pyroscope exec 退出，子进程也会退出，反之亦然。此命令可用于测试、作为 docker 入口点或作为 systemd 服务单元命令。</p><h4 id="命令行参数-2"><a href="#命令行参数-2" class="headerlink" title="命令行参数"></a>命令行参数</h4><table><thead><tr><th>Name</th><th>Default Value</th><th>Usage</th></tr></thead><tbody><tr><td>spy-name</td><td>auto</td><td>Name of the profiler you want to use. Supported ones are: pyspy, rbspy, phpspy, dotnetspy, ebpfspy.</td></tr><tr><td>application-name</td><td></td><td>Application name used when uploading profiling data.</td></tr><tr><td>sample-rate</td><td>100</td><td>Sample rate for the profiler in Hz. 100 means reading 100 times per second.</td></tr><tr><td>detect-subprocesses</td><td>true</td><td>Makes pyroscope keep track of and profile subprocesses of the main process.</td></tr><tr><td>log-level</td><td>info</td><td>Log level: debug|info|warn|error.</td></tr><tr><td>server-address</td><td><a href="http://localhost:4040/">http://localhost:4040</a></td><td>Address of the pyroscope server.</td></tr><tr><td>auth-token</td><td></td><td>Authorization token used to upload profiling data.</td></tr><tr><td>upstream-threads</td><td>4</td><td>Number of upload threads.</td></tr><tr><td>upstream-request-timeout</td><td>10s</td><td>Profile upload timeout.</td></tr><tr><td>no-logging</td><td>false</td><td>Disables logging from pyroscope.</td></tr><tr><td>no-root-drop</td><td>false</td><td>Disables permissions drop when ran under root. use this one if you want to run your command as root.</td></tr><tr><td>user-name</td><td></td><td>Starts process under specified user name.</td></tr><tr><td>group-name</td><td></td><td>Starts process under specified group name.</td></tr><tr><td>pyspy-blocking</td><td>false</td><td>Enables blocking mode for pyspy.</td></tr><tr><td>rbspy-blocking</td><td>false</td><td>Enables blocking mode for rbspy.</td></tr><tr><td>tag</td><td>{}</td><td>Tag in key&#x3D;value form. The flag may be specified multiple times.</td></tr></tbody></table><div class="note modern"><p><strong>application-name</strong>可以在规范中描述中指定。例如：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">my.awesome.app&#123;env=staging,region=us-west-1&#125;</span><br></pre></td></tr></table></figure><p>明确指定的标签优先。</p></div><h4 id="环境变量-2"><a href="#环境变量-2" class="headerlink" title="环境变量"></a>环境变量</h4><p>环境变量必须具有 <code>PYROSCOPE_</code> 前缀并采用 <code>UPPER_SNAKE_CASE</code> 格式，例如：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PYROSCOPE_APPLICATION_NAME=my.awesome.app</span><br></pre></td></tr></table></figure><h3 id="pyroscope-connect"><a href="#pyroscope-connect" class="headerlink" title="pyroscope connect"></a>pyroscope connect</h3><p>该命令将探查器附加到 PID 或操作系统指定的已运行进程（例如，ebpf 集成）。</p><h4 id="命令行参数-3"><a href="#命令行参数-3" class="headerlink" title="命令行参数"></a>命令行参数</h4><p>参数与 <code>pyroscope exec</code> 相同，只是 <code>pyroscope connect</code> 需要指定 <code>-pid</code>：</p><table><thead><tr><th>Name</th><th>Default Value</th><th>Usage</th></tr></thead><tbody><tr><td>spy-name</td><td>auto</td><td>Name of the profiler you want to use. Supported ones are: pyspy, rbspy, phpspy, dotnetspy, ebpfspy.</td></tr><tr><td>application-name</td><td></td><td>Application name used when uploading profiling data.</td></tr><tr><td>sample-rate</td><td>100</td><td>Sample rate for the profiler in Hz. 100 means reading 100 times per second.</td></tr><tr><td>detect-subprocesses</td><td>true</td><td>Makes pyroscope keep track of and profile subprocesses of the main process.</td></tr><tr><td>log-level</td><td>info</td><td>Log level: debug|info|warn|error.</td></tr><tr><td>server-address</td><td><a href="http://localhost:4040/">http://localhost:4040</a></td><td>Address of the pyroscope server.</td></tr><tr><td>auth-token</td><td></td><td>Authorization token used to upload profiling data.</td></tr><tr><td>upstream-threads</td><td>4</td><td>Number of upload threads.</td></tr><tr><td>upstream-request-timeout</td><td>10s</td><td>Profile upload timeout.</td></tr><tr><td>no-logging</td><td>false</td><td>Disables logging from pyroscope.</td></tr><tr><td>pid</td><td>0</td><td>PID of the process you want to profile. Pass -1 to profile the whole system (only supported by ebpfspy).</td></tr><tr><td>pyspy-blocking</td><td>false</td><td>Enables blocking mode for pyspy.</td></tr><tr><td>rbspy-blocking</td><td>false</td><td>Enables blocking mode for rbspy.</td></tr><tr><td>tag</td><td>{}</td><td>Tag in key&#x3D;value form. The flag may be specified multiple times.</td></tr></tbody></table><div class="note modern"><p><strong>application-name</strong>可以在规范中描述中指定。例如：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">my.awesome.app&#123;env=staging,region=us-west-1&#125;</span><br></pre></td></tr></table></figure><p>明确指定的标签优先。</p></div><h4 id="环境变量-3"><a href="#环境变量-3" class="headerlink" title="环境变量"></a>环境变量</h4><p>环境变量必须具有 <code>PYROSCOPE_</code> 前缀并采用 <code>UPPER_SNAKE_CASE</code> 格式，例如：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PYROSCOPE_APPLICATION_NAME=my.awesome.app</span><br></pre></td></tr></table></figure><h3 id="pyroscope-agent"><a href="#pyroscope-agent" class="headerlink" title="pyroscope agent"></a>pyroscope agent</h3><p>该命令持续跟踪配置的目标并将分析器附加到它们。此命令主要应该在诸如 systemd 或 Windows 服务控制管理器之类的服务管理器的上下文中运行，或者在事先不知道目标应用程序时运行。</p><div class="note modern"><p>pyroscope agent命令仅在 Windows 上受支持。</p></div><h4 id="命令行参数-4"><a href="#命令行参数-4" class="headerlink" title="命令行参数"></a>命令行参数</h4><table><thead><tr><th>Name</th><th>Default Value</th><th>Usage</th></tr></thead><tbody><tr><td>log-file-path</td><td></td><td>Log file path.</td></tr><tr><td>log-level</td><td>info</td><td>Log level: debug|info|warn|error.</td></tr><tr><td>no-logging</td><td>false</td><td>Disables logging from pyroscope.</td></tr><tr><td>server-address</td><td><a href="http://localhost:4040/">http://localhost:4040</a></td><td>Address of the pyroscope server.</td></tr><tr><td>auth-token</td><td></td><td>Authorization token used to upload profiling data.</td></tr><tr><td>upstream-threads</td><td>4</td><td>Number of upload threads.</td></tr><tr><td>upstream-request-timeout</td><td>10s</td><td>Profile upload timeout.</td></tr><tr><td>tag</td><td>{}</td><td>Tag key value pairs.</td></tr></tbody></table><h4 id="配置文件选项"><a href="#配置文件选项" class="headerlink" title="配置文件选项"></a>配置文件选项</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Log file path.</span></span><br><span class="line"><span class="attr">log-file-path:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Log level: debug|info|warn|error.</span></span><br><span class="line"><span class="attr">log-level:</span> <span class="string">&quot;info&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Disables logging from pyroscope.</span></span><br><span class="line"><span class="attr">no-logging:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Address of the pyroscope server.</span></span><br><span class="line"><span class="attr">server-address:</span> <span class="string">&quot;http://localhost:4040&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Authorization token used to upload profiling data.</span></span><br><span class="line"><span class="attr">auth-token:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Number of upload threads.</span></span><br><span class="line"><span class="attr">upstream-threads:</span> <span class="string">&quot;4&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Profile upload timeout.</span></span><br><span class="line"><span class="attr">upstream-request-timeout:</span> <span class="string">&quot;10s&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># List of targets to be profiled.</span></span><br><span class="line"><span class="attr">targets:</span> []</span><br><span class="line"></span><br><span class="line"><span class="comment"># Tag key value pairs.</span></span><br><span class="line"><span class="attr">tags:</span> &#123;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>目标描述要分析的应用程序。目前唯一支持的类型是系统服务。 请注意，不能使用命令行参数的同时使用环境变量指定目标。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Name of the system service to be profiled.</span></span><br><span class="line"><span class="attr">service-name:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Name of the profiler you want to use. Supported ones are: pyspy, rbspy, phpspy, dotnetspy, ebpfspy.</span></span><br><span class="line"><span class="attr">spy-name:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Application name used when uploading profiling data.</span></span><br><span class="line"><span class="attr">application-name:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Sample rate for the profiler in Hz. 100 means reading 100 times per second.</span></span><br><span class="line"><span class="attr">sample-rate:</span> <span class="string">&quot;100&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Makes pyroscope keep track of and profile subprocesses of the main process.</span></span><br><span class="line"><span class="attr">detect-subprocesses:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Enables blocking mode for pyspy.</span></span><br><span class="line"><span class="attr">pyspy-blocking:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Enables blocking mode for rbspy.</span></span><br><span class="line"><span class="attr">rbspy-blocking:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><div class="note modern"><p><strong>application-name</strong>可以在规范中描述中指定。例如：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">my.awesome.app&#123;env=staging,region=us-west-1&#125;</span><br></pre></td></tr></table></figure><p>明确指定的标签优先。</p></div><h4 id="环境变量-4"><a href="#环境变量-4" class="headerlink" title="环境变量"></a>环境变量</h4><p>环境变量必须具有 <code>PYROSCOPE_</code> 前缀并采用 <code>UPPER_SNAKE_CASE</code> 格式，例如：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PYROSCOPE_APPLICATION_NAME=my.awesome.app</span><br></pre></td></tr></table></figure><h4 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h4><p>此示例显示了如何分析名称为 <code>MyService</code> 的系统服务：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">log-level:</span> <span class="string">&quot;debug&quot;</span></span><br><span class="line"><span class="attr">server-address:</span> <span class="string">http://pyroscope-server:4040</span></span><br><span class="line"><span class="attr">targets:</span></span><br><span class="line"> <span class="bullet">-</span> <span class="attr">application-name:</span> <span class="string">my.dotnet.svc</span></span><br><span class="line">   <span class="attr">spy-name:</span> <span class="string">dotnetspy</span></span><br><span class="line">   <span class="attr">service-name:</span> <span class="string">MyService</span></span><br></pre></td></tr></table></figure><h3 id="pyroscope-adhoc"><a href="#pyroscope-adhoc" class="headerlink" title="pyroscope adhoc"></a>pyroscope adhoc</h3><p>此命令将分析数据保存到文件中，而不是将其发送到服务器。它以两种方式生成这些文件：</p><ul><li>Pyroscope 默认以本机格式和数据目录存储分析数据。然后，这些配置文件可用于使用 pyroscope UI（“Adhoc Profiling”部分）进行分析，这需要一个正在运行的 pyroscope 服务器。可以使用 --no-json-output 禁用此输出。 </li><li>Pyroscope 还以外部格式生成分析数据。根据生成的配置文件的数量，pyroscope 将在运行 pyroscope 的目录中生成文件或目录。当前支持的格式是独立的 HTML（然后可以共享或直接在浏览器中打开进行分析）、pprof 或折叠（最后两种可以共享并与 pyroscope UI 或其他工具一起使用）。标志 --output-format 用于指定此格式。</li></ul><p><code>pyroscope adhoc</code> 对于测试短期程序（脚本、基准等）很有用，它还可以轻松共享分析结果。 </p><p>有多种方法可以收集分析数据（它支持所有代理模式），但并非所有方法都适用于所有语言。使用它的最佳方式取决于几个因素：语言支持什么，分析进程如何启动，以及分析进程如何提供分析数据。</p><p>不同的支持方式是：</p><ul><li>exec: 这是 <code>pyroscope exec</code> 的 adhoc 版本，pyroscope 为分析的程序创建不同的进程，并使用 spy 直接收集分析数据。但它仅适用于<code>spy</code>可用的语言。当提供<code>spy</code>（使用--spy-name）或自动检测到spy时，这是默认设置。 </li><li>connect: 这是 <code>pyroscope connec</code>t 的临时版本。它与 exec 类似，但它监视一个通过 --pid 标志指示的 arlaedy 正在运行的进程。 </li><li>push: Pyroscope 为分析程序创建一个不同的进程，并启动一个带有采集数据端点的 HTTP 服务器。使用其 HTTP API 分析已经与 Pyroscope 集成的程序很有用。当没有检测到spy并且没有提供 --url 标志时，默认使用推送模式。它也可以用 --push 标志覆盖默认的执行模式。</li><li>pull: 这是拉模式的临时版本，pyroscope 会定期连接到指定的 URL，通过 --url 尝试以任何支持的格式检索分析数据。参数是可选的，如果提供，它们用于在轮询 URL 之前启动新进程。</li></ul><h4 id="命令行参数-5"><a href="#命令行参数-5" class="headerlink" title="命令行参数"></a>命令行参数</h4><table><thead><tr><th>Name</th><th>Default Value</th><th>Adhoc type</th><th>Usage</th></tr></thead><tbody><tr><td>analytics-opt-out</td><td>false</td><td>all</td><td>Disables analytics.</td></tr><tr><td>spy-name</td><td>auto</td><td>exec, connect</td><td>Name of the profiler you want to use. Supported ones are: pyspy, rbspy, phpspy, dotnetspy, ebpfspy. Used in <code>exec</code> and <code>connect</code> modes.</td></tr><tr><td>application-name</td><td></td><td>all</td><td>Application name used when saving profiling data.</td></tr><tr><td>sample-rate</td><td>100</td><td>exec, connect</td><td>Sample rate for the profiler in Hz. 100 means reading 100 times per second.</td></tr><tr><td>detect-subprocesses</td><td>true</td><td>exec, connect</td><td>Makes pyroscope keep track of and profile subprocesses of the main process.</td></tr><tr><td>log-level</td><td>info</td><td>all</td><td>Log level: debug|info|warn|error.</td></tr><tr><td>no-logging</td><td>false</td><td>all</td><td>Disables logging from pyroscope.</td></tr><tr><td>pid</td><td>0</td><td>connect</td><td>PID of the process you want to profile. Pass -1 to profile the whole system (only supported by ebpfspy).</td></tr><tr><td>pyspy-blocking</td><td>false</td><td>exec, connect</td><td>Enables blocking mode for pyspy.</td></tr><tr><td>rbspy-blocking</td><td>false</td><td>exec, connect</td><td>Enables blocking mode for rbspy.</td></tr><tr><td>push</td><td>false</td><td>push</td><td>Use push mode, exposing an ingestion endpoint for the profiled program to use.</td></tr><tr><td>url</td><td></td><td>pull</td><td>URL to gather profiling data from.</td></tr><tr><td>output-format</td><td>json</td><td>all</td><td>Format to export profiling data, supported formats are: html, pprof, collapsed, none.</td></tr><tr><td>no-json-output</td><td>false</td><td>all</td><td>disables generating native JSON file(s) in pyroscope data directory.</td></tr><tr><td>data-path</td><td>OS dependent</td><td>all</td><td>Directory where pyroscope stores adhoc profiles.</td></tr><tr><td>max-nodes-render</td><td>8192</td><td>all</td><td>Max number of nodes used to display data on the frontend.</td></tr><tr><td>max-nodes-serialization</td><td>2048</td><td>all</td><td>Max number of nodes used when saving profiles to disk.</td></tr></tbody></table><h4 id="环境变量-5"><a href="#环境变量-5" class="headerlink" title="环境变量"></a>环境变量</h4><p>环境变量必须具有 <code>PYROSCOPE_</code> 前缀并采用 <code>UPPER_SNAKE_CASE</code> 格式，例如：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PYROSCOPE_APPLICATION_NAME=my.awesome.app</span><br></pre></td></tr></table></figure><h4 id="示例-1"><a href="#示例-1" class="headerlink" title="示例"></a>示例</h4><p><a href="https://github.com/pyroscope-io/pyroscope/tree/main/examples/adhoc">adhoc examples</a> </p><h2 id="admin配置"><a href="#admin配置" class="headerlink" title="admin配置"></a>admin配置</h2><h3 id="删除应用"><a href="#删除应用" class="headerlink" title="删除应用"></a>删除应用</h3><p>要删除应用程序</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pyroscope admin app delete <span class="variable">$APP_NAME</span></span></span><br></pre></td></tr></table></figure><p>系统将要求您确认该应用名称：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">Are you sure you want to delete the app <span class="string">&#x27;myapp&#x27;</span>? This action can not be reversed.</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">Type <span class="string">&#x27;myapp&#x27;</span> to confirm (without quotes).</span></span><br><span class="line">myapp</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">Deleted app <span class="string">&#x27;myapp&#x27;</span>.</span></span><br></pre></td></tr></table></figure><p>如果您希望跳过该验证，可以使用 --force 标志：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pyroscope admin app delete myapp --force</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">Deleted app <span class="string">&#x27;myapp&#x27;</span>.</span></span><br></pre></td></tr></table></figure><p>默认情况下，使用 30 分钟的超时。您可以通过传递<code> --timeout</code> 标志来覆盖该行为。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">pyroscope admin app delete myapp --force --<span class="built_in">timeout</span>=10s</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">Deleted app <span class="string">&#x27;myapp&#x27;</span>.</span></span><br></pre></td></tr></table></figure><h3 id="警告"><a href="#警告" class="headerlink" title="警告"></a>警告</h3><p>在执行该操作时，数据库将被锁定以进行写入，这意味着可能会删除大量分析数据，具体取决于命令运行所需的时间（尽管我们尝试最小化它持有锁定的时间）。</p><h2 id="FlameQL"><a href="#FlameQL" class="headerlink" title="FlameQL"></a>FlameQL</h2><p>本文档介绍了 FlameQL，这是一种 Pyroscope 查询语言，使用户能够探索分析数据。</p><h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><h4 id="数据模型"><a href="#数据模型" class="headerlink" title="数据模型"></a>数据模型</h4><p>Pyroscope 存储与应用程序关联的分析数据。一个应用程序可能有多种不同的配置文件类型，例如：cpu、alloc_space、inuse_space 等。通常，分析器报告通过程序采样收集的数据，因此每个样本描述一个程序调用堆栈，以及在一个位置，例如源文件&#x2F;行或函数名。</p><p>每个样本也由元数据描述，允许用户查询和聚合收集的分析数据。在 pyroscope 中，我们使用标签为收集的样本设置任意键值。如果您熟悉 Prometheus，您可能会将其视为标签。标签是数据结构的可选部分；当涉及到查询时，它们变得非常有用。</p><div class="note modern"><p>为确保最佳性能，建议将唯一标签值的数量保持在较低水平。特别是，请考虑避免使用标识符和请求范围的值。</p></div><p>给定一个应用程序名称和一个标签集，使用以下符号标识完全限定名称：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;application_name&gt;[&#123;[&lt;tag_key&gt;=&lt;tag_value&gt;[,&lt;tag_key&gt;=&lt;tag_value&gt;]]&#125;]</span><br></pre></td></tr></table></figure><p>例如，标记为区域 us-west-1 和 env staging 的 my-awesome-app 应用程序实例的 CPU 配置文件的完全限定名称采用以下形式：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">my.awesome.app.cpu&#123;env=staging,region=us-west-1&#125;</span><br></pre></td></tr></table></figure><div class="note modern"><p>摄取数据时，Pyroscope 代理会添加一个名称后缀来指定配置文件类型：<application_name>.<profile_type>。</p></div><p><strong>约束</strong></p><p>标签键可能包含 ASCII 字母、数字和<code> _</code>。应用程序名称可能包含 ASCII 字母、数字、<code>_</code>、<code>-</code> 和 <code>.</code>.</p><p><strong>保留的标签键</strong></p><p>以下密钥保留供内部使用，不应使用：</p><ul><li><code>__name__</code></li></ul><h3 id="查询表达式语言"><a href="#查询表达式语言" class="headerlink" title="查询表达式语言"></a>查询表达式语言</h3><p>FlameQL 中的查询表示如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;application_name&gt;[&#123;[&lt;tag_matcher&gt;[,&lt;tag_matcher&gt;]]&#125;]</span><br></pre></td></tr></table></figure><p>在最简单的形式中，仅指定应用程序名称。例如，考虑最简单的查询：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">my.awesome.app</span><br></pre></td></tr></table></figure><p>这样的查询将返回 <code>my.awesome.app</code> 的所有实例的聚合数据。到目前为止，只有 <code>sum</code> 聚合可用 - 生成的配置文件将是所有找到的配置文件的合并</p><p>可以通过在花括号 (<code>&#123;&#125;)</code> 中附加一个逗号分隔的标签匹配器列表来过滤要聚合的实例——标签匹配器是指定条件以根据相关标签包含或排除维度的表达式。</p><p>支持的操作符：</p><ul><li><code>=</code> 必须完全等于提供的字符串</li><li><code>=~</code> 必须正则表达式匹配提供的字符串</li><li><code>!=</code> 不能等于提供的字符串</li><li><code>!~</code> 不得与提供的字符串进行正则表达式匹配</li></ul><h4 id="示例-2"><a href="#示例-2" class="headerlink" title="示例"></a>示例</h4><p>无论标签如何，所有应用程序实例：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">my.awesome.app.cpu</span><br></pre></td></tr></table></figure><p>无论标签如何，所有应用程序实例：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">my.awesome.app.cpu&#123;&#125;</span><br></pre></td></tr></table></figure><p>带有 env&#x3D;staging 标记的应用程序实例：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">my.awesome.app.cpu&#123;env=&quot;staging&quot;&#125;</span><br></pre></td></tr></table></figure><p>未使用 env&#x3D;staging 标记的应用程序实例：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">my.awesome.app.cpu&#123;env!=&quot;staging&quot;&#125;</span><br></pre></td></tr></table></figure><p>使用 env&#x3D;staging AND region&#x3D;us-west-1 标记的应用程序实例：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">my.awesome.app.cpu&#123;env=&quot;staging&quot;,region=&quot;us-west-1&quot;&#125;</span><br></pre></td></tr></table></figure><p>未使用 env&#x3D;staging 标记且区域标记值等于 us-west-1 或 eu-west-1 的应用程序实例：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">my.awesome.app.cpu&#123;env!=&quot;staging&quot;,region=~&quot;us-west-1|eu-west-1&quot;&#125;</span><br></pre></td></tr></table></figure><p>带有以 us 开头且不包含 west 的标签区域的应用程序实例：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">my.awesome.app.cpu&#123;region=~&quot;us.*&quot;,region!~&quot;.*west.*&quot;&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;script src=&quot;\assets\js\APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;h1 id=&quot;即时性能分析工具Pyroscope&quot;&gt;&lt;a href=&quot;#即时性能分析工具Pyroscope&quot; class=&quot;headerlink&quot; title=&quot;即时性能分析工具</summary>
      
    
    
    
    <category term="golang" scheme="https://wangyyovo.github.io/categories/golang/"/>
    
    
    <category term="debug" scheme="https://wangyyovo.github.io/tags/debug/"/>
    
  </entry>
  
  <entry>
    <title>golang性能调试优化方法</title>
    <link href="https://wangyyovo.github.io/posts/82a7aa7c/"/>
    <id>https://wangyyovo.github.io/posts/82a7aa7c/</id>
    <published>2022-06-12T03:00:36.000Z</published>
    <updated>2022-06-12T03:00:36.000Z</updated>
    
    <content type="html"><![CDATA[<script src="\assets\js\APlayer.min.js"> </script><h1 id="golang性能调试优化方法"><a href="#golang性能调试优化方法" class="headerlink" title="golang性能调试优化方法"></a>golang性能调试优化方法</h1><p>在 golang 程序中，有哪些内容需要调试优化？</p><p>一般常规内容：</p><ul><li>cpu：程序对cpu的使用情况 - 使用时长，占比等</li><li>内存：程序对cpu的使用情况 - 使用时长，占比，内存泄露等。如果在往里分，程序堆、栈使用情况</li><li>I&#x2F;O：IO的使用情况 - 哪个程序IO占用时间比较长</li></ul><p>golang 程序中：</p><ul><li>goroutine：go的协程使用情况，调用链的情况</li><li>goroutine leak：goroutine泄露检查</li><li>go dead lock：死锁的检测分析</li><li>data race detector：数据竞争分析，其实也与死锁分析有关</li></ul><p>golang 性能调试优化方法：</p><ul><li>Benchmark：基准测试，对特定代码的运行时间和内存信息等进行测试</li><li>Profiling：程序分析，程序的运行画像，在程序执行期间，通过采样收集的数据对程序进行分析</li><li>Trace：跟踪，在程序执行期间，通过采集发生的事件数据对程序进行分析</li></ul><p>profiling 和 trace 有啥区别？<br>profiling 分析没有时间线，trace 分析有时间线。</p><h2 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h2><p>pprof 是 golang 官方提供的性能调优分析工具，可以对程序进行性能分析，并可视化数据，看起来相当的直观。</p><p>当你的 go 程序遇到性能瓶颈时，可以使用这个工具来进行调试并优化程序。</p><p>本文将对下面 golang 中 2 个监控性能的包 pprof 进行运用：</p><ul><li>runtime&#x2F;pprof：采集程序运行数据进行性能分析，一般用于后台工具型应用。</li><li>net&#x2F;http&#x2F;pprof：对 runtime&#x2F;pprof 的二次封装，一般应用于 http server ，采集 http server 运行时数据进行分析。</li></ul><p>pprof 开启后，每隔一段时间就会采集当前程序的堆栈信息，获取函数的 cpu、内存等使用情况。通过对采样的数据进行分析，形成一个数据分析报告。</p><p>pprof 以 profile.proto 的格式保存数据，然后根据这个数据生成可视化的分析报告，支持文本形式和图形形式报告。</p><p>profile.proto 里具体的数据格式是 protocol buffers。</p><p>pprof 使用模式</p><ul><li>Report generation：报告生成</li><li>Interactive terminal use：交互式终端</li><li>Web interface：Web 界面</li></ul><p>pprof开启后，每隔一段时间(10ms)就会收集当前的堆栈信息，获取各个函数占用的CPU以及内存资源，然后通过对这些采样数据进行分析，形成一个性能分析报告。</p><p>性能优化主要有一下几个方面：</p><ul><li><p>CPU Profile：报告程序的CPU使用情况，按照一定频率去采集应用程序在CPU和寄存器上面的数据。</p></li><li><p>Memory Profile（Heap Profile）:报告程序的内存使用情况。</p></li><li><p>Block Profiling: 报告goroutines不在运行状态的情况，可以用来分析和查找死锁等性能瓶颈。</p></li><li><p>Goroutine Profiling: 报告goroutines的使用情况，有哪些roroutines，它们的调用关系是怎样的。</p></li></ul><p><strong>注意：我们只应该在性能测试的时候才在代码中引入pprof</strong></p><h2 id="生成profile方法"><a href="#生成profile方法" class="headerlink" title="生成profile方法"></a>生成profile方法</h2><p>golang目前提供了3中profile，分别是 cpu profile, memery profile, blocking profile, 对于如何生成这些profile有两种办法，<br>一种是使用<code>net/http/pprof</code>包，一种是需要自己手写代码。</p><h3 id="net-http-pprof"><a href="#net-http-pprof" class="headerlink" title="net&#x2F;http&#x2F;pprof"></a>net&#x2F;http&#x2F;pprof</h3><p>这种方法是非常非常简单的，只需要引入 net&#x2F;http&#x2F;pprof 包就可以了，网页上可以查看<br>其实net&#x2F;http&#x2F;pprof中只是使用runtime&#x2F;pprof包来进行封装了一下，并在http端口上暴露出来。</p><h4 id="默认Mux"><a href="#默认Mux" class="headerlink" title="默认Mux"></a>默认Mux</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;log&quot;</span></span><br><span class="line">    <span class="string">&quot;net/http&quot;</span></span><br><span class="line">    _ <span class="string">&quot;net/http/pprof&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">for</span> &#123;</span><br><span class="line">            fmt.Println(<span class="string">&quot;hello world&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line">    log.Fatal(http.ListenAndServe(<span class="string">&quot;0.0.0.0:8080&quot;</span>, <span class="literal">nil</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="自定义Mux"><a href="#自定义Mux" class="headerlink" title="自定义Mux"></a>自定义Mux</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line"><span class="string">&quot;net/http/pprof&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">r := gin.Default()</span><br><span class="line"></span><br><span class="line"><span class="comment">// &quot;github.com/gin-contrib/pprof&quot; </span></span><br><span class="line"><span class="comment">// pprof.Register(r)</span></span><br><span class="line"></span><br><span class="line">prefixRouter := r.Group(<span class="string">&quot;/debug/pprof&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">prefixRouter.GET(<span class="string">&quot;/&quot;</span>, gin.WrapF(pprof.Index))</span><br><span class="line">prefixRouter.GET(<span class="string">&quot;/cmdline&quot;</span>, gin.WrapF(pprof.Cmdline))</span><br><span class="line">prefixRouter.GET(<span class="string">&quot;/profile&quot;</span>, gin.WrapF(pprof.Profile))</span><br><span class="line">prefixRouter.POST(<span class="string">&quot;/symbol&quot;</span>, gin.WrapF(pprof.Symbol))</span><br><span class="line">prefixRouter.GET(<span class="string">&quot;/symbol&quot;</span>, gin.WrapF(pprof.Symbol))</span><br><span class="line">prefixRouter.GET(<span class="string">&quot;/trace&quot;</span>, gin.WrapF(pprof.Trace))</span><br><span class="line">prefixRouter.GET(<span class="string">&quot;/allocs&quot;</span>, gin.WrapH(pprof.Handler(<span class="string">&quot;allocs&quot;</span>)))</span><br><span class="line">prefixRouter.GET(<span class="string">&quot;/block&quot;</span>, gin.WrapH(pprof.Handler(<span class="string">&quot;block&quot;</span>)))</span><br><span class="line">prefixRouter.GET(<span class="string">&quot;/goroutine&quot;</span>, gin.WrapH(pprof.Handler(<span class="string">&quot;goroutine&quot;</span>)))</span><br><span class="line">prefixRouter.GET(<span class="string">&quot;/heap&quot;</span>, gin.WrapH(pprof.Handler(<span class="string">&quot;heap&quot;</span>)))</span><br><span class="line">prefixRouter.GET(<span class="string">&quot;/mutex&quot;</span>, gin.WrapH(pprof.Handler(<span class="string">&quot;mutex&quot;</span>)))</span><br><span class="line">prefixRouter.GET(<span class="string">&quot;/threadcreate&quot;</span>, gin.WrapH(pprof.Handler(<span class="string">&quot;threadcreate&quot;</span>)))</span><br><span class="line">&#125;</span><br><span class="line">r.Run(<span class="string">&quot;:8080&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="使用go-tool-pprof采集数据"><a href="#使用go-tool-pprof采集数据" class="headerlink" title="使用go tool pprof采集数据"></a>使用go tool pprof采集数据</h4><p>查看</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1:8080/debug/pprof 查看整体信息</span><br><span class="line">http://127.0.0.1:8080/debug/pprof/profile 可以将cpu profile下载下来观察分析</span><br></pre></td></tr></table></figure><p>查看信息内容</p><ul><li>allocs: 内存分配情况的采样信息</li><li>blocks: 阻塞操作情况的采样信息</li><li>cmdline: 显示程序启动命令参数及其参数</li><li>goroutine: 显示当前所有协程的堆栈信息</li><li>heap: 堆上的内存分配情况的采样信息</li><li>mutex: 锁竞争情况的采样信息</li><li>profile: cpu占用情况的采样信息，点击会下载文件</li><li>threadcreate: 系统线程创建情况的采样信息</li><li>trace: 程序运行跟踪信息</li></ul><p>采集</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">go tool pprof http://127.0.0.1:8080/debug/pprof/profile # (pprof) traces</span><br><span class="line">go tool pprof http://127.0.0.1:8080/debug/pprof/mutex # (pprof) traces Unlock</span><br><span class="line">go tool pprof http://127.0.0.1:8080/debug/pprof/heap</span><br><span class="line">go tool pprof http://127.0.0.1:8080/debug/pprof/block # (pprof) traces runtime.chanrecv1 找到协程使用list查看</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">以下命令的意思是采集协程数据并持续20S</span></span><br><span class="line">go tool pprof --seconds 20 http://127.0.0.1:8080/debug/pprof/goroutine</span><br><span class="line">go tool pprof http://127.0.0.1:8080/debug/pprof/goroutine?second=20</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">inuse_space表示查看常驻内存的使用情况（list 查看相应的函数）</span></span><br><span class="line">go tool pprof -inuse_space http://127.0.0.1:8080/debug/pprof/heap</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">alloc_objects分析应用程序的内存临时分配情况（list 查看相应的函数）</span></span><br><span class="line">go tool pprof -alloc_objects http://127.0.0.1:8080/debug/pprof/heap</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="runtime-pprof"><a href="#runtime-pprof" class="headerlink" title="runtime&#x2F;pprof"></a>runtime&#x2F;pprof</h3><p>自定编码实现profile的采集</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;bytes&quot;</span></span><br><span class="line"><span class="string">&quot;flag&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;math/rand&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line"><span class="string">&quot;runtime&quot;</span></span><br><span class="line"><span class="string">&quot;runtime/pprof&quot;</span></span><br><span class="line"><span class="string">&quot;sync&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> cpuprofile = flag.String(<span class="string">&quot;cpuprofile&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;write cpu profile to `file`&quot;</span>)</span><br><span class="line"><span class="keyword">var</span> memprofile = flag.String(<span class="string">&quot;memprofile&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;write mem profile to `file`&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">flag.Parse()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> *cpuprofile != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">f, err := os.Create(*cpuprofile)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(<span class="string">&quot;could not create CPU profile: &quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> f.Close() <span class="comment">// error handling omitted for example</span></span><br><span class="line"><span class="keyword">if</span> err := pprof.StartCPUProfile(f); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(<span class="string">&quot;could not start CPU profile: &quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> pprof.StopCPUProfile()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ... rest of the program ...</span></span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">wg.Add(<span class="number">200</span>)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">200</span>; i++ &#123;</span><br><span class="line"><span class="keyword">go</span> cyclenum(<span class="number">30000</span>, &amp;wg)</span><br><span class="line">&#125;</span><br><span class="line">writeBytes()</span><br><span class="line">wg.Wait()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> *memprofile != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">f, err := os.Create(*memprofile)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(<span class="string">&quot;could not create memory profile: &quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> f.Close() <span class="comment">// error handling omitted for example</span></span><br><span class="line">runtime.GC()    <span class="comment">// get up-to-date statistics</span></span><br><span class="line"><span class="keyword">if</span> err := pprof.WriteHeapProfile(f); err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(<span class="string">&quot;could not write memory profile: &quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">cyclenum</span><span class="params">(num <span class="type">int</span>, wg *sync.WaitGroup)</span></span> &#123;</span><br><span class="line">slice := <span class="built_in">make</span>([]<span class="type">int</span>, <span class="number">0</span>)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; num; i++ &#123;</span><br><span class="line"><span class="keyword">for</span> j := <span class="number">0</span>; j &lt; num; j++ &#123;</span><br><span class="line">j = i + j</span><br><span class="line">slice = <span class="built_in">append</span>(slice, j)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">wg.Done()</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">writeBytes</span><span class="params">()</span></span> *bytes.Buffer &#123;</span><br><span class="line"><span class="keyword">var</span> buff bytes.Buffer</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">30000</span>; i++ &#123;</span><br><span class="line">buff.Write([]<span class="type">byte</span>&#123;<span class="string">&#x27;0&#x27;</span> + <span class="type">byte</span>(rand.Intn(<span class="number">10</span>))&#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> &amp;buff</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">go build test.go</span><br><span class="line">./test.exe --cpuprofile=cpu.pprof  --memprofile=mem.pprof</span><br><span class="line"></span><br><span class="line">go tool pprof cpu.pprof</span><br></pre></td></tr></table></figure><p>程序退出时会生成两个profile，一个是cpu.pprof的，一个是mem.pprof。</p><p>go tool pprof 简单的使用格式为：<br>go tool pprof [binary] [source]</p><ul><li>binary： 是应用的二进制文件，用来解析各种符号</li><li>source： 表示 profile 数据的来源，可以是本地的文件，也可以是 http 地址</li></ul><h3 id="go-test"><a href="#go-test" class="headerlink" title="go test"></a>go test</h3><p>编写一个test程序,可以更加精准地进行测试</p><ul><li>-bench&#x3D;. 进行性能测试，&quot;.&quot;是正则匹配，匹配了所有的测试函数</li><li>-benchmem 打印出申请内存的次数。一般用于简单的性能测试，不会导出数据文件。</li><li>-blockprofile block.out 将协程的阻塞数据写入特定的文件（block.out）。如果-c，则写成二进制文件。</li><li>-cpuprofile cpu.out 将协程的CPU使用数据写入特定的文件（cpu.out）。如果-c，则写成二进制文件。</li><li>-memprofile mem.out 将协程的内存申请数据写入特定的文件（mem.out）。如果-c，则写成二进制文件。</li><li>-mutexprofile mutex.out 将协程的互斥数据写入特定的文件（mutex.out）。如果-c，则写成二进制文件。</li><li>-trace trace.out 将执行调用链写入特定文件（trace.out）。</li></ul><p>可以看到，go test会把数据导出在特定的文件之中。之后分析数据就需要读取这些数据。这些数据本身的可读性很差，还是需要借助go tool pprof来分析。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-run=none 只进行基准测试</span></span><br><span class="line">go test -v -run=none -bench=. -blockprofile block.out -cpuprofile cpu.out -memprofile mem.out -mutexprofile mutex.out -trace trace.out</span><br></pre></td></tr></table></figure><p>分析</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">go tool pprof block.out</span><br><span class="line">go tool pprof cpu.out</span><br><span class="line">go tool pprof mem.out</span><br><span class="line">go tool pprof mutex</span><br><span class="line"></span><br><span class="line">go tool trace trace.out</span><br></pre></td></tr></table></figure><h2 id="分析数据"><a href="#分析数据" class="headerlink" title="分析数据"></a>分析数据</h2><h3 id="命令行交互分析"><a href="#命令行交互分析" class="headerlink" title="命令行交互分析"></a>命令行交互分析</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">go tool pprof cpu.pprof</span><br><span class="line">go tool pprof test.exe cpu.pprof</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">go tool pprof cpu.pprof</span></span><br><span class="line">Type: cpu</span><br><span class="line">Time: Jun 11, 2022 at 8:07pm (CST)</span><br><span class="line">Duration: 515.79ms, Total samples = 1.47s (285.00%)</span><br><span class="line">Entering interactive mode (type &quot;help&quot; for commands, &quot;o&quot; for options)</span><br><span class="line">(pprof)</span><br></pre></td></tr></table></figure><p>Type: 分析类型，这里是 cpu</p><p>Duration: 程序执行的时长</p><p>Duration 下面还有一行提示，这是交互模式（通过输入 help 获取帮助信息，输入 o 获取选项信息）。</p><h4 id="pprof命令"><a href="#pprof命令" class="headerlink" title="pprof命令"></a>pprof命令</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">(pprof) help</span><br><span class="line">  Commands:</span><br><span class="line">    callgrind        Outputs a graph in callgrind format</span><br><span class="line">    comments         Output all profile comments</span><br><span class="line">    disasm           Output assembly listings annotated with samples</span><br><span class="line">    dot              Outputs a graph in DOT format</span><br><span class="line">    eog              Visualize graph through eog</span><br><span class="line">    evince           Visualize graph through evince</span><br><span class="line">    gif              Outputs a graph image in GIF format</span><br><span class="line">    gv               Visualize graph through gv</span><br><span class="line">    kcachegrind      Visualize report in KCachegrind</span><br><span class="line">    list             Output annotated source for functions matching regexp</span><br><span class="line">    pdf              Outputs a graph in PDF format</span><br><span class="line">    peek             Output callers/callees of functions matching regexp</span><br><span class="line">    png              Outputs a graph image in PNG format</span><br><span class="line">    proto            Outputs the profile in compressed protobuf format</span><br><span class="line">    ps               Outputs a graph in PS format</span><br><span class="line">    raw              Outputs a text representation of the raw profile</span><br><span class="line">    svg              Outputs a graph in SVG format</span><br><span class="line">    tags             Outputs all tags in the profile</span><br><span class="line">    text             Outputs top entries in text form</span><br><span class="line">    top              Outputs top entries in text form</span><br><span class="line">    topproto         Outputs top entries in compressed protobuf format</span><br><span class="line">    traces           Outputs all profile samples in text form</span><br><span class="line">    tree             Outputs a text rendering of call graph</span><br><span class="line">    web              Visualize graph through web browser</span><br><span class="line">    weblist          Display annotated source in a web browser</span><br><span class="line">    o/options        List options and their current values</span><br><span class="line">    q/quit/exit/^D   Exit pprof</span><br><span class="line"></span><br><span class="line">  Options:</span><br><span class="line">    call_tree        Create a context-sensitive call tree</span><br><span class="line">    compact_labels   Show minimal headers</span><br><span class="line">    divide_by        Ratio to divide all samples before visualization</span><br><span class="line">    drop_negative    Ignore negative differences</span><br><span class="line">    edgefraction     Hide edges below &lt;f&gt;*total</span><br><span class="line">    focus            Restricts to samples going through a node matching regexp</span><br><span class="line">    hide             Skips nodes matching regexp</span><br><span class="line">    ignore           Skips paths going through any nodes matching regexp</span><br><span class="line">    intel_syntax     Show assembly in Intel syntax</span><br><span class="line">    mean             Average sample value over first value (count)</span><br><span class="line">    nodecount        Max number of nodes to show</span><br><span class="line">    nodefraction     Hide nodes below &lt;f&gt;*total</span><br><span class="line">    noinlines        Ignore inlines.</span><br><span class="line">    normalize        Scales profile based on the base profile.</span><br><span class="line">      files            Aggregate at the file level.</span><br><span class="line">      lines            Aggregate at the source code line level.</span><br><span class="line">      addresses        Aggregate at the address level.</span><br><span class="line">    sort</span><br><span class="line">      cum              Sort entries based on cumulative weight</span><br><span class="line">      flat             Sort entries based on own weight</span><br><span class="line">  :   Clear focus/ignore/hide/tagfocus/tagignore</span><br><span class="line"></span><br><span class="line">  type &quot;help &lt;cmd|option&gt;&quot; for more information</span><br></pre></td></tr></table></figure><h4 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h4><h5 id="top"><a href="#top" class="headerlink" title="top"></a>top</h5><p>top 默认查看程序中占用cpu前10位的函数。<br>top 3 可以查看程序中占用CPU前三位的函数。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">(pprof) top</span><br><span class="line">Showing nodes accounting for 1.41s, 95.92% of 1.47s total</span><br><span class="line">Showing top 10 nodes out of 70</span><br><span class="line">      flat  flat%   sum%        cum   cum%</span><br><span class="line">     0.82s 55.78% 55.78%      0.82s 55.78%  runtime.memmove</span><br><span class="line">     0.18s 12.24% 68.03%      0.18s 12.24%  runtime.memclrNoHeapPointers</span><br><span class="line">     0.13s  8.84% 76.87%      1.21s 82.31%  main.cyclenum</span><br><span class="line">     0.12s  8.16% 85.03%      0.12s  8.16%  runtime.stdcall2</span><br><span class="line">     0.07s  4.76% 89.80%      0.07s  4.76%  runtime._ExternalCode</span><br><span class="line">     0.03s  2.04% 91.84%      0.03s  2.04%  runtime.procyield</span><br><span class="line">     0.02s  1.36% 93.20%      0.02s  1.36%  runtime.asyncPreempt</span><br><span class="line">     0.02s  1.36% 94.56%      0.03s  2.04%  runtime.gentraceback</span><br><span class="line">     0.01s  0.68% 95.24%      0.01s  0.68%  runtime.(*pageAlloc).find</span><br><span class="line">     0.01s  0.68% 95.92%      0.01s  0.68%  runtime.casgstatus</span><br><span class="line">(pprof) top 3</span><br><span class="line">Showing nodes accounting for 1.46s, 99.32% of 1.47s total</span><br><span class="line">Showing top 15 nodes out of 70</span><br><span class="line">      flat  flat%   sum%        cum   cum%</span><br><span class="line">     0.82s 55.78% 55.78%      0.82s 55.78%  runtime.memmove</span><br><span class="line">     0.18s 12.24% 68.03%      0.18s 12.24%  runtime.memclrNoHeapPointers</span><br><span class="line">     0.13s  8.84% 76.87%      1.21s 82.31%  main.cyclenum</span><br></pre></td></tr></table></figure><p>最后一列为函数名称，其他各项内容意义如下：</p><ul><li>flat:当前函数占用CPU的耗时</li><li>flat%:当前函数占用CPU的耗时百分比</li><li>sum%:函数占用CPU的累积耗时百分比</li><li>cum：当前函数+调用当前函数的占用CPU总耗时</li><li>cum%: 当前函数+调用当前函数的占用CPU总耗时百分比</li></ul><p>从字段数据我们可以看出哪一个函数比较耗费时间，就可以对这个函数进一步分析</p><h5 id="list"><a href="#list" class="headerlink" title="list"></a>list</h5><p>我们还可以使用<code>list &lt;函数名&gt;</code>命令查看具体的函数分析<br>从上面采样数据可以分析出总耗时最长的函数是<code>main.cycylenum</code>,用<code>list cyclenum</code>命令进行分析</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">(pprof) list cyclenum</span><br><span class="line">Total: 1.47s</span><br><span class="line">ROUTINE ======================== main.cyclenum in E:\project\goproject\test\test.go</span><br><span class="line">     130ms      1.21s (flat, cum) 82.31% of Total</span><br><span class="line">         .          .     51:   &#125;</span><br><span class="line">         .          .     52:&#125;</span><br><span class="line">         .          .     53:func cyclenum(num int, wg *sync.WaitGroup) &#123;</span><br><span class="line">         .          .     54:   slice := make([]int, 0)</span><br><span class="line">         .          .     55:   for i := 0; i &lt; num; i++ &#123;</span><br><span class="line">      70ms       80ms     56:           for j := 0; j &lt; num; j++ &#123;</span><br><span class="line">      30ms       30ms     57:                   j = i + j</span><br><span class="line">      30ms      1.10s     58:                   slice = append(slice, j)</span><br><span class="line">         .          .     59:           &#125;</span><br><span class="line">         .          .     60:   &#125;</span><br><span class="line">         .          .     61:   wg.Done()</span><br><span class="line">         .          .     62:&#125;</span><br><span class="line">         .          .     63:func writeBytes() *bytes.Buffer &#123;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="text"><a href="#text" class="headerlink" title="text"></a>text</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">(pprof) text</span><br><span class="line">Showing nodes accounting for 1.41s, 95.92% of 1.47s total</span><br><span class="line">Showing top 10 nodes out of 70</span><br><span class="line">      flat  flat%   sum%        cum   cum%</span><br><span class="line">     0.82s 55.78% 55.78%      0.82s 55.78%  runtime.memmove</span><br><span class="line">     0.18s 12.24% 68.03%      0.18s 12.24%  runtime.memclrNoHeapPointers</span><br><span class="line">     0.13s  8.84% 76.87%      1.21s 82.31%  main.cyclenum</span><br><span class="line">     0.12s  8.16% 85.03%      0.12s  8.16%  runtime.stdcall2</span><br><span class="line">     0.07s  4.76% 89.80%      0.07s  4.76%  runtime._ExternalCode</span><br><span class="line">     0.03s  2.04% 91.84%      0.03s  2.04%  runtime.procyield</span><br><span class="line">     0.02s  1.36% 93.20%      0.02s  1.36%  runtime.asyncPreempt</span><br><span class="line">     0.02s  1.36% 94.56%      0.03s  2.04%  runtime.gentraceback</span><br><span class="line">     0.01s  0.68% 95.24%      0.01s  0.68%  runtime.(*pageAlloc).find</span><br><span class="line">     0.01s  0.68% 95.92%      0.01s  0.68%  runtime.casgstatus</span><br><span class="line">     </span><br></pre></td></tr></table></figure><h5 id="pdf"><a href="#pdf" class="headerlink" title="pdf"></a>pdf</h5><p><code>pdf</code>命令可以生成可视化的pdf文件。</p><h5 id="help"><a href="#help" class="headerlink" title="help"></a>help</h5><p><code>help</code>命令可以提供所有pprof支持的命令说明。</p><h3 id="图形可视化分析"><a href="#图形可视化分析" class="headerlink" title="图形可视化分析"></a>图形可视化分析</h3><p>安装Graphviz:</p><p>macos: brew install graphviz</p><p>ubuntu: apt-get install graphviz</p><p>centos: yum install graphviz</p><p>windows: <a href="https://graphviz.org/download/">https://graphviz.org/download/</a></p><p><code>dot -version</code>命令查看是否安装成功</p><h4 id="web命令生成svg"><a href="#web命令生成svg" class="headerlink" title="web命令生成svg"></a>web命令生成svg</h4><p>在命令行里输入 web 命令，就可以生成一个 svg 格式的文件，用浏览器打开即可查看 svg 文件。</p><p>每个框代表一个函数，理论上框越大表示占用的 cpu 资源越多</p><p>每个框之间的线条代表函数之间的调用关系，线条上的数字表示函数调用的次数</p><p>每个框中第一行数字表示当前函数占用 cpu 的百分比，第二行数字表示当前函数累计占用 cpu 的百分比</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">go tool pprof cpu.pprof</span> </span><br><span class="line">Type: cpu</span><br><span class="line">Time: Jun 11, 2022 at 8:07pm (CST)</span><br><span class="line">Duration: 515.79ms, Total samples = 1.47s (285.00%)</span><br><span class="line">Entering interactive mode (type &quot;help&quot; for commands, &quot;o&quot; for options)</span><br><span class="line">(pprof) web</span><br></pre></td></tr></table></figure><h4 id="生成pdf"><a href="#生成pdf" class="headerlink" title="生成pdf"></a>生成pdf</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">go tool pprof cpu.pprof</span> </span><br><span class="line">Type: cpu</span><br><span class="line">Time: Jun 11, 2022 at 8:07pm (CST)</span><br><span class="line">Duration: 515.79ms, Total samples = 1.47s (285.00%)</span><br><span class="line">Entering interactive mode (type &quot;help&quot; for commands, &quot;o&quot; for options)</span><br><span class="line">(pprof) pdf</span><br></pre></td></tr></table></figure><h4 id="go-torch生成火焰图"><a href="#go-torch生成火焰图" class="headerlink" title="go-torch生成火焰图"></a>go-torch生成火焰图</h4><p>用 pprof 生成的采样数据，要把它转换成火焰图，就要使用一个转换工具 go-torch，这个工具是 uber 开源，它是用 go 语言编写的，<br>可以直接读取 pprof 采集的数据，并生成一张火焰图， svg 格式的文件。</p><p>生成火焰图的程序 FlameGraph 是用 perl 写的，所以先要安装执行 perl 语言的环境。<br>在终端下执行命令：perl -h ，输出了帮助信息，则说明安装成功</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">go install github.com/uber/go-torch@latest</span><br><span class="line">git clone https://github.com/brendangregg/FlameGraph.git</span><br></pre></td></tr></table></figure><p>把FlameGraph中的文件加入Path中<br>go-torch -b cpu.pprof<br>go-torch -b cpu.pprof -f cpu_flamegraph.svg<br>火焰图 svg 文件，你可以点击上面的每个方块来查看分析它上面的内容。</p><p>火焰图的调用顺序从下到上，每个方块代表一个函数，它上面一层表示这个函数会调用哪些函数，<br>方块的大小代表了占用 CPU 使用时长长短。</p><h4 id="go-tool可视化分析"><a href="#go-tool可视化分析" class="headerlink" title="go tool可视化分析"></a>go tool可视化分析</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go tool pprof -http=:8080 cpu.pprof</span><br></pre></td></tr></table></figure><h5 id="Graph"><a href="#Graph" class="headerlink" title="Graph"></a>Graph</h5><p>节点的颜色越红，其cum和cum%越大。其颜色越灰白，则cum和cum%越小。</p><p>节点越大，其flat和flat%越大；其越小，则flat和flat%越小</p><p>线条代表了函数的调用链，线条越粗，代表指向的函数消耗了越多的资源。反之亦然。</p><p>线条的样式代表了调用关系。实线代表直接调用；虚线代表中间少了几个节点；带有inline字段表示该函数被内联进了调用方（不用在意，可以理解成实线）。</p><h5 id="Flame-Graph"><a href="#Flame-Graph" class="headerlink" title="Flame Graph"></a>Flame Graph</h5><p>火焰图每个方块代表一个函数，它下面一层表示这个函数会调用哪些函数，方块的大小代表了占用 CPU 使用的长短。<br>火焰图的配色并没有特殊的意义，默认的红、黄配色是为了更像火焰而已。</p><h2 id="测试覆盖率"><a href="#测试覆盖率" class="headerlink" title="测试覆盖率"></a>测试覆盖率</h2><p>语句的覆盖率是指在测试中至少被运行一次的代码占总代码数的比例。<br>go test -run&#x3D;Converage 标志参数通过在测试代码中插入生成钩子来统计覆盖率数据。在运行每个测试前，它将待测代码拷贝一份并做修改，在每个词法块都会设置一个布尔标志变量。当被修改后的被测试代码运行退出时，将统计日志数据写入c.out文件，并打印一部分执行的语句的一个总结。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">用-coverprofile标志参数，生成覆盖率文件c.out</span></span><br><span class="line">go test -run=Coverage -coverprofile=cover.out</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">测试覆盖率工具，打印了测试日志，生成一个HTML报告</span></span><br><span class="line">go tool cover -html=cover.out</span><br></pre></td></tr></table></figure><h1 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h1><p>获取的 Profiling 数据是动态的， 要想获得有效的数据，请保证应用处于较大的负载（比如正在生成中运行的服务，或者通过其他工具模拟访问压力）。<br>否则如果应用处于空闲状态，得到的结果可能没有任何意义。</p><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://go.dev/blog/pprof">https://go.dev/blog/pprof</a><br><a href="https://blog.csdn.net/winter_wu_1998/article/details/104579701">https://blog.csdn.net/winter_wu_1998/article/details/104579701</a><br><a href="https://segmentfault.com/a/1190000041261187">https://segmentfault.com/a/1190000041261187</a><br><a href="https://juejin.cn/post/6860844230273662984">https://juejin.cn/post/6860844230273662984</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;script src=&quot;\assets\js\APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;h1 id=&quot;golang性能调试优化方法&quot;&gt;&lt;a href=&quot;#golang性能调试优化方法&quot; class=&quot;headerlink&quot; title=&quot;golang性能调试优化方法</summary>
      
    
    
    
    <category term="golang" scheme="https://wangyyovo.github.io/categories/golang/"/>
    
    
  </entry>
  
  <entry>
    <title>流量回放GoReplay</title>
    <link href="https://wangyyovo.github.io/posts/476d5e4c/"/>
    <id>https://wangyyovo.github.io/posts/476d5e4c/</id>
    <published>2022-06-12T02:55:36.000Z</published>
    <updated>2022-06-12T02:55:36.000Z</updated>
    
    <content type="html"><![CDATA[<script src="\assets\js\APlayer.min.js"> </script><h1 id="流量回放GoReplay"><a href="#流量回放GoReplay" class="headerlink" title="流量回放GoReplay"></a>流量回放GoReplay</h1><h2 id="一-线上引流产生背景"><a href="#一-线上引流产生背景" class="headerlink" title="一. 线上引流产生背景"></a>一. 线上引流产生背景</h2><p>日常大部分的测试工作都是在测试环境下，通过模拟用户的行为来对系统进行验证，包括功能以及性能。在这个过程中，你可能会遇到以下问题:</p><ul><li>用户访问行为比较复杂，模拟很难和用户行为一致，模拟不够真实。</li><li>线下模拟场景有限，会出现业务覆盖不全的情况。</li></ul><p>线上引流方案的出现为上述问题提供了很好的解题思路，<strong>线上引流本质是</strong>：通过把线上的真实流量复制到线下环境，解决测试环境模拟不够真实，或覆盖不够全面的问题。</p><h2 id="二-线上引流常见方案"><a href="#二-线上引流常见方案" class="headerlink" title="二. 线上引流常见方案"></a>二. 线上引流常见方案</h2><p>目前不少公司都对线上引流方案进行了许多实践探索，常见的有以下4种引流方式（不限）：</p><table><thead><tr><th>引流方式</th><th>实现方式</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td><strong>Nginx层流量复制</strong></td><td>安装lua-nginx-module、ngxdevelkit、headers-more-nginx-module模块，通过lua脚本实现把请求复制给测试环境。</td><td>安装和部署还较为简单。</td><td>需要开发lua脚本，且对资源有一定占用。</td></tr><tr><td><strong>基于业务代码层的引流</strong></td><td>将业务代码的调用封装成请求对象，异步的写入缓存中。引流工具通过读缓存中的请求，向测试环境发起请求。</td><td>扩展性好，可定制化高。</td><td>需要开发流量复制工具，工作量较大，且对工作本身的性能要求较高。</td></tr><tr><td><strong>基于访问日志回放</strong></td><td>线上系统记录访问日志，引流工具通过解析日志，向测试环境发起请求。</td><td>离线方式，对线上影响小。</td><td>需要开发日志解析工具，且解析的开销会较大。</td></tr><tr><td><strong>基于TCP&#x2F;IP层的引流</strong></td><td>目前已开源的工具有TcpCopy</td><td>安装、部署使用都较为简单。</td><td>安装、部署使用都较为简单。</td></tr></tbody></table><p>上述的几种引流方式各有利弊，有的是需要自己开发相应的工具来支持。而今天给大家</p><p>介绍的是另外一款简单易用，学习成本低的引流工具<strong>GoReplay</strong>。</p><h2 id="三-推荐一款引流工具：GoReplay"><a href="#三-推荐一款引流工具：GoReplay" class="headerlink" title="三. 推荐一款引流工具：GoReplay"></a>三. 推荐一款引流工具：<strong>GoReplay</strong></h2><p>Gor，又称为GoReplay，是采用Golang 编写的一个开源的 HTTP 实时流量复制工具。它只需要在 LB 或者 入口服务器上执行一个进程，就可以把生产环境的流量复制到任何地方，比如 Staging 环境、Dev 环境。常用于压测及线上问题复现。</p><blockquote><p>注：Golang 是采用Gor 实现且开源的，意味着可以方便的集成到自己的架构中，可以用在压力测试平台、实时流量分析、应用层防火墙等方面。</p></blockquote><h2 id="四-GoReplay工作流程"><a href="#四-GoReplay工作流程" class="headerlink" title="四. GoReplay工作流程"></a>四. <strong>GoReplay</strong>工作流程</h2><p>下面是goreplay官方之前公布的工作流程图，简单来讲就是goreplay捕捉线上流量，并将捕捉到的释放到指定测试服务器上。</p><p><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/blog/golang/e0cf5354d1514ae1bdf94edc5450352b.png"></p><p>最新GoReplay 官网上更新了一张更高逼规格的图解说明，如下图所示：</p><p><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/blog/golang/55cf6c06fd88445eb9027470dd9354aa.png"></p><p>上述流程图展示的已经很详细了，我就不过多解释。</p><blockquote><p>注：Gor不是代理人，不需要将第三方工具放到关键路径上。相反，Gor只是默默地分析你的应用程序的流量，并不影响本身程序。</p></blockquote><h2 id="五-GoReplay支持的常用功能"><a href="#五-GoReplay支持的常用功能" class="headerlink" title="五. GoReplay支持的常用功能"></a>五. <strong>GoReplay</strong>支持的常用功能</h2><ul><li>1､Gor 支持流量的放大和缩小、频率限制，这样不需要搭建和生产环境一致的服务器集群也可以正确测试。</li><li>2､Gor 还支持根据正则表达式过滤流量，这意味着可以单独测试某个 API 服务。</li><li>3､Gor还可以修改 HTTP 请求头，比如替换 User-Agent, 或者增加某些 HTTP Header 。</li><li>4､Gor 还可以把请求记录到文件，以备回放和分析。Gor 支持和 ElasticSearch 集成，将流量存入 ES 进行实时分析。</li><li>5､上线前在预发布环境，使用线上真实的请求，检查是否准备发布的版本，是否具备发布标准。</li><li>6､压力测试完成后，用线上真实的请求，加速后回放至测试环境，检查是否有报错等问题。</li><li>7､用线上的流量转发到预发布或测试环境，检查相同流量下一些指标的反馈情况，检查核心数据是否需要改善。</li><li>8、等等。</li></ul><h2 id="六-下载安装GoReplay"><a href="#六-下载安装GoReplay" class="headerlink" title="六. 下载安装GoReplay"></a>六. 下载安装<strong>GoReplay</strong></h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">下载包</span></span><br><span class="line">wget https://github.com/buger/goreplay/releases/download/1.3.3/gor-1.3.3_windows.zip</span><br></pre></td></tr></table></figure><p>也可以进入到官网下载地址：<code>https://github.com/buger/goreplay/releases</code>下载最新的Gor二进制文件（支持Windows，Linux x64和Mac OS提供预编译的二进制文件），或者可以自行编译。</p><p><strong>获取gor版本：</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/buger/goreplay/releases</span><br></pre></td></tr></table></figure><p><strong>源码地址：</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/buger/goreplay</span><br></pre></td></tr></table></figure><p><strong>官方使用文档：</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/buger/goreplay/wiki</span><br></pre></td></tr></table></figure><h2 id="七-GoReplay-常用命令用法"><a href="#七-GoReplay-常用命令用法" class="headerlink" title="七. GoReplay 常用命令用法"></a>七. <strong>GoReplay</strong> 常用命令用法</h2><p><strong>输入参数：</strong></p><ul><li><code>--input-raw</code>  用于捕获HTTP流量，需要指定IP地址或接口和应用程序端口。</li><li><code>--input-file</code>  接收通过<code>--output-file</code>保存流量的文件</li><li><code>--input-tcp</code>  将多个 Goreplay 实例获取的流量聚集到一个 Goreplay 实例。</li></ul><p><strong>输出参数：</strong></p><ul><li><code>--output-http</code>  重放HTTP流量到给定的端点，接受基础URL。</li><li><code>--output-file</code>  录制流量时指定的存储文件</li><li><code>--output-tcp</code> 将获取的流量转移至另外的 Goreplay 实例，并与其一起使用<code>--input-tcp</code>。</li><li><code>--output-stdout</code>  用于调试，输出所有数据到stdout。</li></ul><p><strong>其它参数：</strong></p><ul><li><p><code>--input-file-loop</code> 无限循环，而不是读完这个文件就停止了</p></li><li><p><code>--output-http-workers</code> 并发请求数</p></li><li><p><code>--http-allow-header</code> 允许的Header头</p></li><li><p><code>--http-disallow-header</code> 不允许的Header头</p></li></ul><ul><li><code>--http-allow-method</code> 允许的请求方法，传入值为GET，POST，OPTIONS等</li><li><code>--http-allow-url</code> url白名单，其他请求将会被丢弃</li><li><code>--http-disallow-url</code> 黑名单，其他的请求会被捕获到</li><li><code>--split-output true</code> 按照轮训方式分割流量</li></ul><h2 id="八-GoReplay-常用实践场景"><a href="#八-GoReplay-常用实践场景" class="headerlink" title="八. GoReplay 常用实践场景"></a>八. <strong>GoReplay</strong> 常用实践场景</h2><p><strong>1、流量实时复制引流（--input-raw 拦截端口配合--output-http输出），例如</strong>将本机80端口的HTTP流量实时复制到targer_server:8080。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gor --input-raw :80 --output-http &quot;http://target_server:8080&quot;</span><br></pre></td></tr></table></figure><p>2､<strong>控制台输出</strong>，获取经过本地8080端口的请求流量，然后打印到控制台。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gor --input-raw :8080 --output-stdout</span><br></pre></td></tr></table></figure><p>上述命令将监控8080端口上所有的流量，并通过终端stdout输出。你可以通过浏览器或者curl访问8080端口，然后在终端查看gor输出所有的http请求。</p><p>3､<strong>先录制后回放</strong>，将捕捉流量保存到文件中，然后释放到其它机器，有时候实时同步流量是很难做到的, 所以Goreplay提供了这种先保存后回放的模式：</p><p>第一步, 通过--output-file保存流量:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gor --input-raw :8080 --output-file=requests.gor</span><br></pre></td></tr></table></figure><blockquote><p>上述命令将8080端口的流量，保存到requests.gor文件中(必须是.gor后缀，其它后缀经测释放时有问题)。</p></blockquote><p>第二步,回放保存的流量:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gor --input-file requests.gor --output-http=&quot;http://localhost:8081&quot;</span><br></pre></td></tr></table></figure><p>上述命令将释放所有保存在requests.gor中的请求通过相同的时间顺序释放到服务器<a href="http://localhost:8081/">http://localhost:8081</a></p><p>4、<strong>过滤指定请求方法</strong>，如果目标服务器使用的库与线上机器一样，且只需要引流Get方法的请求。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gor --input-raw :80  --http-allow-method GET --output-http &quot;http://target_server:8080&quot;</span><br></pre></td></tr></table></figure><p>5､<strong>请求过滤</strong>，当你需要捕捉指定路径的请求流量时，可以使用该机制， 如只同步&#x2F;api路径下的请求</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gor --input-raw :8080 --output-http staging.com --http-allow-url /api</span><br></pre></td></tr></table></figure><p>只收集请求头中符合 api-version 为 1.0x 的请求</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gor --input-raw :8080 --output-http staging.com --http-allow-header api-version:^1\.0\d</span><br></pre></td></tr></table></figure><p>6､<strong>限速机制</strong>，由于生产服务器配置一般远高于测试服务器配置，所以直接将生产服务器全部流量同步到测试服务器是不可行的，goreplay提供了两种策略：</p><p><strong>a. 限制每秒的请求数</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gor  --input-tcp :28020 --output-http &quot;http://staging.com|10&quot;# (每秒请求数限制10个以内)</span><br><span class="line">gor  --input-raw :80 --output-tcp &quot;replay.local:28020|10%&quot;  # (每秒请求数限制10%以内)</span><br></pre></td></tr></table></figure><p>b. <strong>基于Header或Url的参数限制一些请求</strong>，为指定的header或者url的请求设定限制的百分比。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gor  --input-raw :80 --output-tcp &quot;replay.local:28020|10%&quot; --http-header-limiter &quot;X-API-KEY: 10%&quot;</span><br><span class="line">gor  --input-raw :80 --output-tcp &quot;replay.local:28020|10%&quot; --http-param-limiter &quot;api_key: 10%&quot;</span><br></pre></td></tr></table></figure><p>7、<strong>流量加压</strong>，当需要对线上服务进行整体性能压测时，可将线上请求扩大N倍，进行引流，将请求扩大1倍，也可缩小，调整&quot;|&quot;后面的百分比即可。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gor --input-raw :80  --http-allow-method GET --output-http &quot;http://target_server:8080|200%&quot;</span><br></pre></td></tr></table></figure><p>8、<strong>只复制某个URL请求</strong>，--http-allow-url参数，-http-allow-url参数可用正则表达式（--output-http-url-regexp在gor 0.16已经过期，使用--http-allow-url代替）。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gor --input-raw :8080 --http-allow-method GET --output-http &quot;http://target_server:8080&quot; --http-allow-url mall.*hotword</span><br></pre></td></tr></table></figure><p>9、<strong>多目标服务器的流量复制引流</strong>，有点类似nginx的mirror。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gor --input-raw :80 --output-http &quot;http://target_server:8080&quot; --output-http &quot;http://target_server2:8080&quot;</span><br></pre></td></tr></table></figure><p>10、<strong>将流量转发到多个端点</strong>，默认情况下，它会将相同的流量发送到所有输出。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gor --input-tcp :28020 --output-http &quot;http://staging.com&quot;  --output-http &quot;http://dev.com&quot;</span><br></pre></td></tr></table></figure><p>11、将相同的流量发送到多个站点，并且<strong>平分所有流量</strong>。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gor --input-raw :80 --output-http &quot;http://staging.com&quot;  --output-http &quot;http://dev.com&quot; --split-output true</span><br></pre></td></tr></table></figure><p>12、HTTP超时，默认情况下，http请求和响应的超时时间为5秒。你可以像这样覆盖它：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gor --input-tcp replay.local:28020 --output-http http://staging.com --output-http-timeout 30s</span><br></pre></td></tr></table></figure><p>13、基本身份验证，如果您的开发或登台环境受基本身份验证保护，那么可以在重放期间注入这些凭据：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gor --input-raw :80 --output-http &quot;http://user:pass@staging.com&quot;</span><br></pre></td></tr></table></figure><p>14、<strong>性能压力测试</strong>，可以将流量复制到文件，然后再对他们进行回放。回放的时候，流量会维持原始的时间间隔。如果你使用了百分比来进行速率限制，那么回放的速率会相应的增加或减少。有了这种速率限制，gor就可以用来进行压力测试。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gor --input-file &quot;requests.gor|200%&quot; --output-http &quot;staging.com&quot;</span><br></pre></td></tr></table></figure><p>目前，<code>input-file</code>仅在使用基于百分比的限制器时才支持此功能。与默认限制器不同<code>input-file</code>，它不会降低请求速度，而会减慢速度或加速请求发射。</p><p>15 、<strong>录制与回放</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./gor --input-raw :8000 --output-file=requests.gor</span><br></pre></td></tr></table></figure><p>执行录制命令后，将会创建新文件并不断向其写入所有捕获的请求。</p><p>16、<strong>流量回放</strong>，重播来自文件的请求。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./gor --input-file requests.gor --output-http=&quot;http://localhost:8001&quot;</span><br></pre></td></tr></table></figure><p>您应该看到所有记录到<a href="http://localhost:8001的请求，并且它们将以相同的顺序重播，并且与录制的时间完全相同。">http://localhost:8001的请求，并且它们将以相同的顺序重播，并且与录制的时间完全相同。</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;script src=&quot;\assets\js\APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;h1 id=&quot;流量回放GoReplay&quot;&gt;&lt;a href=&quot;#流量回放GoReplay&quot; class=&quot;headerlink&quot; title=&quot;流量回放GoReplay&quot;&gt;&lt;/a&gt;</summary>
      
    
    
    
    <category term="golang" scheme="https://wangyyovo.github.io/categories/golang/"/>
    
    
  </entry>
  
  <entry>
    <title>Windows11部署Docker</title>
    <link href="https://wangyyovo.github.io/posts/5ee696f6/"/>
    <id>https://wangyyovo.github.io/posts/5ee696f6/</id>
    <published>2022-03-07T10:30:39.000Z</published>
    <updated>2022-03-07T10:30:39.000Z</updated>
    
    <content type="html"><![CDATA[<script src="\assets\js\APlayer.min.js"> </script><h1 id="Windows11部署Docker"><a href="#Windows11部署Docker" class="headerlink" title="Windows11部署Docker"></a>Windows11部署Docker</h1><blockquote><p><a href="https://docs.docker.com/desktop/windows/install/">https://docs.docker.com/desktop/windows/install/</a></p><p><a href="https://docs.microsoft.com/en-us/windows/wsl/basic-commands">https://docs.microsoft.com/en-us/windows/wsl/basic-commands</a></p></blockquote><h2 id="一、下载Docker-for-Windows"><a href="#一、下载Docker-for-Windows" class="headerlink" title="一、下载Docker for Windows"></a>一、下载Docker for Windows</h2><p>到Docker官网下载<a href="https://docs.docker.com/desktop/windows/install/"> Docker for Windows</a>,并安装</p><h2 id="二、安装WSL2"><a href="#二、安装WSL2" class="headerlink" title="二、安装WSL2"></a>二、安装WSL2</h2><p>2.1、启动WSL</p><p>以管理员身份在PowerShell中运行以下命令</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dism.exe /online /enable-feature /featurename:Microsoft-Windows-Subsystem-Linux /all /norestart</span><br></pre></td></tr></table></figure><p>2.2、启动虚拟机功能</p><p>以管理员身份在PowerShell中运行以下命令，运行后需重启计算机</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dism.exe /online /enable-feature /featurename:VirtualMachinePlatform /all /norestart</span><br></pre></td></tr></table></figure><p>2.3、安装Linux内核更新包</p><p>下载地址：<a href="https://wslstorestorage.blob.core.windows.net/wslblob/wsl_update_x64.msi"> wsl_update_x64.msi</a></p><p>2.4、设置WSL2为默认版本</p><p>以管理员身份在PowerShell中运行以下命令</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wsl --set-default-version 2</span><br></pre></td></tr></table></figure><h2 id="三、Docker并迁移镜像到非系统盘"><a href="#三、Docker并迁移镜像到非系统盘" class="headerlink" title="三、Docker并迁移镜像到非系统盘"></a>三、Docker并迁移镜像到非系统盘</h2><p>在Windows11中默认已安装Windows Terminal 推荐使用其操作Docker，打开Windows Terminal 输入命令 <strong>wsl -l --all -v</strong> 来查看Docker的运行状态</p><p>执行命令之后可以看到如上图所示Docker的运行状态，Running表示正在运行中，使用<strong>wsl --shutdown</strong> 关闭运行中的Docker</p><p>再次运行命令可以查看到Docker已处于停止状态，此时就可以进入镜像迁移的步骤。</p><p><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/blog/docker/2022-03-07_180322.png"></p><p>导出Docker镜像</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">C:\Users\&lt;user&gt;\AppData\Local\Docker\wsl</span></span><br><span class="line">wsl --export docker-desktop-data &quot;D:\docker\docker-desktop-data.tar&quot;</span><br><span class="line">wsl --export docker-desktop &quot;D:\docker\docker-desktop.tar&quot;</span><br><span class="line">wsl --export Ubuntu-20.04 &quot;D:\docker\Ubuntu-20.04.tar&quot;</span><br></pre></td></tr></table></figure><p>路径为docker导出文件存储的位置</p><p>注销镜像</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wsl --unregister docker-desktop</span><br><span class="line">wsl --unregister docker-desktop-data</span><br><span class="line">wsl --unregister Ubuntu-20.04</span><br></pre></td></tr></table></figure><p>导入之前导出的镜像</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wsl --import docker-desktop d:\docker\docker-desktop d:\docker\docker-desktop.tar</span><br><span class="line">wsl --import docker-desktop-data d:\docker\docker-desktop-data d:\docker\docker-desktop-data.tar</span><br><span class="line">wsl --import Ubuntu-20.04 d:\docker\Ubuntu-20.04 d:\docker\Ubuntu-20.04.tar</span><br></pre></td></tr></table></figure><p>重启Docker</p><h2 id="四、安装Linux分发版"><a href="#四、安装Linux分发版" class="headerlink" title="四、安装Linux分发版"></a>四、安装Linux分发版</h2><p>直接选了评分最多的Ubuntu，按下Windows 键和R，在对话框中输入wsreset，点击确定，等待程序运行完毕自动打开应用商店。也可以通过<code>wsl -install</code>安装</p><p><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/blog/docker/2022-03-07_174944.png"></p><h2 id="五、配置国内镜像仓库"><a href="#五、配置国内镜像仓库" class="headerlink" title="五、配置国内镜像仓库"></a>五、配置国内镜像仓库</h2><p>3.1、右键托盘图标 - 设置</p><p><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/blog/docker/2022-03-07_172557.png"></p><p>3.2、修改Docker Engine配置，增加镜像仓库地址</p><p><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/blog/docker/2022-03-07_172825.png"></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;registry-mirrors&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;https://registry.docker-cn.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;http://hub-mirror.c.163.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;https://docker.mirrors.ustc.edu.cn&quot;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;insecure-registries&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;debug&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;builder&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;gc&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;defaultKeepStorage&quot;</span><span class="punctuation">:</span> <span class="string">&quot;20GB&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;experimental&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;features&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;buildkit&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>科大镜像：<a href="https://docker.mirrors.ustc.edu.cn/">https://docker.mirrors.ustc.edu.cn/</a></p><p>网易：<a href="https://hub-mirror.c.163.com/">https://hub-mirror.c.163.com/</a></p><p>阿里云：https:&#x2F;&#x2F;&lt;你的ID&gt;.mirror.aliyuncs.com</p><p>七牛云加速器：<a href="https://reg-mirror.qiniu.com/">https://reg-mirror.qiniu.com</a></p><h2 id="六、WSL2配置文件-需要重启"><a href="#六、WSL2配置文件-需要重启" class="headerlink" title="六、WSL2配置文件(需要重启)"></a>六、WSL2配置文件(需要重启)</h2><p><a href="https://docs.microsoft.com/en-us/windows/wsl/wsl-config#configure-global-options-with-wslconfig">https://docs.microsoft.com/en-us/windows/wsl/wsl-config#configure-global-options-with-wslconfig</a></p><p><code>mv wsl.conf \\wsl.localhost\Ubuntu\etc\wsl.conf</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"># wsl.conf</span><br><span class="line"></span><br><span class="line"># Automatically mount Windows drive when the distribution is launched</span><br><span class="line">[automount]</span><br><span class="line"></span><br><span class="line"># Set to true will automount fixed drives (C:/ or D:/) with DrvFs under the root directory set above. Set to false means drives won&#x27;t be mounted automatically, but need to be mounted manually or with fstab.</span><br><span class="line">enabled = true</span><br><span class="line"></span><br><span class="line"># Sets the directory where fixed drives will be automatically mounted. This example changes the mount location, so your C-drive would be /c, rather than the default /mnt/c. </span><br><span class="line">root = /</span><br><span class="line"></span><br><span class="line"># DrvFs-specific options can be specified.  </span><br><span class="line">options = &quot;metadata,uid=1003,gid=1003,umask=077,fmask=11,case=off&quot;</span><br><span class="line"></span><br><span class="line"># Sets the `/etc/fstab` file to be processed when a WSL distribution is launched.</span><br><span class="line">mountFsTab = true</span><br><span class="line"></span><br><span class="line"># Network host settings that enable the DNS server used by WSL 2. This example changes the hostname, sets generateHosts to false, preventing WSL from the default behavior of auto-generating /etc/hosts, and sets generateResolvConf to false, preventing WSL from auto-generating /etc/resolv.conf, so that you can create your own (ie. nameserver 1.1.1.1).</span><br><span class="line">[network]</span><br><span class="line">#hostname = DemoHost</span><br><span class="line">#generateHosts = false</span><br><span class="line">#generateResolvConf = false</span><br><span class="line"></span><br><span class="line"># Set whether WSL supports interop process like launching Windows apps and adding path variables. Setting these to false will block the launch of Windows processes and block adding $PATH environment variables.</span><br><span class="line">[interop]</span><br><span class="line">enabled = false</span><br><span class="line">appendWindowsPath = false</span><br><span class="line"></span><br><span class="line"># Set the user when launching a distribution with WSL.</span><br><span class="line">#[user]</span><br><span class="line">#default = DemoUser</span><br><span class="line"></span><br><span class="line"># Set a command to run when a new WSL instance launches. This example starts the Docker container service.</span><br><span class="line">[boot]</span><br><span class="line">command = service docker start</span><br></pre></td></tr></table></figure><p><a href="https://docs.microsoft.com/en-us/windows/wsl/wsl-config#configure-global-options-with-wslconfig">https://docs.microsoft.com/en-us/windows/wsl/wsl-config#configure-global-options-with-wslconfig</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"># C:\Users\&lt;user&gt;\.wslconfig</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Settings apply across all Linux distros running on WSL 2</span><br><span class="line">[wsl2]</span><br><span class="line"></span><br><span class="line"># Limits VM memory to use no more than 4 GB, this can be set as whole numbers using GB or MB</span><br><span class="line">memory=4GB </span><br><span class="line"></span><br><span class="line"># Sets the VM to use two virtual processors</span><br><span class="line">processors=2</span><br><span class="line"></span><br><span class="line"># Specify a custom Linux kernel to use with your installed distros. The default kernel used can be found at https://github.com/microsoft/WSL2-Linux-Kernel</span><br><span class="line">#kernel=C:\\temp\\myCustomKernel</span><br><span class="line"></span><br><span class="line"># Sets additional kernel parameters, in this case enabling older Linux base images such as Centos 6</span><br><span class="line">#kernelCommandLine = vsyscall=emulate</span><br><span class="line"></span><br><span class="line"># Sets amount of swap storage space to 8GB, default is 25% of available RAM</span><br><span class="line">swap=8GB</span><br><span class="line"></span><br><span class="line"># Sets swapfile path location, default is %USERPROFILE%\AppData\Local\Temp\swap.vhdx</span><br><span class="line">#swapfile=C:\\temp\\wsl-swap.vhdx</span><br><span class="line"></span><br><span class="line"># Disable page reporting so WSL retains all allocated memory claimed from Windows and releases none back when free</span><br><span class="line">pageReporting=false</span><br><span class="line"></span><br><span class="line"># Turn off default connection to bind WSL 2 localhost to Windows localhost</span><br><span class="line">localhostforwarding=true</span><br><span class="line"></span><br><span class="line"># Disables nested virtualization</span><br><span class="line">nestedVirtualization=false</span><br><span class="line"></span><br><span class="line"># Turns on output console showing contents of dmesg when opening a WSL 2 distro for debugging</span><br><span class="line">debugConsole=true</span><br></pre></td></tr></table></figure><p>重启docker desktop</p><h2 id="七、docker部署的SqlServer过几秒自动停止"><a href="#七、docker部署的SqlServer过几秒自动停止" class="headerlink" title="七、docker部署的SqlServer过几秒自动停止"></a>七、docker部署的SqlServer过几秒自动停止</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -e &quot;ACCEPT_EULA=Y&quot; -e &quot;SA_PASSWORD=Aa123456!@#&quot; -p 1401:1433 -d mcr.microsoft.com/mssql/server:latest</span><br></pre></td></tr></table></figure><p>其中ACCEPT_EULA&#x3D;Y的意思是同意许可协议，必选MSSQL_SA_PASSWORD为sa用户的密码，要求最少8位的强密码，要有大写字母，小写字母，数字以及特殊符号，否则会有一个大坑（docker启动sqlserver容器后过几秒就停止了，报EXITED(1)的错）</p><p>前面的1401端口表示映射到主机的1401端口</p><p>后面的1433端口表示容器中的sqlserver服务用到的1433端口</p><h2 id="八、启动本k8s"><a href="#八、启动本k8s" class="headerlink" title="八、启动本k8s"></a>八、启动本k8s</h2><p><a href="https://docs.docker.com/desktop/kubernetes/#disable-kubernetes">https://docs.docker.com/desktop/kubernetes/#disable-kubernetes</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl config get-contexts</span><br><span class="line">kubectl config use-context docker-desktop</span><br></pre></td></tr></table></figure><p>kubernetes一直处于starting状态解决方法</p><p><a href="https://blog.csdn.net/gzseehope/article/details/108881193">https://blog.csdn.net/gzseehope/article/details/108881193</a></p><p><a href="https://github.com/AliyunContainerService/k8s-for-docker-desktop/tree/v1.22.5">https://github.com/AliyunContainerService/k8s-for-docker-desktop/tree/v1.22.5</a></p><p><a href="https://www.freeaihub.com/post/108121.html">解决Windows上Docker Desktop中Kubernetes一直处于starting的问题</a></p><p><a href="https://www.cnblogs.com/danvic712/p/enable-k8s-in-docker-desktop.html">在 Docker Desktop 中启用 K8s 服务</a></p><p><a href="https://www.jianshu.com/p/e5c056baa8ab">如何成功启动 Docker 自带的 Kubernetes？(2022年1月更新)</a></p><p><a href="https://wayneshao.com/posts/10324.html">Windows 下 DockerCE 启用 K8s 报错 kubernetes.docker.internal no such host</a></p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://blog.csdn.net/XY1790026787/article/details/107922995">看看Docker Desktop WSL2 backend</a></p><p><a href="https://www.wyr.me/post/689">Win11正式版升级安装Docker(基于WSL2)</a></p><p><a href="https://baijiahao.baidu.com/s?id=1715415573263062604&wfr=spider&for=pc">Windows11安装Docker并迁移镜像到非系统盘</a></p><p><a href="https://post.smzdm.com/p/a259kqlp/">手把手教你踩坑：老白的Docker for Windows安装初探WSL 2 backend</a></p><h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>日志信息</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">github.com/moby/vpnkit/go/cmd/kube<span class="literal">-vpnkit-forwarder</span>/main.go:<span class="number">49</span>: Failed to list *v1.Service: services is forbidden: User <span class="string">&quot;system:serviceaccount:kube-system:vpnkit-controller&quot;</span> cannot list resource <span class="string">&quot;services&quot;</span> <span class="keyword">in</span> API <span class="built_in">group</span> <span class="string">&quot;&quot;</span> at the cluster scope</span><br><span class="line"></span><br><span class="line">log: exiting because of error: log: cannot create log: open /tmp/kube<span class="literal">-vpnkit-forwarder</span>.vpnkit<span class="literal">-controller</span>.unknownuser.log.ERROR.<span class="number">20210815</span><span class="literal">-072638</span>.<span class="number">1</span>: no such file or directory</span><br></pre></td></tr></table></figure><p>网上查找半天说是在 <code>C:\Windows\System32\drivers\etc\hosts</code> 文件添加配置，重启 DockerDesktop 即可。</p><p><code>Resolve-DnsName kubernetes.docker.internal</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1 kubernetes.docker.internal</span><br></pre></td></tr></table></figure><p>重启后问题成功解决。</p><p>我们来查看下集群状态 (搞错了。。。这个是集群启动失败的情况)</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl cluster-info</span><br><span class="line"></span><br><span class="line">To further debug and diagnose cluster problems, use &#x27;kubectl cluster-info dump&#x27;.</span><br><span class="line">Unable to connect to the server: dial tcp: lookup kubernetes.docker.internal: no such host</span><br></pre></td></tr></table></figure><p>集群启动成功的正确姿势</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kubectl cluster<span class="literal">-info</span></span><br><span class="line"></span><br><span class="line">Kubernetes control plane is running at https://kubernetes.docker.internal:<span class="number">6443</span></span><br><span class="line">CoreDNS is running at https://kubernetes.docker.internal:<span class="number">6443</span>/api/v1/namespaces/kube<span class="literal">-system</span>/services/kube<span class="literal">-dns</span>:dns/proxy</span><br><span class="line"></span><br><span class="line">To further debug and diagnose cluster problems, use <span class="string">&#x27;kubectl cluster-info dump&#x27;</span>.</span><br></pre></td></tr></table></figure><p>到此，使用 DockerDesktop 运行 Kubernetes 已经成功。</p><p>在macOS上面，执行 <code>rm -fr &#39;~/Library/Group\ Containers/group.com.docker/pki&#39;</code></p><p>在Windows上面删除 &#39;C:\ProgramData\DockerDesktop\pki&#39; 目录 和 &#39;C:\Users\yourUserName\AppData\Local\Docker\pki&#39; 目录</p>]]></content>
    
    
      
      
    <summary type="html">&lt;script src=&quot;\assets\js\APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;h1 id=&quot;Windows11部署Docker&quot;&gt;&lt;a href=&quot;#Windows11部署Docker&quot; class=&quot;headerlink&quot; title=&quot;Windows1</summary>
      
    
    
    
    <category term="docker" scheme="https://wangyyovo.github.io/categories/docker/"/>
    
    
  </entry>
  
  <entry>
    <title>NATS-Server(JetStream)和NATS Streaming Server对比</title>
    <link href="https://wangyyovo.github.io/posts/f9d1b0aa/"/>
    <id>https://wangyyovo.github.io/posts/f9d1b0aa/</id>
    <published>2022-03-03T10:22:20.000Z</published>
    <updated>2022-03-03T10:22:20.000Z</updated>
    
    <content type="html"><![CDATA[<script src="\assets\js\APlayer.min.js"> </script><h1 id="NATS-Server-JetStream-和NATS-Streaming-Server对比"><a href="#NATS-Server-JetStream-和NATS-Streaming-Server对比" class="headerlink" title="NATS-Server(JetStream)和NATS Streaming Server对比"></a>NATS-Server(JetStream)和NATS Streaming Server对比</h1><p>在我吐槽了无数次之后，<code>NATS JetStream</code>终于结束了beta阶段正式进入RC阶段。终于官方也在最近刚刚正式回复了我正式版本在处理几个问题之后就会正式发布。那么在这个比较重要的<code>NATS-Server</code>特性发布之际聊一下NATS产品本身区别和新特性的使用，还有更多的潜在的区别。</p><h2 id="概念区分：NATS-Server-NATS-Streaming-Server-NATS-JetStream"><a href="#概念区分：NATS-Server-NATS-Streaming-Server-NATS-JetStream" class="headerlink" title="概念区分：NATS-Server &#x2F; NATS Streaming Server &#x2F; NATS JetStream"></a>概念区分：NATS-Server &#x2F; NATS Streaming Server &#x2F; NATS JetStream</h2><h3 id="NATS-Server"><a href="#NATS-Server" class="headerlink" title="NATS-Server"></a>NATS-Server</h3><p><code>NATS-Server</code>（或者叫<code>nats</code>）是一个开源的、云原生的、高性能的消息传递系统，是NATS的最基础的产品。它的核心是一个发布&#x2F;订阅（Pub&#x2F;Sub）系统，客户端可以在不同集群中的服务间<code>nats</code>进行通讯，而不需要关注具体的消息在哪个服务上。换而言之，客户端可以在任意一个集群的服务端上发布消息，同时在任意集群客户端上尝试读取消息。在官方与其他同类消息队列产品<a href="https://docs.nats.io/compare-nats">功能对比</a>中，我们也可以管窥一下产品的功能列表。<code>nats</code>支持多流多服务进行<code>pub/sub</code>，负载均衡，保障消息最多&#x2F;最少一次送达，多租户和用户认证等功能。虽然看上去优点很多，但是<code>nats</code>不是一个应用很广的消息队列的重要原因是，它缺少了一些对消息队列而言很最重要的产品特性，比如持久化支持，比如消息确保一次送达。这意味着当你的消息发送出去之后，你的消息是在处理过程中可能丢失的，甚至是可能送达不到的。</p><h3 id="NATS-Streaming-Server"><a href="#NATS-Streaming-Server" class="headerlink" title="NATS Streaming Server"></a>NATS Streaming Server</h3><p><code>NATS Streaming Server</code>（或者叫<code>stan</code>）是用于尝试解决上面提到的<code>nats</code>的已存在问题的。<code>stan</code>添加了持久化功能和消息送达策略支持。<code>stan</code>中自带了<code>nats</code>服务端，但是在使用过程中，<code>nats</code>和<code>stan</code>不能进行混用。在官方文档中，是这么描述<code>stan</code>和<code>nats</code>之间的关系的：</p><p>NATS客户端和NATS Streaming Server客户端之间不能相互交换数据。也就是说，如果一个NATS Streaming Server客户端在foo上发布消息，在同一主题上订阅的NATS客户端将不会收到消息。NATS Streaming Server消息是由protobuf组成的NATS消息。NATS Streaming Server要向生产者发送ACK，并接收消费者的ACK。如果与NATS客户端自由交换消息，就会引起问题。</p><p><code>stan</code>的具体架构如下图：</p><p><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/blog/nats/3849d973-1e39-463d-b64e-5aecb985d9f4.jpg"></p><p>但是<code>stan</code>虽然提供了持久化和消息传递策略支持，但是在架构设计上却出现了问题，导致在最开始设计时遗留了很多问题，比如当你确定<code>stan</code>集群是固定的不能无限制水平扩容(<a href="https://github.com/nats-io/nats-streaming-server/issues/999">#999</a>)，比如不支持多租户功能(<a href="https://github.com/nats-io/nats-streaming-server/issues/1122">#1122</a>)，比如客户端无法主动拉取消息只能被推送等等</p><h3 id="NATS-JetStream"><a href="#NATS-JetStream" class="headerlink" title="NATS JetStream"></a>NATS JetStream</h3><p><code>NATS JetStream</code>（或者叫<code>JetStream</code>）是NATS基于<code>Raft</code>算法实现的最新的架构设计尝试解决上述问题的新方案。在区别于原有的<code>stan</code>功能上，提供了新的持久化功能和消息送达策略，同时支持水平扩容。同时，新的<code>JetStream</code>也为大消息做了一些优化，不再将这特性功能作为<code>nats</code>的客户端存在而是嵌入<code>NATS Server</code>中作为其中的一个功能存在。也就是说，如果在对这几项技术进行选择时，<code>JetStream</code>应该是最应该被选择的方案。更多详细情况具体可以查看官方的<a href="https://github.com/nats-io/jetstream">指导文档</a>。</p><h2 id="NATS-JetStream使用"><a href="#NATS-JetStream使用" class="headerlink" title="NATS JetStream使用"></a>NATS JetStream使用</h2><p>理论介绍过了，接下来说说实际使用的事情。现在<code>JetStream</code>还是RC阶段，</p><h3 id="编译和启动客户端"><a href="#编译和启动客户端" class="headerlink" title="编译和启动客户端"></a>编译和启动客户端</h3><p>下载<code>nats-server</code><a href="https://github.com/nats-io/nats-server/archive/master.zip">源码</a>，解压之后执行：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd nats-server-master</span><br><span class="line">go build -o nats-server -ldflags=&quot;-s -w -buildid=&quot; .</span><br><span class="line">./nats-server -js</span><br></pre></td></tr></table></figure><p>这样就可以启动一个支持<code>JetStream</code>功能的服务端了。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[19940] 2022/03/03 16:23:17.473191 [INF] Starting nats-server</span><br><span class="line">[19940] 2022/03/03 16:23:17.494913 [INF]   Version:  2.7.2</span><br><span class="line">[19940] 2022/03/03 16:23:17.494913 [INF]   Git:      [135475b]</span><br><span class="line">[19940] 2022/03/03 16:23:17.494913 [INF]   Name:     n3-c1</span><br><span class="line">[19940] 2022/03/03 16:23:17.494913 [INF]   Node:     hxTjz3J4</span><br><span class="line">[19940] 2022/03/03 16:23:17.494913 [INF]   ID:       NCCKYYLMZBGZZB4RZQYZAO6CZPHXHKJPBESSIEON3T2F5MLGNAHDOQKV</span><br><span class="line">[19940] 2022/03/03 16:23:17.494913 [INF] Using configuration file: ./n3_c1.conf</span><br><span class="line">[19940] 2022/03/03 16:23:17.494913 [INF] Starting JetStream</span><br><span class="line">[19940] 2022/03/03 16:23:17.496910 [INF]     _ ___ _____ ___ _____ ___ ___   _   __  __</span><br><span class="line">[19940] 2022/03/03 16:23:17.496910 [INF]  _ | | __|_   _/ __|_   _| _ \ __| /_\ |  \/  |</span><br><span class="line">[19940] 2022/03/03 16:23:17.496910 [INF] | || | _|  | | \__ \ | | |   / _| / _ \| |\/| |</span><br><span class="line">[19940] 2022/03/03 16:23:17.496910 [INF]  \__/|___| |_| |___/ |_| |_|_\___/_/ \_\_|  |_|</span><br><span class="line">[19940] 2022/03/03 16:23:17.496910 [INF]</span><br><span class="line">[19940] 2022/03/03 16:23:17.496910 [INF]          https://docs.nats.io/jetstream</span><br><span class="line">[19940] 2022/03/03 16:23:17.496910 [INF]</span><br><span class="line">[19940] 2022/03/03 16:23:17.496910 [INF] ---------------- JETSTREAM ----------------</span><br><span class="line">[19940] 2022/03/03 16:23:17.496910 [INF]   Max Memory:      953.67 MB</span><br><span class="line">[19940] 2022/03/03 16:23:17.496910 [INF]   Max Storage:     953.67 MB</span><br><span class="line">[19940] 2022/03/03 16:23:17.496910 [INF]   Store Directory: &quot;\nats\n3-c1\storage\jetstream&quot;</span><br><span class="line">[19940] 2022/03/03 16:23:17.497907 [INF] -------------------------------------------</span><br><span class="line">[19940] 2022/03/03 16:23:17.498905 [INF] Starting JetStream cluster</span><br><span class="line">[19940] 2022/03/03 16:23:17.498905 [INF] Creating JetStream metadata controller</span><br><span class="line">[19940] 2022/03/03 16:23:17.502423 [INF] JetStream cluster recovering state</span><br><span class="line">[19940] 2022/03/03 16:23:17.505415 [INF] Listening for client connections on 0.0.0.0:4224</span><br><span class="line">[19940] 2022/03/03 16:23:17.543574 [INF] Server is ready</span><br></pre></td></tr></table></figure><h3 id="编写JetStream-DEMO"><a href="#编写JetStream-DEMO" class="headerlink" title="编写JetStream DEMO"></a>编写JetStream DEMO</h3><p>接下来我们看一下如何使用<code>JetStream</code>进行消息发布&#x2F;订阅功能：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 连接到nats的服务器</span></span><br><span class="line">conn, err := nats.Connect(<span class="string">&quot;nats://127.0.0.1:4222&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Panic(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> conn.Close()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化JetStream功能</span></span><br><span class="line">js, err := conn.JetStream()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Panic(err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断Stream是否存在，如果不存在，那么需要创建这个Stream，否则会导致pub/sub失败</span></span><br><span class="line">stream, err := js.StreamInfo(streamName)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Println(err) <span class="comment">// 如果不存在，这里会有报错</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> stream == <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Printf(<span class="string">&quot;creating stream %q and subject %q&quot;</span>, streamName, subject)</span><br><span class="line">    _, err = js.AddStream(&amp;nats.StreamConfig&#123;</span><br><span class="line">        Name:     streamName,</span><br><span class="line">        Subjects: []<span class="type">string</span>&#123;subject&#125;,</span><br><span class="line">        MaxAge:   <span class="number">3</span> * <span class="number">24</span> * time.Hour,</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Panicln(err)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 订阅消息</span></span><br><span class="line">sub, err := js.Subscribe(subject, cbHandle, nats.AckAll(), nats.DeliverNew())</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Panic(err)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> sub.Unsubscribe()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送消息</span></span><br><span class="line">js.Publish(subject, []<span class="type">byte</span>(<span class="string">&quot;Hello World! &quot;</span>+time.Now().Format(time.RFC3339)))</span><br><span class="line"></span><br><span class="line">time.Sleep(<span class="number">5</span> * time.Second)</span><br><span class="line">log.Println(<span class="string">&quot;Exiting...&quot;</span>)</span><br></pre></td></tr></table></figure><p>在这个例子中，有个值得注意的功能需要额外强调一下，在<code>Subscribe</code>消息时，我们在这里特别声明了<code>nats.DeliverNew()</code>这个选项。如果不声明，则默认为<code>nats.DeliverAll()</code>；除了这两个参数，还有一个<code>nats.DeliverLast()</code>参数，这分别对应了3种开始订阅时的方式：默认方式<code>nats.DeliverAll()</code>是会读取有效生命周期内的所有消息，甚至包含已被处理的消息；<code>nats.DeliverLast()</code>是会包含消息队列中的最后一条消息，即使被处理过的消息；<code>nats.DeliverNew()</code>则只处理订阅之后的新消息。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;script src=&quot;\assets\js\APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;h1 id=&quot;NATS-Server-JetStream-和NATS-Streaming-Server对比&quot;&gt;&lt;a href=&quot;#NATS-Server-JetStream-和N</summary>
      
    
    
    
    <category term="microservice" scheme="https://wangyyovo.github.io/categories/microservice/"/>
    
    <category term="nats" scheme="https://wangyyovo.github.io/categories/microservice/nats/"/>
    
    
  </entry>
  
  <entry>
    <title>OPA进阶-分布式利器Bundle</title>
    <link href="https://wangyyovo.github.io/posts/ee217f4a/"/>
    <id>https://wangyyovo.github.io/posts/ee217f4a/</id>
    <published>2022-03-02T09:48:44.000Z</published>
    <updated>2022-03-02T09:48:44.000Z</updated>
    
    <content type="html"><![CDATA[<script src="\assets\js\APlayer.min.js"> </script><h1 id="OPA进阶-分布式利器Bundle"><a href="#OPA进阶-分布式利器Bundle" class="headerlink" title="OPA进阶-分布式利器Bundle"></a>OPA进阶-分布式利器Bundle</h1><p><code>Bundle</code>是<code>OPA</code>管理<code>policy</code>和<code>data</code>的一种方式。</p><p><code>OPA</code>实现的轻量级策略引擎，一开始就是为了云原生环境的<code>service</code>提供解耦的策略服务，分布式是必然要考虑的问题。</p><p>在<code>Bundle api</code>的设计中，其实就全面考虑并体现了在分布式应用中如何更好的解耦策略引擎的管理。</p><p>比如：</p><ul><li>如何做集中配置管理</li><li>如何动态更新策略</li><li>如何监控策略引擎节点的状态以及决策日志收集</li></ul><p>有了这些功能，再加上其高效的策略描述语言<code>Rego</code>，<code>OPA</code>才真正称得上是<strong>云原生时代的通用策略引擎</strong>。</p><p>本文将带大家简单梳理一遍<code>Bundle</code>的组织方式、管理 api、及监控方式。</p><p>考虑到一次性过完不易消化，文末会提供一个直接可实操的<code>docker-compose</code>版本的<code>demo</code>，将全面覆盖本文细节</p><p>建议大家看完本文，本机运行去体验一下，会有更直观的理解。</p><h2 id="Bundle-文件组织方式"><a href="#Bundle-文件组织方式" class="headerlink" title="Bundle 文件组织方式"></a>Bundle 文件组织方式</h2><p>下面我们先来看下<code>Bundle</code>的文件组织方式</p><p>在<code>Bundle</code>下的<code>data</code>,只能被识别<code>data.json</code>和<code>data.yaml</code>的文件, 而其上边的目录会作为其数据前缀</p><p>如下边<code>roles/data.json</code> (<code>bundle/example</code>作为一个<code>bundle</code>)，会将<code>data.json</code>的数据挂在<code>data.roles</code>节点下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cd bundle/example</span><br><span class="line">tree -a</span><br><span class="line">.</span><br><span class="line">├── .manifest</span><br><span class="line">├── bindings</span><br><span class="line">│   └── data.json</span><br><span class="line">├── main.rego</span><br><span class="line">├── rbac.rego</span><br><span class="line">└── roles</span><br><span class="line">    └── data.json</span><br></pre></td></tr></table></figure><p>其中<code>.manifest</code>文件是<code>Bundle</code>的一个可选的元数据（<code>metadata</code>）配置文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat .manifest</span><br><span class="line">&#123;</span><br><span class="line">  &quot;revision&quot; : &quot;9f160bcd446bf50b1b17b570c322198a68d8e106&quot;,</span><br><span class="line">  &quot;roots&quot;: [&quot;roles&quot;, &quot;bindings&quot;,&quot;rbac&quot;,&quot;system&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>它的作用是声明<code>Bundle</code>的版本<code>revision</code>及其下的路径前缀（<code>roots: path prefix</code>）</p><p><code>roots</code>不仅规定了<code>Bundle</code>应该有的路径前缀；在用<code>Bundle api</code>（后边会提到）更新文件时，也会按其规定的路径前缀来更新文件</p><p>然后<code>bundle</code>也支持<code>tarball</code>格式加载到<code>server</code></p><p>例如<code>opa run -b</code>的方式指定<code>Bundle</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd bundle/example</span><br><span class="line">tar -czf bundle.tar.gz .</span><br><span class="line">opa run -b bundle.tar.gz</span><br></pre></td></tr></table></figure><blockquote><p>Tips: 关于如何在交互式命令行里传递<code>input</code>。之前非 bundle 使用<code>opa run quick-start repl.input:quick-start/input.json</code>到 bundle 格式时，就需要构建 <strong><code>repl/input/data.json</code></strong> 文件格式作为输入</p></blockquote><p>具体可以用时参考文档<strong>bundle-file-format</strong></p><h2 id="opa-server-api"><a href="#opa-server-api" class="headerlink" title="opa server api"></a>opa server api</h2><p>在了解<code>Bundle</code>支持的管理 api 前，我们先看下<strong>opa server api</strong>[2]</p><p>主要 api 如下：</p><table><thead><tr><th align="left">type</th><th align="left">用途</th></tr></thead><tbody><tr><td align="left">Data api</td><td align="left">查询文档（能被输出的规则、虚拟文档等）</td></tr><tr><td align="left">Policy api</td><td align="left">查询策略</td></tr><tr><td align="left">Query api</td><td align="left">执行命令</td></tr><tr><td align="left">Compile api</td><td align="left">执行部分查询计算（<code>partial evaluate query</code>）</td></tr><tr><td align="left">Health api</td><td align="left">健康检查</td></tr><tr><td align="left">Metric api</td><td align="left">指标统计（<code>prometheus</code>格式)</td></tr></tbody></table><p>下面我们以文档查询（<code>Data</code>）api 为例尝试下：</p><p>我们先用之前<code>quick-start</code>的代码起一个<code>opa sever</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">opa run --server quick-start</span><br></pre></td></tr></table></figure><p>(注意：<code>opa server api</code>的路径前缀为<code>/v1/</code>, 对应的，查询 api 路径前缀为<code>/v1/data/</code>,)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 构造input输出请求</span><br><span class="line">cat &lt;&lt;EOF &gt; v1-data-input.json</span><br><span class="line">&#123;</span><br><span class="line">    &quot;input&quot;: $(cat quick-start/input.json)</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"># 查询 example_rbac</span><br><span class="line">curl -s  http://0.0.0.0:8181/v1/data/example_rbac?pretty=true -d @v1-data-input.json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;result&quot;: &#123;</span><br><span class="line">    &quot;allow&quot;: true,</span><br><span class="line">    &quot;role_has_permission&quot;: [</span><br><span class="line">      &quot;widget-reader&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;user_has_role&quot;: [</span><br><span class="line">      &quot;widget-reader&quot;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>Tips：不指定路径时，默认路径为<code>data.system.main</code>，这时输入不需要包裹在<code>input</code> key 内。也可以使用<code>--set</code> 和 <code>--set-file</code> 可以覆盖配置文件中的配置<code>opa run --server --set=default_decision=example_rbac/allow/ quick-start</code> &gt; <code>curl -s http://0.0.0.0:8181/ -d @quick-start/input.json</code></p></blockquote><p>而且 Data 查询也支持组合参数如<code>explain</code>,<code>metrics</code>,<code>provenance</code>等，详细查看文档，这里就不展开了。</p><h2 id="Bundle-管理-api"><a href="#Bundle-管理-api" class="headerlink" title="Bundle 管理 api"></a>Bundle 管理 api</h2><p><code>Bundle</code>为了在分布式系统中更好的展现 OPA 的威力，提供了四种 Api：</p><ul><li>Bundles 用于策略分发，可以定时轮训更新<code>Bundle</code>包</li><li>Decision Logs 定期上传日志包，支持按大小分片，开启后会有日志 id，决策日志可追溯</li><li>Status 定期上传服务状态，包含<code>metrics</code>等信息</li><li>Discovery 服务发现，可以用于集中管理<code>OPA</code>的<code>Bundle</code>配置，各个节点下载定期同步配置后，按配置去更新<code>Bundle</code></li></ul><p>如下图：</p><p><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/blog/opa/control_plane.png">management api</p><p>这里举个带注释<code>Bundle</code>的四种接口配置例子</p><p>（先扫一遍留个印象，具体使用时查看文档，后边会提供可实操的代码）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"># opa/config-bundle.yaml</span><br><span class="line">services:</span><br><span class="line">  # 定义服务，支持多个</span><br><span class="line">  - name: example_bundle</span><br><span class="line">    url: http://demo-server:8888/</span><br><span class="line"></span><br><span class="line">labels:</span><br><span class="line">  app: myapp</span><br><span class="line"></span><br><span class="line">bundles:</span><br><span class="line">  # 定义bundle, 支持多个</span><br><span class="line">  authz:</span><br><span class="line">    # bundle所处的服务</span><br><span class="line">    service: example_bundle</span><br><span class="line">    # 这里指从resource处更新bundle文件包，即：</span><br><span class="line">    # http://demo-server:8888/bundle/rbac.tar.gz</span><br><span class="line">    resource: bundle/rbac.tar.gz</span><br><span class="line">    polling:</span><br><span class="line">      # 300~600s间更新一次</span><br><span class="line">      min_delay_seconds: 300</span><br><span class="line">      max_delay_seconds: 600</span><br><span class="line"></span><br><span class="line">decision_logs:</span><br><span class="line">  service: example_bundle</span><br><span class="line">  # partition_name为区分上传地址,会跟到 /logs 后, 即：</span><br><span class="line">  # http://demo-server:8888/logs/bundle</span><br><span class="line">  # 注意上传的是gzip日志文件</span><br><span class="line">  partition_name: bundle</span><br><span class="line">  reporting:</span><br><span class="line">    min_delay_seconds: 30</span><br><span class="line">    max_delay_seconds: 60</span><br><span class="line"></span><br><span class="line">status:</span><br><span class="line">  service: example_bundle</span><br><span class="line">  # 即 http://demo-server:8888/status/bundle</span><br><span class="line">  partition_name: bundle</span><br><span class="line"></span><br><span class="line"># 默认查询路径</span><br><span class="line">default_decision: rbac/allow</span><br></pre></td></tr></table></figure><h2 id="Bundle-集成方式"><a href="#Bundle-集成方式" class="headerlink" title="Bundle 集成方式"></a>Bundle 集成方式</h2><p>这里我们简单过下集成方式</p><h3 id="opa-server-方式"><a href="#opa-server-方式" class="headerlink" title="opa server 方式"></a>opa server 方式</h3><p>运行方式很简单如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">opa run -s -a 0.0.0.0:8181 -c opa/config-bundle.yaml</span><br></pre></td></tr></table></figure><p>运行后，opa server 会根据配置自动拉取<code>Bundle</code>包：<code>rbac.tar.gz</code></p><p>下载成功后启动策略服务。同时定期上传决策日志和状态给服务端（即：<code>demo-server:8888</code>）</p><h3 id="go-lib-方式"><a href="#go-lib-方式" class="headerlink" title="go lib 方式"></a>go lib 方式</h3><p>使用 lib <code>github.com/open-policy-agent/opa/rego</code>集成</p><p>关键代码举例如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">// 构建查询，PrepareForEval可重用</span><br><span class="line">var err error</span><br><span class="line">query, err := rego.New(</span><br><span class="line">    rego.LoadBundle(&quot;./rbac.tar.gz&quot;),</span><br><span class="line">    rego.Query(&quot;x = data.rbac.allow&quot;),</span><br><span class="line">).PrepareForEval(context.Background())</span><br><span class="line"></span><br><span class="line">// 执行查询</span><br><span class="line">results, err := query.Eval(context.Background(), rego.EvalInput(input))</span><br><span class="line">if err != nil &#123;</span><br><span class="line">    fmt.Fatalln(&quot;Opa eval error:&quot;, err)</span><br><span class="line">    return</span><br><span class="line">&#125; else if len(results) == 0 &#123;</span><br><span class="line">    fmt.Fatalln(&quot;Opa eval error: no result&quot;)</span><br><span class="line">    return</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fmt.Println(&quot;Opa result:&quot;, results[0].Expressions[0].Value)</span><br></pre></td></tr></table></figure><p>具体组织方式官方推荐的有下边<strong>集中式</strong>和<strong>分布式</strong>这两种：</p><p><img src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="图片">host-local</p><p><img src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="图片">distributed-enforcement</p><p>推荐感兴趣的同学再去看下官方 go 集成的 demo: <strong>example-api-authz-go</strong>[3]</p><h2 id="Bundle-的监控"><a href="#Bundle-的监控" class="headerlink" title="Bundle 的监控"></a>Bundle 的监控</h2><p>opa server 支持<code>metrics</code>, 而且是<code>prometheus</code>格式的</p><p>所以配合<code>prometheus</code>可以直接进行对其数据指标的监控，如下图：</p><p><img src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" alt="图片">prometheus</p><p>再配合<code>grafana</code>的<code>dashbord</code>可以更好的展示<code>metrics</code>数据，如下图：</p><p><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/blog/opa/opa_metric.png"></p><h2 id="Bundle-in-action"><a href="#Bundle-in-action" class="headerlink" title="Bundle in action"></a>Bundle in action</h2><p>上边说这么多，不实际试一下怎么知道<code>Bundle</code>究竟如何呢？</p><p>这里提供一个<code>docker-compose</code>版的 demo 给大家去本地验证尝试</p><p>里边提供了三种<code>Bundle</code>版本：</p><ul><li>opa-bundle</li><li>opa-discovery</li><li>demo-sever (go lib 集成)</li></ul><p>也提供了两种版本的<code>monitor</code></p><ul><li>slim version</li><li>advance version</li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;script src=&quot;\assets\js\APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;h1 id=&quot;OPA进阶-分布式利器Bundle&quot;&gt;&lt;a href=&quot;#OPA进阶-分布式利器Bundle&quot; class=&quot;headerlink&quot; title=&quot;OPA进阶-分布</summary>
      
    
    
    
    <category term="microservice" scheme="https://wangyyovo.github.io/categories/microservice/"/>
    
    <category term="opa" scheme="https://wangyyovo.github.io/categories/microservice/opa/"/>
    
    
    <category term="opa" scheme="https://wangyyovo.github.io/tags/opa/"/>
    
  </entry>
  
  <entry>
    <title>OPA进阶-测试、性能分析和基准测试</title>
    <link href="https://wangyyovo.github.io/posts/ba44c24c/"/>
    <id>https://wangyyovo.github.io/posts/ba44c24c/</id>
    <published>2022-03-02T09:45:44.000Z</published>
    <updated>2022-03-02T09:45:44.000Z</updated>
    
    <content type="html"><![CDATA[<script src="\assets\js\APlayer.min.js"> </script><h1 id="OPA进阶-测试、性能分析和基准测试"><a href="#OPA进阶-测试、性能分析和基准测试" class="headerlink" title="OPA进阶-测试、性能分析和基准测试"></a>OPA进阶-测试、性能分析和基准测试</h1><p><code>OPA</code>的测试（<code>test</code>）、性能分析（<code>profile</code>）和（<code>benchmark</code>）</p><p>掌握他们，对于保证策略代码的质量和决策效率有很大的帮助</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir quick-start</span><br></pre></td></tr></table></figure><p>data.json</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;roles&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;operation&quot;</span><span class="punctuation">:</span> <span class="string">&quot;read&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;widgets&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;widget-reader&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;operation&quot;</span><span class="punctuation">:</span> <span class="string">&quot;write&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;widgets&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;widget-writer&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;bindings&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;user&quot;</span><span class="punctuation">:</span> <span class="string">&quot;inspector-alice&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;role&quot;</span><span class="punctuation">:</span> <span class="string">&quot;widget-reader&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;user&quot;</span><span class="punctuation">:</span> <span class="string">&quot;maker-bob&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;role&quot;</span><span class="punctuation">:</span> <span class="string">&quot;widget-writer&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>example.rego</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">package example_rbac</span><br><span class="line"></span><br><span class="line">default allow = false</span><br><span class="line"></span><br><span class="line"># allow will be true when user has role and role has permission</span><br><span class="line">allow &#123;</span><br><span class="line"># opa eval -f pretty -d quick-start -i quick-start/input.json &quot;data.example_rbac.allow&quot; --explain=notes</span><br><span class="line"># trace(role_name)</span><br><span class="line">some role_name</span><br><span class="line">user_has_role[role_name]</span><br><span class="line">role_has_permission[role_name]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># check user role binding exist</span><br><span class="line">user_has_role[role_name] &#123;</span><br><span class="line">role_binding = data.bindings[_]</span><br><span class="line">role_binding.role = role_name</span><br><span class="line">role_binding.user == input.subject.user</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># check role permission exist</span><br><span class="line">role_has_permission[role_name] &#123;</span><br><span class="line">role = data.roles[_]</span><br><span class="line">role.name = role_name</span><br><span class="line">role.operation == input.action.operation</span><br><span class="line">role.resource == input.action.resource</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>example_test.rego</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">package example_rbac_test</span><br><span class="line"></span><br><span class="line">import data.example_rbac</span><br><span class="line"></span><br><span class="line"># tests to coverage 100%</span><br><span class="line"></span><br><span class="line">test_not_allow &#123;</span><br><span class="line">not example_rbac.allow with input as &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">test_allow &#123;</span><br><span class="line">example_rbac.allow with input as &#123;</span><br><span class="line">&quot;action&quot;: &#123;</span><br><span class="line">&quot;operation&quot;: &quot;read&quot;,</span><br><span class="line">&quot;resource&quot;: &quot;widgets&quot;,</span><br><span class="line">&#125;,</span><br><span class="line">&quot;subject&quot;: &#123;&quot;user&quot;: &quot;inspector-alice&quot;&#125;,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>input.json</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;action&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;operation&quot;</span><span class="punctuation">:</span><span class="string">&quot;read&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;resource&quot;</span><span class="punctuation">:</span><span class="string">&quot;widgets&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;subject&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;user&quot;</span><span class="punctuation">:</span><span class="string">&quot;inspector-alice&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="test"><a href="#test" class="headerlink" title="test"></a>test</h2><p><code>OPA</code>的测试很简单。</p><p>所有<code>test_</code>前缀的的规则（<code>rule</code>）都是测试。</p><blockquote><p>Tips: 虽然是测试，但其本质上其仍是规则，任然可以被查询。另外建议文件名遵循<code>_test.rego</code>后缀加以区分</p></blockquote><p>这里拿<code>quick-start</code>的测试例子来看下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">package example_rbac_test</span><br><span class="line"></span><br><span class="line">import data.example_rbac</span><br><span class="line"></span><br><span class="line">test_not_allow &#123;</span><br><span class="line">    not example_rbac.allow with input as &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">test_allow &#123;</span><br><span class="line">  example_rbac.allow with input as &#123;</span><br><span class="line">    &quot;action&quot;: &#123;</span><br><span class="line">      &quot;operation&quot;: &quot;read&quot;,</span><br><span class="line">      &quot;resource&quot;: &quot;widgets&quot;,</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;subject&quot;: &#123;&quot;user&quot;: &quot;inspector-alice&quot;&#125;,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>就这样即覆盖了<code>allow</code>规则的全部测试用例。</p><p>注意这里<code>with</code>起到了数据模拟的作用（<code>data mocking</code>）</p><blockquote><p>Tips: 函数不可用<code>with</code>替换</p></blockquote><p>对应的命令行是：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd quick-start</span><br><span class="line">opa test . -v</span><br><span class="line"># 输出如下</span><br><span class="line">data.example_rbac_test.test_not_allow: PASS (693.201µs)</span><br><span class="line">data.example_rbac_test.test_allow: PASS (562.02µs)</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">PASS: 2/2</span><br></pre></td></tr></table></figure><p>也可以查看测试覆盖率：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">opa test . -c</span><br></pre></td></tr></table></figure><p>设定测试覆盖率标准：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">opa test . -c --threshold 100</span><br></pre></td></tr></table></figure><p>（这里提示下别忘了<code>vscode-opa</code>支持可视化覆盖率展示哦）</p><p>也支持选择测试用例执行：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">opa test -r test_allow . -v</span><br></pre></td></tr></table></figure><h2 id="profile"><a href="#profile" class="headerlink" title="profile"></a>profile</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">cd quick-start</span><br><span class="line">opa eval --profile -d example.rego -d data.json -i input.json -f pretty &quot;data.example_rbac.allow&quot;</span><br><span class="line"></span><br><span class="line">true</span><br><span class="line">+------------------------------+---------+</span><br><span class="line">|            METRIC            |  VALUE  |</span><br><span class="line">+------------------------------+---------+</span><br><span class="line">| timer_rego_data_parse_ns     | 18332   |</span><br><span class="line">| timer_rego_load_files_ns     | 5506307 |</span><br><span class="line">| timer_rego_module_compile_ns | 573408  |</span><br><span class="line">| timer_rego_module_parse_ns   | 5226456 |</span><br><span class="line">| timer_rego_query_compile_ns  | 87390   |</span><br><span class="line">| timer_rego_query_eval_ns     | 292198  |</span><br><span class="line">| timer_rego_query_parse_ns    | 277932  |</span><br><span class="line">+------------------------------+---------+</span><br><span class="line">+----------+----------+----------+-------------------------+</span><br><span class="line">|   TIME   | NUM EVAL | NUM REDO |        LOCATION         |</span><br><span class="line">+----------+----------+----------+-------------------------+</span><br><span class="line">| 54.121µs | 1        | 1        | data.example_rbac.allow |</span><br><span class="line">| 42.776µs | 1        | 2        | example.rego:15         |</span><br><span class="line">| 37.861µs | 1        | 1        | example.rego:9          |</span><br><span class="line">| 35.81µs  | 1        | 1        | example.rego:25         |</span><br><span class="line">| 22.469µs | 1        | 1        | example.rego:10         |</span><br><span class="line">| 21.353µs | 2        | 2        | example.rego:16         |</span><br><span class="line">| 16.888µs | 2        | 1        | example.rego:17         |</span><br><span class="line">| 15.923µs | 2        | 1        | example.rego:23         |</span><br><span class="line">| 14.736µs | 1        | 2        | example.rego:22         |</span><br><span class="line">| 8.798µs  | 1        | 1        | example.rego:24         |</span><br><span class="line">+----------+----------+----------+-------------------------+</span><br></pre></td></tr></table></figure><blockquote><p>Tips: --profile 还支持结果排序和限制显示条数</p><ul><li><code>--profile-sort</code>：对性能分析结果排序，默认按<code>total_time_ns =&gt; num_eval =&gt; num_redo =&gt; file =&gt; line</code>排序, 详见<strong>profile-sort 文档</strong>[1]</li><li><code>--profile-limit</code>：显示几条分析结果，默认 10 条</li></ul></blockquote><h2 id="benchmark"><a href="#benchmark" class="headerlink" title="benchmark"></a>benchmark</h2><p><code>opa</code> 也支持<code>benchmark</code>，基本实现了<code>go</code>的<code>benchmark</code>的使用方式, 甚至有更详细的结果（毕竟一直标榜性能么）</p><p>默认<code>benchmark</code>会展示内存（<code>--benchmem</code>）和查询(<code>--metrics</code>)的基准测试结果</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ opa bench --count 1 -d example.rego -d data.json -i input.json -f pretty &quot;data.example_rbac.allow&quot;</span><br><span class="line">+-------------------------------------------+------------+</span><br><span class="line">| samples                                   |      14162 |</span><br><span class="line">| ns/op                                     |      93655 |</span><br><span class="line">| B/op                                      |      15117 |</span><br><span class="line">| allocs/op                                 |        311 |</span><br><span class="line">| histogram_timer_rego_query_eval_ns_75%    |      89900 |</span><br><span class="line">| histogram_timer_rego_query_eval_ns_90%    |     112253 |</span><br><span class="line">| histogram_timer_rego_query_eval_ns_95%    |     125465 |</span><br><span class="line">| histogram_timer_rego_query_eval_ns_99%    |     222404 |</span><br><span class="line">| histogram_timer_rego_query_eval_ns_99.9%  |     549291 |</span><br><span class="line">| histogram_timer_rego_query_eval_ns_99.99% |     550611 |</span><br><span class="line">| histogram_timer_rego_query_eval_ns_count  |      14162 |</span><br><span class="line">| histogram_timer_rego_query_eval_ns_max    |     550611 |</span><br><span class="line">| histogram_timer_rego_query_eval_ns_mean   |      76735 |</span><br><span class="line">| histogram_timer_rego_query_eval_ns_median |      68336 |</span><br><span class="line">| histogram_timer_rego_query_eval_ns_min    |      38896 |</span><br><span class="line">| histogram_timer_rego_query_eval_ns_stddev |      38828 |</span><br><span class="line">+-------------------------------------------+------------+</span><br></pre></td></tr></table></figure><p>当然也集成到了<code>opa test</code>中</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ opa test -v --bench  example.rego example_test.rego data.json</span><br><span class="line">data.example_rbac_test.test_not_allow      15139             74172 ns/op             62044 timer_rego_query_eval_ns/op     14666 B/op     270 allocs/op</span><br><span class="line">data.example_rbac_test.test_allow          10000            102658 ns/op             90779 timer_rego_query_eval_ns/op     17825 B/op     367 allocs/op</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">PASS: 2/2</span><br></pre></td></tr></table></figure><p>而且<code>--format</code>指定<code>gobench</code>的话，还支持了<strong>benchstat</strong>[2], 是<code>Go</code>亲生的，无疑了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">opa test -v --bench --count 5 --format gobench   example.rego example_test.rego data.json| tee b.txt</span><br><span class="line"></span><br><span class="line">BenchmarkDataExampleRbacTestTestNotAllow           15186             87349 ns/op             73644 timer_rego_query_eval_ns/op     14663 B/op        270 allocs/op</span><br><span class="line">BenchmarkDataExampleRbacTestTestAllow      10000            115857 ns/op            101565 timer_rego_query_eval_ns/op     17828 B/op        367 allocs/op</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">PASS: 2/2</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">benchstat b.txt</span><br><span class="line"></span><br><span class="line">name                             time/op</span><br><span class="line">DataExampleRbacTestTestNotAllow                  92.9µs ±40%</span><br><span class="line">DataExampleRbacTestTestAllow                      123µs ± 8%</span><br><span class="line"></span><br><span class="line">name                             timer_rego_query_eval_ns/op</span><br><span class="line">DataExampleRbacTestTestNotAllow                   79.0k ±41%</span><br><span class="line">DataExampleRbacTestTestAllow                       109k ± 9%</span><br><span class="line"></span><br><span class="line">name                             alloc/op</span><br><span class="line">DataExampleRbacTestTestNotAllow                  14.7kB ± 0%</span><br><span class="line">DataExampleRbacTestTestAllow                     17.8kB ± 0%</span><br><span class="line"></span><br><span class="line">name                             allocs/op</span><br><span class="line">DataExampleRbacTestTestNotAllow                     270 ± 0%</span><br><span class="line">DataExampleRbacTestTestAllow                        367 ± 0%</span><br></pre></td></tr></table></figure><p>基准测试前后对比自然也是支持，如<code>benchstat old.txt new.txt</code>，就不详述了。</p><p>这些工具固然好，高性能还是需要 follow 一些经验法则的</p><p>这里引用官方对于性能优化的建议如下(<strong>key-takeaways</strong>[3])：</p><ul><li><p>编写策略（<code>policy</code>）要最大程度地减少迭代和搜索。</p><ul><li>使用的数组元素有唯一标识符时，改为唯一标识作为 key 的对象。</li><li>考虑利用部分评估（<strong>partial-evaluation</strong>[4]）以将非线性策略编译为线性策略。</li></ul></li><li><p>利用规则索引优化（<strong>rule-indexing</strong>[5]）编写策略，以便规则索引有效。</p></li><li><p>使用探查器(<code>profiler</code>)可帮助确定策略的哪些部分将从提高的性能中受益最大。</p></li><li><p>使用基准测试工具（<code>benchmark tools</code>）来帮助获取真实世界的时序数据并检测策略性能变化。</p></li></ul><blockquote><p>里边提到的<code>partial-evaluation</code>和<code>rule-indexing</code>是保证<code>OPA</code>高性能的两个重要特性，感兴趣的同学可以自行查看下。</p></blockquote><p>下一篇，我们来谈谈<code>OPA</code>的一个重磅功能 - <code>bundle</code>, 一种将策略及数据进行包组织的方式，也支持丰富的管理<code>restful api</code>,适合分布式决策服务的构建。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;script src=&quot;\assets\js\APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;h1 id=&quot;OPA进阶-测试、性能分析和基准测试&quot;&gt;&lt;a href=&quot;#OPA进阶-测试、性能分析和基准测试&quot; class=&quot;headerlink&quot; title=&quot;OPA进阶-</summary>
      
    
    
    
    <category term="microservice" scheme="https://wangyyovo.github.io/categories/microservice/"/>
    
    <category term="opa" scheme="https://wangyyovo.github.io/categories/microservice/opa/"/>
    
    
    <category term="opa" scheme="https://wangyyovo.github.io/tags/opa/"/>
    
  </entry>
  
  <entry>
    <title>OPA进阶-简洁的推导式</title>
    <link href="https://wangyyovo.github.io/posts/b0cdaf3c/"/>
    <id>https://wangyyovo.github.io/posts/b0cdaf3c/</id>
    <published>2022-03-02T09:38:44.000Z</published>
    <updated>2022-03-02T09:38:44.000Z</updated>
    
    <content type="html"><![CDATA[<script src="\assets\js\APlayer.min.js"> </script><h1 id="OPA进阶-简洁的推导式"><a href="#OPA进阶-简洁的推导式" class="headerlink" title="OPA进阶-简洁的推导式"></a>OPA进阶-简洁的推导式</h1><p>我们将以实现判断配置文件数据的不同聚合方式为例展开。</p><p>用到的输入(配置文件列表)为：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// input.json</span></span><br><span class="line"><span class="comment">// posix为常见路径格式</span></span><br><span class="line"><span class="comment">// traditional-mac为mac的一种文件路径格式</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;files&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;posix&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/Users/newbmiao/Documents/1.yaml&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;posix&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/Users/newbmiao/Documents/2.yaml&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;traditional-mac&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Macintosh HD:Users:newbmiao:Documents:3.yml&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;traditional-mac&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Macintosh HD:Users:newbmiao:Documents:3.json&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="comprehensions"><a href="#comprehensions" class="headerlink" title="comprehensions"></a>comprehensions</h2><p>推导式（<code>comprehensions</code>）提供了一种从子查询构建复合值（<code>Composite Values</code>）的简洁方法。</p><p>定义很晦涩，我们从例子来看会清晰许多</p><h3 id="object-comprehensions"><a href="#object-comprehensions" class="headerlink" title="object comprehensions"></a>object comprehensions</h3><p>首先看一个按文件路径类型聚合文件的例子：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">import input.files</span><br><span class="line"></span><br><span class="line">group_files_by_type := &#123;type: paths |</span><br><span class="line">  file := files[_]</span><br><span class="line">  type := file.type</span><br><span class="line">  paths := [path |</span><br><span class="line">    tmp := files[_]</span><br><span class="line">    tmp.type == type</span><br><span class="line">    path := tmp.path</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>即两层遍历，外层遍历获取<code>type</code></p><p>内层遍历按<code>type</code>匹配推导出<code>paths</code>数组</p><p>对应结果为</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">opa eval -f values -d . -i input.json &quot;data.example_comprehensions.group_files_by_type&quot;</span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;posix&quot;: [</span><br><span class="line">      &quot;/Users/newbmiao/Documents/1.yaml&quot;,</span><br><span class="line">      &quot;/Users/newbmiao/Documents/2.yaml&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;traditional-mac&quot;: [</span><br><span class="line">      &quot;Macintosh HD:Users:newbmiao:Documents:3.yml&quot;,</span><br><span class="line">      &quot;Macintosh HD:Users:newbmiao:Documents:3.json&quot;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>忽略实现细节，对象的推导式语法为：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &lt;key&gt;: &lt;term&gt; | &lt;body&gt; &#125;</span><br></pre></td></tr></table></figure><p>定义的<code>key</code>和<code>term</code>需要在<code>body</code>内赋值，最后会复合出一个对象，包含有所有满足的<code>&lt;key&gt;: &lt;term&gt;</code></p><p>这里要注意的事<code>body</code>内条件要都满足才会返回</p><h3 id="array-comprehensions"><a href="#array-comprehensions" class="headerlink" title="array comprehensions"></a>array comprehensions</h3><p>上边例子中<code>paths</code>是一个数组推导式</p><p>其语法为: <code>[ &lt;term&gt; | &lt;body&gt; ]</code></p><p>注意这里的<code>[]</code>， 只有数组推导式用方括号</p><p>而且其内容是<strong>可重复的</strong></p><p>对应再举一个将所有文件路径转为<code>posix</code>的例子：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">convert_all_to_posix_path_array := [path |</span><br><span class="line">  path1 := [p |</span><br><span class="line">    file := files[_]</span><br><span class="line">    file.type == &quot;posix&quot;</span><br><span class="line">    p := file.path</span><br><span class="line">  ]</span><br><span class="line"></span><br><span class="line">  path2 := [p |</span><br><span class="line">    file := files[_]</span><br><span class="line">    file.type == &quot;traditional-mac&quot;</span><br><span class="line">    p := replace(replace(file.path, &quot;Macintosh HD&quot;, &quot;&quot;), &quot;:&quot;, &quot;/&quot;)</span><br><span class="line">  ]</span><br><span class="line"></span><br><span class="line">  paths := array.concat(path1, path2)</span><br><span class="line">  path = paths[_]</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>这里按文件路径类型推导出<code>path1</code>和<code>path2</code>两个数组</p><p>其内部对于<code>file.type</code>的判断达到了过滤匹配的作用</p><h3 id="set-comprehensions"><a href="#set-comprehensions" class="headerlink" title="set comprehensions"></a>set comprehensions</h3><p>上边功能也可以用集合推导式实现如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">convert_all_to_posix_path_sets := &#123;path |</span><br><span class="line">  path1 := &#123;p |</span><br><span class="line">    file := files[_]</span><br><span class="line">    file.type == &quot;posix&quot;</span><br><span class="line">    p := file.path</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  path2 := &#123;p |</span><br><span class="line">    file := files[_]</span><br><span class="line">    file.type == &quot;traditional-mac&quot;</span><br><span class="line">    p := replace(replace(file.path, &quot;Macintosh HD&quot;, &quot;&quot;), &quot;:&quot;, &quot;/&quot;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  paths := path1 | path2</span><br><span class="line">  path = paths[_]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>集合推导式语法为：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &lt;term&gt; | &lt;body&gt; &#125;</span><br></pre></td></tr></table></figure><p>其特点是<strong>不会重复</strong></p><p>可以看出同样功能，集合做组合操作比较表意</p><p>类似的，交集可以用<code>&amp;</code>,差集可以用<code>-</code></p><p>以上就是<code>OPA</code>三类推导式的使用方式。推导式最大的特点就是简洁。</p><p>一旦你熟悉了，就可以写出很多优雅的聚合方式。</p><p>最后出一个题目，大家可以自己练习下(答案可以去<code>opa-koans</code>中查看)</p><p>实现基于文件后缀聚合文件路径, 即输出为：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;json&quot;: [</span><br><span class="line">    &quot;Macintosh HD:Users:newbmiao:Documents:3.json&quot;</span><br><span class="line">  ],</span><br><span class="line">  &quot;yaml&quot;: [</span><br><span class="line">    &quot;/Users/newbmiao/Documents/1.yaml&quot;,</span><br><span class="line">    &quot;/Users/newbmiao/Documents/2.yaml&quot;</span><br><span class="line">  ],</span><br><span class="line">  &quot;yml&quot;: [</span><br><span class="line">    &quot;Macintosh HD:Users:newbmiao:Documents:3.yml&quot;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>提示, 对于文件后缀可以用如下两种方式获取</p><p>方式一：<code>hardcode</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">extSets := [&quot;yaml&quot;, &quot;yml&quot;, &quot;json&quot;]</span><br></pre></td></tr></table></figure><p>方式二：<code>regex</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">extSets := &#123;e |</span><br><span class="line">  e = regex.find_all_string_submatch_n(&quot;.*\\.(.*)$&quot;, files[_].path, -1)[0][1]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;script src=&quot;\assets\js\APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;h1 id=&quot;OPA进阶-简洁的推导式&quot;&gt;&lt;a href=&quot;#OPA进阶-简洁的推导式&quot; class=&quot;headerlink&quot; title=&quot;OPA进阶-简洁的推导式&quot;&gt;&lt;/a&gt;</summary>
      
    
    
    
    <category term="microservice" scheme="https://wangyyovo.github.io/categories/microservice/"/>
    
    <category term="opa" scheme="https://wangyyovo.github.io/categories/microservice/opa/"/>
    
    
    <category term="opa" scheme="https://wangyyovo.github.io/tags/opa/"/>
    
  </entry>
  
  <entry>
    <title>OPA进阶-函数与虚拟文档</title>
    <link href="https://wangyyovo.github.io/posts/ceadba08/"/>
    <id>https://wangyyovo.github.io/posts/ceadba08/</id>
    <published>2022-03-02T09:35:44.000Z</published>
    <updated>2022-03-02T09:35:44.000Z</updated>
    
    <content type="html"><![CDATA[<script src="\assets\js\APlayer.min.js"> </script><h1 id="OPA进阶-函数与虚拟文档"><a href="#OPA进阶-函数与虚拟文档" class="headerlink" title="OPA进阶-函数与虚拟文档"></a>OPA进阶-函数与虚拟文档</h1><p>本文来讲讲<code>OPA</code>常用的函数（<code>function</code>）和虚拟文档（<code>virtual document</code>），以及他们使用的场景。</p><p>我们将以实现判断配置文件为例展开。</p><p><strong>文章目录</strong></p><ul><li>函数</li><li>虚拟文档</li><li>适用场景</li></ul><p>用到的输入(配置文件列表)为：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// input.json</span></span><br><span class="line"><span class="comment">// posix为常见路径格式</span></span><br><span class="line"><span class="comment">// traditional-mac为mac的一种文件路径格式</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;files&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;posix&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/Users/newbmiao/Documents/1.yaml&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;posix&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/Users/newbmiao/Documents/2.yaml&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;traditional-mac&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Macintosh HD:Users:newbmiao:Documents:3.yml&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;traditional-mac&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Macintosh HD:Users:newbmiao:Documents:3.json&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h2><p>函数基本每个语言都会有，要说<code>OPA</code>里有啥特别的地方，那就是他也实现同名函数，类似“函数重载”，但简化了许多。</p><p>他的特点是：</p><ul><li>默认函数返回值为 true&#x2F;false</li><li>可以指定函数返回值</li><li>可以存在同名函数, 但参数数目不能变</li><li>相同输入（参数）必须获得相同输出（返回值）</li></ul><p>举例来说，如果实现判断文件是否是配置文件后缀：</p><p>下边<code>is_config_file</code>就是不指定返回值</p><p>条件满足则返回 true，三个实现只要满足一个就为 true</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">is_config_file(str) &#123;</span><br><span class="line">  contains(str, &quot;.yaml&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">is_config_file(str) &#123;</span><br><span class="line">  contains(str, &quot;.yml&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">is_config_file(str) &#123;</span><br><span class="line">  contains(str, &quot;.json&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当然也可以使用<code>else</code>关键字合并到一个函数：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">is_config_file2(str) &#123;</span><br><span class="line">  contains(str, &quot;.yaml&quot;)</span><br><span class="line">&#125;</span><br><span class="line">else &#123;</span><br><span class="line">  contains(str, &quot;.yml&quot;)</span><br><span class="line">&#125;</span><br><span class="line">else &#123;</span><br><span class="line">  contains(str, &quot;.json&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>那如果指定返回值怎么重载呢？</p><p>以实现不同路径格式的文件名为例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">getFileName(type, str) = x &#123;</span><br><span class="line">  type = &quot;posix&quot;</span><br><span class="line">  str = trim(str)</span><br><span class="line">  tmp := split(str, &quot;/&quot;)</span><br><span class="line">  x := tmp[minus(count(tmp), 1)]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">getFileName(type, str) = x &#123;</span><br><span class="line">  type = &quot;traditional-mac&quot;</span><br><span class="line">  str = trim(str)</span><br><span class="line">  tmp := split(str, &quot;:&quot;)</span><br><span class="line">  x := tmp[minus(count(tmp), 1)]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>你会发现两个函数输入和返回不是相同的么？</p><p>其实不是，仔细看他们内都做了 </p><p><code>type = &#123;&quot;traditional-mac&quot;|&quot;posix&quot;&#125;</code> 的判断</p><p>这实际类似函数声明为 </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getFileName(&quot;posix&quot;, str) = x &#123;&#125;</span><br></pre></td></tr></table></figure><p>所以输入是不同的</p><p>如果你省略了<code>type</code>的判断，会报错的：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eval_conflict_error: functions must not produce multiple outputs for same inputs</span><br></pre></td></tr></table></figure><p>到此，将函数组合一下就可以实现判定是否为配置：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">import input.files</span><br><span class="line"></span><br><span class="line">is_config &#123;</span><br><span class="line">  file := files[_]</span><br><span class="line">  x := getFileName(file.type, file.path)</span><br><span class="line">  is_config_file(x)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>Tips: 关于<code>OPA</code>的内置函数可以查看文档:<strong>built-in-functions</strong>[1]</p></blockquote><h2 id="虚拟文档"><a href="#虚拟文档" class="headerlink" title="虚拟文档"></a>虚拟文档</h2><p>虚拟文档是生成的文档（或者称为<strong>集合</strong>）</p><p>他的特点是：</p><ul><li>作为集合，输入和输出必须是有限的</li><li>可以遍历</li><li>可以查询</li></ul><p>举例来说，同样是获取文件名：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">import input.files</span><br><span class="line"></span><br><span class="line">getFileNames[x] &#123;</span><br><span class="line">  file := files[_]</span><br><span class="line">  file.type = &quot;posix&quot;</span><br><span class="line">  file.path = trim(file.path)</span><br><span class="line">  tmp := split(file.path, &quot;/&quot;)</span><br><span class="line">  x := tmp[minus(count(tmp), 1)]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">getFileNames[x] &#123;</span><br><span class="line">  file := files[_]</span><br><span class="line">  file.type = &quot;traditional-mac&quot;</span><br><span class="line">  file.path = trim(file.path)</span><br><span class="line">  tmp := split(file.path, &quot;:&quot;)</span><br><span class="line">  x := tmp[minus(count(tmp), 1)]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里 <code>getFileNames[x] &#123;&#125;</code> 等价于 <code>getFileNames[x] = x &#123;&#125;</code></p><p>就是<code>x</code>作为了集合的一个结果，填充到<code>getFileNames</code>这个虚拟文档中，其<code>key</code>也是<code>x</code>的值。</p><p>有点抽象是不？</p><p>别怕，他可以查询，我们查询看下他的结果就好理解了</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir syntax</span><br></pre></td></tr></table></figure><p>comprehensions.rego</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">package example_comprehensions</span><br><span class="line"></span><br><span class="line">import input.files</span><br><span class="line"></span><br><span class="line"># object comprehensions</span><br><span class="line"># &#123; &lt;key&gt;: &lt;term&gt; | &lt;body&gt; &#125;</span><br><span class="line">group_files_by_type := &#123;type: paths |</span><br><span class="line">file := files[_]</span><br><span class="line">type := file.type</span><br><span class="line">paths := [path |</span><br><span class="line">tmp := files[_]</span><br><span class="line">tmp.type == type</span><br><span class="line">path := tmp.path</span><br><span class="line">]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># object comprehensions</span><br><span class="line"># &#123; &lt;key&gt;: &lt;term&gt; | &lt;body&gt; &#125;</span><br><span class="line">group_files_by_file_extension := &#123;ext: paths |</span><br><span class="line"># set: [&quot;yaml&quot;, &quot;yml&quot;, &quot;json&quot;]</span><br><span class="line">extSets := &#123;e |</span><br><span class="line">e = regex.find_all_string_submatch_n(&quot;.*\\.(.*)$&quot;, files[_].path, -1)[0][1]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ext := extSets[_]</span><br><span class="line">paths := [path |</span><br><span class="line">tmp := files[_]</span><br><span class="line">endswith(tmp.path, ext)</span><br><span class="line">path := tmp.path</span><br><span class="line">]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># set comprehensions</span><br><span class="line"># &#123; &lt;term&gt; | &lt;body&gt; &#125;</span><br><span class="line">convert_all_to_posix_path_sets := &#123;path |</span><br><span class="line">path1 := &#123;p |</span><br><span class="line">file := files[_]</span><br><span class="line">file.type == &quot;posix&quot;</span><br><span class="line">p := file.path</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">path2 := &#123;p |</span><br><span class="line">file := files[_]</span><br><span class="line">file.type == &quot;traditional-mac&quot;</span><br><span class="line">p := replace(replace(file.path, &quot;Macintosh HD&quot;, &quot;&quot;), &quot;:&quot;, &quot;/&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">paths := path1 | path2</span><br><span class="line">path = paths[_]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># array comprehensions</span><br><span class="line"># [ &lt;term&gt; | &lt;body&gt; ]</span><br><span class="line">convert_all_to_posix_path_array := [path |</span><br><span class="line">path1 := [p |</span><br><span class="line">file := files[_]</span><br><span class="line">file.type == &quot;posix&quot;</span><br><span class="line">p := file.path</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">path2 := [p |</span><br><span class="line">file := files[_]</span><br><span class="line">file.type == &quot;traditional-mac&quot;</span><br><span class="line">p := replace(replace(file.path, &quot;Macintosh HD&quot;, &quot;&quot;), &quot;:&quot;, &quot;/&quot;)</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">paths := array.concat(path1, path2)</span><br><span class="line">path = paths[_]</span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>function.rego</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">package example_func</span><br><span class="line"></span><br><span class="line">import input.files</span><br><span class="line"></span><br><span class="line">is_config &#123;</span><br><span class="line">file := files[_]</span><br><span class="line">x := getFileName(file.type, file.path)</span><br><span class="line">is_config_file(x)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># or</span><br><span class="line"># is_config_file2(x)</span><br><span class="line"></span><br><span class="line"># function&#x27;s input/output can be infinite</span><br><span class="line">getFileName(type, str) = x &#123;</span><br><span class="line">type = &quot;posix&quot; # this is needed, without will report error :</span><br><span class="line"></span><br><span class="line"># eval_conflict_error: functions must not produce multiple outputs for same inputs</span><br><span class="line">str = trim(str)</span><br><span class="line">tmp := split(str, &quot;/&quot;)</span><br><span class="line">x := tmp[count(tmp) - 1]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">getFileName(type, str) = x &#123;</span><br><span class="line">type = &quot;traditional-mac&quot; # this is needed, without will report error</span><br><span class="line">str = trim(str)</span><br><span class="line">tmp := split(str, &quot;:&quot;)</span><br><span class="line">x := tmp[count(tmp) - 1]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># Or</span><br><span class="line"># getFileName(&quot;posix&quot;, str) = x &#123;</span><br><span class="line"># str = trim(str)</span><br><span class="line"># tmp := split(str, &quot;/&quot;)</span><br><span class="line"># x := tmp[minus(count(tmp), 1)]</span><br><span class="line"># &#125;</span><br><span class="line"></span><br><span class="line"># getFileName(&quot;traditional-mac&quot;, str) = x &#123;</span><br><span class="line"># str = trim(str)</span><br><span class="line"># tmp := split(str, &quot;:&quot;)</span><br><span class="line"># x := tmp[minus(count(tmp), 1)]</span><br><span class="line"># &#125;</span><br><span class="line"></span><br><span class="line">is_config_file(str) &#123;</span><br><span class="line">contains(str, &quot;.yaml&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">is_config_file(str) &#123;</span><br><span class="line">contains(str, &quot;.yml&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">is_config_file(str) &#123;</span><br><span class="line">contains(str, &quot;.json&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">is_config_file2(str) &#123;</span><br><span class="line">contains(str, &quot;.yaml&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">else &#123;</span><br><span class="line">contains(str, &quot;.yml&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">else &#123;</span><br><span class="line">contains(str, &quot;.json&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>virtualDocument.rego</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">package example_virtual_doc</span><br><span class="line"></span><br><span class="line">import data.example_func.is_config_file</span><br><span class="line">import input.files</span><br><span class="line"></span><br><span class="line">is_config &#123;</span><br><span class="line">is_config_file(getFileNames[_])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># virtual document&#x27;s input/output is finite, and is generated document,  can be query, support iteration, will be output</span><br><span class="line">getFileNames[x] &#123;</span><br><span class="line">file := files[_]</span><br><span class="line">file.type = &quot;posix&quot;</span><br><span class="line">file.path = trim(file.path)</span><br><span class="line">tmp := split(file.path, &quot;/&quot;)</span><br><span class="line">x := tmp[count(tmp) - 1]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">getFileNames[x] &#123;</span><br><span class="line">file := files[_]</span><br><span class="line">file.type = &quot;traditional-mac&quot;</span><br><span class="line">file.path = trim(file.path)</span><br><span class="line">tmp := split(file.path, &quot;:&quot;)</span><br><span class="line">x := tmp[count(tmp) - 1]</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>input.json</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;files&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;posix&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/Users/newbmiao/Documents/1.yaml&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;posix&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/Users/newbmiao/Documents/2.yaml&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;traditional-mac&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Macintosh HD:Users:newbmiao:Documents:3.yml&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;traditional-mac&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Macintosh HD:Users:newbmiao:Documents:3.json&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cd syntax</span><br><span class="line">opa eval -f values -i input.json -d . &quot;data.example_virtual_doc.getFileNames&quot;</span><br><span class="line">[</span><br><span class="line">  [</span><br><span class="line">    &quot;1.yaml&quot;,</span><br><span class="line">    &quot;2.yaml&quot;,</span><br><span class="line">    &quot;3.yml&quot;,</span><br><span class="line">    &quot;3.json&quot;</span><br><span class="line">  ]</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>然后<strong>遍历</strong>虚拟文档，结合判定<code>is_config_file</code>就可实现判定：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">import data.example_func.is_config_file</span><br><span class="line">import input.files</span><br><span class="line"></span><br><span class="line">is_config &#123;</span><br><span class="line">  is_config_file(getFileNames[_])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里遍历<code>getFileNames[_]</code>,随即作为每一个输入参数传给<code>is_config_file</code>进行判断，是不是很方便！</p><h2 id="适用场景"><a href="#适用场景" class="headerlink" title="适用场景"></a>适用场景</h2><p>具体到他们的适用场景，其实比较好区分，重点只要关注两点：</p><ul><li>是否需要<strong>遍历</strong>？</li><li>输入输出是否是<strong>有限</strong>的？</li></ul><p>如果有一个答案是肯定的，那么虚拟文档就更适合。</p><p><code>OPA</code>的函数和虚拟文档很简单、很清秀是不是？</p><p>今天就到这里，下一篇我们看看他更优雅的推导式（<code>Comprehensions</code>）。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;script src=&quot;\assets\js\APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;h1 id=&quot;OPA进阶-函数与虚拟文档&quot;&gt;&lt;a href=&quot;#OPA进阶-函数与虚拟文档&quot; class=&quot;headerlink&quot; title=&quot;OPA进阶-函数与虚拟文档&quot;&gt;&lt;</summary>
      
    
    
    
    <category term="microservice" scheme="https://wangyyovo.github.io/categories/microservice/"/>
    
    <category term="opa" scheme="https://wangyyovo.github.io/categories/microservice/opa/"/>
    
    
    <category term="opa" scheme="https://wangyyovo.github.io/tags/opa/"/>
    
  </entry>
  
  <entry>
    <title>如何优雅的使用opa进行开发</title>
    <link href="https://wangyyovo.github.io/posts/74b42414/"/>
    <id>https://wangyyovo.github.io/posts/74b42414/</id>
    <published>2022-03-02T09:32:44.000Z</published>
    <updated>2022-03-02T09:32:44.000Z</updated>
    
    <content type="html"><![CDATA[<script src="\assets\js\APlayer.min.js"> </script><h1 id="如何优雅的使用opa进行开发"><a href="#如何优雅的使用opa进行开发" class="headerlink" title="如何优雅的使用opa进行开发"></a>如何优雅的使用opa进行开发</h1><h2 id="opa"><a href="#opa" class="headerlink" title="opa"></a>opa</h2><p><code>opa</code>（命令行工具）现在迭代比较快，为了性能和一些丰富的内置函数，推荐使用最新版</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">mac</span></span><br><span class="line">curl -L -o opa https://openpolicyagent.org/downloads/latest/opa_darwin_amd64</span><br><span class="line">chmod +x opa</span><br><span class="line">mv opa /usr/local/bin/opa</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">other</span></span><br><span class="line">go install github.com/open-policy-agent/opa@latest</span><br></pre></td></tr></table></figure><p>查看命令帮助</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$ ./opa -h</span><br><span class="line">An open source project to policy-enable your service.</span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line">  E:\goproject\gopath\bin\opa.exe [command]</span><br><span class="line"></span><br><span class="line">Available Commands:</span><br><span class="line">  bench       Benchmark a Rego query</span><br><span class="line">  build       Build an OPA bundle</span><br><span class="line">  check       Check Rego source files</span><br><span class="line">  completion  Generate the autocompletion script for the specified shell</span><br><span class="line">  deps        Analyze Rego query dependencies</span><br><span class="line">  eval        Evaluate a Rego query</span><br><span class="line">  exec        Execute against input files</span><br><span class="line">  fmt         Format Rego source files</span><br><span class="line">  help        Help about any command</span><br><span class="line">  inspect     Inspect OPA bundle(s)</span><br><span class="line">  parse       Parse Rego source file</span><br><span class="line">  run         Start OPA in interactive or server mode</span><br><span class="line">  sign        Generate an OPA bundle signature</span><br><span class="line">  test        Execute Rego test cases</span><br><span class="line">  version     Print the version of OPA</span><br><span class="line"></span><br><span class="line">Flags:</span><br><span class="line">  -h, --help   help for E:\goproject\gopath\bin\opa.exe</span><br><span class="line"></span><br><span class="line">Use &quot;E:\goproject\gopath\bin\opa.exe [command] --help&quot; for more information about a command.</span><br></pre></td></tr></table></figure><p>看介绍能知道每个命令是干啥的，用到时具体看 help 就行</p><p>这里边挑常用的命令讲下：</p><h3 id="run"><a href="#run" class="headerlink" title="run"></a>run</h3><p><code>opa run</code>是<code>OPA</code>实现的<strong>交互式运行</strong>（<code>REPL</code>）命令，本地学习或者调试会很方便</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir quick-start</span><br></pre></td></tr></table></figure><p>data.json</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;roles&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;operation&quot;</span><span class="punctuation">:</span> <span class="string">&quot;read&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;widgets&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;widget-reader&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;operation&quot;</span><span class="punctuation">:</span> <span class="string">&quot;write&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;widgets&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;widget-writer&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;bindings&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;user&quot;</span><span class="punctuation">:</span> <span class="string">&quot;inspector-alice&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;role&quot;</span><span class="punctuation">:</span> <span class="string">&quot;widget-reader&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;user&quot;</span><span class="punctuation">:</span> <span class="string">&quot;maker-bob&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;role&quot;</span><span class="punctuation">:</span> <span class="string">&quot;widget-writer&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>example.rego</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">package example_rbac</span><br><span class="line"></span><br><span class="line">default allow = false</span><br><span class="line"></span><br><span class="line"># allow will be true when user has role and role has permission</span><br><span class="line">allow &#123;</span><br><span class="line"># opa eval -f pretty -d quick-start -i quick-start/input.json &quot;data.example_rbac.allow&quot; --explain=notes</span><br><span class="line"># trace(role_name)</span><br><span class="line">some role_name</span><br><span class="line">user_has_role[role_name]</span><br><span class="line">role_has_permission[role_name]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># check user role binding exist</span><br><span class="line">user_has_role[role_name] &#123;</span><br><span class="line">role_binding = data.bindings[_]</span><br><span class="line">role_binding.role = role_name</span><br><span class="line">role_binding.user == input.subject.user</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># check role permission exist</span><br><span class="line">role_has_permission[role_name] &#123;</span><br><span class="line">role = data.roles[_]</span><br><span class="line">role.name = role_name</span><br><span class="line">role.operation == input.action.operation</span><br><span class="line">role.resource == input.action.resource</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>example_test.rego</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">package example_rbac_test</span><br><span class="line"></span><br><span class="line">import data.example_rbac</span><br><span class="line"></span><br><span class="line"># tests to coverage 100%</span><br><span class="line"></span><br><span class="line">test_not_allow &#123;</span><br><span class="line">not example_rbac.allow with input as &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">test_allow &#123;</span><br><span class="line">example_rbac.allow with input as &#123;</span><br><span class="line">&quot;action&quot;: &#123;</span><br><span class="line">&quot;operation&quot;: &quot;read&quot;,</span><br><span class="line">&quot;resource&quot;: &quot;widgets&quot;,</span><br><span class="line">&#125;,</span><br><span class="line">&quot;subject&quot;: &#123;&quot;user&quot;: &quot;inspector-alice&quot;&#125;,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>input.json</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;action&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;operation&quot;</span><span class="punctuation">:</span><span class="string">&quot;read&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;resource&quot;</span><span class="punctuation">:</span><span class="string">&quot;widgets&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;subject&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;user&quot;</span><span class="punctuation">:</span><span class="string">&quot;inspector-alice&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>运行opa</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">opa run quick-start</span></span><br><span class="line">OPA 0.37.2 (commit , built at )</span><br><span class="line">Run &#x27;help&#x27; to see a list of commands and check for updates.</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">获取上下文</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">data</span></span><br><span class="line">&#123;</span><br><span class="line">  &quot;action&quot;: &#123;</span><br><span class="line">    &quot;operation&quot;: &quot;read&quot;,</span><br><span class="line">    &quot;resource&quot;: &quot;widgets&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>你会得到 json 格式的 data 下的所有节点内容</p><p>主要有两类，所有<code>quick-start</code>目录下的</p><ul><li><p>配置文件（<code>.json|.yaml|.yml</code>）</p><p>对应的父节点是<code>data</code></p></li><li><p><code>Rego</code>文件(包括 test 文件)</p></li></ul><p>对应的父节点是<code>data.&lt;package name&gt;</code></p><blockquote><p>Tips: 这样配置文件都挂在<code>data</code>这个根节点下了。</p><p>如果想加载配置文件时增加父节点（如<code>data.example.file</code>）该怎么办？</p><p>可以文件的路径映射前缀 <code>opa run example.file:quick-start</code>注意<strong>只会改变配置文件</strong>的父节点</p><p>这一点很有用，以后讲<code>bundle</code>也会提到</p></blockquote><p>当然也可以指定输入文件<code>input</code>。这个比较特殊，命令行保留了包前缀<code>repl.input</code>给<code>input</code></p><p>也就是说，可以用<code>repl.input:&lt;path to input.json&gt;</code>的方式传递输入，而避免挂载到<code>data</code>根节点下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">opa run quick-start  repl.input:quick-start/input.json</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">data.example_rbac</span></span><br><span class="line">&#123;</span><br><span class="line">  &quot;allow&quot;: true,</span><br><span class="line">  &quot;role_has_permission&quot;: [</span><br><span class="line">    &quot;widget-reader&quot;</span><br><span class="line">  ],</span><br><span class="line">  &quot;user_has_role&quot;: [</span><br><span class="line">    &quot;widget-reader&quot;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>Tips: <code>-w</code>支持交互式窗口内实时文件变更 reload</p><p><code>-s</code>支持服务常驻式启动，启动后可以 REST-Api 查询；</p></blockquote><h3 id="eval"><a href="#eval" class="headerlink" title="eval"></a>eval</h3><p><code>opa eval</code>是用来查询策略结果</p><p><code>-d</code> 指定上下文，<code>-i</code> 指定输入 <code>-f</code> 指定返回格式，默认 json，还支持<code>values,bindings,pretty,source</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">opa eval -f values -d quick-start -i quick-start/input.json &quot;data.example_rbac&quot;</span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;allow&quot;: true,</span><br><span class="line">    &quot;role_has_permission&quot;: [</span><br><span class="line">      &quot;widget-reader&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;user_has_role&quot;: [</span><br><span class="line">      &quot;widget-reader&quot;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><blockquote><p>Tips: 还支持性能分析 <code>--metrics</code>, <code>--instrument</code>, <code>--profile</code></p></blockquote><h3 id="deps"><a href="#deps" class="headerlink" title="deps"></a>deps</h3><p><code>opa deps</code> 用来分析查询依赖</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ opa deps -d quick-start &quot;data.example_rbac&quot;</span><br><span class="line">+------------------------+---------------------------------------+</span><br><span class="line">|     BASE DOCUMENTS     |           VIRTUAL DOCUMENTS           |</span><br><span class="line">+------------------------+---------------------------------------+</span><br><span class="line">| data.bindings          | data.example_rbac.allow               |</span><br><span class="line">| data.roles             | data.example_rbac.role_has_permission |</span><br><span class="line">| input.action.operation | data.example_rbac.user_has_role       |</span><br><span class="line">| input.action.resource  |                                       |</span><br><span class="line">| input.subject.user     |                                       |</span><br><span class="line">+------------------------+---------------------------------------+</span><br></pre></td></tr></table></figure><h3 id="test"><a href="#test" class="headerlink" title="test"></a>test</h3><p><code>opa test</code> 用来跑测试，<code>-c</code>支持输出覆盖率，<code>--threshold</code> 可指定通过覆盖率</p><h3 id="check-fmt"><a href="#check-fmt" class="headerlink" title="check &amp; fmt"></a>check &amp; fmt</h3><p><code>opa check</code> 是语法检查;<code>opa fmt</code>是格式化</p><h2 id="vscode-opa"><a href="#vscode-opa" class="headerlink" title="vscode-opa"></a>vscode-opa</h2><p>命令虽少可还是要记啊，有没有不用敲命令这么费劲的</p><p>有！官方强大的交互式编辑器扩展<strong>vscode-opa</strong>，了解下~~</p><p>安装后只要在<code>vscode</code>的配置里指定<code>OPA</code>执行文件路径就可以用了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;opa.path&quot;: &quot;/usr/local/bin/opa&quot;</span><br></pre></td></tr></table></figure><h3 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h3><p>它基本支持上述大部分命令功能：</p><ul><li>在保存时检查语法（Check Syntax on Save）</li><li>计算包结果（Evaluate Packages）</li><li>计算选择部分结果（Evaluate Selections）</li><li>部分评估选择（Partially Evaluate Selections）</li><li>对选择部分代码运行追踪（Trace Selections）</li><li>对选择部分性能分析（Profile Selections）</li><li>在工作区中运行测试（Run Tests in Workspace）</li><li>切换工作区的测试覆盖（Toggle Coverage in Workspace）</li><li>切换选择部分的测试覆盖（Toggle Coverage of Selections）</li></ul><p>其中评估（<code>Evaluate</code>)和测试覆盖显示（<code>Coverage</code>）在日常开发中很实用</p><h3 id="快捷键配置"><a href="#快捷键配置" class="headerlink" title="快捷键配置"></a>快捷键配置</h3><p>这里可以配置用户快捷键方便直接调起命令：</p><p>（官方推荐的前两个<code>Evaluate</code>的，后边<code>Test</code>相关的也可以加上）</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cmd+e&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;opa.eval.selection&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;when&quot;</span><span class="punctuation">:</span> <span class="string">&quot;editorLangId == rego&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;shift+cmd+a&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;opa.eval.package&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;when&quot;</span><span class="punctuation">:</span> <span class="string">&quot;editorLangId == rego&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;shift+cmd+c&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;opa.test.coverage.workspace&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;when&quot;</span><span class="punctuation">:</span> <span class="string">&quot;editorLangId == rego&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;shift+cmd+t&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;opa.test.workspace&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;when&quot;</span><span class="punctuation">:</span> <span class="string">&quot;editorLangId == rego&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure><blockquote><p>Tip: 插件默认<strong>只取项目根目录</strong>的<code>input.json</code>作为输入</p><p>配置<code>opa.bundleMode</code>默认为 true，则会<strong>只获取目录</strong>里的所有<code>data.&#123;json|yaml&#125;</code></p><p>如果设置为 false，则会获取目录中所有<code>.&#123;json|yaml&#125;</code></p></blockquote><p>好了，现在可以优雅的使用<code>opa</code>开发了。</p><p>下一篇我们来讲讲<code>OPA</code>的函数和虚拟文档，了解下他们各自适用的场景。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;script src=&quot;\assets\js\APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;h1 id=&quot;如何优雅的使用opa进行开发&quot;&gt;&lt;a href=&quot;#如何优雅的使用opa进行开发&quot; class=&quot;headerlink&quot; title=&quot;如何优雅的使用opa进行开发</summary>
      
    
    
    
    <category term="microservice" scheme="https://wangyyovo.github.io/categories/microservice/"/>
    
    <category term="opa" scheme="https://wangyyovo.github.io/categories/microservice/opa/"/>
    
    
    <category term="opa" scheme="https://wangyyovo.github.io/tags/opa/"/>
    
  </entry>
  
  <entry>
    <title>OPA-重新定义规则引擎-入门篇</title>
    <link href="https://wangyyovo.github.io/posts/75a3be3b/"/>
    <id>https://wangyyovo.github.io/posts/75a3be3b/</id>
    <published>2022-03-02T09:30:44.000Z</published>
    <updated>2022-03-02T09:30:44.000Z</updated>
    
    <content type="html"><![CDATA[<script src="\assets\js\APlayer.min.js"> </script><h1 id="OPA-重新定义规则引擎-入门篇"><a href="#OPA-重新定义规则引擎-入门篇" class="headerlink" title="OPA-重新定义规则引擎-入门篇"></a>OPA-重新定义规则引擎-入门篇</h1><p><code>OPA</code>，全称<code>OpenPolicyAgent</code>, 底层用<code>Go</code>实现，它灵活而强大的声明式语言全面支持通用策略定义。</p><h2 id="什么是-OPA"><a href="#什么是-OPA" class="headerlink" title="什么是 OPA"></a>什么是 OPA</h2><p>主要关键词是：</p><ul><li>轻量级的通用策略引擎</li><li>可与服务共存</li><li>集成方式可以是 sidecar、主机级守护进程或库引入</li></ul><p><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/blog/opa/opa-service.png">opa</p><p>文字图片还是不够生动，看看 OPA 作者怎么说：</p><p><a href="https://www.bilibili.com/video/BV1AE411V7Hs?p=1">https://www.bilibili.com/video/BV1AE411V7Hs?p=1</a></p><p><a href="https://www.bilibili.com/video/BV1AE411V7Hs?p=2">https://www.bilibili.com/video/BV1AE411V7Hs?p=2</a></p><p><a href="https://space.bilibili.com/384023450">https://space.bilibili.com/384023450</a></p><h2 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h2><ul><li><p>强大的声明式策略</p><ul><li>上下文感知</li></ul><ul><li>表达性强</li><li>快速</li><li>可移植</li></ul></li><li><p>输入和输出支持任意格式</p><p>配合强大的声明式策略语言<code>Rego</code>，描述任意规则都不是问题</p></li><li><p>全面支持规则和系统解耦</p></li></ul><p><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/blog/opa/decouple.png">如图</p><ul><li><p>集承方式多</p><ul><li>Daemon 式服务</li></ul><ul><li>Go 类库引入</li></ul></li><li><p>决策快</p><ul><li><strong>rule indexing</strong></li></ul><ul><li><strong>partial evaluatio</strong></li></ul></li><li><p>应用广泛</p><p>除了集成做<code>Auth</code>外，还可以应用到<code>k8s,terraform,docker,kafka,sql,linux</code>等上做规则决策</p></li><li><p>工具齐全</p><ul><li>有命令行，有交互式运行环境</li></ul><ul><li>支持测试，性能分析（底层<code>Go</code>实现）</li><li>有强大的交互式编辑器扩展<strong>vscode-opa</strong>[4]</li><li>有<strong>playground</strong>[5]分享代码</li></ul></li></ul><p>下面从一个 RBAC 鉴权例子来了解下<code>OPA</code></p><h2 id="一个-RBAC-例子"><a href="#一个-RBAC-例子" class="headerlink" title="一个 RBAC 例子"></a>一个 RBAC 例子</h2><p>以下 json 配置了 role 能操作的资源和 user 的绑定关系</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// data.json</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;roles&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;operation&quot;</span><span class="punctuation">:</span> <span class="string">&quot;read&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;widgets&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;widget-reader&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;operation&quot;</span><span class="punctuation">:</span> <span class="string">&quot;write&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;widgets&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;widget-writer&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;bindings&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;user&quot;</span><span class="punctuation">:</span> <span class="string">&quot;inspector-alice&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;role&quot;</span><span class="punctuation">:</span> <span class="string">&quot;widget-reader&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;user&quot;</span><span class="punctuation">:</span> <span class="string">&quot;maker-bob&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;role&quot;</span><span class="punctuation">:</span> <span class="string">&quot;widget-writer&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>当一个请求读取 widgets 的 user（如下 json）过来操作资源，怎么判定他是否可以呢？</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// input.json</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;action&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;operation&quot;</span><span class="punctuation">:</span><span class="string">&quot;read&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;resource&quot;</span><span class="punctuation">:</span><span class="string">&quot;widgets&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;subject&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;user&quot;</span><span class="punctuation">:</span><span class="string">&quot;inspector-alice&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>可能你习惯性在想用自己趁手的语言和框架，一顿遍历循环搞定。</p><p>且慢，<code>OPA</code>告诉我们：</p><p>几行代码就可以！（当然代码少不是重点。。。）</p><p>这里是可以在线运行的<strong>代码示例</strong></p><p><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/blog/opa/2022-03-02_173048.png"></p><p>我们先抛开语法，代码其实就是<strong>描述</strong>了一条规则：</p><p><strong>用户是否有角色，角色是否有权限操作的资源</strong></p><p>下面我们开始学习<code>OPA</code>如何定义这条规则</p><h3 id="基本语法"><a href="#基本语法" class="headerlink" title="基本语法"></a>基本语法</h3><p><code>OPA</code>基于一种数据查询语言<strong>Datalog</strong>实现了描述语言&#96;Rego</p><p><code>OPA</code>的<code>Rego</code>基本语法如下表：</p><table><thead><tr><th align="left">语法</th><th align="left">例子</th></tr></thead><tbody><tr><td align="left">上下文</td><td align="left">data</td></tr><tr><td align="left">输入</td><td align="left">input</td></tr><tr><td align="left">索引取值</td><td align="left">data.bindings[0]</td></tr><tr><td align="left">比较</td><td align="left">&quot;alice&quot; &#x3D;&#x3D; input.subject.user</td></tr><tr><td align="left">赋值</td><td align="left">user :&#x3D; input.subject.user</td></tr><tr><td align="left">规则</td><td align="left">&lt; Header &gt; { &lt; Body &gt; }</td></tr><tr><td align="left">规则头</td><td align="left">&lt; Name &gt; &#x3D; &lt; Value &gt; { ... } 或者 &lt; Name &gt; { ... }</td></tr><tr><td align="left">规则体</td><td align="left">And 运算的一个个描述</td></tr><tr><td align="left">多条同名规则</td><td align="left">Or 运算的一个规则</td></tr><tr><td align="left">规则默认值</td><td align="left">default allow &#x3D; false</td></tr><tr><td align="left">函数</td><td align="left">fun(x) { ... }</td></tr><tr><td align="left">虚拟文档</td><td align="left">doc[x] { ... }</td></tr></tbody></table><p>一点也不多。函数和虚拟文档我们后边再开文章展开，今天主要看明白他的规则定义。</p><p>首先<strong>输入</strong>会挂在<code>input</code>对象下，用到的<strong>上下文</strong>（就是规则决策基于的源数据）会挂在<code>data</code>对象下</p><h3 id="rule"><a href="#rule" class="headerlink" title="rule"></a>rule</h3><p>当定义规则时：</p><ul><li><p>每条规则都会有返回值</p><p>不声明返回值，则只返回 true 或 false</p><p>声明返回值 <code>&lt; Value &gt;</code> 则返回其值</p><ul><li>格式 2 <code>&lt; Name &gt; = &lt; Value &gt; &#123; ... &#125;</code></li></ul><ul><li>格式 1：<code>&lt; Name &gt; &#123; ... &#125;</code></li></ul></li><li><p>规则体内每条描述会逐条<code>And</code>运算，全部成立才会返回值</p></li><li><p>多条<strong>同名</strong>规则相互之间是<code>Or</code>运算，满足其一即可</p></li></ul><p>具体到代码中规则<code>allow</code>, 默认值是 false</p><p>要求<code>user_has_role</code>和<code>role_has_permission</code>同时满足</p><p>两者的<code>role_name</code>也是一样。</p><p>你可能发现，局部变量<code>role_name</code> 没声明啊！</p><p><code>Rego</code>里可以省略声明局部变量, 直接使用。</p><blockquote><p>Tips: 但要这样的变量可以被<strong>同名的全局变量</strong>修改。</p><p>局部变量必要时还是应该使用<code>some</code>声明 如: <code>some role_name</code></p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">default allow = false</span><br><span class="line"></span><br><span class="line"># allow will be true when user has role and role has permission</span><br><span class="line">allow &#123;</span><br><span class="line">  user_has_role[role_name]</span><br><span class="line">  role_has_permission[role_name]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后其中<code>user_has_role[role_name]</code>这种带参数的结构不是规则，叫虚拟文档(<strong>文档：可被查询的集合</strong>)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># check user role binding exist</span><br><span class="line">user_has_role[role_name] &#123;</span><br><span class="line">  role_binding = data.bindings[_]</span><br><span class="line">  role_binding.role = role_name</span><br><span class="line">  role_binding.user = input.subject.user</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>Tips: 仔细同学会发现，线上运行版有<code>with</code>：<code>role_binding = data.bindings[_] with data.bindings as data_context.bindings</code></p><p><code>with</code> 是用来替换输入 input 或者上下文 data 里的数据。</p><p>因为线上版没法指定上边的 <code>data.json</code>, 所以通过变量<code>data_context</code>替换传入的。</p></blockquote><p>集合里边<code>role_binding = data.bindings[_]</code>是遍历<code>data.bindings</code></p><p><code>Rego</code>的遍历语法类似 python，这里遍历流程是</p><p>将<code>data.bindings</code>一个值赋值给<code>role_binding</code></p><p>进行后续处理，处理完后再赋下一个值</p><blockquote><p>Tips: <code>_</code>是特殊变量名，当需要变量占位又不需要后边引用时使用（类似 Go 的<code>_</code>）</p></blockquote><p>至于<code>role_binding.role = role_name</code>这条你应该能猜到是判断请求过来的 role 名是否和配置一致</p><p>可是为什么是<code>=</code>操作符，不应该是<code>==</code>?</p><p><a href="https://www.openpolicyagent.org/docs/latest/kubernetes-primer/#equality">https://www.openpolicyagent.org/docs/latest/kubernetes-primer/#equality</a></p><h3 id="unification"><a href="#unification" class="headerlink" title="unification"></a>unification</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rego`中实际只有`=`，而且作用是为变量赋值使等式成立，叫`Unification</span><br></pre></td></tr></table></figure><p>而<code>:=</code>局部变量赋值，<code>==</code>比较，是<code>=</code>的语法糖，为了实现局部变量赋值和比较，和编译错误更容易区分</p><p>所以<code>=</code>更像是<strong>数据查询</strong>。（毕竟<code>Rego</code>是一个数据查询语言嘛）</p><p>这里举个例子就好理解了：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[x, &quot;world&quot;] = [&quot;hello&quot;, y]</span><br><span class="line"># 之后，x值为hello，y为world</span><br></pre></td></tr></table></figure><p>总结一下，本文介绍什么是<code>OPA</code>，并借一个简单的 RBAC 例子初探了<code>Rego</code>强大的声明规则语法。</p><p>下一篇，将会介绍如何本地优雅的开发<code>OPA</code>，感兴趣同学可以先在<code>OPA</code>的 playground 玩玩。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;script src=&quot;\assets\js\APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;h1 id=&quot;OPA-重新定义规则引擎-入门篇&quot;&gt;&lt;a href=&quot;#OPA-重新定义规则引擎-入门篇&quot; class=&quot;headerlink&quot; title=&quot;OPA-重新定义规则</summary>
      
    
    
    
    <category term="microservice" scheme="https://wangyyovo.github.io/categories/microservice/"/>
    
    <category term="opa" scheme="https://wangyyovo.github.io/categories/microservice/opa/"/>
    
    
    <category term="opa" scheme="https://wangyyovo.github.io/tags/opa/"/>
    
  </entry>
  
  <entry>
    <title>OPA-rego语法</title>
    <link href="https://wangyyovo.github.io/posts/3fc956cc/"/>
    <id>https://wangyyovo.github.io/posts/3fc956cc/</id>
    <published>2022-03-02T09:23:44.000Z</published>
    <updated>2022-03-02T09:23:44.000Z</updated>
    
    <content type="html"><![CDATA[<script src="\assets\js\APlayer.min.js"> </script><h2 id="OPA-rego语法"><a href="#OPA-rego语法" class="headerlink" title="OPA-rego语法"></a>OPA-rego语法</h2><blockquote><p><a href="https://www.openpolicyagent.org/docs/latest/">https://www.openpolicyagent.org/docs/latest/</a></p></blockquote><h2 id="1-背景"><a href="#1-背景" class="headerlink" title="1.背景"></a>1.背景</h2><p>OPA专门用于推理结构化文档中表示的信息。您的服务及其用户发布的数据可以使用OPA的本机查询语言Rego进行检查和转换。</p><h2 id="2-什么是rego"><a href="#2-什么是rego" class="headerlink" title="2.什么是rego"></a>2.什么是rego</h2><p>Rego受到Datalog的启发，Datalog是一种众所周知的数十年的查询语言。Rego扩展了Datalog以支持诸如JSON之类的结构化文档模型。</p><p>Rego查询是对存储在OPA中的数据的断言。这些查询可用于定义策略，该策略枚举违反系统预期状态的数据实例</p><h2 id="3-为什么使用rego"><a href="#3-为什么使用rego" class="headerlink" title="3.为什么使用rego"></a>3.为什么使用rego</h2><p>使用Rego定义易于阅读和编写的策略。</p><p>Rego致力于为引用嵌套文档提供强大的支持，并确保查询正确无误。</p><p>Rego是声明性的，因此策略作者可以专注于应返回的查询，而不是应如何执行查询。这些查询比命令式语言中的查询更简单，更简洁。</p><p>像其他支持声明性查询语言的应用程序一样，OPA能够优化查询以提高性能。</p><h2 id="4-语法"><a href="#4-语法" class="headerlink" title="4.语法"></a>4.语法</h2><h3 id="4-1-基础知识"><a href="#4-1-基础知识" class="headerlink" title="4.1 基础知识"></a>4.1 基础知识</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pi := 3.14159</span><br><span class="line">pi</span><br><span class="line">3.14159</span><br><span class="line"></span><br><span class="line">rect := &#123;&quot;width&quot;: 2, &quot;height&quot;: 4&#125;</span><br><span class="line">rect</span><br><span class="line">&#123;</span><br><span class="line">  &quot;height&quot;: 4,</span><br><span class="line">  &quot;width&quot;: 2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">rect == &#123;&quot;height&quot;: 4, &quot;width&quot;: 2&#125;</span><br><span class="line">true</span><br><span class="line"></span><br><span class="line">v &#123; &quot;hello&quot; == &quot;world&quot; &#125;</span><br><span class="line">undefined decision</span><br><span class="line">v == true</span><br><span class="line">undefined decision</span><br><span class="line">v != true</span><br><span class="line">undefined decision</span><br></pre></td></tr></table></figure><p>根据变量来定义规则<br>规则本身可以直观地理解为：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rule-name IS value IF body</span><br></pre></td></tr></table></figure><p>示例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">t &#123; x := 42; y := 41; x &gt; y &#125;</span><br><span class="line">t</span><br><span class="line">true</span><br><span class="line"></span><br><span class="line">t2 &#123;</span><br><span class="line">    x := 42</span><br><span class="line">    y := 41</span><br><span class="line">    x &gt; y</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>规则中的表达式顺序不会影响文档的内容。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">s &#123;</span><br><span class="line">    x &gt; y</span><br><span class="line">    y = 41</span><br><span class="line">    x = 42</span><br><span class="line">&#125;</span><br><span class="line">s</span><br><span class="line">true</span><br></pre></td></tr></table></figure><p>有一个例外：如果使用赋值:&#x3D;，编译器将检查所赋值的变量是否尚未使用。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">z &#123;</span><br><span class="line">    y := 41</span><br><span class="line">    y := 42</span><br><span class="line">    43 &gt; y</span><br><span class="line">&#125;</span><br><span class="line">1 error occurred: module.rego:5: rego_compile_error: var y assigned above</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sites = [&#123;&quot;name&quot;: &quot;prod&quot;&#125;, &#123;&quot;name&quot;: &quot;smoke1&quot;&#125;, &#123;&quot;name&quot;: &quot;dev&quot;&#125;]</span><br><span class="line">r &#123; sites[_].name == &quot;prod&quot; &#125;</span><br></pre></td></tr></table></figure><p>上述规则r断言sites该name属性等于的地方（至少）存在一个文档&quot;prod&quot;。</p><p>结果：true</p><p>我们可以使用定义集合文档而不是布尔文档的规则来概括上面的示例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">q[name] &#123; name := sites[_].name &#125;</span><br><span class="line">[</span><br><span class="line">  &quot;prod&quot;,</span><br><span class="line">  &quot;smoke1&quot;,</span><br><span class="line">  &quot;dev&quot;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">p &#123; q[&quot;prod&quot;] &#125;</span><br><span class="line">查询p将具有相同的结果：</span><br><span class="line">true</span><br><span class="line"></span><br><span class="line">q[&quot;smoke2&quot;]</span><br><span class="line">undefined decision</span><br></pre></td></tr></table></figure><h3 id="4-2-标量值"><a href="#4-2-标量值" class="headerlink" title="4.2 标量值"></a>4.2 标量值</h3><p>标量值是Rego中最简单的术语类型。标量值可以是字符串，数字，布尔值或null。</p><p>可以仅根据标量值定义文档。这对于定义在多个位置引用的常量很有用。例如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">greeting   := &quot;Hello&quot;</span><br><span class="line">max_height := 42</span><br><span class="line">pi         := 3.14159</span><br><span class="line">allowed    := true</span><br><span class="line">location   := null</span><br><span class="line"></span><br><span class="line">[greeting, max_height, pi, allowed, location]</span><br><span class="line">[</span><br><span class="line">  &quot;Hello&quot;,</span><br><span class="line">  42,</span><br><span class="line">  3.14159,</span><br><span class="line">  true,</span><br><span class="line">  null</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h3 id="4-3-综合值"><a href="#4-3-综合值" class="headerlink" title="4.3 综合值"></a>4.3 综合值</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cube := &#123;&quot;width&quot;: 3, &quot;height&quot;: 4, &quot;depth&quot;: 5&#125;</span><br><span class="line"></span><br><span class="line">cube.width</span><br><span class="line">3</span><br><span class="line"></span><br><span class="line">a := 42</span><br><span class="line">b := false</span><br><span class="line">c := null</span><br><span class="line">d := &#123;&quot;a&quot;: a, &quot;x&quot;: [b, c]&#125;</span><br><span class="line"></span><br><span class="line">+----+-------+------+---------------------------+</span><br><span class="line">| a  |   b   |  c   |             d             |</span><br><span class="line">+----+-------+------+---------------------------+</span><br><span class="line">| 42 | false | null | &#123;&quot;a&quot;:42,&quot;x&quot;:[false,null]&#125; |</span><br><span class="line">+----+-------+------+---------------------------+</span><br></pre></td></tr></table></figure><h3 id="4-4-对象"><a href="#4-4-对象" class="headerlink" title="4.4 对象"></a>4.4 对象</h3><p>对象是无序键值集合。在Rego中，任何值类型都可以用作对象键。例如，以下分配将端口号映射 到IP地址列表（表示为字符串）。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">ips_by_port := &#123;</span><br><span class="line">    80: [&quot;1.1.1.1&quot;, &quot;1.1.1.2&quot;],</span><br><span class="line">    443: [&quot;2.2.2.1&quot;],</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ips_by_port[80]</span><br><span class="line">[</span><br><span class="line">  &quot;1.1.1.1&quot;,</span><br><span class="line">  &quot;1.1.1.2&quot;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">some port; ips_by_port[port][_] == &quot;2.2.2.1&quot;</span><br><span class="line">+------+</span><br><span class="line">| port |</span><br><span class="line">+------+</span><br><span class="line">| 443  |</span><br><span class="line">+------+</span><br><span class="line"></span><br><span class="line">将Rego值转换为JSON时，会将非字符串对象键编组为字符串（因为JSON不支持非字符串对象键）。</span><br><span class="line">ips_by_port</span><br><span class="line">&#123;</span><br><span class="line">  &quot;443&quot;: [</span><br><span class="line">    &quot;2.2.2.1&quot;</span><br><span class="line">  ],</span><br><span class="line">  &quot;80&quot;: [</span><br><span class="line">    &quot;1.1.1.1&quot;,</span><br><span class="line">    &quot;1.1.1.2&quot;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-5-Sets"><a href="#4-5-Sets" class="headerlink" title="4.5 Sets"></a>4.5 Sets</h3><p>除了数组和对象外，Rego还支持设置值。集是唯一值的无序集合。就像其他复合值一样，可以根据标量，变量，引用和其他复合值来定义集合。例如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">s := &#123;cube.width, cube.height, cube.depth&#125;</span><br><span class="line">+---------+</span><br><span class="line">|    s    |</span><br><span class="line">+---------+</span><br><span class="line">| [5,4,3] |</span><br><span class="line">+---------+</span><br></pre></td></tr></table></figure><p>设置文档是没有键的值的集合。当序列化为JSON或不支持集合数据类型的其他格式时，OPA将集合文档表示为数组。集与数组或对象之间的重要区别在于，对集和数组或对象进行键控时，它们是无键的，即，您不能引用集内元素的索引。</p><p>比较集合时，元素的顺序无关紧要：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;1,2,3&#125; == &#123;3,1,2&#125;</span><br><span class="line">true</span><br><span class="line"></span><br><span class="line">&#123;1,2,3&#125; == &#123;3,x,2&#125;</span><br><span class="line">1 error occurred: 1:1: rego_unsafe_var_error: var x is unsafe</span><br><span class="line">因为集合与对象共享大括号语法，并且使用定义了一个空对象&#123;&#125;，所以必须使用不同的语法来构造一个空集合：</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">count(set())</span><br><span class="line">0</span><br></pre></td></tr></table></figure><h3 id="4-6-Variables"><a href="#4-6-Variables" class="headerlink" title="4.6 Variables"></a>4.6 Variables</h3><p>变量是Rego中的另一种术语。它们同时出现在规则的开头和正文中。</p><p>可以将出现在规则开头的变量视为规则的输入和输出。与许多编程语言不同，变量是输入或输出，而在许多编程语言中，变量同时是输入和输出。如果查询提供变量的值，则该变量为输入，如果查询不提供变量的值，则该变量为输出。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">sites := [</span><br><span class="line">    &#123;&quot;name&quot;: &quot;prod&quot;&#125;,</span><br><span class="line">    &#123;&quot;name&quot;: &quot;smoke1&quot;&#125;,</span><br><span class="line">    &#123;&quot;name&quot;: &quot;dev&quot;&#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">q[name] &#123; name := sites[_].name &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">q[x]</span><br><span class="line">+----------+----------+</span><br><span class="line">|    x     |   q[x]   |</span><br><span class="line">+----------+----------+</span><br><span class="line">| &quot;prod&quot;   | &quot;prod&quot;   |</span><br><span class="line">| &quot;smoke1&quot; | &quot;smoke1&quot; |</span><br><span class="line">| &quot;dev&quot;    | &quot;dev&quot;    |</span><br><span class="line">+----------+----------+</span><br><span class="line"></span><br><span class="line">q[&quot;dev&quot;]</span><br><span class="line">&quot;dev&quot;</span><br></pre></td></tr></table></figure><h3 id="4-7-References"><a href="#4-7-References" class="headerlink" title="4.7 References"></a>4.7 References</h3><p>引用用于访问嵌套文档。</p><p>本节中的示例使用“示例”部分中定义的数据。</p><p>最简单的参考不包含任何变量。例如，以下参考从示例数据中返回第一个站点文档中第二个服务器的主机名：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sites[0].servers[1].hostname</span><br><span class="line">&quot;helium&quot;</span><br></pre></td></tr></table></figure><h3 id="4-8-Keys"><a href="#4-8-Keys" class="headerlink" title="4.8 Keys"></a>4.8 Keys</h3><p>引用可以包含变量作为键。以这种方式编写的引用用于从集合中的每个元素中选择一个值。</p><p>以下参考将在示例数据中选择所有服务器的主机名：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">sites[i].servers[j].hostname</span><br><span class="line">+---+---+------------------------------+</span><br><span class="line">| i | j | sites[i].servers[j].hostname |</span><br><span class="line">+---+---+------------------------------+</span><br><span class="line">| 0 | 0 | &quot;hydrogen&quot;                   |</span><br><span class="line">| 0 | 1 | &quot;helium&quot;                     |</span><br><span class="line">| 0 | 2 | &quot;lithium&quot;                    |</span><br><span class="line">| 1 | 0 | &quot;beryllium&quot;                  |</span><br><span class="line">| 1 | 1 | &quot;boron&quot;                      |</span><br><span class="line">| 1 | 2 | &quot;carbon&quot;                     |</span><br><span class="line">| 2 | 0 | &quot;nitrogen&quot;                   |</span><br><span class="line">| 2 | 1 | &quot;oxygen&quot;                     |</span><br><span class="line">+---+---+------------------------------+</span><br></pre></td></tr></table></figure><p>从概念上讲，这与以下命令式（Python）代码相同：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">hostnames</span>(<span class="params">sites</span>):</span><br><span class="line">    result = []</span><br><span class="line">    <span class="keyword">for</span> site <span class="keyword">in</span> sites:</span><br><span class="line">        <span class="keyword">for</span> server <span class="keyword">in</span> site.servers:</span><br><span class="line">            result.append(server.hostname)</span><br><span class="line">    <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure><p>在上面的参考中，我们有效地使用了名为i和的变量j来迭代集合。如果变量在引用外部未使用，我们更喜欢用下划线（_）字符替换它们。上面的参考可以重写为：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">sites[_].servers[_].hostname</span><br><span class="line">+------------------------------+</span><br><span class="line">| sites[_].servers[_].hostname |</span><br><span class="line">+------------------------------+</span><br><span class="line">| &quot;hydrogen&quot;                   |</span><br><span class="line">| &quot;helium&quot;                     |</span><br><span class="line">| &quot;lithium&quot;                    |</span><br><span class="line">| &quot;beryllium&quot;                  |</span><br><span class="line">| &quot;boron&quot;                      |</span><br><span class="line">| &quot;carbon&quot;                     |</span><br><span class="line">| &quot;nitrogen&quot;                   |</span><br><span class="line">| &quot;oxygen&quot;                     |</span><br><span class="line">+------------------------------+</span><br></pre></td></tr></table></figure><h3 id="4-9-Composite-Keys"><a href="#4-9-Composite-Keys" class="headerlink" title="4.9 Composite Keys"></a>4.9 Composite Keys</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">s := &#123;[1, 2], [1, 4], [2, 6]&#125;</span><br><span class="line">s[[1, 2]]</span><br><span class="line">[</span><br><span class="line">  1,</span><br><span class="line">  2</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">s[[1, x]]</span><br><span class="line">+---+-----------+</span><br><span class="line">| x | s[[1, x]] |</span><br><span class="line">+---+-----------+</span><br><span class="line">| 2 | [1,2]     |</span><br><span class="line">| 4 | [1,4]     |</span><br><span class="line">+---+-----------+</span><br></pre></td></tr></table></figure><h3 id="4-10-Array-Comprehensions"><a href="#4-10-Array-Comprehensions" class="headerlink" title="4.10 Array Comprehensions"></a>4.10 Array Comprehensions</h3><p>数组推导从子查询中构建数组值。数组推导具有以下形式：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ &lt;term&gt; | &lt;body&gt; ]</span><br></pre></td></tr></table></figure><p>例如，以下规则定义一个对象，其中的键是应用程序名称，值是在其中部署应用程序的服务器的主机名。服务器的主机名以数组表示。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">app_to_hostnames[app_name] = hostnames &#123;</span><br><span class="line">    app := apps[_]</span><br><span class="line">    app_name := app.name</span><br><span class="line">    hostnames := [hostname | name := app.servers[_]</span><br><span class="line">                            s := sites[_].servers[_]</span><br><span class="line">                            s.name == name</span><br><span class="line">                            hostname := s.hostname]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">结果</span><br><span class="line">app_to_hostnames[app]</span><br><span class="line">+-----------+------------------------------------------------------+</span><br><span class="line">|    app    |                app_to_hostnames[app]                 |</span><br><span class="line">+-----------+------------------------------------------------------+</span><br><span class="line">| &quot;web&quot;     | [&quot;hydrogen&quot;,&quot;helium&quot;,&quot;beryllium&quot;,&quot;boron&quot;,&quot;nitrogen&quot;] |</span><br><span class="line">| &quot;mysql&quot;   | [&quot;lithium&quot;,&quot;carbon&quot;]                                 |</span><br><span class="line">| &quot;mongodb&quot; | [&quot;oxygen&quot;]                                           |</span><br><span class="line">+-----------+------------------------------------------------------+</span><br></pre></td></tr></table></figure><h3 id="4-11-Set-Comprehensions"><a href="#4-11-Set-Comprehensions" class="headerlink" title="4.11 Set Comprehensions"></a>4.11 Set Comprehensions</h3><p>Set Comprehensions从子查询中构建设置值。集合理解的形式为</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &lt;term&gt; | &lt;body&gt; &#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">a := [1, 2, 3, 4, 3, 4, 3, 4, 5]</span><br><span class="line">b := &#123;x | x = a[_]&#125;</span><br><span class="line"></span><br><span class="line">+---------------------+-------------+</span><br><span class="line">|          a          |      b      |</span><br><span class="line">+---------------------+-------------+</span><br><span class="line">| [1,2,3,4,3,4,3,4,5] | [1,2,3,4,5] |</span><br><span class="line">+---------------------+-------------+</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;script src=&quot;\assets\js\APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;h2 id=&quot;OPA-rego语法&quot;&gt;&lt;a href=&quot;#OPA-rego语法&quot; class=&quot;headerlink&quot; title=&quot;OPA-rego语法&quot;&gt;&lt;/a&gt;OPA-re</summary>
      
    
    
    
    <category term="microservice" scheme="https://wangyyovo.github.io/categories/microservice/"/>
    
    <category term="opa" scheme="https://wangyyovo.github.io/categories/microservice/opa/"/>
    
    
    <category term="opa" scheme="https://wangyyovo.github.io/tags/opa/"/>
    
  </entry>
  
  <entry>
    <title>OPA-介绍</title>
    <link href="https://wangyyovo.github.io/posts/5d3bf062/"/>
    <id>https://wangyyovo.github.io/posts/5d3bf062/</id>
    <published>2022-03-02T09:23:44.000Z</published>
    <updated>2022-03-02T09:23:44.000Z</updated>
    
    <content type="html"><![CDATA[<script src="\assets\js\APlayer.min.js"> </script><h1 id="OPA-介绍"><a href="#OPA-介绍" class="headerlink" title="OPA-介绍"></a>OPA-介绍</h1><blockquote><p><a href="https://www.openpolicyagent.org/docs/latest/">https://www.openpolicyagent.org/docs/latest/</a></p></blockquote><h2 id="1-OPA-介绍"><a href="#1-OPA-介绍" class="headerlink" title="1.OPA 介绍"></a>1.OPA 介绍</h2><p>开放策略代理（OPA，发音为“ oh-pa”）是一个开放源代码的通用策略引擎，它统一了整个堆栈中的策略执行。OPA提供了一种高级的声明性语言，使您可以将策略指定为代码和简单的API，以减轻软件决策的负担。您可以使用OPA在微服务，Kubernetes，CI &#x2F; CD管道，API网关等中实施策略。</p><p>OPA 最初是由 Styra 公司在 2016 年创建并开源的项目，目前该公司的主要产品就是提供可视化策略控制及策略执行的可视化 Dashboard 服务的。</p><p>OPA 首次进入 CNCF 并成为 sandbox 级别的项目是在 2018 年， 在 2021 年的 2 月份便已经从 CNCF 毕业，这个过程相对来说还是比较快的，由此也可以看出 OPA 是一个比较活跃且应用广泛的项目。</p><p>透过现象看本质，策略就是一组规则，请求发送到引擎，引擎根据规则来进行决策。OPA 并不负责具体任务的执行，它仅负责决策，需要决策的请求通过 JSON 的方式传递给 OPA ，在 OPA 决策后，也会将结果以 JSON 的形式返回。</p><p><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/blog/opa/opa-service.png"></p><h2 id="2-OPA-解决了哪些问题"><a href="#2-OPA-解决了哪些问题" class="headerlink" title="2.OPA 解决了哪些问题"></a>2.OPA 解决了哪些问题</h2><p>OPA通过评估查询输入以及针对策略和数据来生成策略决策。OPA和Rego是域无关的，因此您可以描述策略中几乎所有类型的不变式。例如：</p><ol><li>哪些用户可以访问哪些资源；</li><li>允许哪些子网出口流量；</li><li>必须将工作负载部署到哪个群集；</li><li>可以从哪些注册表二进制文件下载；</li><li>容器可以执行哪些OS功能；</li><li>可以在一天的哪个时间访问系统；</li><li>需要策略控制用户是否可登陆服务器或者做一些操作；</li><li>需要策略控制哪些项目&#x2F;哪些组件可进行部署；</li><li>需要策略控制如何访问数据库；</li><li>需要策略控制哪些资源可部署到 Kubernetes 中；</li></ol><p>策略决策不仅限于简单的是&#x2F;否或允许&#x2F;拒绝答案。像查询输入一样，您的策略可以生成任意结构化数据作为输出。<br><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/blog/opa/bb67bc706e524598ad72c7d53de3519c.png"></p><p>但是对于这些场景或者软件来说，配置它们的策略是需要与该软件进行耦合的，彼此是不统一，不通用的。管理起来也会比较混乱，带来了不小的维护成本。</p><p>OPA 的出现可以将各处配置的策略进行统一，极大的降低了维护成本。以及将策略与对应的软件&#x2F;服务进行解耦，方便进行移植&#x2F;复用。<br><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/blog/opa/bb6e1d6149d3406f92ea406d150d0a55.png"></p><p>假设您在具有以下系统的组织中工作：<br><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/blog/opa/system.svg" alt="在这里插入图片描述"></p><p>系统中包含三种组件：</p><ul><li>服务器暴露零层或多个协议（例如，http，ssh等等）</li><li>网络连接服务器，可以是公共的或私有的。公共网络已连接到Internet。</li><li>端口将服务器连接到网络。</li></ul><p>所有服务器，网络和端口均由脚本设置。该脚本接收系统的JSON表示作为输入：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;servers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;app&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;https&quot;</span><span class="punctuation">,</span> <span class="string">&quot;ssh&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;p1&quot;</span><span class="punctuation">,</span> <span class="string">&quot;p2&quot;</span><span class="punctuation">,</span> <span class="string">&quot;p3&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;db&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;mysql&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;p3&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cache&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;memcache&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;p3&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ci&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;http&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;p1&quot;</span><span class="punctuation">,</span> <span class="string">&quot;p2&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;busybox&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;telnet&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;p1&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;networks&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net1&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;public&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net2&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;public&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net3&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;public&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net4&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;public&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;p1&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net1&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;p2&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net3&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;p3&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net2&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>当天早些时候，您的老板告诉您必须实施的新安全策略：</p><p>Servers reachable from the Internet must not expose the insecure ‘http’ protocol.<br>从Internet可访问的服务器不能暴露不安全的“http”协议。<br>Servers are not allowed to expose the ‘telnet’ protocol.<br>服务器不允许公开’telnet’协议<br>配置了服务器，网络和端口并且合规团队希望定期审核系统以查找违反策略的服务器时，必须执行该策略。</p><p>您的老板已要求您确定OPA是否适合实施该政策。</p><h2 id="3-rego介绍"><a href="#3-rego介绍" class="headerlink" title="3.rego介绍"></a>3.rego介绍</h2><p>OPA 中的策略是以 Rego 这种 DSL(Domain Specific Language) 来表示的。</p><p>Rego 受 Datalog（<a href="https://en.wikipedia.org/wiki/Datalog%EF%BC%89">https://en.wikipedia.org/wiki/Datalog）</a> 的启发，并且扩展了 Datalog 对于结构化文档模型的支持，方便以 JSON 的方式对数据进行处理。</p><p>Rego 允许策略制定者可以专注于返回内容的查询而不是如何执行查询。同时 OPA 中也内置了执行规则时的优化，用户可以默认使用。</p><p>Rego 允许我们使用规则（if-then）封装和重用逻辑，规则可以是完整的或者是部分的。</p><p>每个规则都是由头部和主体组成。在 Rego 中，如果规则主体对于某些变量赋值为真，那么我们说规则头为真。可以通过绝对路径引用任何加载到 OPA 中的规则来查询它的值。规则的路径总是：data…（规则生成的所有值都可以通过全局 data 变量进行查询。例如，下方示例中的 data.example.rules.any_public_networks</p><p>完整规则是将单个值分配给变量的 if-then 语句。</p><p>部分规则是生成一组值并将该组分配给变量的 if-then 语句</p><p>逻辑或是要在 Rego 中定义多个具有相同名称的规则。（查询中将多个表达式连接在一起时，表示的是逻辑 AND）</p><h2 id="4-OPA-安装"><a href="#4-OPA-安装" class="headerlink" title="4.OPA 安装"></a>4.OPA 安装</h2><p>本节说明如何直接查询OPA并在自己的计算机上与其交互。</p><p>1.下载OPA<br>要开始从GitHub版本下载适用于您平台的OPA二进制文件，请执行以下操作：</p><p>在macOS（64位）上：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -L -o opa https://openpolicyagent.org/downloads/v0.28.0/opa_darwin_amd64</span><br></pre></td></tr></table></figure><p>在Linux（64位）上：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">curl -L -o opa https://openpolicyagent.org/downloads/v0.28.0/opa_linux_amd64</span><br><span class="line">chmod 755 ./opa</span><br><span class="line">cp opa /usr/local/bin/</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">opa version</span></span><br><span class="line">Version: 0.35.0</span><br><span class="line">Build Commit: a54537a</span><br><span class="line">Build Timestamp: 2021-12-01T02:11:47Z</span><br><span class="line">Build Hostname: 9e4cf671a460</span><br><span class="line">Go Version: go1.17.3</span><br><span class="line">WebAssembly: unavailable</span><br></pre></td></tr></table></figure><p>容器</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker run --<span class="built_in">rm</span>  openpolicyagent/opa:0.35.0 version</span>    </span><br><span class="line">Version: 0.35.0</span><br><span class="line">Build Commit: a54537a</span><br><span class="line">Build Timestamp: 2021-12-01T02:10:31Z</span><br><span class="line">Build Hostname: 4ee9b086e5de</span><br><span class="line">Go Version: go1.17.3</span><br><span class="line">WebAssembly: available</span><br></pre></td></tr></table></figure><h2 id="5-OPA-运行"><a href="#5-OPA-运行" class="headerlink" title="5.OPA 运行"></a>5.OPA 运行</h2><p>与OPA交互的最简单方法是通过命令行使用opa eval子命令。opa eval是一把瑞士军刀，可用于评估任意的Rego表达式和策略。opa eval支持大量用于控制评估的选项。常用标志包括：</p><ul><li>–bundle -b 将捆绑包文件或目录加载到OPA中。该标志可以重复。</li><li>–data -d 将策略或数据文件加载到OPA中。该标志可以重复。</li><li>–input -i 加载数据文件并将其用作input。该标志不能重复。</li><li>–format -f 设置要使用的输出格式。默认值为json，并且旨在用于程序设计。该pretty格式发出了更多人类可读的输出。</li><li>–fail 不适用 如果查询未定义，则以非零的退出代码退出。</li><li>–fail-defined 不适用 如果查询不是未定义的，则以非零的退出代码退出。</li></ul><p>例如：</p><p>input.json：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;servers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;app&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;https&quot;</span><span class="punctuation">,</span> <span class="string">&quot;ssh&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;p1&quot;</span><span class="punctuation">,</span> <span class="string">&quot;p2&quot;</span><span class="punctuation">,</span> <span class="string">&quot;p3&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;db&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;mysql&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;p3&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cache&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;memcache&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;p3&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ci&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;http&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;p1&quot;</span><span class="punctuation">,</span> <span class="string">&quot;p2&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;busybox&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;telnet&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;p1&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;networks&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net1&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;public&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net2&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;public&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net3&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;public&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net4&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;public&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;p1&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net1&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;p2&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net3&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;p3&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net2&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>example.rego:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">package example</span><br><span class="line"></span><br><span class="line">default allow = false                               # unless otherwise defined, allow is false</span><br><span class="line"></span><br><span class="line">allow = true &#123;                                      # allow is true if...</span><br><span class="line">    count(violation) == 0                           # there are zero violations.</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">violation[server.id] &#123;                              # a server is in the violation set if...</span><br><span class="line">    some server</span><br><span class="line">    public_server[server]                           # it exists in the &#x27;public_server&#x27; set and...</span><br><span class="line">    server.protocols[_] == &quot;http&quot;                   # it contains the insecure &quot;http&quot; protocol.</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">violation[server.id] &#123;                              # a server is in the violation set if...</span><br><span class="line">    server := input.servers[_]                      # it exists in the input.servers collection and...</span><br><span class="line">    server.protocols[_] == &quot;telnet&quot;                 # it contains the &quot;telnet&quot; protocol.</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public_server[server] &#123;                             # a server exists in the public_server set if...</span><br><span class="line">    some i, j</span><br><span class="line">    server := input.servers[_]                      # it exists in the input.servers collection and...</span><br><span class="line">    server.ports[_] == input.ports[i].id            # it references a port in the input.ports collection and...</span><br><span class="line">    input.ports[i].network == input.networks[j].id  # the port references a network in the input.networks collection and...</span><br><span class="line">    input.networks[j].public                        # the network is public.</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>执行：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">root@master:~/cks/opa# ./opa eval &quot;1*2+3&quot;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;result&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;expressions&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;value&quot;: 5,</span><br><span class="line">          &quot;text&quot;: &quot;1*2+3&quot;,</span><br><span class="line">          &quot;location&quot;: &#123;</span><br><span class="line">            &quot;row&quot;: 1,</span><br><span class="line">            &quot;col&quot;: 1</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">root@master:~/cks/opa# ./opa eval -i input.json -d example.rego &quot;data.example.violation[x]&quot;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;result&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;expressions&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;value&quot;: &quot;ci&quot;,</span><br><span class="line">          &quot;text&quot;: &quot;data.example.violation[x]&quot;,</span><br><span class="line">          &quot;location&quot;: &#123;</span><br><span class="line">            &quot;row&quot;: 1,</span><br><span class="line">            &quot;col&quot;: 1</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      &quot;bindings&quot;: &#123;</span><br><span class="line">        &quot;x&quot;: &quot;ci&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;expressions&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;value&quot;: &quot;busybox&quot;,</span><br><span class="line">          &quot;text&quot;: &quot;data.example.violation[x]&quot;,</span><br><span class="line">          &quot;location&quot;: &#123;</span><br><span class="line">            &quot;row&quot;: 1,</span><br><span class="line">            &quot;col&quot;: 1</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      &quot;bindings&quot;: &#123;</span><br><span class="line">        &quot;x&quot;: &quot;busybox&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">root@master:~/cks/opa# ./opa eval --fail-defined -i input.json -d example.rego &quot;data.example.violation[x]&quot;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;result&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;expressions&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;value&quot;: &quot;ci&quot;,</span><br><span class="line">          &quot;text&quot;: &quot;data.example.violation[x]&quot;,</span><br><span class="line">          &quot;location&quot;: &#123;</span><br><span class="line">            &quot;row&quot;: 1,</span><br><span class="line">            &quot;col&quot;: 1</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      &quot;bindings&quot;: &#123;</span><br><span class="line">        &quot;x&quot;: &quot;ci&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;expressions&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;value&quot;: &quot;busybox&quot;,</span><br><span class="line">          &quot;text&quot;: &quot;data.example.violation[x]&quot;,</span><br><span class="line">          &quot;location&quot;: &#123;</span><br><span class="line">            &quot;row&quot;: 1,</span><br><span class="line">            &quot;col&quot;: 1</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      &quot;bindings&quot;: &#123;</span><br><span class="line">        &quot;x&quot;: &quot;busybox&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="6-OPA-run（互动式）"><a href="#6-OPA-run（互动式）" class="headerlink" title="6.OPA run（互动式）"></a>6.OPA run（互动式）</h2><p>OPA包括一个交互式外壳程序或REPL（读取-评估-打印循环）。您可以使用REPL来试验策略并为新策略创建原型。</p><p>要启动REPL，只需：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./opa run</span><br></pre></td></tr></table></figure><p>当您在REPL中输入语句时，OPA会对它们进行评估并打印结果。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; true</span><br><span class="line">true</span><br><span class="line">&gt; 3.14</span><br><span class="line">3.14</span><br><span class="line">&gt; [&quot;hello&quot;, &quot;world&quot;]</span><br><span class="line">[</span><br><span class="line">&quot;hello&quot;,</span><br><span class="line">&quot;world&quot;</span><br></pre></td></tr></table></figure><p>大多数REPL允许您定义以后可以引用的变量。OPA允许您执行类似的操作。例如，您可以定义一个pi常量，如下所示：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; pi := 3.14</span><br></pre></td></tr></table></figure><p>定义“ pi”后，您将查询该值并根据该值编写表达式：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; pi</span><br><span class="line">3.14</span><br><span class="line">&gt; pi &gt; 3</span><br><span class="line">true</span><br></pre></td></tr></table></figure><p>通过按Control-D或键入exit以下命令退出REPL ：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exit</span><br></pre></td></tr></table></figure><p>您可以通过在命令行上传递策略和数据文件来将它们加载到REPL中。默认情况下，JSON和YAML文件植于下data。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">opa run input.json</span><br></pre></td></tr></table></figure><p>运行一些查询以查找数据：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">data.server[0].protocols[1]</span><br><span class="line">undefined</span><br><span class="line">data.servers[0].protocols[1]</span><br><span class="line">&quot;ssh&quot;</span><br><span class="line">data.servers[i].protocols[j]</span><br><span class="line">+---+---+------------------------------+</span><br><span class="line">| i | j | data.servers[i].protocols[j] |</span><br><span class="line">+---+---+------------------------------+</span><br><span class="line">| 0 | 0 | &quot;https&quot;                      |</span><br><span class="line">| 0 | 1 | &quot;ssh&quot;                        |</span><br><span class="line">| 1 | 0 | &quot;mysql&quot;                      |</span><br><span class="line">| 2 | 0 | &quot;memcache&quot;                   |</span><br><span class="line">| 3 | 0 | &quot;http&quot;                       |</span><br><span class="line">| 4 | 0 | &quot;telnet&quot;                     |</span><br><span class="line">+---+---+------------------------------+</span><br><span class="line">net := data.networks[_]; net.public</span><br><span class="line">+-----------------------------+</span><br><span class="line">|             net             |</span><br><span class="line">+-----------------------------+</span><br><span class="line">| &#123;&quot;id&quot;:&quot;net3&quot;,&quot;public&quot;:true&#125; |</span><br><span class="line">| &#123;&quot;id&quot;:&quot;net4&quot;,&quot;public&quot;:true&#125; |</span><br><span class="line">+-----------------------------+</span><br></pre></td></tr></table></figure><p>要将数据文件设置为inputREPL中的文档，请在文件路径前添加前缀：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">opa run example.rego repl.input:input.json</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">data.example.public_server[s]</span><br><span class="line">+-------------------------------------------------------------------+-------------------------------------------------------------------+</span><br><span class="line">|                                 s                                 |                   data.example.public_server[s]                   |</span><br><span class="line">+-------------------------------------------------------------------+-------------------------------------------------------------------+</span><br><span class="line">| &#123;&quot;id&quot;:&quot;app&quot;,&quot;ports&quot;:[&quot;p1&quot;,&quot;p2&quot;,&quot;p3&quot;],&quot;protocols&quot;:[&quot;https&quot;,&quot;ssh&quot;]&#125; | &#123;&quot;id&quot;:&quot;app&quot;,&quot;ports&quot;:[&quot;p1&quot;,&quot;p2&quot;,&quot;p3&quot;],&quot;protocols&quot;:[&quot;https&quot;,&quot;ssh&quot;]&#125; |</span><br><span class="line">| &#123;&quot;id&quot;:&quot;ci&quot;,&quot;ports&quot;:[&quot;p1&quot;,&quot;p2&quot;],&quot;protocols&quot;:[&quot;http&quot;]&#125;              | &#123;&quot;id&quot;:&quot;ci&quot;,&quot;ports&quot;:[&quot;p1&quot;,&quot;p2&quot;],&quot;protocols&quot;:[&quot;http&quot;]&#125;              |</span><br><span class="line">+-------------------------------------------------------------------+-------------------------------------------------------------------+</span><br></pre></td></tr></table></figure><h2 id="7-OPA-run（服务器）"><a href="#7-OPA-run（服务器）" class="headerlink" title="7.OPA run（服务器）"></a>7.OPA run（服务器）</h2><p>要与OPA集成，您可以将其作为服务器运行并通过HTTP执行查询。您可以使用-s或将OPA作为服务器启动--server：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./opa run --server ./example.rego</span><br></pre></td></tr></table></figure><p>默认情况下，OPA在上侦听HTTP连接0.0.0.0:8181。请参阅参考资料opa run --help，以获取用于更改侦听地址，启用TLS等的选项的列表。</p><p>在另一个终端内部使用curl（或类似的工具）来访问OPA的HTTP API。查询&#x2F;v1&#x2F;dataHTTP API时，必须将输入数据包装在JSON对象内：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span> &lt;value&gt;</span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>创建输入文件的副本，以通过发送curl：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; v1-data-input.json</span><br><span class="line">&#123;</span><br><span class="line">    &quot;input&quot;: $(cat input.json)</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>执行一些curl请求并检查输出：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl localhost:8181/v1/data/example/violation -d @v1-data-input.json -H &#x27;Content-Type: application/json&#x27;</span><br><span class="line">curl localhost:8181/v1/data/example/allow -d @v1-data-input.json -H &#x27;Content-Type: application/json&#x27;</span><br></pre></td></tr></table></figure><p>默认情况下data.system.main，用于不带路径的策略查询。当您在不提供路径的情况下执行查询时，不必包装输入。如果该data.system.main决定未定义，则将其视为错误：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl localhost:8181 -i -d @input.json -H &#x27;Content-Type: application/json&#x27;</span><br></pre></td></tr></table></figure><p>您可以重新启动OPA并将其配置为使用任何决策作为默认决策：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./opa run --server --set=default_decision=example/allow ./example.rego</span><br></pre></td></tr></table></figure><p>curl从上面重新运行最后一个命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl localhost:8181 -i -d @input.json -H &#x27;Content-Type: application/json&#x27;</span><br></pre></td></tr></table></figure><h2 id="8-Rego-语法"><a href="#8-Rego-语法" class="headerlink" title="8.Rego 语法"></a>8.Rego 语法</h2><p>OPA策略以称为Rego的高级声明性语言表示。Rego（发音为“ ray-go”）是专门为在复杂的分层数据结构上表达策略而构建的。有关Rego的详细信息，请参阅策略语言文档。</p><p>below以下示例是交互式的！如果在包含服务器，网络和端口的上方编辑输入数据，则输出将在下面更改。同样，如果您在下面的示例中编辑查询或规则，则输出将更改。在通读本节时，请尝试更改输入，查询和规则，并观察输出的差异。</p><p>💻也可以使用以下命令在您的计算机上本地运行它们opa eval，这是设置说明。</p><h3 id="8-1-参考"><a href="#8-1-参考" class="headerlink" title="8.1 参考"></a>8.1 参考</h3><p>当OPA评估策略时，它将查询中提供的数据绑定到名为的全局变量input。您可以使用.（点）运算符在输入中引用数据。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">input.servers</span><br></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;app&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;p1&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;p2&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;p3&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;https&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;ssh&quot;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;db&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;p3&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;mysql&quot;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cache&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;p3&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;memcache&quot;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ci&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;p1&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;p2&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;http&quot;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;busybox&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;p1&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;protocols&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;telnet&quot;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure><p>要引用数组元素，可以使用熟悉的方括号语法：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">input.servers[0].protocols[0]</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;https&quot;</span><br></pre></td></tr></table></figure><p>keys如果键包含以外的其他字符，则可以使用相同的方括号语法 [a-zA-Z0-9_]。例如input[“foo~bar”]。</p><p>如果引用的值不存在，则OPA返回undefined。未定义表示OPA无法找到任何结果。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">input.deadbeef</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">undefined decision</span><br></pre></td></tr></table></figure><h3 id="8-2-表达式（逻辑与）"><a href="#8-2-表达式（逻辑与）" class="headerlink" title="8.2 表达式（逻辑与）"></a>8.2 表达式（逻辑与）</h3><p>要在Rego中制定政策决策，您要针对输入和其他数据编写表达式。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">input.servers[0].id == &quot;app&quot;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">true</span><br></pre></td></tr></table></figure><p>OPA包括一组内置函数，可用于执行常见操作，例如字符串操作，正则表达式匹配，算术，聚合等。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">count(input.servers[0].protocols) &gt;= 1</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">true</span><br></pre></td></tr></table></figure><p>有关现成的OPA支持的内置功能的完整列表，请参阅“策略参考”页面。</p><p>多个表达式通过;（AND）运算符连接在一起。为了使查询产生结果，查询中的所有表达式必须为真或已定义。表达式的顺序无关紧要。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">input.servers[0].id == &quot;app&quot;; input.servers[0].protocols[0] == &quot;https&quot;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">true</span><br></pre></td></tr></table></figure><p>您可以;通过将表达式分成多行来省略（AND）运算符。以下查询与上一个查询具有相同的含义：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">input.servers[0].id == &quot;app&quot;</span><br><span class="line">input.servers[0].protocols[0] == &quot;https&quot;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">true</span><br></pre></td></tr></table></figure><p>如果查询中的任何表达式都不为真（或未定义），则结果为未定义。在下面的示例中，第二个表达式为false：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">input.servers[0].id == &quot;app&quot;</span><br><span class="line">input.servers[0].protocols[0] == &quot;telnet&quot;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">undefined decision</span><br></pre></td></tr></table></figure><h3 id="8-3-逻辑或"><a href="#8-3-逻辑或" class="headerlink" title="8.3 逻辑或"></a>8.3 逻辑或</h3><p>在查询中将多个表达式连接在一起时，您表示的是逻辑与。要在Rego中表达逻辑OR，您可以定义多个具有相同名称的规则。让我们来看一个例子。</p><p>想象一下，您想知道是否有任何服务器公开允许客户端外壳访问的协议。为了确定这一点，你可以定义声明了一个完整的规则 shell_accessible是true，如果任何服务器暴露&quot;telnet“或”ssh&quot; 协议：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">package example.logical_or</span><br><span class="line"></span><br><span class="line">default shell_accessible = false</span><br><span class="line"></span><br><span class="line">shell_accessible = true &#123;</span><br><span class="line">    input.servers[_].protocols[_] == &quot;telnet&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">shell_accessible = true &#123;</span><br><span class="line">    input.servers[_].protocols[_] == &quot;ssh&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;servers&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;id&quot;: &quot;busybox&quot;,</span><br><span class="line">            &quot;protocols&quot;: [&quot;http&quot;, &quot;telnet&quot;]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;id&quot;: &quot;web&quot;,</span><br><span class="line">            &quot;protocols&quot;: [&quot;https&quot;]</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">shell_accessible</span><br><span class="line"></span><br><span class="line">true</span><br></pre></td></tr></table></figure><p>defaultkeyword如果未定义具有相同名称的所有其他规则，则该关键字告诉OPA为该变量分配一个值。</p><p>当您将逻辑或与部分规则一起使用时，每个规则定义都会影响分配给变量的一组值。例如，可以将上面的示例修改为生成一组公开&quot;telnet&quot;或 的服务器&quot;ssh&quot;。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">package example.logical_or</span><br><span class="line"></span><br><span class="line">shell_accessible[server.id] &#123;</span><br><span class="line">    server := input.servers[_]</span><br><span class="line">    server.protocols[_] == &quot;telnet&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">shell_accessible[server.id] &#123;</span><br><span class="line">    server := input.servers[_]</span><br><span class="line">    server.protocols[_] == &quot;ssh&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;servers&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;id&quot;: &quot;busybox&quot;,</span><br><span class="line">            &quot;protocols&quot;: [&quot;http&quot;, &quot;telnet&quot;]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;id&quot;: &quot;db&quot;,</span><br><span class="line">            &quot;protocols&quot;: [&quot;mysql&quot;, &quot;ssh&quot;]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;id&quot;: &quot;web&quot;,</span><br><span class="line">            &quot;protocols&quot;: [&quot;https&quot;]</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">shell_accessible</span><br><span class="line"></span><br><span class="line">[</span><br><span class="line">  &quot;busybox&quot;,</span><br><span class="line">  &quot;db&quot;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h3 id="8-4-Variables变量"><a href="#8-4-Variables变量" class="headerlink" title="8.4 Variables变量"></a>8.4 Variables变量</h3><p>您可以使用:&#x3D;（赋值）运算符将值存储在中间变量中。可以像一样引用变量input</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">s := input.servers[0]</span><br><span class="line">s.id == &quot;app&quot;</span><br><span class="line">p := s.protocols[0]</span><br><span class="line">p == &quot;https&quot;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+---------+-------------------------------------------------------------------+</span><br><span class="line">|    p    |                                 s                                 |</span><br><span class="line">+---------+-------------------------------------------------------------------+</span><br><span class="line">| &quot;https&quot; | &#123;&quot;id&quot;:&quot;app&quot;,&quot;ports&quot;:[&quot;p1&quot;,&quot;p2&quot;,&quot;p3&quot;],&quot;protocols&quot;:[&quot;https&quot;,&quot;ssh&quot;]&#125; |</span><br><span class="line">+---------+-------------------------------------------------------------------+</span><br></pre></td></tr></table></figure><p>当OPA评估表达式时，它将查找使所有表达式都为真的变量的值。如果没有使所有表达式都为真的变量赋值，则结果是不确定的。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">s := input.servers[0]</span><br><span class="line">s.id == &quot;app&quot;</span><br><span class="line">s.protocols[1] == &quot;telnet&quot;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">undefined decision</span><br></pre></td></tr></table></figure><p>变量是不可变的。如果您尝试两次分配相同的变量，OPA将报告错误。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">s := input.servers[0]</span><br><span class="line">s := input.servers[1]</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1 error occurred: 2:1: rego_compile_error: var s assigned above</span><br></pre></td></tr></table></figure><p>OPA必须能够枚举所有表达式中所有变量的值。如果OPA无法枚举任何表达式中变量的值，则OPA将报告错误。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">x := 1</span><br><span class="line">x != y  # y has not been assigned a value</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">2 errors occurred:</span><br><span class="line">2:1: rego_unsafe_var_error: var _ is unsafe</span><br><span class="line">2:1: rego_unsafe_var_error: var y is unsafe</span><br></pre></td></tr></table></figure><h3 id="8-5-迭代"><a href="#8-5-迭代" class="headerlink" title="8.5 迭代"></a>8.5 迭代</h3><p>像其他声明性语言（例如SQL）一样，Rego没有显式的循环或迭代构造。而是将变量注入表达式中时，隐式发生迭代。</p><p>要了解Rego中迭代的工作原理，请想象您需要检查是否有任何公共网络。回想一下，网络是在数组中提供的：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">input.networks</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;id&quot;: &quot;net1&quot;,</span><br><span class="line">    &quot;public&quot;: false</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;id&quot;: &quot;net2&quot;,</span><br><span class="line">    &quot;public&quot;: false</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;id&quot;: &quot;net3&quot;,</span><br><span class="line">    &quot;public&quot;: true</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;id&quot;: &quot;net4&quot;,</span><br><span class="line">    &quot;public&quot;: true</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>一种选择是测试输入中的每个网络：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">input.networks[0].public == true</span><br><span class="line">false</span><br><span class="line"></span><br><span class="line">input.networks[1].public == true</span><br><span class="line">false</span><br><span class="line"></span><br><span class="line">input.networks[2].public == true</span><br><span class="line">true</span><br></pre></td></tr></table></figure><p>这种方法是有问题的，因为可能有太多网络无法静态列出，或更重要的是，可能无法事先知道网络的数量。</p><p>在Rego中，解决方案是将数组索引替换为变量。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">some i; input.networks[i].public == true</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">+---+</span><br><span class="line">| i |</span><br><span class="line">+---+</span><br><span class="line">| 2 |</span><br><span class="line">| 3 |</span><br><span class="line">+---+</span><br></pre></td></tr></table></figure><p>现在，查询将要求该值i使整个表达式为真。当您在引用中替换变量时，OPA会自动查找满足查询中所有表达式的变量分配。就像中间变量一样，OPA返回变量的值。</p><p>您可以根据需要替换任意多个变量。例如，要确定是否有服务器公开了不安全的&quot;http&quot;协议，您可以编写：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">some i, j; input.servers[i].protocols[j] == &quot;http&quot;</span><br><span class="line"></span><br><span class="line">+---+---+</span><br><span class="line">| i | j |</span><br><span class="line">+---+---+</span><br><span class="line">| 3 | 0 |</span><br><span class="line">+---+---+</span><br></pre></td></tr></table></figure><p>如果变量出现多次，则分配满足所有表达式。例如，要查找连接到公共网络的端口的ID，可以编写：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">some i, j</span><br><span class="line">id := input.ports[i].id</span><br><span class="line">input.ports[i].network == input.networks[j].id</span><br><span class="line">input.networks[j].public</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+---+------+---+</span><br><span class="line">| i |  id  | j |</span><br><span class="line">+---+------+---+</span><br><span class="line">| 1 | &quot;p2&quot; | 2 |</span><br><span class="line">+---+------+---+</span><br></pre></td></tr></table></figure><p>为变量提供好名字可能很难。如果仅引用一次变量，则可以将其替换为特殊的_（通配符变量）运算符。从概念上讲，的每个实例_都是一个唯一变量。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">input.servers[_].protocols[_] == &quot;http&quot;</span><br><span class="line">true</span><br></pre></td></tr></table></figure><p>就像引用不存在的字段或无法匹配的表达式的引用一样，如果OPA无法找到满足所有表达式的任何变量赋值，则结果是不确定的。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">some i; input.servers[i].protocols[i] == &quot;ssh&quot;  # there is no assignment of i that satisfies the expression</span><br><span class="line"></span><br><span class="line">undefined decision</span><br></pre></td></tr></table></figure><h3 id="8-6-规则"><a href="#8-6-规则" class="headerlink" title="8.6 规则"></a>8.6 规则</h3><p>Rego使您可以使用规则封装和重用逻辑。规则只是if-then逻辑语句。规则可以是“完整”或“部分”。</p><h4 id="8-6-1-完整规则"><a href="#8-6-1-完整规则" class="headerlink" title="8.6.1 完整规则"></a>8.6.1 完整规则</h4><p>完整的规则是if-then语句，这些语句将单个值分配给变量。例如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">package example.rules</span><br><span class="line"></span><br><span class="line">any_public_networks = true &#123;  # is true if...</span><br><span class="line">    net := input.networks[_]  # some network exists and..</span><br><span class="line">    net.public                # it is public.</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>每条规则都由一个头和一个身体组成。在Rego中，如果规则主体对于某些变量分配集为true，则说规则标题为true 。在上面的示例any_public_networks &#x3D; true中，头是net :&#x3D; input.networks[_]; net.public是身体。</p><p>您可以查询规则生成的值，就像其他任何值一样：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">any_public_networks</span><br><span class="line">true</span><br></pre></td></tr></table></figure><p>规则生成的所有值都可以通过全局data变量查询。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">data.example.rules.any_public_networks</span><br><span class="line">true</span><br></pre></td></tr></table></figure><p>您可以通过使用绝对路径引用OPA加载的任何规则来查询其值。规则的路径始终为：<br>data.<package-path>.<rule-name>。</p><p>如果您省略&#x3D; <value>规则标题的一部分，则该值默认为true。您可以按以下方式重写上面的示例，而无需更改其含义：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">package example.rules</span><br><span class="line"></span><br><span class="line">any_public_networks &#123;</span><br><span class="line">    net := input.networks[_]</span><br><span class="line">    net.public</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>要定义常量，请省略规则主体。省略规则正文时，默认为true。由于规则主体为true，因此规则标头始终为true &#x2F; defined。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">package example.constants</span><br><span class="line"></span><br><span class="line">pi = 3.14</span><br></pre></td></tr></table></figure><p>可以像其他任何值一样查询这样定义的常量：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pi &gt; 3</span><br><span class="line"></span><br><span class="line">true</span><br></pre></td></tr></table></figure><p>如果OPA无法找到满足规则主体的变量分配，则可以说该规则是未定义的。例如，如果input提供给OPA的不包括公共网络，any_public_networks则将是未定义的（与false相同）。下面，为OPA提供了一组不同的输入网络（都不是公共的）：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;networks&quot;: [</span><br><span class="line">        &#123;&quot;id&quot;: &quot;n1&quot;, &quot;public&quot;: false&#125;,</span><br><span class="line">        &#123;&quot;id&quot;: &quot;n2&quot;, &quot;public&quot;: false&#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">any_public_networks</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">undefined decision</span><br></pre></td></tr></table></figure><h4 id="8-6-2-部分规则"><a href="#8-6-2-部分规则" class="headerlink" title="8.6.2 部分规则"></a>8.6.2 部分规则</h4><p>部分规则是if-then语句，它们生成一组值并将该组值分配给变量。例如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">package example.rules</span><br><span class="line"></span><br><span class="line">public_network[net.id] &#123;      # net.id is in the public_network set if...</span><br><span class="line">    net := input.networks[_]  # some network exists and...</span><br><span class="line">    net.public                # it is public.</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在上面的示例中public_network[net.id]是规则头，并且net :&#x3D; input.networks[_]; net.public是规则主体。您可以像查询其他任何值一样查询整个值集：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public_network</span><br><span class="line"></span><br><span class="line">[</span><br><span class="line">  &quot;net3&quot;,</span><br><span class="line">  &quot;net4&quot;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>您可以通过使用变量引用set元素来遍历值集：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">some n; public_network[n]</span><br><span class="line"></span><br><span class="line">+--------+-------------------+</span><br><span class="line">|   n    | public_network[n] |</span><br><span class="line">+--------+-------------------+</span><br><span class="line">| &quot;net3&quot; | &quot;net3&quot;            |</span><br><span class="line">| &quot;net4&quot; | &quot;net4&quot;            |</span><br><span class="line">+--------+-------------------+</span><br></pre></td></tr></table></figure><p>最后，您可以使用相同的语法检查集合中是否存在值：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public_network[&quot;net3&quot;]</span><br><span class="line"></span><br><span class="line">&quot;net3&quot;</span><br></pre></td></tr></table></figure><p>除了部分定义集合外，您还可以部分定义键&#x2F;值对（也称为对象）。有关更多信息，请参见 语言指南中的规则。</p><h3 id="8-7-语法示例"><a href="#8-7-语法示例" class="headerlink" title="8.7 语法示例"></a>8.7 语法示例</h3><p>以上各节介绍了Rego的核心概念。综上所述，让我们回顾一下所需的策略（英语）：</p><p>Servers reachable from the Internet must not expose the insecure ‘http’ protocol.<br>从Internet可访问的服务器不能暴露不安全的“http”协议。<br>Servers are not allowed to expose the ‘telnet’ protocol.<br>服务器不允许公开’telnet’协议。<br>在较高级别，该策略需要识别违反某些条件的服务器。为了实施此策略，我们可以定义称为的规则violation ，这些规则生成一组违反的服务器。</p><p>例如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">package example</span><br><span class="line"></span><br><span class="line">allow = true &#123;                                      # allow is true if...</span><br><span class="line">    count(violation) == 0                           # there are zero violations.</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">violation[server.id] &#123;                              # a server is in the violation set if...</span><br><span class="line">    some server</span><br><span class="line">    public_server[server]                           # it exists in the &#x27;public_server&#x27; set and...</span><br><span class="line">    server.protocols[_] == &quot;http&quot;                   # it contains the insecure &quot;http&quot; protocol.</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">violation[server.id] &#123;                              # a server is in the violation set if...</span><br><span class="line">    server := input.servers[_]                      # it exists in the input.servers collection and...</span><br><span class="line">    server.protocols[_] == &quot;telnet&quot;                 # it contains the &quot;telnet&quot; protocol.</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public_server[server] &#123;                             # a server exists in the public_server set if...</span><br><span class="line">    some i, j</span><br><span class="line">    server := input.servers[_]                      # it exists in the input.servers collection and...</span><br><span class="line">    server.ports[_] == input.ports[i].id            # it references a port in the input.ports collection and...</span><br><span class="line">    input.ports[i].network == input.networks[j].id  # the port references a network in the input.networks collection and...</span><br><span class="line">    input.networks[j].public                        # the network is public.</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">some x; violation[x]</span><br><span class="line"></span><br><span class="line">+-----------+--------------+</span><br><span class="line">|     x     | violation[x] |</span><br><span class="line">+-----------+--------------+</span><br><span class="line">| &quot;ci&quot;      | &quot;ci&quot;         |</span><br><span class="line">| &quot;busybox&quot; | &quot;busybox&quot;    |</span><br><span class="line">+-----------+--------------+</span><br></pre></td></tr></table></figure><h2 id="9-将-OPA-用作Go库"><a href="#9-将-OPA-用作Go库" class="headerlink" title="9.将 OPA 用作Go库"></a>9.将 OPA 用作Go库</h2><p>OPA可以作为库嵌入到Go程序中。将OPA嵌入为库的最简单方法是导入github.com&#x2F;open-policy-agent&#x2F;opa&#x2F;rego 软件包。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import &quot;github.com/open-policy-agent/opa/rego&quot;</span><br></pre></td></tr></table></figure><p>调用该rego.New函数以创建可以准备或评估的对象：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">r := rego.New(</span><br><span class="line">    rego.Query(&quot;x = data.example.allow&quot;),</span><br><span class="line">    rego.Load([]string&#123;&quot;./example.rego&quot;&#125;, nil)</span><br><span class="line">    )</span><br></pre></td></tr></table></figure><p>支持多种选项自定义的评价。有关详细信息，请参见GoDoc页面。构造新rego.Rego对象后，您可以调用 PrepareForEval()以获得可执行查询。如果PrepareForEval()失败，则表明传递给rego.New()调用的选项之一无效（例如，解析错误，编译错误等）</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ctx := context.Background()</span><br><span class="line">query, err := r.PrepareForEval(ctx)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="comment">// handle error</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以将准备好的查询对象缓存在内存中，在多个goroutine中共享，并使用不同的输入重复调用。调用Eval()以执行准备好的查询。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">bs, err := ioutil.ReadFile(<span class="string">&quot;./input.json&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="comment">// handle error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> input <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err := json.Unmarshal(bs, &amp;input); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="comment">// handle error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">rs, err := query.Eval(ctx, rego.EvalInput(input))</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="comment">// handle error</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>该策略决策包含在Eval()调用返回的结果中。您可以检查该决定并进行相应处理：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// In this example we expect a single result (stored in the variable &#x27;x&#x27;).</span><br><span class="line">fmt.Println(&quot;Result:&quot;, rs[0].Bindings[&quot;x&quot;])</span><br></pre></td></tr></table></figure><p>您可以将上述步骤组合到一个简单的命令行程序中，该程序可以评估策略并输出结果：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">main.<span class="keyword">go</span>：</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;context&quot;</span></span><br><span class="line"><span class="string">&quot;encoding/json&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line"><span class="string">&quot;github.com/open-policy-agent/opa/rego&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    ctx := context.Background()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Construct a Rego object that can be prepared or evaluated.</span></span><br><span class="line">    r := rego.New(</span><br><span class="line">        rego.Query(os.Args[<span class="number">2</span>]),</span><br><span class="line">        rego.Load([]<span class="type">string</span>&#123;os.Args[<span class="number">1</span>]&#125;, <span class="literal">nil</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create a prepared query that can be evaluated.</span></span><br><span class="line">    query, err := r.PrepareForEval(ctx)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatal(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Load the input document from stdin.</span></span><br><span class="line">    <span class="keyword">var</span> input <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">    dec := json.NewDecoder(os.Stdin)</span><br><span class="line">    dec.UseNumber()</span><br><span class="line">    <span class="keyword">if</span> err := dec.Decode(&amp;input); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatal(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Execute the prepared query.</span></span><br><span class="line">    rs, err := query.Eval(ctx, rego.EvalInput(input))</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatal(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Do something with the result.</span></span><br><span class="line">    fmt.Println(rs)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行以下代码，如下所示：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">go run main.go example.rego &#x27;data.example.violation&#x27; &lt; input.json</span><br><span class="line">[&#123;[[ci busybox]] map[]&#125;]</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;script src=&quot;\assets\js\APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;h1 id=&quot;OPA-介绍&quot;&gt;&lt;a href=&quot;#OPA-介绍&quot; class=&quot;headerlink&quot; title=&quot;OPA-介绍&quot;&gt;&lt;/a&gt;OPA-介绍&lt;/h1&gt;&lt;blockq</summary>
      
    
    
    
    <category term="microservice" scheme="https://wangyyovo.github.io/categories/microservice/"/>
    
    <category term="opa" scheme="https://wangyyovo.github.io/categories/microservice/opa/"/>
    
    
    <category term="opa" scheme="https://wangyyovo.github.io/tags/opa/"/>
    
  </entry>
  
  <entry>
    <title>Nats JetStream</title>
    <link href="https://wangyyovo.github.io/posts/a3a9c33/"/>
    <id>https://wangyyovo.github.io/posts/a3a9c33/</id>
    <published>2022-02-28T10:42:20.000Z</published>
    <updated>2022-02-28T10:42:20.000Z</updated>
    
    <content type="html"><![CDATA[<script src="\assets\js\APlayer.min.js"> </script><blockquote><p>NATS Streaming服务器已被弃用。关键错误修复和安全修复将应用到 2023 年 6 月。需要持久性的支持 NATS 的应用程序应使用 JetStream。</p></blockquote><h1 id="Nats-JetStream"><a href="#Nats-JetStream" class="headerlink" title="Nats JetStream"></a>Nats JetStream</h1><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p><a href="https://docs.nats.io/running-a-nats-service/introduction/installation">https://docs.nats.io/running-a-nats-service/introduction/installation</a></p><h2 id="运行nats"><a href="#运行nats" class="headerlink" title="运行nats"></a>运行nats</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nats-server #不支持持久化</span><br><span class="line">nats-server -js #支持持久化</span><br></pre></td></tr></table></figure><h2 id="集群"><a href="#集群" class="headerlink" title="集群"></a>集群</h2><h3 id="非JetStream"><a href="#非JetStream" class="headerlink" title="非JetStream"></a>非JetStream</h3><p>nats_1.conf</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"># https://docs.nats.io/running-a-nats-service/configuration/clustering/cluster_config</span><br><span class="line"></span><br><span class="line">listen=4222</span><br><span class="line"></span><br><span class="line">cluster &#123;</span><br><span class="line">  name: example</span><br><span class="line"></span><br><span class="line">  # host/port for inbound route connections from other server</span><br><span class="line">  listen: localhost:4244</span><br><span class="line"></span><br><span class="line">  # Authorization for route connections</span><br><span class="line">  # Other server can connect if they supply the credentials listed here</span><br><span class="line">  # This server will connect to discovered routes using this user</span><br><span class="line">  authorization &#123;</span><br><span class="line">    user: route_user</span><br><span class="line">    password: pwd</span><br><span class="line">    timeout: 0.5</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  # This server establishes routes with these server.</span><br><span class="line">  # This server solicits new routes and Routes are actively solicited and connected to from this server.</span><br><span class="line">  # Other servers can connect to us if they supply the correct credentials</span><br><span class="line">  # in their routes definitions from above.</span><br><span class="line">  routes = [</span><br><span class="line">    nats-route://route_user:pwd@127.0.0.1:4245</span><br><span class="line">    nats-route://route_user:pwd@127.0.0.1:4246</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>nats_2.conf</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"># https://docs.nats.io/running-a-nats-service/configuration/clustering/cluster_config</span><br><span class="line"></span><br><span class="line">listen=4223</span><br><span class="line"></span><br><span class="line">cluster &#123;</span><br><span class="line">  name: example</span><br><span class="line"></span><br><span class="line">  # host/port for inbound route connections from other server</span><br><span class="line">  listen: localhost:4245</span><br><span class="line"></span><br><span class="line">  # Authorization for route connections</span><br><span class="line">  # Other server can connect if they supply the credentials listed here</span><br><span class="line">  # This server will connect to discovered routes using this user</span><br><span class="line">  authorization &#123;</span><br><span class="line">    user: route_user</span><br><span class="line">    password: pwd</span><br><span class="line">    timeout: 0.5</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  # This server establishes routes with these server.</span><br><span class="line">  # This server solicits new routes and Routes are actively solicited and connected to from this server.</span><br><span class="line">  # Other servers can connect to us if they supply the correct credentials</span><br><span class="line">  # in their routes definitions from above.</span><br><span class="line">  routes = [</span><br><span class="line">    nats-route://route_user:pwd@127.0.0.1:4244</span><br><span class="line">    nats-route://route_user:pwd@127.0.0.1:4246</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>nats_3.conf</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"># https://docs.nats.io/running-a-nats-service/configuration/clustering/cluster_config</span><br><span class="line"></span><br><span class="line">listen=4224</span><br><span class="line"></span><br><span class="line">cluster &#123;</span><br><span class="line">  name: example</span><br><span class="line"></span><br><span class="line">  # host/port for inbound route connections from other server</span><br><span class="line">  listen: localhost:4246</span><br><span class="line"></span><br><span class="line">  # Authorization for route connections</span><br><span class="line">  # Other server can connect if they supply the credentials listed here</span><br><span class="line">  # This server will connect to discovered routes using this user</span><br><span class="line">  authorization &#123;</span><br><span class="line">    user: route_user</span><br><span class="line">    password: pwd</span><br><span class="line">    timeout: 0.5</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  # This server establishes routes with these server.</span><br><span class="line">  # This server solicits new routes and Routes are actively solicited and connected to from this server.</span><br><span class="line">  # Other servers can connect to us if they supply the correct credentials</span><br><span class="line">  # in their routes definitions from above.</span><br><span class="line">  routes = [</span><br><span class="line">    nats-route://route_user:pwd@127.0.0.1:4244</span><br><span class="line">    nats-route://route_user:pwd@127.0.0.1:4245</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>启动nats</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./nats-server -c ./nats_1.conf</span><br><span class="line">./nats-server -c ./nats_2.conf</span><br><span class="line">./nats-server -c ./nats_3.conf</span><br></pre></td></tr></table></figure><h3 id="JetStream"><a href="#JetStream" class="headerlink" title="JetStream"></a>JetStream</h3><p>n1_c1.conf</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># https://docs.nats.io/running-a-nats-service/configuration/clustering/jetstream_clustering</span><br><span class="line">server_name=n1-c1</span><br><span class="line">listen=4222</span><br><span class="line"></span><br><span class="line">jetstream &#123;</span><br><span class="line">   store_dir=/nats/n1-c1/storage</span><br><span class="line">   max_mem: 1G</span><br><span class="line">   max_file: 1G</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cluster &#123;</span><br><span class="line">  name: C1</span><br><span class="line">  listen: localhost:6222</span><br><span class="line">  routes: [</span><br><span class="line">    nats-route://localhost:6223</span><br><span class="line">    nats-route://localhost:6224</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>n2_c1.conf</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># https://docs.nats.io/running-a-nats-service/configuration/clustering/jetstream_clustering</span><br><span class="line">server_name=n2-c1</span><br><span class="line">listen=4223</span><br><span class="line"></span><br><span class="line">jetstream &#123;</span><br><span class="line">   store_dir=/nats/n2-c1/storage</span><br><span class="line">   max_mem: 1G</span><br><span class="line">   max_file: 1G</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cluster &#123;</span><br><span class="line">  name: C1</span><br><span class="line">  listen: localhost:6223</span><br><span class="line">  routes: [</span><br><span class="line">    nats-route://localhost:6222</span><br><span class="line">    nats-route://localhost:6224</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>n3_c1.conf</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># https://docs.nats.io/running-a-nats-service/configuration/clustering/jetstream_clustering</span><br><span class="line">server_name=n3-c1</span><br><span class="line">listen=4224</span><br><span class="line"></span><br><span class="line">jetstream &#123;</span><br><span class="line">   store_dir=/nats/n3-c1/storage</span><br><span class="line">   max_mem: 1G</span><br><span class="line">   max_file: 1G</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cluster &#123;</span><br><span class="line">  name: C1</span><br><span class="line">  listen: localhost:6224</span><br><span class="line">  routes: [</span><br><span class="line">    nats-route://localhost:6222</span><br><span class="line">    nats-route://localhost:6223</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>启动nats jetstream</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./nats-server -c ./n1_c1.conf</span><br><span class="line">./nats-server -c ./n2_c1.conf</span><br><span class="line">./nats-server -c ./n3_c1.conf</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;script src=&quot;\assets\js\APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;blockquote&gt;
&lt;p&gt;NATS Streaming服务器已被弃用。关键错误修复和安全修复将应用到 2023 年 6 月。需要持久性的支持 NATS 的应用程序应使用 Je</summary>
      
    
    
    
    <category term="microservice" scheme="https://wangyyovo.github.io/categories/microservice/"/>
    
    <category term="nats" scheme="https://wangyyovo.github.io/categories/microservice/nats/"/>
    
    
  </entry>
  
  <entry>
    <title>基于NATS JetStream构建分布式事件流系统</title>
    <link href="https://wangyyovo.github.io/posts/4ed12469/"/>
    <id>https://wangyyovo.github.io/posts/4ed12469/</id>
    <published>2022-02-28T10:42:20.000Z</published>
    <updated>2022-02-28T10:42:20.000Z</updated>
    
    <content type="html"><![CDATA[<script src="\assets\js\APlayer.min.js"> </script><h1 id="基于NATS-JetStream构建分布式事件流系统"><a href="#基于NATS-JetStream构建分布式事件流系统" class="headerlink" title="基于NATS JetStream构建分布式事件流系统"></a>基于NATS JetStream构建分布式事件流系统</h1><p><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/blog/nats/21436181-4e8d0e32c6c32e8c.png"></p><blockquote><p>【译文】<a href="https://links.jianshu.com/go?to=https://shijuvar.medium.com/building-distributed-event-streaming-systems-in-go-with-nats-jetstream-3938e6dc7a13">原文地址</a><br>本文我将简要介绍NATS JetStream项目，它是一个来自NATS生态的分布式事件流系统。简言之，NATS JetStream是一个以发布&#x2F;订阅作为消息传递模式的分布式流媒体系统。当我在咨询工作中向我的客户介绍NATS时，对NATS、NATS Streaming和新推出的NATS JetStream的不同感到困惑。我将简要介绍这三个产品，然后通过一个非常简单的示例深入介绍NATS JetStream。</p></blockquote><h4 id="从NATS服务到NATS-JetStream来理解NATS生态"><a href="#从NATS服务到NATS-JetStream来理解NATS生态" class="headerlink" title="从NATS服务到NATS JetStream来理解NATS生态"></a>从NATS服务到NATS JetStream来理解NATS生态</h4><p>NAT云原生消息分发系统提供了一个基于“最多一次”交付模型的简单NATS服务，该服务将已发布的消息转发给消费者，而对已发布的消息不进行任何持久性处理，其性能处于行业领先地位。对于某些类型的应用程序，如果不需要事件流平台，那么基本的NATS平台就足够了并且还能获得高性能。使用“最多一次”发布模型，如果消息服务在转发数据给订阅者过程中，订阅者系统故障的话，消息将会丢失，因此无法保证已发布的消息的传递。</p><p>后来NATS生态添加了第二个消息发布可选方案：NATS流，这是一个基于NATS生态构建的高性能、轻量级、可靠的流平台。当使用NATS流发布消息时,发布的消息被持久化到一个可定制的存储中,由于具备发布者和订阅者提供ACK消息、发布者速率限制和每个订阅者速率匹配&#x2F;限制的能力，这样我们可以重用发布的消息为消费者提供“At-least-once-delivery”模式。基础NATS和NATS流都是用Go编写的。虽然NATS Streaming非常高性能和轻量化，但在某些能力和成熟度方面，它没有像Kafka这样的分布式流系统那么强大。与此同时，随着NATS 2.0的出现，NATS的生态系统也得到了很大的发展，NATS 2.0提供了分布式安全、去中心化管理、多租户、更大的网络、全球可扩展以及安全的数据共享。但NATS流在适应NATS 2.0方面存在很多限制，而且流系统还没有发展到能够应对下一代物联网和边缘计算的挑战。</p><p>NATS 2.0的下一代NATS流被称为NATS JetStream。因此，如果你想使用流系统来构建分布式系统、物联网和边缘计算，那么最好基于NATS使用NATS JetStream。官方对NATS流的支持将于2023年6月结束。因此，如果不想持久化发布的消息，请选择基本的NATS;如果希望将消息持久化到持久化存储中，并通过ACK、速率匹配&#x2F;限制等方式重复来自持久化存储的消息，请使用NATS JetStream。NATS JetStream是用Go编写的。</p><h5 id="NATS-JetStream"><a href="#NATS-JetStream" class="headerlink" title="NATS JetStream"></a>NATS JetStream</h5><p><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/blog/nats/21436181-dedfec18af3e72ca.png"></p><p>NATS JetStream是NATS生态系统的下一代流系统，为NATS 2.0打造，具有分布式安全、多租户和水平扩展能力。</p><h4 id="什么是分布式事件流系统？"><a href="#什么是分布式事件流系统？" class="headerlink" title="什么是分布式事件流系统？"></a>什么是分布式事件流系统？</h4><p>流系统允许您从分布式系统和微服务、物联网传感器、边缘设备和软件应用程序中捕获事件流，并将这些流持久化到存储中。因为将这些事件流持久化到持久化存储中，就可以使用事件驱动的结构回放这些事件流，以便检索、处理和响应这些事件流。使用NATS JetStream，流将由生产者系统发布，通过持久化重放消息并通过消费系统发布。简而言之，NATS JetStream是一个以发布&#x2F;订阅作为消息传递模式的分布式流系统。</p><p>尽管现有的流技术很多，其中一些流技术在某些方面比较擅长，但大多数技术还没有经过很大的发展，无法应对未来的计算场景，尤其是物联网和边缘计算。例如，当您使用物联网和边缘计算发布和订阅消息时，您可能需要更好的安全模型。您可能需要多租户和对多个部署模型的支持。NATS JetStream就是为解决这些问题而设计的，这些问题我们在今天的流技术堆栈中已经看到了。</p><h4 id="设计目标"><a href="#设计目标" class="headerlink" title="设计目标"></a>设计目标</h4><p>NATS的官方文档列出了NATS JetStream的设计目标:</p><ul><li><p>系统必须易于配置和操作，易于观察。</p></li><li><p>系统必须是安全的，并且在NATS 2.0安全模型下运行良好。</p></li><li><p>系统必须能水平扩展，并适用于高摄取率。</p></li><li><p>系统必须支持多个用例。</p></li><li><p>系统必须能自愈并高可用。</p></li><li><p>系统必须有一个接近NATS核心的API。</p></li><li><p>系统必须允许NATS消息成为流的一部分。</p></li><li><p>系统必须显示与有效载荷无关的行为。</p></li><li><p>系统不能有第三方依赖关系。</p></li></ul><h4 id="用于运行NATS服务和NATS-JetStream服的简单可执行文件"><a href="#用于运行NATS服务和NATS-JetStream服的简单可执行文件" class="headerlink" title="用于运行NATS服务和NATS JetStream服的简单可执行文件"></a>用于运行NATS服务和NATS JetStream服的简单可执行文件</h4><p>安装<a href="https://links.jianshu.com/go?to=https://github.com/nats-io/nats-server">NATS Server v2.2.2</a>，您可以使用相同的可执行文件“nats-server”运行基本的NATS服务(没有持久性)和NATS JetStream服务。当你运行nats-server可执行文件时，它将作为基本的NATS服务运行，当你运行带有-js参数的nats-server可执行文件或配置启用JetStream时，它将运行启用了JetStream子系统的NATS服务。<br>以下是JetStream的配置文件:<br>清单1。启用JetStream子系统</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> jetstream &#123;</span><br><span class="line">    </span><br><span class="line">    store_dir: &quot;/data/nats-server&quot;</span><br><span class="line"></span><br><span class="line">    max_memory_store: 1073741824</span><br><span class="line"></span><br><span class="line">    max_file_store: 10737418240</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面的配置为NATS服务启用了JetStream子系统，并将&#x2F;data&#x2F; nats-server目录配置为持久化流的存储目录。<br>在这里，我们使用js.conf文件运行带有JetStream子系统的nats-server:<br>清单2。使用js.conf文件运行NATS服务器</p><p>图1所示。NATS JetStream服务正在运行:</p><p><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/blog/nats/2022-03-03_183014.png"></p><h4 id="使用单个NATS客户端SDK与NATS和NATS-JetStream工作"><a href="#使用单个NATS客户端SDK与NATS和NATS-JetStream工作" class="headerlink" title="使用单个NATS客户端SDK与NATS和NATS JetStream工作"></a>使用单个NATS客户端SDK与NATS和NATS JetStream工作</h4><p>我们使用单独的客户端sdk与NATS服务和NATS流媒体服务一起工作。但Go SDK <a href="https://links.jianshu.com/go?to=https://github.com/nats-io/nats.go">nats.go</a>v1.11.0版本中，你可以使用相同的库来处理基本的NATS和NATS JetStream。<br>下面是从NATS连接创建JetStream上下文的代码:<br>清单3。创建JetStream上下文</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">import &quot;github.com/nats-io/nats.go&quot;</span><br><span class="line">nc, _ := nats.Connect(nats.DefaultURL)</span><br><span class="line">js, err := nc.JetStream()</span><br></pre></td></tr></table></figure><p>JetStreamContext允许JetStream消息和流管理。一旦创建了JetStreamContext，就可以通过使用其发布和订阅api轻松地使用JetStream。</p><h4 id="JetStream流"><a href="#JetStream流" class="headerlink" title="JetStream流"></a>JetStream流</h4><p>在JetStream中，事件流以Streams存储，其中多个相关的主题存储在一个Stream中。例如，当你在构建一个订单处理系统时，可以考虑“ORDERS”作为一个Stream，在这里可以使用与Stream相关的主题比如“ORDERS.created”、“ORDERS.approved&quot;、“ORDERS.rejected&quot;、“ORDER.payment.debited&quot;和“ORDERS.shiped&quot;，来发布和消费事件流。因此所有这些相关的主题都属于“ORDERS”这个Stream。<br>下图显示了在服务器上以存储文件形式存储的“ORDERS”流。<br>图2。订单流存储</p><p><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/blog/nats/2022-03-03_183942.png" alt="img"></p><h4 id="拉式消费者和推式消费者"><a href="#拉式消费者和推式消费者" class="headerlink" title="拉式消费者和推式消费者"></a>拉式消费者和推式消费者</h4><p>JetStream提供了两种消费者(订阅者)系统:基于拉的消费者和基于推的消费者。基于Pull的消费者让JetStream从消费者系统中提取消息。基于pull的消费者系统就像工作队列。因为JetStream提供了ACK(确认)机制，所以可以轻松地水平扩展基于Pull的消费者系统，而不会出现消息重复的问题。拉式订阅是NATS生态系统的新功能。基于Push的消费者使JetStream将消息推送到消费者系统，这对于监控系统来说是一个很好的选择。<br>以下是来自NATS文档的JetStream混合推&#x2F;拉订单处理架构:</p><p><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/blog/nats/21436181-d8581bf962a150d6.png"></p><p>原图链接: <a href="https://links.jianshu.com/go?to=https://docs.nats.io/jetstream/concepts">https://docs.nats.io/jetstream/concepts</a></p><h4 id="通配符订阅"><a href="#通配符订阅" class="headerlink" title="通配符订阅"></a>通配符订阅</h4><p>NATS流的消费者不支持通配符订阅。庆幸的是在JetStream中支持通配符订阅。下面的代码块显示了通配符订阅:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nc, _ := nats.Connect(nats.DefaultURL)</span><br><span class="line">js, _ := nc.JetStream()</span><br><span class="line">js.Subscribe(<span class="string">&quot;ORDERS.*&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(msg *nats.Msg)</span></span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="NATS命令行"><a href="#NATS命令行" class="headerlink" title="NATS命令行"></a>NATS命令行</h4><p>NATS生态系统为管理需求提供了一个新的NATS CLI工具。你可以从源代码安装或使用Homebrew tap。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">brew tap nats-io/nats-tools</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">brew install nats-io/nats-tools/nats</span></span><br></pre></td></tr></table></figure><h4 id="一个NATS-JetStream的示例"><a href="#一个NATS-JetStream的示例" class="headerlink" title="一个NATS JetStream的示例"></a>一个NATS JetStream的示例</h4><p>让我们是用 <a href="https://links.jianshu.com/go?to=https://github.com/nats-io/nats.go">nats.go</a>Go客户端SDK编写一个简单的示例来理解如何使用NATS JetStream。<br>配置最新版本NATS服务和nats.go客户端SDK：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Go client latest</span> </span><br><span class="line">go get github.com/nats-io/nats.go/@latest</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">For latest NATS Server, add /v2 at the end</span></span><br><span class="line">go get github.com/nats-io/nats-server/v2</span><br></pre></td></tr></table></figure><h4 id="例子演示"><a href="#例子演示" class="headerlink" title="例子演示"></a>例子演示</h4><p>在这个例子中，使用Stream ”ORDERS“作为主题”ORDERS.<em>的流。为了演示，我们用“ORDERS.created&quot;和&quot;ORDERS.approved&quot;主题来发布消息。一个系统用“ORDERS.created&quot;主题发布消息。一个基于Pull消费者将订阅该主题的消息，并基于这个事件做一些处理之后，进一步在&quot;ORDERS.approved&quot;主题上发布消息。另一个基于Push的消费者使用“ORDERS.</em>”通配符订阅消息，因此所有“ORDERS”上的流都被订阅。</p><h4 id="使用JetStreamContext创建流"><a href="#使用JetStreamContext创建流" class="headerlink" title="使用JetStreamContext创建流"></a>使用JetStreamContext创建流</h4><p>我们首先创建一个流“ORDERS”，用于主题“ORDERS.*”。您可以使用管理工具(如NATS CLI)或使用NATS客户端sdk来创建Stream。这里我们使用nats.go创建Stream。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">   streamName  = <span class="string">&quot;ORDERS&quot;</span></span><br><span class="line">   streamSubjects = <span class="string">&quot;ORDERS.*&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">createStream</span><span class="params">(js nats.JetStreamContext)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">   </span><br><span class="line">   stream, err := js.StreamInfo(streamName)</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      log.Println(err)</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> stream == <span class="literal">nil</span> &#123;</span><br><span class="line">      log.Printf(<span class="string">&quot;creating stream %q and subjects %q&quot;</span>, streamName, streamSubjects)</span><br><span class="line">      _, err = js.AddStream(&amp;nats.StreamConfig&#123;</span><br><span class="line">         Name:     streamName,</span><br><span class="line">         Subjects: []<span class="type">string</span>&#123;streamSubjects&#125;,</span><br><span class="line">      &#125;)</span><br><span class="line">      <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">         <span class="keyword">return</span> err</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在上面的代码块中，如果流不存在，我们就使用JetStreamContext的AddStream方法创建一个新的流。JetStreamContext可以通过调用NATS连接对象的JetStream方法来创建。<br>从NATS连接创建JetStreamContext，然后调用createStream方法创建一个Stream。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> nc, _ := nats.Connect(nats.DefaultURL)</span><br><span class="line"></span><br><span class="line">js, err := nc.JetStream()</span><br><span class="line">err = createStream(js)</span><br></pre></td></tr></table></figure><h4 id="事件发布流"><a href="#事件发布流" class="headerlink" title="事件发布流"></a>事件发布流</h4><p>下面的代码块以“ORDERS”为主题发布消息(事件流)，目的是“让消费者系统知道新订单被放到了我们的分布式系统环境中，这样消费者系统就可以通过执行自己的操作和发布其他事件集来响应这些事件。<br>发布主题为“ORDERS.created”的消息：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">   subjectName =<span class="string">&quot;ORDERS.created&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">createOrder</span><span class="params">(js nats.JetStreamContext)</span></span> <span class="type">error</span>&#123;</span><br><span class="line">   <span class="keyword">var</span> order model.Order</span><br><span class="line">   <span class="keyword">for</span> i := <span class="number">1</span>; i &lt;= <span class="number">10</span>; i++ &#123;</span><br><span class="line">      order = model.Order&#123;</span><br><span class="line">         OrderID:    i,</span><br><span class="line">         CustomerID: <span class="string">&quot;Cust-&quot;</span> + strconv.Itoa(i),</span><br><span class="line">         Status:     <span class="string">&quot;created&quot;</span>,</span><br><span class="line">      &#125;</span><br><span class="line">      orderJSON, _ := json.Marshal(order)</span><br><span class="line">      _, err := js.Publish(subjectName, orderJSON)</span><br><span class="line">      <span class="keyword">if</span> err!=<span class="literal">nil</span> &#123;</span><br><span class="line">         <span class="keyword">return</span> err</span><br><span class="line">      &#125;</span><br><span class="line">      log.Printf(<span class="string">&quot;Order with OrderID:%d has been published\n&quot;</span>,i)</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>下面是在我们的例子中使用的Order结构体:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Order <span class="keyword">struct</span> &#123;</span><br><span class="line">   OrderID    <span class="type">int</span></span><br><span class="line">   CustomerID <span class="type">string</span></span><br><span class="line">   Status     <span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>下面是示例完整代码块，它创建了Stream并在主题“ORDERS.created”上发布消息:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"> <span class="string">&quot;encoding/json&quot;</span></span><br><span class="line"> <span class="string">&quot;log&quot;</span></span><br><span class="line"> <span class="string">&quot;strconv&quot;</span></span><br><span class="line"></span><br><span class="line"> <span class="string">&quot;github.com/nats-io/nats.go&quot;</span></span><br><span class="line"></span><br><span class="line"> <span class="string">&quot;github.com/shijuvar/go-distsys/jsdemo/model&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line"> streamName  = <span class="string">&quot;ORDERS&quot;</span></span><br><span class="line"> streamSubjects = <span class="string">&quot;ORDERS.*&quot;</span></span><br><span class="line"> subjectName =<span class="string">&quot;ORDERS.created&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"> </span><br><span class="line"> nc, _ := nats.Connect(nats.DefaultURL)</span><br><span class="line"> </span><br><span class="line"> js, err := nc.JetStream()</span><br><span class="line"> checkErr(err)</span><br><span class="line"> </span><br><span class="line"> err = createStream(js)</span><br><span class="line"> checkErr(err)</span><br><span class="line"> </span><br><span class="line"> err= createOrder(js)</span><br><span class="line"> checkErr(err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">createOrder</span><span class="params">(js nats.JetStreamContext)</span></span> <span class="type">error</span>&#123;</span><br><span class="line"> <span class="keyword">var</span> order model.Order</span><br><span class="line"> <span class="keyword">for</span> i := <span class="number">1</span>; i &lt;= <span class="number">10</span>; i++ &#123;</span><br><span class="line">    order = model.Order&#123;</span><br><span class="line">       OrderID:    i,</span><br><span class="line">       CustomerID: <span class="string">&quot;Cust-&quot;</span> + strconv.Itoa(i),</span><br><span class="line">       Status:     <span class="string">&quot;created&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    orderJSON, _ := json.Marshal(order)</span><br><span class="line">    _, err := js.Publish(subjectName, orderJSON)</span><br><span class="line">    <span class="keyword">if</span> err!=<span class="literal">nil</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    log.Printf(<span class="string">&quot;Order with OrderID:%d has been published\n&quot;</span>,i)</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">createStream</span><span class="params">(js nats.JetStreamContext)</span></span> <span class="type">error</span> &#123;</span><br><span class="line"> </span><br><span class="line"> stream, err := js.StreamInfo(streamName)</span><br><span class="line"> <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Println(err)</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">if</span> stream == <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Printf(<span class="string">&quot;creating stream %q and subjects %q&quot;</span>, streamName, streamSubjects)</span><br><span class="line">    _, err = js.AddStream(&amp;nats.StreamConfig&#123;</span><br><span class="line">       Name:     streamName,</span><br><span class="line">       Subjects: []<span class="type">string</span>&#123;streamSubjects&#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">checkErr</span><span class="params">(err <span class="type">error</span>)</span></span> &#123;</span><br><span class="line"> <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatal(err)</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="基于拉的消费者对事件的反应"><a href="#基于拉的消费者对事件的反应" class="headerlink" title="基于拉的消费者对事件的反应"></a>基于拉的消费者对事件的反应</h4><p>一个基于Pull的消费者从主题“ORDERS”中订阅消息的例子。最终通过主题“ORDERS.approved”发布消息。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">   <span class="string">&quot;context&quot;</span></span><br><span class="line">   <span class="string">&quot;encoding/json&quot;</span></span><br><span class="line">   <span class="string">&quot;log&quot;</span></span><br><span class="line">   <span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">   <span class="string">&quot;github.com/nats-io/nats.go&quot;</span></span><br><span class="line"></span><br><span class="line">   <span class="string">&quot;github.com/shijuvar/go-distsys/jsdemo/model&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">   subSubjectName =<span class="string">&quot;ORDERS.created&quot;</span></span><br><span class="line">   pubSubjectName =<span class="string">&quot;ORDERS.approved&quot;</span></span><br><span class="line"></span><br><span class="line">)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">   </span><br><span class="line">   nc, _ := nats.Connect(nats.DefaultURL)</span><br><span class="line">   js, err := nc.JetStream()</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      log.Fatal(err)</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   </span><br><span class="line">   sub, _ := js.PullSubscribe(subSubjectName, <span class="string">&quot;order-review&quot;</span>, nats.PullMaxWaiting(<span class="number">128</span>))</span><br><span class="line">   ctx, cancel := context.WithTimeout(context.Background(), <span class="number">10</span>*time.Second)</span><br><span class="line">   <span class="keyword">defer</span> cancel()</span><br><span class="line"></span><br><span class="line">   <span class="keyword">for</span> &#123;</span><br><span class="line">      <span class="keyword">select</span> &#123;</span><br><span class="line">      <span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">         <span class="keyword">return</span></span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">      &#125;</span><br><span class="line">      msgs, _ := sub.Fetch(<span class="number">10</span>, nats.Context(ctx))</span><br><span class="line">      <span class="keyword">for</span> _, msg := <span class="keyword">range</span> msgs &#123;</span><br><span class="line">         msg.Ack()</span><br><span class="line">         <span class="keyword">var</span> order model.Order</span><br><span class="line">         err := json.Unmarshal(msg.Data, &amp;order)</span><br><span class="line">         <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            log.Fatal(err)</span><br><span class="line">         &#125;</span><br><span class="line">         log.Println(<span class="string">&quot;order-review service&quot;</span>)</span><br><span class="line">         log.Printf(<span class="string">&quot;OrderID:%d, CustomerID: %s, Status:%s\n&quot;</span>, order.OrderID, order.CustomerID, order.Status)</span><br><span class="line">         reviewOrder(js,order)</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">reviewOrder</span><span class="params">(js nats.JetStreamContext, order model.Order)</span></span> &#123;</span><br><span class="line">   </span><br><span class="line">   order.Status =<span class="string">&quot;approved&quot;</span></span><br><span class="line">   orderJSON, _ := json.Marshal(order)</span><br><span class="line">   _, err := js.Publish(pubSubjectName, orderJSON)</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      log.Fatal(err)</span><br><span class="line">   &#125;</span><br><span class="line">   log.Printf(<span class="string">&quot;Order with OrderID:%d has been %s\n&quot;</span>,order.OrderID, order.Status)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>JetStreamContext的PullSubscribe方法创建了一个可以获取消息的订阅。它将返回一个Subscription对象。Subscription的Fetch方法从流中为Pull消费者提取一批消息。msg.Ack()向服务器发出手动确认。</p><h4 id="基于Push的消费者使用通配符订阅"><a href="#基于Push的消费者使用通配符订阅" class="headerlink" title="基于Push的消费者使用通配符订阅"></a>基于Push的消费者使用通配符订阅</h4><p>在下面示例中，另一个消费者是一个基于Push的订阅者，它使用通配符订阅消息。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">   <span class="string">&quot;encoding/json&quot;</span></span><br><span class="line">   <span class="string">&quot;log&quot;</span></span><br><span class="line">   <span class="string">&quot;runtime&quot;</span></span><br><span class="line"></span><br><span class="line">   <span class="string">&quot;github.com/nats-io/nats.go&quot;</span></span><br><span class="line"></span><br><span class="line">   <span class="string">&quot;github.com/shijuvar/go-distsys/jsdemo/model&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">   </span><br><span class="line">   nc, _ := nats.Connect(nats.DefaultURL)</span><br><span class="line">   js, err := nc.JetStream()</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      log.Fatal(err)</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   js.Subscribe(<span class="string">&quot;ORDERS.*&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(msg *nats.Msg)</span></span> &#123;</span><br><span class="line">      msg.Ack()</span><br><span class="line">      <span class="keyword">var</span> order model.Order</span><br><span class="line">      err := json.Unmarshal(msg.Data, &amp;order)</span><br><span class="line">      <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">         log.Fatal(err)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      log.Printf(<span class="string">&quot;monitor service subscribes from subject:%s\n&quot;</span>, msg.Subject)</span><br><span class="line">      log.Printf(<span class="string">&quot;OrderID:%d, CustomerID: %s, Status:%s\n&quot;</span>, order.OrderID, order.CustomerID, order.Status)</span><br><span class="line">   &#125;, nats.Durable(<span class="string">&quot;monitor&quot;</span>),nats.ManualAck())</span><br><span class="line"></span><br><span class="line">   runtime.Goexit()</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对于已经在NATS和NATS流媒体服务器上工作过的NATS开发人员来说，订阅API是一个非常熟悉的API。</p><h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>当我们考虑使用分布式流系统作为构建分布式系统、基于微服务的分布式系统、基于物联网的系统、下一代Edge系统的核心架构时，可以考虑使用NATS JetStream。在未来的计算中，处理大量的事件流和消息流将是一个巨大的挑战，特别是边缘计算。 NATS JetStream提供了分布式安全、多租户和水平扩展能力。在NATS JetStream的早期版本中，一些设计目标没有通过集群选项实现。但随着后来的发布和改进，我希望NATS JetStream能够实现所有的设计目标，成为一种极具竞争力的流技术。考虑到简单性和适应性边缘架构，我肯定会选择NATS JetStream而不是Kafka，并等待这个技术更加成熟。</p><h2 id="常见属性"><a href="#常见属性" class="headerlink" title="常见属性"></a>常见属性</h2><h3 id="StreamConfig全属性"><a href="#StreamConfig全属性" class="headerlink" title="StreamConfig全属性"></a>StreamConfig全属性</h3><table><thead><tr><th>属性</th><th>描述</th></tr></thead><tbody><tr><td>MaxAge</td><td>流中消息的最大年龄，以微秒为单位</td></tr><tr><td>MaxBytes</td><td>流的最大存储容量，当合并的流大小超过这个大小时，旧的消息就会被删除</td></tr><tr><td>MaxMsgSize</td><td>流能接收的最大消息尺寸</td></tr><tr><td>MaxMsgs</td><td>流中能存储的最大消息条数，当数量超过这个值时，旧的消息就会被删除</td></tr><tr><td>MaxConsumers</td><td>流最多能有多少个消费者，为<code>-1</code>时无限制</td></tr><tr><td>Name</td><td>流的名称，<strong>不能</strong>带有空格，tab或者<code>.</code></td></tr><tr><td>NoAck</td><td>禁用流接收的消息的ACK</td></tr><tr><td>Replicas</td><td>消息在集群中的副本数量，最大值为5</td></tr><tr><td>Retention</td><td>消息的保留策略，有<code>LimitsPolicy</code>(默认)，<code>InterestPolicy</code>，<code>WorkQueuePolicy</code></td></tr><tr><td>Discard</td><td>当流触及限制后，<code>DiscardNew</code>策略会拒绝新的消息，<code>DiscardOld</code>(默认)会删除旧的消息</td></tr><tr><td>Storage</td><td>消息的存储方式，有<code>file</code>和<code>memory</code>两种</td></tr><tr><td>Subjects</td><td>待消费的<code>subjects</code>集合，支持通配符</td></tr><tr><td>Duplicates</td><td>消息去重使用的时间窗</td></tr></tbody></table><h3 id="保留策略-Retention"><a href="#保留策略-Retention" class="headerlink" title="保留策略(Retention)"></a>保留策略(Retention)</h3><table><thead><tr><th>保留策略</th><th>描述</th></tr></thead><tbody><tr><td><code>LimitsPolicy</code></td><td>对消息的数量、存储容量和年龄进行限制</td></tr><tr><td><code>WorkQueuePolicy</code></td><td>直到被一个观察者消耗之前，消息都会保存</td></tr><tr><td><code>InterestPolicy</code></td><td>只要有消费者处于活跃状态，消息就会被保存下来</td></tr></tbody></table><p>上面提到的<code>MaxMsgs</code>，<code>MaxMsgs</code>，<code>MaxAge</code>用来对消息进行限制，它们也是<code>LimitsPolicy</code>策略仅能使用的属性。</p><p>在<code>WorkQueuePolicy</code>策略下，一旦有消费者收到确认，消息就会被立即删除。而启用<code>InterestPolicy</code>时，如果没有消费者在线就会立即将消息删除。</p><p>需要注意，在<code>WorkQueuePolicy</code>和<code>InterestPolicy</code>下，<code>MaxMsgs</code>，<code>MaxMsgs</code>，<code>MaxAge</code>这三个属性依然是生效的，并且是作为前置条件存在。</p><h3 id="确认模型-Acknowledgement-Models"><a href="#确认模型-Acknowledgement-Models" class="headerlink" title="确认模型(Acknowledgement Models)"></a>确认模型(Acknowledgement Models)</h3><p>消费者有三种确认模式:</p><table><thead><tr><th>模式</th><th>描述</th></tr></thead><tbody><tr><td><code>AckExplicit</code></td><td>要求每个消息都进行手动确认，这也是拉模型下唯一支持的方式</td></tr><tr><td><code>AckAll</code></td><td>这个模式下，如果你确认了第<code>100</code>个消息，那么<code>1</code>-<code>99</code>个消息都会自动确认，适用于批处理任务，以减少确认带来的额外开销</td></tr><tr><td><code>AckNone</code></td><td>不支持任何确认</td></tr></tbody></table><h3 id="ConsumerConfig的配置属性列表"><a href="#ConsumerConfig的配置属性列表" class="headerlink" title="ConsumerConfig的配置属性列表"></a>ConsumerConfig的配置属性列表</h3><table><thead><tr><th>属性</th><th>描述</th></tr></thead><tbody><tr><td>AckPolicy</td><td>消息的确认方式，支持<code>AckNone``, ``AckAll</code> 和 <code>AckExplicit</code></td></tr><tr><td>AckWait</td><td>在消息被重新投递之前，允许消息在多长时间之内处于未确认状态</td></tr><tr><td>DeliverPolicy</td><td>消费者的起始位置策略，支持<code>DeliverAll</code>, <code>DeliverLast</code>, <code>DeliverNew</code>, <code>DeliverByStartSequence</code> 和<code>DeliverByStartTime</code></td></tr><tr><td>DeliverySubject</td><td>传递观察到的消息的subject，如果没有设置的话，会创建一个拉模式的消费者</td></tr><tr><td>Durable</td><td>消费者的名称</td></tr><tr><td>FilterSubject</td><td>当从一个有许多subject或通配符的流中消费时，只选择一个特定的传入subject，支持通配符。</td></tr><tr><td>MaxDeliver</td><td>特定消息的最大传递次数，以此来避免使你的系统陷入崩溃的毒药类型的消息（如陷入死循环）</td></tr><tr><td>OptStartSeq</td><td>当第一次从流中消费消息时，从集合中的这个特定的消息开始读取</td></tr><tr><td>ReplayPolicy</td><td>消息的发送方式，支持<code>ReplayInstant</code>和<code>ReplayOriginal</code></td></tr><tr><td>SampleFrequency</td><td>确认的消息应占观测样本的百分比，区间为0-100</td></tr><tr><td>OptStartTime</td><td>当第一次从流中消费消息时，从这个时间或之后的消息开始</td></tr><tr><td>RateLimit</td><td>以bit&#x2F;s为单位的消息传递速率</td></tr><tr><td>MaxAckPending</td><td>未确认的最大消息数量，一旦达到此限制，将暂停发送消息</td></tr></tbody></table><h3 id="消费者起始位置-Consumer-Starting-Position"><a href="#消费者起始位置-Consumer-Starting-Position" class="headerlink" title="消费者起始位置(Consumer Starting Position)"></a>消费者起始位置(Consumer Starting Position)</h3><p>配置消费者时可以决定从什么位置开始消费，NATS支持以下<code>DeliverPolicy</code>:</p><table><thead><tr><th>策略</th><th>描述</th></tr></thead><tbody><tr><td><code>all</code></td><td>传递所有可用的消息</td></tr><tr><td><code>last</code></td><td>传递最近的消息，类似于<code>tail -n 1 -f</code></td></tr><tr><td><code>new</code></td><td>只传递在订阅之后新到来的消息</td></tr><tr><td><code>by_start_time</code></td><td>传递特定时间之后的消息，需要设置<code>OptStartTime</code></td></tr><tr><td><code>by_start_sequence</code></td><td>从流中特定序号的消息开始，需要设置<code>OptStartSeq</code></td></tr></tbody></table>]]></content>
    
    
      
      
    <summary type="html">&lt;script src=&quot;\assets\js\APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;h1 id=&quot;基于NATS-JetStream构建分布式事件流系统&quot;&gt;&lt;a href=&quot;#基于NATS-JetStream构建分布式事件流系统&quot; class=&quot;headerlin</summary>
      
    
    
    
    <category term="microservice" scheme="https://wangyyovo.github.io/categories/microservice/"/>
    
    <category term="nats" scheme="https://wangyyovo.github.io/categories/microservice/nats/"/>
    
    
  </entry>
  
  <entry>
    <title>Go服务监控搭建入门</title>
    <link href="https://wangyyovo.github.io/posts/b7af1a36/"/>
    <id>https://wangyyovo.github.io/posts/b7af1a36/</id>
    <published>2022-02-25T14:55:36.000Z</published>
    <updated>2022-02-25T14:55:36.000Z</updated>
    
    <content type="html"><![CDATA[<script src="\assets\js\APlayer.min.js"> </script><h1 id="Go服务监控搭建入门"><a href="#Go服务监控搭建入门" class="headerlink" title="Go服务监控搭建入门"></a>Go服务监控搭建入门</h1><blockquote><p>prometheus v2.33.4</p><p>grafana v8.4.1</p></blockquote><h2 id="架构简介"><a href="#架构简介" class="headerlink" title="架构简介"></a>架构简介</h2><p>整体的简易架构如下：</p><p><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/blog/prometheus/20210531132351.png" alt="img"></p><ul><li>Grafana：作为UI，提供了丰富的监控面板。</li><li>Prometheus：Prometheus是一个监控&amp;时序数据库。</li><li>需要被监控的服务：需要被监控的服务按照标准提供一个<code>metrics</code>接口，Prometheus会去通过暴露的这个接口拉取数据。Go已经有封装好的包<code>github.com/prometheus/client_golang/prometheus</code>，我们直接采用就可以了。</li></ul><h2 id="准备镜像"><a href="#准备镜像" class="headerlink" title="准备镜像"></a>准备镜像</h2><p>选取Prometheus镜像，如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">docker pull bitnami/prometheus:latest</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">docker run -d -p 9090:9090 bitnami/prometheus:2.33.4</span></span><br><span class="line">docker pull bitnami/prometheus:2.33.4</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>选取Grafana镜像，如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">docker pull bitnami/grafana:latest</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">docker run -d -p 3000:3000 bitnami/grafana:8.4.1</span></span><br><span class="line">docker pull bitnami/grafana:8.4.1</span><br></pre></td></tr></table></figure><p>Go服务demo代码镜像：</p><p>首先我们选用现有封装好的代码包，如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">选用现有的prometheus包</span></span><br><span class="line">go get github.com/prometheus/client_golang/prometheus</span><br><span class="line">go get github.com/prometheus/client_golang/prometheus/promauto</span><br><span class="line">go get github.com/prometheus/client_golang/prometheus/promhttp</span><br></pre></td></tr></table></figure><p>demo代码如下：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;github.com/prometheus/client_golang/prometheus/promhttp&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// 对外提供/metrics接口</span></span><br><span class="line">http.Handle(<span class="string">&quot;/metrics&quot;</span>, promhttp.Handler())</span><br><span class="line">http.ListenAndServe(<span class="string">&quot;:2112&quot;</span>, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>启动Go服务，curl请求接口：</p><blockquote><p>curl <a href="http://localhost:2112/metrics">http://localhost:2112/metrics</a></p></blockquote><p>获取到监控指标数据如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">HELP go_gc_duration_seconds A summary of the pause duration of garbage collection cycles.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">TYPE go_gc_duration_seconds summary</span></span><br><span class="line">go_gc_duration_seconds&#123;quantile=&quot;0&quot;&#125; 2.8697e-05</span><br><span class="line">go_gc_duration_seconds&#123;quantile=&quot;0.25&quot;&#125; 3.8094e-05</span><br><span class="line">go_gc_duration_seconds&#123;quantile=&quot;0.5&quot;&#125; 0.000125819</span><br><span class="line">go_gc_duration_seconds&#123;quantile=&quot;0.75&quot;&#125; 0.000190862</span><br><span class="line">go_gc_duration_seconds&#123;quantile=&quot;1&quot;&#125; 0.0098972</span><br><span class="line">go_gc_duration_seconds_sum 0.025042382</span><br><span class="line">go_gc_duration_seconds_count 45</span><br><span class="line">......略</span><br></pre></td></tr></table></figure><p>通过prometheus的配置文件<code>prometheus.yml</code>注册我们Go样例服务，如下</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="comment"># prometheus自身的监控</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;prometheus&#x27;</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;prometheus:9090&#x27;</span>]</span><br><span class="line">  <span class="comment"># 重点是这里 </span></span><br><span class="line">  <span class="comment"># 注册我们Go服务的job</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;go-demo&#x27;</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;go-demo:2112&#x27;</span>]</span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">server_name:</span> <span class="string">server</span></span><br></pre></td></tr></table></figure><p>编写Go服务的dockerfile，如下：</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> amd64/golang:<span class="number">1.16</span>.<span class="number">3</span>-alpine3.<span class="number">12</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">mkdir</span> -p /home/go-demo</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;/home/deploy/go-demo/run.sh&quot;</span>]</span></span><br></pre></td></tr></table></figure><p>启动脚本<code>/home/deploy/go-demo/run.sh</code>，如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line"></span><br><span class="line">cd /home/deploy/go-demo \</span><br><span class="line">    &amp;&amp; go run main.go \</span><br><span class="line">    &amp;&amp; sleep 100000</span><br></pre></td></tr></table></figure><h2 id="服务编排-docker-compose"><a href="#服务编排-docker-compose" class="headerlink" title="服务编排(docker-compose)"></a>服务编排(docker-compose)</h2><p>上面我们是单独启动每个容器来实现的，接着我们用docker-compose来编排服务。</p><p>首先，创建network:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建network</span></span><br><span class="line">docker network create example_default</span><br></pre></td></tr></table></figure><p>接着，编写docker-compose.yaml文件如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">prometheus:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">bitnami/prometheus:2.33.4</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./prometheus/prometheus.yml:/opt/bitnami/prometheus/conf/prometheus.yml</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9090:9090&quot;</span></span><br><span class="line">    <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">networks:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">grafana:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">bitnami/grafana:8.4.1</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">grafana</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;3000:3000&quot;</span></span><br><span class="line">    <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">networks:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">go-demo:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">go-demo</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">./go-demo</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./go-demo:/home/deploy/go-demo</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;2112:2112&quot;</span></span><br><span class="line">    <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">networks:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">default</span></span><br><span class="line"><span class="attr">networks:</span> </span><br><span class="line">  <span class="attr">default:</span></span><br><span class="line">    <span class="attr">external:</span> </span><br><span class="line">      <span class="attr">name:</span> <span class="string">example_default</span></span><br></pre></td></tr></table></figure><p>最后，启动服务：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动服务</span></span><br><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure><h2 id="Grafana监控面板配置"><a href="#Grafana监控面板配置" class="headerlink" title="Grafana监控面板配置"></a>Grafana监控面板配置</h2><p>首先prometheus其实自己是有监控面板的，我们可以通过下面的地址访问：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:9090</span><br></pre></td></tr></table></figure><p>举个例子，比如通过如下的操作，我们就可以看见我们Go服务的<code>Goroutines</code>监控。</p><p><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/blog/prometheus/1.png" alt="img"></p><p><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/blog/prometheus/2.png" alt="img"></p><p>但是呢，Grafana提供了更丰富的监控面板，接着我们来搭建一个简单的Go服务监控。</p><p>访问grafana地址：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:3000</span><br></pre></td></tr></table></figure><p>初始账号密码：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">admin</span><br><span class="line">admin</span><br></pre></td></tr></table></figure><p>进入首页：</p><p><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/blog/prometheus/3.png" alt="img"></p><p>添加数据源：</p><p><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/blog/prometheus/4.png" alt="img"></p><p><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/blog/prometheus/5.png" alt="img"></p><p>选择数据源为Prometheus:</p><p><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/blog/prometheus/6.png" alt="img"></p><p>填写Prometheus服务的地址：</p><p><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/blog/prometheus/7.png" alt="img"></p><p>切换到Dashboards面板，选择导入一个面板：</p><p><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/blog/prometheus/8.png" alt="img"></p><p><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/blog/prometheus/9.png" alt="img"></p><p>接着我们就可以看见一个已经存在的面板了，这个面板是Prometheus自身监控的面板。</p><p><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/blog/prometheus/10.png" alt="img"></p><p>接着，我们来创建一个我们自己Go服务的面板，首先创建一个Go服务的目录(保证隔离和可读性，相当于namespace)：</p><p><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/blog/prometheus/11.png" alt="img"></p><p><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/blog/prometheus/12.png" alt="img"></p><p>创建一个Go服务的面板：</p><p><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/blog/prometheus/13.png" alt="img"></p><p>创建一个指标视图：</p><p><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/blog/prometheus/14.png" alt="img"></p><p>选择视图类型为折线统计图，选择数据指标为<code>go_gotoutines</code>:</p><p><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/blog/prometheus/15.png" alt="img"></p><p><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/blog/prometheus/16.png" alt="img"></p><p><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/blog/prometheus/18.png" alt="img"></p><p>以此类推，我们就创建了一些列监控视图数据，比如goroutine数量、线程数量、heap内存数据、stack内存数据、mcache数据、mspan数据、GC数据等等，如下：</p><p><img src="https://jsd.012700.xyz/gh/wangyyovo/CDN@master/blog/prometheus/17.png" alt="img"></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>如上我们就成功搭建了一个入门级别的「Go服务监控」，但是这还不能够上生产环境，为什么，留下两个课后思考：</p><ul><li>除了系统、性能指标外，业务指标怎么统计？</li><li>上面注册服务是通过人工修改的，实际我们的服务都是动态服务发现了，所以配合服务发现我们怎么注册服务到<code>prometheus</code>呢？</li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;script src=&quot;\assets\js\APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;h1 id=&quot;Go服务监控搭建入门&quot;&gt;&lt;a href=&quot;#Go服务监控搭建入门&quot; class=&quot;headerlink&quot; title=&quot;Go服务监控搭建入门&quot;&gt;&lt;/a&gt;Go服务监控</summary>
      
    
    
    
    <category term="microservice" scheme="https://wangyyovo.github.io/categories/microservice/"/>
    
    <category term="prometheus" scheme="https://wangyyovo.github.io/categories/microservice/prometheus/"/>
    
    
  </entry>
  
  <entry>
    <title>EFK日志系统搭建</title>
    <link href="https://wangyyovo.github.io/posts/d074a0bb/"/>
    <id>https://wangyyovo.github.io/posts/d074a0bb/</id>
    <published>2022-02-01T13:50:36.000Z</published>
    <updated>2022-02-01T13:50:36.000Z</updated>
    
    <content type="html"><![CDATA[<script src="\assets\js\APlayer.min.js"> </script><h1 id="EFK日志系统搭建"><a href="#EFK日志系统搭建" class="headerlink" title="EFK日志系统搭建"></a>EFK日志系统搭建</h1><p>目录结构</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~/log-collect/EFK# tree</span><br><span class="line">├── docker-compose.yml</span><br><span class="line">├── .env</span><br><span class="line">├── elasticsearch</span><br><span class="line">│   ├── data</span><br><span class="line">│   └── Dockerfile</span><br><span class="line">├── fluentd</span><br><span class="line">│   ├── Dockerfile</span><br><span class="line">│   └── etc</span><br><span class="line">│       └── fluent.conf</span><br><span class="line">└── kibana</span><br><span class="line">    ├── data</span><br><span class="line">    ├── Dockerfile</span><br><span class="line">    └── kibana.yml</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>新建目录</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p EFK/elasticsearch/data</span><br><span class="line">mkdir -p EFK/kibana/data</span><br><span class="line">mkdir -p EFK/fluentd/etc</span><br></pre></td></tr></table></figure><h2 id="elasticsearch"><a href="#elasticsearch" class="headerlink" title="elasticsearch"></a>elasticsearch</h2><h2 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h2><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ARG</span> ELK_VERSION</span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> docker.elastic.co/elasticsearch/elasticsearch:$&#123;ELK_VERSION&#125;</span><br></pre></td></tr></table></figure><h2 id="fluentd"><a href="#fluentd" class="headerlink" title="fluentd"></a>fluentd</h2><h3 id="Dockerfile-1"><a href="#Dockerfile-1" class="headerlink" title="Dockerfile"></a>Dockerfile</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ARG</span> FLUENTD_VERSION</span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> fluent/fluentd:v$&#123;FLUENTD_VERSION&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Use root account to use apk</span></span><br><span class="line"><span class="keyword">USER</span> root</span><br><span class="line"></span><br><span class="line"><span class="comment"># below RUN includes plugin as examples elasticsearch is not required</span></span><br><span class="line"><span class="comment"># you may customize including plugins as you wish</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apk add --no-cache --update --virtual .build-deps \</span></span><br><span class="line"><span class="language-bash">        sudo build-base ruby-dev \</span></span><br><span class="line"><span class="language-bash"> &amp;&amp; sudo gem install fluent-plugin-elasticsearch \</span></span><br><span class="line"><span class="language-bash"> &amp;&amp; sudo gem sources --clear-all \</span></span><br><span class="line"><span class="language-bash"> &amp;&amp; apk del .build-deps \</span></span><br><span class="line"><span class="language-bash"> &amp;&amp; <span class="built_in">rm</span> -rf /tmp/* /var/tmp/* /usr/lib/ruby/gems/*/cache/*.gem</span></span><br><span class="line"><span class="comment"># RUN [&quot;gem&quot;, &quot;install&quot;, &quot;fluent-plugin-elasticsearch&quot;, &quot;--no-rdoc&quot;, &quot;--no-ri&quot;, &quot;--version&quot;, &quot;1.9.2&quot;]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">USER</span> fluent</span><br></pre></td></tr></table></figure><h3 id="fluent-conf"><a href="#fluent-conf" class="headerlink" title="fluent.conf"></a>fluent.conf</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">&lt;source&gt;</span><br><span class="line">  @type forward</span><br><span class="line">  port 24224</span><br><span class="line">  tag nginx</span><br><span class="line">  &lt;parse&gt;</span><br><span class="line">    @type nginx</span><br><span class="line">    expression /^(?&lt;host&gt;[^ ]*) (?&lt;server_port&gt;[^ ]*) (?&lt;user&gt;[^ ]*) \[(?&lt;time&gt;[^\]]*)\] &quot;(?&lt;method&gt;\S+[^\&quot;])(?: +(?&lt;path&gt;[^\&quot;]*?)(?: +\S*)?)?&quot; (?&lt;code&gt;[^ ]*) (?&lt;size&gt;[^ ]*) &quot;(?&lt;referer&gt;[^\&quot;]*)&quot; &quot;(?&lt;agent&gt;[^\&quot;]*)&quot;$/</span><br><span class="line">    time_key time</span><br><span class="line">    time_format %d/%b/%Y:%H:%M:%S %z</span><br><span class="line">  &lt;/parse&gt;</span><br><span class="line">&lt;/source&gt;</span><br><span class="line"></span><br><span class="line"># &lt;filter **&gt;</span><br><span class="line">#   @type parser</span><br><span class="line">#   &lt;parse&gt;</span><br><span class="line">#     @type regexp</span><br><span class="line">    </span><br><span class="line">#     expression /^(?&lt;host&gt;[^ ]*) (?&lt;server_port&gt;[^ ]*) (?&lt;user&gt;[^ ]*) \[(?&lt;time&gt;[^\]]*)\] &quot;(?&lt;method&gt;\S+[^\&quot;])(?: +(?&lt;path&gt;[^\&quot;]*?)(?: +\S*)?)?&quot; (?&lt;code&gt;[^ ]*) (?&lt;size&gt;[^ ]*) &quot;(?&lt;referer&gt;[^\&quot;]*)&quot; &quot;(?&lt;agent&gt;[^\&quot;]*)&quot;$/</span><br><span class="line">#     time_key time</span><br><span class="line">#     time_format %d/%b/%Y:%H:%M:%S %z</span><br><span class="line">    </span><br><span class="line">#   &lt;/parse&gt;</span><br><span class="line">#   key_name log</span><br><span class="line"># &lt;/filter&gt;</span><br><span class="line"></span><br><span class="line">&lt;match nginx&gt;</span><br><span class="line">  @type elasticsearch</span><br><span class="line">  host elasticsearch</span><br><span class="line">  port 9200</span><br><span class="line">  logstash_format true</span><br><span class="line">  logstash_prefix fluentd</span><br><span class="line">  logstash_dateformat %Y%m%d</span><br><span class="line">  include_tag_key true</span><br><span class="line">  type_name access_log</span><br><span class="line">  tag_key nginx</span><br><span class="line">  flush_interval 1s</span><br><span class="line">  user elastic</span><br><span class="line">  password elastic</span><br><span class="line">  suppress_type_name true</span><br><span class="line">&lt;/match&gt;</span><br></pre></td></tr></table></figure><h2 id="kibana"><a href="#kibana" class="headerlink" title="kibana"></a>kibana</h2><h3 id="Dockerfile-2"><a href="#Dockerfile-2" class="headerlink" title="Dockerfile"></a>Dockerfile</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ARG</span> ELK_VERSION</span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> docker.elastic.co/kibana/kibana:$&#123;ELK_VERSION&#125;</span><br></pre></td></tr></table></figure><h3 id="kibana-yml"><a href="#kibana-yml" class="headerlink" title="kibana.yml"></a>kibana.yml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># ** THIS IS AN AUTO-GENERATED FILE **</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Default Kibana configuration for docker target</span></span><br><span class="line"><span class="attr">server.name:</span> <span class="string">kibana</span></span><br><span class="line"><span class="attr">server.host:</span> <span class="string">&quot;0&quot;</span></span><br><span class="line"><span class="comment"># server.basePath: &quot;/efk&quot;</span></span><br><span class="line"><span class="attr">elasticsearch.hosts:</span> [ <span class="string">&quot;http://elasticsearch:9200&quot;</span> ]</span><br><span class="line"><span class="attr">monitoring.ui.container.elasticsearch.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">i18n.locale:</span> <span class="string">&quot;zh-CN&quot;</span></span><br><span class="line"><span class="attr">elasticsearch.username:</span> <span class="string">&quot;elastic&quot;</span></span><br><span class="line"><span class="attr">elasticsearch.password:</span> <span class="string">&quot;elastic&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#$ vim nginx.conf</span></span><br><span class="line"><span class="comment">#    location /efk/ &#123;</span></span><br><span class="line"><span class="comment">#          proxy_pass http://192.168.1.11:5601/;</span></span><br><span class="line"><span class="comment">#    &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#配置kibana</span></span><br><span class="line"><span class="comment">#$ vim ./kibana/kibana.yml</span></span><br><span class="line"><span class="comment">#server.basePath: &quot;/efk&quot;</span></span><br></pre></td></tr></table></figure><h2 id="docker-compose-yml"><a href="#docker-compose-yml" class="headerlink" title="docker-compose.yml"></a>docker-compose.yml</h2><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">&quot;3.7&quot;</span></span><br><span class="line">services:</span><br><span class="line">  flog:</span><br><span class="line">      image: mingrammer/flog</span><br><span class="line">      container_name: flog</span><br><span class="line">      command: <span class="string">&quot;-f json -l -d 1&quot;</span></span><br><span class="line">      depends_on: </span><br><span class="line">        - fluentd</span><br><span class="line">      links:</span><br><span class="line">        - fluentd</span><br><span class="line">      logging:</span><br><span class="line">        driver: <span class="string">&quot;fluentd&quot;</span></span><br><span class="line">        options:</span><br><span class="line">          fluentd-address: localhost:<span class="number">24224</span></span><br><span class="line">          tag: fake.log</span><br><span class="line">      networks:</span><br><span class="line">        - elk-nginx</span><br><span class="line"></span><br><span class="line">  fluentd:</span><br><span class="line">      image: fluentd:$&#123;FLUENTD_VERSION&#125;</span><br><span class="line">      container_name: fluentd_$&#123;FLUENTD_VERSION&#125;</span><br><span class="line">      build:</span><br><span class="line">        context: ./fluentd</span><br><span class="line">        args:</span><br><span class="line">          FLUENTD_VERSION: $FLUENTD_VERSION</span><br><span class="line">      ports:</span><br><span class="line">        - <span class="string">&quot;24224:24224&quot;</span></span><br><span class="line">        - <span class="string">&quot;24224:24224/udp&quot;</span></span><br><span class="line">      depends_on: </span><br><span class="line">        - <span class="string">&quot;elasticsearch&quot;</span></span><br><span class="line">      networks:</span><br><span class="line">        - elk-nginx</span><br><span class="line">      volumes:</span><br><span class="line">        - ./fluentd/etc:/fluentd/etc</span><br><span class="line"></span><br><span class="line">  elasticsearch:</span><br><span class="line">    image: elasticsearch:$&#123;ELK_VERSION&#125;</span><br><span class="line">    container_name: elasticsearch_$&#123;ELK_VERSION&#125;</span><br><span class="line">    build:</span><br><span class="line">      context: ./elasticsearch</span><br><span class="line">      args:</span><br><span class="line">        ELK_VERSION: $ELK_VERSION</span><br><span class="line">    mem_limit: <span class="number">1</span>G</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;9200:9200&quot;</span></span><br><span class="line">    <span class="keyword">expose</span>:</span><br><span class="line">      - <span class="number">9200</span></span><br><span class="line">    volumes:</span><br><span class="line">      - ./elasticsearch/data:/usr/share/elasticsearch/data</span><br><span class="line">    environment:</span><br><span class="line">      - discovery.type=single-node</span><br><span class="line">      - <span class="string">&quot;ES_JAVA_OPTS=-Xms512m -Xmx512m&quot;</span></span><br><span class="line">      - xpack.security.enabled=true</span><br><span class="line">    networks:</span><br><span class="line">      - elk-nginx</span><br><span class="line"></span><br><span class="line">  kibana:</span><br><span class="line">    image: kibana:$&#123;ELK_VERSION&#125;</span><br><span class="line">    container_name: kibana_$&#123;ELK_VERSION&#125;</span><br><span class="line">    build:</span><br><span class="line">      context: kibana/</span><br><span class="line">      args:</span><br><span class="line">        ELK_VERSION: $ELK_VERSION</span><br><span class="line">    mem_limit: <span class="number">1</span>G</span><br><span class="line">    volumes:</span><br><span class="line">      - ./kibana/kibana.yml:/usr/share/kibana/config/kibana.yml</span><br><span class="line">      - ./kibana/data:/usr/share/kibana/data</span><br><span class="line">    links:</span><br><span class="line">      - <span class="string">&quot;elasticsearch&quot;</span></span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;5601:5601&quot;</span></span><br><span class="line">    networks:</span><br><span class="line">      - elk-nginx</span><br><span class="line"></span><br><span class="line">networks:</span><br><span class="line">  elk-nginx:</span><br><span class="line">    driver: bridge</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="env"><a href="#env" class="headerlink" title=".env"></a>.env</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ELK_VERSION=7.16.3</span><br><span class="line">FLUENTD_VERSION=1.14-1</span><br></pre></td></tr></table></figure><h2 id="修改文件权限"><a href="#修改文件权限" class="headerlink" title="修改文件权限"></a>修改文件权限</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod 777 -R ./</span><br></pre></td></tr></table></figure><h2 id="配置密码访问"><a href="#配置密码访问" class="headerlink" title="配置密码访问"></a>配置密码访问</h2><p>Elasticsearch安全认证</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重置密码 auto：随机密码 interactive：手动设置</span></span><br><span class="line">docker exec -it elasticsearch_7.16.3 bash</span><br><span class="line">./bin/elasticsearch-setup-passwords interactive</span><br><span class="line"></span><br><span class="line">--- Please confirm that you would like to continue [y/N]y</span><br><span class="line"></span><br><span class="line">Enter password for [elastic]:                  &lt;--输入用户elastic的密码&gt;</span><br><span class="line">Reenter password for [elastic]:                &lt;--再次输入定义的密码&gt;</span><br><span class="line">Enter password for [apm_system]:               &lt;--输入用户apm_system的密码&gt;</span><br><span class="line">Reenter password for [apm_system]:             &lt;--再次输入定义的密码&gt;</span><br><span class="line">Enter password for [kibana_system]:            &lt;--输入用户kibana的密码&gt;</span><br><span class="line">Reenter password for [kibana_system]:          &lt;--再次输入定义的密码&gt;</span><br><span class="line">Enter password for [logstash_system]:          &lt;--输入用户logstash_system的密码&gt;</span><br><span class="line">Reenter password for [logstash_system]:        &lt;--再次输入定义的密码&gt;</span><br><span class="line">Enter password for [beats_system]:             &lt;--输入用户beats_system的密码&gt;</span><br><span class="line">Reenter password for [beats_system]:           &lt;--再次输入定义的密码&gt;</span><br><span class="line">Enter password for [remote_monitoring_user]:   &lt;--输入用户remote_monitoring_user的密码&gt;</span><br><span class="line">Reenter password for [remote_monitoring_user]: &lt;--再次输入定义的密码&gt;</span><br><span class="line">Changed password for user [apm_system]</span><br><span class="line">Changed password for user [kibana_system]</span><br><span class="line">Changed password for user [logstash_system]</span><br><span class="line">Changed password for user [beats_system]</span><br><span class="line">Changed password for user [remote_monitoring_user]</span><br><span class="line">Changed password for user [elastic]</span><br><span class="line"></span><br><span class="line">exit</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -H &quot;Content-Type:application/json&quot; -XPOST -u elastic &#x27;http://127.0.0.1:9200/_xpack/security/user/elastic/_password&#x27; -d &#x27;&#123; &quot;password&quot; : &quot;123456&quot; &#125;&#x27;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;script src=&quot;\assets\js\APlayer.min.js&quot;&gt; &lt;/script&gt;&lt;h1 id=&quot;EFK日志系统搭建&quot;&gt;&lt;a href=&quot;#EFK日志系统搭建&quot; class=&quot;headerlink&quot; title=&quot;EFK日志系统搭建&quot;&gt;&lt;/a&gt;EFK日志系统搭建</summary>
      
    
    
    
    <category term="log" scheme="https://wangyyovo.github.io/categories/log/"/>
    
    
    <category term="log" scheme="https://wangyyovo.github.io/tags/log/"/>
    
  </entry>
  
</feed>
